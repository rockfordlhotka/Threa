@* Form modal for adding or editing a wound on a character *@

@using GameMechanics
@using GameMechanics.Effects.Behaviors
@using GameMechanics.Messaging
@using Threa.Dal.Dto
@using Radzen

@inject IDataPortal<CharacterEdit> characterPortal
@inject IChildDataPortal<EffectRecord> effectPortal
@inject DialogService DialogService
@inject ITimeEventPublisher TimeEventPublisher
@inject ITableDal tableDal

<div class="p-3">
    <EditForm Model="@this" OnValidSubmit="SaveWound">
        <DataAnnotationsValidator />

        @* Common Wound Templates *@
        <div class="mb-3">
            <label class="form-label">Quick Template (Optional)</label>
            <select class="form-select" @onchange="OnTemplateSelected">
                <option value="">-- Select a template --</option>
                @foreach (var template in CommonWounds)
                {
                    <option value="@template.Name">@template.Name</option>
                }
            </select>
            <small class="text-muted">Pre-fill form with common wound values</small>
        </div>

        <hr class="my-3" />

        @* Severity Selection *@
        <div class="mb-3">
            <label class="form-label">Severity <span class="text-danger">*</span></label>
            <select class="form-select @(string.IsNullOrEmpty(selectedSeverity) ? "is-invalid" : "")"
                    @bind="selectedSeverity" @bind:after="OnSeverityChanged">
                <option value="">-- Select severity --</option>
                <option value="Minor">Minor</option>
                <option value="Moderate">Moderate</option>
                <option value="Severe">Severe</option>
                <option value="Critical">Critical</option>
            </select>
            @if (string.IsNullOrEmpty(selectedSeverity))
            {
                <div class="invalid-feedback">Severity is required</div>
            }
        </div>

        @* Location Selection *@
        <div class="mb-3">
            <label class="form-label">Location <span class="text-danger">*</span></label>
            <select class="form-select @(string.IsNullOrEmpty(selectedLocation) ? "is-invalid" : "")" @bind="selectedLocation">
                <option value="">-- Select location --</option>
                <option value="Head">Head</option>
                <option value="Torso">Torso</option>
                <option value="LeftArm">Left Arm</option>
                <option value="RightArm">Right Arm</option>
                <option value="LeftLeg">Left Leg</option>
                <option value="RightLeg">Right Leg</option>
            </select>
            @if (string.IsNullOrEmpty(selectedLocation))
            {
                <div class="invalid-feedback">Location is required</div>
            }
        </div>

        @* Description *@
        <div class="mb-3">
            <label class="form-label">Description <span class="text-danger">*</span></label>
            <input type="text" class="form-control @(string.IsNullOrEmpty(description) || description.Length < 3 ? "is-invalid" : "")"
                   @bind="description" placeholder="Describe the wound..." />
            @if (string.IsNullOrEmpty(description) || description.Length < 3)
            {
                <div class="invalid-feedback">Description is required (min 3 characters)</div>
            }
        </div>

        <hr class="my-3" />

        @* Effect Values (with severity defaults) *@
        <div class="row g-3 mb-3">
            <div class="col-md-4">
                <label class="form-label">AS Penalty</label>
                <input type="number" class="form-control" @bind="asPenalty" max="0" />
                <small class="text-muted">Penalty to all ability scores</small>
            </div>
            <div class="col-md-4">
                <label class="form-label">FAT/Tick</label>
                <input type="number" class="form-control" @bind="fatDamage" min="0" />
                <small class="text-muted">FAT damage per 20 rounds</small>
            </div>
            <div class="col-md-4">
                <label class="form-label">VIT/Tick</label>
                <input type="number" class="form-control" @bind="vitDamage" min="0" />
                <small class="text-muted">VIT damage per 20 rounds</small>
            </div>
        </div>

        @* Healing Time *@
        <div class="mb-3">
            <label class="form-label">Healing Time</label>
            <div class="input-group">
                <input type="number" class="form-control" @bind="healingTimeValue" min="0" placeholder="0" />
                <select class="form-select" style="max-width: 120px;" @bind="healingTimeUnit">
                    <option value="rounds">Rounds</option>
                    <option value="minutes">Minutes</option>
                    <option value="hours">Hours</option>
                    <option value="days">Days</option>
                    <option value="weeks">Weeks</option>
                </select>
            </div>
            <small class="text-muted">
                @if (healingTimeValue > 0)
                {
                    <span>Wound fully heals in @FormatHealingTime(). Severity decreases as it heals (half-life model).</span>
                }
                else
                {
                    <span>Leave at 0 for manual healing only (no auto-degradation)</span>
                }
            </small>
        </div>

        @if (!string.IsNullOrEmpty(selectedSeverity))
        {
            <div class="alert alert-secondary small mb-3">
                <i class="bi bi-info-circle me-1"></i>
                <strong>@selectedSeverity defaults:</strong>
                AS @(WoundState.GetSeverityDefaults(selectedSeverity).asPenalty),
                FAT @(WoundState.GetSeverityDefaults(selectedSeverity).fatPerTick)/tick,
                VIT @(WoundState.GetSeverityDefaults(selectedSeverity).vitPerTick)/tick
            </div>
        }

        @* Validation Messages *@
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger mb-3">
                <i class="bi bi-exclamation-triangle me-1"></i>@errorMessage
            </div>
        }

        @* Action Buttons *@
        <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" @onclick="Cancel" disabled="@isProcessing">
                Cancel
            </button>
            <button type="submit" class="btn btn-danger" disabled="@(!IsFormValid || isProcessing)">
                @if (isProcessing)
                {
                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                }
                <i class="bi bi-bandaid me-1"></i>
                @(ExistingWound != null ? "Update Wound" : "Add Wound")
            </button>
        </div>
    </EditForm>
</div>

@code {
    [Parameter] public CharacterEdit? Character { get; set; }
    [Parameter] public int CharacterId { get; set; }
    [Parameter] public Guid TableId { get; set; }
    [Parameter] public EffectRecord? ExistingWound { get; set; }

    private string selectedSeverity = "";
    private string selectedLocation = "";
    private string description = "";
    private int asPenalty = -2;
    private int fatDamage = 1;
    private int vitDamage = 0;
    private int healingTimeValue = 0;
    private string healingTimeUnit = "hours";
    private bool isProcessing;
    private string? errorMessage;

    // Common wound templates with healing times based on severity
    // Healing times: Minor=1 week, Moderate=2 weeks, Severe=4 weeks, Critical=8 weeks
    private static readonly (string Name, string Location, string Severity, string Description, int HealingDays)[] CommonWounds =
    [
        ("Broken Arm", "RightArm", "Severe", "Fractured arm bone", 28),
        ("Broken Leg", "RightLeg", "Severe", "Fractured leg bone", 42),
        ("Concussion", "Head", "Moderate", "Traumatic head injury", 14),
        ("Deep Cut", "Torso", "Minor", "Deep bleeding laceration", 7),
        ("Puncture Wound", "Torso", "Moderate", "Piercing injury", 14),
        ("Burns", "Torso", "Minor", "Thermal damage to skin", 10),
        ("Internal Bleeding", "Torso", "Critical", "Internal hemorrhage", 56),
        ("Sprained Ankle", "RightLeg", "Minor", "Twisted ankle joint", 7),
        ("Cracked Ribs", "Torso", "Moderate", "Fractured rib bones", 21),
        ("Severed Tendon", "RightArm", "Critical", "Major tendon damage", 56)
    ];

    private bool IsFormValid =>
        !string.IsNullOrEmpty(selectedSeverity) &&
        !string.IsNullOrEmpty(selectedLocation) &&
        !string.IsNullOrEmpty(description) &&
        description.Length >= 3;

    protected override void OnParametersSet()
    {
        if (ExistingWound != null)
        {
            // Edit mode - populate form from existing wound
            var state = WoundState.Deserialize(ExistingWound.BehaviorState);

            // Use original severity for the form (what the wound started as)
            selectedSeverity = state.OriginalSeverity ?? state.Severity ?? "Minor";
            selectedLocation = ExistingWound.Location ?? "Torso";
            description = state.Description ?? ExistingWound.Description ?? "";

            // Load custom overrides if set, otherwise use severity defaults
            var defaults = WoundState.GetSeverityDefaults(selectedSeverity);
            asPenalty = state.CustomASPenalty ?? defaults.asPenalty;
            fatDamage = state.CustomFatDamagePerTick ?? state.FatDamagePerTick ?? defaults.fatPerTick;
            vitDamage = state.CustomVitDamagePerTick ?? state.VitDamagePerTick ?? defaults.vitPerTick;

            // Load healing time from EffectRecord (preferred) or legacy WoundState
            long? expiryTime = ExistingWound.ExpiresAtEpochSeconds ?? state.ExpiryTimeSeconds;
            if (expiryTime.HasValue && Character != null)
            {
                var remainingSeconds = expiryTime.Value - Character.CurrentGameTimeSeconds;
                if (remainingSeconds > 0)
                {
                    ConvertSecondsToTimeValue(remainingSeconds);
                }
            }
        }
    }

    private void ConvertSecondsToTimeValue(long seconds)
    {
        // Convert to the most appropriate unit
        long weekSeconds = 7 * 86400;
        if (seconds >= weekSeconds && seconds % weekSeconds == 0)
        {
            healingTimeValue = (int)(seconds / weekSeconds);
            healingTimeUnit = "weeks";
        }
        else if (seconds >= 86400 && seconds % 86400 == 0)
        {
            healingTimeValue = (int)(seconds / 86400);
            healingTimeUnit = "days";
        }
        else if (seconds >= 3600 && seconds % 3600 == 0)
        {
            healingTimeValue = (int)(seconds / 3600);
            healingTimeUnit = "hours";
        }
        else if (seconds >= 60 && seconds % 60 == 0)
        {
            healingTimeValue = (int)(seconds / 60);
            healingTimeUnit = "minutes";
        }
        else
        {
            // Show as rounds (3 seconds per round)
            healingTimeValue = (int)(seconds / 3);
            healingTimeUnit = "rounds";
        }
    }

    private long? GetHealingTimeSeconds()
    {
        if (healingTimeValue <= 0) return null;

        return healingTimeUnit switch
        {
            "rounds" => healingTimeValue * 3,
            "minutes" => healingTimeValue * 60,
            "hours" => healingTimeValue * 3600,
            "days" => healingTimeValue * 86400,
            "weeks" => healingTimeValue * 7 * 86400,
            _ => null
        };
    }

    private string FormatHealingTime()
    {
        if (healingTimeValue <= 0) return "";
        return $"{healingTimeValue} {healingTimeUnit}";
    }

    private void OnTemplateSelected(ChangeEventArgs e)
    {
        var templateName = e.Value?.ToString();
        if (string.IsNullOrEmpty(templateName)) return;

        var template = CommonWounds.FirstOrDefault(t => t.Name == templateName);
        if (template != default)
        {
            selectedLocation = template.Location;
            selectedSeverity = template.Severity;
            description = template.Description;
            OnSeverityChanged();

            // Set healing time from template
            healingTimeValue = template.HealingDays;
            healingTimeUnit = "days";
        }
    }

    private void OnSeverityChanged()
    {
        if (!string.IsNullOrEmpty(selectedSeverity))
        {
            var defaults = WoundState.GetSeverityDefaults(selectedSeverity);
            asPenalty = defaults.asPenalty;
            fatDamage = defaults.fatPerTick;
            vitDamage = defaults.vitPerTick;

            // Set default healing time based on severity (use weeks for 7+ days)
            var healingSeconds = WoundState.GetDefaultHealingTimeSeconds(selectedSeverity);
            var healingDays = (int)(healingSeconds / 86400);
            if (healingDays >= 7 && healingDays % 7 == 0)
            {
                healingTimeValue = healingDays / 7;
                healingTimeUnit = "weeks";
            }
            else
            {
                healingTimeValue = healingDays;
                healingTimeUnit = "days";
            }
        }
    }

    private async Task SaveWound()
    {
        if (!IsFormValid) return;

        isProcessing = true;
        errorMessage = null;

        try
        {
            // Re-fetch character for fresh state
            var character = await characterPortal.FetchAsync(CharacterId);

            // Sync character's game time to the table's current time if behind.
            // This prevents wounds from being created with a stale base time that
            // would cause them to expire prematurely on the next time advancement.
            if (TableId != Guid.Empty)
            {
                try
                {
                    var gameTable = await tableDal.GetTableAsync(TableId);
                    var tableCurrentTime = gameTable.StartTimeSeconds + (gameTable.CurrentRound * 3L);
                    if (tableCurrentTime > character.CurrentGameTimeSeconds)
                        character.CurrentGameTimeSeconds = tableCurrentTime;
                }
                catch { /* ignore if table can't be loaded â€” use character's own time */ }
            }

            var healingSeconds = GetHealingTimeSeconds();

            if (ExistingWound != null)
            {
                // Edit: Find and update existing wound
                var wound = character.Effects.FirstOrDefault(e => e.Id == ExistingWound.Id);
                if (wound != null)
                {
                    var state = WoundState.Deserialize(wound.BehaviorState);
                    state.Severity = selectedSeverity;
                    state.Description = description;
                    state.CustomASPenalty = asPenalty;
                    state.FatDamagePerTick = fatDamage;
                    state.VitDamagePerTick = vitDamage;
                    state.ExpiryTimeSeconds = healingSeconds.HasValue
                        ? character.CurrentGameTimeSeconds + healingSeconds.Value
                        : null;
                    wound.BehaviorState = state.Serialize();
                    wound.Location = selectedLocation;
                    wound.Name = $"Wound: {selectedLocation}";
                    wound.Description = description;
                }
            }
            else
            {
                // Add: Create new wound using WoundBehavior.CreateCustomWound
                WoundBehavior.CreateCustomWound(
                    character, effectPortal,
                    selectedLocation, selectedSeverity, description,
                    asPenalty, fatDamage, vitDamage,
                    healingSeconds);
            }

            await characterPortal.UpdateAsync(character);

            // Publish update
            await TimeEventPublisher.PublishCharacterUpdateAsync(new CharacterUpdateMessage
            {
                CharacterId = CharacterId,
                UpdateType = CharacterUpdateType.EffectAdded,
                CampaignId = TableId.ToString(),
                SourceId = "GM",
                Description = $"Wound {(ExistingWound != null ? "updated" : "added")}: {description}"
            });

            DialogService.Close(true);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving wound: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void Cancel()
    {
        DialogService.Close(false);
    }
}
