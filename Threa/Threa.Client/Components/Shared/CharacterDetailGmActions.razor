@* GM Actions tab - damage, healing, effects, and character management *@

@using GameMechanics
@using GameMechanics.Messaging
@using Threa.Dal.Dto

@inject IDataPortal<CharacterEdit> characterPortal
@inject IChildDataPortal<EffectRecord> effectPortal
@inject IDataPortal<GameMechanics.GamePlay.TableCharacterDetacher> detacherPortal
@inject ITimeEventPublisher TimeEventPublisher

<div class="row g-3">
    <!-- Apply Damage -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-danger text-white">
                <strong><i class="bi bi-heart-pulse me-1"></i>Apply Damage</strong>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Amount</label>
                    <input type="number" class="form-control" @bind="damageAmount" min="1" />
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-danger flex-grow-1" @onclick="ApplyDamageToFat" disabled="@isProcessing">
                        <i class="bi bi-dash-circle me-1"></i>FAT
                    </button>
                    <button class="btn btn-danger flex-grow-1" @onclick="ApplyDamageToVit" disabled="@isProcessing">
                        <i class="bi bi-dash-circle me-1"></i>VIT
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Apply Healing -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <strong><i class="bi bi-bandaid me-1"></i>Apply Healing</strong>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Amount</label>
                    <input type="number" class="form-control" @bind="healAmount" min="1" />
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-success flex-grow-1" @onclick="ApplyHealingToFat" disabled="@isProcessing">
                        <i class="bi bi-plus-circle me-1"></i>FAT
                    </button>
                    <button class="btn btn-success flex-grow-1" @onclick="ApplyHealingToVit" disabled="@isProcessing">
                        <i class="bi bi-plus-circle me-1"></i>VIT
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Effects -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-warning text-dark">
                <strong><i class="bi bi-stars me-1"></i>Apply Effect</strong>
            </div>
            <div class="card-body">
                <select class="form-select mb-2" @bind="selectedEffect">
                    <option value="">Select effect...</option>
                    <option value="Stunned">Stunned</option>
                    <option value="Blinded">Blinded</option>
                    <option value="Prone">Prone</option>
                    <option value="Frightened">Frightened</option>
                    <option value="Slowed">Slowed</option>
                </select>
                <button class="btn btn-warning w-100" @onclick="ApplyEffect"
                        disabled="@(string.IsNullOrEmpty(selectedEffect) || isProcessing)">
                    <i class="bi bi-plus-lg me-1"></i>Apply Effect
                </button>
            </div>
        </div>
    </div>

    <!-- Character Management -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-secondary text-white">
                <strong><i class="bi bi-gear me-1"></i>Character Management</strong>
            </div>
            <div class="card-body d-flex flex-column">
                <p class="text-muted small flex-grow-1">
                    Remove this character from the table. They will need to submit a new join request to rejoin.
                </p>
                <button class="btn btn-outline-danger w-100" @onclick="ConfirmRemove" disabled="@isProcessing">
                    <i class="bi bi-x-circle me-1"></i>Remove from Table
                </button>
            </div>
        </div>
    </div>
</div>

@* Feedback messages *@
@if (!string.IsNullOrEmpty(feedbackMessage))
{
    <div class="alert @feedbackClass mt-3 alert-dismissible fade show" role="alert">
        <i class="bi @feedbackIcon me-1"></i>
        @feedbackMessage
        <button type="button" class="btn-close" @onclick="() => feedbackMessage = null"></button>
    </div>
}

@* Remove Confirmation Dialog *@
@if (showRemoveConfirm)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Remove Character</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CancelRemove"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to remove <strong>@Character?.Name</strong> from this table?</p>
                    <p class="text-muted small">The character will no longer be attached to this campaign and the player will need to submit a new join request to rejoin.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelRemove">Cancel</button>
                    <button type="button" class="btn btn-danger" @onclick="ExecuteRemove" disabled="@isProcessing">
                        <i class="bi bi-x-circle"></i> Remove
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public CharacterEdit? Character { get; set; }

    [Parameter]
    public int CharacterId { get; set; }

    [Parameter]
    public Guid TableId { get; set; }

    [Parameter]
    public EventCallback OnCharacterRemoved { get; set; }

    [Parameter]
    public EventCallback OnCharacterUpdated { get; set; }

    // Form state
    private int damageAmount = 1;
    private int healAmount = 1;
    private string selectedEffect = "";
    private bool isProcessing;
    private bool showRemoveConfirm;

    // Feedback
    private string? feedbackMessage;
    private string feedbackClass = "alert-info";
    private string feedbackIcon = "bi-info-circle";

    // Wrapper methods for button clicks
    private Task ApplyDamageToFat() => ApplyDamageToPool("FAT");
    private Task ApplyDamageToVit() => ApplyDamageToPool("VIT");
    private Task ApplyHealingToFat() => ApplyHealingToPool("FAT");
    private Task ApplyHealingToVit() => ApplyHealingToPool("VIT");

    private async Task ApplyDamageToPool(string pool)
    {
        if (Character == null) return;
        isProcessing = true;

        try
        {
            var character = await characterPortal.FetchAsync(CharacterId);

            if (pool == "FAT")
            {
                character.Fatigue.PendingDamage += damageAmount;
            }
            else
            {
                character.Vitality.PendingDamage += damageAmount;
            }

            await characterPortal.UpdateAsync(character);

            await TimeEventPublisher.PublishCharacterUpdateAsync(new CharacterUpdateMessage
            {
                CharacterId = CharacterId,
                UpdateType = CharacterUpdateType.Damage,
                CampaignId = TableId.ToString(),
                SourceId = "GM",
                Description = $"{damageAmount} {pool} damage"
            });

            ShowFeedback($"Saved: {damageAmount} {pool} damage applied", "alert-success", "bi-check-circle");
            await OnCharacterUpdated.InvokeAsync();
        }
        catch (Exception ex)
        {
            ShowFeedback($"Error saving: {ex.Message}", "alert-danger", "bi-exclamation-triangle");
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task ApplyHealingToPool(string pool)
    {
        if (Character == null) return;
        isProcessing = true;

        try
        {
            var character = await characterPortal.FetchAsync(CharacterId);

            if (pool == "FAT")
            {
                character.Fatigue.PendingHealing += healAmount;
            }
            else
            {
                character.Vitality.PendingHealing += healAmount;
            }

            await characterPortal.UpdateAsync(character);

            await TimeEventPublisher.PublishCharacterUpdateAsync(new CharacterUpdateMessage
            {
                CharacterId = CharacterId,
                UpdateType = CharacterUpdateType.Healing,
                CampaignId = TableId.ToString(),
                SourceId = "GM",
                Description = $"{healAmount} {pool} healing"
            });

            ShowFeedback($"Saved: {healAmount} {pool} healing applied", "alert-success", "bi-check-circle");
            await OnCharacterUpdated.InvokeAsync();
        }
        catch (Exception ex)
        {
            ShowFeedback($"Error saving: {ex.Message}", "alert-danger", "bi-exclamation-triangle");
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task ApplyEffect()
    {
        if (Character == null || string.IsNullOrEmpty(selectedEffect)) return;
        isProcessing = true;

        try
        {
            var character = await characterPortal.FetchAsync(CharacterId);

            var effect = await effectPortal.CreateChildAsync(
                EffectType.Condition,
                selectedEffect,
                (string?)null,
                (int?)null,
                (string?)null
            );
            effect.Source = "GM";

            character.Effects.AddEffect(effect);
            await characterPortal.UpdateAsync(character);

            await TimeEventPublisher.PublishCharacterUpdateAsync(new CharacterUpdateMessage
            {
                CharacterId = CharacterId,
                UpdateType = CharacterUpdateType.EffectAdded,
                CampaignId = TableId.ToString(),
                SourceId = "GM",
                Description = selectedEffect
            });

            ShowFeedback($"Saved: {selectedEffect} effect applied", "alert-success", "bi-check-circle");
            selectedEffect = "";
            await OnCharacterUpdated.InvokeAsync();
        }
        catch (Exception ex)
        {
            ShowFeedback($"Error saving: {ex.Message}", "alert-danger", "bi-exclamation-triangle");
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void ConfirmRemove()
    {
        showRemoveConfirm = true;
    }

    private void CancelRemove()
    {
        showRemoveConfirm = false;
    }

    private async Task ExecuteRemove()
    {
        isProcessing = true;

        try
        {
            var result = await detacherPortal.ExecuteAsync(CharacterId);

            if (result.Success)
            {
                await OnCharacterRemoved.InvokeAsync();
            }
            else
            {
                ShowFeedback($"Error: {result.ErrorMessage}", "alert-danger", "bi-exclamation-triangle");
            }
        }
        catch (Exception ex)
        {
            ShowFeedback($"Error: {ex.Message}", "alert-danger", "bi-exclamation-triangle");
        }
        finally
        {
            isProcessing = false;
            showRemoveConfirm = false;
        }
    }

    private void ShowFeedback(string message, string alertClass, string icon = "bi-check-circle")
    {
        feedbackMessage = message;
        feedbackClass = alertClass;
        feedbackIcon = icon;
    }
}
