@* Character Detail Narrative - Appearance, backstory, and editable GM notes *@

@using GameMechanics
@using GameMechanics.Messaging
@using GameMechanics.Time.Calendars
@using Threa.Dal

@inject ITableDal tableDal
@inject IDataPortal<CharacterEdit> characterPortal
@inject ITimeEventPublisher TimeEventPublisher
@inject IGameCalendarProvider CalendarProvider

<div class="row">
    <!-- Left: Appearance -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header"><strong>Appearance</strong></div>
            <div class="card-body">
                @if (!string.IsNullOrEmpty(Character?.ImageUrl))
                {
                    <img src="@Character.ImageUrl" alt="@Character.Name" class="img-fluid rounded mb-3" style="max-height: 150px;" />
                }

                <table class="table table-sm mb-0">
                    <tbody>
                        <tr>
                            <td class="text-muted">Height</td>
                            <td>@(string.IsNullOrEmpty(Character?.Height) ? "-" : Character.Height)</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Weight</td>
                            <td>@(string.IsNullOrEmpty(Character?.Weight) ? "-" : Character.Weight)</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Skin</td>
                            <td>@(string.IsNullOrEmpty(Character?.SkinDescription) ? "-" : Character.SkinDescription)</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Hair</td>
                            <td>@(string.IsNullOrEmpty(Character?.HairDescription) ? "-" : Character.HairDescription)</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Age</td>
                            <td>
                                @if (Character != null && Character.Birthdate.HasValue)
                                {
                                    var calendar = CalendarProvider.GetDefaultCalendar(TableTheme);
                                    long ageSeconds = CurrentTimeSeconds - Character.Birthdate.Value;
                                    long ageYears = ageSeconds / calendar.SecondsPerYear;
                                    <span class="text-primary" style="cursor: pointer; text-decoration: underline dotted;"
                                          title="Click to change birthdate"
                                          @onclick="ToggleBirthdatePicker">@ageYears year@(ageYears != 1 ? "s" : "")</span>
                                }
                                else
                                {
                                    <span class="text-muted" style="cursor: pointer;"
                                          title="Click to set birthdate"
                                          @onclick="ToggleBirthdatePicker"><em>Not set</em></span>
                                }
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        @if (showBirthdatePicker)
        {
            <div class="mt-3">
                <CalendarTimePicker EpochSeconds="@(Character?.Birthdate ?? CurrentTimeSeconds)"
                                   Theme="@TableTheme"
                                   OnTimeSet="OnBirthdateSet"
                                   OnCancel="() => showBirthdatePicker = false" />
            </div>
        }

        <!-- Aliases -->
        @if (!string.IsNullOrEmpty(Character?.Aliases))
        {
            <div class="card mt-3">
                <div class="card-header"><strong>Aliases</strong></div>
                <div class="card-body">
                    <p class="mb-0">@Character.Aliases</p>
                </div>
            </div>
        }
    </div>

    <!-- Right: Backstory and Notes -->
    <div class="col-md-6">
        <!-- Player Description/Backstory -->
        <div class="card">
            <div class="card-header"><strong>Backstory</strong></div>
            <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                @if (string.IsNullOrEmpty(Character?.Description))
                {
                    <p class="text-muted mb-0">No backstory provided.</p>
                }
                else
                {
                    <p class="mb-0" style="white-space: pre-wrap;">@Character.Description</p>
                }
            </div>
        </div>

        <!-- Player Notes (read-only) -->
        @if (!string.IsNullOrEmpty(Character?.Notes))
        {
            <div class="card mt-3">
                <div class="card-header"><strong>Player Notes</strong></div>
                <div class="card-body" style="max-height: 150px; overflow-y: auto;">
                    <p class="mb-0" style="white-space: pre-wrap;">@Character.Notes</p>
                </div>
            </div>
        }

        <!-- GM Notes (editable) -->
        <div class="card mt-3 border-warning">
            <div class="card-header bg-warning text-dark">
                <strong><i class="bi bi-eye-slash me-1"></i>GM Notes</strong>
                <small class="ms-2">(Private - not visible to player)</small>
            </div>
            <div class="card-body">
                <textarea class="form-control" rows="4"
                          placeholder="Add private notes about this character..."
                          @bind="gmNotes"
                          @onblur="SaveGmNotes"
                          disabled="@isSaving"></textarea>
                @if (isSaving)
                {
                    <small class="text-muted"><i class="bi bi-arrow-repeat"></i> Saving...</small>
                }
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public CharacterEdit? Character { get; set; }

    [Parameter]
    public Guid TableId { get; set; }

    [Parameter]
    public int CharacterId { get; set; }

    [Parameter]
    public string? InitialGmNotes { get; set; }

    [Parameter]
    public EventCallback<string?> OnGmNotesChanged { get; set; }

    [Parameter]
    public long CurrentTimeSeconds { get; set; }

    [Parameter]
    public string TableTheme { get; set; } = "fantasy";

    [Parameter]
    public EventCallback OnCharacterUpdated { get; set; }

    private string? gmNotes;
    private bool isSaving;
    private bool showBirthdatePicker;

    protected override void OnInitialized()
    {
        gmNotes = InitialGmNotes;
    }

    protected override void OnParametersSet()
    {
        // Update gmNotes when InitialGmNotes changes (e.g., when switching characters)
        gmNotes = InitialGmNotes;
    }

    private void ToggleBirthdatePicker()
    {
        showBirthdatePicker = !showBirthdatePicker;
    }

    private async Task OnBirthdateSet(long newBirthdate)
    {
        showBirthdatePicker = false;
        if (Character == null) return;

        try
        {
            var character = await characterPortal.FetchAsync(CharacterId);
            character.Birthdate = newBirthdate;
            await characterPortal.UpdateAsync(character);

            await TimeEventPublisher.PublishCharacterUpdateAsync(new CharacterUpdateMessage
            {
                CharacterId = CharacterId,
                UpdateType = CharacterUpdateType.General,
                CampaignId = TableId.ToString(),
                Description = "Birthdate updated"
            });

            await OnCharacterUpdated.InvokeAsync();
        }
        catch
        {
            // Silently fail - character will reload on next refresh
        }
    }

    private async Task SaveGmNotes()
    {
        if (isSaving) return;
        isSaving = true;
        try
        {
            await tableDal.UpdateGmNotesAsync(TableId, CharacterId, gmNotes);
            await OnGmNotesChanged.InvokeAsync(gmNotes);
        }
        finally
        {
            isSaving = false;
        }
    }
}
