@namespace Threa.Client.Components.Shared

@using GameMechanics.Time.Calendars

<div class="row g-2">
    <div class="col-6">
        <label class="form-label small">Year</label>
        <input type="number" class="form-control" value="@year" @onchange="e => SetYear(e)" min="0" />
    </div>
    <div class="col-6">
        <label class="form-label small">Month</label>
        <select class="form-select" value="@month" @onchange="e => SetMonth(e)">
            @for (int i = 0; i < ImperialCalendar.MonthNames.Length; i++)
            {
                <option value="@i">@(i + 1) - @ImperialCalendar.MonthNames[i]</option>
            }
        </select>
    </div>
    <div class="col-6">
        <label class="form-label small">Day (1-@maxDay)</label>
        <input type="number" class="form-control" value="@(day + 1)" @onchange="e => SetDay(e)" min="1" max="@maxDay" />
    </div>
    <div class="col-6">
        <label class="form-label small">Bell (1-24)</label>
        <input type="number" class="form-control" value="@(bell + 1)" @onchange="e => SetBell(e)" min="1" max="24" />
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public long EpochSeconds { get; set; }

    [Parameter]
    public EventCallback<long> OnChanged { get; set; }

    private long year;
    private int month, day, bell;
    private int maxDay => ImperialCalendar.GetDaysInMonth(month);

    protected override void OnParametersSet()
    {
        (year, month, day, bell) = ImperialCalendar.DecomposeDateTime(EpochSeconds);
    }

    private async Task SetYear(ChangeEventArgs e) { year = ParseLong(e); await Recompose(); }
    private async Task SetMonth(ChangeEventArgs e) { month = ParseInt(e); await Recompose(); }
    private async Task SetDay(ChangeEventArgs e) { day = ParseInt(e) - 1; await Recompose(); }
    private async Task SetBell(ChangeEventArgs e) { bell = ParseInt(e) - 1; await Recompose(); }

    private async Task Recompose()
    {
        var epoch = ImperialCalendar.ComposeDateTime(year, month, day, bell);
        await OnChanged.InvokeAsync(epoch);
    }

    private static long ParseLong(ChangeEventArgs e) =>
        long.TryParse(e.Value?.ToString(), out var v) ? v : 0;

    private static int ParseInt(ChangeEventArgs e) =>
        int.TryParse(e.Value?.ToString(), out var v) ? v : 0;
}
