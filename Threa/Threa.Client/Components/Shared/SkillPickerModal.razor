@* Skill Picker Modal - Allows GM to select a skill to add to a character *@

@using GameMechanics.Reference
@using Radzen

@inject IDataPortal<SkillList> skillListPortal
@inject DialogService DialogService

<div class="skill-picker-modal">
    <!-- Search box -->
    <div class="mb-2">
        <input type="text"
               class="form-control form-control-sm"
               placeholder="Search skills..."
               @bind="searchText"
               @bind:event="oninput" />
    </div>

    <!-- Category filter -->
    <div class="mb-2">
        <div class="btn-group btn-group-sm flex-wrap" role="group">
            <button type="button"
                    class="btn btn-sm @(selectedCategory == null ? "btn-primary" : "btn-outline-primary")"
                    @onclick="() => selectedCategory = null">
                All
            </button>
            @foreach (var category in availableCategories)
            {
                <button type="button"
                        class="btn btn-sm @(selectedCategory == category ? "btn-primary" : "btn-outline-primary")"
                        @onclick="() => selectedCategory = category">
                    @category
                </button>
            }
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading skills...</span>
            </div>
        </div>
    }
    else if (filteredSkills.Any())
    {
        <!-- Skills list - no inner scroll, modal handles it -->
        <div class="skill-list">
            @foreach (var skill in filteredSkills.OrderBy(s => s.Name))
            {
                <div class="skill-item d-flex align-items-center gap-2 py-1 border-bottom skill-picker-row"
                     style="cursor: pointer;"
                     @onclick="() => SelectSkill(skill)">
                    <span class="flex-grow-1 small">@skill.Name</span>
                    <span class="text-muted small" style="min-width: 65px; text-align: center; flex-shrink: 0; white-space: nowrap;">@skill.PrimaryAttribute</span>
                    @if (skill.IsSpecialized)
                    {
                        <span class="badge bg-info" style="font-size: 0.65rem;" title="Specialized skill">Spec</span>
                    }
                    @if (skill.IsMagic || skill.IsTheology || skill.IsPsionic)
                    {
                        var magicType = skill.IsMagic ? "Magic" : skill.IsTheology ? "Theology" : "Psionic";
                        <span class="badge badge-purple" style="font-size: 0.65rem;" title="@magicType skill">@magicType</span>
                    }
                </div>
            }
        </div>
    }
    else
    {
        <div class="alert alert-info py-2 small">
            <i class="bi bi-info-circle me-1"></i>
            @if (!string.IsNullOrEmpty(searchText) || selectedCategory != null)
            {
                <span>No skills match your filter criteria.</span>
            }
            else
            {
                <span>No skills available to add.</span>
            }
        </div>
    }

    <!-- Cancel button -->
    <div class="mt-2 text-end">
        <button class="btn btn-secondary btn-sm" @onclick="Cancel">Cancel</button>
    </div>
</div>

<style>
    .skill-picker-row:hover {
        background-color: var(--bs-tertiary-bg);
    }
</style>

@code {
    /// <summary>
    /// Skill IDs the character already has (to exclude from picker).
    /// </summary>
    [Parameter]
    public HashSet<string> ExistingSkillIds { get; set; } = new();

    /// <summary>
    /// The table theme. If "scifi", magic skills are filtered out.
    /// </summary>
    [Parameter]
    public string TableTheme { get; set; } = "fantasy";

    private bool isLoading = true;
    private List<SkillInfo> allSkills = new();
    private string searchText = "";
    private string? selectedCategory;

    private IEnumerable<SkillInfo> filteredSkills => allSkills
        .Where(s => !ExistingSkillIds.Contains(s.Id))
        .Where(s => TableTheme != "scifi" || (!s.IsMagic && !s.IsTheology && !s.IsPsionic))
        .Where(s => string.IsNullOrEmpty(searchText) ||
                    s.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                    s.PrimaryAttribute.Contains(searchText, StringComparison.OrdinalIgnoreCase))
        .Where(s => selectedCategory == null || GetCategoryDisplay(s) == selectedCategory);

    private IEnumerable<string> availableCategories => allSkills
        .Where(s => !ExistingSkillIds.Contains(s.Id))
        .Where(s => TableTheme != "scifi" || (!s.IsMagic && !s.IsTheology && !s.IsPsionic))
        .Select(GetCategoryDisplay)
        .Distinct()
        .OrderBy(c => c);

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var skillList = await skillListPortal.FetchAsync();
            allSkills = skillList.ToList();
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetCategoryDisplay(SkillInfo skill)
    {
        if (skill.IsMagic) return "Magic";
        if (skill.IsTheology) return "Theology";
        if (skill.IsPsionic) return "Psionic";
        if (skill.IsSpecialized) return "Specialized";
        return "General";
    }

    private void SelectSkill(SkillInfo skill)
    {
        DialogService.Close(skill.Id);
    }

    private void Cancel()
    {
        DialogService.Close(null);
    }
}
