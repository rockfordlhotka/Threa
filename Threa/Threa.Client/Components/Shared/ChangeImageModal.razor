@* Modal for changing character image URL *@

@using Radzen

@inject DialogService DialogService

<div class="p-3">
    <div class="mb-3">
        <label for="imageUrl" class="form-label">Image URL</label>
        <input type="text" 
               class="form-control" 
               id="imageUrl"
               placeholder="https://example.com/image.jpg"
               @bind="imageUrl" 
               @bind:event="oninput"
               @bind:after="OnImageUrlChanged" />
        <div class="form-text">Enter a valid URL for your character's image</div>
    </div>

    @if (!string.IsNullOrEmpty(imageUrl))
    {
        <div class="mb-3">
            <label class="form-label">Preview</label>
            <div class="text-center p-2 border rounded">
                <img src="@imageUrl" 
                     alt="Character preview" 
                     style="max-width: 200px; max-height: 200px; object-fit: contain;"
                     @onerror="OnImageError" />
            </div>
            @if (imageLoadError)
            {
                <div class="alert alert-warning mt-2 py-2">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    Unable to load image. Please check the URL.
                </div>
            }
        </div>
    }

    <div class="d-flex justify-content-end gap-2 mt-3">
        <button class="btn btn-secondary" @onclick="Cancel">Cancel</button>
        <button class="btn btn-primary" 
                @onclick="Save" 
                disabled="@(string.IsNullOrWhiteSpace(imageUrl) || imageLoadError)">
            Save
        </button>
    </div>
</div>

@code {
    [Parameter]
    public string CurrentImageUrl { get; set; } = string.Empty;

    private string imageUrl = string.Empty;
    private bool imageLoadError = false;

    protected override void OnInitialized()
    {
        imageUrl = CurrentImageUrl;
    }

    private void OnImageUrlChanged()
    {
        // Reset error flag when URL changes
        imageLoadError = false;
    }

    private void OnImageError()
    {
        imageLoadError = true;
        StateHasChanged();
    }

    private void Save()
    {
        DialogService.Close(imageUrl.Trim());
    }

    private void Cancel()
    {
        DialogService.Close(null);
    }
}
