@* Modal for unloading a weapon from inventory back to loose ammo *@

@using GameMechanics
@using GameMechanics.Combat
@using Threa.Dal
@using Threa.Dal.Dto
@using Radzen

@inject DialogService DialogService

<div class="p-3">
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-1"></i>@errorMessage
        </div>
    }

    @* Weapon Info *@
    <div class="card mb-3">
        <div class="card-body">
            <h6 class="card-title">@WeaponName</h6>
            <div class="d-flex gap-3">
                <div>
                    <small class="text-muted">Currently Loaded</small>
                    <div class="fw-bold">@currentAmmo / @totalCapacity</div>
                </div>
                @if (!string.IsNullOrEmpty(loadedAmmoType))
                {
                    <div>
                        <small class="text-muted">Ammo Type</small>
                        <div class="fw-bold">@loadedAmmoType</div>
                    </div>
                }
            </div>
        </div>
    </div>

    @if (currentAmmo <= 0)
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-circle me-1"></i>
            This weapon is empty - nothing to unload.
        </div>
    }
    else
    {
        @* Quantity Slider *@
        <div class="mb-3">
            <label class="form-label">Rounds to Unload: <strong>@roundsToUnload</strong></label>
            <input type="range" class="form-range"
                   min="1" max="@currentAmmo"
                   @bind="roundsToUnload" @bind:event="oninput" />
            <div class="d-flex justify-content-between text-muted small">
                <span>1</span>
                <span>All: @currentAmmo</span>
            </div>
        </div>

        @* Unload Cost Selection *@
        <div class="mb-3">
            <label class="form-label">Unload Cost</label>
            @if (!CanAffordAnyCost)
            {
                <div class="alert alert-danger py-2">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    Not enough AP or FAT to unload.
                </div>
            }
            else
            {
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="unloadCost" id="normalUnload"
                           checked="@(!useTwoApCost)" @onchange="() => useTwoApCost = false"
                           disabled="@(!CanAffordOneApOneFat)" />
                    <label class="form-check-label @(!CanAffordOneApOneFat ? "text-muted" : "")" for="normalUnload">
                        <strong>1 AP + 1 FAT</strong>
                        @if (!CanAffordOneApOneFat)
                        {
                            <span class="text-danger ms-2">(not enough)</span>
                        }
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="unloadCost" id="twoApUnload"
                           checked="@useTwoApCost" @onchange="() => useTwoApCost = true"
                           disabled="@(!CanAffordTwoAp)" />
                    <label class="form-check-label @(!CanAffordTwoAp ? "text-muted" : "")" for="twoApUnload">
                        <strong>2 AP</strong>
                        <span class="text-muted ms-2">(no fatigue)</span>
                        @if (!CanAffordTwoAp)
                        {
                            <span class="text-danger ms-2">(not enough)</span>
                        }
                    </label>
                </div>
            }
        </div>

        @* Duration Display *@
        <div class="alert alert-info">
            <i class="bi bi-clock me-1"></i>
            <strong>Duration:</strong> @durationRounds round(s) of concentration
            <br />
            <small class="text-muted">Rate: 6 rounds per game round (2 per second) - half of reload time</small>
            <br />
            <small class="text-warning">
                <i class="bi bi-exclamation-triangle me-1"></i>
                Taking other actions will break concentration and cancel the unload.
            </small>
        </div>
    }

    @* Action Buttons *@
    <div class="d-flex justify-content-end gap-2 mt-3">
        <button type="button" class="btn btn-secondary" @onclick="Cancel">
            Cancel
        </button>
        <button type="button" class="btn btn-warning"
                @onclick="Confirm"
                disabled="@(!IsFormValid)">
            <i class="bi bi-box-arrow-up me-1"></i>
            Start Unload
        </button>
    </div>
</div>

@code {
    [Parameter] public CharacterItem? Weapon { get; set; }
    [Parameter] public string WeaponName { get; set; } = "";
    [Parameter] public int AvailableAp { get; set; }
    [Parameter] public int AvailableFat { get; set; }

    // Cost availability
    private bool CanAffordOneApOneFat => AvailableAp >= 1 && AvailableFat >= 1;
    private bool CanAffordTwoAp => AvailableAp >= 2;
    private bool CanAffordAnyCost => CanAffordOneApOneFat || CanAffordTwoAp;
    private bool CanAffordSelectedCost => useTwoApCost ? CanAffordTwoAp : CanAffordOneApOneFat;

    private int roundsToUnload = 1;
    private bool useTwoApCost = false;
#pragma warning disable CS0649 // Field is never assigned - reserved for future validation
    private string? errorMessage;
#pragma warning restore CS0649

    // Weapon state
    private int currentAmmo;
    private int totalCapacity;
    private string? loadedAmmoType;

    // Computed values - unload is twice as fast (6 rounds per game round instead of 3)
    private int durationRounds => (int)Math.Ceiling(roundsToUnload / 6.0);
    private bool IsFormValid => currentAmmo > 0 && roundsToUnload > 0 && roundsToUnload <= currentAmmo && CanAffordSelectedCost;

    protected override void OnParametersSet()
    {
        // Default to an available cost option
        if (!CanAffordOneApOneFat && CanAffordTwoAp)
        {
            useTwoApCost = true;
        }
        else if (CanAffordOneApOneFat)
        {
            useTwoApCost = false;
        }

        if (Weapon != null)
        {
            // Load weapon state
            var ammoState = WeaponAmmoState.FromJson(Weapon.CustomProperties);
            currentAmmo = ammoState.TotalAvailable;
            loadedAmmoType = ammoState.LoadedAmmoType;

            // Get weapon properties from template for display
            if (Weapon.Template != null)
            {
                var weaponProps = RangedWeaponProperties.FromJson(Weapon.Template.CustomProperties);
                if (weaponProps != null)
                {
                    totalCapacity = weaponProps.TotalCapacity;
                    // If no loaded ammo type, use weapon's ammo type
                    loadedAmmoType ??= weaponProps.AmmoType;
                }
            }

            // Default to unloading everything
            roundsToUnload = currentAmmo;
        }
    }

    private void Cancel()
    {
        DialogService.Close(null);
    }

    private void Confirm()
    {
        if (!IsFormValid) return;

        var result = new UnloadWeaponResult
        {
            WeaponItemId = Weapon!.Id,
            RoundsToUnload = roundsToUnload,
            AmmoType = loadedAmmoType,
            WeaponName = WeaponName,
            DurationRounds = durationRounds,
            UseTwoApCost = useTwoApCost
        };

        DialogService.Close(result);
    }
}
