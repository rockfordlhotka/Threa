@* Dialog for confirming concentration break before taking actions *@

@using GameMechanics.Effects.Behaviors
@using Threa.Dal.Dto

@inject Radzen.DialogService DialogService

<div class="concentration-break-dialog">
    <div class="dialog-content">
        <p class="mb-3">You are concentrating on:</p>

        <div class="concentration-details card p-3 mb-3 bg-light">
            <h5 class="mb-2">@GetConcentrationName()</h5>
            @if (IsCastingTime)
            {
                <p class="text-muted mb-0">
                    <i class="bi bi-clock"></i>
                    Progress: @CurrentProgress / @TotalRequired rounds
                </p>
                <p class="text-warning mb-0">
                    <small>Interrupting will cancel the action.</small>
                </p>
            }
            else if (IsSustained)
            {
                @if (LinkedEffectCount > 0)
                {
                    <p class="text-muted mb-0">
                        <i class="bi bi-link-45deg"></i>
                        Maintaining @LinkedEffectCount effect(s) on target(s)
                    </p>
                }
                @if (DrainPerRound != null)
                {
                    <p class="text-muted mb-0">
                        <i class="bi bi-lightning"></i>
                        Draining @DrainPerRound per round
                    </p>
                }
                <p class="text-warning mb-0">
                    <small>Breaking will end the effect immediately.</small>
                </p>
            }
        </div>

        <p class="text-danger">
            <strong>Taking this action will break concentration.</strong>
        </p>
    </div>

    <div class="dialog-buttons d-flex justify-content-end gap-2 mt-4">
        <RadzenButton Text="Cancel"
                      ButtonStyle="Radzen.ButtonStyle.Light"
                      Click="@OnCancel" />
        <RadzenButton Text="Break & Continue"
                      ButtonStyle="Radzen.ButtonStyle.Danger"
                      Click="@OnConfirm" />
    </div>
</div>

@code {
    /// <summary>
    /// The concentration type (e.g., "MagazineReload", "SustainedSpell")
    /// </summary>
    [Parameter]
    public string? ConcentrationType { get; set; }

    /// <summary>
    /// The name of the concentration effect (e.g., "Invisibility", "Reloading Magazine")
    /// </summary>
    [Parameter]
    public string? EffectName { get; set; }

    /// <summary>
    /// The spell name for sustained spells
    /// </summary>
    [Parameter]
    public string? SpellName { get; set; }

    /// <summary>
    /// Current progress for casting-time concentration
    /// </summary>
    [Parameter]
    public int CurrentProgress { get; set; }

    /// <summary>
    /// Total required rounds for casting-time concentration
    /// </summary>
    [Parameter]
    public int TotalRequired { get; set; }

    /// <summary>
    /// Number of linked effects for sustained concentration
    /// </summary>
    [Parameter]
    public int LinkedEffectCount { get; set; }

    /// <summary>
    /// FAT drain per round for sustained concentration
    /// </summary>
    [Parameter]
    public int FatDrainPerRound { get; set; }

    /// <summary>
    /// VIT drain per round for sustained concentration
    /// </summary>
    [Parameter]
    public int VitDrainPerRound { get; set; }

    private bool IsCastingTime => ConcentrationType == "MagazineReload"
        || ConcentrationType == "SpellCasting"
        || ConcentrationType == "RitualPreparation";

    private bool IsSustained => ConcentrationType == "SustainedSpell"
        || ConcentrationType == "SustainedAbility"
        || ConcentrationType == "MentalControl";

    private string? DrainPerRound
    {
        get
        {
            var parts = new List<string>();
            if (FatDrainPerRound > 0)
                parts.Add($"{FatDrainPerRound} FAT");
            if (VitDrainPerRound > 0)
                parts.Add($"{VitDrainPerRound} VIT");

            return parts.Count > 0 ? string.Join(" + ", parts) : null;
        }
    }

    private string GetConcentrationName()
    {
        if (!string.IsNullOrEmpty(SpellName))
            return SpellName;
        if (!string.IsNullOrEmpty(EffectName))
            return EffectName;
        return ConcentrationType ?? "Unknown";
    }

    private void OnCancel()
    {
        DialogService.Close(false);
    }

    private void OnConfirm()
    {
        DialogService.Close(true);
    }

    /// <summary>
    /// Shows the concentration break confirmation dialog.
    /// </summary>
    /// <param name="dialogService">The dialog service</param>
    /// <param name="state">The current concentration state</param>
    /// <param name="effectName">The effect name to display</param>
    /// <returns>True if user chose to break concentration, false if cancelled</returns>
    public static async Task<bool> ShowAsync(
        Radzen.DialogService dialogService,
        ConcentrationState state,
        string effectName)
    {
        var parameters = new Dictionary<string, object>
        {
            { nameof(ConcentrationType), state.ConcentrationType },
            { nameof(EffectName), effectName },
            { nameof(SpellName), state.SpellName ?? "" },
            { nameof(CurrentProgress), state.CurrentProgress },
            { nameof(TotalRequired), state.TotalRequired },
            { nameof(LinkedEffectCount), state.LinkedEffectIds?.Count ?? 0 },
            { nameof(FatDrainPerRound), state.FatDrainPerRound },
            { nameof(VitDrainPerRound), state.VitDrainPerRound }
        };

        var result = await dialogService.OpenAsync<ConcentrationBreakDialog>(
            "Break Concentration?",
            parameters,
            new Radzen.DialogOptions
            {
                Width = "400px",
                CloseDialogOnOverlayClick = true,
                ShowClose = true
            });

        return result is bool confirmed && confirmed;
    }
}
