@using GameMechanics
@using GameMechanics.GamePlay
@using GameMechanics.Messaging
@using GameMechanics.Effects.Behaviors
@using Radzen
@using Threa.Dal
@using Threa.Client.Components.Shared

@implements IAsyncDisposable

@inject IDataPortal<CharacterEdit> characterPortal
@inject DialogService DialogService
@inject ITableDal tableDal
@inject ITimeEventSubscriber TimeEventSubscriber

<div class="character-detail-modal">
    <!-- Header with character switcher, summary, and close -->
    <div class="modal-header d-flex align-items-center border-bottom pb-3 mb-3 gap-3">
        <!-- Character Selector -->
        <select class="form-select" style="max-width: 200px; flex-shrink: 0;" @bind="selectedCharacterId" @bind:after="OnCharacterChanged">
            @foreach (var charInfo in AllCharacters)
            {
                <option value="@charInfo.CharacterId">@charInfo.CharacterName</option>
            }
        </select>

        <!-- Character Summary (when loaded) -->
        @if (character != null && !isLoading)
        {
            <div class="d-flex align-items-center gap-3 flex-grow-1">
                <!-- Species -->
                <span class="text-muted small">@character.Species</span>

                <!-- Health Bars -->
                <div class="d-flex align-items-center gap-2" style="min-width: 200px;">
                    <div class="d-flex align-items-center gap-1">
                        <small class="text-muted" style="width: 28px; font-size: 0.7rem;">FAT</small>
                        <div style="width: 80px;">
                            <PendingPoolBar CurrentValue="@character.Fatigue.Value"
                                           MaxValue="@character.Fatigue.BaseValue"
                                           PendingDamage="@character.Fatigue.PendingDamage"
                                           PendingHealing="@character.Fatigue.PendingHealing"
                                           Height="8px" />
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-1">
                        <small class="text-muted" style="width: 28px; font-size: 0.7rem;">VIT</small>
                        <div style="width: 80px;">
                            <PendingPoolBar CurrentValue="@character.Vitality.Value"
                                           MaxValue="@character.Vitality.BaseValue"
                                           PendingDamage="@character.Vitality.PendingDamage"
                                           PendingHealing="@character.Vitality.PendingHealing"
                                           Height="8px" />
                        </div>
                    </div>
                </div>

                <!-- Status Badges -->
                <div class="d-flex gap-1">
                    <span class="badge bg-primary" title="Action Points">
                        <i class="bi bi-lightning-charge"></i> @character.ActionPoints.Available/@character.ActionPoints.Max
                    </span>
                    @foreach (var wound in character.Effects.Where(e => e.EffectType == Threa.Dal.Dto.EffectType.Wound))
                    {
                        var woundState = WoundState.Deserialize(wound.BehaviorState);
                        var severity = woundState?.Severity ?? "Unknown";
                        var description = woundState?.Description ?? wound.Location ?? "Wound";
                        var badgeClass = severity switch
                        {
                            "Critical" => "bg-danger",
                            "Severe" => "bg-danger-subtle text-danger",
                            "Moderate" => "bg-warning text-dark",
                            "Minor" => "bg-secondary",
                            _ => "bg-warning text-dark"
                        };

                        <span class="badge @badgeClass"
                              style="cursor: help;"
                              title="@($"{severity} wound at {wound.Location}: {description}")">
                            <i class="bi bi-bandaid"></i> @(wound.Location?.Replace("Left", "L").Replace("Right", "R") ?? "?")
                        </span>
                    }
                    @if (character.Effects.Count(e => e.EffectType != Threa.Dal.Dto.EffectType.Wound) > 0)
                    {
                        <span class="badge bg-info" title="Active Effects">
                            <i class="bi bi-stars"></i> @character.Effects.Count(e => e.EffectType != Threa.Dal.Dto.EffectType.Wound)
                        </span>
                    }
                </div>
            </div>
        }

        <!-- Close Button -->
        <button type="button" class="btn-close ms-auto" aria-label="Close" @onclick="Close"></button>
    </div>

    <!-- Tab navigation -->
    <div class="tab-buttons mb-3">
        @foreach (var tabName in tabNames)
        {
            <button class="tab-link @(activeTab == tabName ? "active" : "")"
                    @onclick="() => activeTab = tabName">
                @tabName
            </button>
        }
    </div>

    <!-- Tab content -->
    <div class="tab-content p-3" style="min-height: 400px; max-height: 70vh; overflow-y: auto;">
        @if (isLoading)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading character data...</p>
            </div>
        }
        else if (character != null)
        {
            @if (activeTab == "GM Actions")
            {
                <CharacterDetailGmActions Character="character"
                                          CharacterId="selectedCharacterId"
                                          TableId="TableId"
                                          OnCharacterRemoved="OnCharacterRemoved"
                                          OnCharacterUpdated="OnCharacterUpdated"
                                          OnEditStatsRequested="SwitchToSheetAndEdit" />
            }
            else if (activeTab == "Character Sheet")
            {
                <CharacterDetailSheet Character="character"
                                       CharacterId="selectedCharacterId"
                                       TableId="TableId"
                                       IsEditMode="@isEditMode"
                                       IsEditModeChanged="@((bool val) => { isEditMode = val; StateHasChanged(); })"
                                       OnCharacterUpdated="OnCharacterUpdated" />
            }
            else if (activeTab == "Effects")
            {
                <CharacterDetailEffects Character="character"
                                         CharacterId="selectedCharacterId"
                                         TableId="TableId" />
            }
            else if (activeTab == "Inventory")
            {
                <CharacterDetailInventory Character="character"
                                         CharacterId="selectedCharacterId"
                                         TableId="TableId" />
            }
            else if (activeTab == "Grant Items")
            {
                <CharacterDetailItemDistribution Character="character"
                                                  CharacterId="selectedCharacterId"
                                                  TableId="TableId"
                                                  OnItemGranted="OnCharacterUpdated" />
            }
            else if (activeTab == "Narrative")
            {
                <CharacterDetailNarrative Character="character"
                                          TableId="TableId"
                                          CharacterId="selectedCharacterId"
                                          InitialGmNotes="@currentGmNotes"
                                          OnGmNotesChanged="@((notes) => currentGmNotes = notes)" />
            }
        }
        else
        {
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-1"></i>
                Unable to load character data.
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public int CharacterId { get; set; }

    [Parameter]
    public Guid TableId { get; set; }

    [Parameter]
    public IEnumerable<TableCharacterInfo> AllCharacters { get; set; } = Enumerable.Empty<TableCharacterInfo>();

    private static readonly string[] tabNames = ["GM Actions", "Character Sheet", "Effects", "Inventory", "Grant Items", "Narrative"];
    private string activeTab = tabNames[0];
    private int selectedCharacterId;
    private bool isLoading = true;
    private CharacterEdit? character;
    private string? currentGmNotes;
    private bool subscribed;
    private bool isEditMode;

    protected override async Task OnInitializedAsync()
    {
        selectedCharacterId = CharacterId;
        await LoadCharacterAsync();
        await SubscribeToUpdatesAsync();
    }

    private async Task SubscribeToUpdatesAsync()
    {
        if (subscribed) return;

        await TimeEventSubscriber.ConnectAsync();
        await TimeEventSubscriber.SubscribeAsync();
        TimeEventSubscriber.CharacterUpdateReceived += OnCharacterUpdateReceived;
        subscribed = true;
    }

    private void OnCharacterUpdateReceived(object? sender, CharacterUpdateMessage e)
    {
        // Only refresh if the updated character is the one we're viewing
        if (e.CharacterId != selectedCharacterId) return;

        InvokeAsync(async () =>
        {
            // Refresh character data silently (no visual indicator per CONTEXT.md)
            isLoading = true;
            StateHasChanged();

            try
            {
                character = await characterPortal.FetchAsync(selectedCharacterId);
            }
            finally
            {
                isLoading = false;
                StateHasChanged();
            }
        });
    }

    private async Task OnCharacterChanged()
    {
        await LoadCharacterAsync();
    }

    private async Task LoadCharacterAsync()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            character = await characterPortal.FetchAsync(selectedCharacterId);

            // Load GM notes directly from DAL to ensure we get the latest saved value
            currentGmNotes = await tableDal.GetGmNotesAsync(TableId, selectedCharacterId);
        }
        catch
        {
            character = null;
            currentGmNotes = null;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void Close()
    {
        DialogService.Close();
    }

    private async Task OnCharacterUpdated()
    {
        // Reload the character to reflect changes
        await LoadCharacterAsync();
    }

    private void SwitchToSheetAndEdit()
    {
        activeTab = "Character Sheet";
        isEditMode = true;
        // CharacterDetailSheet's OnParametersSetAsync will detect IsEditMode=true
        // and call LoadEditingCharacter() to fetch the character for editing
        StateHasChanged();
    }

    private void OnCharacterRemoved()
    {
        // Close the modal - the character has been removed from the table
        DialogService.Close("removed");
    }

    public async ValueTask DisposeAsync()
    {
        if (subscribed)
        {
            TimeEventSubscriber.CharacterUpdateReceived -= OnCharacterUpdateReceived;
            await TimeEventSubscriber.UnsubscribeAsync();
            subscribed = false;
        }
    }
}
