@namespace Threa.Client.Components.Shared

@using GameMechanics.Time.Calendars

@inject IGameCalendarProvider CalendarProvider

<span class="game-time-display" @onclick="ToggleModal" title="Click to view all calendars" style="cursor: pointer; text-decoration: underline dotted;">
    @GetDisplayText()
</span>

@if (showModal)
{
    <CalendarModal EpochSeconds="EpochSeconds"
                   Theme="@Theme"
                   DefaultCalendarId="@DefaultCalendarId"
                   IsGm="@IsGm"
                   OnDefaultChanged="HandleDefaultChanged"
                   OnClose="CloseModal" />
}

@code {
    [Parameter, EditorRequired]
    public long EpochSeconds { get; set; }

    [Parameter, EditorRequired]
    public string Theme { get; set; } = "fantasy";

    [Parameter]
    public string? DefaultCalendarId { get; set; }

    [Parameter]
    public bool IsGm { get; set; }

    [Parameter]
    public EventCallback<string> OnDefaultCalendarChanged { get; set; }

    /// <summary>
    /// When set, clicking the time display invokes this callback instead of showing
    /// the CalendarModal inline. Use this when the component is nested inside a
    /// CSS clip-path ancestor (e.g. a scifi-theme card) where position:fixed modals
    /// would be visually clipped.
    /// </summary>
    [Parameter]
    public EventCallback OnRequestShowModal { get; set; }

    private bool showModal;

    private string GetDisplayText()
    {
        var calendar = CalendarProvider.GetCalendar(Theme, DefaultCalendarId);
        return calendar?.FormatCompact(EpochSeconds) ?? EpochSeconds.ToString();
    }

    private async Task ToggleModal()
    {
        if (OnRequestShowModal.HasDelegate)
            await OnRequestShowModal.InvokeAsync();
        else
            showModal = !showModal;
    }

    private void CloseModal()
    {
        showModal = false;
    }

    private async Task HandleDefaultChanged(string calendarId)
    {
        DefaultCalendarId = calendarId;
        await OnDefaultCalendarChanged.InvokeAsync(calendarId);
        StateHasChanged();
    }
}
