@using GameMechanics.Player
@using Radzen
@using System.Security.Claims

@inject IDataPortal<AdminUserEdit> userPortal
@inject ViewModel<AdminUserEdit> vm
@inject DialogService DialogService
@inject AuthenticationStateProvider AuthenticationStateProvider

<div class="p-3">
    @if (vm.Model == null)
    {
        <p>Loading...</p>
    }
    else
    {
        @if (isSelfEdit)
        {
            <div class="alert alert-warning mb-3">
                <i class="bi bi-exclamation-triangle me-1"></i>
                You are editing your own account.
            </div>
        }

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }
        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success">@successMessage</div>
        }

        <div class="mb-3">
            <label class="form-label">Username</label>
            <input type="text" class="form-control" value="@vm.Model.Email" disabled />
        </div>

        <div class="mb-3">
            <label class="form-label">Display Name</label>
            <input type="text" class="form-control" @bind="vm.Model.Name" />
        </div>

        <div class="mb-3">
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="isEnabled" @bind="vm.Model.IsEnabled" />
                <label class="form-check-label" for="isEnabled">Account Enabled</label>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">Roles</label>
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="isGameMaster" @bind="vm.Model.IsGameMaster" />
                <label class="form-check-label" for="isGameMaster">Game Master</label>
            </div>
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="isAdmin" @bind="vm.Model.IsAdministrator" />
                <label class="form-check-label" for="isAdmin">Administrator</label>
            </div>
            <small class="text-muted">User role is always assigned.</small>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">Reset Password</label>
            <input type="password" class="form-control" @bind="vm.Model.NewPassword" placeholder="Leave blank to keep current" />
        </div>

        <div class="d-flex gap-2 justify-content-end">
            <button type="button" class="btn btn-secondary" @onclick="Close">Close</button>
            <button type="button" class="btn btn-primary" @onclick="SaveAsync" disabled="@(!vm.Model.IsSavable || saving)">
                @if (saving)
                {
                    <span class="spinner-border spinner-border-sm me-1"></span>
                }
                Save
            </button>
        </div>
    }
</div>

@code {
    [Parameter]
    public int UserId { get; set; }

    private int currentUserId;
    private bool isSelfEdit;
    private string? errorMessage;
    private string? successMessage;
    private bool saving;

    protected override async Task OnInitializedAsync()
    {
        // Get current user ID
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            var idClaim = user.FindFirst(ClaimTypes.NameIdentifier);
            if (idClaim != null && int.TryParse(idClaim.Value, out var id))
            {
                currentUserId = id;
            }
        }

        isSelfEdit = currentUserId == UserId;

        vm.ModelChanged += async () => await InvokeAsync(StateHasChanged);
        vm.ModelPropertyChanged += async (s, a) => await InvokeAsync(StateHasChanged);
        await vm.RefreshAsync(() => userPortal.FetchAsync(UserId));
    }

    private async Task SaveAsync()
    {
        if (vm.Model == null) return;

        errorMessage = null;
        successMessage = null;

        // Check for self-disable warning
        if (currentUserId == vm.Model.Id && !vm.Model.IsEnabled)
        {
            var confirmed = await DialogService.Confirm(
                "You're about to disable your own account. You will be logged out immediately. Continue?",
                "Warning",
                new ConfirmOptions
                {
                    OkButtonText = "Disable Anyway",
                    CancelButtonText = "Cancel"
                });
            if (confirmed != true) return;
        }

        // Check for self-demote warning
        if (currentUserId == vm.Model.Id && !vm.Model.IsAdministrator)
        {
            var confirmed = await DialogService.Confirm(
                "You're about to remove your own Admin access. You won't be able to access this page after saving. Continue?",
                "Warning",
                new ConfirmOptions
                {
                    OkButtonText = "Remove Anyway",
                    CancelButtonText = "Cancel"
                });
            if (confirmed != true) return;
        }

        saving = true;
        StateHasChanged();

        try
        {
            vm.Model = await vm.Model.SaveAsync();
            successMessage = "User saved successfully.";
        }
        catch (Csla.DataPortalException ex) when (ex.BusinessException != null)
        {
            errorMessage = ex.BusinessException.Message;
        }
        catch (Csla.Rules.ValidationException)
        {
            // Display broken rules from the model
            var brokenRules = vm.Model.BrokenRulesCollection
                .Where(r => r.Severity == Csla.Rules.RuleSeverity.Error)
                .Select(r => r.Description);
            errorMessage = string.Join("; ", brokenRules);
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            saving = false;
            StateHasChanged();
        }
    }

    private void Close()
    {
        DialogService.Close(!string.IsNullOrEmpty(successMessage));
    }
}
