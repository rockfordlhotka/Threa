@page "/gamemaster/magicschools/{Id}"
@page "/gamemaster/magicschools/new"
@rendermode InteractiveServer

@attribute [Authorize(Roles = "GameMaster,Administrator")]

@using GameMechanics.Magic
@using Microsoft.AspNetCore.Authorization

@inject IDataPortal<MagicSchoolDefinitionEdit> schoolPortal
@inject ViewModel<MagicSchoolDefinitionEdit> vm
@inject Threa.Services.RenderModeProvider RenderModeProvider
@inject NavigationManager NavigationManager

<div class="info-box d-flex justify-content-between align-items-center">
    <div>
        <strong>@(IsNewSchool ? "Add New Magic School" : $"Edit: {vm.Model?.Name ?? "School"}")</strong>
        @if (vm.Model != null)
        {
            <span class="badge ms-2 @(vm.Model.IsActive ? "bg-success" : "bg-warning")">
                @(vm.Model.IsActive ? "Active" : "Inactive")
            </span>
            @if (vm.Model.IsCore)
            {
                <span class="badge-purple ms-1">Core</span>
            }
        }
    </div>
    <a href="/gamemaster/magicschools" class="btn btn-outline-secondary btn-sm">Back to Magic Schools</a>
</div>

@if (!string.IsNullOrEmpty(vm.ViewModelErrorText))
{
    <div class="alert alert-danger">@vm.ViewModelErrorText</div>
}

@if (vm.Model == null)
{
    <div class="card">
        <div class="card-body text-center py-4">
            <div class="item-meta">Loading magic school...</div>
        </div>
    </div>
}
else
{
    <div class="card">
        <div class="card-body">
            <table class="table table-sm">
                <thead>
                    <tr><th></th><th></th></tr>
                </thead>
                <tbody>
                    <tr><td colspan="2"><div class="info-box card-header-purple"><strong>Basic Information</strong></div></td></tr>
            
            @if (IsNewSchool)
            {
                <TextInputRow Property="vm.GetPropertyInfo<string>(() => vm.Model.Id)" />
            }
            else
            {
                <tr>
                    <td>Id</td>
                    <td>
                        <input type="text" value="@vm.Model.Id" class="form-control" readonly disabled />
                        @if (!vm.Model.CanBeDeleted)
                        {
                            <small class="text-warning d-block mt-1">? Core magic school - cannot be deleted</small>
                        }
                    </td>
                </tr>
            }
            
            <TextInputRow Property="vm.GetPropertyInfo<string>(() => vm.Model.Name)" />
            <TextInputRow Property="vm.GetPropertyInfo<string>(() => vm.Model.ShortDescription)" />
            <TextAreaRow Property="vm.GetPropertyInfo<string>(() => vm.Model.Description)" />

                    <tr><td colspan="2"><hr /></td></tr>
                    <tr><td colspan="2"><div class="info-box"><strong>Visual Properties</strong></div></td></tr>

            <tr>
                <td>Color Code</td>
                <td>
                    <div class="input-group">
                        <input type="color" @bind="vm.Model.ColorCode" class="form-control form-control-color" title="Choose color" />
                        <input type="text" @bind="vm.Model.ColorCode" class="form-control" placeholder="#FFFFFF" />
                    </div>
                    <small class="text-muted">Hex color code for UI theming</small>
                </td>
            </tr>

            <TextInputRow Property="vm.GetPropertyInfo<string?>(() => vm.Model.IconUrl)" />

                    <tr><td colspan="2"><hr /></td></tr>
                    <tr><td colspan="2"><div class="info-box"><strong>Configuration</strong></div></td></tr>

            <TextInputRow Property="vm.GetPropertyInfo<string>(() => vm.Model.ManaSkillId)" />
            <NumericSelectorRow Property="vm.GetPropertyInfo<int>(() => vm.Model.DisplayOrder)" />
            <TextAreaRow Property="vm.GetPropertyInfo<string?>(() => vm.Model.TypicalSpellTypes)" />

            <CheckBoxRow Property="vm.GetPropertyInfo<bool>(() => vm.Model.IsActive)" />
            
            @if (!IsNewSchool)
            {
                <tr>
                    <td>Core School</td>
                    <td>
                        <input type="checkbox" @bind="vm.Model.IsCore" disabled />
                        <small class="text-muted d-block mt-1">Core schools cannot be modified</small>
                    </td>
                </tr>
            }

                    <tr><td colspan="2"><hr /></td></tr>
                    <tr><td colspan="2">
                        <div class="alert alert-info">
                            <strong>Note:</strong> After creating a magic school, you'll need to:
                            <ul class="mb-0">
                                <li>Create a corresponding mana skill (e.g., "shadow-mana")</li>
                                <li>Create spell skills for this school</li>
                                <li>Update spell definitions to use this school</li>
                            </ul>
                        </div>
                    </td></tr>
                </tbody>
            </table>
        </div>

        <div class="card-footer">
            <button type="button" @onclick="SaveData" class="btn btn-primary" disabled="@(!vm.Model.IsSavable)">Save</button>
            <button type="button" @onclick="Cancel" class="btn btn-secondary ms-2">Cancel</button>
        </div>
    </div>
}

@code {
    [Parameter]
    public string? Id { get; set; }

    private bool IsNewSchool => Id == "new" || string.IsNullOrEmpty(Id);

    protected override async Task OnInitializedAsync()
    {
        if (!RenderModeProvider.GetRenderMode(this).ToString().Contains("Interactive"))
            return;

        vm.Saved += () => NavigationManager.NavigateTo("/gamemaster/magicschools");
        vm.ModelChanged += async () => await InvokeAsync(() => StateHasChanged());
        vm.ModelPropertyChanged += async (s, a) => await InvokeAsync(() => StateHasChanged());

        if (IsNewSchool)
        {
            await vm.RefreshAsync(() => schoolPortal.CreateAsync());
        }
        else if (!string.IsNullOrEmpty(Id) && Id != "new")
        {
            await vm.RefreshAsync(() => schoolPortal.FetchAsync(Id));
        }
    }

    private async Task SaveData()
    {
        await vm.SaveAsync();
        NavigationManager.NavigateTo("/gamemaster/magicschools");
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/gamemaster/magicschools");
    }
}
