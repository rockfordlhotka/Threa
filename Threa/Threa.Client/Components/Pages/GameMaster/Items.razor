@page "/gamemaster/items"

@using GameMechanics.Items
@using Threa.Dal.Dto
@using Microsoft.AspNetCore.Authorization

@implements IDisposable

@inject IDataPortal<ItemTemplateList> itemListPortal
@inject ViewModel<ItemTemplateList> vm
@inject NavigationManager NavigationManager

@attribute [Authorize(Roles = "GameMaster,Administrator")]

<h3>Manage Items</h3>

<div class="alert-danger">@vm.ViewModelErrorText</div>

@if (vm.Model == null)
{
    <div>Loading...</div>
    <img src="images/busy.gif" class="busy-animation" />
}
else
{
    <a href="/gamemaster/items/new" class="btn btn-primary mb-3">Add New Item</a>

    <div class="d-flex gap-3 mb-3 align-items-center">
        <RadzenTextBox @bind-Value="@searchText" Placeholder="Search items..."
            @oninput="@((e) => OnSearchInput(e.Value?.ToString() ?? ""))"
            Style="width: 300px" />
        <RadzenDropDown TValue="ItemType?" Data="@itemTypes"
            @bind-Value="@selectedType" Change="@(_ => ApplyFilters())"
            Placeholder="Filter by Type" AllowClear="true" Style="width: 200px" />
    </div>

    <RadzenDataGrid Data="@filteredItems" TItem="ItemTemplateInfo"
        AllowSorting="true" AllowPaging="true" PageSize="20"
        RowSelect="@(item => NavigationManager.NavigateTo($"/gamemaster/items/{item.Id}"))"
        Style="cursor: pointer">
        <Columns>
            <RadzenDataGridColumn TItem="ItemTemplateInfo" Property="Name" Title="Name" Sortable="true" Width="300px" />
            <RadzenDataGridColumn TItem="ItemTemplateInfo" Property="ItemType" Title="Type" Sortable="true" Width="150px" />
        </Columns>
    </RadzenDataGrid>
}

@code {
    private IEnumerable<ItemTemplateInfo>? allItems;
    private IEnumerable<ItemTemplateInfo>? filteredItems;
    private string searchText = "";
    private ItemType? selectedType;
    private System.Timers.Timer? debounceTimer;
    private const int DebounceMs = 300;
    private readonly IEnumerable<ItemType> itemTypes = Enum.GetValues<ItemType>();

    protected override async Task OnParametersSetAsync()
    {
        await vm.RefreshAsync(() => itemListPortal.FetchAsync());
        allItems = vm.Model;
        ApplyFilters();
        StateHasChanged();
    }

    private void OnSearchInput(string value)
    {
        searchText = value;
        debounceTimer?.Stop();
        debounceTimer?.Dispose();
        debounceTimer = new System.Timers.Timer(DebounceMs);
        debounceTimer.Elapsed += (s, e) =>
        {
            debounceTimer?.Stop();
            InvokeAsync(() => { ApplyFilters(); StateHasChanged(); });
        };
        debounceTimer.Start();
    }

    private void ApplyFilters()
    {
        var query = allItems?.AsEnumerable() ?? Enumerable.Empty<ItemTemplateInfo>();

        if (selectedType.HasValue)
            query = query.Where(i => i.ItemType == selectedType.Value);

        if (!string.IsNullOrWhiteSpace(searchText))
            query = query.Where(i =>
                i.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                i.Description.Contains(searchText, StringComparison.OrdinalIgnoreCase));

        filteredItems = query.ToList();
    }

    public void Dispose()
    {
        debounceTimer?.Stop();
        debounceTimer?.Dispose();
    }
}
