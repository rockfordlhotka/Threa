@page "/gamemaster/items"
@rendermode InteractiveServer

@using GameMechanics.Items
@using Threa.Dal.Dto
@using Microsoft.AspNetCore.Authorization

@implements IDisposable

@inject IDataPortal<ItemTemplateList> itemListPortal
@inject ViewModel<ItemTemplateList> vm
@inject NavigationManager NavigationManager

@attribute [Authorize(Roles = "GameMaster,Administrator")]

<div class="info-box d-flex justify-content-between align-items-center">
    <div>
        <strong>Manage Items</strong>
        @if (filteredItems != null)
        {
            <span class="item-meta ms-3">Showing @filteredItems.Count() of @(allItems?.Count() ?? 0) items</span>
        }
    </div>
    <a href="/gamemaster/items/new" class="btn btn-primary btn-sm">Add New Item</a>
</div>

@if (!string.IsNullOrEmpty(vm.ViewModelErrorText))
{
    <div class="alert alert-danger">@vm.ViewModelErrorText</div>
}

@if (vm.Model == null)
{
    <div class="card">
        <div class="card-body text-center py-4">
            <div class="item-meta mb-2">Loading items...</div>
            <img src="images/busy.gif" class="busy-animation" />
        </div>
    </div>
}
else
{
    <div class="card">
        <div class="card-header d-flex gap-3 align-items-center flex-wrap">
            <RadzenTextBox @bind-Value="@searchText" Placeholder="Search items..."
                @oninput="@((e) => OnSearchInput(e.Value?.ToString() ?? ""))"
                Style="width: 300px" />
            <RadzenDropDown TValue="ItemType?" Data="@itemTypes"
                @bind-Value="@selectedType" Change="@(_ => ApplyFilters())"
                Placeholder="Filter by Type" AllowClear="true" Style="width: 200px" />
        </div>
        <div class="card-body p-0">
            <RadzenDataGrid Data="@filteredItems" TItem="ItemTemplateInfo"
                AllowSorting="true" AllowPaging="true" PageSize="20"
                RowSelect="@(item => NavigationManager.NavigateTo($"/gamemaster/items/{item.Id}"))"
                Style="cursor: pointer">
                <Columns>
                    <RadzenDataGridColumn TItem="ItemTemplateInfo" Property="Name" Title="Name" Sortable="true" Width="300px" />
                    <RadzenDataGridColumn TItem="ItemTemplateInfo" Property="ItemType" Title="Type" Sortable="true" Width="150px" />
                    <RadzenDataGridColumn TItem="ItemTemplateInfo" Title="Status" Width="100px">
                        <Template Context="item">
                            @if (item.IsActive)
                            {
                                <span class="text-positive">Active</span>
                            }
                            else
                            {
                                <span class="text-negative">Inactive</span>
                            }
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="ItemTemplateInfo" Title="" Width="80px" Sortable="false">
                        <Template Context="item">
                            <a href="/gamemaster/items/@item.Id/delete"
                               class="btn btn-sm btn-outline-danger"
                               @onclick:stopPropagation="true"
                               title="Delete">
                                <i class="bi bi-trash"></i>
                            </a>
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        </div>
    </div>
}

@code {
    private IEnumerable<ItemTemplateInfo>? allItems;
    private IEnumerable<ItemTemplateInfo>? filteredItems;
    private string searchText = "";
    private ItemType? selectedType;
    private System.Timers.Timer? debounceTimer;
    private const int DebounceMs = 300;
    private readonly IEnumerable<ItemType> itemTypes = Enum.GetValues<ItemType>();

    protected override async Task OnParametersSetAsync()
    {
        await vm.RefreshAsync(() => itemListPortal.FetchAsync());
        allItems = vm.Model;
        ApplyFilters();
        StateHasChanged();
    }

    private void OnSearchInput(string value)
    {
        searchText = value;
        debounceTimer?.Stop();
        debounceTimer?.Dispose();
        debounceTimer = new System.Timers.Timer(DebounceMs);
        debounceTimer.Elapsed += (s, e) =>
        {
            debounceTimer?.Stop();
            InvokeAsync(() => { ApplyFilters(); StateHasChanged(); });
        };
        debounceTimer.Start();
    }

    private void ApplyFilters()
    {
        var query = allItems?.AsEnumerable() ?? Enumerable.Empty<ItemTemplateInfo>();

        if (selectedType.HasValue)
            query = query.Where(i => i.ItemType == selectedType.Value);

        if (!string.IsNullOrWhiteSpace(searchText))
            query = query.Where(i =>
                i.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                i.Description.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                (!string.IsNullOrEmpty(i.Tags) && i.Tags.Contains(searchText, StringComparison.OrdinalIgnoreCase)));

        filteredItems = query.OrderBy(i => i.Name).ToList();
    }

    public void Dispose()
    {
        debounceTimer?.Stop();
        debounceTimer?.Dispose();
    }
}
