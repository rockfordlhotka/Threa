@page "/gamemaster/skills/{Id}"
@page "/gamemaster/skills/new"
@rendermode InteractiveServer

@attribute [Authorize(Roles = "GameMaster,Administrator")]

@using GameMechanics.Skills
@using Threa.Dal.Dto
@using Microsoft.AspNetCore.Authorization

@inject IDataPortal<SkillDefinitionEdit> skillPortal
@inject ViewModel<SkillDefinitionEdit> vm
@inject Threa.Services.RenderModeProvider RenderModeProvider
@inject NavigationManager NavigationManager

<div class="info-box d-flex justify-content-between align-items-center">
    <div>
        <strong>@(IsNewSkill ? "Add New Skill" : $"Edit: {vm.Model?.Name ?? "Skill"}")</strong>
        @if (vm.Model != null)
        {
            var skillType = vm.Model.IsSpecialized ? "Specialized" : (vm.Model.IsMagic ? "Magic" : "Standard");
            var badgeClass = skillType switch
            {
                "Magic" => "badge-purple",
                "Specialized" => "badge bg-info",
                _ => "badge bg-secondary"
            };
            <span class="badge ms-2 @badgeClass">@skillType</span>
        }
    </div>
    <a href="/gamemaster/skills" class="btn btn-outline-secondary btn-sm">Back to Skills</a>
</div>

@if (!string.IsNullOrEmpty(vm.ViewModelErrorText))
{
    <div class="alert alert-danger">@vm.ViewModelErrorText</div>
}

@if (vm.Model == null)
{
    <div class="card">
        <div class="card-body text-center py-4">
            <div class="item-meta">Loading skill...</div>
        </div>
    </div>
}
else
{
    <div class="card">
        <div class="card-body">
            <table class="table table-sm">
                <thead>
                    <tr><th></th><th></th></tr>
                </thead>
                <tbody>
                    <!-- Common Properties (All Skills) -->
                    <tr><td colspan="2"><div class="info-box"><strong>Basic Information</strong></div></td></tr>
            
            @if (IsNewSkill)
            {
                <TextInputRow Property="vm.GetPropertyInfo<string>(() => vm.Model.Id)" />
            }
            else
            {
                <tr>
                    <td>Id</td>
                    <td>
                        <input type="text" value="@vm.Model.Id" class="form-control" readonly disabled />
                        @if (!vm.Model.CanBeDeleted)
                        {
                            <small class="text-warning d-block mt-1">? Core attribute skill - cannot be deleted</small>
                        }
                    </td>
                </tr>
            }
            
            <TextInputRow Property="vm.GetPropertyInfo<string>(() => vm.Model.Name)" />
            
            <TextAreaRow Property="vm.GetPropertyInfo<string?>(() => vm.Model.Description)" />
            
            <tr>
                <td>Category</td>
                <td>
                    <select @bind="vm.Model.Category" class="form-control">
                        @foreach (SkillCategory category in Enum.GetValues(typeof(SkillCategory)))
                        {
                            <option value="@category">@category</option>
                        }
                    </select>
                </td>
            </tr>

            <CheckBoxRow Property="vm.GetPropertyInfo<bool>(() => vm.Model.IsSpecialized)" />
            <CheckBoxRow Property="vm.GetPropertyInfo<bool>(() => vm.Model.IsMagic)" />
            <CheckBoxRow Property="vm.GetPropertyInfo<bool>(() => vm.Model.IsTheology)" />
            <CheckBoxRow Property="vm.GetPropertyInfo<bool>(() => vm.Model.IsPsionic)" />

                    <tr><td colspan="2"><hr /></td></tr>
                    <tr><td colspan="2"><div class="info-box"><strong>Attributes & Training Costs</strong></div></td></tr>
            <tr>
                <td colspan="2">
                    <small class="text-muted">
                        Valid attributes: STR, DEX, END, INT, ITT, WIL, PHY, SOC
                    </small>
                </td>
            </tr>

            <tr>
                <td>Primary Attribute</td>
                <td>
                    <input type="text" class="form-control" @bind="vm.Model.PrimaryAttribute" />
                    <small class="text-muted">Use "/" for multiple attributes (e.g., "DEX/ITT") - values are averaged</small>
                </td>
            </tr>
            <tr>
                <td>Secondary Attribute</td>
                <td>
                    <input type="text" class="form-control" @bind="vm.Model.SecondaryAttribute" />
                    <small class="text-muted">Character must have >= 8 in this attribute to learn/use skill</small>
                </td>
            </tr>
            <tr>
                <td>Tertiary Attribute</td>
                <td>
                    <input type="text" class="form-control" @bind="vm.Model.TertiaryAttribute" />
                    <small class="text-muted">Character must have >= 6 in this attribute to learn/use skill</small>
                </td>
            </tr>

            <NumericSelectorRow Property="vm.GetPropertyInfo<int>(() => vm.Model.Untrained)" />
            <NumericSelectorRow Property="vm.GetPropertyInfo<int>(() => vm.Model.Trained)" />

                    <tr><td colspan="2"><hr /></td></tr>
                    <tr><td colspan="2"><div class="info-box"><strong>Action Properties</strong></div></td></tr>

            <tr>
                <td>Action Type</td>
                <td>
                    <select @bind="vm.Model.ActionType" class="form-control">
                        @foreach (ActionType actionType in Enum.GetValues(typeof(ActionType)))
                        {
                            <option value="@actionType">@actionType</option>
                        }
                    </select>
                </td>
            </tr>

            <tr>
                <td>Target Value Type</td>
                <td>
                    <select @bind="vm.Model.TargetValueType" class="form-control">
                        @foreach (TargetValueType tvType in Enum.GetValues(typeof(TargetValueType)))
                        {
                            <option value="@tvType">@tvType</option>
                        }
                    </select>
                </td>
            </tr>

            <NumericSelectorRow Property="vm.GetPropertyInfo<int>(() => vm.Model.DefaultTV)" />
            <TextInputRow Property="vm.GetPropertyInfo<string?>(() => vm.Model.OpposedSkillId)" />

            <tr>
                <td>Result Table</td>
                <td>
                    <select @bind="vm.Model.ResultTable" class="form-control">
                        @foreach (ResultTableType resultTable in Enum.GetValues(typeof(ResultTableType)))
                        {
                            <option value="@resultTable">@resultTable</option>
                        }
                    </select>
                </td>
            </tr>

            <CheckBoxRow Property="vm.GetPropertyInfo<bool>(() => vm.Model.RequiresTarget)" />
            <CheckBoxRow Property="vm.GetPropertyInfo<bool>(() => vm.Model.RequiresLineOfSight)" />
            <CheckBoxRow Property="vm.GetPropertyInfo<bool>(() => vm.Model.IsFreeAction)" />
            <CheckBoxRow Property="vm.GetPropertyInfo<bool>(() => vm.Model.IsPassive)" />
            <TextAreaRow Property="vm.GetPropertyInfo<string?>(() => vm.Model.ActionDescription)" />

                    <!-- Combat-Specific Properties -->
                    @if (vm.Model.IsCombatSkill)
                    {
                        <tr><td colspan="2"><hr /></td></tr>
                        <tr><td colspan="2"><div class="info-box"><strong>Combat Properties</strong></div></td></tr>
                        <CheckBoxRow Property="vm.GetPropertyInfo<bool>(() => vm.Model.AppliesPhysicalityBonus)" />
                    }

                    <!-- Spell-Specific Properties -->
                    @if (vm.Model.IsActiveSpell)
                    {
                        <tr><td colspan="2"><hr /></td></tr>
                        <tr><td colspan="2"><div class="info-box card-header-purple"><strong>Spell Properties</strong></div></td></tr>
                
                <CheckBoxRow Property="vm.GetPropertyInfo<bool>(() => vm.Model.CanPumpWithFatigue)" />
                <CheckBoxRow Property="vm.GetPropertyInfo<bool>(() => vm.Model.CanPumpWithMana)" />
                
                @if (vm.Model.CanPumpWithFatigue || vm.Model.CanPumpWithMana)
                {
                    <TextAreaRow Property="vm.GetPropertyInfo<string?>(() => vm.Model.PumpDescription)" />
                }

                <tr>
                    <td colspan="2">
                        <em>Note: Mana requirements are managed separately through the spell definition system.</em>
                    </td>
                </tr>
            }

                    <!-- Mana Skill Properties -->
                    @if (vm.Model.IsManaSkill)
                    {
                        <tr><td colspan="2"><hr /></td></tr>
                        <tr><td colspan="2"><div class="info-box text-mana"><strong>Mana Channeling Properties</strong></div></td></tr>

                        <tr>
                            <td colspan="2">
                                <em class="item-description">Mana channeling skills focus on gathering and storing mana for spell use.</em>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="card-footer">
            <button type="button" @onclick="SaveData" class="btn btn-primary" disabled="@(!vm.Model.IsSavable)">Save</button>
            <button type="button" @onclick="Cancel" class="btn btn-secondary ms-2">Cancel</button>
        </div>
    </div>
}

@code {
    [Parameter]
    public string? Id { get; set; }

    private bool IsNewSkill => Id == "new" || string.IsNullOrEmpty(Id);

    protected override async Task OnInitializedAsync()
    {
        if (!RenderModeProvider.GetRenderMode(this).ToString().Contains("Interactive"))
            return;

        vm.Saved += () => NavigationManager.NavigateTo("/gamemaster/skills");
        vm.ModelChanged += async () => await InvokeAsync(() => StateHasChanged());
        vm.ModelPropertyChanged += async (s, a) => await InvokeAsync(() => StateHasChanged());

        if (IsNewSkill)
        {
            await vm.RefreshAsync(() => skillPortal.CreateAsync());
        }
        else if (!string.IsNullOrEmpty(Id) && Id != "new")
        {
            await vm.RefreshAsync(() => skillPortal.FetchAsync(Id));
        }
    }

    private async Task SaveData()
    {
        await vm.SaveAsync();
        NavigationManager.NavigateTo("/gamemaster/skills");
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/gamemaster/skills");
    }
}

