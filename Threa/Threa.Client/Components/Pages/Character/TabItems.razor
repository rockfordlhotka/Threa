@inject ICharacterItemDal itemDal
@inject IItemTemplateDal itemTemplateDal

@using GameMechanics.Combat
@using Threa.Dal.Dto

@implements IDisposable

@if (vm == null || vm.Model == null)
{
    <p>Loading...</p>
    return;
}

<div class="info-box">
    <strong>Character:</strong> @vm.Model.Name
    <span style="margin-left: 2rem;"><strong>Species:</strong> @vm.Model.Species</span>
</div>

@if (isLoadingItems)
{
    <p>Loading items...</p>
    return;
}

@if (errorMessage != null)
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (vm.Model.Id == 0)
{
    <div class="alert alert-info">
        <p><strong>Save your character first</strong> to manage inventory.</p>
        <p><em>After saving, you can browse and add items to your starting inventory.</em></p>
    </div>
    return;
}

@if (vm.Model.IsPlayable)
{
    <div class="alert alert-secondary">
        <p>Your character is <strong>active</strong>. Inventory changes are managed by the GM during play.</p>
    </div>
}

@{
    var currencyProvider = CurrencyProviderFactory.GetProvider(vm.Model.Setting);
}
<h4>Currency</h4>
<div style="margin-bottom: 2rem;">
    <table class="table table-sm" style="max-width: 500px;">
        <thead>
            <tr>
                <th>Denomination</th>
                <th>Amount</th>
                @if (currencyProvider.HasFixedExchangeRates)
                {
                    <th>Value (cp)</th>
                }
            </tr>
        </thead>
        <tbody>
            @foreach (var entry in vm.Model.Wallet)
            {
                var denom = currencyProvider.Denominations.FirstOrDefault(d => d.Code == entry.CurrencyCode);
                <tr>
                    <td>@(denom?.Name ?? entry.CurrencyCode) (@(denom?.Abbreviation ?? entry.CurrencyCode))</td>
                    <td>
                        <input type="number"
                               class="form-control form-control-sm"
                               style="width: 100px;"
                               min="0"
                               @bind="entry.Amount"
                               disabled="@vm.Model.IsPlayable" />
                    </td>
                    @if (currencyProvider.HasFixedExchangeRates)
                    {
                        <td>@((long)entry.Amount * (denom?.BaseUnitValue ?? 0))</td>
                    }
                </tr>
            }
            @if (currencyProvider.HasFixedExchangeRates)
            {
                <tr class="table-summary-row">
                    <td colspan="2">Total Value</td>
                    <td>@(vm.Model.TotalBaseValue ?? 0) cp</td>
                </tr>
            }
        </tbody>
    </table>
</div>

<h4>Equipped Items</h4>
@if (equippedItems == null || !equippedItems.Any())
{
    <p><em>No items equipped.</em></p>
}
else
{
    <div class="equipped-items" style="margin-bottom: 2rem;">
        @foreach (var item in equippedItems.OrderBy(i => i.EquippedSlot))
        {
            <div class="item-card">
                <div style="font-weight: bold;">
                    @GetEquippedSlotName(item.EquippedSlot): @(item.Template?.Name ?? "Unknown Item")
                    @if (item.CustomName != null)
                    {
                        <span class="custom-name"> "@item.CustomName"</span>
                    }
                </div>

                @if (item.Template != null)
                {
                    <div class="item-description">
                        @item.Template.ShortDescription
                    </div>

                    @* Show weapon combat stats *@
                    @if (item.Template.ItemType == ItemType.Weapon)
                    {
                        <div class="item-stats" style="margin-top: 0.5rem;">
                            <strong>Weapon Stats:</strong>
                            Damage Class: @item.Template.DamageClass
                            | Type: @item.Template.DamageType
                            @if (item.Template.SVModifier != 0)
                            {
                                <span>| SV Modifier: @(item.Template.SVModifier > 0 ? "+" : "")@item.Template.SVModifier</span>
                            }
                            @if (item.Template.AVModifier != 0)
                            {
                                <span>| AV Modifier: @(item.Template.AVModifier > 0 ? "+" : "")@item.Template.AVModifier</span>
                            }
                            @if (item.Template.Range.HasValue)
                            {
                                <span>| Range: @item.Template.Range ft</span>
                            }
                            @if (!string.IsNullOrEmpty(item.Template.RelatedSkill))
                            {
                                <span>| Skill: @item.Template.RelatedSkill</span>
                            }
                        </div>
                    }

                    @* Show armor combat stats *@
                    @if (item.Template.ItemType == ItemType.Armor)
                    {
                        <div class="item-stats" style="margin-top: 0.5rem;">
                            <strong>Armor Stats:</strong>
                            @if (!string.IsNullOrEmpty(item.Template.ArmorAbsorption))
                            {
                                <span>Absorption: @item.Template.ArmorAbsorption</span>
                            }
                            @if (item.Template.DodgeModifier != 0)
                            {
                                <span>| Dodge Modifier: @(item.Template.DodgeModifier > 0 ? "+" : "")@item.Template.DodgeModifier</span>
                            }
                        </div>
                    }

                    @* Show durability if applicable *@
                    @if (item.Template.HasDurability && item.CurrentDurability.HasValue)
                    {
                        var durabilityPercent = item.Template.MaxDurability > 0
                            ? (int)((double)item.CurrentDurability.Value / item.Template.MaxDurability.Value * 100)
                            : 100;
                        var durabilityClass = durabilityPercent > 75 ? "text-positive" : durabilityPercent > 25 ? "text-spell" : "text-negative";
                        <div class="item-stats @durabilityClass">
                            Durability: @item.CurrentDurability/@item.Template.MaxDurability (@durabilityPercent%)
                        </div>
                    }

                    <div class="item-meta">
                        Weight: @item.Template.Weight lbs | Value: @FormatCurrency(item.Template.Value)
                    </div>
                }
            </div>
        }
    </div>
}

@if (!vm.Model.IsPlayable)
{
    <div class="alert alert-info mb-3">
        <strong>Character Creation Mode:</strong> Click items in the browser to add them to your inventory.
    </div>

    <div class="row">
        @* Left column: Item Browser *@
        <div class="col-md-6">
            <h4>Available Items</h4>
            <div class="d-flex gap-2 mb-3 flex-wrap">
                <RadzenTextBox @bind-Value="@searchText" Placeholder="Search..."
                    @oninput="@((e) => OnSearchInput(e.Value?.ToString() ?? ""))"
                    Style="width: 180px" />
                <RadzenDropDown TValue="ItemType?" Data="@itemTypes"
                    @bind-Value="@selectedType" Change="@(_ => ApplyFilters())"
                    Placeholder="Type" AllowClear="true" Style="width: 140px" />
            </div>

            <RadzenDataGrid Data="@filteredTemplates" TItem="ItemTemplate"
                AllowSorting="true" AllowPaging="true" PageSize="10"
                RowSelect="@AddItemFromBrowser"
                Style="cursor: pointer; max-height: 400px; overflow-y: auto">
                <Columns>
                    <RadzenDataGridColumn TItem="ItemTemplate" Property="Name" Title="Name" Width="180px" />
                    <RadzenDataGridColumn TItem="ItemTemplate" Property="ItemType" Title="Type" Width="100px" />
                    <RadzenDataGridColumn TItem="ItemTemplate" Property="Weight" Title="Wt" Width="60px">
                        <Template Context="t">@t.Weight.ToString("F1")</Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="ItemTemplate" Property="MaxStackSize" Title="Stack" Width="60px">
                        <Template Context="t">
                            @if (t.IsStackable)
                            {
                                <span>@t.MaxStackSize</span>
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="ItemTemplate" Title="Info" Width="120px" Sortable="false">
                        <Template Context="t">
                            @if (t.ItemType == ItemType.AmmoContainer)
                            {
                                var ammoProps = GetAmmoContainerProperties(t);
                                if (ammoProps != null)
                                {
                                    <span class="small text-info" title="Capacity: @ammoProps.Capacity rounds of @ammoProps.AmmoType">
                                        <i class="bi bi-box2"></i> @ammoProps.Capacity
                                    </span>
                                }
                            }
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        </div>

        @* Right column: Current Inventory *@
        <div class="col-md-6">
            <h4>Starting Inventory</h4>

            @{
                var totalWeight = CalculateTotalWeight();
                var maxWeight = CalculateCarryingCapacity();
                var isOverweight = totalWeight > maxWeight;
            }
            @if (isOverweight)
            {
                <div class="alert alert-warning py-2 mb-2">
                    <strong>Over Capacity!</strong> Carrying @totalWeight.ToString("F1") / @maxWeight.ToString("F1") lbs
                    <br/><small>This is allowed during character creation, but may affect gameplay.</small>
                </div>
            }
            else
            {
                <div class="text-muted mb-2">
                    <strong>Weight:</strong> @totalWeight.ToString("F1") / @maxWeight.ToString("F1") lbs
                </div>
            }

            @if (inventoryItems == null || !inventoryItems.Any())
            {
                <p><em>No items in inventory. Click items on the left to add them.</em></p>
            }
            else
            {
                <div class="inventory-items" style="max-height: 400px; overflow-y: auto;">
                    @foreach (var item in inventoryItems.OrderBy(i => i.Template?.ItemType).ThenBy(i => i.Template?.Name))
                    {
                        <div class="item-card">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="font-weight: bold;">
                                    @(item.Template?.Name ?? "Unknown Item")
                                    @if (item.Template?.IsStackable == true)
                                    {
                                        <span style="margin-left: 0.5rem;">
                                            x<input type="number"
                                                   class="form-control form-control-sm d-inline-block"
                                                   style="width: 60px; height: 24px; padding: 0 4px; font-size: 0.85em;"
                                                   min="1"
                                                   max="@(item.Template.MaxStackSize)"
                                                   value="@item.StackSize"
                                                   @onchange="@(e => UpdateQuantity(item.Id, int.Parse(e.Value?.ToString() ?? "1")))" />
                                        </span>
                                    }
                                    else if (item.StackSize > 1)
                                    {
                                        <span class="stack-count"> @($"x{item.StackSize}")</span>
                                    }
                                </div>
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveItemAsync(item.Id)" disabled="@isRemovingItem" title="Remove">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            @if (item.Template != null)
                            {
                                <div class="item-stats">
                                    @item.Template.ShortDescription
                                </div>
                                @* Show ammo count for ammo containers *@
                                @if (GetAmmoContainerInfo(item) is var ammoInfo && ammoInfo.HasValue)
                                {
                                    <div class="item-stats text-info-accent">
                                        <i class="bi bi-box2"></i> <strong>Ammo:</strong> @ammoInfo.Value.LoadedAmmo / @ammoInfo.Value.MaxCapacity
                                        @if (!string.IsNullOrEmpty(ammoInfo.Value.AmmoType))
                                        {
                                            <span>(@ammoInfo.Value.AmmoType)</span>
                                        }
                                    </div>
                                }
                                <div class="item-meta">
                                    Weight: @((item.Template.Weight * item.StackSize).ToString("F1")) lbs @if(item.StackSize > 1){ <span>(@item.Template.Weight ea)</span> } | Value: @FormatCurrency(item.Template.Value)
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    </div>
}
else
{
    @* Read-only inventory view for active characters *@
    <h4>Inventory Items</h4>
    @if (inventoryItems == null || !inventoryItems.Any())
    {
        <p><em>No items in inventory.</em></p>
    }
    else
    {
        <div class="inventory-items">
            @foreach (var item in inventoryItems.OrderBy(i => i.Template?.ItemType).ThenBy(i => i.Template?.Name))
            {
                <div class="item-card">
                    <div style="font-weight: bold;">
                        @(item.Template?.Name ?? "Unknown Item")
                        @if (item.StackSize > 1)
                        {
                            <span class="stack-count"> @($"x{item.StackSize}")</span>
                        }
                        @if (item.CustomName != null)
                        {
                            <span class="custom-name"> "@item.CustomName"</span>
                        }
                    </div>

                    @if (item.Template != null)
                    {
                        <div class="item-description">
                            @item.Template.ShortDescription
                        </div>

                        @* Show ammo count for ammo containers *@
                        @if (GetAmmoContainerInfo(item) is var ammoInfo && ammoInfo.HasValue)
                        {
                            <div class="item-stats text-info-accent">
                                <i class="bi bi-box2"></i> <strong>Ammo:</strong> @ammoInfo.Value.LoadedAmmo / @ammoInfo.Value.MaxCapacity
                                @if (!string.IsNullOrEmpty(ammoInfo.Value.AmmoType))
                                {
                                    <span>(@ammoInfo.Value.AmmoType)</span>
                                }
                            </div>
                        }

                        @* Show items inside containers *@
                        @if (item.Template.IsContainer)
                        {
                            var containerContents = GetContainerContents(item.Id);
                            if (containerContents.Any())
                            {
                                <div class="container-contents">
                                    <div style="font-size: 0.85em; font-weight: bold; margin-bottom: 0.25rem;">Contents:</div>
                                    @foreach (var containerItem in containerContents)
                                    {
                                        <div style="font-size: 0.85em; margin-bottom: 0.25rem;">
                                            - @(containerItem.Template?.Name ?? "Unknown")
                                            @if (containerItem.StackSize > 1)
                                            {
                                                <span> x@containerItem.StackSize</span>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                        }

                        <div class="item-meta">
                            Weight: @item.Template.Weight lbs | Value: @FormatCurrency(item.Template.Value)
                        </div>
                    }
                </div>
            }
        </div>
    }
}

@code
{
    [Parameter]
    public ViewModel<GameMechanics.CharacterEdit>? vm { get; set; }

    private List<CharacterItem>? allItems;
    private List<CharacterItem>? equippedItems;
    private List<CharacterItem>? inventoryItems;
    private List<ItemTemplate>? itemTemplates;
    private bool isLoadingItems = true;
    private bool isRemovingItem = false;
    private string? errorMessage;

    // Debounce and filter fields for item browser
    private string searchText = "";
    private ItemType? selectedType;
    private System.Timers.Timer? debounceTimer;
    private const int DebounceMs = 300;
    private List<ItemTemplate>? filteredTemplates;
    private readonly IEnumerable<ItemType> itemTypes = Enum.GetValues<ItemType>();

    protected override async Task OnInitializedAsync()
    {
        await LoadItemTemplatesAsync();
        await LoadItemsAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reload items if the character changes
        if (vm?.Model?.Id > 0)
        {
            await LoadItemsAsync();
        }
    }

    private async Task LoadItemTemplatesAsync()
    {
        try
        {
            itemTemplates = await itemTemplateDal.GetAllTemplatesAsync();
            ApplyFilters();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading item templates: {ex.Message}";
        }
    }

    private async Task LoadItemsAsync()
    {
        try
        {
            if (vm?.Model?.Id > 0)
            {
                isLoadingItems = true;
                errorMessage = null;

                allItems = await itemDal.GetCharacterItemsAsync(vm.Model.Id);

                // Separate equipped items from inventory items
                // Inventory items are those not equipped and not inside a container
                equippedItems = allItems.Where(i => i.IsEquipped).ToList();
                inventoryItems = allItems.Where(i => !i.IsEquipped && !i.ContainerItemId.HasValue).ToList();

                isLoadingItems = false;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading items: {ex.Message}";
            isLoadingItems = false;
        }
    }

    private async Task AddItemFromBrowser(ItemTemplate template)
    {
        if (template == null || vm?.Model == null || vm.Model.Id == 0 || vm.Model.IsPlayable)
            return;

        try
        {
            errorMessage = null;

            var newItem = new CharacterItem
            {
                Id = Guid.NewGuid(),
                ItemTemplateId = template.Id,
                OwnerCharacterId = vm.Model!.Id,
                StackSize = 1,
                CurrentDurability = template.HasDurability ? template.MaxDurability : null,
                CreatedAt = DateTime.UtcNow
            };

            await itemDal.AddItemAsync(newItem);
            await LoadItemsAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error adding item: {ex.Message}";
        }
    }

    private void OnSearchInput(string value)
    {
        searchText = value;
        debounceTimer?.Stop();
        debounceTimer?.Dispose();
        debounceTimer = new System.Timers.Timer(DebounceMs);
        debounceTimer.Elapsed += (s, e) =>
        {
            debounceTimer?.Stop();
            InvokeAsync(() => { ApplyFilters(); StateHasChanged(); });
        };
        debounceTimer.Start();
    }

    private void ApplyFilters()
    {
        var query = itemTemplates?.AsEnumerable() ?? Enumerable.Empty<ItemTemplate>();

        if (selectedType.HasValue)
            query = query.Where(i => i.ItemType == selectedType.Value);

        if (!string.IsNullOrWhiteSpace(searchText))
            query = query.Where(i =>
                i.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                (!string.IsNullOrEmpty(i.ShortDescription) && i.ShortDescription.Contains(searchText, StringComparison.OrdinalIgnoreCase)));

        filteredTemplates = query.ToList();
    }

    private async Task RemoveItemAsync(Guid itemId)
    {
        try
        {
            isRemovingItem = true;
            errorMessage = null;
            StateHasChanged();

            await itemDal.DeleteItemAsync(itemId);
            await LoadItemsAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error removing item: {ex.Message}";
        }
        finally
        {
            isRemovingItem = false;
            StateHasChanged();
        }
    }

    private async Task UpdateQuantity(Guid itemId, int newQuantity)
    {
        var item = allItems?.FirstOrDefault(i => i.Id == itemId);
        if (item == null || vm?.Model?.IsPlayable == true)
            return;

        var maxStack = item.Template?.MaxStackSize ?? 1;

        try
        {
            errorMessage = null;

            if (newQuantity <= 0)
            {
                // Quantity 0 or less = remove item
                await itemDal.DeleteItemAsync(itemId);
            }
            else
            {
                // Clamp to valid range and update
                item.StackSize = Math.Clamp(newQuantity, 1, maxStack);
                await itemDal.UpdateItemAsync(item);
            }

            await LoadItemsAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error updating quantity: {ex.Message}";
        }
    }
    
    private List<CharacterItem> GetContainerContents(Guid containerId)
    {
        if (allItems == null)
            return new List<CharacterItem>();

        return allItems.Where(i => i.ContainerItemId == containerId).ToList();
    }

    private string GetEquippedSlotName(EquipmentSlot slot)
    {
        return slot switch
        {
            EquipmentSlot.Head => "Head",
            EquipmentSlot.Face => "Face",
            EquipmentSlot.Ears => "Ears",
            EquipmentSlot.Neck => "Neck",
            EquipmentSlot.Shoulders => "Shoulders",
            EquipmentSlot.Back => "Back",
            EquipmentSlot.Chest => "Chest",
            EquipmentSlot.ArmLeft => "Left Arm",
            EquipmentSlot.ArmRight => "Right Arm",
            EquipmentSlot.WristLeft => "Left Wrist",
            EquipmentSlot.WristRight => "Right Wrist",
            EquipmentSlot.HandLeft => "Left Hand",
            EquipmentSlot.HandRight => "Right Hand",
            EquipmentSlot.Waist => "Waist",
            EquipmentSlot.Legs => "Legs",
            EquipmentSlot.AnkleLeft => "Left Ankle",
            EquipmentSlot.AnkleRight => "Right Ankle",
            EquipmentSlot.FootLeft => "Left Foot",
            EquipmentSlot.FootRight => "Right Foot",
            EquipmentSlot.MainHand => "Main Hand",
            EquipmentSlot.OffHand => "Off Hand",
            EquipmentSlot.TwoHand => "Two Hands",
            EquipmentSlot.FingerLeft1 => "Left Ring Finger",
            EquipmentSlot.FingerLeft2 => "Left Middle Finger",
            EquipmentSlot.FingerLeft3 => "Left Index Finger",
            EquipmentSlot.FingerLeft4 => "Left Thumb",
            EquipmentSlot.FingerLeft5 => "Left Pinky",
            EquipmentSlot.FingerRight1 => "Right Ring Finger",
            EquipmentSlot.FingerRight2 => "Right Middle Finger",
            EquipmentSlot.FingerRight3 => "Right Index Finger",
            EquipmentSlot.FingerRight4 => "Right Thumb",
            EquipmentSlot.FingerRight5 => "Right Pinky",
            _ => slot.ToString()
        };
    }

    public void Dispose()
    {
        debounceTimer?.Stop();
        debounceTimer?.Dispose();
    }
    
    /// <summary>
    /// Calculate carrying capacity based on STR using exponential formula.
    /// Formula: 50 lbs * (1.15 ^ (STR - 10))
    /// </summary>
    private decimal CalculateCarryingCapacity()
    {
        // Default to STR 10 if character or attribute not available
        var str = vm?.Model?.GetAttribute("STR") ?? 10;
        return 50m * (decimal)Math.Pow(1.15, str - 10);
    }

    /// <summary>
    /// Calculate total weight of all inventory items (including equipped and container contents).
    /// </summary>
    private decimal CalculateTotalWeight()
    {
        if (allItems == null) return 0;
        return allItems.Sum(i => (decimal)(i.Template?.Weight ?? 0) * i.StackSize);
    }

    private string FormatCurrency(int copperValue)
    {
        return GameMechanics.MoneyChanger.FormatCopper(copperValue);
    }

    private static AmmoContainerProperties? GetAmmoContainerProperties(ItemTemplate template)
    {
        if (template.ItemType != ItemType.AmmoContainer || string.IsNullOrWhiteSpace(template.CustomProperties))
            return null;

        return AmmoContainerProperties.FromJson(template.CustomProperties);
    }

    /// <summary>
    /// Gets ammo container display info (loaded/capacity) for an item.
    /// Returns null if item is not an ammo container or has no capacity.
    /// </summary>
    private (int LoadedAmmo, int MaxCapacity, string? AmmoType)? GetAmmoContainerInfo(CharacterItem item)
    {
        if (item.Template?.ItemType != ItemType.AmmoContainer)
            return null;

        var containerState = AmmoContainerState.FromJson(item.CustomProperties);
        var containerProps = GetAmmoContainerProperties(item.Template);

        int maxCapacity = containerState?.MaxCapacity ?? 0;
        if (maxCapacity == 0 && containerProps != null)
        {
            maxCapacity = containerProps.Capacity;
        }

        if (maxCapacity == 0)
            return null;

        return (
            containerState?.LoadedAmmo ?? 0,
            maxCapacity,
            containerState?.AmmoType ?? containerProps?.AmmoType
        );
    }
}
