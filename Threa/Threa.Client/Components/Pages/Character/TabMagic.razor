@inject IDataPortal<GameMechanics.Reference.SkillList> skillListPortal
@inject IChildDataPortal<GameMechanics.SkillEdit> skillPortal

@if (vm == null || vm.Model == null)
{
    <p>Loading...</p>
    return;
}

@if (initError != null)
{
    <div class="alert alert-danger">
        <strong>Initialization Error:</strong> @initError
    </div>
    return;
}

<div style="margin-bottom: 1rem; padding: 0.5rem; background-color: #f0f0f0; border-radius: 4px;">
    <strong>Character:</strong> @vm.Model.Name
    <span style="margin-left: 2rem;"><strong>Species:</strong> @vm.Model.Species</span>
    <span style="margin-left: 2rem;"><strong>Total XP:</strong> @vm.Model.XPTotal</span>
    <span style="margin-left: 2rem;"><strong>Banked XP:</strong> <span style="font-weight: bold; color: @(vm.Model.XPBanked > 0 ? "green" : "red")">@vm.Model.XPBanked</span></span>
    <span style="margin-left: 2rem;"><strong>XP Spent on Skills:</strong> <span style="font-weight: bold; color: #0066cc;">@GetTotalXPSpentOnSkills()</span></span>
</div>

@if (!vm.Model.IsPlayable)
{
    <div class="alert alert-info">
        <p>During character creation, you can spend @vm.Model.XPBanked XP to advance your magic skills.</p>
        <p>You can also <strong>decrease</strong> skill levels to return XP to your bank if you change your mind.</p>
        <p><em>Once the character is activated, you can only advance skills with earned XP (no decreasing).</em></p>
    </div>
}
else
{
    <div class="alert alert-secondary">
        <p>Your character is <strong>active</strong>. Spend XP from your bank to improve your magic skills.</p>
        <p>You have <strong>@vm.Model.XPBanked XP</strong> available to spend.</p>
        <p>Total XP spent on skills: <strong>@GetTotalXPSpentOnSkills()</strong></p>
    </div>
}

<div class="alert alert-info" style="margin-bottom: 1.5rem;">
    <h5>About Magic Skills</h5>
    <p>Magic requires three types of skills:</p>
    <ul>
        <li><strong>Mana Skills:</strong> Gather and store magical energy (e.g., Fire Mana, Water Mana). Your max mana pool equals your skill level.</li>
        <li><strong>Spell Skills:</strong> Cast specific spells using mana from the corresponding school (e.g., Fire Bolt requires Fire Mana).</li>
        <li><strong>Meta-Magic Skills:</strong> Enhance or modify spell casting (if available).</li>
    </ul>
    <p><em>Note: Characters can subconsciously use magic. "Normal people" sometimes tap into these skills without formal training.</em></p>
</div>

<h4>Current Magic Skills</h4>
@if (errorMessage != null)
{
    <div class="alert alert-danger">@errorMessage</div>
}

@* Group magic skills by category *@
@{
    // Filter magic skills once for better performance
    var magicSkills = vm.Model.Skills.Where(s => IsSkillMagic(s)).ToList();
    
    var manaSkills = magicSkills.Where(s => IsManaSkill(s)).OrderBy(s => s.Name).ToList();
    var spellSkills = magicSkills.Where(s => !IsManaSkill(s) && !IsMetaMagicSkill(s)).OrderBy(s => s.Name).ToList();
    var metaMagicSkills = magicSkills.Where(s => IsMetaMagicSkill(s)).OrderBy(s => s.Name).ToList();
}

@if (manaSkills.Any())
{
    <h5 style="margin-top: 1.5rem; color: #0066cc;">Mana Skills</h5>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Skill Name</th>
                <th>Primary Attribute</th>
                <th>Level</th>
                <th>Bonus</th>
                <th>Ability Score</th>
                <th>Max Mana</th>
                @if (!vm.Model.IsPlayable)
                {
                    <th>XP Spent</th>
                }
                <th>XP Cost to Next Level</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var skill in manaSkills)
            {
                var xpCostToNextLevel = skill.Level < 10 ? GetXPCostToNextLevel(skill) : 0;
                var isNewSkill = IsNewSkill(skill);
                <tr>
                    <td>@skill.Name</td>
                    <td>@skill.PrimaryAttribute</td>
                    <td>@skill.Level</td>
                    <td>@skill.Bonus</td>
                    <td>@skill.AbilityScore</td>
                    <td><strong>@skill.Level</strong></td>
                    @if (!vm.Model.IsPlayable)
                    {
                        <td>
                            <span style="font-weight: bold; color: #0066cc;">@skill.XPSpent</span>
                        </td>
                    }
                    <td>
                        @if (skill.Level < 10)
                        {
                            @xpCostToNextLevel
                        }
                        else
                        {
                            <span style="color: gray;">MAX</span>
                        }
                    </td>
                    <td>
                        @if (skill.Level < 10 && vm.Model.XPBanked >= xpCostToNextLevel)
                        {
                            <button class="btn btn-sm btn-success" @onclick="() => IncreaseSkillLevel(skill)">
                                Level Up (@xpCostToNextLevel XP)
                            </button>
                        }
                        @if (!vm.Model.IsPlayable && isNewSkill && skill.Level > 0)
                        {
                            <button class="btn btn-sm btn-warning" @onclick="() => DecreaseSkillLevel(skill)">
                                Decrease
                            </button>
                        }
                        @if (!vm.Model.IsPlayable && isNewSkill && skill.Level == 0)
                        {
                            <button class="btn btn-sm btn-danger" @onclick="() => RemoveSkill(skill)">
                                Remove
                            </button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (spellSkills.Any())
{
    <h5 style="margin-top: 1.5rem; color: #cc6600;">Spell Skills</h5>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Skill Name</th>
                <th>Primary Attribute</th>
                <th>Level</th>
                <th>Bonus</th>
                <th>Ability Score</th>
                @if (!vm.Model.IsPlayable)
                {
                    <th>XP Spent</th>
                }
                <th>XP Cost to Next Level</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var skill in spellSkills)
            {
                var xpCostToNextLevel = skill.Level < 10 ? GetXPCostToNextLevel(skill) : 0;
                var isNewSkill = IsNewSkill(skill);
                <tr>
                    <td>@skill.Name</td>
                    <td>@skill.PrimaryAttribute</td>
                    <td>@skill.Level</td>
                    <td>@skill.Bonus</td>
                    <td>@skill.AbilityScore</td>
                    @if (!vm.Model.IsPlayable)
                    {
                        <td>
                            <span style="font-weight: bold; color: #0066cc;">@skill.XPSpent</span>
                        </td>
                    }
                    <td>
                        @if (skill.Level < 10)
                        {
                            @xpCostToNextLevel
                        }
                        else
                        {
                            <span style="color: gray;">MAX</span>
                        }
                    </td>
                    <td>
                        @if (skill.Level < 10 && vm.Model.XPBanked >= xpCostToNextLevel)
                        {
                            <button class="btn btn-sm btn-success" @onclick="() => IncreaseSkillLevel(skill)">
                                Level Up (@xpCostToNextLevel XP)
                            </button>
                        }
                        @if (!vm.Model.IsPlayable && isNewSkill && skill.Level > 0)
                        {
                            <button class="btn btn-sm btn-warning" @onclick="() => DecreaseSkillLevel(skill)">
                                Decrease
                            </button>
                        }
                        @if (!vm.Model.IsPlayable && isNewSkill && skill.Level == 0)
                        {
                            <button class="btn btn-sm btn-danger" @onclick="() => RemoveSkill(skill)">
                                Remove
                            </button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (metaMagicSkills.Any())
{
    <h5 style="margin-top: 1.5rem; color: #9900cc;">Meta-Magic Skills</h5>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Skill Name</th>
                <th>Primary Attribute</th>
                <th>Level</th>
                <th>Bonus</th>
                <th>Ability Score</th>
                @if (!vm.Model.IsPlayable)
                {
                    <th>XP Spent</th>
                }
                <th>XP Cost to Next Level</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var skill in metaMagicSkills)
            {
                var xpCostToNextLevel = skill.Level < 10 ? GetXPCostToNextLevel(skill) : 0;
                var isNewSkill = IsNewSkill(skill);
                <tr>
                    <td>@skill.Name</td>
                    <td>@skill.PrimaryAttribute</td>
                    <td>@skill.Level</td>
                    <td>@skill.Bonus</td>
                    <td>@skill.AbilityScore</td>
                    @if (!vm.Model.IsPlayable)
                    {
                        <td>
                            <span style="font-weight: bold; color: #0066cc;">@skill.XPSpent</span>
                        </td>
                    }
                    <td>
                        @if (skill.Level < 10)
                        {
                            @xpCostToNextLevel
                        }
                        else
                        {
                            <span style="color: gray;">MAX</span>
                        }
                    </td>
                    <td>
                        @if (skill.Level < 10 && vm.Model.XPBanked >= xpCostToNextLevel)
                        {
                            <button class="btn btn-sm btn-success" @onclick="() => IncreaseSkillLevel(skill)">
                                Level Up (@xpCostToNextLevel XP)
                            </button>
                        }
                        @if (!vm.Model.IsPlayable && isNewSkill && skill.Level > 0)
                        {
                            <button class="btn btn-sm btn-warning" @onclick="() => DecreaseSkillLevel(skill)">
                                Decrease
                            </button>
                        }
                        @if (!vm.Model.IsPlayable && isNewSkill && skill.Level == 0)
                        {
                            <button class="btn btn-sm btn-danger" @onclick="() => RemoveSkill(skill)">
                                Remove
                            </button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (!manaSkills.Any() && !spellSkills.Any() && !metaMagicSkills.Any())
{
    <p style="color: gray; font-style: italic;">No magic skills yet. Add magic skills below to get started.</p>
}

<h4 style="margin-top: 2rem;">Add New Magic Skill</h4>
@if (availableMagicSkills != null && availableMagicSkills.Any())
{
    <div style="margin-bottom: 1rem;">
        <select class="form-select" @bind="selectedSkillId" style="width: 400px; display: inline-block;">
            <option value="">-- Select a magic skill to add --</option>
            @foreach (var availableSkill in availableMagicSkills)
            {
                <option value="@availableSkill.Name">@availableSkill.Name @(availableSkill.Category != Threa.Dal.Dto.SkillCategory.Other ? $"({availableSkill.Category})" : "")</option>
            }
        </select>
        <button class="btn btn-primary" @onclick="AddNewSkillAsync" disabled="@(string.IsNullOrEmpty(selectedSkillId))">
            Add Magic Skill
        </button>
    </div>
}
else
{
    <p>Loading available magic skills...</p>
}

@code {
    [Parameter]
    public ViewModel<GameMechanics.CharacterEdit>? vm { get; set; }

    private GameMechanics.Reference.SkillList? allSkills;
    private IEnumerable<GameMechanics.Reference.SkillInfo>? availableMagicSkills;
    private string? selectedSkillId;
    private string? errorMessage;
    private string? initError;
    private Dictionary<string, int> originalSkillLevels = new Dictionary<string, int>();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (vm?.Model != null)
            {
                // Load all skills
                allSkills = await skillListPortal.FetchAsync();
                
                // Track original skill levels to know which are "new"
                foreach (var skill in vm.Model.Skills)
                {
                    if (!originalSkillLevels.ContainsKey(skill.Name))
                    {
                        originalSkillLevels[skill.Name] = skill.Level;
                    }
                }
                
                UpdateAvailableMagicSkills();
            }
        }
        catch (Exception ex)
        {
            initError = ex.ToString();
        }
    }

    private int GetTotalXPSpentOnSkills()
    {
        if (vm?.Model?.Skills == null) return 0;
        return vm.Model.Skills.Sum(s => s.XPSpent);
    }

    private void UpdateAvailableMagicSkills()
    {
        if (allSkills == null) return;
        
        // Filter to show only magic skills that are not already in the character's skill list
        var existingSkillNames = vm!.Model!.Skills.Select(s => s.Name).ToHashSet();
        availableMagicSkills = allSkills.Where(s => !existingSkillNames.Contains(s.Name) && !s.IsStandard && s.IsMagic);
    }

    private bool IsSkillMagic(GameMechanics.SkillEdit skill)
    {
        // Check if this skill is a magic skill by looking it up in allSkills
        var skillInfo = allSkills?.FirstOrDefault(s => s.Name == skill.Name);
        return skillInfo?.IsMagic ?? false;
    }

    private bool IsManaSkill(GameMechanics.SkillEdit skill)
    {
        // Check category first for more reliable detection
        var skillInfo = allSkills?.FirstOrDefault(s => s.Name == skill.Name);
        if (skillInfo?.Category == Threa.Dal.Dto.SkillCategory.Mana)
            return true;

        // Fallback to name-based detection for backward compatibility
        return skill.Name.Contains("Mana", StringComparison.OrdinalIgnoreCase);
    }

    private bool IsMetaMagicSkill(GameMechanics.SkillEdit skill)
    {
        // Meta-magic skills would have a specific naming pattern (not currently implemented as a category)
        return skill.Name.Contains("Meta", StringComparison.OrdinalIgnoreCase);
    }

    private int GetXPCostToNextLevel(GameMechanics.SkillEdit skill)
    {
        // Find the skill info to get the difficulty (Trained value)
        var skillInfo = allSkills?.FirstOrDefault(s => s.Name == skill.Name);
        if (skillInfo == null)
        {
            // Default to difficulty 5 if not found
            return GameMechanics.SkillCost.GetLevelUpCost(skill.Level, 5);
        }
        
        // Use Trained as the difficulty level
        var difficulty = skillInfo.Trained;
        return GameMechanics.SkillCost.GetLevelUpCost(skill.Level, difficulty);
    }

    private bool IsNewSkill(GameMechanics.SkillEdit skill)
    {
        // A skill is "new" if it wasn't in the original list or its level has increased
        if (!originalSkillLevels.ContainsKey(skill.Name))
        {
            return true;
        }
        return skill.Level > originalSkillLevels[skill.Name];
    }

    private void IncreaseSkillLevel(GameMechanics.SkillEdit skill)
    {
        errorMessage = null;
        
        if (skill.Level >= 10)
        {
            errorMessage = "Skill is already at maximum level.";
            return;
        }

        var xpCost = GetXPCostToNextLevel(skill);
        
        if (vm!.Model!.XPBanked < xpCost)
        {
            errorMessage = $"Not enough XP. Need {xpCost} XP but only have {vm.Model.XPBanked} XP.";
            return;
        }

        // Spend XP and increase level
        vm.Model.SpendXP(xpCost);
        skill.Level++;
        skill.XPSpent += xpCost;
        
        StateHasChanged();
    }

    private void DecreaseSkillLevel(GameMechanics.SkillEdit skill)
    {
        errorMessage = null;
        
        // Check if this is a new level increase
        var originalLevel = originalSkillLevels.ContainsKey(skill.Name) ? originalSkillLevels[skill.Name] : 0;
        
        if (skill.Level <= originalLevel)
        {
            errorMessage = "Cannot reduce skill level below its original value.";
            return;
        }

        // Refund XP and decrease level
        skill.Level--;
        var xpRefund = GetXPCostToNextLevel(skill);
        vm!.Model!.RefundXP(xpRefund);
        skill.XPSpent -= xpRefund;
        
        StateHasChanged();
    }

    private async Task AddNewSkillAsync()
    {
        errorMessage = null;
        
        if (string.IsNullOrEmpty(selectedSkillId))
        {
            errorMessage = "Please select a magic skill to add.";
            return;
        }

        try
        {
            // selectedSkillId is actually the skill name
            // Find the skill by name
            var skillInfo = allSkills?.FirstOrDefault(s => s.Name == selectedSkillId);
            if (skillInfo == null)
            {
                errorMessage = "Selected skill not found.";
                return;
            }

            // Add the skill using the SkillEditList method
            // Use the Id if available, otherwise use the Name
            string skillIdentifier = !string.IsNullOrEmpty(skillInfo.Id) ? skillInfo.Id : skillInfo.Name;
            await vm!.Model!.Skills.AddSkillAsync(skillIdentifier, skillListPortal, skillPortal);
            
            UpdateAvailableMagicSkills();
            selectedSkillId = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error adding skill: {ex.Message}";
        }
    }

    private void RemoveSkill(GameMechanics.SkillEdit skill)
    {
        errorMessage = null;
        
        // Check if this is a new skill (not in original list)
        var originalLevel = originalSkillLevels.ContainsKey(skill.Name) ? originalSkillLevels[skill.Name] : -1;
        
        if (originalLevel >= 0)
        {
            errorMessage = "Cannot remove existing skills. You can only remove newly added skills.";
            return;
        }

        // Refund all XP spent on this skill
        for (int i = 0; i < skill.Level; i++)
        {
            var tempSkillInfo = allSkills?.FirstOrDefault(s => s.Name == skill.Name);
            var difficulty = tempSkillInfo?.Trained ?? 5;
            vm!.Model!.RefundXP(GameMechanics.SkillCost.GetLevelUpCost(i, difficulty));
        }

        // Remove the skill
        vm!.Model!.Skills.Remove(skill);
        
        UpdateAvailableMagicSkills();
        selectedSkillId = null;
        StateHasChanged();
    }
}
