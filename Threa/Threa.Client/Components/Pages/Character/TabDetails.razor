@using GameMechanics
@using GameMechanics.Reference
@inject IDataPortal<SpeciesList> speciesListPortal

@if (vm == null || vm.Model == null)
{
    <p>Loading...</p>
    return;
}

<div class="info-box">
    <strong>Character:</strong> @vm.Model.Name
    <span style="margin-left: 2rem;"><strong>Species:</strong> @GetSpeciesName(vm.Model.Species)</span>
</div>

<table>
    <thead>
        <tr><th></th><th></th></tr>
    </thead>
    <tbody>
        <TextInputRow Property="vm.GetPropertyInfo<string>(() => vm.Model.Name)" />
        <TextInputRow Property="vm.GetPropertyInfo<string>(() => vm.Model.TrueName)" />
        <LabelRow Property="vm.GetPropertyInfo<int>(() => vm.Model.PlayerId)" />
        <TextInputRow Property="vm.GetPropertyInfo<string>(() => vm.Model.Aliases)" />
        
        <tr>
            <td>Species</td>
            <td>
                @if (speciesList != null)
                {
                    <select @bind="vm.Model.Species" @bind:after="OnSpeciesChanged" class="form-control">
                        @foreach (var species in speciesList)
                        {
                            <option value="@species.Id">@species.Name</option>
                        }
                    </select>
                    <small class="text-muted d-block mt-1">
                        @{
                            var selectedSpecies = speciesList.FirstOrDefault(s => s.Id == vm.Model.Species);
                            if (selectedSpecies != null && selectedSpecies.AttributeModifiers.Any())
                            {
                                <text>Modifiers: @string.Join(", ", selectedSpecies.AttributeModifiers.Select(m => $"{m.AttributeName} {(m.Modifier >= 0 ? "+" : "")}{m.Modifier}"))</text>
                            }
                            else
                            {
                                <text>No attribute modifiers (baseline species)</text>
                            }
                        }
                    </small>
                }
                else
                {
                    <input type="text" value="@vm.Model.Species" class="form-control" disabled />
                    <small class="text-muted">Loading species...</small>
                }
            </td>
        </tr>
        
        <tr>
            <td>Setting</td>
            <td>
                <span class="badge @(vm.Model.Setting == GameSettings.SciFi ? "bg-info" : "bg-primary")">
                    @GameSettings.DisplayName(vm.Model.Setting)
                </span>
            </td>
        </tr>
        <TextInputRow Property="vm.GetPropertyInfo<string>(() => vm.Model.SkinDescription)" />
        <TextInputRow Property="vm.GetPropertyInfo<string>(() => vm.Model.HairDescription)" />
        <TextInputRow Property="vm.GetPropertyInfo<string>(() => vm.Model.Height)" />
        <TextInputRow Property="vm.GetPropertyInfo<string>(() => vm.Model.Weight)" />
        <TextInputRow Property="vm.GetPropertyInfo<long?>(() => vm.Model.Birthdate)" />
        <TextInputRow Property="vm.GetPropertyInfo<int>(() => vm.Model.DamageClass)" />
        <TextInputRow Property="vm.GetPropertyInfo<string>(() => vm.Model.ImageUrl)" />
        <LabelRow Property="vm.GetPropertyInfo<int>(() => vm.Model.XPTotal)" />
        <TextInputRow Property="vm.GetPropertyInfo<int>(() => vm.Model.XPBanked)" />
        <TextAreaRow Property="vm.GetPropertyInfo<string>(() => vm.Model.Description)" />
        <TextAreaRow Property="vm.GetPropertyInfo<string>(() => vm.Model.Notes)" />
    </tbody>
</table>

@code 
{
    [Parameter]
    public ViewModel<GameMechanics.CharacterEdit>? vm { get; set; }

    private List<SpeciesInfo>? speciesList;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var list = await speciesListPortal.FetchAsync();
            speciesList = list.ToList();
        }
        catch
        {
            // Handle error - species list couldn't be loaded
            speciesList = null;
        }
    }

    private string GetSpeciesName(string speciesId)
    {
        var species = speciesList?.FirstOrDefault(s => s.Id == speciesId);
        return species?.Name ?? speciesId;
    }

    private void OnSpeciesChanged()
    {
        if (vm?.Model == null || speciesList == null) return;
        
        // Find the new species info
        var newSpeciesInfo = speciesList.FirstOrDefault(s => s.Id == vm.Model.Species);
        
        // Update attribute modifiers based on new species
        vm.Model.UpdateSpeciesModifiers(newSpeciesInfo);
    }
}
