@using Threa.Client.Components.Shared
@using Radzen

@inject IDataPortal<GameMechanics.Reference.SkillList> skillListPortal
@inject IChildDataPortal<GameMechanics.SkillEdit> skillPortal
@inject DialogService DialogService

@if (vm == null || vm.Model == null)
{
    <p>Loading...</p>
    return;
}

@if (initError != null)
{
    <div class="alert alert-danger">
        <strong>Initialization Error:</strong> @initError
    </div>
    return;
}

@if (IsNpcTemplate)
{
    <div class="info-box">
        <strong>NPC Template:</strong> @vm.Model.Name
        <span style="margin-left: 2rem;"><strong>Species:</strong> @vm.Model.Species</span>
        <span style="margin-left: 2rem;"><strong>Total Max XP:</strong> <span class="text-info-accent" style="font-weight: bold;">@GetTotalNpcXP()</span></span>
    </div>
    <div class="alert alert-info">
        <p>Set skill levels directly for this NPC template. Max XP is calculated using trained skill costs.</p>
        <p><em>Core standard skills (attributes) cannot be removed. Other skills can be added and removed freely.</em></p>
    </div>
}
else
{
    <div class="info-box">
        <strong>Character:</strong> @vm.Model.Name
        <span style="margin-left: 2rem;"><strong>Species:</strong> @vm.Model.Species</span>
        <span style="margin-left: 2rem;"><strong>Total XP:</strong> @vm.Model.XPTotal</span>
        <span style="margin-left: 2rem;"><strong>Banked XP:</strong> <span class="@(vm.Model.XPBanked > 0 ? "text-positive" : "text-negative")" style="font-weight: bold;">@vm.Model.XPBanked</span></span>
        <span style="margin-left: 2rem;"><strong>XP Spent on Skills:</strong> <span class="text-info-accent" style="font-weight: bold;">@GetTotalXPSpentOnSkills()</span></span>
    </div>

    @if (!vm.Model.IsPlayable)
    {
        <div class="alert alert-info">
            <p>During character creation, you can spend @vm.Model.XPBanked XP to advance your skills.</p>
            <p>You can also <strong>decrease</strong> skill levels or <strong>remove</strong> added skills to return XP to your bank if you change your mind.</p>
            <p><em>Core attribute skills cannot be removed. Once the character is activated, you can only advance skills with earned XP (no decreasing or removing).</em></p>
        </div>
    }
    else
    {
        <div class="alert alert-secondary">
            <p>Your character is <strong>active</strong>. Spend XP from your bank to improve your skills.</p>
            <p>You have <strong>@vm.Model.XPBanked XP</strong> available to spend.</p>
            <p>Total XP spent on skills: <strong>@GetTotalXPSpentOnSkills()</strong></p>
        </div>
    }
}

<h4>Current Skills</h4>
@if (errorMessage != null)
{
    <div class="alert alert-danger">@errorMessage</div>
}

<table class="table table-striped">
    <thead>
        <tr>
            <th>Skill Name</th>
            <th>Primary Attribute</th>
            <th>Level</th>
            <th>Bonus</th>
            <th>Ability Score</th>
            @if (IsNpcTemplate)
            {
                <th>Max XP</th>
            }
            else
            {
                @if (!vm.Model.IsPlayable)
                {
                    <th>XP Spent</th>
                }
                <th>XP Cost to Next Level</th>
            }
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var skill in vm.Model.Skills.Where(s => !IsSkillMagic(s)).OrderBy(s => s.Name))
        {
            var xpCostToNextLevel = skill.Level < 10 ? GetXPCostToNextLevel(skill) : 0;
            var isNewSkill = IsNewSkill(skill);
            var skillDescription = GetSkillDescription(skill);
            <tr>
                <td title="@skillDescription">@skill.Name</td>
                <td>@skill.PrimaryAttribute</td>
                @if (IsNpcTemplate)
                {
                    <td>
                        <input type="number"
                               class="form-control form-control-sm"
                               style="width: 80px;"
                               min="0"
                               max="10"
                               value="@skill.Level"
                               @onchange="@(e => SetNpcSkillLevel(skill, int.Parse(e.Value?.ToString() ?? "0")))" />
                    </td>
                }
                else
                {
                    <td>@skill.Level</td>
                }
                <td>@skill.Bonus</td>
                <td>@skill.AbilityScore</td>
                @if (IsNpcTemplate)
                {
                    <td>
                        <span class="text-info-accent" style="font-weight: bold;">@GetCumulativeXPCost(skill)</span>
                    </td>
                }
                else
                {
                    @if (!vm.Model.IsPlayable)
                    {
                        <td>
                            <span class="text-info-accent" style="font-weight: bold;">@skill.XPSpent</span>
                        </td>
                    }
                    <td>
                        @if (skill.Level < 10)
                        {
                            @xpCostToNextLevel
                        }
                        else
                        {
                            <span class="text-neutral">MAX</span>
                        }
                    </td>
                }
                <td>
                    @if (IsNpcTemplate)
                    {
                        @if (CanRemoveNpcSkill(skill))
                        {
                            <button class="btn btn-sm btn-danger" @onclick="() => RemoveNpcSkill(skill)">
                                Remove
                            </button>
                        }
                    }
                    else
                    {
                        @if (skill.Level < 10 && vm.Model.XPBanked >= xpCostToNextLevel)
                        {
                            <button class="btn btn-sm btn-success" @onclick="() => IncreaseSkillLevel(skill)">
                                Level Up (@xpCostToNextLevel XP)
                            </button>
                        }
                        @if (!vm.Model.IsPlayable && isNewSkill && skill.Level > 0)
                        {
                            <button class="btn btn-sm btn-warning" @onclick="() => DecreaseSkillLevel(skill)">
                                Decrease
                            </button>
                        }
                        @if (!vm.Model.IsPlayable && CanRemoveSkill(skill))
                        {
                            <button class="btn btn-sm btn-danger" @onclick="() => RemoveSkill(skill)">
                                @if (skill.XPSpent > 0)
                                {
                                    <text>Remove (+@skill.XPSpent XP)</text>
                                }
                                else
                                {
                                    <text>Remove</text>
                                }
                            </button>
                        }
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

<h4>Add New Skill</h4>
<div style="margin-bottom: 1rem;">
    <button class="btn btn-primary" @onclick="OpenSkillPickerAsync" disabled="@(allSkills == null)">
        <i class="bi bi-plus-circle me-1"></i> Add Skills...
    </button>
</div>

@code {
    [Parameter]
    public ViewModel<GameMechanics.CharacterEdit>? vm { get; set; }

    private GameMechanics.Reference.SkillList? allSkills;
    private string? errorMessage;
    private string? initError;

    private bool IsNpcTemplate => vm?.Model?.IsNpc == true && vm?.Model?.IsTemplate == true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (vm?.Model != null)
            {
                // Load all skills
                allSkills = await skillListPortal.FetchAsync();
            }
        }
        catch (Exception ex)
        {
            initError = ex.ToString();
        }
    }

    private int GetTotalXPSpentOnSkills()
    {
        if (vm?.Model?.Skills == null) return 0;
        return vm.Model.Skills.Sum(s => s.XPSpent);
    }

    private int GetTotalNpcXP()
    {
        if (vm?.Model?.Skills == null) return 0;
        return vm.Model.Skills.Sum(s => GetCumulativeXPCost(s));
    }

    private bool IsSkillMagic(GameMechanics.SkillEdit skill)
    {
        // Check if this skill is a magic skill by looking it up in allSkills
        var skillInfo = allSkills?.FirstOrDefault(s => s.Name == skill.Name);
        return skillInfo?.IsMagic ?? false;
    }

    private string? GetSkillDescription(GameMechanics.SkillEdit skill)
    {
        // Look up the skill description from allSkills
        var skillInfo = allSkills?.FirstOrDefault(s => s.Name == skill.Name);
        return skillInfo?.Description;
    }

    private int GetXPCostToNextLevel(GameMechanics.SkillEdit skill)
    {
        // Find the skill info to get the difficulty (Trained value)
        var skillInfo = allSkills?.FirstOrDefault(s => s.Name == skill.Name);
        if (skillInfo == null)
        {
            // Default to difficulty 5 if not found
            return GameMechanics.SkillCost.GetLevelUpCost(skill.Level, 5);
        }

        // Use Trained as the difficulty level
        var difficulty = skillInfo.Trained;
        return GameMechanics.SkillCost.GetLevelUpCost(skill.Level, difficulty);
    }

    private int GetCumulativeXPCost(GameMechanics.SkillEdit skill)
    {
        var skillInfo = allSkills?.FirstOrDefault(s => s.Name == skill.Name);
        var difficulty = skillInfo?.Trained ?? 5;
        return GameMechanics.SkillCost.GetCumulativeCost(skill.Level, difficulty);
    }

    private bool IsNewSkill(GameMechanics.SkillEdit skill)
    {
        // A skill is "new" if it wasn't in the original list or its level has increased
        if (!vm!.Model!.OriginalSkillLevels.ContainsKey(skill.Name))
        {
            return true;
        }
        return skill.Level > vm.Model.OriginalSkillLevels[skill.Name];
    }

    private bool CanRemoveSkill(GameMechanics.SkillEdit skill)
    {
        // A skill can be removed only if it was added during this character creation session
        // (not in the original skill list). Core attribute skills are always in the original
        // list and cannot be removed.
        return !vm!.Model!.OriginalSkillLevels.ContainsKey(skill.Name);
    }

    // === NPC Template Methods ===

    private void SetNpcSkillLevel(GameMechanics.SkillEdit skill, int newLevel)
    {
        errorMessage = null;
        newLevel = Math.Clamp(newLevel, 0, 10);
        skill.Level = newLevel;

        // Calculate XPSpent based on cumulative trained cost
        var skillInfo = allSkills?.FirstOrDefault(s => s.Name == skill.Name);
        var difficulty = skillInfo?.Trained ?? 5;
        skill.XPSpent = GameMechanics.SkillCost.GetCumulativeCost(newLevel, difficulty);

        StateHasChanged();
    }

    private bool CanRemoveNpcSkill(GameMechanics.SkillEdit skill)
    {
        // Core standard skills cannot be removed from NPC templates
        var skillInfo = allSkills?.FirstOrDefault(s => s.Name == skill.Name);
        return skillInfo?.IsStandard != true;
    }

    private void RemoveNpcSkill(GameMechanics.SkillEdit skill)
    {
        errorMessage = null;
        if (!CanRemoveNpcSkill(skill))
        {
            errorMessage = "Core standard skills cannot be removed.";
            return;
        }
        vm!.Model!.Skills.Remove(skill);
        StateHasChanged();
    }

    // === Player Character Methods ===

    private void IncreaseSkillLevel(GameMechanics.SkillEdit skill)
    {
        errorMessage = null;

        if (skill.Level >= 10)
        {
            errorMessage = "Skill is already at maximum level.";
            return;
        }

        var xpCost = GetXPCostToNextLevel(skill);

        if (vm!.Model!.XPBanked < xpCost)
        {
            errorMessage = $"Not enough XP. Need {xpCost} XP but only have {vm.Model.XPBanked} XP.";
            return;
        }

        // Spend XP and increase level
        vm.Model.SpendXP(xpCost);
        skill.Level++;
        skill.XPSpent += xpCost;

        StateHasChanged();
    }

    private void DecreaseSkillLevel(GameMechanics.SkillEdit skill)
    {
        errorMessage = null;

        // Check if this is a new level increase
        var originalLevel = vm!.Model!.OriginalSkillLevels.ContainsKey(skill.Name) ? vm.Model.OriginalSkillLevels[skill.Name] : 0;

        if (skill.Level <= originalLevel)
        {
            errorMessage = "Cannot reduce skill level below its original value.";
            return;
        }

        // Refund XP and decrease level
        skill.Level--;
        var xpRefund = GetXPCostToNextLevel(skill);
        vm!.Model!.RefundXP(xpRefund);
        skill.XPSpent -= xpRefund;

        StateHasChanged();
    }

    private async Task OpenSkillPickerAsync()
    {
        errorMessage = null;

        // Get existing skill names to exclude from picker
        var existingSkillNames = vm!.Model!.Skills.Select(s => s.Name).ToHashSet();

        var result = await DialogService.OpenAsync<SkillMultiPickerModal>(
            "Add Skills",
            new Dictionary<string, object>
            {
                { "ExistingSkillNames", existingSkillNames },
                { "ExcludeMagicSkills", true }
            },
            new DialogOptions { Width = "600px", Height = "600px", CloseDialogOnOverlayClick = false });

        if (result is List<string> selectedSkillIdentifiers && selectedSkillIdentifiers.Count > 0)
        {
            try
            {
                foreach (var skillIdentifier in selectedSkillIdentifiers)
                {
                    await vm!.Model!.Skills.AddSkillAsync(skillIdentifier, skillListPortal, skillPortal);
                }
                StateHasChanged();
            }
            catch (Exception ex)
            {
                errorMessage = $"Error adding skills: {ex.Message}";
            }
        }
    }

    private void RemoveSkill(GameMechanics.SkillEdit skill)
    {
        errorMessage = null;

        // Check if this is a new skill (not in original list)
        if (vm!.Model!.OriginalSkillLevels.ContainsKey(skill.Name))
        {
            errorMessage = "Cannot remove core attribute skills. You can only remove skills you added during character creation.";
            return;
        }

        // Refund all XP spent on this skill
        if (skill.XPSpent > 0)
        {
            vm!.Model!.RefundXP(skill.XPSpent);
        }

        // Remove the skill
        vm!.Model!.Skills.Remove(skill);

        StateHasChanged();
    }
}
