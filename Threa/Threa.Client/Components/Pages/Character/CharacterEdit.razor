@page "/player/character"
@page "/player/character/{id:int}"

@rendermode InteractiveServer

@attribute [Authorize]

@using Threa.Services

@inject Csla.Blazor.State.StateManager StateManager
@inject RenderModeProvider RenderModeProvider
@inject ViewModel<GameMechanics.CharacterEdit> vm
@inject IDataPortal<GameMechanics.CharacterEdit> characterPortal
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

@implements IDisposable

<h3>Character Details</h3>

<div class="alert-danger">@vm.ViewModelErrorText</div>
@if (vm.Exception != null)
{
    <div class="alert-danger">@vm.Exception.ToString()</div>
}

@if (vm.Model == null)
{
    <div>Loading...  </div>
    <img src="images/busy.gif" class="busy-animation"  />
}
else
{
    <div class="tab-buttons">
        <button class="tab-link @(activeTab == tabNames[0] ? "active" : "")" @onclick="() => SelectTab(tabNames[0])">@tabNames[0]</button>
        <button class="tab-link @(activeTab == tabNames[1] ? "active" : "")" @onclick="() => SelectTab(tabNames[1])">@tabNames[1]</button>
        <button class="tab-link @(activeTab == tabNames[2] ? "active" : "")" @onclick="() => SelectTab(tabNames[2])">@tabNames[2]</button>
        <button class="tab-link @(activeTab == tabNames[3] ? "active" : "")" @onclick="() => SelectTab(tabNames[3])">@tabNames[3]</button>
        <button class="tab-link @(activeTab == tabNames[4] ? "active" : "")" @onclick="() => SelectTab(tabNames[4])">@tabNames[4]</button>
    </div>

    @if (activeTab == tabNames[0])
    {
        <div class="tab-content">
            <TabDetails vm="vm" />
        </div>
    }

    @if (activeTab == tabNames[1])
    {
        <div class="tab-content">
            <TabAttributes vm="vm" />
        </div>
    }

    @if (activeTab == tabNames[2])
    {
        <div class="tab-content">
            <TabSkills vm="vm" />
        </div>
    }

    @if (activeTab == tabNames[3])
    {
        <div class="tab-content">
            <TabMagic vm="vm" />
        </div>
    }

    @if (activeTab == tabNames[4])
    {
        <div class="tab-content">
            <TabItems vm="vm" />
        </div>
    }
    @if (vm.Model.IsBeingSaved)
    {
        <button disabled>Save</button>
        <button disabled>Save and Exit</button>
        <img src="images/busy.gif" class="busy-animation" />
    }
    else
    {
        <button @onclick="SaveAsync" disabled="@(!vm.Model.IsSavable)">Save</button>
        <button @onclick="SaveAndExitAsync" disabled="@(!vm.Model.IsSavable)">Save and Exit</button>
    }
}

@code {
    [Parameter]
    public int id { get; set; }

    private readonly static string[] tabNames = new[] { "Info", "Attributes", "Skills", "Magic", "Items" };
    private string activeTab = tabNames[0];
    private bool _warningEnabled = false;
    private bool _navigateAfterSave = false;

    private void SelectTab(string tabName)
    {
        activeTab = tabName;
    }

    protected override async Task OnInitializedAsync()
    {
        // Every page _must_ initialize the state manager
        await StateManager.InitializeAsync();

        vm.Saved += OnSaved;
        vm.ModelChanged += OnModelChanged;
        vm.ModelPropertyChanged += OnModelPropertyChanged;

        if (RenderModeProvider.GetRenderMode(this).IsInteractive())
        {
            if (id == 0)
                await vm.RefreshAsync(() =>
                  characterPortal.CreateAsync());
            else
                await vm.RefreshAsync(() =>
                  characterPortal.FetchAsync(id));
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await UpdateUnsavedChangesWarning();
        }
    }

    private void OnSaved()
    {
        _ = DisableUnsavedChangesWarning();
        if (_navigateAfterSave)
        {
            NavigationManager.NavigateTo("/player/characters");
        }
        else if (id == 0 && vm.Model?.Id > 0)
        {
            // Update URL to include the new character ID without triggering a full navigation
            NavigationManager.NavigateTo($"/player/character/{vm.Model.Id}", replace: true);
            id = vm.Model.Id;
        }
    }

    private async void OnModelChanged()
    {
        await InvokeAsync(() => StateHasChanged());
        await UpdateUnsavedChangesWarning();
    }

    private async void OnModelPropertyChanged(object? s, System.ComponentModel.PropertyChangedEventArgs a)
    {
        await InvokeAsync(() => StateHasChanged());
        await UpdateUnsavedChangesWarning();
    }

    private async Task UpdateUnsavedChangesWarning()
    {
        if (vm.Model == null) return;

        // Enable warning if there are unsaved changes (new unsaved character or modified existing character)
        bool hasUnsavedChanges = (vm.Model.IsNew || vm.Model.IsDirty) && !vm.Model.IsBeingSaved;

        if (hasUnsavedChanges && !_warningEnabled)
        {
            await JSRuntime.InvokeVoidAsync("unsavedChangesWarning.enable");
            _warningEnabled = true;
        }
        else if (!hasUnsavedChanges && _warningEnabled)
        {
            await DisableUnsavedChangesWarning();
        }
    }

    private async Task DisableUnsavedChangesWarning()
    {
        if (_warningEnabled)
        {
            await JSRuntime.InvokeVoidAsync("unsavedChangesWarning.disable");
            _warningEnabled = false;
        }
    }

    private async void SaveAsync()
    {
        _navigateAfterSave = false;
        vm.Model.IsBeingSaved = true;
        StateHasChanged();
        await Task.Delay(1000);
        await vm.SaveAsync();
        vm.Model.IsBeingSaved = false;
        StateHasChanged();
    }

    private async void SaveAndExitAsync()
    {
        _navigateAfterSave = true;
        vm.Model.IsBeingSaved = true;
        StateHasChanged();
        await Task.Delay(1000);
        await vm.SaveAsync();
        vm.Model.IsBeingSaved = false;
        StateHasChanged();
    }

    public void Dispose()
    {
        vm.Saved -= OnSaved;
        vm.ModelChanged -= OnModelChanged;
        vm.ModelPropertyChanged -= OnModelPropertyChanged;
        _ = DisableUnsavedChangesWarning();
    }
}
