@page "/player/character"
@page "/player/character/{id:int}"

@rendermode InteractiveServer

@attribute [Authorize]

@using System.Linq
@using GameMechanics
@using Threa.Services

@inject RenderModeProvider RenderModeProvider
@inject ViewModel<GameMechanics.CharacterEdit> vm
@inject IDataPortal<GameMechanics.CharacterEdit> characterPortal
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

@implements IDisposable

<h3>Character Details</h3>

<div class="alert-danger">@vm.ViewModelErrorText</div>
@if (vm.Exception != null)
{
    <div class="alert-danger">@vm.Exception.ToString()</div>
}

@if (vm.Model == null)
{
    <div>Loading...  </div>
    <img src="images/busy.gif" class="busy-animation"  />
}
else
{
    <div class="tab-buttons">
        @foreach (var tab in GetVisibleTabs())
        {
            <button class="tab-link @(activeTab == tab ? "active" : "")" @onclick="() => SelectTab(tab)">@tab</button>
        }
    </div>

    @if (activeTab == "Info")
    {
        <div class="tab-content">
            <TabDetails vm="vm" />
        </div>
    }

    @if (activeTab == "Attributes")
    {
        <div class="tab-content">
            <TabAttributes vm="vm" />
        </div>
    }

    @if (activeTab == "Skills")
    {
        <div class="tab-content">
            <TabSkills vm="vm" />
        </div>
    }

    @if (activeTab == "Magic" && vm.Model.Setting != GameSettings.SciFi)
    {
        <div class="tab-content">
            <TabMagic vm="vm" />
        </div>
    }

    @if (activeTab == "Items")
    {
        <div class="tab-content">
            <TabItems vm="vm" />
        </div>
    }
    @if (vm.Model.IsBeingSaved)
    {
        <button disabled>Save</button>
        <button disabled>Save and Exit</button>
        <img src="images/busy.gif" class="busy-animation" />
    }
    else
    {
        <button @onclick="SaveAsync" disabled="@(!vm.Model.IsSavable)">Save</button>
        <button @onclick="SaveAndExitAsync" disabled="@(!vm.Model.IsSavable)">Save and Exit</button>
    }
}

@code {
    [Parameter]
    public int id { get; set; }

    [SupplyParameterFromQuery]
    public string? setting { get; set; }

    private static readonly string[] AllTabNames = ["Info", "Attributes", "Skills", "Magic", "Items"];
    private string activeTab = "Info";

    private string[] GetVisibleTabs()
    {
        if (vm.Model?.Setting == GameSettings.SciFi)
            return AllTabNames.Where(t => t != "Magic").ToArray();
        return AllTabNames;
    }
    private bool _warningEnabled = false;
    private bool _navigateAfterSave = false;

    private void SelectTab(string tabName)
    {
        var visible = GetVisibleTabs();
        activeTab = visible.Contains(tabName) ? tabName : visible[0];
    }

    protected override async Task OnInitializedAsync()
    {
        // Every page _must_ initialize the state manager

        vm.Saved += OnSaved;
        vm.ModelChanged += OnModelChanged;
        vm.ModelPropertyChanged += OnModelPropertyChanged;

        if (RenderModeProvider.GetRenderMode(this).IsInteractive())
        {
            if (id == 0)
            {
                var effectiveSetting = GameSettings.IsValid(setting) ? setting! : GameSettings.Default;
                await vm.RefreshAsync(async () =>
                {
                    var character = await characterPortal.CreateAsync();
                    character.Setting = effectiveSetting;
                    return character;
                });
            }
            else
                await vm.RefreshAsync(() =>
                  characterPortal.FetchAsync(id));
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await UpdateUnsavedChangesWarning();
        }
    }

    private void OnSaved()
    {
        _ = DisableUnsavedChangesWarning();
        if (_navigateAfterSave)
        {
            NavigationManager.NavigateTo("/player/characters");
        }
        else if (id == 0 && vm.Model?.Id > 0)
        {
            // Update URL to include the new character ID without triggering a full navigation
            NavigationManager.NavigateTo($"/player/character/{vm.Model.Id}", replace: true);
            id = vm.Model.Id;
        }
    }

    private async void OnModelChanged()
    {
        await InvokeAsync(() => StateHasChanged());
        await UpdateUnsavedChangesWarning();
    }

    private async void OnModelPropertyChanged(object? s, System.ComponentModel.PropertyChangedEventArgs a)
    {
        await InvokeAsync(() => StateHasChanged());
        await UpdateUnsavedChangesWarning();
    }

    private async Task UpdateUnsavedChangesWarning()
    {
        if (vm.Model == null) return;

        // Enable warning if there are unsaved changes (new unsaved character or modified existing character)
        bool hasUnsavedChanges = (vm.Model.IsNew || vm.Model.IsDirty) && !vm.Model.IsBeingSaved;

        if (hasUnsavedChanges && !_warningEnabled)
        {
            await JSRuntime.InvokeVoidAsync("unsavedChangesWarning.enable");
            _warningEnabled = true;
        }
        else if (!hasUnsavedChanges && _warningEnabled)
        {
            await DisableUnsavedChangesWarning();
        }
    }

    private async Task DisableUnsavedChangesWarning()
    {
        if (_warningEnabled)
        {
            await JSRuntime.InvokeVoidAsync("unsavedChangesWarning.disable");
            _warningEnabled = false;
        }
    }

    private async void SaveAsync()
    {
        _navigateAfterSave = false;
        vm.Model.IsBeingSaved = true;
        StateHasChanged();
        await Task.Delay(1000);
        await vm.SaveAsync();
        vm.Model.IsBeingSaved = false;
        StateHasChanged();
    }

    private async void SaveAndExitAsync()
    {
        _navigateAfterSave = true;
        vm.Model.IsBeingSaved = true;
        StateHasChanged();
        await Task.Delay(1000);
        await vm.SaveAsync();
        vm.Model.IsBeingSaved = false;
        StateHasChanged();
    }

    public void Dispose()
    {
        vm.Saved -= OnSaved;
        vm.ModelChanged -= OnModelChanged;
        vm.ModelPropertyChanged -= OnModelPropertyChanged;
        _ = DisableUnsavedChangesWarning();
    }
}
