@page "/profile/{Id:int}"
@rendermode InteractiveServer

@attribute [Authorize]

@using GameMechanics.Player
@using Threa.Client.Components.Shared

@inject IDataPortal<ProfileInfo> profilePortal
@inject Threa.Services.RenderModeProvider RenderModeProvider

<h3>User Profile</h3>

@if (_loading)
{
    <div>Loading...</div>
    <img src="images/busy.gif" class="busy-animation" />
}
else if (_error != null)
{
    <div class="alert alert-danger">@_error</div>
}
else if (_profile != null)
{
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <UserAvatar Email="@_profile.ContactEmail"
                                    DisplayName="@_profile.Name"
                                    Size="128"
                                    UseGravatar="@_profile.UseGravatar" />
                    </div>
                    <h4 class="card-title">@_profile.Name</h4>
                    <p class="text-muted">Player ID: @_profile.Id</p>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private ProfileInfo? _profile;
    private bool _loading = true;
    private string? _error;

    protected override async Task OnInitializedAsync()
    {
        if (!RenderModeProvider.GetRenderMode(this).ToString().Contains("Interactive"))
            return;

        await LoadProfile();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reload if Id changes (navigating between profiles)
        if (!_loading && (_profile == null || _profile.Id != Id))
        {
            await LoadProfile();
        }
    }

    private async Task LoadProfile()
    {
        _loading = true;
        _error = null;

        try
        {
            _profile = await profilePortal.FetchAsync(Id);
        }
        catch (Exception)
        {
            _error = "Unable to load profile. The user may not exist.";
            _profile = null;
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }
}
