@page "/play"
@page "/play/{TableId:guid}"

@rendermode InteractiveServer

@attribute [Authorize]

@using Threa.Services

@inject Csla.Blazor.State.StateManager StateManager
@inject RenderModeProvider RenderModeProvider
@inject NavigationManager NavigationManager
@inject ApplicationContext applicationContext
@inject IDataPortal<GameMechanics.CharacterEdit> characterPortal
@inject IDataPortal<GameMechanics.GamePlay.TableEdit> tablePortal
@inject IDataPortal<GameMechanics.Player.CharacterList> characterListPortal

<PageTitle>Threa - Play</PageTitle>

@if (errorMessage != null)
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (table == null && TableId != Guid.Empty)
{
    <div>Loading table...</div>
}
else if (character == null)
{
    <h3>Select a Character to Play</h3>

    @if (availableCharacters == null)
    {
        <p>Loading characters...</p>
    }
    else if (!availableCharacters.Any())
    {
        <div class="alert alert-info">
            <p>You don't have any activated characters to play.</p>
            <p><a href="/player/characters">Create and activate a character</a> to start playing.</p>
        </div>
    }
    else
    {
        <div class="list-group" style="max-width: 500px;">
            @foreach (var charInfo in availableCharacters)
            {
                <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                        @onclick="() => SelectCharacterAsync(charInfo.Id)">
                    <div>
                        <strong>@charInfo.Name</strong>
                        <br />
                        <small class="text-muted">@charInfo.Species</small>
                    </div>
                    <span class="badge bg-success">Play</span>
                </button>
            }
        </div>
    }
}
else
{
    <!-- Character Status Header -->
    <div class="character-header" style="background-color: #2d3748; color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <div class="d-flex flex-wrap justify-content-between align-items-center">
            <div>
                <h4 style="margin: 0;">@character.Name</h4>
                <small>@character.Species</small>
            </div>
            <div class="d-flex gap-4 flex-wrap">
                <div class="text-center">
                    <small>FAT</small>
                    <div class="fw-bold">@character.Fatigue.Value / @character.Fatigue.BaseValue</div>
                    <div class="progress" style="height: 8px; width: 80px;">
                        <div class="progress-bar @(GetFatBarColor())" style="width: @GetFatPercent()%"></div>
                    </div>
                </div>
                <div class="text-center">
                    <small>VIT</small>
                    <div class="fw-bold">@character.Vitality.Value / @character.Vitality.BaseValue</div>
                    <div class="progress" style="height: 8px; width: 80px;">
                        <div class="progress-bar @(GetVitBarColor())" style="width: @GetVitPercent()%"></div>
                    </div>
                </div>
                <div class="text-center">
                    <small>AP</small>
                    <div class="fw-bold">@character.ActionPoints.Available / @character.ActionPoints.Max</div>
                </div>
            </div>
            <div>
                @if (table != null)
                {
                    <small>Table: @table.Name</small>
                    <br />
                    <span class="badge @(table.IsInCombat ? "bg-danger" : "bg-success")">
                        @(table.IsInCombat ? "Combat" : "Exploration") - Round @table.CurrentRound
                    </span>
                }
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-buttons">
        @foreach (var tabName in tabNames)
        {
            <button class="tab-link @(activeTab == tabName ? "active" : "")"
                    @onclick="() => SelectTab(tabName)">
                @tabName
            </button>
        }
    </div>

    <!-- Tab Content -->
    <div class="tab-content" style="padding: 1rem; border: 1px solid #ddd; border-top: none; border-radius: 0 0 8px 8px;">
        @if (activeTab == "Status")
        {
            <TabStatus Character="character" Table="table" />
        }
        else if (activeTab == "Actions")
        {
            <TabActions Character="character" Table="table" />
        }
        else if (activeTab == "Skills")
        {
            <TabPlaySkills Character="character" Table="table" />
        }
        else if (activeTab == "Magic")
        {
            <TabPlayMagic Character="character" Table="table" />
        }
        else if (activeTab == "Defense")
        {
            <TabDefense Character="character" Table="table" />
        }
        else if (activeTab == "Inventory")
        {
            <TabPlayInventory Character="character" Table="table" />
        }
    </div>

    <!-- Activity Log -->
    <div class="activity-log mt-3" style="background-color: #f8f9fa; padding: 1rem; border-radius: 8px; max-height: 200px; overflow-y: auto;">
        <h6>Activity Log</h6>
        @if (activityLog.Count == 0)
        {
            <p class="text-muted">No recent activity.</p>
        }
        else
        {
            @foreach (var entry in activityLog.TakeLast(10).Reverse())
            {
                <div class="small">
                    <span class="text-muted">[@entry.Timestamp.ToString("HH:mm:ss")]</span>
                    @entry.Message
                </div>
            }
        }
    </div>
}

@code {
    [Parameter]
    public Guid TableId { get; set; }

    private static readonly string[] tabNames = new[] { "Status", "Actions", "Skills", "Magic", "Defense", "Inventory" };
    private string activeTab = tabNames[0];

    private GameMechanics.CharacterEdit? character;
    private GameMechanics.GamePlay.TableEdit? table;
    private IEnumerable<GameMechanics.Player.CharacterInfo>? availableCharacters;
    private string? errorMessage;
    private List<ActivityLogEntry> activityLog = new();

    private record ActivityLogEntry(DateTime Timestamp, string Message);

    protected override async Task OnInitializedAsync()
    {
        await StateManager.InitializeAsync();

        if (RenderModeProvider.GetRenderMode(this).IsInteractive())
        {
            // Get the current player ID from claims
            var playerId = int.Parse(applicationContext.Principal.Claims
                .Where(_ => _.Type == System.Security.Claims.ClaimTypes.NameIdentifier).First().Value);

            // Load available characters for selection
            var charList = await characterListPortal.FetchAsync(playerId);
            availableCharacters = charList.Where(c => c.IsPlayable);

            // If TableId is provided, load the table
            if (TableId != Guid.Empty)
            {
                try
                {
                    table = await tablePortal.FetchAsync(TableId);
                }
                catch (Exception ex)
                {
                    errorMessage = $"Failed to load table: {ex.Message}";
                }
            }
        }
    }

    private async Task SelectCharacterAsync(int characterId)
    {
        try
        {
            errorMessage = null;
            character = await characterPortal.FetchAsync(characterId);
            AddLogEntry($"Playing as {character.Name}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load character: {ex.Message}";
        }
    }

    private void SelectTab(string tabName)
    {
        activeTab = tabName;
    }

    private void AddLogEntry(string message)
    {
        activityLog.Add(new ActivityLogEntry(DateTime.Now, message));
        if (activityLog.Count > 100)
            activityLog.RemoveAt(0);
    }

    // UI Helper methods
    private int GetFatPercent() => character?.Fatigue.BaseValue > 0
        ? (int)((double)character.Fatigue.Value / character.Fatigue.BaseValue * 100) : 0;

    private int GetVitPercent() => character?.Vitality.BaseValue > 0
        ? (int)((double)character.Vitality.Value / character.Vitality.BaseValue * 100) : 0;

    private string GetFatBarColor()
    {
        var percent = GetFatPercent();
        return percent > 50 ? "bg-success" : percent > 25 ? "bg-warning" : "bg-danger";
    }

    private string GetVitBarColor()
    {
        var percent = GetVitPercent();
        return percent > 50 ? "bg-success" : percent > 25 ? "bg-warning" : "bg-danger";
    }
}
