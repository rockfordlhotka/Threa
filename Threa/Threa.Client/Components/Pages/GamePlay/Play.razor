@page "/play"
@page "/play/{TableId:guid}"

@rendermode InteractiveServer

@attribute [Authorize]

@implements IDisposable

@using GameMechanics.Messaging
@using Threa.Services
@using Threa.Client.Components.Shared

@inject Csla.Blazor.State.StateManager StateManager
@inject RenderModeProvider RenderModeProvider
@inject NavigationManager NavigationManager
@inject ApplicationContext applicationContext
@inject IDataPortal<GameMechanics.CharacterEdit> characterPortal
@inject IDataPortal<GameMechanics.GamePlay.TableEdit> tablePortal
@inject IDataPortal<GameMechanics.Player.CharacterList> characterListPortal
@inject IDataPortal<GameMechanics.GamePlay.TableCharacterDetacher> detacherPortal
@inject IDataPortal<GameMechanics.GamePlay.TableCharacterAttacher> attacherPortal
@inject IDataPortal<GameMechanics.GamePlay.TableList> tableListPortal
@inject IActivityLogService ActivityLog

<PageTitle>Threa - Play</PageTitle>

@if (errorMessage != null)
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (table == null && TableId != Guid.Empty)
{
    <div>Loading table...</div>
}
else if (character == null)
{
    <h3>Select a Character to Play</h3>

    @if (availableCharacters == null)
    {
        <p>Loading characters...</p>
    }
    else if (!availableCharacters.Any())
    {
        <div class="alert alert-info">
            <p>You don't have any activated characters to play.</p>
            <p><a href="/player/characters">Create and activate a character</a> to start playing.</p>
        </div>
    }
    else
    {
        <div class="list-group" style="max-width: 500px;">
            @foreach (var charInfo in availableCharacters)
            {
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-2 flex-grow-1" 
                         style="cursor: pointer;" 
                         @onclick="() => SelectCharacterAsync(charInfo.Id)">
                        <div>
                            <strong>@charInfo.Name</strong>
                            <br />
                            <small class="text-muted">@charInfo.Species</small>
                            @if (charInfo.IsAttachedToTable)
                            {
                                <br />
                                <small class="text-info"><i class="bi bi-table"></i> Table: @charInfo.TableName</small>
                            }
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        @if (charInfo.IsAttachedToTable)
                        {
                            <button class="btn btn-sm btn-outline-warning" 
                                    title="Detach from table"
                                    @onclick="() => ShowDetachConfirmation(charInfo)"
                                    @onclick:stopPropagation="true">
                                <i class="bi bi-box-arrow-right"></i>
                            </button>
                        }
                        <button class="btn btn-sm btn-success" 
                                @onclick="() => SelectCharacterAsync(charInfo.Id)"
                                @onclick:stopPropagation="true">
                            Play
                        </button>
                    </div>
                </div>
            }
        </div>
    }
}

@* Detach Confirmation Dialog *@
@if (showDetachConfirmation && characterToDetach != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">Confirm Detach from Table</h5>
                    <button type="button" class="btn-close" @onclick="CancelDetach"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to detach <strong>@characterToDetach.Name</strong> from table <strong>@characterToDetach.TableName</strong>?</p>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Warning:</strong> This will remove your character from the active game session. 
                        You will need to rejoin the table to continue playing in that session.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelDetach">Cancel</button>
                    <button type="button" class="btn btn-warning" @onclick="ConfirmDetach" disabled="@isDetaching">
                        @if (isDetaching)
                        {
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            <span>Detaching...</span>
                        }
                        else
                        {
                            <span>Detach Character</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@* Table Selection Dialog *@
@if (showTableSelection && characterToAttach != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Join a Table</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CancelTableSelection"></button>
                </div>
                <div class="modal-body">
                    <p>Select a table for <strong>@characterToAttach.Name</strong> to join:</p>
                    
                    @if (availableTables == null)
                    {
                        <p>Loading tables...</p>
                    }
                    else if (!availableTables.Any())
                    {
                        <div class="alert alert-info">
                            <p>No active tables available.</p>
                            <p>You can still play without joining a table, or ask a Game Master to create one.</p>
                        </div>
                    }
                    else
                    {
                        <div class="list-group mb-3">
                            @foreach (var tableInfo in availableTables)
                            {
                                <button type="button" 
                                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center @(selectedTableId == tableInfo.Id ? "active" : "")"
                                        @onclick="() => selectedTableId = tableInfo.Id">
                                    <div>
                                        <strong>@tableInfo.Name</strong>
                                        <br />
                                        <small>@tableInfo.StatusDisplay - Round @tableInfo.CurrentRound</small>
                                    </div>
                                    @if (selectedTableId == tableInfo.Id)
                                    {
                                        <i class="bi bi-check-circle-fill"></i>
                                    }
                                </button>
                            }
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelTableSelection">Cancel</button>
                    <button type="button" class="btn btn-outline-primary" @onclick="PlayWithoutTable">
                        Play Without Table
                    </button>
                    @if (availableTables != null && availableTables.Any())
                    {
                        <button type="button" class="btn btn-primary" 
                                @onclick="ConfirmTableSelection" 
                                disabled="@(selectedTableId == Guid.Empty || isAttaching)">
                            @if (isAttaching)
                            {
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                <span>Joining...</span>
                            }
                            else
                            {
                                <span>Join Table</span>
                            }
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
}

@if (character != null)
{
    <!-- Character Status Header -->
    <div class="character-header" style="background-color: #2d3748; color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <div class="d-flex flex-column gap-3">
            <div class="d-flex flex-wrap justify-content-between align-items-start">
                <div>
                    <h4 style="margin: 0;">@character.Name</h4>
                    <small>@character.Species</small>
                </div>

                <div class="d-flex gap-4 flex-wrap justify-content-center">
                    <div class="text-center" style="width: 120px;">
                        <small>FAT</small>
                        <div class="fw-bold">@character.Fatigue.Value / @character.Fatigue.BaseValue</div>
                        <PendingPoolBar CurrentValue="@character.Fatigue.Value"
                                        MaxValue="@character.Fatigue.BaseValue"
                                        PendingDamage="@character.Fatigue.PendingDamage"
                                        PendingHealing="@character.Fatigue.PendingHealing"
                                        Height="10px" />
                    </div>
                    <div class="text-center" style="width: 120px;">
                        <small>VIT</small>
                        <div class="fw-bold">@character.Vitality.Value / @character.Vitality.BaseValue</div>
                        <PendingPoolBar CurrentValue="@character.Vitality.Value"
                                        MaxValue="@character.Vitality.BaseValue"
                                        PendingDamage="@character.Vitality.PendingDamage"
                                        PendingHealing="@character.Vitality.PendingHealing"
                                        Height="10px" />
                    </div>
                    <div class="text-center">
                        <small>AP</small>
                        <div class="fw-bold fs-4">@character.ActionPoints.Available / @character.ActionPoints.Max</div>
                    </div>
                    <div class="text-center">
                        <small>Wounds</small>
                        <div class="fw-bold fs-4">
                            <i class="bi bi-bandaid"></i> @GetWoundCount()
                        </div>
                    </div>
                </div>

                <div>
                    @if (table != null)
                    {
                        <div class="text-end">
                            <small>Table: @table.Name</small>
                            <br />
                            <span class="badge @(table.IsInCombat ? "bg-danger" : "bg-success")">
                                @(table.IsInCombat ? "Combat" : "Exploration") - Round @table.CurrentRound
                            </span>
                        </div>
                    }
                </div>
            </div>

            @if (character.Effects.Any())
            {
                <div class="d-flex flex-wrap gap-2 align-items-center" style="border-top: 1px solid #4a5568; padding-top: 0.75rem;">
                    <small class="me-2">Effects:</small>
                    @foreach (var effect in character.Effects)
                    {
                        <EffectIcon EffectType="@effect.EffectType.ToString()"
                                    EffectName="@effect.Name"
                                    Tooltip="@GetEffectTooltip(effect)"
                                    Stacks="@effect.CurrentStacks"
                                    Color="white" />
                    }
                </div>
            }
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-buttons">
        @foreach (var tabName in tabNames)
        {
            <button class="tab-link @(activeTab == tabName ? "active" : "")"
                    @onclick="() => SelectTab(tabName)">
                @tabName
            </button>
        }
    </div>

    <!-- Tab Content -->
    <div class="tab-content" style="padding: 1rem; border: 1px solid #ddd; border-top: none; border-radius: 0 0 8px 8px;">
        @if (activeTab == "Status")
        {
            <TabStatus Character="character" Table="table" />
        }
        else if (activeTab == "Combat")
        {
            <TabCombat Character="character" Table="table" />
        }
        else if (activeTab == "Skills")
        {
            <TabPlaySkills Character="character" Table="table" />
        }
        else if (activeTab == "Magic")
        {
            <TabPlayMagic Character="character" Table="table" />
        }
        else if (activeTab == "Defense")
        {
            <TabDefense Character="character" Table="table" />
        }
        else if (activeTab == "Inventory")
        {
            <TabPlayInventory Character="character" Table="table" />
        }
    </div>

    <!-- Activity Log -->
    <div class="activity-log mt-3" style="background-color: #f8f9fa; padding: 1rem; border-radius: 8px; max-height: 200px; overflow-y: auto;">
        <h6>Activity Log</h6>
        @if (activityLog.Count == 0)
        {
            <p class="text-muted">No recent activity.</p>
        }
        else
        {
            @foreach (var entry in activityLog.TakeLast(10).Reverse())
            {
                <div class="small @GetActivityClass(entry.Category)">
                    <span class="text-muted">[@entry.Timestamp.ToString("HH:mm:ss")]</span>
                    <strong>@entry.Source:</strong> @entry.Message
                </div>
            }
        }
    </div>
}

@code {
[Parameter]
public Guid TableId { get; set; }

private static readonly string[] tabNames = new[] { "Status", "Combat", "Skills", "Magic", "Defense", "Inventory" };
private string activeTab = tabNames[0];

private GameMechanics.CharacterEdit? character;
private GameMechanics.GamePlay.TableEdit? table;
private IEnumerable<GameMechanics.Player.CharacterInfo>? availableCharacters;
private IEnumerable<GameMechanics.GamePlay.TableInfo>? availableTables;
private string? errorMessage;
private int currentPlayerId;
private List<ActivityLogEntry> activityLog = new();
private IDisposable? activityLogSubscription;

// Detach confirmation state
private bool showDetachConfirmation;
private bool isDetaching;
private GameMechanics.Player.CharacterInfo? characterToDetach;

// Table selection state
private bool showTableSelection;
private bool isAttaching;
private GameMechanics.Player.CharacterInfo? characterToAttach;
private Guid selectedTableId;

private record ActivityLogEntry(DateTime Timestamp, string Message, string Source, ActivityCategory Category);

protected override async Task OnInitializedAsync()
{
    await StateManager.InitializeAsync();

    if (RenderModeProvider.GetRenderMode(this).IsInteractive())
    {
        // Get the current player ID from claims
        currentPlayerId = int.Parse(applicationContext.Principal.Claims
            .Where(_ => _.Type == System.Security.Claims.ClaimTypes.NameIdentifier).First().Value);

        await LoadCharactersAsync();

        // If TableId is provided, load the table
        if (TableId != Guid.Empty)
        {
            try
            {
                table = await tablePortal.FetchAsync(TableId);
                SubscribeToActivityLog(TableId);
            }
            catch (Exception ex)
            {
                errorMessage = $"Failed to load table: {ex.Message}";
            }
        }
    }
}

private async Task LoadCharactersAsync()
{
    // Load available characters for selection
    var charList = await characterListPortal.FetchAsync(currentPlayerId);
    availableCharacters = charList.Where(c => c.IsPlayable);
}

private async Task LoadTablesAsync()
{
    try
    {
        var tableList = await tableListPortal.FetchAsync();
        // Show only active tables (not ended)
        availableTables = tableList.Where(t => t.Status != Threa.Dal.Dto.TableStatus.Ended);
    }
    catch (Exception ex)
    {
        errorMessage = $"Failed to load tables: {ex.Message}";
    }
}

private async Task SelectCharacterAsync(int characterId)
{
    try
    {
        errorMessage = null;
        
        // Find the character info to check if attached to table
        var charInfo = availableCharacters?.FirstOrDefault(c => c.Id == characterId);
        
        if (charInfo != null && !charInfo.IsAttachedToTable)
        {
            // Character not attached to a table - show table selection dialog
            characterToAttach = charInfo;
            selectedTableId = Guid.Empty;
            await LoadTablesAsync();
            showTableSelection = true;
        }
        else
        {
            // Character is attached to a table or we couldn't find info - just load and play
            character = await characterPortal.FetchAsync(characterId);
            
            // If attached to a table, load the table too
            if (charInfo?.TableId != null)
            {
                try
                {
                    table = await tablePortal.FetchAsync(charInfo.TableId.Value);
                    SubscribeToActivityLog(charInfo.TableId.Value);
                }
                catch
                {
                    // Table might not exist anymore - continue without it
                }
            }

            AddLogEntry($"Playing as {character.Name}", ActivityCategory.Player);
        }
    }
    catch (Exception ex)
    {
        errorMessage = $"Failed to load character: {ex.Message}";
    }
}

    private void SelectTab(string tabName)
    {
        activeTab = tabName;
    }

    private void AddLogEntry(string message, ActivityCategory category = ActivityCategory.General)
    {
        // Only publish if we have a table context
        if (table != null)
        {
            ActivityLog.Publish(table.Id, message, character?.Name ?? "Player", category);
        }
        else
        {
            // Local-only for when there's no table
            activityLog.Add(new ActivityLogEntry(DateTime.Now, message, character?.Name ?? "Player", category));
            if (activityLog.Count > 100)
                activityLog.RemoveAt(0);
        }
    }

    private void SubscribeToActivityLog(Guid tableId)
    {
        // Unsubscribe from any previous subscription
        activityLogSubscription?.Dispose();

        activityLogSubscription = ActivityLog.Subscribe(tableId, msg =>
        {
            InvokeAsync(() =>
            {
                activityLog.Add(new ActivityLogEntry(msg.Timestamp, msg.Message, msg.Source, msg.Category));
                if (activityLog.Count > 100) activityLog.RemoveAt(0);
                StateHasChanged();
            });
        });
    }

    public void Dispose()
    {
        activityLogSubscription?.Dispose();
    }

    private string GetActivityClass(ActivityCategory category) =>
        category switch
        {
            ActivityCategory.Combat => "text-danger",
            ActivityCategory.Announcement => "text-primary fw-bold",
            ActivityCategory.Health => "text-success",
            ActivityCategory.Effect => "text-warning",
            ActivityCategory.Time => "text-info",
            ActivityCategory.Session => "text-secondary fst-italic",
            ActivityCategory.Player => "text-muted",
            _ => ""
        };

    // UI Helper methods
    private int GetWoundCount() => character?.Effects.Count(e => e.EffectType == Threa.Dal.Dto.EffectType.Wound) ?? 0;

    private string GetEffectTooltip(GameMechanics.EffectRecord effect)
    {
        var duration = effect.RemainingRounds.HasValue ? $" ({effect.RemainingRounds} rounds left)" : "";
        var source = string.IsNullOrEmpty(effect.Source) ? "" : $" (Source: {effect.Source})";
        var description = string.IsNullOrEmpty(effect.Description) ? "" : $": {effect.Description}";

        return $"{effect.Name}{description}{duration}{source}";
    }

    // Detach confirmation methods
    private void ShowDetachConfirmation(GameMechanics.Player.CharacterInfo charInfo)
    {
        characterToDetach = charInfo;
        showDetachConfirmation = true;
    }

    private void CancelDetach()
    {
        showDetachConfirmation = false;
        characterToDetach = null;
    }

    private async Task ConfirmDetach()
    {
        if (characterToDetach == null) return;

        try
        {
            isDetaching = true;
            errorMessage = null;

            var result = await detacherPortal.ExecuteAsync(characterToDetach.Id);

            if (result.Success)
            {
                AddLogEntry($"Detached {characterToDetach.Name} from table {result.TableName}", ActivityCategory.Player);

                // Reload the character list to reflect the change
                await LoadCharactersAsync();
            }
            else
            {
                errorMessage = result.ErrorMessage ?? "Failed to detach character from table.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to detach character: {ex.Message}";
        }
        finally
        {
            isDetaching = false;
            showDetachConfirmation = false;
            characterToDetach = null;
        }
    }

    // Table selection methods
    private void CancelTableSelection()
    {
        showTableSelection = false;
        characterToAttach = null;
        selectedTableId = Guid.Empty;
    }

    private async Task PlayWithoutTable()
    {
        if (characterToAttach == null) return;

        try
        {
            errorMessage = null;
            character = await characterPortal.FetchAsync(characterToAttach.Id);
            AddLogEntry($"Playing as {character.Name} (no table)", ActivityCategory.Player);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load character: {ex.Message}";
        }
        finally
        {
            showTableSelection = false;
            characterToAttach = null;
            selectedTableId = Guid.Empty;
        }
    }

    private async Task ConfirmTableSelection()
    {
        if (characterToAttach == null || selectedTableId == Guid.Empty) return;

        try
        {
            isAttaching = true;
            errorMessage = null;

            var result = await attacherPortal.ExecuteAsync(characterToAttach.Id, selectedTableId, currentPlayerId);

            if (result.Success)
            {
                    // Load the character and table
                character = await characterPortal.FetchAsync(characterToAttach.Id);
                table = await tablePortal.FetchAsync(selectedTableId);
                SubscribeToActivityLog(selectedTableId);

                // Reload the character list to reflect the change
                await LoadCharactersAsync();

                AddLogEntry($"Joined table {result.TableName}", ActivityCategory.Player);
            }
            else
            {
                errorMessage = result.ErrorMessage ?? "Failed to join table.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to join table: {ex.Message}";
        }
        finally
        {
            isAttaching = false;
            showTableSelection = false;
            characterToAttach = null;
            selectedTableId = Guid.Empty;
        }
    }
}
