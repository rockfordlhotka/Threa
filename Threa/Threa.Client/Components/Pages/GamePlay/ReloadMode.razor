@using Threa.Client.Components.Shared
@using GameMechanics.Combat
@using GameMechanics.Effects.Behaviors
@using Threa.Dal.Dto

@inject Radzen.DialogService DialogService

<div class="reload-mode">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0"><i class="bi bi-box-arrow-in-down text-success"></i> Reload Weapon</h4>
        <button class="btn btn-outline-secondary btn-sm" @onclick="OnCancel">
            <i class="bi bi-x-lg"></i> Cancel
        </button>
    </div>

    @if (!hasReloaded)
    {
        <!-- Reload Setup -->
        <div class="row">
            <div class="col-md-6">
                <!-- Weapon Selection -->
                <div class="card mb-3">
                    <div class="card-header">
                        <strong>1. Select Weapon to Reload</strong>
                    </div>
                    <div class="card-body">
                        @if (AvailableWeapons == null || !AvailableWeapons.Any())
                        {
                            <p class="text-muted">No ranged weapons equipped.</p>
                        }
                        else
                        {
                            <div class="list-group">
                                @foreach (var weapon in AvailableWeapons)
                                {
                                    <button class="list-group-item list-group-item-action @(selectedWeapon?.ItemId == weapon.ItemId ? "active" : "")"
                                            @onclick="() => SelectWeapon(weapon)">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>@weapon.Name</strong>
                                                <div class="small @(selectedWeapon?.ItemId == weapon.ItemId ? "" : "text-muted")">
                                                    @weapon.LoadedAmmoType ammo
                                                </div>
                                            </div>
                                            <div class="text-end">
                                                <span class="badge @GetAmmoBadgeClass(weapon)">
                                                    @weapon.LoadedAmmo / @weapon.Capacity
                                                </span>
                                                @if (weapon.LoadedAmmo >= weapon.Capacity)
                                                {
                                                    <div class="small text-success">Full</div>
                                                }
                                            </div>
                                        </div>
                                    </button>
                                }
                            </div>
                        }
                    </div>
                </div>

                @if (selectedWeapon != null)
                {
                    <!-- Ammo Source Selection -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong>2. Select Ammo Source</strong>
                            @if (!string.IsNullOrEmpty(selectedWeapon.AcceptedAmmoType))
                            {
                                <small class="text-muted ms-2">(requires @selectedWeapon.AcceptedAmmoType)</small>
                            }
                        </div>
                        <div class="card-body">
                            @if (!GetCompatibleAmmoSources().Any())
                            {
                                <p class="text-muted">No compatible magazines or ammo in inventory.</p>
                            }
                            else
                            {
                                <div class="list-group">
                                    @foreach (var mag in GetCompatibleAmmoSources())
                                    {
                                        <button class="list-group-item list-group-item-action @(selectedMagazine?.ItemId == mag.ItemId ? "active" : "")"
                                                @onclick="() => SelectMagazine(mag)">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>@mag.Name</strong>
                                                    <div class="small @(selectedMagazine?.ItemId == mag.ItemId ? "" : "text-muted")">
                                                        @(mag.IsLooseAmmo ? "Loose ammo" : "Magazine")
                                                    </div>
                                                </div>
                                                <div class="text-end">
                                                    <span class="badge @(mag.CurrentAmmo > 0 ? "bg-success" : "bg-secondary")">
                                                        @mag.CurrentAmmo @(mag.IsLooseAmmo ? "rounds" : $"/ {mag.Capacity}")
                                                    </span>
                                                </div>
                                            </div>
                                        </button>
                                    }
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Action Cost -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong>3. Action Cost</strong>
                        </div>
                        <div class="card-body">
                            <ActionCostSelector AP="@(Character?.ActionPoints.Available ?? 0)"
                                                Fat="@(Character?.Fatigue.Value ?? 0)"
                                                OnCostTypeSelected="OnCostTypeChanged" />
                        </div>
                    </div>
                }
            </div>

            <div class="col-md-6">
                <!-- Reload Summary -->
                <div class="card bg-light">
                    <div class="card-header bg-success text-white">
                        <strong><i class="bi bi-info-circle"></i> Reload Summary</strong>
                    </div>
                    <div class="card-body">
                        @if (selectedWeapon != null && selectedMagazine != null)
                        {
                            <table class="table table-sm mb-0">
                                <tbody>
                                    <tr>
                                        <td>Weapon:</td>
                                        <td class="fw-bold">@selectedWeapon.Name</td>
                                    </tr>
                                    <tr>
                                        <td>Current Ammo:</td>
                                        <td class="fw-bold">@selectedWeapon.LoadedAmmo / @selectedWeapon.Capacity</td>
                                    </tr>
                                    <tr>
                                        <td colspan="2"><hr class="my-1" /></td>
                                    </tr>
                                    <tr>
                                        <td>Ammo Source:</td>
                                        <td class="fw-bold">@selectedMagazine.Name</td>
                                    </tr>
                                    <tr>
                                        <td>Available:</td>
                                        <td class="fw-bold">@selectedMagazine.CurrentAmmo rounds</td>
                                    </tr>
                                    <tr>
                                        <td colspan="2"><hr class="my-1" /></td>
                                    </tr>
                                    <tr>
                                        <td>Rounds to Load:</td>
                                        <td class="fw-bold text-success">@GetRoundsToLoad()</td>
                                    </tr>
                                    <tr>
                                        <td>After Reload:</td>
                                        <td class="fw-bold">@GetAmmoAfterReload() / @selectedWeapon.Capacity</td>
                                    </tr>
                                    <tr>
                                        <td colspan="2"><hr class="my-1" /></td>
                                    </tr>
                                    <tr>
                                        <td>Cost:</td>
                                        <td>@GetCostDisplay()</td>
                                    </tr>
                                </tbody>
                            </table>
                        }
                        else
                        {
                            <p class="text-muted mb-0">Select a weapon and ammo source to see reload details.</p>
                        }
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-success btn-lg w-100"
                                @onclick="ExecuteReload"
                                disabled="@(!CanReload())">
                            <i class="bi bi-box-arrow-in-down"></i> Reload
                        </button>
                    </div>
                </div>

                <!-- Current Equipment Status -->
                <div class="card mt-3 bg-light">
                    <div class="card-body py-2">
                        <div class="row text-center">
                            <div class="col-4">
                                <small class="text-muted">AP</small>
                                <div class="fw-bold @(Character?.ActionPoints.Available <= 0 ? "text-danger" : "")">
                                    @Character?.ActionPoints.Available / @Character?.ActionPoints.Max
                                </div>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">FAT</small>
                                <div class="fw-bold @(Character?.Fatigue.Value <= 0 ? "text-danger" : "")">
                                    @Character?.Fatigue.Value / @Character?.Fatigue.BaseValue
                                </div>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">VIT</small>
                                <div class="fw-bold">
                                    @Character?.Vitality.Value / @Character?.Vitality.BaseValue
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Reload Result -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <strong><i class="bi bi-check-circle"></i> Weapon Reloaded!</strong>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tbody>
                        <tr>
                            <td>Weapon:</td>
                            <td class="fw-bold">@reloadResult?.WeaponName</td>
                        </tr>
                        <tr>
                            <td>Rounds Loaded:</td>
                            <td class="fw-bold text-success">@reloadResult?.RoundsLoaded</td>
                        </tr>
                        <tr>
                            <td>New Ammo Count:</td>
                            <td class="fw-bold">@reloadResult?.NewAmmoCount / @reloadResult?.Capacity</td>
                        </tr>
                        <tr>
                            <td>Ammo Source:</td>
                            <td class="fw-bold">@reloadResult?.AmmoSourceName</td>
                        </tr>
                        <tr>
                            <td>Remaining in Source:</td>
                            <td class="fw-bold">@reloadResult?.AmmoSourceRemaining</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="card-footer d-flex gap-2">
                <button class="btn btn-primary" @onclick="CompleteReload">
                    <i class="bi bi-check"></i> Done
                </button>
                <button class="btn btn-outline-secondary" @onclick="ResetReload">
                    <i class="bi bi-arrow-repeat"></i> Reload Another
                </button>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public GameMechanics.CharacterEdit? Character { get; set; }

    [Parameter]
    public GameMechanics.GamePlay.TableEdit? Table { get; set; }

    [Parameter]
    public List<RangedWeaponInfo>? AvailableWeapons { get; set; }

    [Parameter]
    public List<AmmoSourceInfo>? AvailableMagazines { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    [Parameter]
    public EventCallback<ReloadCompleteData> OnReloadComplete { get; set; }

    // Selection state
    private RangedWeaponInfo? selectedWeapon;
    private AmmoSourceInfo? selectedMagazine;
    private ActionCostType costType = ActionCostType.OneAPOneFat;

    // Result state
    private bool hasReloaded;
    private ReloadResultData? reloadResult;

    private void SelectWeapon(RangedWeaponInfo weapon)
    {
        selectedWeapon = weapon;
        selectedMagazine = null; // Reset magazine selection when weapon changes
    }

    private void SelectMagazine(AmmoSourceInfo mag)
    {
        selectedMagazine = mag;
    }

    private void OnCostTypeChanged(ActionCostType type)
    {
        costType = type;
    }

    /// <summary>
    /// Gets ammo sources that are compatible with the selected weapon's ammo type.
    /// Uses the weapon's AcceptedAmmoType (what it can use) rather than LoadedAmmoType (what's currently loaded).
    /// </summary>
    private IEnumerable<AmmoSourceInfo> GetCompatibleAmmoSources()
    {
        if (AvailableMagazines == null || selectedWeapon == null)
            return Enumerable.Empty<AmmoSourceInfo>();

        var weaponAmmoType = selectedWeapon.AcceptedAmmoType;
        if (string.IsNullOrEmpty(weaponAmmoType))
            return Enumerable.Empty<AmmoSourceInfo>();

        return AvailableMagazines.Where(m => 
            string.Equals(m.AmmoType, weaponAmmoType, StringComparison.OrdinalIgnoreCase) &&
            m.CurrentAmmo > 0);
    }

    private string GetAmmoBadgeClass(RangedWeaponInfo weapon)
    {
        if (weapon.LoadedAmmo >= weapon.Capacity) return "bg-success";
        if (weapon.LoadedAmmo > 0) return "bg-warning";
        return "bg-danger";
    }

    private int GetRoundsToLoad()
    {
        if (selectedWeapon == null || selectedMagazine == null) return 0;

        int spaceInWeapon = selectedWeapon.Capacity - selectedWeapon.LoadedAmmo;
        return Math.Min(spaceInWeapon, selectedMagazine.CurrentAmmo);
    }

    private int GetAmmoAfterReload()
    {
        if (selectedWeapon == null) return 0;
        return selectedWeapon.LoadedAmmo + GetRoundsToLoad();
    }

    private string GetCostDisplay()
    {
        return costType switch
        {
            ActionCostType.OneAPOneFat => "1 AP + 1 FAT",
            ActionCostType.TwoAP => "2 AP",
            _ => "Unknown"
        };
    }

    private bool CanReload()
    {
        if (Character == null || selectedWeapon == null || selectedMagazine == null) return false;
        if (GetRoundsToLoad() <= 0) return false;

        var apNeeded = costType == ActionCostType.TwoAP ? 2 : 1;
        var fatNeeded = costType == ActionCostType.OneAPOneFat ? 1 : 0;

        return Character.ActionPoints.Available >= apNeeded &&
               Character.Fatigue.Value >= fatNeeded &&
               !Character.IsPassedOut;
    }

    private async Task ExecuteReload()
    {
        if (!CanReload() || Character == null || selectedWeapon == null || selectedMagazine == null) return;

        // Check if character is concentrating - prompt before breaking
        var concentrationEffect = Character.GetConcentrationEffect();
        if (concentrationEffect != null)
        {
            var state = ConcentrationState.FromJson(concentrationEffect.BehaviorState);
            if (state != null)
            {
                var confirmed = await ConcentrationBreakDialog.ShowAsync(
                    DialogService,
                    state,
                    concentrationEffect.Name);
                if (!confirmed)
                    return; // User cancelled - don't execute action

                // User confirmed - break concentration before proceeding
                ConcentrationBehavior.BreakConcentration(Character, "Took reload action");
            }
        }

        // Deduct costs
        var apCost = costType == ActionCostType.TwoAP ? 2 : 1;
        var fatCost = costType == ActionCostType.OneAPOneFat ? 1 : 0;

        Character.ActionPoints.Available -= apCost;
        Character.ActionPoints.ActionsTakenThisRound += 1;
        if (fatCost > 0)
            Character.Fatigue.Value -= fatCost;

        // Calculate reload amounts
        int roundsToLoad = GetRoundsToLoad();

        // Store result
        reloadResult = new ReloadResultData
        {
            WeaponName = selectedWeapon.Name,
            RoundsLoaded = roundsToLoad,
            NewAmmoCount = selectedWeapon.LoadedAmmo + roundsToLoad,
            Capacity = selectedWeapon.Capacity,
            AmmoSourceName = selectedMagazine.Name,
            AmmoSourceRemaining = selectedMagazine.CurrentAmmo - roundsToLoad
        };

        hasReloaded = true;

        // Save character state
        if (Character is Csla.Core.ISavable savable)
        {
            await savable.SaveAsync();
        }
    }

    private void ResetReload()
    {
        hasReloaded = false;
        reloadResult = null;
        selectedWeapon = null;
        selectedMagazine = null;
    }

    private async Task CompleteReload()
    {
        if (reloadResult == null || selectedWeapon == null || selectedMagazine == null) return;

        var message = $"{Character?.Name} reloads {reloadResult.WeaponName} with {reloadResult.RoundsLoaded} rounds from {reloadResult.AmmoSourceName} ({reloadResult.NewAmmoCount}/{reloadResult.Capacity})";

        var completeData = new ReloadCompleteData
        {
            Message = message,
            WeaponItemId = selectedWeapon.ItemId,
            AmmoSourceItemId = selectedMagazine.ItemId,
            RoundsLoaded = reloadResult.RoundsLoaded,
            NewWeaponAmmoCount = reloadResult.NewAmmoCount,
            AmmoSourceRemaining = reloadResult.AmmoSourceRemaining
        };

        await OnReloadComplete.InvokeAsync(completeData);
    }

    private class ReloadResultData
    {
        public string WeaponName { get; set; } = "";
        public int RoundsLoaded { get; set; }
        public int NewAmmoCount { get; set; }
        public int Capacity { get; set; }
        public string AmmoSourceName { get; set; } = "";
        public int AmmoSourceRemaining { get; set; }
    }
}
