@using GameMechanics.Combat
@using GameMechanics.Messaging

<div class="targeting-results-panel">
    @if (Resolution == null)
    {
        <div class="alert alert-secondary text-center">
            <i class="bi bi-hourglass-split"></i> Waiting for both parties to confirm...
            <div class="mt-2">
                <span class="badge @(AttackerConfirmed ? "bg-success" : "bg-secondary") me-2">
                    @(AttackerConfirmed ? "Attacker Ready" : "Attacker Pending")
                </span>
                <span class="badge @(DefenderConfirmed ? "bg-success" : "bg-secondary")">
                    @(DefenderConfirmed ? "Defender Ready" : "Defender Pending")
                </span>
            </div>
        </div>
    }
    else
    {
        <div class="card @(Resolution.IsHit ? "border-danger" : "border-success")">
            <div class="card-header @(Resolution.IsHit ? "bg-danger" : "bg-success") text-white">
                <strong>
                    @if (Resolution.IsHit)
                    {
                        <i class="bi bi-bullseye"></i> <text>Hit!</text>
                    }
                    else
                    {
                        <i class="bi bi-shield-check"></i> <text>Miss!</text>
                    }
                </strong>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Attack Roll</h6>
                        <p class="mb-1">
                            <small class="text-muted">@Resolution.AttackBreakdown</small>
                        </p>
                        <p class="mb-0">
                            <strong>AV: @Resolution.AttackerAV</strong>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6>Defense</h6>
                        <p class="mb-1">
                            <small class="text-muted">@Resolution.DefenseBreakdown</small>
                        </p>
                        <p class="mb-0">
                            <strong>TV: @Resolution.DefenderTV</strong>
                        </p>
                    </div>
                </div>

                <hr />

                <div class="text-center">
                    <h4>
                        SV: <span class="@(Resolution.SuccessValue >= 0 ? "text-danger" : "text-success")">@Resolution.SuccessValue</span>
                    </h4>
                </div>

                @if (Resolution.IsHit)
                {
                    <hr />
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Hit Location</h6>
                            <p class="mb-0">
                                <i class="bi bi-geo-alt-fill text-danger"></i>
                                <strong>@Resolution.HitLocation</strong>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6>Damage</h6>
                            <p class="mb-0">
                                <span class="badge bg-warning text-dark">@Resolution.FATDamage FAT</span>
                                <span class="badge bg-danger">@Resolution.VITDamage VIT</span>
                            </p>
                        </div>
                    </div>

                    @if (IsDefender)
                    {
                        <hr />
                        <div class="alert alert-warning mb-0">
                            <strong>@Resolution.DefenderDetails</strong>
                        </div>
                        @if (!DamageAccepted)
                        {
                            <button class="btn btn-danger w-100 mt-2" @onclick="AcceptDamage">
                                <i class="bi bi-check-lg"></i> Accept Damage
                            </button>
                        }
                        else
                        {
                            <div class="alert alert-success mt-2 mb-0">
                                <i class="bi bi-check-circle"></i> Damage accepted
                            </div>
                        }
                    }
                    else
                    {
                        <hr />
                        <div class="alert alert-info mb-0">
                            <strong>@Resolution.AttackerNarrative</strong>
                        </div>
                    }
                }
                else
                {
                    <div class="alert @(IsDefender ? "alert-success" : "alert-secondary") mt-3 mb-0">
                        <strong>@(IsDefender ? "You successfully avoided the attack!" : Resolution.AttackerNarrative)</strong>
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public TargetingResolutionData? Resolution { get; set; }

    [Parameter]
    public bool AttackerConfirmed { get; set; }

    [Parameter]
    public bool DefenderConfirmed { get; set; }

    [Parameter]
    public bool IsDefender { get; set; }

    [Parameter]
    public bool DamageAccepted { get; set; }

    [Parameter]
    public EventCallback OnAcceptDamage { get; set; }

    private async Task AcceptDamage()
    {
        await OnAcceptDamage.InvokeAsync();
    }
}
