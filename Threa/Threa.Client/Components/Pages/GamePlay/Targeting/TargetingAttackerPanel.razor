@using Threa.Client.Components.Shared
@using Threa.Client.Components.Pages.GamePlay
@using GameMechanics.Combat
@using GameMechanics.Messaging
@using GameMechanics

<div class="targeting-attacker-panel">
    <div class="card h-100">
        <div class="card-header bg-danger text-white">
            <strong><i class="bi bi-crosshair"></i> Your Attack</strong>
            <small class="d-block">@AttackerName</small>
        </div>
        <div class="card-body overflow-auto" style="max-height: 400px;">
            <!-- Action Cost Selection -->
            <div class="mb-3">
                <label class="form-label fw-bold">Action Cost</label>
                <ActionCostSelector AP="@MaxAPBoost" 
                                    Fat="@MaxFATBoost" 
                                    IsReadOnly="@IsReadOnly"
                                    OnCostTypeSelected="OnActionCostTypeChanged" />
                <small class="text-muted">Choose how to pay for this attack</small>
            </div>

            <hr />

            @if (ActionType == TargetingActionType.MeleeAttack)
            {
                <!-- Melee Weapon Selection -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Weapon</label>
                    @if (AvailableWeapons?.Count > 1)
                    {
                        <select class="form-select form-select-sm"
                                disabled="@IsReadOnly"
                                value="@selectedWeaponIndex"
                                @onchange="OnWeaponSelectionChanged">
                            @for (int i = 0; i < AvailableWeapons.Count; i++)
                            {
                                var w = AvailableWeapons[i];
                                var idx = i;
                                <option value="@idx">
                                    @w.Name
                                    @if (w.WeaponAVModifier != 0)
                                    {
                                        <text> (AV @(w.WeaponAVModifier >= 0 ? "+" : "")@w.WeaponAVModifier)</text>
                                    }
                                </option>
                            }
                        </select>
                    }
                    else
                    {
                        var displayWeapon = GetSelectedWeapon();
                        var displayName = displayWeapon?.Name ?? InitialData?.WeaponName ?? "Unarmed";
                        var displayAV = displayWeapon?.WeaponAVModifier ?? WeaponAVModifier;
                        <div class="alert alert-info py-2 mb-0">
                            <strong>@displayName</strong>
                            @if (displayAV != 0)
                            {
                                <span class="ms-2 badge @(displayAV >= 0 ? "bg-success" : "bg-danger")">
                                    AV @(displayAV >= 0 ? "+" : "")@displayAV
                                </span>
                            }
                        </div>
                    }
                    <small class="text-muted">Weapon is selected based on equipped items</small>
                </div>
            }

            @if (ActionType == TargetingActionType.RangedAttack)
            {
                <!-- Weapon name + ammo badge -->
                @if (InitialData?.WeaponName != null)
                {
                    <div class="mb-3 d-flex justify-content-between align-items-center">
                        <strong>@InitialData.WeaponName</strong>
                        <span class="badge @(InitialData.CurrentLoadedAmmo > 0 ? "bg-success" : "bg-danger")">
                            @InitialData.CurrentLoadedAmmo ammo
                        </span>
                    </div>
                }

                <!-- Ranged Attack Options -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Range</label>
                    <select class="form-select form-select-sm"
                            disabled="@IsReadOnly"
                            @bind="range" @bind:after="OnDataChanged">
                        <option value="@RangeCategory.Short">Short (TV 6)</option>
                        <option value="@RangeCategory.Medium">Medium (TV 8)</option>
                        <option value="@RangeCategory.Long">Long (TV 10)</option>
                        <option value="@RangeCategory.Extreme">Extreme (TV 12)</option>
                    </select>
                </div>

                @if (ShowFireMode)
                {
                    <div class="mb-3">
                        <label class="form-label fw-bold">Fire Mode</label>
                        <div class="d-flex flex-wrap gap-2">
                            @if (InitialData?.SupportsSingle ?? true)
                            {
                                <button class="btn btn-sm @(fireMode == FireMode.Single ? "btn-warning" : "btn-outline-secondary")"
                                        disabled="@IsReadOnly"
                                        @onclick="() => SetFireMode(FireMode.Single)">
                                    <i class="bi bi-dot"></i> Single
                                    <span class="badge bg-dark">1 round</span>
                                </button>
                            }
                            @if (InitialData?.SupportsBurst ?? false)
                            {
                                <button class="btn btn-sm @(fireMode == FireMode.Burst ? "btn-warning" : "btn-outline-secondary")"
                                        disabled="@IsReadOnly"
                                        @onclick="() => SetFireMode(FireMode.Burst)">
                                    <i class="bi bi-three-dots"></i> Burst
                                    <span class="badge bg-dark">@(InitialData?.BurstSize ?? 3) rounds</span>
                                </button>
                            }
                            @if (InitialData?.SupportsSuppression ?? false)
                            {
                                <button class="btn btn-sm @(fireMode == FireMode.Suppression ? "btn-warning" : "btn-outline-secondary")"
                                        disabled="@IsReadOnly"
                                        @onclick="() => SetFireMode(FireMode.Suppression)">
                                    <i class="bi bi-arrows-angle-expand"></i> Suppression
                                    <span class="badge bg-dark">@(InitialData?.SuppressiveRounds ?? 10) rounds</span>
                                </button>
                            }
                        </div>
                    </div>
                }
            }

            @if (ActionType == TargetingActionType.RangedAttack)
            {
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="attackerMoving"
                               disabled="@IsReadOnly"
                               @bind="isMoving" @bind:after="OnDataChanged">
                        <label class="form-check-label" for="attackerMoving">
                            Moving (-2 AV)
                        </label>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="calledShot"
                               disabled="@IsReadOnly"
                               @bind="isCalledShot" @bind:after="OnDataChanged">
                        <label class="form-check-label" for="calledShot">
                            Called Shot (-2 AV)
                        </label>
                    </div>
                    @if (isCalledShot)
                    {
                        <select class="form-select form-select-sm mt-2"
                                disabled="@IsReadOnly"
                                @bind="calledShotLocation" @bind:after="OnDataChanged">
                            <option value="@HitLocation.Head">Head</option>
                            <option value="@HitLocation.Torso">Torso</option>
                            <option value="@HitLocation.LeftArm">Left Arm</option>
                            <option value="@HitLocation.RightArm">Right Arm</option>
                            <option value="@HitLocation.LeftLeg">Left Leg</option>
                            <option value="@HitLocation.RightLeg">Right Leg</option>
                        </select>
                        <small class="text-info">
                            <i class="bi bi-info-circle"></i> SV 2+ hits target location; SV 0-1 hits random
                        </small>
                    }
                </div>
            }

            @if (ActionType != TargetingActionType.Medical)
            {
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="usePhysicality" 
                               disabled="@IsReadOnly"
                               @bind="usePhysicality" @bind:after="OnDataChanged">
                        <label class="form-check-label" for="usePhysicality">
                            Use Physicality Bonus
                        </label>
                    </div>
                </div>
            }

            <hr />

            <div class="mb-3">
                <label class="form-label fw-bold">Boost (Optional)</label>
                <BoostSelector AvailableAP="@GetAvailableAPForBoost()"
                               AvailableFAT="@GetAvailableFATForBoost()"
                               CostType="@actionCostType"
                               IsReadOnly="@IsReadOnly"
                               OnBoostChanged="OnBoostChanged"
                               OnBoostCostChanged="OnBoostCostChanged" />
            </div>
        </div>
        <div class="card-footer">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <span>Skill (@GetEffectiveSkillName()):</span>
                <strong>@GetEffectiveSkillAS()</strong>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span>Weapon/Boost modifier:</span>
                <strong class="@(GetTotalAVModifier() >= 0 ? "text-success" : "text-danger")">
                    @(GetTotalAVModifier() >= 0 ? "+" : "")@GetTotalAVModifier()
                </strong>
            </div>
            <button class="btn @(IsConfirmed ? "btn-success" : "btn-danger") w-100"
                    @onclick="ToggleConfirm"
                    disabled="@IsReadOnly">
                @if (IsConfirmed)
                {
                    <i class="bi bi-check-circle"></i> <text>Confirmed - Click to Edit</text>
                }
                else
                {
                    <i class="bi bi-lock"></i> <text>Confirm Attack Settings</text>
                }
            </button>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public string AttackerName { get; set; } = string.Empty;

    [Parameter]
    public TargetingActionType ActionType { get; set; }

    [Parameter]
    public int BaseSkillAS { get; set; }

    [Parameter]
    public int WeaponAVModifier { get; set; }

    [Parameter]
    public bool ShowFireMode { get; set; }

    [Parameter]
    public int MaxAPBoost { get; set; }

    [Parameter]
    public int MaxFATBoost { get; set; }

    [Parameter]
    public bool IsConfirmed { get; set; }

    [Parameter]
    public bool IsReadOnly { get; set; }

    [Parameter]
    public TargetingAttackerData? InitialData { get; set; }

    [Parameter]
    public List<MeleeWeaponInfo>? AvailableWeapons { get; set; }

    [Parameter]
    public EventCallback<TargetingAttackerData> OnDataUpdated { get; set; }

    [Parameter]
    public EventCallback<bool> OnConfirmChanged { get; set; }

    // Local state
    private bool isMoving;
    private bool isCalledShot;
    private HitLocation calledShotLocation = HitLocation.Torso;
    private bool usePhysicality = true;
    private int apBoost;
    private int fatBoost;
    private int attackAVBoost;
    private RangeCategory range = RangeCategory.Medium;
    private FireMode fireMode = FireMode.Single;
    private ActionCostType actionCostType = ActionCostType.OneAPOneFat;
    private int selectedWeaponIndex;

    protected override void OnParametersSet()
    {
        if (InitialData != null)
        {
            isMoving = InitialData.IsMoving;
            isCalledShot = InitialData.IsCalledShot;
            calledShotLocation = InitialData.CalledShotLocation ?? HitLocation.Torso;
            usePhysicality = InitialData.UsePhysicality;
            apBoost = InitialData.APBoost;
            fatBoost = InitialData.FATBoost;
            range = InitialData.Range ?? RangeCategory.Medium;
            // Auto-select fire mode based on weapon capabilities when not yet set
            if (InitialData.FireMode.HasValue)
            {
                fireMode = InitialData.FireMode.Value;
            }
            else
            {
                if (InitialData.SupportsSingle) fireMode = FireMode.Single;
                else if (InitialData.SupportsBurst) fireMode = FireMode.Burst;
                else if (InitialData.SupportsSuppression) fireMode = FireMode.Suppression;
                else fireMode = FireMode.Single;
            }
            actionCostType = InitialData.ActionCostType;

            // Weapons are embedded in InitialData by CombatContent.BuildAttackerData â€”
            // prefer that over the separately-threaded parameter so the targeting
            // panel works identically to the anonymous-attack AttackMode.
            // Only override if InitialData has actual weapons (not empty list).
            if (InitialData.AvailableWeapons?.Count > 0)
                AvailableWeapons = InitialData.AvailableWeapons;

            if (AvailableWeapons != null && InitialData.WeaponName != null)
            {
                var idx = AvailableWeapons.FindIndex(w => w.Name == InitialData.WeaponName);
                selectedWeaponIndex = idx >= 0 ? idx : 0;
            }
        }
    }

    private MeleeWeaponInfo? GetSelectedWeapon() =>
        AvailableWeapons?.Count > 0 ? AvailableWeapons[selectedWeaponIndex] : null;

    private string GetEffectiveSkillName()
    {
        var w = GetSelectedWeapon();
        if (w?.SkillName is { Length: > 0 } wSkill) return wSkill;
        return InitialData?.SkillName ?? "Attack";
    }

    private int GetEffectiveSkillAS()
    {
        var w = GetSelectedWeapon();
        if (w?.SkillAS > 0) return w.SkillAS;
        return BaseSkillAS;
    }

    private async Task OnWeaponSelectionChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var idx))
        {
            selectedWeaponIndex = idx;
            await OnDataChanged();
        }
    }

    private int GetAvailableAPForBoost()
    {
        var baseCost = actionCostType == ActionCostType.TwoAP ? 2 : 1;
        return Math.Max(0, MaxAPBoost - baseCost);
    }

    private int GetAvailableFATForBoost()
    {
        var baseCost = actionCostType == ActionCostType.OneAPOneFat ? 1 : 0;
        return Math.Max(0, MaxFATBoost - baseCost);
    }

    private async Task OnActionCostTypeChanged(ActionCostType type)
    {
        actionCostType = type;
        // Reset boost when cost type changes
        attackAVBoost = 0;
        apBoost = 0;
        fatBoost = 0;
        await OnDataChanged();
    }

    private async Task OnBoostChanged(int totalBoost)
    {
        attackAVBoost = totalBoost;
        await OnDataChanged();
    }

    private async Task OnBoostCostChanged((int Boost, int APCost, int FATCost) cost)
    {
        attackAVBoost = cost.Boost;
        apBoost = cost.APCost;
        fatBoost = cost.FATCost;
        await OnDataChanged();
    }

    private int GetTotalAVModifier()
    {
        var selectedWeapon = GetSelectedWeapon();
        int modifier = (selectedWeapon?.WeaponAVModifier ?? WeaponAVModifier) + attackAVBoost;
        if (isMoving) modifier -= 2;
        if (isCalledShot) modifier -= 2;
        return modifier;
    }

    private async Task OnDataChanged()
    {
        if (IsReadOnly) return;

        var data = BuildAttackerData();
        await OnDataUpdated.InvokeAsync(data);
    }

    private async Task ToggleConfirm()
    {
        if (IsReadOnly) return;
        await OnConfirmChanged.InvokeAsync(!IsConfirmed);
    }

    private TargetingAttackerData BuildAttackerData()
    {
        var selectedWeapon = GetSelectedWeapon();
        // Use the selected weapon's skill info if available; otherwise fall back to initial data.
        var skillName = selectedWeapon?.SkillName is { Length: > 0 } wSkill
            ? wSkill
            : InitialData?.SkillName ?? "";
        var skillAS = selectedWeapon?.SkillAS > 0
            ? selectedWeapon.SkillAS
            : BaseSkillAS;
        return new TargetingAttackerData
        {
            ActionType = ActionType,
            SkillId = InitialData?.SkillId ?? "",
            SkillName = skillName,
            SkillAS = skillAS,
            WeaponAVModifier = selectedWeapon?.WeaponAVModifier ?? WeaponAVModifier,
            WeaponSVModifier = selectedWeapon?.WeaponSVModifier ?? InitialData?.WeaponSVModifier ?? 0,
            WeaponDamageClass = selectedWeapon?.WeaponDamageClass ?? InitialData?.WeaponDamageClass ?? 1,
            WeaponName = selectedWeapon?.Name ?? InitialData?.WeaponName,
            WeaponTemplateId = selectedWeapon?.TemplateId ?? InitialData?.WeaponTemplateId ?? 0,
            WeaponDamageModifiers = selectedWeapon?.WeaponDamageModifiers ?? InitialData?.WeaponDamageModifiers,
            DamageType = InitialData?.DamageType ?? DamageType.Bashing,
            AttackerCharacterId = InitialData?.AttackerCharacterId ?? 0,
            IsDodgeable = InitialData?.IsDodgeable ?? false,
            CurrentLoadedAmmo = InitialData?.CurrentLoadedAmmo ?? 0,
            AmmoDamageModifier = InitialData?.AmmoDamageModifier ?? 0,
            AmmoSpecialEffect = InitialData?.AmmoSpecialEffect,
            IsMoving = isMoving,
            ActionCostType = actionCostType,
            APBoost = apBoost,
            FATBoost = fatBoost,
            IsCalledShot = isCalledShot,
            CalledShotLocation = isCalledShot ? calledShotLocation : null,
            UsePhysicality = usePhysicality,
            Range = ActionType == TargetingActionType.RangedAttack ? range : null,
            FireMode = ActionType == TargetingActionType.RangedAttack ? fireMode : null,
            AvailableWeapons = InitialData?.AvailableWeapons,
            WeaponItemId = InitialData?.WeaponItemId ?? Guid.Empty,
            SupportsSingle = InitialData?.SupportsSingle ?? true,
            SupportsBurst = InitialData?.SupportsBurst ?? false,
            SupportsSuppression = InitialData?.SupportsSuppression ?? false
        };
    }

    private async Task SetFireMode(FireMode mode)
    {
        fireMode = mode;
        await OnDataChanged();
    }
}
