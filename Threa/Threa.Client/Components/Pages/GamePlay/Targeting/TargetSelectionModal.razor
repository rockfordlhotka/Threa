@using GameMechanics.GamePlay
@using GameMechanics.Messaging

<div class="target-selection-modal">
    <div class="modal-header">
        <h5 class="modal-title">
            <i class="bi bi-crosshair text-danger"></i>
            Select Target for @ActionTypeName
        </h5>
    </div>
    <div class="modal-body">
        @if (AvailableTargets == null || !AvailableTargets.Any())
        {
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i> No valid targets available at this table.
            </div>
        }
        else
        {
            <div class="list-group">
                @foreach (var target in AvailableTargets)
                {
                    <button type="button"
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-center @(selectedTargetId == target.CharacterId ? "active" : "")"
                            @onclick="() => SelectTarget(target)">
                        <div>
                            <strong>@target.CharacterName</strong>
                            @if (!string.IsNullOrEmpty(target.PlayerName))
                            {
                                <small class="text-muted d-block">(@target.PlayerName)</small>
                            }
                        </div>
                        <span class="badge @(target.IsNPC ? "bg-secondary" : "bg-primary")">
                            @(target.IsNPC ? "NPC" : "PC")
                        </span>
                    </button>
                }
            </div>
        }
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" @onclick="Cancel">
            <i class="bi bi-x-lg"></i> Cancel
        </button>
        <button type="button" class="btn btn-danger" @onclick="Confirm" disabled="@(selectedTargetId == 0)">
            <i class="bi bi-crosshair"></i> Target Selected
        </button>
    </div>
</div>

@code {
    [Parameter]
    public TargetingActionType ActionType { get; set; }

    [Parameter]
    public IEnumerable<TargetInfo>? AvailableTargets { get; set; }

    [Parameter]
    public int ExcludeCharacterId { get; set; }

    [Parameter]
    public EventCallback<TargetInfo> OnTargetSelected { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    private int selectedTargetId;
    private TargetInfo? selectedTarget;

    private string ActionTypeName => ActionType switch
    {
        TargetingActionType.MeleeAttack => "Melee Attack",
        TargetingActionType.RangedAttack => "Ranged Attack",
        TargetingActionType.Medical => "Medical Action",
        _ => "Action"
    };

    private void SelectTarget(TargetInfo target)
    {
        selectedTargetId = target.CharacterId;
        selectedTarget = target;
    }

    private async Task Confirm()
    {
        if (selectedTarget != null)
        {
            await OnTargetSelected.InvokeAsync(selectedTarget);
        }
    }

    private async Task Cancel()
    {
        await OnCancel.InvokeAsync();
    }

    public class TargetInfo
    {
        public int CharacterId { get; init; }
        public string CharacterName { get; init; } = string.Empty;
        public string? PlayerName { get; init; }
        public bool IsNPC { get; init; }
    }
}
