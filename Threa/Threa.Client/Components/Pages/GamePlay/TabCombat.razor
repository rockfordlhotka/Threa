@using GameMechanics
@using GameMechanics.GamePlay
@using GameMechanics.Messaging
@using GameMechanics.Combat
@using Threa.Dal
@using Threa.Client.Components.Shared
@using Threa.Client.Components.Pages.GamePlay
@using Threa.Client.Components.Pages.GamePlay.Targeting

@inject ICharacterItemDal CharacterItemDal
@inject IItemTemplateDal ItemTemplateDal
@inject IActivityLogService ActivityLog

<CombatContent @ref="combatContentRef"
               Character="Character"
               Table="Table"
               AvailableTargets="AvailableTargets"
               ActivityEntries="ActivityEntries"
               GetActivityCssClass="GetActivityCssClass"
               CharacterItemDal="CharacterItemDal"
               ItemTemplateDal="ItemTemplateDal"
               ActivityLog="ActivityLog"
               OnCharacterChanged="OnCharacterChanged"
               OnInitiateTargeting="OnInitiateTargeting" />

@code {
    [Parameter]
    public CharacterEdit? Character { get; set; }

    [Parameter]
    public TableEdit? Table { get; set; }

    [Parameter]
    public EventCallback OnCharacterChanged { get; set; }

    [Parameter]
    public List<TargetSelectionModal.TargetInfo>? AvailableTargets { get; set; }

    [Parameter]
    public EventCallback<(TargetingActionType ActionType, int TargetId, string TargetName, TargetingAttackerData AttackerData, List<MeleeWeaponInfo>? AvailableWeapons)> OnInitiateTargeting { get; set; }

    /// <summary>
    /// Activity log entries to display in the combat tab's activity feed.
    /// Uses Play.razor's public ActivityLogEntry record type.
    /// </summary>
    [Parameter]
    public List<Play.ActivityLogEntry>? ActivityEntries { get; set; }

    /// <summary>
    /// CSS class resolver for activity log entry categories.
    /// </summary>
    [Parameter]
    public Func<ActivityCategory, string>? GetActivityCssClass { get; set; }

    private CombatContent? combatContentRef;

    /// <summary>
    /// Returns true when a non-default combat mode is active in the combat content.
    /// </summary>
    public bool IsInNonDefaultMode => combatContentRef?.IsInNonDefaultMode ?? false;

    /// <summary>
    /// Resets combat mode to Default. Called by Play.razor when the browser back button
    /// is pressed while a combat mode is active.
    /// </summary>
    public void ResetCombatMode() => combatContentRef?.ResetToDefault();
}
