@* Skills Tab for gameplay - XP advancement and skill management *@

@using Threa.Client.Components.Shared
@using Threa.Dal.Dto
@using Radzen
@inject DialogService DialogService
@inject IDataPortal<GameMechanics.Reference.SkillList> skillListPortal
@inject IChildDataPortal<GameMechanics.SkillEdit> skillPortal

<div class="alert alert-info mb-3">
    <p class="mb-2">
        <strong><i class="bi bi-star-fill me-2"></i>Skill Advancement</strong>
    </p>
    <p class="mb-1">
        Spend XP to increase your skill levels. You can pay either the <strong>trained</strong> cost (if you've had training) 
        or the <strong>untrained</strong> cost (learning on your own).
    </p>
    <p class="mb-0">
        <strong>Available XP:</strong> <span class="badge bg-primary fs-6">@(Character?.XPBanked ?? 0)</span>
    </p>
</div>

@if (errorMessage != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @errorMessage
        <button type="button" class="btn-close" @onclick="() => errorMessage = null" aria-label="Close"></button>
    </div>
}

<div class="card mb-3">
    <div class="card-header">
        <strong><i class="bi bi-list-check me-2"></i>Current Skills</strong>
    </div>
    <div class="card-body">
        @if (Character?.Skills == null || !Character.Skills.Any())
        {
            <p class="text-muted">No skills available.</p>
        }
        else
        {
            <div class="input-group mb-3">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control" placeholder="Search skills..."
                       @bind="searchFilter" @bind:event="oninput" />
            </div>

            <table class="table table-sm table-hover">
                <thead>
                    <tr>
                        <th>Skill Name</th>
                        <th>Primary Attribute</th>
                        <th>Level</th>
                        <th>Bonus</th>
                        <th>Ability Score</th>
                        <th>XP Cost (Next Level)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var skill in FilteredSkills())
                    {
                        var skillInfo = GetSkillInfo(skill);
                        var skillDescription = GetSkillDescription(skill);
                        var trainedCost = skill.Level < 10 ? GetXPCostToNextLevel(skill, trained: true) : 0;
                        var untrainedCost = skill.Level < 10 ? GetXPCostToNextLevel(skill, trained: false) : 0;
                        var isNewSkill = IsNewSkill(skill);
                        var chipBonus = Character!.GetChipSkillLevelBonus(skill.Name, skill.Bonus);
                        <tr title="@skillDescription">
                            <td>@skill.Name</td>
                            <td>@skill.PrimaryAttribute</td>
                            <td>
                                @skill.Level
                                @if (chipBonus > 0)
                                {
                                    <span class="badge bg-info ms-1" title="Chip raises effective level by @chipBonus">chip +@chipBonus</span>
                                }
                            </td>
                            <td>@skill.Bonus</td>
                            <td><strong>@skill.AbilityScore</strong></td>
                            <td>
                                @if (skill.Level < 10)
                                {
                                    <span class="text-success" title="Trained cost">@trainedCost</span>
                                    <span class="text-muted mx-1">/</span>
                                    <span class="text-warning" title="Untrained cost">@untrainedCost</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">MAX</span>
                                }
                            </td>
                            <td>
                                @if (skill.Level < 10)
                                {
                                    <div class="btn-group btn-group-sm" role="group">
                                        @if (Character!.XPBanked >= trainedCost)
                                        {
                                            <button class="btn btn-outline-success"
                                                    title="Level up using trained cost"
                                                    @onclick="() => IncreaseSkillLevel(skill, trained: true)">
                                                <i class="bi bi-arrow-up-circle"></i> @trainedCost
                                            </button>
                                        }
                                        @if (Character!.XPBanked >= untrainedCost)
                                        {
                                            <button class="btn btn-outline-warning"
                                                    title="Level up using untrained cost"
                                                    @onclick="() => IncreaseSkillLevel(skill, trained: false)">
                                                <i class="bi bi-arrow-up-circle"></i> @untrainedCost
                                            </button>
                                        }
                                    </div>
                                }
                                @if (isNewSkill && CanRemoveSkill(skill))
                                {
                                    <button class="btn btn-sm btn-outline-danger ms-2"
                                            title="Remove this newly added skill"
                                            @onclick="() => RemoveSkill(skill)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>

@{
    var chipOnlySkills = Character?.GetChipGrantedSkills()
        .Where(g => !(Character.Skills?.Any(s => s.Name.Equals(g.SkillName, StringComparison.OrdinalIgnoreCase)) ?? false))
        .ToList();
}
@if (chipOnlySkills != null && chipOnlySkills.Count > 0)
{
    <div class="card mb-3">
        <div class="card-header" style="background: var(--bs-info); color: white;">
            <strong><i class="bi bi-cpu me-2"></i>Chip Skills</strong>
            <span class="badge bg-white text-dark ms-2">@chipOnlySkills.Count</span>
        </div>
        <div class="card-body">
            <p class="text-muted small mb-2">Skills granted by loaded skill chips. Only active while the chip is in an equipped Skillwire.</p>
            <table class="table table-sm table-hover">
                <thead>
                    <tr>
                        <th>Skill</th>
                        <th>Source</th>
                        <th>Attr</th>
                        <th>Chip Level</th>
                        <th>Ability Score</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var granted in chipOnlySkills.OrderBy(g => g.SkillName))
                    {
                        var chipAS = GameMechanics.SkillEdit.GetAttributeBase(Character!, granted.PrimaryAttribute) + granted.SkillLevel;
                        <tr>
                            <td>@granted.SkillName</td>
                            <td><span class="badge bg-info">@granted.ChipName</span></td>
                            <td>@granted.PrimaryAttribute</td>
                            <td>@granted.SkillLevel</td>
                            <td><strong>@chipAS</strong></td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

<div class="card">
    <div class="card-header">
        <strong><i class="bi bi-plus-circle me-2"></i>Add New Skill</strong>
    </div>
    <div class="card-body">
        <p class="text-muted mb-3">
            Add new skills to your character. New skills start at level 0 and can be leveled up using XP.
        </p>
        <button class="btn btn-primary" 
                @onclick="OpenSkillPickerAsync" 
                disabled="@(allSkills == null)">
            <i class="bi bi-plus-circle me-1"></i> Add Skills...
        </button>
    </div>
</div>

@code {
    [Parameter]
    public GameMechanics.CharacterEdit? Character { get; set; }

    [Parameter]
    public GameMechanics.GamePlay.TableEdit? Table { get; set; }

    [Parameter]
    public EventCallback OnCharacterChanged { get; set; }

    private string searchFilter = "";
    private string? errorMessage;
    private GameMechanics.Reference.SkillList? allSkills;

    // Track which skills were newly added in this session (to allow removal)
    private HashSet<string> newlyAddedSkills = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            allSkills = await skillListPortal.FetchAsync();
        }
        catch (Exception)
        {
            // If we can't load skill list, descriptions will just be empty in tooltips
            allSkills = null;
        }
    }

    private string? GetSkillDescription(GameMechanics.SkillEdit skill)
    {
        var skillInfo = GetSkillInfo(skill);
        return skillInfo?.Description;
    }

    private GameMechanics.Reference.SkillInfo? GetSkillInfo(GameMechanics.SkillEdit skill)
    {
        return allSkills?.FirstOrDefault(s => s.Name == skill.Name);
    }

    private IEnumerable<GameMechanics.SkillEdit> FilteredSkills()
    {
        if (Character?.Skills == null) return Enumerable.Empty<GameMechanics.SkillEdit>();

        var skills = Character.Skills.AsEnumerable()
            // Filter out magic skills (shown in Magic tab)
            .Where(s => !s.IsSpell && !s.IsManaSkill);

        if (!string.IsNullOrWhiteSpace(searchFilter))
        {
            skills = skills.Where(s => s.Name.Contains(searchFilter, StringComparison.OrdinalIgnoreCase));
        }
        return skills.OrderBy(s => s.Name);
    }

    private int GetXPCostToNextLevel(GameMechanics.SkillEdit skill, bool trained)
    {
        var skillInfo = GetSkillInfo(skill);
        if (skillInfo == null)
        {
            // Default to difficulty 5 if not found
            return GameMechanics.SkillCost.GetLevelUpCost(skill.Level, 5);
        }

        var difficulty = trained ? skillInfo.Trained : skillInfo.Untrained;
        return GameMechanics.SkillCost.GetLevelUpCost(skill.Level, difficulty);
    }

    private bool IsNewSkill(GameMechanics.SkillEdit skill)
    {
        // A skill is "new" if it was added in this session
        return newlyAddedSkills.Contains(skill.Name);
    }

    private bool CanRemoveSkill(GameMechanics.SkillEdit skill)
    {
        // Can only remove skills that were added in this session
        return newlyAddedSkills.Contains(skill.Name);
    }

    private void IncreaseSkillLevel(GameMechanics.SkillEdit skill, bool trained)
    {
        errorMessage = null;

        if (skill.Level >= 10)
        {
            errorMessage = "Skill is already at maximum level.";
            return;
        }

        var xpCost = GetXPCostToNextLevel(skill, trained);

        if (Character!.XPBanked < xpCost)
        {
            errorMessage = $"Not enough XP. Need {xpCost} XP but only have {Character.XPBanked} XP.";
            return;
        }

        // Spend XP and increase level
        Character.SpendXP(xpCost);
        skill.Level++;
        skill.XPSpent += xpCost;

        _ = OnCharacterChanged.InvokeAsync();
        StateHasChanged();
    }

    private async Task OpenSkillPickerAsync()
    {
        errorMessage = null;

        if (Character?.Skills == null) return;

        // Get existing skill names to exclude from picker
        var existingSkillNames = Character.Skills.Select(s => s.Name).ToHashSet();

        var result = await DialogService.OpenAsync<SkillMultiPickerModal>(
            "Add Skills",
            new Dictionary<string, object>
            {
                { "ExistingSkillNames", existingSkillNames },
                { "ExcludeMagicSkills", false } // Allow all skills in play mode
            },
            new DialogOptions { Width = "600px", Height = "600px", CloseDialogOnOverlayClick = false });

        if (result is List<string> selectedSkillIdentifiers && selectedSkillIdentifiers.Count > 0)
        {
            try
            {
                foreach (var skillIdentifier in selectedSkillIdentifiers)
                {
                    await Character.Skills.AddSkillAsync(skillIdentifier, skillListPortal, skillPortal);
                    
                    // Track this as a newly added skill
                    var skillName = skillIdentifier.Split(':').Last();
                    newlyAddedSkills.Add(skillName);
                }
                
                await OnCharacterChanged.InvokeAsync();
                StateHasChanged();
            }
            catch (Exception ex)
            {
                errorMessage = $"Error adding skills: {ex.Message}";
            }
        }
    }

    private void RemoveSkill(GameMechanics.SkillEdit skill)
    {
        errorMessage = null;

        if (!CanRemoveSkill(skill))
        {
            errorMessage = "Can only remove skills that were added in this session.";
            return;
        }

        // Refund all XP spent on this skill
        if (skill.XPSpent > 0)
        {
            Character!.RefundXP(skill.XPSpent);
        }

        // Remove from tracking
        newlyAddedSkills.Remove(skill.Name);

        // Remove the skill
        Character!.Skills.Remove(skill);

        _ = OnCharacterChanged.InvokeAsync();
        StateHasChanged();
    }
}
