@using GameMechanics.Effects.Behaviors
@using Threa.Dal.Dto
@using Threa.Client.Components.Shared

@inject Radzen.DialogService DialogService

<div class="anonymous-action-mode">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0"><i class="bi bi-dice-5 text-primary"></i> Anonymous Action</h4>
        <button class="btn btn-outline-secondary btn-sm" @onclick="OnCancel">
            <i class="bi bi-x-lg"></i> Cancel
        </button>
    </div>

    @if (!hasRolled)
    {
        <!-- Setup Phase -->
        <div class="row">
            <div class="col-md-6">
                <!-- 1. Attribute Selection -->
                <div class="card mb-3">
                    <div class="card-header">
                        <strong>1. Select Attribute</strong>
                    </div>
                    <div class="card-body">
                        <select class="form-select" @bind="selectedAttribute">
                            <option value="">-- Select Attribute --</option>
                            @foreach (var attr in AttributeNames)
                            {
                                <option value="@attr">@AttributeDisplayNames[attr]</option>
                            }
                        </select>
                        @if (!string.IsNullOrEmpty(selectedAttribute))
                        {
                            <div class="mt-2 small text-muted">
                                Effective Value: <strong>@GetSelectedAttributeValue()</strong>
                            </div>
                        }
                    </div>
                </div>

                <!-- 2. Action Cost -->
                <div class="card mb-3">
                    <div class="card-header">
                        <strong>2. Action Cost</strong>
                    </div>
                    <div class="card-body">
                        <ActionCostSelector AP="@(Character?.ActionPoints.Available ?? 0)"
                                            Fat="@(Character?.Fatigue.Value ?? 0)"
                                            OnCostTypeSelected="OnCostTypeChanged" />
                    </div>
                </div>

                <!-- 3. Target Value -->
                <div class="card mb-3">
                    <div class="card-header">
                        <strong>3. Target Value</strong>
                    </div>
                    <div class="card-body">
                        <input type="number" class="form-control" @bind="targetValue" min="1"
                               placeholder="Enter TV" />
                    </div>
                </div>

                <!-- 4. Boost -->
                <div class="card mb-3">
                    <div class="card-header">
                        <strong>4. Boost (Optional)</strong>
                    </div>
                    <div class="card-body">
                        <BoostSelector AvailableAP="@GetAvailableAPForBoost()"
                                       AvailableFAT="@GetAvailableFATForBoost()"
                                       CostType="@costType"
                                       OnBoostChanged="OnBoostChanged"
                                       OnBoostCostChanged="OnBoostCostChanged" />
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <!-- Summary Card -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <strong><i class="bi bi-info-circle"></i> Action Summary</strong>
                    </div>
                    <div class="card-body">
                        @if (!string.IsNullOrEmpty(selectedAttribute) && targetValue > 0)
                        {
                            <table class="table table-sm mb-0">
                                <tbody>
                                    <tr>
                                        <td>Attribute:</td>
                                        <td class="fw-bold">@AttributeDisplayNames[selectedAttribute]</td>
                                    </tr>
                                    <tr>
                                        <td>Attribute Value:</td>
                                        <td class="fw-bold">@GetSelectedAttributeValue()</td>
                                    </tr>
                                    <tr>
                                        <td>Target Value:</td>
                                        <td class="fw-bold">@targetValue</td>
                                    </tr>
                                    <tr>
                                        <td colspan="2"><hr class="my-1" /></td>
                                    </tr>
                                    <tr>
                                        <td>Cost:</td>
                                        <td>@GetCostDisplay()</td>
                                    </tr>
                                    @if (boostValue > 0)
                                    {
                                        <tr>
                                            <td>Boost:</td>
                                            <td class="text-success fw-bold">+@boostValue</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                        else
                        {
                            <p class="text-muted mb-0">Select an attribute and enter a target value to see action details.</p>
                        }
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-primary btn-lg w-100"
                                @onclick="ExecuteAction"
                                disabled="@(!CanRoll())">
                            <i class="bi bi-dice-5"></i> Roll Check
                        </button>
                    </div>
                </div>

                <!-- Resource Summary -->
                <div class="card mt-3">
                    <div class="card-body py-2">
                        <div class="row text-center">
                            <div class="col-4">
                                <small class="text-muted">AP</small>
                                <div class="fw-bold @(Character?.ActionPoints.Available <= 0 ? "text-danger" : "")">
                                    @Character?.ActionPoints.Available / @Character?.ActionPoints.Max
                                </div>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">FAT</small>
                                <div class="fw-bold @(Character?.Fatigue.Value <= 0 ? "text-danger" : "")">
                                    @Character?.Fatigue.Value / @Character?.Fatigue.BaseValue
                                </div>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">VIT</small>
                                <div class="fw-bold">
                                    @Character?.Vitality.Value / @Character?.Vitality.BaseValue
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Result Phase -->
        <div class="card">
            <div class="card-header @(resultSV >= 0 ? "bg-success" : "bg-danger") text-white">
                <strong>
                    <i class="bi @(resultSV >= 0 ? "bi-check-circle" : "bi-x-circle")"></i>
                    @(resultSV >= 0 ? "Success!" : "Failure")
                </strong>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tbody>
                        <tr>
                            <td>Attribute:</td>
                            <td class="fw-bold">@AttributeDisplayNames[selectedAttribute]</td>
                        </tr>
                        <tr>
                            <td>Attribute Value:</td>
                            <td class="fw-bold">@resultAttributeValue</td>
                        </tr>
                        @if (boostValue > 0)
                        {
                            <tr>
                                <td>Boost:</td>
                                <td class="fw-bold text-success">+@boostValue</td>
                            </tr>
                        }
                        @if (resultWoundPenalty > 0)
                        {
                            <tr>
                                <td>Wounds:</td>
                                <td class="fw-bold text-danger">-@resultWoundPenalty</td>
                            </tr>
                        }
                        @if (resultMultiActionPenalty > 0)
                        {
                            <tr>
                                <td>Multi-Action Penalty:</td>
                                <td class="fw-bold text-danger">-@resultMultiActionPenalty</td>
                            </tr>
                        }
                        <tr>
                            <td>Effective Value:</td>
                            <td class="fw-bold">@resultEffectiveValue</td>
                        </tr>
                        <tr>
                            <td colspan="2"><hr class="my-1" /></td>
                        </tr>
                        <tr>
                            <td>Dice Roll:</td>
                            <td class="fw-bold @(resultDiceRoll >= 0 ? "text-success" : "text-danger")">
                                @(resultDiceRoll >= 0 ? "+" : "")@resultDiceRoll
                            </td>
                        </tr>
                        <tr>
                            <td>Total Roll:</td>
                            <td class="fw-bold">@resultTotalRoll</td>
                        </tr>
                        <tr>
                            <td>Target Value:</td>
                            <td class="fw-bold">@targetValue</td>
                        </tr>
                        <tr>
                            <td colspan="2"><hr class="my-1" /></td>
                        </tr>
                        <tr>
                            <td>Success Value:</td>
                            <td class="fw-bold @(resultSV >= 0 ? "text-success" : "text-danger")">
                                @(resultSV >= 0 ? "+" : "")@resultSV
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="card-footer">
                <button class="btn btn-outline-secondary" @onclick="Complete">
                    <i class="bi bi-check-lg"></i> Done
                </button>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public GameMechanics.CharacterEdit? Character { get; set; }

    [Parameter]
    public GameMechanics.GamePlay.TableEdit? Table { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    [Parameter]
    public EventCallback<string> OnActionComplete { get; set; }

    // Attribute data
    private static readonly string[] AttributeNames = { "STR", "DEX", "END", "INT", "ITT", "WIL", "PHY" };
    private static readonly Dictionary<string, string> AttributeDisplayNames = new()
    {
        { "STR", "Physicality (STR)" },
        { "DEX", "Dodge (DEX)" },
        { "END", "Drive (END)" },
        { "INT", "Reasoning (INT)" },
        { "ITT", "Awareness (ITT)" },
        { "WIL", "Focus (WIL)" },
        { "PHY", "Influence (PHY)" }
    };

    // Setup state
    private string selectedAttribute = "";
    private int targetValue;
    private ActionCostType costType = ActionCostType.OneAPOneFat;
    private int boostValue;
    private int boostAPCost;
    private int boostFATCost;

    // Roll state
    private bool hasRolled;
    private int resultAttributeValue;
    private int resultEffectiveValue;
    private int resultDiceRoll;
    private int resultTotalRoll;
    private int resultSV;
    private int resultWoundPenalty;
    private int resultMultiActionPenalty;

    private int GetSelectedAttributeValue()
    {
        if (Character == null || string.IsNullOrEmpty(selectedAttribute)) return 0;
        return Character.GetEffectiveAttribute(selectedAttribute);
    }

    private void OnCostTypeChanged(ActionCostType type)
    {
        costType = type;
    }

    private void OnBoostChanged(int totalBoost)
    {
        boostValue = totalBoost;
    }

    private void OnBoostCostChanged((int Boost, int APCost, int FATCost) cost)
    {
        boostValue = cost.Boost;
        boostAPCost = cost.APCost;
        boostFATCost = cost.FATCost;
    }

    private int GetAvailableAPForBoost()
    {
        var baseCost = costType == ActionCostType.TwoAP ? 2 : 1;
        return Math.Max(0, (Character?.ActionPoints.Available ?? 0) - baseCost);
    }

    private int GetAvailableFATForBoost()
    {
        var baseCost = costType == ActionCostType.OneAPOneFat ? 1 : 0;
        return Math.Max(0, (Character?.Fatigue.Value ?? 0) - baseCost);
    }

    private string GetCostDisplay()
    {
        return costType switch
        {
            ActionCostType.OneAPOneFat => "1 AP + 1 FAT",
            ActionCostType.TwoAP => "2 AP",
            _ => "Unknown"
        };
    }

    private bool CanRoll()
    {
        if (Character == null || Character.IsPassedOut) return false;
        if (string.IsNullOrEmpty(selectedAttribute)) return false;
        if (targetValue <= 0) return false;

        var apNeeded = (costType == ActionCostType.TwoAP ? 2 : 1) + boostAPCost;
        var fatNeeded = (costType == ActionCostType.OneAPOneFat ? 1 : 0) + boostFATCost;

        return Character.ActionPoints.Available >= apNeeded &&
               Character.Fatigue.Value >= fatNeeded;
    }

    private async Task ExecuteAction()
    {
        if (!CanRoll() || Character == null) return;

        // Check concentration - prompt to break if active
        var concentrationEffect = Character.GetConcentrationEffect();
        if (concentrationEffect != null)
        {
            var state = ConcentrationState.FromJson(concentrationEffect.BehaviorState);
            if (state != null)
            {
                var confirmed = await ConcentrationBreakDialog.ShowAsync(
                    DialogService,
                    state,
                    concentrationEffect.Name);
                if (!confirmed)
                    return;

                ConcentrationBehavior.BreakConcentration(Character, "Took action");
            }
        }

        // End parry mode if active
        if (CombatStanceBehavior.IsInParryMode(Character))
        {
            CombatStanceBehavior.EndParryMode(Character);
        }

        // Deduct costs
        var apCost = costType == ActionCostType.TwoAP ? 2 : 1;
        var fatCost = costType == ActionCostType.OneAPOneFat ? 1 : 0;

        Character.ActionPoints.Available -= (apCost + boostAPCost);
        Character.ActionPoints.ActionsTakenThisRound += 1;
        if ((fatCost + boostFATCost) > 0)
            Character.Fatigue.Value -= (fatCost + boostFATCost);

        // Calculate effective value using standard AS formula
        int attributeValue = Character.GetEffectiveAttribute(selectedAttribute);
        // Anonymous actions use skill level 0: AS = Attribute + 0 - 5 = Attribute - 5
        // GetEffectiveAttribute already includes item bonuses and effect attribute modifiers
        int baseAS = attributeValue - 5;
        
        // Apply ability score modifiers from active effects (wounds, buffs, debuffs, etc.)
        // Use empty string for skill name since this is an anonymous action
        var effectASModifier = Character.Effects.GetAbilityScoreModifier("", selectedAttribute, baseAS);
        
        // Calculate multi-action penalty (ActionsTakenThisRound already incremented)
        int multiActionPenalty = 0;
        if (Character.ActionPoints.ActionsTakenThisRound > 1)
        {
            multiActionPenalty = (Character.ActionPoints.ActionsTakenThisRound - 1) * 2;
        }
        
        // Apply all modifiers: boost, effects, and multi-action penalty
        int effectiveValue = baseAS + boostValue + effectASModifier - multiActionPenalty;
        
        // Track wound penalty for display separately (wounds are already included in effectASModifier)
        // This is needed for the result breakdown shown to the player
        int woundCount = Character.Effects.Count(e => e.EffectType == EffectType.Wound);
        int woundPenalty = woundCount * 2;

        // Roll and calculate result
        int diceRoll = GameMechanics.Dice.Roll4dFPlus();
        int totalRoll = effectiveValue + diceRoll;
        int sv = totalRoll - targetValue;

        // Store results for display
        resultAttributeValue = attributeValue;
        resultEffectiveValue = effectiveValue;
        resultDiceRoll = diceRoll;
        resultTotalRoll = totalRoll;
        resultSV = sv;
        resultWoundPenalty = woundPenalty;
        resultMultiActionPenalty = multiActionPenalty;
        hasRolled = true;

        // Save character state
        if (Character is Csla.Core.ISavable savable)
        {
            await savable.SaveAsync();
        }
    }

    private async Task Complete()
    {
        // Build result message per CONTEXT.md format
        var attrDisplay = AttributeDisplayNames.GetValueOrDefault(selectedAttribute, selectedAttribute);
        var message = $"{Character?.Name}: {attrDisplay} " +
                      $"{resultEffectiveValue} + 4dF+ ({(resultDiceRoll >= 0 ? "+" : "")}{resultDiceRoll}) = " +
                      $"{resultTotalRoll} vs TV {targetValue} -> SV {(resultSV >= 0 ? "+" : "")}{resultSV}";

        await OnActionComplete.InvokeAsync(message);
    }
}
