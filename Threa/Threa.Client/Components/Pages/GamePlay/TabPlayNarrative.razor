@* Narrative Tab for gameplay - Character appearance, backstory, and notes *@

@using GameMechanics
@using GameMechanics.Messaging
@using GameMechanics.Time.Calendars
@using Threa.Dal

@inject IDataPortal<CharacterEdit> characterPortal
@inject ITimeEventPublisher TimeEventPublisher
@inject IGameCalendarProvider CalendarProvider

<div class="row">
    <!-- Left: Appearance -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header"><strong>Appearance</strong></div>
            <div class="card-body">
                @if (!string.IsNullOrEmpty(Character?.ImageUrl))
                {
                    <img src="@Character.ImageUrl" alt="@Character.Name" class="img-fluid rounded mb-3" style="max-height: 150px;" />
                }

                <table class="table table-sm mb-0">
                    <tbody>
                        <tr>
                            <td class="text-muted" style="width: 25%;">Height</td>
                            <td>
                                @if (isEditingHeight)
                                {
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control" @bind="editHeight" placeholder="e.g., 6'2&quot;" />
                                        <button class="btn btn-sm btn-success" @onclick="SaveHeight">
                                            <i class="bi bi-check"></i>
                                        </button>
                                        <button class="btn btn-sm btn-secondary" @onclick="() => isEditingHeight = false">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    <span @onclick="() => { editHeight = Character?.Height ?? string.Empty; isEditingHeight = true; }" 
                                          style="cursor: pointer;" 
                                          title="Click to edit">
                                        @(string.IsNullOrEmpty(Character?.Height) ? "Click to set" : Character.Height)
                                    </span>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted">Weight</td>
                            <td>
                                @if (isEditingWeight)
                                {
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control" @bind="editWeight" placeholder="e.g., 180 lbs" />
                                        <button class="btn btn-sm btn-success" @onclick="SaveWeight">
                                            <i class="bi bi-check"></i>
                                        </button>
                                        <button class="btn btn-sm btn-secondary" @onclick="() => isEditingWeight = false">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    <span @onclick="() => { editWeight = Character?.Weight ?? string.Empty; isEditingWeight = true; }" 
                                          style="cursor: pointer;" 
                                          title="Click to edit">
                                        @(string.IsNullOrEmpty(Character?.Weight) ? "Click to set" : Character.Weight)
                                    </span>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted">Skin</td>
                            <td>
                                @if (isEditingSkin)
                                {
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control" @bind="editSkin" placeholder="e.g., Tan" />
                                        <button class="btn btn-sm btn-success" @onclick="SaveSkin">
                                            <i class="bi bi-check"></i>
                                        </button>
                                        <button class="btn btn-sm btn-secondary" @onclick="() => isEditingSkin = false">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    <span @onclick="() => { editSkin = Character?.SkinDescription ?? string.Empty; isEditingSkin = true; }" 
                                          style="cursor: pointer;" 
                                          title="Click to edit">
                                        @(string.IsNullOrEmpty(Character?.SkinDescription) ? "Click to set" : Character.SkinDescription)
                                    </span>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted">Hair</td>
                            <td>
                                @if (isEditingHair)
                                {
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control" @bind="editHair" placeholder="e.g., Brown, short" />
                                        <button class="btn btn-sm btn-success" @onclick="SaveHair">
                                            <i class="bi bi-check"></i>
                                        </button>
                                        <button class="btn btn-sm btn-secondary" @onclick="() => isEditingHair = false">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    <span @onclick="() => { editHair = Character?.HairDescription ?? string.Empty; isEditingHair = true; }" 
                                          style="cursor: pointer;" 
                                          title="Click to edit">
                                        @(string.IsNullOrEmpty(Character?.HairDescription) ? "Click to set" : Character.HairDescription)
                                    </span>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted">Age</td>
                            <td>
                                @if (Character != null && Character.Birthdate.HasValue && Table != null)
                                {
                                    var calendar = CalendarProvider.GetDefaultCalendar(Table.Theme);
                                    long currentTime = Table.StartTimeSeconds + (Table.CurrentRound * 3L);
                                    long ageSeconds = currentTime - Character.Birthdate.Value;
                                    long ageYears = ageSeconds / calendar.SecondsPerYear;
                                    <span>@ageYears year@(ageYears != 1 ? "s" : "")</span>
                                }
                                else
                                {
                                    <span class="text-muted"><em>Not set</em></span>
                                }
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Aliases -->
        <div class="card mt-3">
            <div class="card-header"><strong>Aliases</strong></div>
            <div class="card-body">
                @if (isEditingAliases)
                {
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" @bind="editAliases" placeholder="Alternative names, nicknames..." />
                        <button class="btn btn-sm btn-success" @onclick="SaveAliases">
                            <i class="bi bi-check"></i>
                        </button>
                        <button class="btn btn-sm btn-secondary" @onclick="() => isEditingAliases = false">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                }
                else
                {
                    <p class="mb-0" 
                       @onclick="() => { editAliases = Character?.Aliases ?? string.Empty; isEditingAliases = true; }" 
                       style="cursor: pointer;" 
                       title="Click to edit">
                        @(string.IsNullOrEmpty(Character?.Aliases) ? "Click to add aliases..." : Character.Aliases)
                    </p>
                }
            </div>
        </div>
    </div>

    <!-- Right: Backstory and Notes -->
    <div class="col-md-6">
        <!-- Player Description/Backstory -->
        <div class="card">
            <div class="card-header">
                <strong>Backstory</strong>
                @if (!isEditingDescription)
                {
                    <button class="btn btn-sm btn-outline-primary float-end" @onclick="() => { editDescription = Character?.Description ?? string.Empty; isEditingDescription = true; }">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                }
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                @if (isEditingDescription)
                {
                    <textarea class="form-control mb-2" rows="8" @bind="editDescription" placeholder="Your character's backstory..."></textarea>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-success" @onclick="SaveDescription">
                            <i class="bi bi-check"></i> Save
                        </button>
                        <button class="btn btn-sm btn-secondary" @onclick="() => isEditingDescription = false">
                            <i class="bi bi-x"></i> Cancel
                        </button>
                    </div>
                }
                else
                {
                    @if (string.IsNullOrEmpty(Character?.Description))
                    {
                        <p class="text-muted mb-0">No backstory provided. Click Edit to add one.</p>
                    }
                    else
                    {
                        <p class="mb-0" style="white-space: pre-wrap;">@Character.Description</p>
                    }
                }
            </div>
        </div>

        <!-- Player Notes -->
        <div class="card mt-3">
            <div class="card-header">
                <strong>Notes</strong>
                @if (!isEditingNotes)
                {
                    <button class="btn btn-sm btn-outline-primary float-end" @onclick="() => { editNotes = Character?.Notes ?? string.Empty; isEditingNotes = true; }">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                }
            </div>
            <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                @if (isEditingNotes)
                {
                    <textarea class="form-control mb-2" rows="6" @bind="editNotes" placeholder="Your notes about this character..."></textarea>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-success" @onclick="SaveNotes">
                            <i class="bi bi-check"></i> Save
                        </button>
                        <button class="btn btn-sm btn-secondary" @onclick="() => isEditingNotes = false">
                            <i class="bi bi-x"></i> Cancel
                        </button>
                    </div>
                }
                else
                {
                    @if (string.IsNullOrEmpty(Character?.Notes))
                    {
                        <p class="text-muted mb-0">No notes yet. Click Edit to add notes.</p>
                    }
                    else
                    {
                        <p class="mb-0" style="white-space: pre-wrap;">@Character.Notes</p>
                    }
                }
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public CharacterEdit? Character { get; set; }

    [Parameter]
    public GameMechanics.GamePlay.TableEdit? Table { get; set; }

    [Parameter]
    public EventCallback OnCharacterChanged { get; set; }

    private bool isEditingHeight;
    private bool isEditingWeight;
    private bool isEditingSkin;
    private bool isEditingHair;
    private bool isEditingAliases;
    private bool isEditingDescription;
    private bool isEditingNotes;

    private string editHeight = string.Empty;
    private string editWeight = string.Empty;
    private string editSkin = string.Empty;
    private string editHair = string.Empty;
    private string editAliases = string.Empty;
    private string editDescription = string.Empty;
    private string editNotes = string.Empty;

    private async Task SaveHeight()
    {
        if (Character == null) return;
        try
        {
            var character = await characterPortal.FetchAsync(Character.Id);
            character.Height = editHeight;
            await characterPortal.UpdateAsync(character);
            await PublishUpdate("Height updated");
            await OnCharacterChanged.InvokeAsync();
            isEditingHeight = false;
        }
        catch
        {
            // Silently fail - character will reload on next refresh
        }
    }

    private async Task SaveWeight()
    {
        if (Character == null) return;
        try
        {
            var character = await characterPortal.FetchAsync(Character.Id);
            character.Weight = editWeight;
            await characterPortal.UpdateAsync(character);
            await PublishUpdate("Weight updated");
            await OnCharacterChanged.InvokeAsync();
            isEditingWeight = false;
        }
        catch
        {
            // Silently fail - character will reload on next refresh
        }
    }

    private async Task SaveSkin()
    {
        if (Character == null) return;
        try
        {
            var character = await characterPortal.FetchAsync(Character.Id);
            character.SkinDescription = editSkin;
            await characterPortal.UpdateAsync(character);
            await PublishUpdate("Skin description updated");
            await OnCharacterChanged.InvokeAsync();
            isEditingSkin = false;
        }
        catch
        {
            // Silently fail - character will reload on next refresh
        }
    }

    private async Task SaveHair()
    {
        if (Character == null) return;
        try
        {
            var character = await characterPortal.FetchAsync(Character.Id);
            character.HairDescription = editHair;
            await characterPortal.UpdateAsync(character);
            await PublishUpdate("Hair description updated");
            await OnCharacterChanged.InvokeAsync();
            isEditingHair = false;
        }
        catch
        {
            // Silently fail - character will reload on next refresh
        }
    }

    private async Task SaveAliases()
    {
        if (Character == null) return;
        try
        {
            var character = await characterPortal.FetchAsync(Character.Id);
            character.Aliases = editAliases;
            await characterPortal.UpdateAsync(character);
            await PublishUpdate("Aliases updated");
            await OnCharacterChanged.InvokeAsync();
            isEditingAliases = false;
        }
        catch
        {
            // Silently fail - character will reload on next refresh
        }
    }

    private async Task SaveDescription()
    {
        if (Character == null) return;
        try
        {
            var character = await characterPortal.FetchAsync(Character.Id);
            character.Description = editDescription;
            await characterPortal.UpdateAsync(character);
            await PublishUpdate("Backstory updated");
            await OnCharacterChanged.InvokeAsync();
            isEditingDescription = false;
        }
        catch
        {
            // Silently fail - character will reload on next refresh
        }
    }

    private async Task SaveNotes()
    {
        if (Character == null) return;
        try
        {
            var character = await characterPortal.FetchAsync(Character.Id);
            character.Notes = editNotes;
            await characterPortal.UpdateAsync(character);
            await PublishUpdate("Notes updated");
            await OnCharacterChanged.InvokeAsync();
            isEditingNotes = false;
        }
        catch
        {
            // Silently fail - character will reload on next refresh
        }
    }

    private async Task PublishUpdate(string description)
    {
        if (Character == null || Table == null) return;

        await TimeEventPublisher.PublishCharacterUpdateAsync(new CharacterUpdateMessage
        {
            CharacterId = Character.Id,
            UpdateType = CharacterUpdateType.General,
            CampaignId = Table.Id.ToString(),
            Description = description
        });
    }
}
