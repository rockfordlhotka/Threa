@using Threa.Client.Components.Shared
@using GameMechanics.Combat
@using GameMechanics.Effects.Behaviors
@using Threa.Dal.Dto

@inject Csla.IChildDataPortal<GameMechanics.EffectRecord> EffectPortal

<div class="damage-resolution">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0"><i class="bi bi-lightning-charge text-danger"></i> Damage Resolution</h4>
        <button class="btn btn-outline-secondary btn-sm" @onclick="OnCancel">
            <i class="bi bi-x-lg"></i> Cancel
        </button>
    </div>

    @if (resolutionPhase == ResolutionPhase.Input)
    {
        <!-- Phase 1: Input SV and damage info -->
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header">
                        <strong>1. Damage Source</strong>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Success Value (SV)</label>
                            <div class="input-group">
                                <input type="number" class="form-control form-control-lg" @bind="inputSV"
                                       min="0" placeholder="Enter SV">
                                <span class="input-group-text">SV</span>
                            </div>
                            <small class="text-muted">The SV from attack vs defense, or GM-assigned value for falls/spells.</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Damage Type</label>
                            <select class="form-select" @bind="selectedDamageType">
                                <option value="@DamageType.Bashing">Bashing (Blunt)</option>
                                <option value="@DamageType.Cutting">Cutting (Slashing)</option>
                                <option value="@DamageType.Piercing">Piercing (Stabbing)</option>
                                <option value="@DamageType.Projectile">Projectile (Ranged)</option>
                                <option value="@DamageType.Energy">Energy (Magic/Fire)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Damage Class</label>
                            <select class="form-select" @bind="selectedDamageClass">
                                <option value="1">Class 1 (Normal weapons)</option>
                                <option value="2">Class 2 (Vehicles, giants) - 10x</option>
                                <option value="3">Class 3 (Armored vehicles, dragons) - 100x</option>
                                <option value="4">Class 4 (Starships, high magic) - 1000x</option>
                            </select>
                        </div>
                    </div>
                </div>

                @if (ShieldBlockAvailable && !shieldBlockUsed)
                {
                    <div class="card mb-3 border-info">
                        <div class="card-header bg-info text-white">
                            <strong><i class="bi bi-shield-shaded"></i> Shield Block Available</strong>
                        </div>
                        <div class="card-body">
                            <p class="mb-2">You can attempt to block with your shield before armor absorbs damage.</p>
                            <div class="d-flex gap-2">
                                <button class="btn btn-info" @onclick="AttemptShieldBlock"
                                        disabled="@(!CanAttemptShieldBlock())">
                                    <i class="bi bi-shield-check"></i> Attempt Shield Block
                                </button>
                                <button class="btn btn-outline-secondary" @onclick="SkipShieldBlock">
                                    Skip Shield
                                </button>
                            </div>
                            @if (!CanAttemptShieldBlock())
                            {
                                <small class="text-warning d-block mt-2">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    Requires 1 AP + 1 FAT (or 2 AP)
                                </small>
                            }
                        </div>
                    </div>
                }

                @if (shieldBlockResult != null)
                {
                    <div class="card mb-3 @(shieldBlockResult.Success ? "border-success" : "border-danger")">
                        <div class="card-header @(shieldBlockResult.Success ? "bg-success" : "bg-danger") text-white">
                            <strong>Shield Block @(shieldBlockResult.Success ? "Success!" : "Failed")</strong>
                        </div>
                        <div class="card-body">
                            <p>Rolled @shieldBlockResult.Roll vs TV 8</p>
                            @if (shieldBlockResult.Success)
                            {
                                <p class="text-success">Shield will absorb damage first!</p>
                            }
                        </div>
                    </div>
                }
            </div>

            <div class="col-md-6">
                <!-- Preview and proceed -->
                <div class="card bg-light">
                    <div class="card-header bg-danger text-white">
                        <strong><i class="bi bi-calculator"></i> Damage Preview</strong>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm mb-0">
                            <tbody>
                                <tr>
                                    <td>Incoming SV:</td>
                                    <td class="fw-bold">@inputSV</td>
                                </tr>
                                <tr>
                                    <td>Damage Type:</td>
                                    <td class="fw-bold">@selectedDamageType</td>
                                </tr>
                                <tr>
                                    <td>Damage Class:</td>
                                    <td class="fw-bold">@selectedDamageClass</td>
                                </tr>
                                <tr>
                                    <td>Dice Roll:</td>
                                    <td class="fw-bold">@GetDicePreview()</td>
                                </tr>
                                @if (shieldBlockResult?.Success == true)
                                {
                                    <tr class="table-info">
                                        <td>Shield Block:</td>
                                        <td class="fw-bold text-success">Active</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-danger btn-lg w-100" @onclick="ProceedToResolution"
                                disabled="@(inputSV < 0)">
                            <i class="bi bi-dice-5"></i> Roll Hit Location & Damage
                        </button>
                    </div>
                </div>

                <!-- Equipped Armor Summary -->
                <div class="card mt-3">
                    <div class="card-header">
                        <strong><i class="bi bi-shield-fill"></i> Equipped Protection</strong>
                    </div>
                    <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                        @if (equippedArmor.Any())
                        {
                            <ul class="list-unstyled mb-0">
                                @foreach (var armor in equippedArmor)
                                {
                                    <li class="mb-1">
                                        <i class="bi bi-shield"></i>
                                        <strong>@armor.Name</strong>
                                        <small class="text-muted">(@armor.Slot)</small>
                                        <br />
                                        <small>Class @armor.DamageClass, Durability: @armor.CurrentDurability/@armor.MaxDurability</small>
                                    </li>
                                }
                            </ul>
                        }
                        else
                        {
                            <p class="text-muted mb-0"><em>No armor equipped</em></p>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
    else if (resolutionPhase == ResolutionPhase.Result)
    {
        <!-- Phase 2: Show results -->
        <div class="card">
            <div class="card-header @GetResultHeaderClass() text-white">
                <strong>
                    <i class="bi @GetResultIcon()"></i> @GetResultTitle()
                </strong>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>Hit Location</h5>
                        <div class="alert alert-secondary">
                            <i class="bi bi-geo-alt"></i>
                            <strong class="fs-5">@result!.HitLocation</strong>
                        </div>

                        <h5>Absorption Steps</h5>
                        @if (result.AbsorptionSteps.Any())
                        {
                            <ul class="list-group mb-3">
                                @foreach (var step in result.AbsorptionSteps)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="bi @(step.IsShield ? "bi-shield-shaded" : "bi-shield")"></i>
                                            @step.ItemName
                                            @if (step.ItemDestroyed)
                                            {
                                                <span class="badge bg-danger ms-1">DESTROYED</span>
                                            }
                                        </div>
                                        <span class="badge bg-success">-@step.TotalAbsorbed SV</span>
                                    </li>
                                }
                            </ul>
                        }
                        else
                        {
                            <p class="text-muted">No armor at this location</p>
                        }

                        @if (result.ArmorSkillRV != 0)
                        {
                            <div class="small text-muted">
                                Armor Skill: @(result.ArmorSkillRV >= 0 ? "+" : "")@result.ArmorSkillRV
                                (@(result.ArmorSkillBonus >= 0 ? "+" : "")@result.ArmorSkillBonus absorption)
                            </div>
                        }
                    </div>

                    <div class="col-md-6">
                        <h5>Damage Calculation</h5>
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <td>Incoming SV:</td>
                                    <td>@result.IncomingSV</td>
                                </tr>
                                <tr>
                                    <td>Absorbed:</td>
                                    <td class="text-success">-@result.TotalAbsorbed</td>
                                </tr>
                                <tr class="table-warning">
                                    <td><strong>Penetrating SV:</strong></td>
                                    <td><strong>@result.PenetratingSV</strong></td>
                                </tr>
                                @if (result.DamageRoll != null)
                                {
                                    <tr>
                                        <td>Damage Roll:</td>
                                        <td>@result.DamageRoll.DiceSpec.Description = @result.DamageRoll.RawRoll</td>
                                    </tr>
                                    <tr>
                                        <td>Damage Total:</td>
                                        <td><strong>@result.DamageRoll.DamageValue</strong></td>
                                    </tr>
                                }
                            </tbody>
                        </table>

                        @if (result.FullyAbsorbed)
                        {
                            <div class="alert alert-success">
                                <i class="bi bi-shield-check"></i>
                                <strong>All damage absorbed!</strong>
                            </div>
                        }
                        else
                        {
                            <div class="alert @(result.CausedWound ? "alert-danger" : "alert-warning")">
                                <h5>
                                    @if (result.CausedWound)
                                    {
                                        <i class="bi bi-bandaid"></i>
                                        <text>Wounded!</text>
                                    }
                                    else
                                    {
                                        <i class="bi bi-exclamation-triangle"></i>
                                        <text>Damage Taken</text>
                                    }
                                </h5>
                                <div class="d-flex gap-4">
                                    <div>
                                        <span class="text-danger fw-bold fs-4">@result.FatigueDamage</span>
                                        <small class="text-muted">FAT</small>
                                    </div>
                                    <div>
                                        <span class="text-danger fw-bold fs-4">@result.VitalityDamage</span>
                                        <small class="text-muted">VIT</small>
                                    </div>
                                    @if (result.WoundCount > 0)
                                    {
                                        <div>
                                            <span class="text-danger fw-bold fs-4">@result.WoundCount</span>
                                            <small class="text-muted">Wound@(result.WoundCount > 1 ? "s" : "")</small>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
            <div class="card-footer d-flex gap-2">
                <button class="btn btn-primary btn-lg" @onclick="ApplyDamageAndComplete">
                    <i class="bi bi-check-lg"></i> Apply Damage
                </button>
                <button class="btn btn-outline-secondary" @onclick="ResetResolution">
                    <i class="bi bi-arrow-repeat"></i> New Damage
                </button>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public GameMechanics.CharacterEdit? Character { get; set; }
    [Parameter] public GameMechanics.GamePlay.TableEdit? Table { get; set; }
    [Parameter] public int? InitialSV { get; set; }
    [Parameter] public DamageType? InitialDamageType { get; set; }
    [Parameter] public int? InitialDamageClass { get; set; }
    [Parameter] public bool? InitialShieldBlockSuccess { get; set; }
    [Parameter] public int? InitialShieldBlockRV { get; set; }
    [Parameter] public List<CharacterItem>? EquippedItems { get; set; }
    [Parameter] public int ShieldSkillAS { get; set; }
    [Parameter] public int ArmorSkillAS { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback<string> OnDamageComplete { get; set; }

    private enum ResolutionPhase { Input, Result }
    private ResolutionPhase resolutionPhase = ResolutionPhase.Input;

    // Input state
    private int inputSV;
    private DamageType selectedDamageType = DamageType.Bashing;
    private int selectedDamageClass = 1;
    private List<EquippedArmorInfo> equippedArmor = new();
    private EquippedArmorInfo? equippedShield;

    // Shield block state
    private bool shieldBlockUsed;
    private ShieldBlockResultData? shieldBlockResult;

    // Result state
    private DamageResolutionResult? result;

    protected override void OnParametersSet()
    {
        // Initialize from parameters if provided (from combat flow)
        if (InitialSV.HasValue) inputSV = InitialSV.Value;
        if (InitialDamageType.HasValue) selectedDamageType = InitialDamageType.Value;
        if (InitialDamageClass.HasValue) selectedDamageClass = InitialDamageClass.Value;

        // If shield block already happened in DefendMode
        if (InitialShieldBlockSuccess.HasValue)
        {
            shieldBlockUsed = true;
            shieldBlockResult = new ShieldBlockResultData
            {
                Success = InitialShieldBlockSuccess.Value,
                Roll = InitialShieldBlockRV ?? 0
            };
        }

        LoadEquippedArmor();
    }

    private void LoadEquippedArmor()
    {
        equippedArmor.Clear();
        equippedShield = null;

        if (EquippedItems == null) return;

        foreach (var item in EquippedItems)
        {
            if (item.Template == null) continue;

            if (item.Template.ItemType == ItemType.Shield)
            {
                equippedShield = new EquippedArmorInfo
                {
                    ItemId = item.Id,
                    Name = item.CustomName ?? item.Template.Name,
                    Slot = item.EquippedSlot,
                    DamageClass = item.Template.DamageClass,
                    CurrentDurability = item.CurrentDurability ?? item.Template.MaxDurability ?? 10,
                    MaxDurability = item.Template.MaxDurability ?? 10,
                    ArmorAbsorption = item.Template.ArmorAbsorption
                };
            }
            else if (item.Template.ItemType == ItemType.Armor)
            {
                equippedArmor.Add(new EquippedArmorInfo
                {
                    ItemId = item.Id,
                    Name = item.CustomName ?? item.Template.Name,
                    Slot = item.EquippedSlot,
                    DamageClass = item.Template.DamageClass,
                    CurrentDurability = item.CurrentDurability ?? item.Template.MaxDurability ?? 10,
                    MaxDurability = item.Template.MaxDurability ?? 10,
                    ArmorAbsorption = item.Template.ArmorAbsorption
                });
            }
        }
    }

    private bool ShieldBlockAvailable => equippedShield != null && !shieldBlockUsed;

    private bool CanAttemptShieldBlock()
    {
        if (Character == null) return false;
        // Shield block costs 1 AP + 1 FAT (or 2 AP)
        return Character.ActionPoints.Available >= 1 && Character.Fatigue.Value >= 1;
    }

    private void AttemptShieldBlock()
    {
        if (!CanAttemptShieldBlock() || Character == null) return;

        // Deduct cost
        Character.ActionPoints.Available -= 1;
        Character.Fatigue.Value -= 1;

        // Roll shield block vs TV 8
        int roll = ShieldSkillAS + GameMechanics.Dice.Roll4dFPlus();
        bool success = roll >= 8;

        shieldBlockUsed = true;
        shieldBlockResult = new ShieldBlockResultData
        {
            Success = success,
            Roll = roll,
            RV = roll - 8
        };
    }

    private void SkipShieldBlock()
    {
        shieldBlockUsed = true;
        shieldBlockResult = null;
    }

    private string GetDicePreview()
    {
        if (inputSV < 0) return "N/A";
        var spec = DamageTables.GetDiceForSV(inputSV);
        return spec.Description;
    }

    private void ProceedToResolution()
    {
        if (Character == null) return;

        // Determine hit location
        var hitLocationCalc = new HitLocationCalculator(new RandomDiceRoller());
        var hitLocation = hitLocationCalc.DetermineHitLocation();

        // Build armor info for this location
        var armorAtLocation = BuildArmorInfoForLocation(hitLocation);

        // Build shield info if block succeeded
        ShieldInfo? shieldInfo = null;
        if (shieldBlockResult?.Success == true && equippedShield != null)
        {
            shieldInfo = BuildShieldInfo(equippedShield);
        }

        // Build damage request
        var request = new DamageRequest
        {
            IncomingSV = inputSV,
            HitLocation = hitLocation,
            DamageType = selectedDamageType,
            DamageClass = selectedDamageClass,
            DefenderArmorAS = ArmorSkillAS,
            ArmorPieces = armorAtLocation,
            Shield = shieldInfo,
            ShieldBlockSucceeded = shieldBlockResult?.Success ?? false,
            ShieldBlockRV = shieldBlockResult?.RV
        };

        // Resolve damage
        var resolver = new DamageResolver(new RandomDiceRoller());
        result = resolver.Resolve(request);

        resolutionPhase = ResolutionPhase.Result;
    }

    private List<ArmorInfo> BuildArmorInfoForLocation(HitLocation location)
    {
        var armorList = new List<ArmorInfo>();
        var slotsForLocation = EquipmentLocationMapper.GetSlotsForLocation(location);

        foreach (var armor in equippedArmor)
        {
            if (slotsForLocation.Contains(armor.Slot))
            {
                armorList.Add(new ArmorInfo
                {
                    ItemId = armor.ItemId.ToString(),
                    Name = armor.Name,
                    CoveredLocations = EquipmentLocationMapper.GetCoveredLocations(armor.Slot),
                    DamageClass = armor.DamageClass,
                    Absorption = ParseArmorAbsorption(armor.ArmorAbsorption),
                    CurrentDurability = armor.CurrentDurability,
                    MaxDurability = armor.MaxDurability,
                    LayerOrder = GetLayerOrder(armor.Slot)
                });
            }
        }

        return armorList.OrderBy(a => a.LayerOrder).ToList();
    }

    private ShieldInfo BuildShieldInfo(EquippedArmorInfo shield)
    {
        return new ShieldInfo
        {
            ItemId = shield.ItemId.ToString(),
            Name = shield.Name,
            DamageClass = shield.DamageClass,
            Absorption = ParseArmorAbsorption(shield.ArmorAbsorption),
            CurrentDurability = shield.CurrentDurability,
            MaxDurability = shield.MaxDurability
        };
    }

    private Dictionary<DamageType, int> ParseArmorAbsorption(string? json)
    {
        var result = new Dictionary<DamageType, int>();
        if (string.IsNullOrEmpty(json)) return result;

        try
        {
            var parsed = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, int>>(json);
            if (parsed != null)
            {
                foreach (var kvp in parsed)
                {
                    if (Enum.TryParse<DamageType>(kvp.Key, true, out var damageType))
                    {
                        result[damageType] = kvp.Value;
                    }
                }
            }
        }
        catch
        {
            // If parsing fails, return empty dictionary
        }

        return result;
    }

    private int GetLayerOrder(EquipmentSlot slot)
    {
        // Outer layers absorb first (lower number = outer)
        return slot switch
        {
            EquipmentSlot.Back => 1,      // Cloaks, capes - outermost
            EquipmentSlot.Shoulders => 2, // Pauldrons
            EquipmentSlot.Chest => 3,     // Main armor
            EquipmentSlot.Waist => 4,     // Belt/tasset
            _ => 10                        // Default inner
        };
    }

    private string GetResultHeaderClass()
    {
        if (result == null) return "bg-secondary";
        if (result.FullyAbsorbed) return "bg-success";
        if (result.CausedWound) return "bg-danger";
        return "bg-warning";
    }

    private string GetResultIcon()
    {
        if (result == null) return "bi-question-circle";
        if (result.FullyAbsorbed) return "bi-shield-check";
        if (result.CausedWound) return "bi-bandaid";
        return "bi-exclamation-triangle";
    }

    private string GetResultTitle()
    {
        if (result == null) return "Damage Resolution";
        if (result.FullyAbsorbed) return "Damage Absorbed!";
        if (result.CausedWound) return $"Wounded at {result.HitLocation}!";
        return $"Damage to {result.HitLocation}";
    }

    private async Task ApplyDamageAndComplete()
    {
        if (result == null || Character == null) return;

        // Apply FAT damage to pending damage pool
        if (result.FatigueDamage > 0)
        {
            Character.Fatigue.PendingDamage += result.FatigueDamage;
        }

        // Apply VIT damage to pending damage pool
        if (result.VitalityDamage > 0)
        {
            Character.Vitality.PendingDamage += result.VitalityDamage;
        }

        // Create wound effects
        for (int i = 0; i < result.WoundCount; i++)
        {
            var woundEffect = EffectPortal.CreateChild(
                EffectType.Wound,
                $"Wound ({result.HitLocation})",
                result.HitLocation.ToString(),
                null, // Wounds don't expire automatically
                null);

            woundEffect.Description = $"Wound at {result.HitLocation} from {result.DamageType} damage";
            woundEffect.Source = "Combat";

            Character.Effects.AddEffect(woundEffect);
        }

        // Save character
        if (Character is Csla.Core.ISavable savable)
        {
            await savable.SaveAsync();
        }

        // Build completion message
        var message = BuildCompletionMessage();
        await OnDamageComplete.InvokeAsync(message);
    }

    private string BuildCompletionMessage()
    {
        if (result == null) return "";

        if (result.FullyAbsorbed)
        {
            return $"{Character?.Name} absorbs all damage (SV {result.IncomingSV} to {result.HitLocation})";
        }

        var parts = new List<string>();
        parts.Add($"{Character?.Name} takes");

        if (result.FatigueDamage > 0)
            parts.Add($"{result.FatigueDamage} FAT");

        if (result.VitalityDamage > 0)
            parts.Add($"{result.VitalityDamage} VIT");

        parts.Add($"to {result.HitLocation}");

        if (result.WoundCount > 0)
            parts.Add($"({result.WoundCount} wound{(result.WoundCount > 1 ? "s" : "")})");

        return string.Join(" ", parts);
    }

    private void ResetResolution()
    {
        resolutionPhase = ResolutionPhase.Input;
        result = null;
        shieldBlockUsed = false;
        shieldBlockResult = null;
    }

    // Helper classes
    private class EquippedArmorInfo
    {
        public Guid ItemId { get; set; }
        public string Name { get; set; } = "";
        public EquipmentSlot Slot { get; set; }
        public int DamageClass { get; set; }
        public int CurrentDurability { get; set; }
        public int MaxDurability { get; set; }
        public string? ArmorAbsorption { get; set; }
    }

    private class ShieldBlockResultData
    {
        public bool Success { get; set; }
        public int Roll { get; set; }
        public int RV { get; set; }
    }

    // Simple dice roller for resolution
    private class RandomDiceRoller : IDiceRoller
    {
        private static readonly Random _random = new();

        public int Roll(int count, int size)
        {
            int total = 0;
            for (int i = 0; i < count; i++)
            {
                total += _random.Next(1, size + 1);
            }
            return total;
        }

        public int RollFudge()
        {
            int die = _random.Next(1, 7);
            if (die <= 2) return -1;
            if (die >= 5) return +1;
            return 0;
        }

        public int Roll4dFPlus()
        {
            int total = 0;
            for (int i = 0; i < 4; i++)
            {
                int die = _random.Next(1, 7);
                if (die <= 2) total -= 1;
                else if (die >= 5) total += 1;
                // 3-4 = 0

                // Exploding on 6
                while (die == 6)
                {
                    die = _random.Next(1, 7);
                    if (die <= 2) total -= 1;
                    else if (die >= 5) total += 1;
                }
            }
            return total;
        }
    }
}
