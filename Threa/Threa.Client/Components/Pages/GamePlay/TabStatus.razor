@* Status Tab - Shows character portrait, health pools, effects, and wounds *@

@using GameMechanics.Effects.Behaviors
@using GameMechanics.Time
@using GameMechanics.Items
@using Threa.Dal.Dto
@using Threa.Client.Components.Shared

@inject IGameTimeFormatService TimeFormat

<div class="row">
    <!-- Left Column: Portrait and Quick Status -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                @if (!string.IsNullOrEmpty(Character?.ImageUrl))
                {
                    <img src="@Character.ImageUrl" alt="@Character.Name" class="img-fluid rounded mb-3" style="max-height: 200px;" />
                }
                else
                {
                    <div class="bg-secondary text-white rounded d-flex align-items-center justify-content-center mb-3" style="height: 200px; font-size: 4rem;">
                        @(Character?.Name.FirstOrDefault())
                    </div>
                }
                <h5>@Character?.Name</h5>
                <p class="text-muted mb-1">@Character?.Species</p>
                <p class="text-muted mb-0">Damage Class: @Character?.DamageClass</p>
            </div>
        </div>

        <!-- Quick Status -->
        <div class="card mt-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <strong>Status</strong>
                @if (Table?.IsInCombat == true)
                {
                    <span class="badge bg-danger">Round @Table.CurrentRound</span>
                }
            </div>
            <div class="card-body">
                @if (Character?.IsPassedOut == true)
                {
                    <div class="alert alert-danger mb-2 py-1">
                        <i class="bi bi-moon-stars"></i> <strong>Unconscious</strong>
                    </div>
                }
                else if (Character?.Fatigue.Value <= 0)
                {
                    <div class="alert alert-warning mb-2 py-1">
                        <i class="bi bi-battery"></i> <strong>Exhausted</strong>
                    </div>
                }
                else if (GetFatPercent() <= 25)
                {
                    <div class="alert alert-warning mb-2 py-1">
                        <i class="bi bi-battery-half"></i> <strong>Fatigued</strong>
                    </div>
                }
                else
                {
                    <div class="alert alert-success mb-2 py-1">
                        <i class="bi bi-check-circle"></i> <strong>Conscious</strong>
                    </div>
                }

                @if (GetVitPercent() <= 25 && Character?.Vitality.Value > 0)
                {
                    <div class="alert alert-danger mb-2 py-1">
                        <i class="bi bi-exclamation-triangle"></i> <strong>Critical Health</strong>
                    </div>
                }
                else if (GetVitPercent() <= 50 && Character?.Vitality.Value > 0)
                {
                    <div class="alert alert-warning mb-2 py-1">
                        <i class="bi bi-heart-half"></i> <strong>Injured</strong>
                    </div>
                }

                @if (TotalWoundPenalty < 0)
                {
                    <div class="alert alert-warning mb-2 py-1">
                        <i class="bi bi-bandaid"></i> <strong>Wounded</strong>
                        <span class="badge bg-danger ms-2">@TotalWoundPenalty AS</span>
                    </div>
                }

                @if (HasCrippledLimbs)
                {
                    <div class="alert alert-danger mb-2 py-1">
                        <i class="bi bi-x-circle"></i> <strong>Crippled Limb</strong>
                    </div>
                }

                @* Concentration Status *@
                <ConcentrationIndicator Character="@Character"
                                        ShowDropButton="true"
                                        OnConcentrationDropped="@HandleConcentrationDropped" />
            </div>
        </div>

        <!-- Attributes with Item Bonuses -->
        <div class="card mt-3">
            <div class="card-header">
                <strong><i class="bi bi-bar-chart"></i> Attributes</strong>
            </div>
            <div class="card-body">
                @foreach (var attr in Character?.AttributeList ?? Enumerable.Empty<GameMechanics.AttributeEdit>())
                {
                    var breakdown = Character?.GetAttributeBreakdown(attr.Name);
                    if (breakdown != null)
                    {
                        <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                            <span class="fw-bold">@attr.Name</span>
                            <div class="d-flex align-items-center gap-2">
                                <span class="@GetTotalBonusClass(breakdown)" style="font-size: 1.1rem;">
                                    @breakdown.Total
                                </span>
                                <small class="text-muted">
                                    (@breakdown.BaseValue<text> base</text>@if (breakdown.ItemBonus != 0)
                                    {<text> </text><span class="@(breakdown.ItemBonus > 0 ? "text-success" : "text-danger")">@(breakdown.ItemBonus > 0 ? "+" : "")@breakdown.ItemBonus items</span>}@if (breakdown.EffectBonus != 0)
                                    {<text> </text><span class="@(breakdown.EffectBonus > 0 ? "text-success" : "text-danger")">@(breakdown.EffectBonus > 0 ? "+" : "")@breakdown.EffectBonus effects</span>})
                                </small>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>

    <!-- Middle Column: Health Pools -->
    <div class="col-md-4">
        <!-- Fatigue Pool -->
        <div class="card mb-3 @GetPoolCardClass(GetFatPercent())">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <strong><i class="bi bi-battery-charging"></i> Fatigue (FAT)</strong>
                @if (GetFatPercent() <= 25)
                {
                    <span class="badge bg-danger">LOW</span>
                }
            </div>
            <div class="card-body">
                <div class="text-center mb-2">
                    <span class="display-6 @GetPoolValueClass(GetFatPercent())">@Character?.Fatigue.Value</span>
                    <span class="text-muted">/ @Character?.Fatigue.BaseValue</span>
                </div>
                <PendingPoolBar CurrentValue="@(Character?.Fatigue.Value ?? 0)"
                                MaxValue="@(Character?.Fatigue.BaseValue ?? 1)"
                                PendingDamage="@(Character?.Fatigue.PendingDamage ?? 0)"
                                PendingHealing="@(Character?.Fatigue.PendingHealing ?? 0)"
                                ShowLabels="false"
                                Height="25px" />

                <!-- Pending Details -->
                <div class="mt-2 small">
                    @if (Character?.Fatigue.PendingHealing > 0 || Character?.Fatigue.PendingDamage > 0)
                    {
                        <div class="d-flex justify-content-between text-muted">
                            <span>Pending:</span>
                            <span>
                                @if (Character?.Fatigue.PendingDamage > 0)
                                {
                                    <span class="text-danger">-@Character.Fatigue.PendingDamage</span>
                                }
                                @if (Character?.Fatigue.PendingHealing > 0)
                                {
                                    <span class="text-success ms-1">+@Character.Fatigue.PendingHealing</span>
                                }
                            </span>
                        </div>
                        <div class="d-flex justify-content-between text-muted">
                            <span>Next tick:</span>
                            <span>
                                @if (Character?.Fatigue.PendingDamage > 0)
                                {
                                    <span class="text-danger">-@GetNextTickAmount(Character.Fatigue.PendingDamage)</span>
                                }
                                @if (Character?.Fatigue.PendingHealing > 0)
                                {
                                    <span class="text-success ms-1">+@GetNextTickAmount(Character.Fatigue.PendingHealing)</span>
                                }
                                <span class="text-info ms-1">(end of round)</span>
                            </span>
                        </div>
                    }
                    else
                    {
                        <div class="text-muted text-center">No pending changes</div>
                    }
                </div>
            </div>
        </div>

        <!-- Vitality Pool -->
        <div class="card mb-3 @GetPoolCardClass(GetVitPercent())">
            <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                <strong><i class="bi bi-heart-pulse"></i> Vitality (VIT)</strong>
                @if (GetVitPercent() <= 25)
                {
                    <span class="badge bg-warning text-dark">CRITICAL</span>
                }
            </div>
            <div class="card-body">
                <div class="text-center mb-2">
                    <span class="display-6 @GetPoolValueClass(GetVitPercent())">@Character?.Vitality.Value</span>
                    <span class="text-muted">/ @Character?.Vitality.BaseValue</span>
                </div>
                <PendingPoolBar CurrentValue="@(Character?.Vitality.Value ?? 0)"
                                MaxValue="@(Character?.Vitality.BaseValue ?? 1)"
                                PendingDamage="@(Character?.Vitality.PendingDamage ?? 0)"
                                PendingHealing="@(Character?.Vitality.PendingHealing ?? 0)"
                                ShowLabels="false"
                                Height="25px" />

                <!-- Pending Details -->
                <div class="mt-2 small">
                    @if (Character?.Vitality.PendingHealing > 0 || Character?.Vitality.PendingDamage > 0)
                    {
                        <div class="d-flex justify-content-between text-muted">
                            <span>Pending:</span>
                            <span>
                                @if (Character?.Vitality.PendingDamage > 0)
                                {
                                    <span class="text-danger">-@Character.Vitality.PendingDamage</span>
                                }
                                @if (Character?.Vitality.PendingHealing > 0)
                                {
                                    <span class="text-success ms-1">+@Character.Vitality.PendingHealing</span>
                                }
                            </span>
                        </div>
                        <div class="d-flex justify-content-between text-muted">
                            <span>Next tick:</span>
                            <span>
                                @if (Character?.Vitality.PendingDamage > 0)
                                {
                                    <span class="text-danger">-@GetNextTickAmount(Character.Vitality.PendingDamage)</span>
                                }
                                @if (Character?.Vitality.PendingHealing > 0)
                                {
                                    <span class="text-success ms-1">+@GetNextTickAmount(Character.Vitality.PendingHealing)</span>
                                }
                                <span class="text-info ms-1">(end of round)</span>
                            </span>
                        </div>
                    }
                    else
                    {
                        <div class="text-muted text-center">No pending changes</div>
                    }
                </div>

                <!-- Low Vitality FAT Recovery Warning -->
                @if (Character?.Vitality.Value > 0 && Character?.Vitality.Value <= 4)
                {
                    <div class="alert alert-warning mt-2 mb-0 py-2 px-2 small">
                        <div class="fw-bold mb-1">
                            <i class="bi bi-exclamation-triangle"></i> Low Vitality Effect
                        </div>
                        <div>
                            @if (Character.Vitality.Value == 4)
                            {
                                <span>FAT recovery slowed to <strong>1 per minute</strong></span>
                            }
                            else if (Character.Vitality.Value == 3)
                            {
                                <span>FAT recovery slowed to <strong>1 per 30 minutes</strong></span>
                                <br /><small class="text-muted">Actions require Focus check (TV 7)</small>
                            }
                            else if (Character.Vitality.Value == 2)
                            {
                                <span>FAT recovery slowed to <strong>1 per hour</strong></span>
                                <br /><small class="text-muted">Actions require Focus check (TV 12)</small>
                            }
                            else if (Character.Vitality.Value == 1)
                            {
                                <span class="text-danger"><strong>FAT recovery halted</strong></span>
                                <br /><small class="text-muted">Cannot perform actions</small>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Action Points -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <strong><i class="bi bi-lightning-charge"></i> Action Points (AP)</strong>
            </div>
            <div class="card-body">
                <div class="text-center mb-2">
                    <span class="display-6">@Character?.ActionPoints.Available</span>
                    <span class="text-muted">/ @Character?.ActionPoints.Max</span>
                </div>
                <div class="d-flex justify-content-center gap-2">
                    @for (int i = 0; i < (Character?.ActionPoints.Max ?? 0); i++)
                    {
                        var isAvailable = i < (Character?.ActionPoints.Available ?? 0);
                        <div class="rounded-circle d-flex align-items-center justify-content-center @(isAvailable ? "bg-primary" : "bg-secondary")"
                             style="width: 30px; height: 30px;">
                            @if (isAvailable)
                            {
                                <i class="bi bi-lightning-fill text-white" style="font-size: 0.8rem;"></i>
                            }
                        </div>
                    }
                </div>
                <div class="text-center mt-2">
                    <small class="text-muted">Recovery: @Character?.ActionPoints.Recovery AP/round</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Active Effects and Wounds -->
    <div class="col-md-4">
        <!-- Active Effects -->
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <strong><i class="bi bi-stars"></i> Active Effects</strong>
                @if (Character?.Effects.Any() == true)
                {
                    <span class="badge bg-secondary">@Character.Effects.Count()</span>
                }
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                @if (Character?.Effects == null || !Character.Effects.Any(e => e.EffectType != EffectType.Wound))
                {
                    <p class="text-muted mb-0">No active effects</p>
                }
                else
                {
                    @foreach (var group in GetGroupedEffects())
                    {
                        <div class="mb-3">
                            <h6 class="text-muted border-bottom pb-1 mb-2">
                                <i class="bi @GetEffectGroupIcon(group.Key)"></i> @GetEffectGroupName(group.Key)
                            </h6>
                            @foreach (var effect in group)
                            {
                                <div class="effect-item mb-2 p-2 rounded @GetEffectItemClass(effect)"
                                     @onclick="() => ToggleEffectExpansion(effect.Id)"
                                     style="cursor: pointer;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center gap-2">
                                            <EffectIcon EffectType="@effect.EffectType.ToString()"
                                                        EffectName="@effect.Name"
                                                        Stacks="@(effect.CurrentStacks > 1 ? effect.CurrentStacks : null)"
                                                        Color="@GetEffectIconColor(effect)" />
                                            <div>
                                                <strong>@effect.Name</strong>
                                                @if (!string.IsNullOrEmpty(effect.Source))
                                                {
                                                    <br /><small class="text-muted">@effect.Source</small>
                                                }
                                            </div>
                                        </div>
                                        <div class="text-end">
                                            @{
                                                var remainingSeconds = GetRemainingSeconds(effect);
                                            }
                                            @if (remainingSeconds.HasValue)
                                            {
                                                <span class="badge @GetDurationBadgeClass(remainingSeconds.Value)">
                                                    @TimeFormat.FormatRemaining(remainingSeconds.Value)
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary"><i class="bi bi-infinity me-1"></i>Permanent</span>
                                            }
                                            <i class="bi @(expandedEffects.Contains(effect.Id) ? "bi-chevron-up" : "bi-chevron-down") ms-1"></i>
                                        </div>
                                    </div>

                                    @if (expandedEffects.Contains(effect.Id))
                                    {
                                        <div class="mt-2 pt-2 border-top small">
                                            @if (!string.IsNullOrEmpty(effect.Description))
                                            {
                                                <div class="mb-1">@effect.Description</div>
                                            }
                                            @if (!string.IsNullOrEmpty(effect.Location))
                                            {
                                                <div class="text-muted">Location: @FormatLocation(effect.Location)</div>
                                            }
                                            @if (effect.CurrentStacks > 1)
                                            {
                                                <div class="text-muted">Stacks: @effect.CurrentStacks</div>
                                            }
                                            @if (effect.ExpiresAtEpochSeconds.HasValue && effect.CreatedAtEpochSeconds.HasValue)
                                            {
                                                var totalDurationSeconds = effect.ExpiresAtEpochSeconds.Value - effect.CreatedAtEpochSeconds.Value;
                                                var elapsedSeconds = Character.CurrentGameTimeSeconds - effect.CreatedAtEpochSeconds.Value;
                                                <div class="text-muted">
                                                    Duration: @TimeFormat.FormatProgress(elapsedSeconds, totalDurationSeconds)
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                }
            </div>
        </div>

        <!-- Wounds -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <strong><i class="bi bi-bandaid"></i> Wounds</strong>
                @if (TotalWoundCount > 0)
                {
                    <span class="badge bg-danger">@TotalWoundCount total</span>
                }
            </div>
            <div class="card-body">
                @if (TotalWoundCount == 0)
                {
                    <p class="text-muted mb-0">No wounds</p>
                }
                else
                {
                    <!-- AS Penalty Summary -->
                    <div class="alert alert-warning py-2 mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-arrow-down-circle"></i> Total AS Penalty</span>
                            <strong class="text-danger">@TotalWoundPenalty</strong>
                        </div>
                        <small class="text-muted">Applied to all ability scores</small>
                    </div>

                    <!-- Wound Cards by Location -->
                    <div class="wound-locations">
                        @foreach (var wound in GetActiveWounds())
                        {
                            var woundState = WoundState.Deserialize(wound.BehaviorState);
                            var healingTime = GetWoundHealingTime(wound);
                            var locationIcon = GetLocationIcon(wound.Location);
                            var currentSeverity = woundState.CurrentSeverity ?? woundState.Severity;
                            var originalSeverity = woundState.OriginalSeverity ?? woundState.Severity;

                            <div class="wound-location-row p-2 mb-2 rounded border" style="border-color: var(--color-card-border);">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="bi @locationIcon text-danger"></i>
                                        <div>
                                            <span>@FormatLocation(wound.Location ?? "Unknown")</span>
                                            @if (!string.IsNullOrEmpty(currentSeverity))
                                            {
                                                <br />
                                                <span class="badge @GetSeverityBadgeClass(currentSeverity)" style="font-size: 0.7rem;">
                                                    @currentSeverity
                                                </span>
                                                @if (currentSeverity != originalSeverity)
                                                {
                                                    <small class="text-muted ms-1">(was @originalSeverity)</small>
                                                }
                                            }
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        @if (woundState.SeriousWounds > 0)
                                        {
                                            <span class="badge bg-danger" title="Serious wounds: major damage, periodic VIT drain">
                                                <i class="bi bi-x-circle"></i> @woundState.SeriousWounds
                                            </span>
                                        }
                                        @if (woundState.LightWounds > 0)
                                        {
                                            <span class="badge bg-warning text-dark" title="Light wounds: healing, periodic FAT drain">
                                                <i class="bi bi-dash-circle"></i> @woundState.LightWounds
                                            </span>
                                        }
                                        @if (woundState.IsCrippled)
                                        {
                                            <span class="badge bg-dark" title="Limb is crippled and unusable">CRIPPLED</span>
                                        }
                                        else if (woundState.IsDisabled)
                                        {
                                            <span class="badge bg-secondary" title="Limb is disabled">Disabled</span>
                                        }
                                    </div>
                                </div>
                                @if (healingTime.HasValue)
                                {
                                    <div class="d-flex justify-content-between align-items-center mt-1 small">
                                        <span class="text-muted"><i class="bi bi-bandaid me-1"></i>Heals in:</span>
                                        <span class="badge @GetHealingTimeBadgeClass(healingTime.Value)">
                                            @TimeFormat.FormatRemaining(healingTime.Value)
                                        </span>
                                    </div>
                                }
                                else
                                {
                                    <div class="mt-1 small text-muted">
                                        <i class="bi bi-infinity me-1"></i>Manual healing required
                                    </div>
                                }
                            </div>
                        }
                    </div>

                    <!-- Wound Drain Info -->
                    @if (HasActiveWoundDrain)
                    {
                        <div class="mt-3 p-2 border rounded small" style="border-color: var(--color-card-border);">
                            <div class="fw-bold mb-1"><i class="bi bi-hourglass-split"></i> Wound Effects</div>
                            <div class="text-muted">
                                Every 20 rounds, wounds cause periodic damage:
                                <ul class="mb-0 mt-1">
                                    <li>Serious wounds: 1 VIT + 2 FAT each</li>
                                    <li>Light wounds: 1 FAT each</li>
                                </ul>
                            </div>
                            @{
                                var nextDrainRounds = GetNextWoundDrainRounds();
                                if (nextDrainRounds.HasValue)
                                {
                                    <div class="mt-1">
                                        <span class="text-danger">Next drain in: @nextDrainRounds rounds</span>
                                    </div>
                                }
                            }
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

@code {
#pragma warning disable CS0618 // Using legacy round-based properties for UI display

    [Parameter]
    public GameMechanics.CharacterEdit? Character { get; set; }

    [Parameter]
    public GameMechanics.GamePlay.TableEdit? Table { get; set; }

    /// <summary>
    /// Callback when character is modified (e.g., concentration dropped).
    /// </summary>
    [Parameter]
    public EventCallback OnCharacterChanged { get; set; }

    private HashSet<Guid> expandedEffects = new();

    /// <summary>
    /// Handles concentration being voluntarily dropped.
    /// </summary>
    private async Task HandleConcentrationDropped()
    {
        await OnCharacterChanged.InvokeAsync();
        StateHasChanged();
    }

    // Body locations with their icons
    private static readonly Dictionary<string, string> BodyLocations = new()
    {
        { "Head", "bi-emoji-neutral" },
        { "Torso", "bi-person" },
        { "LeftArm", "bi-hand-index" },
        { "RightArm", "bi-hand-index" },
        { "LeftLeg", "bi-arrow-down" },
        { "RightLeg", "bi-arrow-down" }
    };

    // Percentage calculations
    private int GetFatPercent() => Character?.Fatigue.BaseValue > 0
        ? (int)((double)Character.Fatigue.Value / Character.Fatigue.BaseValue * 100) : 0;

    private int GetVitPercent() => Character?.Vitality.BaseValue > 0
        ? (int)((double)Character.Vitality.Value / Character.Vitality.BaseValue * 100) : 0;

    // Pool styling
    private string GetPoolCardClass(int percent) => percent <= 25 ? "border-danger" : "";

    private string GetPoolValueClass(int percent) =>
        percent <= 25 ? "text-danger" : percent <= 50 ? "text-warning" : "";

    // Calculate next tick amount (half, rounded down, min 1 if any pending)
    private int GetNextTickAmount(int pending) =>
        pending <= 1 ? pending : pending / 2;

    // Wound helpers
    private int TotalWoundCount => Character?.Effects.TotalWoundCount ?? 0;

    private int TotalWoundPenalty
    {
        get
        {
            if (Character?.Effects == null) return 0;

            // Sum actual AS penalties from all wounds (supports custom penalties from Plan 01)
            var woundEffects = Character.Effects.GetEffectsByType(EffectType.Wound).ToList();
            if (!woundEffects.Any()) return 0;

            return woundEffects.Sum(wound =>
            {
                var modifiers = wound.GetAbilityScoreModifiers("AnySkill", "AnyAttr", 0);
                return modifiers.Sum(m => m.Value);
            });
        }
    }

    private bool HasCrippledLimbs => Character?.Effects.GetAllWoundStates()
        .Any(w => w.State.IsCrippled) ?? false;

    private bool HasActiveWoundDrain => TotalWoundCount > 0;

    private WoundState? GetWoundStateForLocation(string location) =>
        Character?.Effects.GetWoundState(location);

    private IEnumerable<GameMechanics.EffectRecord> GetActiveWounds()
    {
        if (Character?.Effects == null) return Enumerable.Empty<GameMechanics.EffectRecord>();
        return Character.Effects
            .Where(e => e.EffectType == EffectType.Wound && e.IsActive)
            .OrderBy(e => e.Location);
    }

    private string GetLocationIcon(string? location) => location switch
    {
        "Head" => "bi-emoji-neutral",
        "Torso" => "bi-person",
        "LeftArm" or "RightArm" => "bi-hand-index",
        "LeftLeg" or "RightLeg" => "bi-arrow-down",
        _ => "bi-bandaid"
    };

    private long? GetWoundHealingTime(GameMechanics.EffectRecord wound)
    {
        // Use EffectRecord's ExpiresAtEpochSeconds (preferred) or legacy WoundState.ExpiryTimeSeconds
        long? expiryTime = wound.ExpiresAtEpochSeconds;
        if (!expiryTime.HasValue && !string.IsNullOrEmpty(wound.BehaviorState))
        {
            var state = WoundState.Deserialize(wound.BehaviorState);
            expiryTime = state.ExpiryTimeSeconds;
        }

        if (!expiryTime.HasValue) return null;

        var currentGameTime = Character?.CurrentGameTimeSeconds ?? 0;
        var remaining = expiryTime.Value - currentGameTime;
        return remaining > 0 ? remaining : 0;
    }

    private string GetHealingTimeBadgeClass(long remainingSeconds)
    {
        if (remainingSeconds < 60) return "bg-success";
        if (remainingSeconds < 600) return "bg-info";
        return "bg-secondary";
    }

    private string GetSeverityBadgeClass(string? severity) => severity switch
    {
        "Critical" => "bg-danger",
        "Severe" => "bg-warning text-dark",
        "Moderate" => "bg-info",
        "Minor" => "bg-secondary",
        _ => "bg-secondary"
    };

    private int? GetNextWoundDrainRounds()
    {
        if (Character?.Effects == null) return null;

        var woundEffects = Character.Effects.GetEffectsByType(EffectType.Wound).Where(e => e.IsActive).ToList();
        if (!woundEffects.Any()) return null;

        // Find the minimum RoundsToDamage across all wound effects
        int? minRounds = null;
        foreach (var wound in woundEffects)
        {
            var state = WoundState.Deserialize(wound.BehaviorState);
            if (state.RoundsToDamage > 0 && (!minRounds.HasValue || state.RoundsToDamage < minRounds))
            {
                minRounds = state.RoundsToDamage;
            }
        }
        return minRounds;
    }

    private string FormatLocation(string location) => location switch
    {
        "LeftArm" => "Left Arm",
        "RightArm" => "Right Arm",
        "LeftLeg" => "Left Leg",
        "RightLeg" => "Right Leg",
        _ => location
    };

    // Effect grouping and display
    private IEnumerable<IGrouping<EffectType, GameMechanics.EffectRecord>> GetGroupedEffects()
    {
        if (Character?.Effects == null) return Enumerable.Empty<IGrouping<EffectType, GameMechanics.EffectRecord>>();

        // Group effects by type, excluding wounds (shown separately)
        return Character.Effects
            .Where(e => e.EffectType != EffectType.Wound && e.IsActive)
            .GroupBy(e => e.EffectType)
            .OrderBy(g => GetEffectTypeOrder(g.Key));
    }

    private int GetEffectTypeOrder(EffectType type) => type switch
    {
        EffectType.Condition => 0,
        EffectType.Debuff => 1,
        EffectType.Poison => 2,
        EffectType.Disease => 3,
        EffectType.Buff => 4,
        EffectType.SpellEffect => 5,
        EffectType.ItemEffect => 6,
        _ => 99
    };

    private string GetEffectGroupName(EffectType type) => type switch
    {
        EffectType.Condition => "Conditions",
        EffectType.Poison => "Poisons",
        EffectType.Disease => "Diseases",
        EffectType.Buff => "Buffs",
        EffectType.Debuff => "Debuffs",
        EffectType.SpellEffect => "Spell Effects",
        EffectType.ItemEffect => "Item Effects",
        EffectType.Environmental => "Environmental",
        _ => "Other Effects"
    };

    private string GetEffectGroupIcon(EffectType type) => type switch
    {
        EffectType.Condition => "bi-exclamation-diamond",
        EffectType.Poison => "bi-moisture",
        EffectType.Disease => "bi-virus",
        EffectType.Buff => "bi-arrow-up-circle",
        EffectType.Debuff => "bi-arrow-down-circle",
        EffectType.SpellEffect => "bi-magic",
        EffectType.ItemEffect => "bi-gem",
        EffectType.Environmental => "bi-cloud",
        _ => "bi-question-diamond"
    };

    private string GetEffectItemClass(GameMechanics.EffectRecord effect) => effect.EffectType switch
    {
        EffectType.Buff => "bg-success bg-opacity-10",
        EffectType.Debuff or EffectType.Poison or EffectType.Disease => "bg-danger bg-opacity-10",
        EffectType.Condition => "bg-purple bg-opacity-10",
        EffectType.SpellEffect => "bg-primary bg-opacity-10",
        EffectType.Concentration => "bg-info bg-opacity-10",
        _ => "bg-light text-dark"
    };

    private string GetEffectIconColor(GameMechanics.EffectRecord effect) => effect.EffectType switch
    {
        EffectType.Buff => "#198754",
        EffectType.Debuff or EffectType.Poison => "#dc3545",
        EffectType.Disease => "#6f42c1",
        EffectType.Condition => "#ffc107",
        EffectType.SpellEffect => "#0d6efd",
        EffectType.ItemEffect => "#20c997",
        _ => "#6c757d"
    };

    private string GetDurationBadgeClass(long remainingSeconds)
    {
        // For short durations (< 1 minute), use round-based thresholds
        if (remainingSeconds < 60)
        {
            var rounds = remainingSeconds / 3;
            return rounds <= 3 ? "bg-danger" : rounds <= 10 ? "bg-warning text-dark" : "bg-info";
        }
        // For longer durations, use time-based thresholds
        if (remainingSeconds < 600) return "bg-info"; // < 10 minutes
        if (remainingSeconds < 3600) return "bg-info"; // < 1 hour
        return "bg-secondary"; // >= 1 hour (long duration)
    }

    private long? GetRemainingSeconds(GameMechanics.EffectRecord effect)
    {
        // For concentration effects, calculate remaining from behavior state
        if (effect.EffectType == EffectType.Concentration && !string.IsNullOrEmpty(effect.BehaviorState))
        {
            var state = ConcentrationState.FromJson(effect.BehaviorState);
            if (state != null)
            {
                var remainingRounds = state.TotalRequired - state.CurrentProgress;
                return remainingRounds * 3; // 3 seconds per round
            }
        }

        if (!effect.ExpiresAtEpochSeconds.HasValue) return null;
        var currentGameTime = Character?.CurrentGameTimeSeconds ?? 0;
        var remaining = effect.ExpiresAtEpochSeconds.Value - currentGameTime;
        return remaining > 0 ? remaining : 0;
    }

    private void ToggleEffectExpansion(Guid effectId)
    {
        if (!expandedEffects.Remove(effectId))
        {
            expandedEffects.Add(effectId);
        }
    }

    private string GetTotalBonusClass(AttributeBonusBreakdown breakdown)
    {
        var totalBonus = breakdown.ItemBonus + breakdown.EffectBonus;
        if (totalBonus > 0) return "text-success";
        if (totalBonus < 0) return "text-danger";
        return "";
    }
}
