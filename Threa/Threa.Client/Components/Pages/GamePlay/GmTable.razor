@page "/gamemaster/table/{TableId:guid}"

@rendermode InteractiveServer

@attribute [Authorize(Roles = "GameMaster,Administrator")]

@implements IDisposable

@using GameMechanics.Messaging
@using GameMechanics.Time
@using Microsoft.AspNetCore.Authorization
@using Radzen
@using Threa.Services
@using Threa.Client.Components.Shared
@using Threa.Dal
@using Threa.Dal.Dto
@using System.Security.Claims

@inject Csla.Blazor.State.StateManager StateManager
@inject RenderModeProvider RenderModeProvider
@inject NavigationManager NavigationManager
@inject IDataPortal<GameMechanics.GamePlay.TableEdit> tablePortal
@inject IDataPortal<GameMechanics.GamePlay.TableCharacterList> characterListPortal
@inject IDataPortal<GameMechanics.CharacterEdit> characterPortal
@inject IActivityLogService ActivityLog
@inject ITimeEventPublisher TimeEventPublisher
@inject IJSRuntime JS
@inject IDataPortal<GameMechanics.GamePlay.JoinRequestList> joinRequestListPortal
@inject IDataPortal<GameMechanics.GamePlay.JoinRequestProcessor> processorPortal
@inject ApplicationContext applicationContext
@inject ITimeEventSubscriber TimeEventSubscriber
@inject DialogService DialogService
@inject TimeAdvancementService TimeAdvancementService
@inject IGameTimeFormatService TimeFormat

<PageTitle>GM Table - @(table?.Name ?? "Loading...")</PageTitle>

@if (errorMessage != null)
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (table == null)
{
    <div>Loading table...</div>
}
else
{
    <!-- Header Bar -->
    <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-dark text-white rounded gm-header">
        <div>
            <h4 class="mb-0">@table.Name</h4>
            <span class="badge @GetStatusBadgeClass()">@table.StatusDisplay</span>
        </div>
        <div class="d-flex gap-2 align-items-center">
            <ThemeSwitcher CurrentTheme="@table.Theme"
                           CanEdit="true"
                           OnThemeChanged="ChangeTheme" />
            <div class="text-end me-3">
                <small class="d-block text-muted">Game Time</small>
                <span class="fw-bold">@TimeFormat.FormatCompact(table.CurrentTimeSeconds)</span>
            </div>
            @if (table.IsInCombat)
            {
                <span class="badge bg-danger fs-6">In Rounds: Round @table.CurrentRound</span>
            }
        </div>
    </div>

    <div class="row">
        <!-- Left Panel: Characters/NPCs -->
        <div class="col-md-6">
            @* Pending Join Requests Section - only shown when requests exist *@
            @if (pendingRequests != null && pendingRequests.Any())
            {
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center bg-warning text-dark">
                        <strong><i class="bi bi-person-plus me-1"></i>Pending Join Requests</strong>
                        <span class="badge bg-dark">@pendingRequests.Count()</span>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        @foreach (var request in pendingRequests)
                        {
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <strong>@request.CharacterName</strong>
                                            <small class="text-muted d-block">@request.Species</small>
                                        </div>
                                        <small class="text-muted">@request.RequestedAt.ToString("MMM d")</small>
                                    </div>

                                    @* Expandable character details *@
                                    <div class="mb-2">
                                        <button class="btn btn-sm btn-outline-secondary"
                                                @onclick="() => ToggleCharacterDetails(request.CharacterId)">
                                            <i class="bi @(expandedCharacterId == request.CharacterId ? "bi-chevron-up" : "bi-eye")"></i>
                                            @(expandedCharacterId == request.CharacterId ? "Hide Details" : "View Character")
                                        </button>
                                    </div>

                                    @if (expandedCharacterId == request.CharacterId && expandedCharacter != null)
                                    {
                                        <div class="border rounded p-2 mb-2" style="font-size: 0.85rem;">
                                            <div class="row">
                                                <div class="col-6">
                                                    <strong>Attributes:</strong>
                                                    <ul class="list-unstyled mb-0 small">
                                                        @foreach (var attr in expandedCharacter.AttributeList)
                                                        {
                                                            <li>@attr.Name: @attr.Value</li>
                                                        }
                                                    </ul>
                                                </div>
                                                <div class="col-6">
                                                    <strong>Health:</strong>
                                                    <ul class="list-unstyled mb-0 small">
                                                        <li>FAT: @expandedCharacter.Fatigue.Value / @expandedCharacter.Fatigue.BaseValue</li>
                                                        <li>VIT: @expandedCharacter.Vitality.Value / @expandedCharacter.Vitality.BaseValue</li>
                                                    </ul>
                                                </div>
                                            </div>
                                            @if (!string.IsNullOrWhiteSpace(expandedCharacter.Description))
                                            {
                                                <div class="mt-2">
                                                    <strong>Description:</strong>
                                                    <p class="mb-0 small">@expandedCharacter.Description</p>
                                                </div>
                                            }
                                        </div>
                                    }

                                    <div class="d-flex gap-2">
                                        <button class="btn btn-success btn-sm flex-grow-1"
                                                disabled="@isProcessingRequest"
                                                @onclick="() => ApproveRequest(request.Id)">
                                            <i class="bi bi-check-lg"></i> Approve
                                        </button>
                                        <button class="btn btn-danger btn-sm flex-grow-1"
                                                disabled="@isProcessingRequest"
                                                @onclick="() => DenyRequest(request.Id)">
                                            <i class="bi bi-x-lg"></i> Deny
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>Characters at Table</strong>
                    <span class="badge bg-primary">@(tableCharacters?.Count() ?? 0)</span>
                </div>
                <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                    @if (tableCharacters == null || !tableCharacters.Any())
                    {
                        <div class="text-center py-4">
                            <i class="bi bi-people fs-1 text-muted"></i>
                            <p class="text-muted mt-2 mb-0">Waiting for players to join</p>
                            <small class="text-muted">Share this link:</small>
                            <div class="mt-1">
                                <code class="small">@GetPlayerJoinLink()</code>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="row row-cols-1 row-cols-lg-2 g-2">
                            @foreach (var character in tableCharacters)
                            {
                                <div class="col" @key="@($"{character.CharacterId}-{characterListVersion}")">
                                    <CharacterStatusCard Character="@character"
                                                        IsSelected="@(selectedCharacter?.CharacterId == character.CharacterId)"
                                                        OnClick="OpenCharacterDetails" />
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            <!-- NPC Placeholder -->
            <NpcPlaceholder />
        </div>

        <!-- Right Panel: Time Controls & Activity -->
        <div class="col-md-6">
            <!-- Time Controls -->
            <div class="card mb-3">
                <div class="card-header">
                    <strong><i class="bi bi-clock-history me-1"></i>TIME CONTROLS</strong>
                </div>
                <div class="card-body">
                    <!-- Current Time Display -->
                    <div class="text-center mb-3 p-2 rounded" style="background: var(--color-bg-tertiary);">
                        <small style="color: var(--color-text-muted);">CURRENT TIME</small>
                        <div class="fw-bold" style="font-family: var(--font-display);">
                            @TimeFormat.FormatCompact(table.CurrentTimeSeconds)
                        </div>
                    </div>

                    @if (table.Status == Threa.Dal.Dto.TableStatus.Lobby)
                    {
                        <div class="mb-3">
                            <label class="form-label">Start Time (in seconds from epoch 0)</label>
                            <input type="number" class="form-control" @bind="table.StartTimeSeconds"
                                   min="0" placeholder="e.g., 0 for beginning of time" />
                            <small class="text-muted">
                                Preview: @TimeFormat.FormatCompact(table.StartTimeSeconds)
                            </small>
                        </div>
                        <button class="btn btn-success btn-lg w-100" @onclick="StartSession">
                            <i class="bi bi-play-fill"></i> Start Session
                        </button>
                    }
                    else if (table.Status == Threa.Dal.Dto.TableStatus.Active)
                    {
                        <!-- Combat Mode Toggle Button -->
                        @if (table.IsInCombat)
                        {
                            <button class="btn btn-outline-success w-100 mb-3" @onclick="ExitCombat">
                                <i class="bi bi-peace"></i> End Combat
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-danger w-100 mb-3" @onclick="EnterCombat">
                                <i class="bi bi-shield-exclamation"></i> Start Combat
                            </button>
                        }

                        <!-- Context-Aware Time Buttons -->
                        @if (table.IsInCombat)
                        {
                            <button class="btn btn-primary w-100" @onclick="AdvanceRound">
                                +1 Round
                            </button>
                        }
                        else
                        {
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary w-100" @onclick="() => AdvanceTime(60)">+1 Min</button>
                                <button class="btn btn-outline-primary w-100" @onclick="() => AdvanceTime(600)">+10 Min</button>
                                <button class="btn btn-outline-primary w-100" @onclick="() => AdvanceTime(3600)">+1 Hour</button>
                                <button class="btn btn-outline-primary w-100" @onclick="() => AdvanceTime(86400)">+1 Day</button>
                                <button class="btn btn-outline-primary w-100" @onclick="() => AdvanceTime(604800)">+1 Week</button>
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- GM Announcement -->
            <div class="card mb-3">
                <div class="card-header">
                    <strong>Send Announcement</strong>
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" class="form-control" @bind="announcementText"
                               placeholder="Message to all players..." />
                        <button class="btn btn-primary" @onclick="SendAnnouncement"
                                disabled="@(string.IsNullOrWhiteSpace(announcementText))">
                            Send
                        </button>
                    </div>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="card">
                <div class="card-header">
                    <strong>Activity Log</strong>
                </div>
                <div class="card-body" style="max-height: 250px; overflow-y: auto;">
                    @if (activityLog.Count == 0)
                    {
                        <p class="text-muted small">No activity yet.</p>
                    }
                    else
                    {
                        @foreach (var entry in activityLog.TakeLast(20).Reverse())
                        {
                            <div class="small mb-1 @GetActivityClass(entry.Category)">
                                <span class="text-muted">[@entry.Timestamp.ToString("HH:mm:ss")]</span>
                                <strong>@entry.Source:</strong> @entry.Message
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>

}

@* RadzenDialog must be in the interactive context for DialogService to work *@
<RadzenDialog />

@code {
    [Parameter]
    public Guid TableId { get; set; }

    private GameMechanics.GamePlay.TableEdit? table;
    private IEnumerable<GameMechanics.GamePlay.TableCharacterInfo>? tableCharacters;
    private GameMechanics.GamePlay.TableCharacterInfo? selectedCharacter;
    private string? errorMessage;
    private List<ActivityLogEntry> activityLog = new();
    private IDisposable? activityLogSubscription;

    // Form fields
    private string announcementText = "";

    // Join request state
    private IEnumerable<GameMechanics.GamePlay.JoinRequestInfo>? pendingRequests;
    private int? expandedCharacterId;
    private GameMechanics.CharacterEdit? expandedCharacter;
    private bool isProcessingRequest;
    private bool timeEventSubscribed;
    private bool _disposed;

    // Version counter to force re-render of character cards
    private int characterListVersion = 0;

    private record ActivityLogEntry(DateTime Timestamp, string Message, string Source, ActivityCategory Category);

    protected override async Task OnInitializedAsync()
    {
        await StateManager.InitializeAsync();

        if (RenderModeProvider.GetRenderMode(this).IsInteractive())
        {
            await LoadTable();
            SubscribeToActivityLog();
            await TimeEventPublisher.ConnectAsync();
            await SubscribeToTimeEventsAsync();
        }
    }

    private async Task SubscribeToTimeEventsAsync()
    {
        if (timeEventSubscribed) return;

        await TimeEventSubscriber.ConnectAsync();
        await TimeEventSubscriber.SubscribeAsync();

        TimeEventSubscriber.TimeEventReceived += OnTimeEventReceived;
        TimeEventSubscriber.TimeSkipReceived += OnTimeSkipReceived;
        TimeEventSubscriber.CharacterUpdateReceived += OnCharacterUpdateReceived;
        TimeEventSubscriber.JoinRequestReceived += OnJoinRequestReceived;
        timeEventSubscribed = true;
    }

    private void OnTimeEventReceived(object? sender, TimeEventMessage e)
    {
        // NOTE: Time processing is now done server-side by TimeAdvancementService.
        // This handler is kept for any additional time event notifications but 
        // character updates are handled via CharactersUpdatedReceived.
        Console.WriteLine($"[GmTable] OnTimeEventReceived: EventType={e.EventType}, CampaignId={e.CampaignId}, TableId={table?.Id}");

        // Ignore events if component is disposed or not our table
        if (_disposed || table == null || e.CampaignId != table.Id.ToString())
        {
            return;
        }

        // Just update the table state (no delayed character refresh needed)
        _ = InvokeAsync(async () =>
        {
            try
            {
                // Refresh table to show updated round/time
                table = await tablePortal.FetchAsync(table.Id);
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[GmTable] OnTimeEventReceived error: {ex.Message}");
            }
        });
    }

    private void OnTimeSkipReceived(object? sender, TimeSkipMessage e)
    {
        // NOTE: Time processing is now done server-side by TimeAdvancementService.
        // This handler is kept for any additional time skip notifications but
        // character updates are handled via CharactersUpdatedReceived.
        Console.WriteLine($"[GmTable] OnTimeSkipReceived: CampaignId={e.CampaignId}, TableId={table?.Id}, SkipUnit={e.SkipUnit}");

        // Ignore events if component is disposed or not our table
        if (_disposed || table == null || e.CampaignId != table.Id.ToString())
        {
            return;
        }

        // Just update the table state (no delayed character refresh needed)
        _ = InvokeAsync(async () =>
        {
            try
            {
                // Refresh table to show updated time
                table = await tablePortal.FetchAsync(table.Id);
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[GmTable] OnTimeSkipReceived error: {ex.Message}");
            }
        });
    }

    private void OnCharacterUpdateReceived(object? sender, CharacterUpdateMessage e)
    {
        Console.WriteLine($"[GmTable] OnCharacterUpdateReceived: CharId={e.CharacterId}, CampaignId={e.CampaignId}, TableId={table?.Id}");

        // Ignore events if component is disposed
        if (_disposed)
        {
            Console.WriteLine("[GmTable] OnCharacterUpdateReceived: disposed, skipping");
            return;
        }

        // Only process updates for characters at this table
        // Check by CampaignId if available, otherwise check if character is in our list
        if (!string.IsNullOrEmpty(e.CampaignId) && table != null && e.CampaignId != table.Id.ToString())
        {
            Console.WriteLine($"[GmTable] OnCharacterUpdateReceived: CampaignId mismatch, skipping");
            return;
        }

        Console.WriteLine("[GmTable] OnCharacterUpdateReceived: triggering refresh");
        // Refresh character list when a character is updated
        _ = InvokeAsync(async () =>
        {
            try
            {
                await RefreshCharacterListAsync();
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[GmTable] OnCharacterUpdateReceived error: {ex.Message}");
            }
        });
    }

    private void OnJoinRequestReceived(object? sender, JoinRequestMessage e)
    {
        // Ignore events if component is disposed or not relevant to our table
        if (_disposed || table == null || e.TableId != table.Id || e.Status != JoinRequestStatus.Pending)
            return;

        // Refresh the pending requests list to show the new request
        _ = InvokeAsync(async () =>
        {
            await LoadPendingRequests();
            StateHasChanged();
        });
    }

    private async Task RefreshCharacterListAsync()
    {
        try
        {
            Console.WriteLine($"[GmTable] RefreshCharacterListAsync starting, version={characterListVersion}");
            var charList = await characterListPortal.FetchAsync(TableId);
            // Materialize to a new list to ensure Blazor detects the change
            tableCharacters = charList.ToList();

            // Log the fetched values for debugging
            foreach (var c in tableCharacters)
            {
                Console.WriteLine($"[GmTable] Fetched {c.CharacterName}: FAT={c.FatValue}/{c.FatMax} (pending dmg={c.FatPendingDamage}), VIT={c.VitValue}/{c.VitMax} (pending dmg={c.VitPendingDamage})");
            }

            // Update selected character reference if it still exists
            if (selectedCharacter != null)
            {
                selectedCharacter = tableCharacters.FirstOrDefault(c => c.CharacterId == selectedCharacter.CharacterId);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[GmTable] RefreshCharacterListAsync error: {ex.Message}");
        }
        finally
        {
            // Always increment version to force re-render of character cards
            // even if fetch failed - this ensures UI stays responsive
            characterListVersion++;
            Console.WriteLine($"[GmTable] RefreshCharacterListAsync complete, new version={characterListVersion}");
        }
    }

    private async Task UnsubscribeFromTimeEventsAsync()
    {
        if (!timeEventSubscribed) return;

        TimeEventSubscriber.TimeEventReceived -= OnTimeEventReceived;
        TimeEventSubscriber.TimeSkipReceived -= OnTimeSkipReceived;
        TimeEventSubscriber.CharacterUpdateReceived -= OnCharacterUpdateReceived;
        TimeEventSubscriber.JoinRequestReceived -= OnJoinRequestReceived;
        await TimeEventSubscriber.UnsubscribeAsync();
        timeEventSubscribed = false;
    }

    private void SubscribeToActivityLog()
    {
        activityLogSubscription = ActivityLog.Subscribe(TableId, msg =>
        {
            InvokeAsync(() =>
            {
                activityLog.Add(new ActivityLogEntry(msg.Timestamp, msg.Message, msg.Source, msg.Category));
                if (activityLog.Count > 100) activityLog.RemoveAt(0);
                StateHasChanged();
            });
        });
    }

    public async void Dispose()
    {
        if (_disposed) return;
        _disposed = true;

        activityLogSubscription?.Dispose();
        await UnsubscribeFromTimeEventsAsync();
        // Note: TimeEventPublisher is a singleton service, do not dispose
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        // Initialize tooltips after each render since cards may have changed
        if (tableCharacters?.Any() == true)
        {
            await JS.InvokeVoidAsync("reinitializeTooltipsAfterDelay", 50);
        }
    }

    private async Task LoadTable()
    {
        try
        {
            table = await tablePortal.FetchAsync(TableId);
            var charList = await characterListPortal.FetchAsync(TableId);
            // Materialize to a list to ensure consistent behavior with RefreshCharacterListAsync
            tableCharacters = charList.ToList();

            // Apply the table's theme
            if (table != null)
            {
                await JS.InvokeVoidAsync("threaTheme.apply", table.Theme ?? "fantasy");
            }

            // Load pending join requests
            await LoadPendingRequests();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load table: {ex.Message}";
        }
    }

    private async Task LoadPendingRequests()
    {
        try
        {
            var list = await joinRequestListPortal.FetchAsync(TableId);
            pendingRequests = list.AsEnumerable();
        }
        catch
        {
            pendingRequests = Enumerable.Empty<GameMechanics.GamePlay.JoinRequestInfo>();
        }
    }

    private async Task ChangeTheme(string newTheme)
    {
        if (table == null) return;

        table.Theme = newTheme;
        await SaveTable();

        // Apply theme immediately
        await JS.InvokeVoidAsync("threaTheme.apply", newTheme);

        AddLogEntry($"Theme changed to {(newTheme == "scifi" ? "Neon Circuit (Sci-Fi)" : "Arcanum (Fantasy)")}", ActivityCategory.Session);

        // Notify all players that theme changed via a table update message
        await TimeEventPublisher.PublishTableUpdateAsync(new TableUpdateMessage
        {
            TableId = table.Id,
            UpdateType = "ThemeChanged",
            Theme = newTheme
        });
    }

    private void AddLogEntry(string message, ActivityCategory category = ActivityCategory.General)
    {
        ActivityLog.Publish(TableId, message, "GM", category);
    }

    private async Task StartSession()
    {
        if (table == null) return;
        table.StartSession();
        await SaveTable();
        AddLogEntry("Session started", ActivityCategory.Session);

        // Announce the current game time to all players
        var timeDisplay = TimeFormat.FormatFull(table.CurrentTimeSeconds);
        AddLogEntry($"The in-game time is: {timeDisplay}", ActivityCategory.Time);
    }

    private async Task PauseSession()
    {
        if (table == null) return;
        table.PauseSession();
        await SaveTable();
        AddLogEntry("Session paused", ActivityCategory.Session);
    }

    private async Task ResumeSession()
    {
        if (table == null) return;
        table.ResumeSession();
        await SaveTable();
        AddLogEntry("Session resumed", ActivityCategory.Session);
    }

    private async Task EndSession()
    {
        if (table == null) return;
        table.EndSession();
        await SaveTable();
        AddLogEntry("Session ended", ActivityCategory.Session);
    }

    private async Task AdvanceRound()
    {
        if (table == null) return;
        table.AdvanceRound();
        await SaveTable();
        AddLogEntry($"Advanced to round {table.CurrentRound}", ActivityCategory.Time);

        // Process time advancement for all characters at the table
        // The TimeAdvancementService handles:
        // 1. Loading all characters attached to the table
        // 2. Processing end-of-round effects on each character
        // 3. Saving each character
        // 4. Publishing a notification so player clients can refresh their displays
        var result = await TimeAdvancementService.AdvanceRoundsAsync(
            table.Id, 
            roundCount: 1, 
            currentTableTimeSeconds: table.CurrentTimeSeconds);

        if (!result.Success)
        {
            foreach (var error in result.Errors)
            {
                AddLogEntry($"Error: {error}", ActivityCategory.General);
            }
        }

        // Refresh character list to show updated state
        await RefreshCharacterListAsync();
        StateHasChanged();
    }

    private async Task EnterCombat()
    {
        if (table == null) return;
        table.EnterCombat();
        await SaveTable();
        AddLogEntry("Combat started!", ActivityCategory.Combat);

        // Publish combat state change
        await TimeEventPublisher.PublishCombatStateAsync(new CombatStateMessage
        {
            EnteringCombat = true,
            CampaignId = table.Id.ToString(),
            SourceId = "GM",
            EncounterName = "Combat"
        });
    }

    private async Task ExitCombat()
    {
        if (table == null) return;
        table.ExitCombat();
        await SaveTable();
        AddLogEntry("Combat ended", ActivityCategory.Combat);

        // Publish combat state change
        await TimeEventPublisher.PublishCombatStateAsync(new CombatStateMessage
        {
            EnteringCombat = false,
            CampaignId = table.Id.ToString(),
            SourceId = "GM"
        });
    }

    private async Task AdvanceTime(int seconds)
    {
        if (table == null) return;

        table.AdvanceTime(seconds);
        await SaveTable();

        // Determine the appropriate event type and format for logging
        var (timeEventType, timeDescription, count) = seconds switch
        {
            60 => (GameMechanics.Time.TimeEventType.EndOfMinute, "1 minute", 1),
            600 => (GameMechanics.Time.TimeEventType.EndOfTurn, "1 turn (10 minutes)", 1),
            3600 => (GameMechanics.Time.TimeEventType.EndOfHour, "1 hour", 1),
            86400 => (GameMechanics.Time.TimeEventType.EndOfDay, "1 day", 1),
            604800 => (GameMechanics.Time.TimeEventType.EndOfWeek, "1 week", 1),
            _ => (GameMechanics.Time.TimeEventType.EndOfMinute, $"{seconds} seconds", seconds / 60)
        };

        AddLogEntry($"Advanced time by {timeDescription}", ActivityCategory.Time);

        // Process time advancement for all characters at the table
        // The TimeAdvancementService handles:
        // 1. Loading all characters attached to the table
        // 2. Processing time skip effects on each character (recovery, effect expiration)
        // 3. Saving each character
        // 4. Publishing a notification so player clients can refresh their displays
        var result = await TimeAdvancementService.ProcessTimeSkipAsync(
            table.Id,
            timeEventType,
            count,
            currentTableTimeSeconds: table.CurrentTimeSeconds);

        if (!result.Success)
        {
            foreach (var error in result.Errors)
            {
                AddLogEntry($"Error: {error}", ActivityCategory.General);
            }
        }

        // Refresh character list to show updated state
        await RefreshCharacterListAsync();
        StateHasChanged();
    }

    /// <summary>
    /// Schedules multiple delayed refreshes to catch character updates from players.
    /// This is a fallback mechanism in case CharacterUpdateReceived messages are missed.
    /// NOTE: This method is deprecated - time processing is now server-side in TimeAdvancementService.
    /// </summary>
    [Obsolete("Time processing is now server-side. This method is no longer needed.")]
    private async Task ScheduleDelayedRefreshesAsync()
    {
        // No-op: time processing is now done server-side by TimeAdvancementService
        await Task.CompletedTask;
    }

    private void SendAnnouncement()
    {
        if (string.IsNullOrWhiteSpace(announcementText)) return;
        AddLogEntry(announcementText, ActivityCategory.Announcement);
        announcementText = "";
    }

    private async Task SaveTable()
    {
        if (table == null) return;
        try
        {
            await tablePortal.UpdateAsync(table);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to save: {ex.Message}";
        }
    }

    private void SelectCharacter(GameMechanics.GamePlay.TableCharacterInfo character)
    {
        selectedCharacter = character;
    }

    private async Task OpenCharacterDetails(GameMechanics.GamePlay.TableCharacterInfo character)
    {
        // Select the character for item distribution
        selectedCharacter = character;

        try
        {
            var result = await DialogService.OpenAsync<CharacterDetailModal>(
                character.CharacterName,
                new Dictionary<string, object>
                {
                    { "CharacterId", character.CharacterId },
                    { "TableId", TableId },
                    { "AllCharacters", tableCharacters ?? Enumerable.Empty<GameMechanics.GamePlay.TableCharacterInfo>() }
                },
                new DialogOptions
                {
                    Width = "90%",
                    Height = "90%",
                    CloseDialogOnOverlayClick = true,
                    ShowClose = false  // We have our own close button
                });

            // If character was removed via modal, refresh the list
            if (result as string == "removed")
            {
                AddLogEntry($"Removed {character.CharacterName} from table", ActivityCategory.Player);
                await RefreshCharacterListAsync();
                selectedCharacter = null;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to open character details: {ex.Message}";
            AddLogEntry($"Error opening modal: {ex.Message}", ActivityCategory.General);
        }
    }

    private string GetPlayerJoinLink() =>
        NavigationManager.ToAbsoluteUri($"/play/join/{TableId}").ToString();

    private string GetStatusBadgeClass() =>
        table?.Status switch
        {
            Threa.Dal.Dto.TableStatus.Lobby => "bg-info",
            Threa.Dal.Dto.TableStatus.Active => "bg-success",
            Threa.Dal.Dto.TableStatus.Paused => "bg-warning",
            Threa.Dal.Dto.TableStatus.Ended => "bg-secondary",
            _ => "bg-secondary"
        };

    private string GetConnectionBadgeClass(Threa.Dal.Dto.ConnectionStatus status) =>
        status switch
        {
            Threa.Dal.Dto.ConnectionStatus.Connected => "bg-success",
            Threa.Dal.Dto.ConnectionStatus.Disconnected => "bg-danger",
            Threa.Dal.Dto.ConnectionStatus.Away => "bg-warning",
            _ => "bg-secondary"
        };

    private string GetConnectionIndicatorClass(Threa.Dal.Dto.ConnectionStatus status) =>
        status switch
        {
            Threa.Dal.Dto.ConnectionStatus.Connected => "connected",
            Threa.Dal.Dto.ConnectionStatus.Disconnected => "disconnected",
            Threa.Dal.Dto.ConnectionStatus.Away => "away",
            _ => ""
        };

    private string? GetHealthStatus(GameMechanics.GamePlay.TableCharacterInfo character)
    {
        var fatPercent = GetPercent(character.FatValue, character.FatMax);
        var vitPercent = GetPercent(character.VitValue, character.VitMax);

        if (character.FatValue <= 0) return "UNCONSCIOUS";
        if (vitPercent <= 25) return "CRITICAL";
        if (fatPercent <= 25) return "EXHAUSTED";
        if (vitPercent <= 50) return "INJURED";

        return null;
    }

    private string GetHealthStatusBadgeClass(GameMechanics.GamePlay.TableCharacterInfo character)
    {
        var fatPercent = GetPercent(character.FatValue, character.FatMax);
        var vitPercent = GetPercent(character.VitValue, character.VitMax);

        if (character.FatValue <= 0) return "bg-dark";
        if (vitPercent <= 25) return "bg-danger";
        if (fatPercent <= 25) return "bg-warning text-dark";
        if (vitPercent <= 50) return "bg-warning text-dark";

        return "bg-secondary";
    }

    private int GetPercent(int value, int max) =>
        max > 0 ? (value * 100 / max) : 0;

    private string GetActivityClass(ActivityCategory category) =>
        category switch
        {
            ActivityCategory.Combat => "text-danger",
            ActivityCategory.Announcement => "text-primary fw-bold",
            ActivityCategory.Health => "text-success",
            ActivityCategory.Effect => "text-warning",
            ActivityCategory.Time => "text-info",
            ActivityCategory.Session => "text-secondary fst-italic",
            ActivityCategory.Player => "text-muted",
            _ => ""
        };

    // Join Request Methods
    private async Task ToggleCharacterDetails(int characterId)
    {
        if (expandedCharacterId == characterId)
        {
            expandedCharacterId = null;
            expandedCharacter = null;
        }
        else
        {
            expandedCharacterId = characterId;
            try
            {
                expandedCharacter = await characterPortal.FetchAsync(characterId);
            }
            catch
            {
                expandedCharacter = null;
            }
        }
    }

    private async Task ApproveRequest(Guid requestId)
    {
        if (table == null) return;
        isProcessingRequest = true;

        try
        {
            var gameMasterId = GetCurrentUserId();
            var result = await processorPortal.ExecuteAsync(requestId, true, gameMasterId);

            if (result.Success)
            {
                AddLogEntry($"Approved join request for {result.CharacterName}", ActivityCategory.Player);
                await LoadPendingRequests();
                var charList = await characterListPortal.FetchAsync(TableId);
                tableCharacters = charList.AsEnumerable();
            }
            else
            {
                errorMessage = result.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to approve: {ex.Message}";
        }
        finally
        {
            isProcessingRequest = false;
            expandedCharacterId = null;
            expandedCharacter = null;
        }
    }

    private async Task DenyRequest(Guid requestId)
    {
        if (table == null) return;
        isProcessingRequest = true;

        try
        {
            var gameMasterId = GetCurrentUserId();
            var result = await processorPortal.ExecuteAsync(requestId, false, gameMasterId);

            if (result.Success)
            {
                AddLogEntry($"Denied join request for {result.CharacterName}", ActivityCategory.Player);
                await LoadPendingRequests();
            }
            else
            {
                errorMessage = result.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to deny: {ex.Message}";
        }
        finally
        {
            isProcessingRequest = false;
        }
    }

    private int GetCurrentUserId()
    {
        return int.Parse(applicationContext.Principal.Claims
            .First(c => c.Type == ClaimTypes.NameIdentifier).Value);
    }
}
