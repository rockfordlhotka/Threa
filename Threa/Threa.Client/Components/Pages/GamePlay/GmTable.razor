@page "/gamemaster/table/{TableId:guid}"

@rendermode InteractiveServer

@attribute [Authorize(Roles = "GameMaster,Administrator")]

@implements IDisposable

@using GameMechanics.Messaging
@using GameMechanics.Time
@using Microsoft.AspNetCore.Authorization
@using Radzen
@using Threa.Services
@using Threa.Client.Components.Shared
@using Threa.Dal
@using Threa.Dal.Dto
@using System.Security.Claims

@inject Csla.Blazor.State.StateManager StateManager
@inject RenderModeProvider RenderModeProvider
@inject NavigationManager NavigationManager
@inject IDataPortal<GameMechanics.GamePlay.TableEdit> tablePortal
@inject IDataPortal<GameMechanics.GamePlay.TableCharacterList> characterListPortal
@inject IDataPortal<GameMechanics.CharacterEdit> characterPortal
@inject IChildDataPortal<GameMechanics.EffectRecord> effectPortal
@inject IActivityLogService ActivityLog
@inject ITimeEventPublisher TimeEventPublisher
@inject IJSRuntime JS
@inject IItemTemplateDal itemTemplateDal
@inject GameMechanics.Items.ItemManagementService itemManagementService
@inject IDataPortal<GameMechanics.GamePlay.JoinRequestList> joinRequestListPortal
@inject IDataPortal<GameMechanics.GamePlay.JoinRequestProcessor> processorPortal
@inject IDataPortal<GameMechanics.GamePlay.TableCharacterDetacher> detacherPortal
@inject ApplicationContext applicationContext
@inject ITimeEventSubscriber TimeEventSubscriber
@inject DialogService DialogService

<PageTitle>GM Table - @(table?.Name ?? "Loading...")</PageTitle>

@if (errorMessage != null)
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (table == null)
{
    <div>Loading table...</div>
}
else
{
    <!-- Header Bar -->
    <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-dark text-white rounded gm-header">
        <div>
            <h4 class="mb-0">@table.Name</h4>
            <span class="badge @GetStatusBadgeClass()">@table.StatusDisplay</span>
        </div>
        <div class="d-flex gap-2 align-items-center">
            <ThemeSwitcher CurrentTheme="@table.Theme"
                           CanEdit="true"
                           OnThemeChanged="ChangeTheme" />
            <div class="text-end me-3">
                <small class="d-block text-muted">Game Time</small>
                <span class="fw-bold">@GameTimeFormatter.FormatCompact(table.CurrentTimeSeconds)</span>
            </div>
            <span class="badge bg-info fs-5">Round @table.CurrentRound</span>
            @if (table.IsInCombat)
            {
                <span class="badge bg-danger">COMBAT</span>
            }
        </div>
    </div>

    <div class="row">
        <!-- Left Panel: Characters/NPCs -->
        <div class="col-md-4">
            @* Pending Join Requests Section - only shown when requests exist *@
            @if (pendingRequests != null && pendingRequests.Any())
            {
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center bg-warning text-dark">
                        <strong><i class="bi bi-person-plus me-1"></i>Pending Join Requests</strong>
                        <span class="badge bg-dark">@pendingRequests.Count()</span>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        @foreach (var request in pendingRequests)
                        {
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <strong>@request.CharacterName</strong>
                                            <small class="text-muted d-block">@request.Species</small>
                                        </div>
                                        <small class="text-muted">@request.RequestedAt.ToString("MMM d")</small>
                                    </div>

                                    @* Expandable character details *@
                                    <div class="mb-2">
                                        <button class="btn btn-sm btn-outline-secondary"
                                                @onclick="() => ToggleCharacterDetails(request.CharacterId)">
                                            <i class="bi @(expandedCharacterId == request.CharacterId ? "bi-chevron-up" : "bi-eye")"></i>
                                            @(expandedCharacterId == request.CharacterId ? "Hide Details" : "View Character")
                                        </button>
                                    </div>

                                    @if (expandedCharacterId == request.CharacterId && expandedCharacter != null)
                                    {
                                        <div class="border rounded p-2 mb-2 bg-light" style="font-size: 0.85rem;">
                                            <div class="row">
                                                <div class="col-6">
                                                    <strong>Attributes:</strong>
                                                    <ul class="list-unstyled mb-0 small">
                                                        @foreach (var attr in expandedCharacter.AttributeList)
                                                        {
                                                            <li>@attr.Name: @attr.Value</li>
                                                        }
                                                    </ul>
                                                </div>
                                                <div class="col-6">
                                                    <strong>Health:</strong>
                                                    <ul class="list-unstyled mb-0 small">
                                                        <li>FAT: @expandedCharacter.Fatigue.Value / @expandedCharacter.Fatigue.BaseValue</li>
                                                        <li>VIT: @expandedCharacter.Vitality.Value / @expandedCharacter.Vitality.BaseValue</li>
                                                    </ul>
                                                </div>
                                            </div>
                                            @if (!string.IsNullOrWhiteSpace(expandedCharacter.Description))
                                            {
                                                <div class="mt-2">
                                                    <strong>Description:</strong>
                                                    <p class="mb-0 small">@expandedCharacter.Description</p>
                                                </div>
                                            }
                                        </div>
                                    }

                                    <div class="d-flex gap-2">
                                        <button class="btn btn-success btn-sm flex-grow-1"
                                                disabled="@isProcessingRequest"
                                                @onclick="() => ApproveRequest(request.Id)">
                                            <i class="bi bi-check-lg"></i> Approve
                                        </button>
                                        <button class="btn btn-danger btn-sm flex-grow-1"
                                                disabled="@isProcessingRequest"
                                                @onclick="() => DenyRequest(request.Id)">
                                            <i class="bi bi-x-lg"></i> Deny
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>Characters at Table</strong>
                    <span class="badge bg-primary">@(tableCharacters?.Count() ?? 0)</span>
                </div>
                <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                    @if (tableCharacters == null || !tableCharacters.Any())
                    {
                        <div class="text-center py-4">
                            <i class="bi bi-people fs-1 text-muted"></i>
                            <p class="text-muted mt-2 mb-0">Waiting for players to join</p>
                            <small class="text-muted">Share this link:</small>
                            <div class="mt-1">
                                <code class="small">@GetPlayerJoinLink()</code>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="row row-cols-1 row-cols-lg-2 g-2">
                            @foreach (var character in tableCharacters)
                            {
                                <div class="col">
                                    <CharacterStatusCard Character="@character"
                                                        IsSelected="@(selectedCharacter?.CharacterId == character.CharacterId)"
                                                        OnClick="OpenCharacterDetails" />
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            <!-- NPCs Panel -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>NPCs</strong>
                    <button class="btn btn-sm btn-outline-primary" @onclick="AddNpc">+ Add NPC</button>
                </div>
                <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                    @if (npcs == null || !npcs.Any())
                    {
                        <p class="text-muted small">No NPCs at this table.</p>
                    }
                    else
                    {
                        @foreach (var npc in npcs)
                        {
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>@npc.Name</span>
                                <button class="btn btn-sm btn-outline-danger"
                                        @onclick="() => RemoveNpc(npc.Id)">Remove</button>
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- Item Distribution Panel -->
            <div class="card mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>Item Distribution</strong>
                </div>
                <div class="card-body">
                    <!-- Search and Filter -->
                    <div class="mb-2">
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" placeholder="Search items..."
                                   @bind="itemSearchText" @bind:event="oninput" />
                            <select class="form-select" @bind="selectedItemType" style="max-width: 100px;">
                                <option value="">All</option>
                                @foreach (var type in itemTypes)
                                {
                                    <option value="@type">@type</option>
                                }
                            </select>
                        </div>
                    </div>

                    <!-- Item List -->
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px;">
                        @if (!filteredTemplates.Any())
                        {
                            <p class="text-muted small p-2 mb-0">No items found.</p>
                        }
                        else
                        {
                            @foreach (var template in filteredTemplates)
                            {
                                <div class="p-2 border-bottom item-row @(selectedTemplate?.Id == template.Id ? "bg-primary text-white" : "")"
                                     style="cursor: pointer;"
                                     @onclick="() => SelectTemplate(template)">
                                    <strong>@template.Name</strong>
                                    <small class="ms-1 @(selectedTemplate?.Id == template.Id ? "" : "text-muted")">(@template.ItemType)</small>
                                </div>
                            }
                        }
                    </div>

                    <!-- Grant Controls -->
                    @if (selectedTemplate != null && selectedCharacter != null)
                    {
                        <div class="mt-2 p-2 bg-light rounded">
                            <div class="small mb-1">
                                Grant <strong>@selectedTemplate.Name</strong> to <strong>@selectedCharacter.CharacterName</strong>
                            </div>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">Qty</span>
                                <input type="number" class="form-control" @bind="grantQuantity"
                                       min="1" max="@(selectedTemplate.IsStackable ? 999 : 1)" style="max-width: 80px;" />
                                <button class="btn btn-success" @onclick="GrantItemToCharacter">
                                    <i class="bi bi-gift"></i> Grant
                                </button>
                            </div>
                            @if (!selectedTemplate.IsStackable && grantQuantity > 1)
                            {
                                <small class="text-warning">This item is not stackable. Quantity will be 1.</small>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted small mt-2 mb-0">Select an item and a character to grant.</p>
                    }
                </div>
            </div>
        </div>

        <!-- Center Panel: Selected Entity Details -->
        <div class="col-md-4">
            @if (selectedCharacter != null)
            {
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <strong>@selectedCharacter.CharacterName</strong>
                    </div>
                    <div class="card-body">
                        <p><strong>Species:</strong> @selectedCharacter.Species</p>
                        <p><strong>FAT:</strong> @selectedCharacter.FatValue / @selectedCharacter.FatMax</p>
                        <p><strong>VIT:</strong> @selectedCharacter.VitValue / @selectedCharacter.VitMax</p>
                        <p><strong>AP:</strong> @selectedCharacter.ActionPoints / @selectedCharacter.ActionPointMax</p>

                        <hr />

                        <h6>Apply Damage</h6>
                        <div class="input-group mb-2">
                            <input type="number" class="form-control" placeholder="Amount" @bind="damageAmount" min="1" />
                            <select class="form-select" @bind="damageType" style="max-width: 120px;">
                                <option value="FAT">FAT</option>
                                <option value="VIT">VIT</option>
                            </select>
                            <button class="btn btn-danger" @onclick="ApplyDamage">Apply</button>
                        </div>

                        <h6>Apply Healing</h6>
                        <div class="input-group mb-2">
                            <input type="number" class="form-control" placeholder="Amount" @bind="healAmount" min="1" />
                            <select class="form-select" @bind="healType" style="max-width: 120px;">
                                <option value="FAT">FAT</option>
                                <option value="VIT">VIT</option>
                            </select>
                            <button class="btn btn-success" @onclick="ApplyHealing">Apply</button>
                        </div>

                        <h6>Apply Effect</h6>
                        <div class="input-group mb-2">
                            <select class="form-select" @bind="selectedEffect">
                                <option value="">Select effect...</option>
                                <option value="Stunned">Stunned</option>
                                <option value="Blinded">Blinded</option>
                                <option value="Prone">Prone</option>
                            </select>
                            <button class="btn btn-warning" @onclick="ApplyEffect"
                                    disabled="@(string.IsNullOrEmpty(selectedEffect))">Apply</button>
                        </div>

                        <hr />

                        <div class="d-grid">
                            <button class="btn btn-outline-danger" @onclick="() => ConfirmRemoveCharacter(selectedCharacter)">
                                <i class="bi bi-x-circle me-1"></i>Remove from Table
                            </button>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="card">
                    <div class="card-body text-center text-muted">
                        <p>Select a character to view details and apply actions.</p>
                    </div>
                </div>
            }
        </div>

        <!-- Right Panel: Time Controls & Activity -->
        <div class="col-md-4">
            <!-- Time Controls -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong><i class="bi bi-clock-history"></i> TIME CONTROLS</strong>
                    <span class="badge bg-info">Round @table.CurrentRound</span>
                </div>
                <div class="card-body">
                    <!-- Current Time Display -->
                    <div class="text-center mb-3 p-2 rounded" style="background: var(--color-bg-tertiary);">
                        <small style="color: var(--color-text-muted);">CURRENT TIME</small>
                        <div class="fw-bold" style="font-family: var(--font-display);">
                            @GameTimeFormatter.FormatCompact(table.CurrentTimeSeconds)
                        </div>
                    </div>

                    @if (table.Status == Threa.Dal.Dto.TableStatus.Lobby)
                    {
                        <div class="mb-3">
                            <label class="form-label">Start Time (in seconds from epoch 0)</label>
                            <input type="number" class="form-control" @bind="table.StartTimeSeconds"
                                   min="0" placeholder="e.g., 0 for beginning of time" />
                            <small class="text-muted">
                                Preview: @GameTimeFormatter.FormatCompact(table.StartTimeSeconds)
                            </small>
                        </div>
                        <button class="btn btn-success btn-lg w-100" @onclick="StartSession">
                            <i class="bi bi-play-fill"></i> Start Session
                        </button>
                    }
                    else if (table.Status == Threa.Dal.Dto.TableStatus.Active)
                    {
                        @if (table.IsInCombat)
                        {
                            <!-- Round Advancement (Combat Mode) -->
                            <div class="mb-3">
                                <div class="d-flex gap-2 mb-2">
                                    <button class="btn btn-primary flex-grow-1" @onclick="AdvanceRound">
                                        +1 Round
                                    </button>
                                    <button class="btn btn-outline-primary" @onclick="() => AdvanceRoundsQuick(5)">
                                        +5
                                    </button>
                                    <button class="btn btn-outline-primary" @onclick="() => AdvanceRoundsQuick(10)">
                                        +10
                                    </button>
                                </div>

                                <!-- Custom Advance -->
                                <div class="input-group">
                                    <input type="number" class="form-control" @bind="roundsToAdvance"
                                           min="1" max="100" placeholder="Custom rounds" />
                                    <button class="btn btn-outline-primary" @onclick="AdvanceMultipleRounds">
                                        Advance
                                    </button>
                                </div>
                            </div>
                        }
                        else
                        {
                            <!-- Time Advancement (Non-Combat) -->
                            <div class="mb-3">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary btn-sm" @onclick="() => AdvanceTime(60)">
                                        +1 Minute
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" @onclick="() => AdvanceTime(600)">
                                        +1 Turn (10 min)
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" @onclick="() => AdvanceTime(3600)">
                                        +1 Hour
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" @onclick="() => AdvanceTime(86400)">
                                        +1 Day
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" @onclick="() => AdvanceTime(604800)">
                                        +1 Week
                                    </button>
                                </div>
                            </div>
                        }

                        <hr />

                        <!-- Combat Mode Toggle -->
                        <div class="d-flex align-items-center justify-content-between">
                            <span style="font-family: var(--font-display);">COMBAT MODE</span>
                            @if (table.IsInCombat)
                            {
                                <span class="badge bg-danger me-2">ACTIVE</span>
                            }
                        </div>
                        @if (table.IsInCombat)
                        {
                            <button class="btn btn-outline-success w-100 mt-2" @onclick="ExitCombat">
                                <i class="bi bi-peace"></i> End Combat
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-danger w-100 mt-2" @onclick="EnterCombat">
                                <i class="bi bi-shield-exclamation"></i> Enter Combat
                            </button>
                        }
                    }
                </div>
            </div>

            <!-- GM Announcement -->
            <div class="card mb-3">
                <div class="card-header">
                    <strong>Send Announcement</strong>
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" class="form-control" @bind="announcementText"
                               placeholder="Message to all players..." />
                        <button class="btn btn-primary" @onclick="SendAnnouncement"
                                disabled="@(string.IsNullOrWhiteSpace(announcementText))">
                            Send
                        </button>
                    </div>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="card">
                <div class="card-header">
                    <strong>Activity Log</strong>
                </div>
                <div class="card-body" style="max-height: 250px; overflow-y: auto;">
                    @if (activityLog.Count == 0)
                    {
                        <p class="text-muted small">No activity yet.</p>
                    }
                    else
                    {
                        @foreach (var entry in activityLog.TakeLast(20).Reverse())
                        {
                            <div class="small mb-1 @GetActivityClass(entry.Category)">
                                <span class="text-muted">[@entry.Timestamp.ToString("HH:mm:ss")]</span>
                                <strong>@entry.Source:</strong> @entry.Message
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>

    @* Character Removal Confirmation Modal *@
    @if (showRemoveConfirm && characterToRemove != null)
    {
        <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">Remove Character</h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="CancelRemove"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to remove <strong>@characterToRemove.CharacterName</strong> from this table?</p>
                        <p class="text-muted small">The character will no longer be attached to this campaign and the player will need to submit a new join request to rejoin.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CancelRemove">Cancel</button>
                        <button type="button" class="btn btn-danger" @onclick="ExecuteRemoveCharacter">
                            <i class="bi bi-x-circle"></i> Remove
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
}

@code {
    [Parameter]
    public Guid TableId { get; set; }

    private GameMechanics.GamePlay.TableEdit? table;
    private IEnumerable<GameMechanics.GamePlay.TableCharacterInfo>? tableCharacters;
    private GameMechanics.GamePlay.TableCharacterInfo? selectedCharacter;
    private List<NpcInfo>? npcs;
    private string? errorMessage;
    private List<ActivityLogEntry> activityLog = new();
    private IDisposable? activityLogSubscription;

    // Form fields
    private int damageAmount = 1;
    private string damageType = "FAT";
    private int healAmount = 1;
    private string healType = "FAT";
    private string selectedEffect = "";
    private int roundsToAdvance = 5;
    private string announcementText = "";

    // Item distribution state
    private List<ItemTemplate>? allTemplates;
    private ItemType? selectedItemType;
    private string itemSearchText = "";
    private ItemTemplate? selectedTemplate;
    private int grantQuantity = 1;

    // Join request state
    private IEnumerable<GameMechanics.GamePlay.JoinRequestInfo>? pendingRequests;
    private int? expandedCharacterId;
    private GameMechanics.CharacterEdit? expandedCharacter;
    private bool showRemoveConfirm;
    private GameMechanics.GamePlay.TableCharacterInfo? characterToRemove;
    private bool isProcessingRequest;
    private bool timeEventSubscribed;

    private IEnumerable<ItemTemplate> filteredTemplates =>
        allTemplates?
            .Where(t => t.IsActive)
            .Where(t => selectedItemType == null || t.ItemType == selectedItemType)
            .Where(t => string.IsNullOrEmpty(itemSearchText) ||
                        t.Name.Contains(itemSearchText, StringComparison.OrdinalIgnoreCase))
            .OrderBy(t => t.Name)
            .Take(15)
        ?? Enumerable.Empty<ItemTemplate>();

    private static readonly ItemType[] itemTypes = Enum.GetValues<ItemType>();

    private record NpcInfo(Guid Id, string Name);
    private record ActivityLogEntry(DateTime Timestamp, string Message, string Source, ActivityCategory Category);

    protected override async Task OnInitializedAsync()
    {
        await StateManager.InitializeAsync();

        if (RenderModeProvider.GetRenderMode(this).IsInteractive())
        {
            await LoadTable();
            SubscribeToActivityLog();
            await TimeEventPublisher.ConnectAsync();
            await SubscribeToTimeEventsAsync();
        }
    }

    private async Task SubscribeToTimeEventsAsync()
    {
        if (timeEventSubscribed) return;

        await TimeEventSubscriber.ConnectAsync();
        await TimeEventSubscriber.SubscribeAsync();

        TimeEventSubscriber.TimeEventReceived += OnTimeEventReceived;
        TimeEventSubscriber.CharacterUpdateReceived += OnCharacterUpdateReceived;
        TimeEventSubscriber.JoinRequestReceived += OnJoinRequestReceived;
        timeEventSubscribed = true;
    }

    private void OnTimeEventReceived(object? sender, TimeEventMessage e)
    {
        // Only process if this event is for our table
        if (table == null || e.CampaignId != table.Id.ToString()) return;

        // When time advances, schedule a refresh of character data after a short delay
        // to allow player clients to process their end-of-round effects first
        InvokeAsync(async () =>
        {
            // Wait briefly for players to process and save their character updates
            await Task.Delay(500);
            await RefreshCharacterListAsync();
            StateHasChanged();
        });
    }

    private void OnCharacterUpdateReceived(object? sender, CharacterUpdateMessage e)
    {
        // Refresh character list when any character at this table is updated
        InvokeAsync(async () =>
        {
            await RefreshCharacterListAsync();
            StateHasChanged();
        });
    }

    private void OnJoinRequestReceived(object? sender, JoinRequestMessage e)
    {
        // Only process if this request is for our table and it's a new pending request
        if (table == null || e.TableId != table.Id || e.Status != JoinRequestStatus.Pending)
            return;

        // Refresh the pending requests list to show the new request
        InvokeAsync(async () =>
        {
            await LoadPendingRequests();
            StateHasChanged();
        });
    }

    private async Task RefreshCharacterListAsync()
    {
        try
        {
            var charList = await characterListPortal.FetchAsync(TableId);
            tableCharacters = charList.AsEnumerable();

            // Update selected character reference if it still exists
            if (selectedCharacter != null)
            {
                selectedCharacter = tableCharacters.FirstOrDefault(c => c.CharacterId == selectedCharacter.CharacterId);
            }
        }
        catch
        {
            // Ignore refresh errors
        }
    }

    private async Task UnsubscribeFromTimeEventsAsync()
    {
        if (!timeEventSubscribed) return;

        TimeEventSubscriber.TimeEventReceived -= OnTimeEventReceived;
        TimeEventSubscriber.CharacterUpdateReceived -= OnCharacterUpdateReceived;
        TimeEventSubscriber.JoinRequestReceived -= OnJoinRequestReceived;
        await TimeEventSubscriber.UnsubscribeAsync();
        timeEventSubscribed = false;
    }

    private void SubscribeToActivityLog()
    {
        activityLogSubscription = ActivityLog.Subscribe(TableId, msg =>
        {
            InvokeAsync(() =>
            {
                activityLog.Add(new ActivityLogEntry(msg.Timestamp, msg.Message, msg.Source, msg.Category));
                if (activityLog.Count > 100) activityLog.RemoveAt(0);
                StateHasChanged();
            });
        });
    }

    public async void Dispose()
    {
        activityLogSubscription?.Dispose();
        await UnsubscribeFromTimeEventsAsync();
        // Note: TimeEventPublisher is a singleton service, do not dispose
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        // Initialize tooltips after each render since cards may have changed
        if (tableCharacters?.Any() == true)
        {
            await JS.InvokeVoidAsync("reinitializeTooltipsAfterDelay", 50);
        }
    }

    private async Task LoadTable()
    {
        try
        {
            table = await tablePortal.FetchAsync(TableId);
            var charList = await characterListPortal.FetchAsync(TableId);
            tableCharacters = charList.AsEnumerable();
            npcs = new List<NpcInfo>();

            // Apply the table's theme
            if (table != null)
            {
                await JS.InvokeVoidAsync("threaTheme.apply", table.Theme ?? "fantasy");
            }

            // Load item templates for item distribution
            allTemplates = await itemTemplateDal.GetAllTemplatesAsync();

            // Load pending join requests
            await LoadPendingRequests();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load table: {ex.Message}";
        }
    }

    private async Task LoadPendingRequests()
    {
        try
        {
            var list = await joinRequestListPortal.FetchAsync(TableId);
            pendingRequests = list.AsEnumerable();
        }
        catch
        {
            pendingRequests = Enumerable.Empty<GameMechanics.GamePlay.JoinRequestInfo>();
        }
    }

    private async Task ChangeTheme(string newTheme)
    {
        if (table == null) return;

        table.Theme = newTheme;
        await SaveTable();

        // Apply theme immediately
        await JS.InvokeVoidAsync("threaTheme.apply", newTheme);

        AddLogEntry($"Theme changed to {(newTheme == "scifi" ? "Neon Circuit (Sci-Fi)" : "Arcanum (Fantasy)")}", ActivityCategory.Session);

        // Notify all players that theme changed via a table update message
        await TimeEventPublisher.PublishTableUpdateAsync(new TableUpdateMessage
        {
            TableId = table.Id,
            UpdateType = "ThemeChanged",
            Theme = newTheme
        });
    }

    private void AddLogEntry(string message, ActivityCategory category = ActivityCategory.General)
    {
        ActivityLog.Publish(TableId, message, "GM", category);
    }

    private async Task StartSession()
    {
        if (table == null) return;
        table.StartSession();
        await SaveTable();
        AddLogEntry("Session started", ActivityCategory.Session);

        // Announce the current game time to all players
        var timeDisplay = GameTimeFormatter.FormatFull(table.CurrentTimeSeconds);
        AddLogEntry($"The in-game time is: {timeDisplay}", ActivityCategory.Time);
    }

    private async Task PauseSession()
    {
        if (table == null) return;
        table.PauseSession();
        await SaveTable();
        AddLogEntry("Session paused", ActivityCategory.Session);
    }

    private async Task ResumeSession()
    {
        if (table == null) return;
        table.ResumeSession();
        await SaveTable();
        AddLogEntry("Session resumed", ActivityCategory.Session);
    }

    private async Task EndSession()
    {
        if (table == null) return;
        table.EndSession();
        await SaveTable();
        AddLogEntry("Session ended", ActivityCategory.Session);
    }

    private async Task AdvanceRound()
    {
        if (table == null) return;
        table.AdvanceRound();
        await SaveTable();
        AddLogEntry($"Advanced to round {table.CurrentRound}", ActivityCategory.Time);

        // Publish time event so players can process end-of-round effects
        await TimeEventPublisher.PublishTimeEventAsync(new TimeEventMessage
        {
            EventType = GameMechanics.Time.TimeEventType.EndOfRound,
            Count = 1,
            CampaignId = table.Id.ToString(),
            SourceId = "GM",
            Reason = $"Advanced to round {table.CurrentRound}"
        });
    }

    private async Task AdvanceMultipleRounds()
    {
        if (table == null) return;
        table.AdvanceRounds(roundsToAdvance);
        await SaveTable();
        AddLogEntry($"Advanced {roundsToAdvance} rounds to round {table.CurrentRound}", ActivityCategory.Time);

        // Publish time event so players can process end-of-round effects
        await TimeEventPublisher.PublishTimeEventAsync(new TimeEventMessage
        {
            EventType = GameMechanics.Time.TimeEventType.EndOfRound,
            Count = roundsToAdvance,
            CampaignId = table.Id.ToString(),
            SourceId = "GM",
            Reason = $"Advanced {roundsToAdvance} rounds to round {table.CurrentRound}"
        });
    }

    private async Task AdvanceRoundsQuick(int count)
    {
        if (table == null) return;
        table.AdvanceRounds(count);
        await SaveTable();
        AddLogEntry($"Advanced {count} rounds to round {table.CurrentRound}", ActivityCategory.Time);

        await TimeEventPublisher.PublishTimeEventAsync(new TimeEventMessage
        {
            EventType = GameMechanics.Time.TimeEventType.EndOfRound,
            Count = count,
            CampaignId = table.Id.ToString(),
            SourceId = "GM",
            Reason = $"Advanced {count} rounds to round {table.CurrentRound}"
        });
    }

    private async Task EnterCombat()
    {
        if (table == null) return;
        table.EnterCombat();
        await SaveTable();
        AddLogEntry("Combat started!", ActivityCategory.Combat);

        // Publish combat state change
        await TimeEventPublisher.PublishCombatStateAsync(new CombatStateMessage
        {
            EnteringCombat = true,
            CampaignId = table.Id.ToString(),
            SourceId = "GM",
            EncounterName = "Combat"
        });
    }

    private async Task ExitCombat()
    {
        if (table == null) return;
        table.ExitCombat();
        await SaveTable();
        AddLogEntry("Combat ended", ActivityCategory.Combat);

        // Publish combat state change
        await TimeEventPublisher.PublishCombatStateAsync(new CombatStateMessage
        {
            EnteringCombat = false,
            CampaignId = table.Id.ToString(),
            SourceId = "GM"
        });
    }

    private async Task AdvanceTime(int seconds)
    {
        if (table == null) return;

        table.AdvanceTime(seconds);
        await SaveTable();

        // Determine the appropriate event type and format for logging
        var (timeEventType, timeDescription, count) = seconds switch
        {
            60 => (GameMechanics.Time.TimeEventType.EndOfMinute, "1 minute", 1),
            600 => (GameMechanics.Time.TimeEventType.EndOfTurn, "1 turn (10 minutes)", 1),
            3600 => (GameMechanics.Time.TimeEventType.EndOfHour, "1 hour", 1),
            86400 => (GameMechanics.Time.TimeEventType.EndOfDay, "1 day", 1),
            604800 => (GameMechanics.Time.TimeEventType.EndOfWeek, "1 week", 1),
            _ => (GameMechanics.Time.TimeEventType.EndOfMinute, $"{seconds} seconds", seconds / 60)
        };

        AddLogEntry($"Advanced time by {timeDescription}", ActivityCategory.Time);

        // Publish time skip event so players can process time-based effects
        await TimeEventPublisher.PublishTimeSkipAsync(new TimeSkipMessage
        {
            SkipUnit = timeEventType,
            Count = count,
            CampaignId = table.Id.ToString(),
            SourceId = "GM",
            NarrativeDescription = $"GM advanced time by {timeDescription}"
        });
    }

    private void SendAnnouncement()
    {
        if (string.IsNullOrWhiteSpace(announcementText)) return;
        AddLogEntry(announcementText, ActivityCategory.Announcement);
        announcementText = "";
    }

    private async Task SaveTable()
    {
        if (table == null) return;
        try
        {
            await tablePortal.UpdateAsync(table);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to save: {ex.Message}";
        }
    }

    private void SelectCharacter(GameMechanics.GamePlay.TableCharacterInfo character)
    {
        selectedCharacter = character;
    }

    private async Task OpenCharacterDetails(GameMechanics.GamePlay.TableCharacterInfo character)
    {
        // Also select the character for the center panel
        selectedCharacter = character;

        await DialogService.OpenAsync<CharacterDetailModal>(
            character.CharacterName,
            new Dictionary<string, object>
            {
                { "CharacterId", character.CharacterId },
                { "TableId", TableId },
                { "AllCharacters", tableCharacters ?? Enumerable.Empty<GameMechanics.GamePlay.TableCharacterInfo>() }
            },
            new DialogOptions
            {
                Width = "90%",
                Height = "90%",
                CloseDialogOnOverlayClick = false,
                ShowClose = false  // We have our own close button
            });
    }

    private void QuickHeal(GameMechanics.GamePlay.TableCharacterInfo character)
    {
        AddLogEntry($"Quick healed {character.CharacterName}", ActivityCategory.Health);
    }

    private void QuickDamage(GameMechanics.GamePlay.TableCharacterInfo character)
    {
        AddLogEntry($"Quick damaged {character.CharacterName}", ActivityCategory.Health);
    }

    private async Task ApplyDamage()
    {
        if (selectedCharacter == null || table == null) return;

        try
        {
            // Fetch the character, apply damage, and save
            var character = await characterPortal.FetchAsync(selectedCharacter.CharacterId);

            if (damageType == "FAT")
            {
                character.Fatigue.PendingDamage += damageAmount;
            }
            else // VIT
            {
                character.Vitality.PendingDamage += damageAmount;
            }

            await characterPortal.UpdateAsync(character);

            AddLogEntry($"Applied {damageAmount} {damageType} damage to {selectedCharacter.CharacterName}", ActivityCategory.Health);

            // Notify the player to refresh their character
            await TimeEventPublisher.PublishCharacterUpdateAsync(new CharacterUpdateMessage
            {
                CharacterId = selectedCharacter.CharacterId,
                UpdateType = CharacterUpdateType.Damage,
                CampaignId = table.Id.ToString(),
                SourceId = "GM",
                Description = $"{damageAmount} {damageType} damage"
            });

            // Refresh the table character list to show updated values
            var charList = await characterListPortal.FetchAsync(TableId);
            tableCharacters = charList.AsEnumerable();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to apply damage: {ex.Message}";
        }
    }

    private async Task ApplyHealing()
    {
        if (selectedCharacter == null || table == null) return;

        try
        {
            // Fetch the character, apply healing, and save
            var character = await characterPortal.FetchAsync(selectedCharacter.CharacterId);

            if (healType == "FAT")
            {
                character.Fatigue.PendingHealing += healAmount;
            }
            else // VIT
            {
                character.Vitality.PendingHealing += healAmount;
            }

            await characterPortal.UpdateAsync(character);

            AddLogEntry($"Applied {healAmount} {healType} healing to {selectedCharacter.CharacterName}", ActivityCategory.Health);

            // Notify the player to refresh their character
            await TimeEventPublisher.PublishCharacterUpdateAsync(new CharacterUpdateMessage
            {
                CharacterId = selectedCharacter.CharacterId,
                UpdateType = CharacterUpdateType.Healing,
                CampaignId = table.Id.ToString(),
                SourceId = "GM",
                Description = $"{healAmount} {healType} healing"
            });

            // Refresh the table character list to show updated values
            var charList = await characterListPortal.FetchAsync(TableId);
            tableCharacters = charList.AsEnumerable();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to apply healing: {ex.Message}";
        }
    }

    private async Task ApplyEffect()
    {
        if (selectedCharacter == null || string.IsNullOrEmpty(selectedEffect) || table == null) return;

        try
        {
            // Fetch the character, add effect, and save
            var character = await characterPortal.FetchAsync(selectedCharacter.CharacterId);

            // Create the effect with appropriate type and duration
            var effect = await effectPortal.CreateChildAsync(
                Threa.Dal.Dto.EffectType.Condition,  // Stunned, Blinded, Prone are all conditions
                selectedEffect,  // Name
                (string?)null,   // Location (null for global effects)
                (int?)null,      // DurationRounds (null = permanent until removed)
                (string?)null    // BehaviorState
            );
            effect.Source = "GM";

            character.Effects.AddEffect(effect);
            await characterPortal.UpdateAsync(character);

            AddLogEntry($"Applied {selectedEffect} to {selectedCharacter.CharacterName}", ActivityCategory.Effect);

            // Notify the player to refresh their character
            await TimeEventPublisher.PublishCharacterUpdateAsync(new CharacterUpdateMessage
            {
                CharacterId = selectedCharacter.CharacterId,
                UpdateType = CharacterUpdateType.EffectAdded,
                CampaignId = table.Id.ToString(),
                SourceId = "GM",
                Description = selectedEffect
            });

            // Refresh the table character list to show updated values
            var charList = await characterListPortal.FetchAsync(TableId);
            tableCharacters = charList.AsEnumerable();

            selectedEffect = "";
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to apply effect: {ex.Message}";
        }
    }

    private void AddNpc()
    {
        AddLogEntry("NPC creation not yet implemented", ActivityCategory.General);
    }

    private void RemoveNpc(Guid npcId)
    {
        npcs?.RemoveAll(n => n.Id == npcId);
        AddLogEntry("NPC removed", ActivityCategory.General);
    }

    private string GetPlayerJoinLink() =>
        NavigationManager.ToAbsoluteUri($"/play/{TableId}").ToString();

    private string GetStatusBadgeClass() =>
        table?.Status switch
        {
            Threa.Dal.Dto.TableStatus.Lobby => "bg-info",
            Threa.Dal.Dto.TableStatus.Active => "bg-success",
            Threa.Dal.Dto.TableStatus.Paused => "bg-warning",
            Threa.Dal.Dto.TableStatus.Ended => "bg-secondary",
            _ => "bg-secondary"
        };

    private string GetConnectionBadgeClass(Threa.Dal.Dto.ConnectionStatus status) =>
        status switch
        {
            Threa.Dal.Dto.ConnectionStatus.Connected => "bg-success",
            Threa.Dal.Dto.ConnectionStatus.Disconnected => "bg-danger",
            Threa.Dal.Dto.ConnectionStatus.Away => "bg-warning",
            _ => "bg-secondary"
        };

    private string GetConnectionIndicatorClass(Threa.Dal.Dto.ConnectionStatus status) =>
        status switch
        {
            Threa.Dal.Dto.ConnectionStatus.Connected => "connected",
            Threa.Dal.Dto.ConnectionStatus.Disconnected => "disconnected",
            Threa.Dal.Dto.ConnectionStatus.Away => "away",
            _ => ""
        };

    private string? GetHealthStatus(GameMechanics.GamePlay.TableCharacterInfo character)
    {
        var fatPercent = GetPercent(character.FatValue, character.FatMax);
        var vitPercent = GetPercent(character.VitValue, character.VitMax);

        if (character.FatValue <= 0) return "UNCONSCIOUS";
        if (vitPercent <= 25) return "CRITICAL";
        if (fatPercent <= 25) return "EXHAUSTED";
        if (vitPercent <= 50) return "INJURED";

        return null;
    }

    private string GetHealthStatusBadgeClass(GameMechanics.GamePlay.TableCharacterInfo character)
    {
        var fatPercent = GetPercent(character.FatValue, character.FatMax);
        var vitPercent = GetPercent(character.VitValue, character.VitMax);

        if (character.FatValue <= 0) return "bg-dark";
        if (vitPercent <= 25) return "bg-danger";
        if (fatPercent <= 25) return "bg-warning text-dark";
        if (vitPercent <= 50) return "bg-warning text-dark";

        return "bg-secondary";
    }

    private int GetPercent(int value, int max) =>
        max > 0 ? (value * 100 / max) : 0;

    private string GetActivityClass(ActivityCategory category) =>
        category switch
        {
            ActivityCategory.Combat => "text-danger",
            ActivityCategory.Announcement => "text-primary fw-bold",
            ActivityCategory.Health => "text-success",
            ActivityCategory.Effect => "text-warning",
            ActivityCategory.Time => "text-info",
            ActivityCategory.Session => "text-secondary fst-italic",
            ActivityCategory.Player => "text-muted",
            _ => ""
        };

    private void SelectTemplate(ItemTemplate template)
    {
        selectedTemplate = selectedTemplate?.Id == template.Id ? null : template;
        grantQuantity = 1;
    }

    private async Task GrantItemToCharacter()
    {
        if (selectedCharacter == null || selectedTemplate == null || table == null)
            return;

        try
        {
            // Fetch full CharacterEdit for ItemManagementService
            var targetCharacter = await characterPortal.FetchAsync(selectedCharacter.CharacterId);

            // Create the item instance
            var newItem = new CharacterItem
            {
                Id = Guid.NewGuid(),
                ItemTemplateId = selectedTemplate.Id,
                OwnerCharacterId = selectedCharacter.CharacterId,
                StackSize = selectedTemplate.IsStackable ? grantQuantity : 1,
                CurrentDurability = selectedTemplate.HasDurability ? selectedTemplate.MaxDurability : null,
                CreatedAt = DateTime.UtcNow
            };

            // Add via service (handles effects)
            var result = await itemManagementService.AddItemToInventoryAsync(targetCharacter, newItem);

            if (!result.Success)
            {
                errorMessage = result.ErrorMessage;
                return;
            }

            // Notify player to refresh inventory
            await TimeEventPublisher.PublishCharacterUpdateAsync(new CharacterUpdateMessage
            {
                CharacterId = selectedCharacter.CharacterId,
                UpdateType = CharacterUpdateType.InventoryChanged,
                CampaignId = table.Id.ToString(),
                SourceId = "GM",
                Description = $"Granted {(selectedTemplate.IsStackable ? grantQuantity : 1)}x {selectedTemplate.Name}"
            });

            // Log the action
            var qty = selectedTemplate.IsStackable ? grantQuantity : 1;
            AddLogEntry($"Granted {qty}x {selectedTemplate.Name} to {selectedCharacter.CharacterName}", ActivityCategory.General);

            // Reset for next grant
            grantQuantity = 1;
            selectedTemplate = null;
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to grant item: {ex.Message}";
        }
    }

    // Join Request Methods
    private async Task ToggleCharacterDetails(int characterId)
    {
        if (expandedCharacterId == characterId)
        {
            expandedCharacterId = null;
            expandedCharacter = null;
        }
        else
        {
            expandedCharacterId = characterId;
            try
            {
                expandedCharacter = await characterPortal.FetchAsync(characterId);
            }
            catch
            {
                expandedCharacter = null;
            }
        }
    }

    private async Task ApproveRequest(Guid requestId)
    {
        if (table == null) return;
        isProcessingRequest = true;

        try
        {
            var gameMasterId = GetCurrentUserId();
            var result = await processorPortal.ExecuteAsync(requestId, true, gameMasterId);

            if (result.Success)
            {
                AddLogEntry($"Approved join request for {result.CharacterName}", ActivityCategory.Player);
                await LoadPendingRequests();
                var charList = await characterListPortal.FetchAsync(TableId);
                tableCharacters = charList.AsEnumerable();
            }
            else
            {
                errorMessage = result.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to approve: {ex.Message}";
        }
        finally
        {
            isProcessingRequest = false;
            expandedCharacterId = null;
            expandedCharacter = null;
        }
    }

    private async Task DenyRequest(Guid requestId)
    {
        if (table == null) return;
        isProcessingRequest = true;

        try
        {
            var gameMasterId = GetCurrentUserId();
            var result = await processorPortal.ExecuteAsync(requestId, false, gameMasterId);

            if (result.Success)
            {
                AddLogEntry($"Denied join request for {result.CharacterName}", ActivityCategory.Player);
                await LoadPendingRequests();
            }
            else
            {
                errorMessage = result.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to deny: {ex.Message}";
        }
        finally
        {
            isProcessingRequest = false;
        }
    }

    private int GetCurrentUserId()
    {
        return int.Parse(applicationContext.Principal.Claims
            .First(c => c.Type == ClaimTypes.NameIdentifier).Value);
    }

    // Character Removal Methods
    private void ConfirmRemoveCharacter(GameMechanics.GamePlay.TableCharacterInfo character)
    {
        characterToRemove = character;
        showRemoveConfirm = true;
    }

    private void CancelRemove()
    {
        characterToRemove = null;
        showRemoveConfirm = false;
    }

    private async Task ExecuteRemoveCharacter()
    {
        if (characterToRemove == null || table == null) return;

        try
        {
            var result = await detacherPortal.ExecuteAsync(characterToRemove.CharacterId);

            if (result.Success)
            {
                AddLogEntry($"Removed {characterToRemove.CharacterName} from table", ActivityCategory.Player);
                var charList = await characterListPortal.FetchAsync(TableId);
                tableCharacters = charList.AsEnumerable();

                if (selectedCharacter?.CharacterId == characterToRemove.CharacterId)
                {
                    selectedCharacter = null;
                }
            }
            else
            {
                errorMessage = result.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to remove character: {ex.Message}";
        }
        finally
        {
            characterToRemove = null;
            showRemoveConfirm = false;
        }
    }
}
