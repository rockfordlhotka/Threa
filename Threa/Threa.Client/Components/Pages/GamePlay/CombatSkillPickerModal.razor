@inject Radzen.DialogService DialogService

<div class="combat-skill-picker">
    <!-- Search/Filter -->
    <div class="mb-3">
        <input type="text" class="form-control form-control-sm" placeholder="Search skills..."
               @bind="searchFilter" @bind:event="oninput" />
    </div>

    <!-- Skills grouped by attribute -->
    <div class="skill-groups">
        @foreach (var group in GetGroupedSkills())
        {
            <div class="card mb-2">
                <div class="card-header py-1 px-2 bg-light">
                    <strong class="small">@GetAttributeDisplayName(group.Key)</strong>
                </div>
                <div class="list-group list-group-flush">
                    @foreach (var skill in group)
                    {
                        <button class="list-group-item list-group-item-action py-2 px-3 d-flex justify-content-between align-items-center"
                                @onclick="() => SelectSkill(skill)">
                            <span>@skill.Name</span>
                            <span class="badge bg-primary">AS @skill.AbilityScore</span>
                        </button>
                    }
                </div>
            </div>
        }

        @if (!GetGroupedSkills().Any())
        {
            <p class="text-muted text-center mt-3">No skills found.</p>
        }
    </div>

    <!-- Cancel -->
    <div class="mt-3 text-end">
        <button class="btn btn-outline-secondary btn-sm" @onclick="Cancel">
            <i class="bi bi-x-lg"></i> Cancel
        </button>
    </div>
</div>

@code {
    [Parameter]
    public GameMechanics.CharacterEdit? Character { get; set; }

    private string searchFilter = "";

    private static readonly Dictionary<string, string> AttributeDisplayNames = new()
    {
        { "STR", "Physicality (STR)" },
        { "DEX", "Dodge (DEX)" },
        { "END", "Drive (END)" },
        { "INT", "Reasoning (INT)" },
        { "ITT", "Awareness (ITT)" },
        { "WIL", "Focus (WIL)" },
        { "PHY", "Influence (PHY)" }
    };

    private IEnumerable<IGrouping<string, GameMechanics.SkillEdit>> GetGroupedSkills()
    {
        var skills = Character?.Skills?.AsEnumerable() ?? Enumerable.Empty<GameMechanics.SkillEdit>();

        // Filter out standard skills
        skills = skills.Where(s => s.Category != Threa.Dal.Dto.SkillCategory.Standard);

        if (!string.IsNullOrWhiteSpace(searchFilter))
        {
            skills = skills.Where(s => s.Name.Contains(searchFilter, StringComparison.OrdinalIgnoreCase));
        }

        return skills
            .OrderBy(s => s.PrimaryAttribute)
            .ThenBy(s => s.Name)
            .GroupBy(s => s.PrimaryAttribute);
    }

    private string GetAttributeDisplayName(string attr)
    {
        return AttributeDisplayNames.GetValueOrDefault(attr, attr);
    }

    private void SelectSkill(GameMechanics.SkillEdit skill)
    {
        DialogService.Close(skill);
    }

    private void Cancel()
    {
        DialogService.Close();
    }
}
