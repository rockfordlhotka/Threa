@using GameMechanics.Actions
@using GameMechanics.Effects.Behaviors
@using Threa.Dal.Dto
@using Threa.Client.Components.Shared
@using GameMechanics

@inject Radzen.DialogService DialogService
@inject IChildDataPortal<GameMechanics.EffectRecord> effectPortal

<div class="medical-mode">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0"><i class="bi bi-heart-pulse text-success"></i> Medical Treatment</h4>
        <button class="btn btn-outline-secondary btn-sm" @onclick="OnCancel">
            <i class="bi bi-x-lg"></i> Cancel
        </button>
    </div>

    @if (!hasRolled)
    {
        <!-- Medical Setup -->
        <div class="row">
            <div class="col-md-6">
                <!-- Skill Selection -->
                <div class="card mb-3">
                    <div class="card-header">
                        <strong>1. Select Medical Skill</strong>
                    </div>
                    <div class="card-body">
                        <div class="list-group">
                            @foreach (var skill in GetMedicalSkills())
                            {
                                <button class="list-group-item list-group-item-action @(selectedSkill?.Id == skill.Id ? "active" : "")"
                                        @onclick="() => SelectSkill(skill)">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>@skill.Name</strong>
                                            <div class="small @(selectedSkill?.Id == skill.Id ? "" : "text-muted")">
                                                @skill.PrimaryAttribute skill - @skill.PostUseConcentrationRounds round@(skill.PostUseConcentrationRounds != 1 ? "s" : "") to complete
                                            </div>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-primary">
                                                AS @skill.AbilityScore
                                            </span>
                                            @if (skill.SvBonus > 0)
                                            {
                                                <span class="badge bg-success ms-1">
                                                    +@skill.SvBonus SV
                                                </span>
                                            }
                                        </div>
                                    </div>
                                </button>
                            }
                            @if (!GetMedicalSkills().Any())
                            {
                                <div class="text-muted p-2">No medical skills found. Add First-Aid, Nursing, or Doctor skills to this character.</div>
                            }
                        </div>
                    </div>
                </div>

                @if (selectedSkill != null)
                {
                    <!-- Target Selection -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong>2. Select Target</strong>
                        </div>
                        <div class="card-body">
                            <div class="list-group">
                                @* Self target *@
                                <button class="list-group-item list-group-item-action @(targetType == TargetType.Self ? "active" : "")"
                                        @onclick="() => SelectTarget(TargetType.Self)">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>@Character?.Name (Self)</strong>
                                            <div class="small @(targetType == TargetType.Self ? "" : "text-muted")">
                                                FAT: @Character?.Fatigue.Value/@Character?.Fatigue.BaseValue |
                                                VIT: @Character?.Vitality.Value/@Character?.Vitality.BaseValue
                                            </div>
                                        </div>
                                        @if (targetType == TargetType.Self)
                                        {
                                            <i class="bi bi-check-circle-fill"></i>
                                        }
                                    </div>
                                </button>
                                @* No target (NPC/Other) - just rolls and reports SV *@
                                <button class="list-group-item list-group-item-action @(targetType == TargetType.Other ? "active" : "")"
                                        @onclick="() => SelectTarget(TargetType.Other)">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>Other (NPC/External)</strong>
                                            <div class="small @(targetType == TargetType.Other ? "" : "text-muted")">
                                                Roll only - GM applies healing result
                                            </div>
                                        </div>
                                        @if (targetType == TargetType.Other)
                                        {
                                            <i class="bi bi-check-circle-fill"></i>
                                        }
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Action Cost -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong>3. Action Cost</strong>
                        </div>
                        <div class="card-body">
                            <ActionCostSelector AP="@(Character?.ActionPoints.Available ?? 0)"
                                                Fat="@(Character?.Fatigue.Value ?? 0)"
                                                OnCostTypeSelected="OnCostTypeChanged" />
                        </div>
                    </div>

                    <!-- Boost -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong>4. Boost (Optional)</strong>
                        </div>
                        <div class="card-body">
                            <BoostSelector AvailableAP="@GetAvailableAPForBoost()"
                                           AvailableFAT="@GetAvailableFATForBoost()"
                                           CostType="@costType"
                                           OnBoostChanged="OnBoostChanged"
                                           OnBoostCostChanged="OnBoostCostChanged" />
                        </div>
                    </div>
                }
            </div>

            <div class="col-md-6">
                <!-- Medical Summary -->
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <strong><i class="bi bi-info-circle"></i> Treatment Summary</strong>
                    </div>
                    <div class="card-body">
                        @if (selectedSkill != null && targetType != TargetType.None)
                        {
                            <table class="table table-sm mb-0">
                                <tbody>
                                    <tr>
                                        <td>Skill:</td>
                                        <td class="fw-bold">@selectedSkill.Name</td>
                                    </tr>
                                    <tr>
                                        <td>Ability Score:</td>
                                        <td class="fw-bold">@selectedSkill.AbilityScore</td>
                                    </tr>
                                    @if (selectedSkill.SvBonus > 0)
                                    {
                                        <tr>
                                            <td>SV Bonus:</td>
                                            <td class="fw-bold text-success">+@selectedSkill.SvBonus</td>
                                        </tr>
                                    }
                                    @if (boostValue > 0)
                                    {
                                        <tr>
                                            <td>Boost:</td>
                                            <td class="fw-bold text-success">+@boostValue</td>
                                        </tr>
                                    }
                                    <tr>
                                        <td>Target Value:</td>
                                        <td class="fw-bold">@MedicalResolver.MedicalTV</td>
                                    </tr>
                                    <tr>
                                        <td colspan="2"><hr class="my-1" /></td>
                                    </tr>
                                    <tr>
                                        <td>Patient:</td>
                                        <td class="fw-bold">@(targetType == TargetType.Self ? Character?.Name : "Other (NPC/External)")</td>
                                    </tr>
                                    @if (targetType == TargetType.Self)
                                    {
                                        <tr>
                                            <td>Concentration:</td>
                                            <td class="fw-bold">@selectedSkill.PostUseConcentrationRounds round@(selectedSkill.PostUseConcentrationRounds != 1 ? "s" : "")</td>
                                        </tr>
                                    }
                                    <tr>
                                        <td colspan="2"><hr class="my-1" /></td>
                                    </tr>
                                    <tr>
                                        <td>Cost:</td>
                                        <td>@GetCostDisplay()</td>
                                    </tr>
                                    @if (boostValue > 0)
                                    {
                                        <tr>
                                            <td>Boost Cost:</td>
                                            <td class="text-warning">@GetBoostCostDisplay()</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>

                            @if (targetType == TargetType.Self)
                            {
                                <div class="alert alert-info mt-3 mb-0 py-2">
                                    <small>
                                        <i class="bi bi-lightbulb"></i>
                                        Roll the skill check now. If successful, concentration begins.
                                        Healing applies when concentration completes.
                                        If interrupted, treatment fails.
                                    </small>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-warning mt-3 mb-0 py-2">
                                    <small>
                                        <i class="bi bi-info-circle"></i>
                                        Roll the skill check to determine healing amount.
                                        The GM will apply healing to the target.
                                    </small>
                                </div>
                            }
                        }
                        else
                        {
                            <p class="text-muted mb-0">Select a skill and target to see treatment details.</p>
                        }
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-success btn-lg w-100"
                                @onclick="RollCheck"
                                disabled="@(!CanRoll())"
                                title="@(selectedSkill == null ? "Select a skill" : targetType == TargetType.None ? "Select a target" : "")">
                            <i class="bi bi-dice-5"></i> Roll Check
                        </button>
                    </div>
                </div>

                <!-- Resource Summary -->
                <div class="card mt-3">
                    <div class="card-body py-2">
                        <div class="row text-center">
                            <div class="col-4">
                                <small class="text-muted">AP</small>
                                <div class="fw-bold @(Character?.ActionPoints.Available <= 0 ? "text-danger" : "")">
                                    @Character?.ActionPoints.Available / @Character?.ActionPoints.Max
                                </div>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">FAT</small>
                                <div class="fw-bold @(Character?.Fatigue.Value <= 0 ? "text-danger" : "")">
                                    @Character?.Fatigue.Value / @Character?.Fatigue.BaseValue
                                </div>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">VIT</small>
                                <div class="fw-bold">
                                    @Character?.Vitality.Value / @Character?.Vitality.BaseValue
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Roll Result -->
        <div class="card">
            <div class="card-header @(checkResult?.Success == true ? "bg-success" : "bg-danger") text-white">
                <strong><i class="bi @(checkResult?.Success == true ? "bi-check-circle" : "bi-x-circle")"></i>
                    @if (checkResult?.Success == true)
                    {
                        @(targetType == TargetType.Self ? "Treatment Started!" : "Roll Complete!")
                    }
                    else
                    {
                        <text>Treatment Failed</text>
                    }
                </strong>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tbody>
                        <tr>
                            <td>Skill:</td>
                            <td class="fw-bold">@selectedSkill?.Name</td>
                        </tr>
                        <tr>
                            <td>Ability Score:</td>
                            <td class="fw-bold">@checkResult?.AbilityScore@(boostValue > 0 ? $" (+{boostValue} boost)" : "")</td>
                        </tr>
                        <tr>
                            <td>Dice Roll:</td>
                            <td class="fw-bold @(checkResult?.DiceRoll >= 0 ? "text-success" : "text-danger")">
                                @(checkResult?.DiceRoll >= 0 ? "+" : "")@checkResult?.DiceRoll
                            </td>
                        </tr>
                        <tr>
                            <td>Total Roll:</td>
                            <td class="fw-bold">@checkResult?.TotalRoll</td>
                        </tr>
                        <tr>
                            <td>Target Value:</td>
                            <td class="fw-bold">@MedicalResolver.MedicalTV</td>
                        </tr>
                        <tr>
                            <td colspan="2"><hr class="my-1" /></td>
                        </tr>
                        <tr>
                            <td>Success Value:</td>
                            <td class="fw-bold @(checkResult?.Success == true ? "text-success" : "text-danger")">
                                @checkResult?.SuccessValue
                            </td>
                        </tr>
                        @if (checkResult?.Success == true)
                        {
                            <tr>
                                <td>Healing Amount:</td>
                                <td class="fw-bold text-success">@checkResult?.HealingAmount FAT/VIT</td>
                            </tr>
                            <tr>
                                <td>Treatment Time:</td>
                                <td class="fw-bold">@checkResult?.ConcentrationRounds rounds</td>
                            </tr>
                            @if (targetType == TargetType.Other)
                            {
                                <tr>
                                    <td colspan="2">
                                        <div class="alert alert-info py-2 mb-0 mt-2">
                                            <i class="bi bi-info-circle"></i>
                                            GM: Apply @checkResult?.HealingAmount healing to target after @checkResult?.ConcentrationRounds rounds
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="2">
                                    <div class="alert alert-danger py-2 mb-0 mt-2">
                                        <i class="bi bi-exclamation-triangle"></i>
                                        @checkResult?.ResultDescription
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div class="card-footer d-flex gap-2">
                @if (checkResult?.Success == true)
                {
                    <button class="btn btn-success" @onclick="StartConcentration">
                        @if (targetType == TargetType.Self)
                        {
                            <i class="bi bi-play-circle"></i> <text>Begin Treatment</text>
                        }
                        else
                        {
                            <i class="bi bi-check-lg"></i> <text>Done</text>
                        }
                    </button>
                }
                <button class="btn btn-outline-secondary" @onclick="Reset">
                    <i class="bi bi-arrow-counterclockwise"></i> @(checkResult?.Success == true ? "Cancel" : "Try Again")
                </button>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public GameMechanics.CharacterEdit? Character { get; set; }

    [Parameter]
    public GameMechanics.GamePlay.TableEdit? Table { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    [Parameter]
    public EventCallback<MedicalCompleteData> OnMedicalComplete { get; set; }

    [Parameter]
    public EventCallback OnCharacterChanged { get; set; }

    // Target type enum
    private enum TargetType { None, Self, Other }

    // Selection state
    private SkillEdit? selectedSkill;
    private TargetType targetType = TargetType.None;
    private ActionCostType costType = ActionCostType.OneAPOneFat;

    // Boost state
    private int boostValue;
    private int boostAPCost;
    private int boostFATCost;

    // Roll state
    private bool hasRolled;
    private MedicalCheckResult? checkResult;

    private void SelectSkill(SkillEdit skill)
    {
        selectedSkill = skill;
    }

    private IEnumerable<SkillEdit> GetMedicalSkills()
    {
        if (Character == null) return [];
        return Character.Skills.Where(s => s.IsMedicalSkill);
    }

    private void SelectTarget(TargetType type)
    {
        targetType = type;
    }

    private void OnCostTypeChanged(ActionCostType type)
    {
        costType = type;
        boostValue = 0;
        boostAPCost = 0;
        boostFATCost = 0;
    }

    private void OnBoostChanged(int totalBoost) => boostValue = totalBoost;

    private void OnBoostCostChanged((int Boost, int APCost, int FATCost) cost)
    {
        boostValue = cost.Boost;
        boostAPCost = cost.APCost;
        boostFATCost = cost.FATCost;
    }

    private int GetAvailableAPForBoost()
    {
        var baseCost = costType == ActionCostType.TwoAP ? 2 : 1;
        return Math.Max(0, (Character?.ActionPoints.Available ?? 0) - baseCost);
    }

    private int GetAvailableFATForBoost()
    {
        var baseCost = costType == ActionCostType.OneAPOneFat ? 1 : 0;
        return Math.Max(0, (Character?.Fatigue.Value ?? 0) - baseCost);
    }

    private string GetBoostCostDisplay()
    {
        if (boostValue == 0) return "None";
        if (boostFATCost > 0)
            return $"{boostAPCost} AP + {boostFATCost} FAT (+{boostValue} AS)";
        return $"{boostAPCost} AP (+{boostValue} AS)";
    }


    private string GetCostDisplay()
    {
        return costType switch
        {
            ActionCostType.OneAPOneFat => "1 AP + 1 FAT",
            ActionCostType.TwoAP => "2 AP",
            _ => "Unknown"
        };
    }

    private bool CanRoll()
    {
        if (Character == null || selectedSkill == null || targetType == TargetType.None) return false;
        if (Character.IsPassedOut) return false;

        // Only check concentration for Self target (Other target doesn't start concentration)
        if (targetType == TargetType.Self && ConcentrationBehavior.IsConcentrating(Character)) return false;

        var apNeeded = (costType == ActionCostType.TwoAP ? 2 : 1) + boostAPCost;
        var fatNeeded = (costType == ActionCostType.OneAPOneFat ? 1 : 0) + boostFATCost;

        return Character.ActionPoints.Available >= apNeeded &&
               Character.Fatigue.Value >= fatNeeded;
    }

    private async Task RollCheck()
    {
        if (!CanRoll() || Character == null || selectedSkill == null) return;

        // Check if character is concentrating - only need to break for Self target (which starts new concentration)
        if (targetType == TargetType.Self)
        {
            var concentrationEffect = Character.GetConcentrationEffect();
            if (concentrationEffect != null)
            {
                var state = ConcentrationState.FromJson(concentrationEffect.BehaviorState);
                if (state != null)
                {
                    var confirmed = await ConcentrationBreakDialog.ShowAsync(
                        DialogService,
                        state,
                        concentrationEffect.Name);
                    if (!confirmed)
                        return;

                    ConcentrationBehavior.BreakConcentration(Character, "Started medical treatment");
                }
            }
        }

        // Deduct costs
        var apCost = (costType == ActionCostType.TwoAP ? 2 : 1) + boostAPCost;
        var fatCost = (costType == ActionCostType.OneAPOneFat ? 1 : 0) + boostFATCost;

        Character.ActionPoints.Available -= apCost;
        Character.ActionPoints.ActionsTakenThisRound += 1;
        if (fatCost > 0)
            Character.Fatigue.Value -= fatCost;

        // Create request and resolve using skill definition data
        // AbilityScore is pre-computed and already includes wounds, effects, and attribute bonuses
        var request = new MedicalRequest
        {
            SkillDisplayName = selectedSkill.Name,
            AbilityScore = selectedSkill.AbilityScore,
            AttributeName = selectedSkill.PrimaryAttribute,
            ConcentrationRounds = selectedSkill.PostUseConcentrationRounds,
            IsMultipleAction = Character.ActionPoints.ActionsTakenThisRound > 1,
            Boost = boostValue,
            SvBonus = selectedSkill.SvBonus
        };

        var resolver = new MedicalResolver();
        checkResult = resolver.ResolveCheck(request);
        hasRolled = true;

        // Save character state
        if (Character is Csla.Core.ISavable savable)
        {
            await savable.SaveAsync();
        }

        // Notify parent to refresh character display (AP, FAT changes)
        if (OnCharacterChanged.HasDelegate)
        {
            await OnCharacterChanged.InvokeAsync();
        }
    }

    private async Task StartConcentration()
    {
        if (Character == null || checkResult == null || selectedSkill == null) return;

        var skillName = selectedSkill.Name;
        string message;

        if (targetType == TargetType.Self)
        {
            // Create concentration state for self-treatment
            var stateJson = ConcentrationBehavior.CreateMedicalHealingState(
                targetCharacterId: Character.Id,
                targetName: Character.Name,
                healerCharacterId: Character.Id,
                healerName: Character.Name,
                skillName: skillName,
                successValue: checkResult.SuccessValue,
                concentrationRounds: checkResult.ConcentrationRounds);

            // Create the concentration effect
            // Signature: (EffectType, name, location, durationRounds, behaviorState)
            // Pass null for durationRounds - concentration tracks its own progress, not epoch-based expiry
            var effect = effectPortal.CreateChild(
                EffectType.Concentration,
                $"Treating: {Character.Name}",
                null,  // location - not applicable for concentration
                (int?)null,  // durationRounds - null for progress-based concentration
                stateJson);

            Character.Effects.AddEffect(effect);
            message = $"{Character.Name} begins {skillName} treatment " +
                     $"(SV {checkResult.SuccessValue}, {checkResult.HealingAmount} healing in {checkResult.ConcentrationRounds} rounds)";
        }
        else
        {
            // Other target - just report the result, no concentration on this character
            message = $"{Character.Name} performs {skillName} check: " +
                     $"SV {checkResult.SuccessValue} = {checkResult.HealingAmount} FAT/VIT healing " +
                     $"(apply to target after {checkResult.ConcentrationRounds} rounds)";
        }

        // Save and complete
        if (Character is Csla.Core.ISavable savable)
        {
            await savable.SaveAsync();
        }

        await OnMedicalComplete.InvokeAsync(new MedicalCompleteData
        {
            Message = message,
            Success = true,
            HealingAmount = checkResult.HealingAmount,
            ConcentrationRounds = checkResult.ConcentrationRounds
        });
    }

    private void Reset()
    {
        hasRolled = false;
        checkResult = null;
    }
}
