@page "/forgot-password"

@using GameMechanics.Player
@using Csla

@inject IDataPortal<PasswordRecovery> portal
@inject NavigationManager NavigationManager

<PageTitle>Threa - Reset Password</PageTitle>

<h1>Reset Password</h1>

<p class="text-muted">Step @CurrentStep of 3</p>

@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="alert alert-danger">@ErrorMessage</div>
}

@if (!string.IsNullOrEmpty(InfoMessage))
{
    <div class="alert alert-info">@InfoMessage</div>
}

@if (CurrentStep == 1)
{
    <!-- Step 1: Enter Username -->
    <EditForm Model="Model" OnSubmit="SubmitUsername" FormName="step1form">
        <div class="mb-3">
            <label class="form-label">Username</label>
            <InputText class="form-control" @bind-Value="Model!.Username" />
            <small class="form-text text-muted">Enter your username to begin password recovery.</small>
        </div>
        <button type="submit" class="btn btn-primary">Continue</button>
        <a href="/login" class="btn btn-link">Back to Login</a>
    </EditForm>
}
else if (CurrentStep == 2)
{
    <!-- Step 2: Answer Secret Question -->
    <div class="mb-3">
        <strong>Security Question:</strong>
        <p class="border rounded p-2 bg-light">@SecretQuestion</p>
    </div>
    <EditForm Model="Model" OnSubmit="SubmitAnswer" FormName="step2form">
        <div class="mb-3">
            <label class="form-label">Your Answer</label>
            <InputText class="form-control" @bind-Value="Model!.SecretAnswer" />
            <small class="form-text text-muted">Answer is case-insensitive.</small>
        </div>
        <button type="submit" class="btn btn-primary">Verify</button>
        <button type="button" class="btn btn-secondary" @onclick="GoBackToStep1">Back</button>
    </EditForm>
}
else if (CurrentStep == 3)
{
    <!-- Step 3: Set New Password -->
    <EditForm Model="Model" OnSubmit="SubmitNewPassword" FormName="step3form">
        <div class="mb-3">
            <label class="form-label">New Password</label>
            <InputText type="password" class="form-control" @bind-Value="Model!.NewPassword" />
            <small class="form-text text-muted">Minimum 6 characters.</small>
        </div>
        <div class="mb-3">
            <label class="form-label">Confirm Password</label>
            <InputText type="password" class="form-control" @bind-Value="Model!.ConfirmPassword" />
        </div>
        <button type="submit" class="btn btn-primary">Reset Password</button>
        <button type="button" class="btn btn-secondary" @onclick="GoBackToStep2">Back</button>
    </EditForm>
}

@code {
    [SupplyParameterFromForm]
    public RecoveryModel? Model { get; set; }

    private int CurrentStep { get; set; } = 1;
    private string ErrorMessage { get; set; } = "";
    private string InfoMessage { get; set; } = "";
    private string SecretQuestion { get; set; } = "";

    protected override void OnInitialized()
    {
        Model ??= new();
    }

    private async Task SubmitUsername()
    {
        ErrorMessage = "";
        InfoMessage = "";

        if (string.IsNullOrWhiteSpace(Model!.Username))
        {
            ErrorMessage = "Please enter your username.";
            return;
        }

        try
        {
            var cmd = await portal.CreateAsync();
            cmd.Username = Model.Username;
            cmd = await portal.ExecuteAsync(cmd);

            if (cmd.IsLockedOut)
            {
                ErrorMessage = cmd.ErrorMessage;
                return;
            }

            // Store the question and advance
            SecretQuestion = cmd.SecretQuestion;

            // Show generic message regardless of whether user exists (prevent enumeration)
            InfoMessage = "If that username exists, the secret question will be shown.";

            if (!string.IsNullOrEmpty(SecretQuestion))
            {
                CurrentStep = 2;
                InfoMessage = ""; // Clear message when advancing
            }
        }
        catch (DataPortalException ex)
        {
            ErrorMessage = ex.BusinessExceptionMessage ?? "An error occurred. Please try again.";
        }
    }

    private async Task SubmitAnswer()
    {
        ErrorMessage = "";
        InfoMessage = "";

        if (string.IsNullOrWhiteSpace(Model!.SecretAnswer))
        {
            ErrorMessage = "Please enter your answer.";
            return;
        }

        try
        {
            var cmd = await portal.CreateAsync();
            cmd.Username = Model.Username;
            cmd.SecretAnswer = Model.SecretAnswer;
            cmd = await portal.ExecuteAsync(cmd);

            if (cmd.IsLockedOut)
            {
                ErrorMessage = cmd.ErrorMessage;
                return;
            }

            if (!cmd.IsAnswerValid)
            {
                ErrorMessage = cmd.ErrorMessage;
                return;
            }

            // Answer correct - advance to step 3
            CurrentStep = 3;
        }
        catch (DataPortalException ex)
        {
            ErrorMessage = ex.BusinessExceptionMessage ?? "An error occurred. Please try again.";
        }
    }

    private async Task SubmitNewPassword()
    {
        ErrorMessage = "";
        InfoMessage = "";

        // Client-side validation
        if (string.IsNullOrWhiteSpace(Model!.NewPassword))
        {
            ErrorMessage = "Please enter a new password.";
            return;
        }

        if (Model.NewPassword.Length < 6)
        {
            ErrorMessage = "Password must be at least 6 characters.";
            return;
        }

        if (Model.NewPassword != Model.ConfirmPassword)
        {
            ErrorMessage = "Passwords do not match.";
            return;
        }

        try
        {
            var cmd = await portal.CreateAsync();
            cmd.Username = Model.Username;
            cmd.NewPassword = Model.NewPassword;
            cmd = await portal.ExecuteAsync(cmd);

            if (!cmd.PasswordResetSuccess)
            {
                ErrorMessage = cmd.ErrorMessage;
                return;
            }

            // Success - redirect to login
            NavigationManager.NavigateTo("/login?passwordreset=true");
        }
        catch (DataPortalException ex)
        {
            ErrorMessage = ex.BusinessExceptionMessage ?? "An error occurred. Please try again.";
        }
    }

    private void GoBackToStep1()
    {
        CurrentStep = 1;
        ErrorMessage = "";
        InfoMessage = "";
        SecretQuestion = "";
        Model!.SecretAnswer = "";
    }

    private void GoBackToStep2()
    {
        CurrentStep = 2;
        ErrorMessage = "";
        Model!.NewPassword = "";
        Model.ConfirmPassword = "";
    }

    public class RecoveryModel
    {
        public string Username { get; set; } = string.Empty;
        public string SecretAnswer { get; set; } = string.Empty;
        public string NewPassword { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
