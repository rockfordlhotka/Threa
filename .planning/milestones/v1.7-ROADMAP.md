# Milestone v1.7: Combat Tab Rework

**Status:** ✅ SHIPPED 2026-02-13
**Phases:** 32-36
**Total Plans:** 10

## Overview

Consolidate Combat and Defense tabs into a single compact tab with icon+label buttons organized in three groups (Actions, Defense, Other), add anonymous action and skill check features, and verify anonymous target attacks. Related to Issues #104, #105.

## Phases

### Phase 32: Layout Restructuring

**Goal**: Player sees a single Combat tab with three clearly labeled button groups instead of the old two-tab layout with large buttons and a skills list
**Depends on**: Nothing (first phase of v1.7)
**Requirements**: LAY-01, LAY-02, LAY-03, LAY-04, LAY-05
**Plans**: 2 plans

Plans:
- [x] 32-01-PLAN.md — Add combat tile CSS and restructure TabCombat Default mode (three groups, left panel, compact tiles)
- [x] 32-02-PLAN.md — Remove Defense tab from Play.razor, wire activity log to TabCombat, visual verification

**Details:**
- Added 93 lines of combat tile CSS with group accent colors, sci-fi glow effects, and card header accent lines
- Replaced old two-column layout with three-group card layout (Actions, Defense, Other)
- Left panel shows FAT/VIT progress bars, wound count, and equipped armor with durability bars
- All 11 combat action buttons always visible, disabled when unavailable
- Defense tab removed from Play.razor tab navigation
- Activity log wired to TabCombat with conditional rendering to prevent duplication
- ActivityLogEntry record made public in Play.razor for cross-component sharing

### Phase 33: Attack Actions

**Goal**: Player can initiate melee and ranged attacks from the Actions group, with verified AV display for solo melee and TV modifier support for solo ranged
**Depends on**: Phase 32
**Requirements**: ACT-01, ACT-02, VER-01, VER-02
**Plans**: 2 plans

Plans:
- [x] 33-01-PLAN.md — Add ranged button tooltip and wire anonymous target selection into melee AttackMode
- [x] 33-02-PLAN.md — Add anonymous target support to RangedAttackMode with simplified TV input and SV-only result

**Details:**
- Anonymous Target as first-class option in target selection (not a fallback)
- Melee anonymous target displays Attack Value (AV) to player
- Ranged anonymous target uses simplified single TV modifier input replacing full range/conditions UI
- SV-only result display showing AV - TV = SV prominently
- Used FirearmAttackResolver with TVAdjustment offset to preserve resolver logic while giving player TV control
- "Change Target" button in results footer for explicit target switching

### Phase 34: New Action Types

**Goal**: Player can perform attribute-only anonymous actions and skill checks from the Actions group without using the attack workflow
**Depends on**: Phase 32
**Requirements**: ACT-03, ACT-04
**Plans**: 2 plans

Plans:
- [x] 34-01-PLAN.md — Create AnonymousActionMode component and integrate into TabCombat Actions group
- [x] 34-02-PLAN.md — Create CombatSkillPickerModal + SkillCheckMode and integrate into TabCombat Actions group

**Details:**
- AnonymousActionMode: attribute dropdown, cost selector, TV input, boost selector, 4dF+ roll with wound/multi-action penalties
- CombatSkillPickerModal: Radzen dialog showing all skills grouped by PrimaryAttribute with search/filter
- SkillCheckMode: modal-first flow, then inline panel with AS + 4dF+ vs TV resolution
- Both modes handle concentration break checks, parry mode end, cost deduction, and CSLA save
- Result messages follow established format: "{Name}: {Skill} AS {effectiveAS} + 4dF+ ({diceRoll}) = {total} vs TV {tv} -> SV {sv}"

### Phase 35: Defense Group

**Goal**: Player can defend, take damage, and set stances from the Defense group on the Combat tab
**Depends on**: Phase 32
**Requirements**: DEF-01, DEF-02, DEF-03
**Plans**: 2 plans

Plans:
- [x] 35-01-PLAN.md — Add stance chip CSS, extend CombatStanceBehavior, and add stance toggle chips to Defense group
- [x] 35-02-PLAN.md — Wire ActiveStance pre-selection to DefendMode and add Defend button AP hint

**Details:**
- Stance chip CSS (pill-shaped, active/disabled/hover states, scifi theme glow)
- CombatStanceBehavior extended with DodgeFocus and BlockWithShield constants, helpers, and state creators
- OnAdding updated to enforce single active stance (replaces any existing CombatStance)
- 4 stance chips: Normal, Parry Mode, Dodge Focus, Block with Shield
- DefendMode accepts ActiveStance parameter and pre-selects matching defense type on load
- Pre-selection guarded by !hasRolled to avoid overriding player choice after a roll

### Phase 36: Other Group

**Goal**: Player can access all utility actions (medical, rest, implants, reload, unload) from the Other group
**Depends on**: Phase 32
**Requirements**: OTH-01, OTH-02, OTH-03, OTH-04, OTH-05
**Plans**: 2 plans

Plans:
- [x] 36-01-PLAN.md — Wire Other group button visibility, add Rest confirmation flow, create dimming CSS class
- [x] 36-02-PLAN.md — Apply cost-aware dimming across all three combat tile groups with cost tooltips

**Details:**
- Conditional buttons (Implants, Reload, Unload) hidden via @if guards when preconditions not met
- Rest confirmation panel with CombatMode.Rest following established pattern
- combat-tile-dimmed CSS class applied to all 12 buttons across all three groups
- Two-tier visual system: CSS dimming for resource insufficiency (clickable), disabled for hard blocks only
- Cost-explaining tooltips switch between action description and cost requirement
- Removed stale combat-tile-passive-only CSS class

---

## Milestone Summary

**Key Decisions:**
- All combat buttons always rendered and disabled when unavailable instead of hidden with @if (better discoverability)
- Anonymous Target as first-class option in target list, not a fallback
- Used FirearmAttackResolver with TVAdjustment offset for anonymous targets (preserves resolver logic)
- OnAdding replaces ANY existing CombatStance (not just same-name) for mutual exclusivity
- Pre-selection guarded by !hasRolled to avoid overriding player choice after roll
- StartRest checks only IsPassedOut, not CanRest(), allowing panel to open with insufficient AP
- Disabled attribute reserved for hard blocks only; CSS dimming for resource insufficiency

**Issues Resolved:**
- Defense tab consolidated into Combat tab (no more tab switching for combat actions)
- Combat skills list replaced by on-demand modal picker (saves screen space)
- Missing anonymous action capability added (attribute-only rolls without attack workflow)
- Missing skill check capability added (standalone skill resolution without attack)

**Issues Deferred:**
- Armor summary display on Combat tab (placeholder/TODO from Defense tab)
- Incoming attack response UI (placeholder from Defense tab)
- Keyboard shortcuts for combat actions (power user feature)

**Technical Debt Incurred:**
- Unused skill filtering methods (filteredSkills, GetGroupedSkills, GetCategoryOrder) — dead code from old skills list
- TabDefense.razor file retained but not referenced — intentionally kept for pattern reference
- Pre-existing TODO comment at TabCombat.razor line 590 — unrelated to v1.7 work

---

_For current project status, see .planning/ROADMAP.md_
