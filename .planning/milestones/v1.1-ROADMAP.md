# Milestone v1.1: User Management & Authentication

**Status:** ✅ SHIPPED 2026-01-26
**Phases:** 8-11
**Total Plans:** 8

## Overview

Enable self-service user registration and admin user management without email dependency. Users can register, recover passwords via secret Q&A, and manage profiles with Gravatar integration.

## Phases

### Phase 8: Registration Foundation

**Goal**: New users can self-register and the first user automatically becomes the system administrator
**Depends on**: Phase 7 (existing auth system)
**Requirements**: AUTH-01, AUTH-02, AUTH-03
**Plans**: 2 plans

**Success Criteria** (what must be TRUE):
1. New user can access registration page and create account with username, password (min 6 chars), and secret question/answer
2. First registered user in the system automatically has Admin role after registration completes
3. Subsequent registered users have User role by default (not Admin, not GameMaster)
4. Duplicate usernames are rejected with clear error message

Plans:
- [x] 08-01-PLAN.md - Data layer and UserRegistration business object with validation, first-user-admin logic
- [x] 08-02-PLAN.md - Registration UI page and login page link

**Deliverables:**
- Player DTO with SecretQuestion and SecretAnswer fields
- UserRegistration CSLA business object with validation rules (Required, MinLength, MaxLength)
- First-user-admin logic with BCrypt password hashing (salt factor 12)
- Registration UI page at /register with CSLA error display
- Login page integration with registration link and success message
- 11 unit tests covering validation and insert logic

---

### Phase 9: Password Recovery

**Goal**: Users who forget their password can reset it using their secret question/answer
**Depends on**: Phase 8
**Requirements**: AUTH-04, AUTH-05, AUTH-06
**Plans**: 2 plans

**Success Criteria** (what must be TRUE):
1. User can initiate password reset by entering their username
2. System displays the user's secret question (without revealing answer)
3. User's answer is validated case-insensitively with trimmed whitespace
4. After correct answer, user can set a new password and immediately log in
5. Incorrect answer shows error but does not reveal correct answer

Plans:
- [x] 09-01-PLAN.md - Data layer extensions and PasswordRecovery business object with lockout logic
- [x] 09-02-PLAN.md - Password recovery UI wizard (3 steps)

**Deliverables:**
- PasswordRecovery CSLA CommandBase with step-based execution
- IPlayerDal recovery methods (GetSecretQuestionAsync, ValidateSecretAnswerAsync, ResetPasswordAsync, IsRecoveryLockedOutAsync, GetRemainingRecoveryAttemptsAsync)
- Player DTO lockout fields (FailedRecoveryAttempts, RecoveryLockoutUntil)
- Lockout protection (3 attempts, 15-minute duration)
- ForgotPassword.razor 3-step wizard UI
- Login page forgot password link and success message
- 8 unit tests covering all recovery scenarios
- Case-insensitive answer validation with username enumeration prevention

---

### Phase 10: Admin User Management

**Goal**: Administrators can view, enable/disable, and assign roles to all users
**Depends on**: Phase 8
**Requirements**: USER-01, USER-02, USER-03, USER-04, USER-05, USER-06
**Plans**: 2 plans

**Success Criteria** (what must be TRUE):
1. Admin can view list of all users showing username, display name, roles, and enabled status
2. Admin can disable a user account (user cannot log in, but data preserved)
3. Admin can enable a previously disabled user account
4. Admin can assign and remove roles (User, GameMaster, Admin) to any user
5. Disabled users are blocked at login with appropriate message

Plans:
- [x] 10-01-PLAN.md - DAL and LastAdminProtectionRule business rule
- [x] 10-02-PLAN.md - Admin user management UI with modal editing

**Deliverables:**
- CountEnabledAdminsAsync DAL method
- LastAdminProtectionRule async business rule (prevents system lockout)
- UserEditModal component for modal user editing
- Enhanced Users.razor with sortable QuickGrid
- Self-edit warnings and confirmation dialogs
- Disabled user login blocking via UserValidation
- 6 unit tests for last-admin protection

---

### Phase 11: User Profiles

**Goal**: Users can customize their profiles with display names, email, and Gravatar-based avatars
**Depends on**: Phase 8
**Requirements**: PROF-01, PROF-02, PROF-03, PROF-04, PROF-05, PROF-06, PROF-07
**Plans**: 2 plans

**Success Criteria** (what must be TRUE):
1. User can set a display name (shown throughout UI instead of username)
2. User can optionally provide and update their email address
3. When email is provided, user avatar displays via Gravatar (with retro fallback)
4. When email is not provided, avatar displays initials from display name
5. User can view their own profile page
6. Users can view other users' public profiles showing display name and avatar

Plans:
- [x] 11-01-PLAN.md - Data layer, DTO extensions, profanity filter rule, and PlayerEdit BO enhancements
- [x] 11-02-PLAN.md - UserAvatar component, profile edit UI with Gravatar preview, avatar integration in nav and admin

**Deliverables:**
- Player DTO ContactEmail and UseGravatar fields
- PlayerEdit enhanced with profile validation
- ProfileInfo read-only business object for public profiles
- NoProfanityRule CSLA business rule (uses Profanity.Detector library, handles Scunthorpe problem)
- UserAvatar reusable component with Gravatar/initials fallback
- Profile.razor public profile page at /profile/{id}
- Enhanced PlayerEdit.razor with live Gravatar preview
- Avatar integration in nav bar and admin user list

---

## Milestone Summary

**Execution Order:**
Phases 9, 10, 11 could execute in parallel after Phase 8 completed, as they had minimal interdependencies. All phases completed on 2026-01-26.

**Key Decisions:**

| Decision | Rationale | Outcome |
|----------|-----------|---------|
| BCrypt password hashing (salt factor 12) | Match existing AdminUserEdit pattern for consistency | ✓ Good - Consistent security across system |
| Secret answer normalization (trim + lowercase) | User-friendly validation for password recovery | ✓ Good - Reduces user frustration |
| 3-attempt lockout with 15-minute duration | Balance security vs usability for password recovery | ✓ Good - Prevents brute-force without excessive lockout |
| Username enumeration prevention | Generic messages on password recovery step 1 | ✓ Good - Security best practice |
| Last-admin protection rule | Prevent accidental system lockout | ✓ Good - Critical safety feature |
| Profanity.Detector library for display names | Handles Scunthorpe problem, maintained word list | ✓ Good - Better than basic word list |
| ContactEmail separate from Email field | Legacy Email field contains username, not email | ✓ Good - Preserves existing data structure |
| UserAvatar component with Gravatar/initials | Reusable across UI, graceful degradation | ✓ Good - Clean abstraction |
| DoNotParallelize attribute for MockDb tests | Shared state causes race conditions | ✓ Good - Tests reliable |
| ApplicationContext.GetRequiredService for async rules | CreateInstanceDI doesn't work for interfaces | ✓ Good - Proper DI resolution |

**Issues Resolved:**
- Phase 8: MockDb PlayerDal not saving new secret Q&A fields - Fixed by updating SavePlayerAsync
- Phase 8: MockDb re-hashing already-hashed passwords - Fixed by detecting BCrypt hash format
- Phase 9: SQLite DAL missing recovery method implementations - Added all 5 methods to maintain interface parity
- Phase 10: Namespace reference in DAL using GameMechanics types - Fixed by using string literal "Administrator"
- Phase 11: Profanity.Detector namespace mismatch - Corrected from Profanity.Detector to ProfanityFilter

**Issues Deferred:**
- None - All planned features delivered

**Technical Debt Incurred:**
- None - Clean implementation across all phases
- Pre-existing v1.0 tech debt remains (ArmorInfoFactory orphaned, weapon filtering in UI layer, case sensitivity inconsistencies, OnCharacterChanged callback not wired)

**Security Posture:**
- BCrypt password hashing with salt factor 12
- Brute-force protection (3-attempt lockout, 15-minute duration)
- Username enumeration prevention
- Last-admin protection prevents system lockout
- CSRF protection via ASP.NET Core built-in
- SQL injection prevention via parameterized queries

**Future Enhancements (Deferred):**
- Hash secret answers instead of storing plaintext (AUTH-07)
- Password complexity rules (AUTH-08)
- Two-factor authentication (AUTH-09)
- Session timeout settings (AUTH-07)
- Audit logging (USER-07)
- Custom avatar upload alternative to Gravatar (PROF-08)

---

_For current project status, see .planning/ROADMAP.md_
_Archived: 2026-01-26 as part of v1.1 milestone completion_
