---
phase: 32-layout-restructuring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Threa/Threa/wwwroot/css/themes.css
  - Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor
autonomous: true

must_haves:
  truths:
    - "Combat tab Default mode shows three card groups labeled Actions, Defense, and Other"
    - "All buttons use compact icon-above-label tile style instead of large full-width buttons"
    - "Combat skills list no longer appears on the Combat tab"
    - "Left panel shows FAT/VIT detail and armor info on wide screens"
    - "Resource summary (AP/FAT/VIT duplicate) is removed from the Combat tab"
    - "Activity feed rendering area exists in Combat tab Default mode"
    - "Both fantasy and sci-fi themes render correctly for new styles"
  artifacts:
    - path: "Threa/Threa/wwwroot/css/themes.css"
      provides: "Combat tile button CSS and group accent colors for both themes"
      contains: ".combat-tile"
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor"
      provides: "Restructured Default mode with three groups, left panel, activity feed area"
      contains: "combat-group-actions"
  key_links:
    - from: "TabCombat.razor"
      to: "themes.css"
      via: "CSS class references"
      pattern: "combat-tile|combat-group"
---

<objective>
Restructure TabCombat.razor's Default mode from a two-column skills+buttons layout to a left-panel + three-group-cards layout with compact tile buttons, and add the supporting CSS.

Purpose: This is the core layout change for Phase 32 — replacing the old large-button combat UI with a compact three-group design that reduces visual noise and groups actions logically.

Output: Restructured TabCombat.razor Default mode markup + combat tile CSS in themes.css. TabCombat will also gain new parameters for activity log data (wired by Plan 02).
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-layout-restructuring/32-CONTEXT.md
@.planning/phases/32-layout-restructuring/32-RESEARCH.md
@Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor
@Threa/Threa/wwwroot/css/themes.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add combat tile CSS to themes.css</name>
  <files>Threa/Threa/wwwroot/css/themes.css</files>
  <action>
Add the following CSS to the end of themes.css (before any closing comments):

**Compact combat tile button styles:**
- `.combat-tile` — flex column layout, icon above label, min-width 80px, padding 0.5rem 0.75rem, gap 0.25rem, font-size 0.8rem, uppercase, letter-spacing 0.05em, font-family var(--font-display), border 1px solid var(--color-card-border), background var(--color-card-bg), color var(--color-text-primary), border-radius var(--border-radius), transition all 0.2s ease
- `.combat-tile i` — font-size 1.2rem
- `.combat-tile:disabled` — opacity 0.4, cursor not-allowed
- `.combat-tile:not(:disabled):hover` — slight background shift using var(--color-bg-tertiary)

**Group accent color styles (use theme variables for theme safety):**
- `.combat-tile-actions` — border-color var(--color-accent-red)
- `.combat-tile-actions:not(:disabled):hover` — background var(--color-accent-red), color white
- `.combat-tile-defense` — border-color var(--color-accent-blue)
- `.combat-tile-defense:not(:disabled):hover` — background var(--color-accent-blue), color white
- `.combat-tile-other` — border-color var(--color-accent-secondary)
- `.combat-tile-other:not(:disabled):hover` — background var(--color-accent-secondary), color white

**Sci-fi theme enhancements (under [data-theme="scifi"] selector):**
- `.combat-tile-actions` — box-shadow 0 0 5px var(--color-accent-red)
- `.combat-tile-defense` — box-shadow 0 0 5px var(--color-accent-blue)
- `.combat-tile-other` — box-shadow 0 0 5px var(--color-accent-secondary)

**Combat group card header accent lines:**
- `.combat-group-actions .card-header` — border-left 3px solid var(--color-accent-red)
- `.combat-group-defense .card-header` — border-left 3px solid var(--color-accent-blue)
- `.combat-group-other .card-header` — border-left 3px solid var(--color-accent-secondary)

All colors MUST use CSS custom properties (theme variables), never hard-coded hex values. This ensures both fantasy and sci-fi themes work correctly since each theme defines different values for the same variable names.
  </action>
  <verify>
Search themes.css for `.combat-tile` and `.combat-group-actions` — both must exist. Verify no hard-coded hex colors in the new CSS (only var() references). Run `dotnet build Threa.sln` to confirm no issues.
  </verify>
  <done>themes.css contains combat tile styles with group accent colors, compatible with both fantasy and sci-fi themes via CSS custom properties</done>
</task>

<task type="auto">
  <name>Task 2: Restructure TabCombat.razor Default mode</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor</files>
  <action>
This task modifies ONLY the Default mode HTML block in TabCombat.razor (the `@if (combatMode == CombatMode.Default)` section, currently lines ~20-252). The @code block, all sub-mode else-if branches, and all sub-mode component renderings remain UNTOUCHED.

**Add two new parameters** in the @code block (alongside existing parameters):

```csharp
[Parameter]
public List<Play.ActivityLogEntry>? ActivityEntries { get; set; }

[Parameter]
public Func<ActivityCategory, string>? GetActivityCssClass { get; set; }
```

NOTE: If `ActivityLogEntry` or `ActivityCategory` are private records in Play.razor, you'll need to either:
- Make them public/internal in Play.razor, OR
- Create simple public types, OR
- Pass simpler types (e.g., List of tuples or a lightweight DTO)

Use whichever approach is cleanest. The key is that TabCombat can render activity log entries with CSS classes.

**Replace the Default mode HTML** (`@if (combatMode == CombatMode.Default) { ... }`) with the new three-group layout:

```
Row (Bootstrap grid)
├── Left Panel (col-lg-3, collapses to full-width on smaller screens)
│   ├── Card: "Health Pools" (bi-heart-pulse icon)
│   │   └── FAT: current/base, VIT: current/base, wound count with AS penalty
│   └── Card: "Armor" (bi-shield icon)
│       └── List equipped armor pieces with slot, name, and durability bar
│           (Use equippedItems data already loaded in @code block)
│           (Filter to items where Template?.ItemType is Armor or Shield)
│           (Show "No armor equipped" if none found)
│
├── Right Panel (col-lg-9)
│   ├── Card: "Actions" (bi-lightning-charge icon, class combat-group-actions)
│   │   └── d-flex flex-wrap gap-2 of compact tile buttons:
│   │       - Attack (bi-bullseye, combat-tile-actions, @onclick=StartAttack, disabled=!CanAct())
│   │       - Ranged (bi-crosshair, combat-tile-actions, @onclick=StartRangedAttack, disabled=!CanAct() || !hasRangedWeaponEquipped)
│   │         NOTE: Show button ALWAYS (even without ranged weapon), just disabled. No @if hiding.
│   │
│   ├── Card: "Defense" (bi-shield-shaded icon, class combat-group-defense)
│   │   └── d-flex flex-wrap gap-2 of compact tile buttons:
│   │       - Defend (bi-shield-shaded, combat-tile-defense, @onclick=StartDefend, disabled=Character?.IsPassedOut)
│   │       - Take Damage (bi-bandaid, combat-tile-defense, @onclick=StartTakeDamage, always enabled)
│   │
│   ├── Card: "Other" (bi-gear icon, class combat-group-other)
│   │   └── d-flex flex-wrap gap-2 of compact tile buttons:
│   │       - Medical (bi-heart-pulse, combat-tile-other, @onclick=StartMedical, disabled=!CanAct())
│   │       - Rest (bi-cup-hot, combat-tile-other, @onclick=Rest, disabled=!CanRest())
│   │       - Implants (bi-cpu, combat-tile-other, @onclick=StartActivateImplant, disabled=!hasToggleableImplantsEquipped)
│   │         NOTE: Show button ALWAYS, disabled when no toggleable implants.
│   │       - Reload (bi-box-arrow-in-down, combat-tile-other, @onclick=StartReload, disabled=!CanAct() || !hasRangedWeaponEquipped)
│   │       - Unload (bi-box-arrow-up, combat-tile-other, @onclick=StartUnload, disabled when no weapon has ammo)
│   │         NOTE: Show ALL buttons always. Disable unavailable ones. No @if to hide.
│   │
│   └── Activity Feed (activity-log activity-log-container class)
│       └── Render ActivityEntries (last 10, reversed) using same markup pattern as Play.razor:
│           foreach entry: <div class="small @GetActivityCssClass(entry.Category)">timestamp + source + message</div>
│           If ActivityEntries is null or empty: "No recent activity." placeholder
```

**What to REMOVE from the Default mode block:**
1. The entire "Combat Skills Column" (col-md-7 with skill list) — skills stay on their own tab
2. The "Resource Summary" card at the bottom of the action buttons column (AP/FAT/VIT — already in page header)
3. The old large `btn-lg` buttons — replaced by compact tiles in the three groups

**What to PRESERVE:**
- The `<div class="combat-tab-container">` wrapper
- All sub-mode else-if branches (Attack, Defend, TakeDamage, RangedAttack, Reload, Unload, Medical, ActivateImplant, SelectTarget)
- The entire @code block (all fields, methods, event handlers)
- The "Round @Table.CurrentRound" badge — move it to the Actions card header (if Table.IsInCombat)

**Button tile markup pattern** (repeat for each button):
```razor
<button class="btn combat-tile combat-tile-actions"
        @onclick="StartAttack"
        disabled="@(!CanAct())"
        title="Melee attack (1 AP + 1 FAT)">
    <i class="bi bi-bullseye"></i>
    <span>Attack</span>
</button>
```

**For the targeted attack buttons** (Attack + Target split): In the new compact layout, do NOT replicate the btn-group split. Just have a single "Attack" tile and a single "Target" tile (bi-person-plus) next to it. The Target tile calls `StartTargetedAttack(TargetingActionType.MeleeAttack)`. Same for ranged: one "Ranged" tile + one "Ranged Target" tile if HasTargetsAvailable(). If no targets available, show only the solo tile, but still show the Target tile disabled.

**Armor info in left panel:**
Use the already-loaded `equippedItems` list from @code. Filter for armor pieces:
```csharp
equippedItems.Where(i => i.Template?.ItemType == ItemType.Armor || i.Template?.ItemType == ItemType.Shield)
```
Show each piece's slot (EquippedSlot), name (Template.Name), and a basic durability bar if durability data is available. If no armor equipped, show "No armor equipped" placeholder.

**Health pools in left panel:**
- FAT: Show `Character.Fatigue.Value / Character.Fatigue.BaseValue` with color-coded text (red if low)
- VIT: Show `Character.Vitality.Value / Character.Vitality.BaseValue` with color-coded text (red if low)
- Wounds: Show count with AS penalty (same as header's wound count display)
  </action>
  <verify>
Run `dotnet build Threa.sln` — must compile with zero errors. Grep TabCombat.razor for "combat-group-actions", "combat-group-defense", "combat-group-other" — all three must exist. Grep for "Combat Skills" (the old header) — must NOT exist in the Default mode block. Grep for the old resource summary div with "col-4" AP/FAT/VIT pattern — must NOT exist.
  </verify>
  <done>TabCombat.razor Default mode shows three-group card layout with compact tile buttons, left detail panel with health pools and armor, activity feed area, and no skills list or resource summary card</done>
</task>

</tasks>

<verification>
1. `dotnet build Threa.sln` compiles successfully
2. TabCombat.razor contains three card groups with classes `combat-group-actions`, `combat-group-defense`, `combat-group-other`
3. All buttons use `combat-tile` CSS class (no `btn-lg` buttons remain in Default mode)
4. No `@if` hides buttons — all buttons are always rendered, disabled when unavailable
5. "Combat Skills" section is gone from Default mode
6. Old resource summary (AP/FAT/VIT triple) is gone from Default mode
7. themes.css contains `.combat-tile` and group accent styles
8. Both fantasy and sci-fi themes use CSS variables only (no hard-coded colors)
</verification>

<success_criteria>
- TabCombat Default mode renders three distinct button groups in card containers
- All buttons are compact tiles (icon + short label)
- Left panel shows health pool detail and armor info
- Activity feed area accepts entries as parameter
- Skills list removed from Combat tab
- Resource summary removed (already in header)
- Solution builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/32-layout-restructuring/32-01-SUMMARY.md`
</output>
