---
phase: 32-layout-restructuring
plan: 02
type: execute
wave: 2
depends_on: ["32-01"]
files_modified:
  - Threa/Threa.Client/Components/Pages/GamePlay/Play.razor
autonomous: false

must_haves:
  truths:
    - "Defense tab is gone from the play page tab bar"
    - "Activity log entries appear inside the Combat tab when it is active"
    - "Activity log does not render twice (not both in Play.razor AND TabCombat)"
    - "All other tabs (Status, Skills, Magic, Inventory) still work"
    - "Solution builds and the play page loads without errors"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/Play.razor"
      provides: "Updated tab array without Defense, activity log passed to TabCombat"
      contains: "ActivityEntries"
  key_links:
    - from: "Play.razor"
      to: "TabCombat.razor"
      via: "ActivityEntries and GetActivityCssClass parameters"
      pattern: "ActivityEntries=.*activityLog"
---

<objective>
Wire the restructured TabCombat into Play.razor: remove the Defense tab, pass activity log data to TabCombat, and ensure the activity feed renders inside the Combat tab instead of duplicating below all tabs.

Purpose: Completes the layout restructuring by removing the old Defense tab from navigation and connecting the activity feed to the new Combat tab layout built in Plan 01.

Output: Updated Play.razor with Defense tab removed and activity log parameters wired to TabCombat.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-layout-restructuring/32-CONTEXT.md
@.planning/phases/32-layout-restructuring/32-01-SUMMARY.md
@Threa/Threa.Client/Components/Pages/GamePlay/Play.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove Defense tab and wire activity log to TabCombat</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/Play.razor</files>
  <action>
Make these targeted changes to Play.razor:

**1. Remove "Defense" from the tab array (line ~342):**
```csharp
// Before:
private static readonly string[] AllTabNames = new[] { "Status", "Combat", "Defense", "Skills", "Magic", "Inventory" };

// After:
private static readonly string[] AllTabNames = new[] { "Status", "Combat", "Skills", "Magic", "Inventory" };
```

**2. Remove the Defense tab rendering block (around line ~273-275):**
Delete these lines entirely:
```razor
else if (activeTab == "Defense")
{
    <TabDefense Character="character" Table="table" />
}
```

**3. Make ActivityLogEntry and GetActivityClass accessible to TabCombat:**

The `ActivityLogEntry` record (line ~384) is currently private. The `GetActivityClass` method (line ~793) is also private. To pass these to TabCombat:

Option A (preferred — simplest): Make `ActivityLogEntry` a public record inside Play.razor's @code block:
```csharp
public record ActivityLogEntry(DateTime Timestamp, string Message, string Source, ActivityCategory Category);
```

ActivityCategory is already a public enum from GameMechanics.Messaging.

If making the record public in the @code block causes issues (Blazor component nested types), create a small standalone class. But try public first — Blazor @code blocks support public nested types.

**4. Pass activity log data to TabCombat (around line ~258-262):**
Add the two new parameters to the TabCombat component invocation:
```razor
<TabCombat Character="character"
           Table="table"
           OnCharacterChanged="SaveCharacterAsync"
           AvailableTargets="@GetAvailableTargets()"
           OnInitiateTargeting="HandleInitiateTargeting"
           ActivityEntries="@activityLog"
           GetActivityCssClass="GetActivityClass" />
```

**5. Conditionally hide the activity log at the bottom of Play.razor:**

The activity log section (lines ~312-329) currently renders below ALL tab content. Since the Combat tab now has its own activity feed, either:
- Option A: Always show the bottom activity log (it serves all tabs). This means it shows twice on the Combat tab — NOT desired.
- Option B (preferred): Conditionally hide the bottom activity log when the Combat tab is active:
```razor
@if (activeTab != "Combat")
{
    <!-- Activity Log -->
    <div class="activity-log mt-3 activity-log-container">
        ...existing activity log markup...
    </div>
}
```

This way: Combat tab shows activity log inside the tab layout (from Plan 01). All other tabs show the activity log below as before. No duplication.

**6. EnsureValidActiveTab safety:**
The `EnsureValidActiveTab` method (line ~357) resets to "Status" if the active tab isn't in `tabNames`. Since we removed "Defense", any user who had Defense as their active tab will automatically reset to Status. No change needed here — the existing logic handles it.

**Do NOT:**
- Delete TabDefense.razor file (it can remain as dead code for now; later phases may reference its patterns)
- Change any other tab rendering
- Modify the TabCombat @code block (that was done in Plan 01)
- Touch the targeting modal or any other Play.razor functionality
  </action>
  <verify>
Run `dotnet build Threa.sln` — must compile with zero errors. Grep Play.razor for `"Defense"` — should NOT appear in AllTabNames array or tab rendering. Grep for `ActivityEntries=` — must appear in TabCombat invocation. Grep for `activeTab != "Combat"` — must gate the bottom activity log.
  </verify>
  <done>Defense tab removed from navigation, activity log wired to TabCombat, bottom activity log hidden when Combat tab is active, solution compiles</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Phase 32 complete: Combat tab restructured with three button groups (Actions, Defense, Other), left detail panel (health pools + armor), compact tile buttons, activity feed, and Defense tab removed from navigation.
  </what-built>
  <how-to-verify>
1. Run the app: `cd Threa/Threa && dotnet run`
2. Navigate to the Play page for any character
3. Verify the tab bar: should show Status, Combat, Skills, Magic/Inventory — NO "Defense" tab
4. Click the "Combat" tab:
   - LEFT panel: "Health Pools" card (FAT/VIT values) + "Armor" card (equipped armor or "No armor equipped")
   - RIGHT panel: Three card groups stacked vertically:
     a. "Actions" card with compact tile buttons (Attack, Ranged, Target variants)
     b. "Defense" card with compact tile buttons (Defend, Take Damage)
     c. "Other" card with compact tile buttons (Medical, Rest, Implants, Reload, Unload)
   - Activity feed below the three groups
5. Verify buttons are compact tiles (icon above short label) — NOT large full-width buttons
6. Verify disabled buttons: Ranged, Implants should be disabled/grayed if no ranged weapon/implants equipped — but still visible (no layout shifts)
7. Click "Attack" tile — should enter the existing attack sub-mode (verify sub-modes still work)
8. Cancel back to Default, click "Defend" — should enter defend sub-mode
9. Switch to other tabs (Status, Skills, etc.) — verify they still work and show activity log below
10. Switch back to Combat — verify activity log shows inside the tab, not duplicated below
11. If the table has a sci-fi theme, verify the tiles have glow effects and sci-fi styling
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the layout, button behavior, or visual styling</resume-signal>
</task>

</tasks>

<verification>
1. `dotnet build Threa.sln` compiles successfully
2. Defense tab is gone from the play page tab navigation
3. Activity log renders inside Combat tab (not duplicated)
4. All other tabs (Status, Skills, Magic, Inventory) continue to work
5. Sub-mode navigation (Attack, Defend, etc.) still functions correctly from the new tile buttons
</verification>

<success_criteria>
- Defense tab removed from Play.razor tab array and rendering
- Activity log entries passed as parameters to TabCombat and rendered inside the Combat tab
- Activity log hidden from bottom of Play.razor when Combat tab is active (no duplication)
- All sub-modes still accessible via new compact tile buttons
- Solution builds without errors
- User visually confirms the layout matches the Phase 32 design intent
</success_criteria>

<output>
After completion, create `.planning/phases/32-layout-restructuring/32-02-SUMMARY.md`
</output>
