---
phase: 09-password-recovery
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - Threa/Threa/Components/Pages/ForgotPassword.razor
  - Threa/Threa/Components/Pages/Login.razor
autonomous: true

must_haves:
  truths:
    - "User can navigate to /forgot-password from login page"
    - "Step 1 accepts username and shows 'If username exists' message (prevents enumeration)"
    - "Step 2 displays secret question and accepts answer"
    - "Step 3 accepts new password with confirmation field"
    - "Incorrect answer shows remaining attempts count"
    - "Lockout displays appropriate message"
    - "Success redirects to login page with success message"
    - "Back navigation works between steps"
  artifacts:
    - path: "Threa/Threa/Components/Pages/ForgotPassword.razor"
      provides: "3-step password recovery wizard"
      min_lines: 100
    - path: "Threa/Threa/Components/Pages/Login.razor"
      provides: "Link to forgot password page"
      contains: "forgot-password"
  key_links:
    - from: "Threa/Threa/Components/Pages/ForgotPassword.razor"
      to: "PasswordRecovery"
      via: "IDataPortal injection and Execute"
      pattern: "IDataPortal<PasswordRecovery>"
    - from: "Threa/Threa/Components/Pages/Login.razor"
      to: "/forgot-password"
      via: "Navigation link"
      pattern: "href.*forgot-password"
---

<objective>
Create the password recovery UI wizard with 3 steps.

Purpose: Enable users to self-service reset their password through a guided wizard that validates their identity via secret question.

Output: ForgotPassword.razor wizard page with username entry, secret question answer, and password reset steps. Login page integration with forgot password link.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-password-recovery/09-CONTEXT.md
@.planning/phases/09-password-recovery/09-01-SUMMARY.md

# UI patterns to follow
@Threa/Threa/Components/Pages/Login.razor
@Threa/Threa/Components/Pages/Register.razor

# Business object
@GameMechanics/Player/PasswordRecovery.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ForgotPassword Wizard Page</name>
  <files>Threa/Threa/Components/Pages/ForgotPassword.razor</files>
  <action>
Create a 3-step password recovery wizard page following the existing Login.razor and Register.razor patterns:

```razor
@page "/forgot-password"

@using GameMechanics.Player
@using Csla

@inject IDataPortal<PasswordRecovery> portal
@inject NavigationManager NavigationManager

<PageTitle>Threa - Reset Password</PageTitle>

<h1>Reset Password</h1>

<p class="text-muted">Step @CurrentStep of 3</p>

@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="alert alert-danger">@ErrorMessage</div>
}

@if (!string.IsNullOrEmpty(InfoMessage))
{
    <div class="alert alert-info">@InfoMessage</div>
}

@if (CurrentStep == 1)
{
    <!-- Step 1: Enter Username -->
    <EditForm Model="Model" OnSubmit="SubmitUsername" FormName="step1form">
        <div class="mb-3">
            <label class="form-label">Username</label>
            <InputText class="form-control" @bind-Value="Model!.Username" />
            <small class="form-text text-muted">Enter your username to begin password recovery.</small>
        </div>
        <button type="submit" class="btn btn-primary">Continue</button>
        <a href="/login" class="btn btn-link">Back to Login</a>
    </EditForm>
}
else if (CurrentStep == 2)
{
    <!-- Step 2: Answer Secret Question -->
    <div class="mb-3">
        <strong>Security Question:</strong>
        <p class="border rounded p-2 bg-light">@SecretQuestion</p>
    </div>
    <EditForm Model="Model" OnSubmit="SubmitAnswer" FormName="step2form">
        <div class="mb-3">
            <label class="form-label">Your Answer</label>
            <InputText class="form-control" @bind-Value="Model!.SecretAnswer" />
            <small class="form-text text-muted">Answer is case-insensitive.</small>
        </div>
        <button type="submit" class="btn btn-primary">Verify</button>
        <button type="button" class="btn btn-secondary" @onclick="GoBackToStep1">Back</button>
    </EditForm>
}
else if (CurrentStep == 3)
{
    <!-- Step 3: Set New Password -->
    <EditForm Model="Model" OnSubmit="SubmitNewPassword" FormName="step3form">
        <div class="mb-3">
            <label class="form-label">New Password</label>
            <InputText type="password" class="form-control" @bind-Value="Model!.NewPassword" />
            <small class="form-text text-muted">Minimum 6 characters.</small>
        </div>
        <div class="mb-3">
            <label class="form-label">Confirm Password</label>
            <InputText type="password" class="form-control" @bind-Value="Model!.ConfirmPassword" />
        </div>
        <button type="submit" class="btn btn-primary">Reset Password</button>
        <button type="button" class="btn btn-secondary" @onclick="GoBackToStep2">Back</button>
    </EditForm>
}

@code {
    [SupplyParameterFromForm]
    public RecoveryModel? Model { get; set; }

    private int CurrentStep { get; set; } = 1;
    private string ErrorMessage { get; set; } = "";
    private string InfoMessage { get; set; } = "";
    private string SecretQuestion { get; set; } = "";

    protected override void OnInitialized()
    {
        Model ??= new();
    }

    private async Task SubmitUsername()
    {
        ErrorMessage = "";
        InfoMessage = "";

        if (string.IsNullOrWhiteSpace(Model!.Username))
        {
            ErrorMessage = "Please enter your username.";
            return;
        }

        try
        {
            var cmd = await portal.CreateAsync();
            cmd.Username = Model.Username;
            cmd = await portal.ExecuteAsync(cmd);

            if (cmd.IsLockedOut)
            {
                ErrorMessage = cmd.ErrorMessage;
                return;
            }

            // Store the question and advance
            SecretQuestion = cmd.SecretQuestion;

            // Show generic message regardless of whether user exists (prevent enumeration)
            InfoMessage = "If that username exists, the secret question will be shown.";

            if (!string.IsNullOrEmpty(SecretQuestion))
            {
                CurrentStep = 2;
                InfoMessage = ""; // Clear message when advancing
            }
        }
        catch (DataPortalException ex)
        {
            ErrorMessage = ex.BusinessExceptionMessage ?? "An error occurred. Please try again.";
        }
    }

    private async Task SubmitAnswer()
    {
        ErrorMessage = "";
        InfoMessage = "";

        if (string.IsNullOrWhiteSpace(Model!.SecretAnswer))
        {
            ErrorMessage = "Please enter your answer.";
            return;
        }

        try
        {
            var cmd = await portal.CreateAsync();
            cmd.Username = Model.Username;
            cmd.SecretAnswer = Model.SecretAnswer;
            cmd = await portal.ExecuteAsync(cmd);

            if (cmd.IsLockedOut)
            {
                ErrorMessage = cmd.ErrorMessage;
                return;
            }

            if (!cmd.IsAnswerValid)
            {
                ErrorMessage = cmd.ErrorMessage;
                return;
            }

            // Answer correct - advance to step 3
            CurrentStep = 3;
        }
        catch (DataPortalException ex)
        {
            ErrorMessage = ex.BusinessExceptionMessage ?? "An error occurred. Please try again.";
        }
    }

    private async Task SubmitNewPassword()
    {
        ErrorMessage = "";
        InfoMessage = "";

        // Client-side validation
        if (string.IsNullOrWhiteSpace(Model!.NewPassword))
        {
            ErrorMessage = "Please enter a new password.";
            return;
        }

        if (Model.NewPassword.Length < 6)
        {
            ErrorMessage = "Password must be at least 6 characters.";
            return;
        }

        if (Model.NewPassword != Model.ConfirmPassword)
        {
            ErrorMessage = "Passwords do not match.";
            return;
        }

        try
        {
            var cmd = await portal.CreateAsync();
            cmd.Username = Model.Username;
            cmd.NewPassword = Model.NewPassword;
            cmd = await portal.ExecuteAsync(cmd);

            if (!cmd.PasswordResetSuccess)
            {
                ErrorMessage = cmd.ErrorMessage;
                return;
            }

            // Success - redirect to login
            NavigationManager.NavigateTo("/login?passwordreset=true");
        }
        catch (DataPortalException ex)
        {
            ErrorMessage = ex.BusinessExceptionMessage ?? "An error occurred. Please try again.";
        }
    }

    private void GoBackToStep1()
    {
        CurrentStep = 1;
        ErrorMessage = "";
        InfoMessage = "";
        SecretQuestion = "";
        Model!.SecretAnswer = "";
    }

    private void GoBackToStep2()
    {
        CurrentStep = 2;
        ErrorMessage = "";
        Model!.NewPassword = "";
        Model.ConfirmPassword = "";
    }

    public class RecoveryModel
    {
        public string Username { get; set; } = string.Empty;
        public string SecretAnswer { get; set; } = string.Empty;
        public string NewPassword { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
```

Key features:
- Step indicator showing "Step N of 3"
- Back navigation between steps (resets relevant state)
- Generic message for unknown username (InfoMessage approach)
- Real-time password validation before submit
- Confirm password field with matching validation
- Lockout error display
- Remaining attempts shown in error message (from business object)
- Success redirects with query param for login page message
  </action>
  <verify>
1. Build succeeds: `dotnet build Threa/Threa/Threa.csproj`
2. Page compiles without errors
  </verify>
  <done>ForgotPassword.razor wizard page exists with all 3 steps, back navigation, and proper error handling.</done>
</task>

<task type="auto">
  <name>Task 2: Add Forgot Password Link and Success Message to Login Page</name>
  <files>Threa/Threa/Components/Pages/Login.razor</files>
  <action>
Update Login.razor to add:
1. Link to forgot password page
2. Success message when arriving from password reset

**Add query parameter property** (near existing `Registered` property):
```csharp
[SupplyParameterFromQuery]
public bool PasswordReset { get; set; }
```

**Add success message** (after the existing Registered message):
```razor
@if (PasswordReset)
{
    <div class="alert alert-success">Password reset successful! Please log in with your new password.</div>
}
```

**Add forgot password link** (update the button area):
The current login form has:
```razor
<button class="btn btn-primary">Login</button>
<a href="/register" class="btn btn-link">Don't have an account? Register</a>
```

Change to:
```razor
<button class="btn btn-primary">Login</button>
<div class="mt-2">
    <a href="/register" class="btn btn-link">Don't have an account? Register</a>
    <span class="text-muted">|</span>
    <a href="/forgot-password" class="btn btn-link">Forgot password?</a>
</div>
```

This keeps the existing register link and adds the forgot password link.
  </action>
  <verify>
1. Build succeeds: `dotnet build Threa/Threa/Threa.csproj`
2. Login page has forgot password link
  </verify>
  <done>Login.razor has forgot password link and displays success message from password reset.</done>
</task>

</tasks>

<verification>
1. `dotnet build Threa.sln` - All projects compile
2. Login page has "Forgot password?" link pointing to /forgot-password
3. ForgotPassword page loads at /forgot-password
4. Step 1 accepts username, shows "If that username exists" message
5. Step 2 shows secret question and accepts answer
6. Step 3 accepts password with confirmation
7. Back buttons work between steps
8. Success redirects to login with success message
</verification>

<success_criteria>
- ForgotPassword.razor exists at /forgot-password route
- Login.razor has "Forgot password?" link
- Login.razor shows success message when ?passwordreset=true
- 3-step wizard:
  - Step 1: Username entry with "If that username exists" message
  - Step 2: Secret question display with answer input
  - Step 3: New password with confirm password field
- Back navigation works between all steps
- Error messages display inline (lockout, remaining attempts, validation)
- Password validation matches registration rules (min 6 chars)
- Successful reset redirects to /login?passwordreset=true
</success_criteria>

<output>
After completion, create `.planning/phases/09-password-recovery/09-02-SUMMARY.md`
</output>
