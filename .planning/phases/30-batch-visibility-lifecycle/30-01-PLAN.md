---
phase: 30-batch-visibility-lifecycle
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - GameMechanics/Batch/BatchActionRequest.cs
  - GameMechanics/Batch/BatchActionResult.cs
  - GameMechanics/Batch/BatchActionService.cs
  - GameMechanics/ServiceCollectionExtensions.cs
autonomous: true

must_haves:
  truths:
    - "BatchActionService can toggle visibility on a list of NPC character IDs"
    - "BatchActionService can archive and detach a list of NPC character IDs"
    - "BatchActionResult.Summary produces contextual text for visibility and dismiss operations"
    - "Non-NPC characters are silently skipped in both operations"
  artifacts:
    - path: "GameMechanics/Batch/BatchActionRequest.cs"
      provides: "VisibilityTarget property and Visibility/Dismiss enum values"
      contains: "VisibilityTarget"
    - path: "GameMechanics/Batch/BatchActionResult.cs"
      provides: "Action-type-aware Summary for visibility and dismiss"
      contains: "Visibility"
    - path: "GameMechanics/Batch/BatchActionService.cs"
      provides: "ToggleVisibilityAsync and DismissAsync methods"
      contains: "ToggleVisibilityAsync"
  key_links:
    - from: "GameMechanics/Batch/BatchActionService.cs"
      to: "Threa.Dal/ITableDal.cs"
      via: "constructor injection for RemoveCharacterFromTableAsync"
      pattern: "ITableDal"
    - from: "GameMechanics/Batch/BatchActionService.cs"
      to: "CharacterEdit.VisibleToPlayers"
      via: "property set in ToggleVisibilityAsync"
      pattern: "VisibleToPlayers"
    - from: "GameMechanics/Batch/BatchActionService.cs"
      to: "CharacterEdit.IsArchived"
      via: "property set + RemoveCharacterFromTableAsync in DismissAsync"
      pattern: "IsArchived"
---

<objective>
Extend BatchActionService with ToggleVisibilityAsync and DismissAsync methods, and generalize the batch action DTOs to support non-damage/healing operations.

Purpose: The service layer must support visibility toggle and dismiss/archive as batch operations before the UI can wire up buttons for them.
Output: BatchActionService with two new public methods, updated DTOs with new enum values and generalized Summary, ITableDal injected for dismiss table detach.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-batch-visibility-lifecycle/30-CONTEXT.md
@.planning/phases/30-batch-visibility-lifecycle/30-RESEARCH.md

Key source files:
@GameMechanics/Batch/BatchActionService.cs
@GameMechanics/Batch/BatchActionRequest.cs
@GameMechanics/Batch/BatchActionResult.cs
@GameMechanics/ServiceCollectionExtensions.cs
@Threa.Dal/ITableDal.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend batch action DTOs for visibility and dismiss</name>
  <files>
    GameMechanics/Batch/BatchActionRequest.cs
    GameMechanics/Batch/BatchActionResult.cs
  </files>
  <action>
1. In `BatchActionRequest.cs`, add two new enum values to `BatchActionType`:
```csharp
/// <summary>Toggle NPC visibility (reveal or hide).</summary>
Visibility,

/// <summary>Dismiss/archive NPCs and remove from table.</summary>
Dismiss
```

2. In `BatchActionRequest.cs`, add a nullable bool property for visibility target:
```csharp
/// <summary>
/// For Visibility actions: true = reveal, false = hide.
/// Determined by SelectionBar before calling service (reveal when any hidden, hide when all visible).
/// Null for non-visibility actions.
/// </summary>
public bool? VisibilityTarget { get; set; }
```
The existing Pool and Amount properties remain unchanged (only used by Damage/Healing).

3. In `BatchActionResult.cs`, replace the hardcoded Summary property with an action-type-aware version:
```csharp
public string Summary => ActionType switch
{
    BatchActionType.Visibility => HasFailures
        ? $"{SuccessIds.Count} of {TotalCount} NPC(s) {(VisibilityAction ? "revealed" : "hidden")}"
        : $"{SuccessIds.Count} NPC(s) {(VisibilityAction ? "revealed" : "hidden")}",
    BatchActionType.Dismiss => HasFailures
        ? $"Dismissed {SuccessIds.Count} of {TotalCount} NPC(s)"
        : $"Dismissed {SuccessIds.Count} NPC(s)",
    _ => HasFailures
        ? $"Applied {Amount} {Pool} {ActionType.ToString().ToLower()} to {SuccessIds.Count} of {TotalCount} characters"
        : $"Applied {Amount} {Pool} {ActionType.ToString().ToLower()} to {SuccessIds.Count} character(s)"
};
```

4. Add a `VisibilityAction` bool property to `BatchActionResult` to track reveal vs hide for the summary:
```csharp
/// <summary>
/// For visibility operations: true = revealed, false = hidden.
/// </summary>
public bool VisibilityAction { get; set; }
```
  </action>
  <verify>`dotnet build GameMechanics/GameMechanics.csproj` passes with 0 errors. Confirm BatchActionType has 4 values (Damage, Healing, Visibility, Dismiss). Confirm Summary produces "NPC(s) revealed" format for Visibility type and "Dismissed N NPC(s)" for Dismiss type.</verify>
  <done>BatchActionType enum has Visibility and Dismiss values. BatchActionRequest has VisibilityTarget property. BatchActionResult.Summary produces contextual text per action type.</done>
</task>

<task type="auto">
  <name>Task 2: Add ToggleVisibilityAsync and DismissAsync to BatchActionService</name>
  <files>
    GameMechanics/Batch/BatchActionService.cs
    GameMechanics/ServiceCollectionExtensions.cs
  </files>
  <action>
1. Add `ITableDal` as a constructor dependency to `BatchActionService`. Add `using Threa.Dal;` import. Update the constructor:
```csharp
private readonly IDataPortal<CharacterEdit> _characterPortal;
private readonly ITimeEventPublisher _timeEventPublisher;
private readonly ITableDal _tableDal;

public BatchActionService(
    IDataPortal<CharacterEdit> characterPortal,
    ITimeEventPublisher timeEventPublisher,
    ITableDal tableDal)
{
    _characterPortal = characterPortal;
    _timeEventPublisher = timeEventPublisher;
    _tableDal = tableDal;
}
```
DI already has ITableDal registered, so no ServiceCollectionExtensions change needed for that -- but verify the `AddScoped<BatchActionService>()` registration still resolves correctly with the new constructor parameter.

2. Add `ToggleVisibilityAsync` method following the same sequential pattern as `ProcessBatchAsync`:
```csharp
/// <summary>
/// Toggles visibility on multiple NPCs. Non-NPC characters are silently skipped.
/// </summary>
public async Task<BatchActionResult> ToggleVisibilityAsync(BatchActionRequest request)
{
    var result = new BatchActionResult
    {
        ActionType = BatchActionType.Visibility,
        VisibilityAction = request.VisibilityTarget ?? true
    };

    foreach (var characterId in request.CharacterIds)
    {
        try
        {
            var character = await _characterPortal.FetchAsync(characterId);

            if (!character.IsNpc)
                continue;

            character.VisibleToPlayers = request.VisibilityTarget ?? true;
            await _characterPortal.UpdateAsync(character);
            result.SuccessIds.Add(characterId);
            result.SuccessNames.Add(character.Name);
        }
        catch (Exception ex)
        {
            result.FailedIds.Add(characterId);
            result.Errors.Add($"Character {characterId}: {ex.Message}");
        }
    }

    if (result.SuccessIds.Count > 0)
    {
        await _timeEventPublisher.PublishCharactersUpdatedAsync(
            new CharactersUpdatedMessage
            {
                TableId = request.TableId,
                CharacterIds = result.SuccessIds,
                EventType = TimeEventType.EndOfRound,
                SourceId = "BatchActionService"
            });
    }

    return result;
}
```

3. Add `DismissAsync` method with the two-step archive + table detach pattern:
```csharp
/// <summary>
/// Dismisses (archives) multiple NPCs and removes them from the table.
/// Non-NPC characters are silently skipped.
/// </summary>
public async Task<BatchActionResult> DismissAsync(BatchActionRequest request)
{
    var result = new BatchActionResult
    {
        ActionType = BatchActionType.Dismiss
    };

    foreach (var characterId in request.CharacterIds)
    {
        try
        {
            var character = await _characterPortal.FetchAsync(characterId);

            if (!character.IsNpc)
                continue;

            // Step 1: Archive the character
            character.IsArchived = true;
            await _characterPortal.UpdateAsync(character);

            // Step 2: Remove from table
            await _tableDal.RemoveCharacterFromTableAsync(request.TableId, characterId);

            result.SuccessIds.Add(characterId);
            result.SuccessNames.Add(character.Name);
        }
        catch (Exception ex)
        {
            result.FailedIds.Add(characterId);
            result.Errors.Add($"Character {characterId}: {ex.Message}");
        }
    }

    if (result.SuccessIds.Count > 0)
    {
        await _timeEventPublisher.PublishCharactersUpdatedAsync(
            new CharactersUpdatedMessage
            {
                TableId = request.TableId,
                CharacterIds = result.SuccessIds,
                EventType = TimeEventType.EndOfRound,
                SourceId = "BatchActionService"
            });
    }

    return result;
}
```

4. Update the class-level XML doc comment from "Service for applying batch actions (damage/healing)" to "Service for applying batch actions (damage/healing, visibility toggle, dismiss/archive) to multiple characters."

5. Build and verify: `dotnet build Threa.sln` -- the new ITableDal constructor parameter will be resolved by the existing DI registration. No changes to ServiceCollectionExtensions.cs needed since ITableDal is already registered.
  </action>
  <verify>`dotnet build Threa.sln` passes (excluding file-lock errors on running Threa host). `dotnet test GameMechanics.Test/GameMechanics.Test.csproj` passes -- existing tests still work with the new constructor parameter (test DI must also have ITableDal registered). If test DI fails due to missing ITableDal, add a mock or register the MockDb implementation in the test setup.</verify>
  <done>BatchActionService has ToggleVisibilityAsync and DismissAsync methods. ITableDal is injected. Non-NPC characters are silently skipped. Both methods publish single CharactersUpdatedMessage after batch. Existing tests pass.</done>
</task>

</tasks>

<verification>
1. `dotnet build GameMechanics/GameMechanics.csproj` -- 0 errors
2. `dotnet build Threa.sln` -- compiles (excluding file-lock on running host)
3. `dotnet test GameMechanics.Test/GameMechanics.Test.csproj` -- all existing tests pass
4. BatchActionType enum has 4 values: Damage, Healing, Visibility, Dismiss
5. BatchActionResult.Summary produces action-type-aware text
6. BatchActionService.ToggleVisibilityAsync sets VisibleToPlayers on NPCs only
7. BatchActionService.DismissAsync sets IsArchived + calls RemoveCharacterFromTableAsync on NPCs only
</verification>

<success_criteria>
- ToggleVisibilityAsync sets VisibleToPlayers to the request's VisibilityTarget for all NPC character IDs, skipping PCs
- DismissAsync sets IsArchived=true and calls RemoveCharacterFromTableAsync for all NPC character IDs, skipping PCs
- Both methods publish a single CharactersUpdatedMessage after the batch completes
- BatchActionResult.Summary returns contextual text: "N NPC(s) revealed/hidden" or "Dismissed N NPC(s)"
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/30-batch-visibility-lifecycle/30-01-SUMMARY.md`
</output>
