---
phase: 30-batch-visibility-lifecycle
plan: 02
type: execute
wave: 2
depends_on: ["30-01"]
files_modified:
  - Threa/Threa.Client/Components/Shared/SelectionBar.razor
  - Threa/Threa.Client/Components/Shared/BatchDismissConfirmModal.razor
  - Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
autonomous: true

must_haves:
  truths:
    - "GM can click Toggle Visibility button to reveal or hide all selected NPCs"
    - "GM can click Dismiss button, confirm, and archive all selected NPCs"
    - "Visibility/Dismiss buttons are hidden when no NPCs are selected (all PCs)"
    - "Toggle Visibility button label says Reveal when any selected NPC is hidden, Hide when all are visible"
    - "Dismiss shows confirmation modal before executing"
    - "Visibility toggle does NOT show confirmation"
    - "After visibility toggle, selection remains intact"
    - "After dismiss, only dismissed NPCs are removed from selection"
    - "Result feedback shows after both operations"
  artifacts:
    - path: "Threa/Threa.Client/Components/Shared/SelectionBar.razor"
      provides: "Toggle Visibility and Dismiss buttons with NPC filtering"
      contains: "ToggleVisibility"
    - path: "Threa/Threa.Client/Components/Shared/BatchDismissConfirmModal.razor"
      provides: "Simple confirmation modal for batch dismiss"
      contains: "NpcCount"
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor"
      provides: "AllCharacters parameter passed to SelectionBar, action-type-aware selection cleanup"
      contains: "AllCharacters"
  key_links:
    - from: "Threa/Threa.Client/Components/Shared/SelectionBar.razor"
      to: "GameMechanics/Batch/BatchActionService.cs"
      via: "ToggleVisibilityAsync and DismissAsync calls"
      pattern: "BatchActionService\\.(ToggleVisibility|Dismiss)Async"
    - from: "Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor"
      to: "Threa/Threa.Client/Components/Shared/SelectionBar.razor"
      via: "AllCharacters parameter binding"
      pattern: "AllCharacters="
    - from: "Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor"
      to: "HandleBatchActionCompleted"
      via: "Action-type-aware selection cleanup"
      pattern: "ActionType.*Visibility|ActionType.*Dismiss"
---

<objective>
Add Toggle Visibility and Dismiss buttons to SelectionBar with NPC filtering, dismiss confirmation modal, and action-type-aware selection cleanup in GmTable.

Purpose: The GM needs UI controls to batch-toggle NPC visibility and batch-dismiss NPCs from the selection bar, with appropriate confirmation for destructive actions and contextual button labels.
Output: SelectionBar with visibility/dismiss buttons, BatchDismissConfirmModal component, GmTable wired with AllCharacters parameter and updated selection cleanup logic.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-batch-visibility-lifecycle/30-CONTEXT.md
@.planning/phases/30-batch-visibility-lifecycle/30-RESEARCH.md
@.planning/phases/30-batch-visibility-lifecycle/30-01-SUMMARY.md

Key source files:
@Threa/Threa.Client/Components/Shared/SelectionBar.razor
@Threa/Threa.Client/Components/Shared/BatchDamageHealingModal.razor
@Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
@GameMechanics/GamePlay/TableCharacterInfo.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BatchDismissConfirmModal and update SelectionBar</name>
  <files>
    Threa/Threa.Client/Components/Shared/BatchDismissConfirmModal.razor
    Threa/Threa.Client/Components/Shared/SelectionBar.razor
  </files>
  <action>
**Part A: Create BatchDismissConfirmModal.razor**

Create a simple confirmation modal following the same pattern as BatchDamageHealingModal. Location: `Threa/Threa.Client/Components/Shared/BatchDismissConfirmModal.razor`

```razor
@* Confirmation modal for batch dismiss/archive of NPCs *@

@using Radzen

@inject DialogService DialogService

<div class="p-3">
    <p class="mb-3">
        Dismiss <strong>@NpcCount</strong> NPC@(NpcCount != 1 ? "s" : "")? They will be archived and removed from the table.
    </p>

    <div class="d-flex justify-content-end gap-2">
        <button type="button" class="btn btn-secondary" @onclick="Cancel">
            Cancel
        </button>
        <button type="button" class="btn btn-danger" @onclick="Confirm">
            <i class="bi bi-archive me-1"></i>Dismiss
        </button>
    </div>
</div>

@code {
    [Parameter] public int NpcCount { get; set; }

    private void Cancel() => DialogService.Close(null);
    private void Confirm() => DialogService.Close(true);
}
```

**Part B: Update SelectionBar.razor**

1. Add a new parameter for character metadata needed for NPC filtering:
```csharp
[Parameter]
public IEnumerable<GameMechanics.GamePlay.TableCharacterInfo>? AllCharacters { get; set; }
```

2. Add `@using GameMechanics.GamePlay` to the top of the file (near the existing @using lines).

3. Add NPC filtering computed properties in the @code block:
```csharp
private int SelectedNpcCount => AllCharacters?
    .Where(c => c.IsNpc && SelectedCharacterIds.Contains(c.CharacterId))
    .Count() ?? 0;

private bool HasSelectedNpcs => SelectedNpcCount > 0;

private List<int> GetSelectedNpcIds() => AllCharacters?
    .Where(c => c.IsNpc && SelectedCharacterIds.Contains(c.CharacterId))
    .Select(c => c.CharacterId)
    .ToList() ?? new();

private string VisibilityButtonLabel
{
    get
    {
        var selectedNpcs = AllCharacters?
            .Where(c => c.IsNpc && SelectedCharacterIds.Contains(c.CharacterId));
        if (selectedNpcs == null || !selectedNpcs.Any()) return "Reveal";

        bool anyHidden = selectedNpcs.Any(c => !c.VisibleToPlayers);
        return anyHidden ? "Reveal" : "Hide";
    }
}

private bool VisibilityTarget
{
    get
    {
        var selectedNpcs = AllCharacters?
            .Where(c => c.IsNpc && SelectedCharacterIds.Contains(c.CharacterId));
        if (selectedNpcs == null || !selectedNpcs.Any()) return true;
        return selectedNpcs.Any(c => !c.VisibleToPlayers);
    }
}
```

4. Restructure the button layout in the div with class "d-flex gap-2 align-items-center". The new layout follows CONTEXT decisions: Clear Selection at far left, then action buttons (Damage, Heal, Toggle Visibility), then Dismiss isolated at far right. Use `justify-content-between` on a wrapper to push Dismiss to the right, and group the other buttons with `gap-2`.

Replace the entire button area `<div class="d-flex gap-2 align-items-center">` with:
```razor
<div class="d-flex gap-2 align-items-center">
    <button class="btn btn-sm btn-outline-secondary" @onclick="HandleDeselectAll">
        <i class="bi bi-x-lg me-1"></i>Clear
    </button>

    <span class="text-muted">|</span>

    <button class="btn btn-sm btn-danger" @onclick="OpenDamageModal">
        <i class="bi bi-heart-pulse me-1"></i>Damage
    </button>
    <button class="btn btn-sm btn-success" @onclick="OpenHealingModal">
        <i class="bi bi-bandaid me-1"></i>Heal
    </button>

    @if (HasSelectedNpcs)
    {
        <button class="btn btn-sm btn-outline-info" @onclick="ExecuteToggleVisibility">
            <i class="bi @(VisibilityTarget ? "bi-eye" : "bi-eye-slash") me-1"></i>@VisibilityButtonLabel
        </button>
    }

    @if (HasSelectedNpcs)
    {
        <span class="text-muted">|</span>
        <button class="btn btn-sm btn-outline-danger" @onclick="OpenDismissConfirmation">
            <i class="bi bi-archive me-1"></i>Dismiss
        </button>
    }
</div>
```

5. Add the visibility toggle execution method (no confirmation needed -- CONTEXT says it is non-destructive):
```csharp
private async Task ExecuteToggleVisibility()
{
    var npcIds = GetSelectedNpcIds();
    if (npcIds.Count == 0) return;

    var request = new BatchActionRequest
    {
        TableId = TableId,
        CharacterIds = npcIds,
        ActionType = BatchActionType.Visibility,
        VisibilityTarget = VisibilityTarget
    };

    var result = await BatchActionService.ToggleVisibilityAsync(request);
    await HandleBatchResult(result);
}
```

6. Add the dismiss confirmation and execution methods:
```csharp
private async Task OpenDismissConfirmation()
{
    var npcCount = SelectedNpcCount;
    if (npcCount == 0) return;

    var dialogResult = await DialogService.OpenAsync<BatchDismissConfirmModal>(
        "Dismiss NPCs",
        new Dictionary<string, object>
        {
            { "NpcCount", npcCount }
        },
        new DialogOptions { Width = "350px", CloseDialogOnOverlayClick = true });

    if (dialogResult is bool confirmed && confirmed)
    {
        await ExecuteDismiss();
    }
}

private async Task ExecuteDismiss()
{
    var npcIds = GetSelectedNpcIds();
    if (npcIds.Count == 0) return;

    var request = new BatchActionRequest
    {
        TableId = TableId,
        CharacterIds = npcIds,
        ActionType = BatchActionType.Dismiss
    };

    var result = await BatchActionService.DismissAsync(request);
    await HandleBatchResult(result);
}
```

Important: The visibility and dismiss methods pass only NPC IDs to the service (pre-filtered by GetSelectedNpcIds), not the full SelectedCharacterIds set. This means PCs are never even sent to the service -- they are filtered at the UI layer.
  </action>
  <verify>`dotnet build Threa/Threa.Client/Threa.Client.csproj` passes with 0 errors. Confirm BatchDismissConfirmModal.razor exists and compiles. Confirm SelectionBar has AllCharacters parameter, visibility/dismiss buttons, and NPC filtering logic.</verify>
  <done>SelectionBar has Toggle Visibility button (contextual Reveal/Hide label) and Dismiss button (with confirmation modal). Both buttons only render when NPCs are selected. Clear button moved to far left, Dismiss isolated at far right. NPC IDs pre-filtered before service calls.</done>
</task>

<task type="auto">
  <name>Task 2: Wire GmTable with AllCharacters parameter and action-type-aware selection cleanup</name>
  <files>
    Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
  </files>
  <action>
1. Update the SelectionBar usage in GmTable.razor (around line 75) to pass the AllCharacters parameter:
```razor
<SelectionBar SelectedCount="@selectedCharacterIds.Count"
              OnDeselectAll="DeselectAll"
              TableId="@TableId"
              SelectedCharacterIds="@selectedCharacterIds"
              AllCharacters="@tableCharacters"
              OnBatchActionCompleted="HandleBatchActionCompleted" />
```
The `tableCharacters` field (line 600) is already `IEnumerable<TableCharacterInfo>?` which matches the new parameter type.

2. Modify `HandleBatchActionCompleted` (around line 1494) to implement action-type-aware selection cleanup per CONTEXT decisions:
- **Visibility**: do NOT clear any selection (GM may want to chain additional actions)
- **Dismiss**: remove only dismissed NPC IDs from selection (remaining selected characters stay selected)
- **Damage/Healing**: keep existing behavior (clear all on full success, remove succeeded on partial)

Replace the current HandleBatchActionCompleted method with:
```csharp
// Batch action result handler - manages selection cleanup after batch operations
private async Task HandleBatchActionCompleted(BatchActionResult result)
{
    switch (result.ActionType)
    {
        case BatchActionType.Visibility:
            // Visibility: keep selection intact (GM may chain actions)
            break;

        case BatchActionType.Dismiss:
            // Dismiss: remove only dismissed NPC IDs from selection
            foreach (var successId in result.SuccessIds)
            {
                selectedCharacterIds.Remove(successId);
            }
            break;

        default:
            // Damage/Healing: clear all on full success, remove succeeded on partial
            if (result.AllSucceeded)
            {
                selectedCharacterIds.Clear();
            }
            else if (result.HasFailures && result.SuccessIds.Count > 0)
            {
                foreach (var successId in result.SuccessIds)
                {
                    selectedCharacterIds.Remove(successId);
                }
            }
            break;
    }

    // Refresh character list to show updated state (health, visibility, or removed NPCs)
    await RefreshCharacterListAsync();
    StateHasChanged();
}
```

3. Ensure `@using GameMechanics.Batch` is already present in GmTable.razor imports (it was added in Phase 29-03). If not, add it.
  </action>
  <verify>`dotnet build Threa.sln` passes (excluding file-lock errors on running host). `dotnet test GameMechanics.Test/GameMechanics.Test.csproj` -- all existing tests pass. Verify the SelectionBar tag now includes `AllCharacters="@tableCharacters"`. Verify HandleBatchActionCompleted has switch on result.ActionType with Visibility and Dismiss cases.</verify>
  <done>GmTable passes tableCharacters to SelectionBar via AllCharacters parameter. HandleBatchActionCompleted uses action-type-aware cleanup: visibility keeps selection, dismiss removes only dismissed IDs, damage/healing uses existing logic. Character list refreshes after all batch operations.</done>
</task>

</tasks>

<verification>
1. `dotnet build Threa.sln` -- compiles (excluding file-lock on running host)
2. `dotnet test GameMechanics.Test/GameMechanics.Test.csproj` -- all tests pass
3. SelectionBar renders Toggle Visibility button only when NPCs are selected
4. Toggle Visibility button label says "Reveal" when any selected NPC is hidden, "Hide" when all visible
5. Dismiss button renders only when NPCs are selected, isolated at far right
6. Dismiss opens confirmation modal before executing
7. Clear button is at far left of the action bar
8. GmTable passes AllCharacters to SelectionBar
9. HandleBatchActionCompleted applies correct selection cleanup per action type
</verification>

<success_criteria>
- Toggle Visibility button appears when NPCs are selected, hidden when only PCs selected
- Button label is contextual: "Reveal" when any selected NPC is hidden, "Hide" when all are visible
- Clicking Toggle Visibility calls BatchActionService.ToggleVisibilityAsync with pre-filtered NPC IDs
- Dismiss button appears at far right, separated from other actions
- Clicking Dismiss opens BatchDismissConfirmModal showing NPC count
- Confirming dismiss calls BatchActionService.DismissAsync with pre-filtered NPC IDs
- After visibility toggle: selection stays intact
- After dismiss: only dismissed NPC IDs removed from selection
- Both operations show result feedback via existing HandleBatchResult pattern
- Button layout follows CONTEXT: Clear | Damage | Heal | Toggle Vis | ... | Dismiss
</success_criteria>

<output>
After completion, create `.planning/phases/30-batch-visibility-lifecycle/30-02-SUMMARY.md`
</output>
