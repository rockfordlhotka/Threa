---
phase: 26-visibility-lifecycle
plan: 05
type: execute
wave: 3
depends_on: ["26-01"]
files_modified:
  - GameMechanics/NpcTemplateCreator.cs
  - Threa/Threa.Client/Components/Shared/SaveAsTemplateModal.razor
  - Threa/Threa.Client/Components/Shared/CharacterDetailAdmin.razor
autonomous: true

must_haves:
  truths:
    - "GM can save an active NPC as a new template"
    - "Template captures full current state (attributes, skills, equipment)"
    - "Template has reset health (full) and cleared effects"
    - "Modal prompts for template name, category, and tags"
  artifacts:
    - path: "GameMechanics/NpcTemplateCreator.cs"
      provides: "CSLA command to create template from NPC"
      min_lines: 60
      contains: "IsTemplate = true"
    - path: "Threa/Threa.Client/Components/Shared/SaveAsTemplateModal.razor"
      provides: "Modal for template name/category/tags input"
      min_lines: 50
  key_links:
    - from: "CharacterDetailAdmin.razor"
      to: "SaveAsTemplateModal.razor"
      via: "Opens modal on button click"
      pattern: "<SaveAsTemplateModal"
    - from: "SaveAsTemplateModal.razor"
      to: "NpcTemplateCreator"
      via: "Executes command on save"
      pattern: "NpcTemplateCreator"
---

<objective>
Implement "Save as Template" functionality for active NPCs.

Purpose: Per CONTEXT.md, GMs can save an active NPC (with current wounds, effects, inventory) as a new template. This captures battle-tested NPCs for reuse. Template name is pre-filled with NPC name, modal prompts for category and tags.

Output: NpcTemplateCreator command and SaveAsTemplateModal component integrated into CharacterDetailAdmin.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/26-visibility-lifecycle/26-CONTEXT.md
@.planning/phases/26-visibility-lifecycle/26-RESEARCH.md
@.planning/phases/26-visibility-lifecycle/26-01-SUMMARY.md

@GameMechanics/NpcSpawner.cs
@Threa/Threa.Client/Components/Shared/CharacterDetailAdmin.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NpcTemplateCreator Command</name>
  <files>GameMechanics/NpcTemplateCreator.cs</files>
  <action>
Create NpcTemplateCreator.cs in GameMechanics/ folder:

```csharp
using Csla;
using System;
using System.Linq;
using System.Threading.Tasks;
using Threa.Dal;
using Threa.Dal.Dto;

namespace GameMechanics;

/// <summary>
/// CSLA command that creates a new NPC template from an active NPC instance.
/// Copies the NPC's current state (attributes, skills, equipment) but resets
/// health pools and clears temporary effects.
/// </summary>
[Serializable]
public class NpcTemplateCreator : CommandBase<NpcTemplateCreator>
{
    #region Input Parameters

    public static readonly PropertyInfo<int> SourceCharacterIdProperty = RegisterProperty<int>(nameof(SourceCharacterId));
    /// <summary>
    /// The ID of the NPC character to create a template from.
    /// </summary>
    public int SourceCharacterId
    {
        get => ReadProperty(SourceCharacterIdProperty);
        set => LoadProperty(SourceCharacterIdProperty, value);
    }

    public static readonly PropertyInfo<string> TemplateNameProperty = RegisterProperty<string>(nameof(TemplateName));
    /// <summary>
    /// The name for the new template.
    /// </summary>
    public string TemplateName
    {
        get => ReadProperty(TemplateNameProperty);
        set => LoadProperty(TemplateNameProperty, value);
    }

    public static readonly PropertyInfo<string?> CategoryProperty = RegisterProperty<string?>(nameof(Category));
    /// <summary>
    /// Optional category for template organization.
    /// </summary>
    public string? Category
    {
        get => ReadProperty(CategoryProperty);
        set => LoadProperty(CategoryProperty, value);
    }

    public static readonly PropertyInfo<string?> TagsProperty = RegisterProperty<string?>(nameof(Tags));
    /// <summary>
    /// Optional comma-separated tags for template filtering.
    /// </summary>
    public string? Tags
    {
        get => ReadProperty(TagsProperty);
        set => LoadProperty(TagsProperty, value);
    }

    #endregion

    #region Output

    public static readonly PropertyInfo<int> CreatedTemplateIdProperty = RegisterProperty<int>(nameof(CreatedTemplateId));
    /// <summary>
    /// The ID of the newly created template.
    /// </summary>
    public int CreatedTemplateId
    {
        get => ReadProperty(CreatedTemplateIdProperty);
        private set => LoadProperty(CreatedTemplateIdProperty, value);
    }

    public static readonly PropertyInfo<bool> SuccessProperty = RegisterProperty<bool>(nameof(Success));
    /// <summary>
    /// Whether the operation completed successfully.
    /// </summary>
    public bool Success
    {
        get => ReadProperty(SuccessProperty);
        private set => LoadProperty(SuccessProperty, value);
    }

    public static readonly PropertyInfo<string?> ErrorMessageProperty = RegisterProperty<string?>(nameof(ErrorMessage));
    /// <summary>
    /// Error message if the operation failed.
    /// </summary>
    public string? ErrorMessage
    {
        get => ReadProperty(ErrorMessageProperty);
        private set => LoadProperty(ErrorMessageProperty, value);
    }

    #endregion

    [Execute]
    private async Task ExecuteAsync([Inject] ICharacterDal characterDal)
    {
        try
        {
            // 1. Fetch source NPC
            var source = await characterDal.GetCharacterAsync(SourceCharacterId);
            if (source == null)
            {
                Success = false;
                ErrorMessage = $"Character {SourceCharacterId} not found";
                return;
            }

            // 2. Create new character DTO as template
            var template = new Character
            {
                Id = 0, // Will be assigned on save
                PlayerId = source.PlayerId,

                // Identity - use new name
                Name = TemplateName,
                TrueName = source.TrueName,
                Aliases = source.Aliases,
                Species = source.Species,
                Description = source.Description,
                ImageUrl = source.ImageUrl,

                // Physical description
                Height = source.Height,
                Weight = source.Weight,
                SkinDescription = source.SkinDescription,
                HairDescription = source.HairDescription,
                Birthdate = source.Birthdate,

                // Combat stats
                DamageClass = source.DamageClass,

                // Health pools - RESET to full (templates represent fresh state)
                FatBaseValue = source.FatBaseValue,
                FatValue = source.FatBaseValue, // Full health
                FatPendingDamage = 0,
                FatPendingHealing = 0,
                VitBaseValue = source.VitBaseValue,
                VitValue = source.VitBaseValue, // Full health
                VitPendingDamage = 0,
                VitPendingHealing = 0,

                // Action points - full
                ActionPointMax = source.ActionPointMax,
                ActionPointRecovery = source.ActionPointRecovery,
                ActionPointAvailable = source.ActionPointMax,

                // XP
                XPTotal = source.XPTotal,
                XPBanked = source.XPBanked,

                // Currency
                CopperCoins = source.CopperCoins,
                SilverCoins = source.SilverCoins,
                GoldCoins = source.GoldCoins,
                PlatinumCoins = source.PlatinumCoins,

                // NPC/Template flags
                IsNpc = true,
                IsTemplate = true,
                IsPlayable = false, // Templates are not directly playable
                VisibleToPlayers = true, // Templates visible in library
                IsArchived = false,

                // Template organization
                Category = Category,
                Tags = Tags,
                TemplateNotes = source.Notes, // Preserve notes as template notes
                DefaultDisposition = source.DefaultDisposition,
                DifficultyRating = source.DifficultyRating,

                // Source tracking - templates don't have source
                SourceTemplateId = null,
                SourceTemplateName = null,

                // Notes
                Notes = string.Empty,

                // Game time
                CurrentGameTimeSeconds = 0
            };

            // 3. Copy attributes
            template.AttributeList = source.AttributeList
                .Select(a => new CharacterAttribute
                {
                    Name = a.Name,
                    Value = a.Value
                })
                .ToList();

            // 4. Copy skills
            template.Skills = source.Skills
                .Select(s => new CharacterSkill
                {
                    Id = s.Id,
                    Name = s.Name,
                    Category = s.Category,
                    Description = s.Description,
                    IsSpecialized = s.IsSpecialized,
                    IsMagic = s.IsMagic,
                    IsTheology = s.IsTheology,
                    IsPsionic = s.IsPsionic,
                    Untrained = s.Untrained,
                    Trained = s.Trained,
                    PrimaryAttribute = s.PrimaryAttribute,
                    SecondaryAttribute = s.SecondaryAttribute,
                    TertiaryAttribute = s.TertiaryAttribute,
                    ImageUrl = s.ImageUrl,
                    ActionType = s.ActionType,
                    TargetValueType = s.TargetValueType,
                    DefaultTV = s.DefaultTV,
                    OpposedSkillId = s.OpposedSkillId,
                    CooldownType = s.CooldownType,
                    CooldownSeconds = s.CooldownSeconds,
                    ResultTable = s.ResultTable,
                    AppliesPhysicalityBonus = s.AppliesPhysicalityBonus,
                    RequiresTarget = s.RequiresTarget,
                    RequiresLineOfSight = s.RequiresLineOfSight,
                    ManaRequirements = s.ManaRequirements,
                    CanPumpWithFatigue = s.CanPumpWithFatigue,
                    CanPumpWithMana = s.CanPumpWithMana,
                    PumpDescription = s.PumpDescription,
                    IsFreeAction = s.IsFreeAction,
                    IsPassive = s.IsPassive,
                    ActionDescription = s.ActionDescription,
                    Level = s.Level,
                    XPBanked = s.XPBanked,
                    XPSpent = s.XPSpent
                })
                .ToList();

            // 5. Copy items (equipment persists to template)
            template.Items = source.Items
                .Select(i => new CharacterItem
                {
                    ItemId = i.ItemId,
                    Name = i.Name,
                    Description = i.Description,
                    Category = i.Category,
                    Weight = i.Weight,
                    Value = i.Value,
                    Quantity = i.Quantity,
                    IsEquipped = i.IsEquipped,
                    EquipSlot = i.EquipSlot,
                    ImageUrl = i.ImageUrl,
                    Properties = i.Properties
                })
                .ToList();

            // 6. DO NOT copy effects - templates start clean
            // (Wounds, buffs, debuffs are combat state, not template state)
            template.Effects = new List<CharacterEffect>();

            // 7. Save template
            var saved = await characterDal.SaveCharacterAsync(template);

            CreatedTemplateId = saved.Id;
            Success = true;
        }
        catch (Exception ex)
        {
            Success = false;
            ErrorMessage = ex.Message;
        }
    }
}
```

Key points:
- Copies full character state (attributes, skills, items)
- Resets health pools to full (template = fresh state)
- Clears all effects (wounds, buffs, debuffs are combat state)
- Sets IsTemplate = true, IsNpc = true, IsPlayable = false
- Clears source template tracking (this IS a template now)
  </action>
  <verify>Build: `dotnet build GameMechanics/GameMechanics.csproj` - no errors</verify>
  <done>NpcTemplateCreator command creates template from NPC with reset health and cleared effects</done>
</task>

<task type="auto">
  <name>Task 2: Create SaveAsTemplateModal Component</name>
  <files>Threa/Threa.Client/Components/Shared/SaveAsTemplateModal.razor</files>
  <action>
Create SaveAsTemplateModal.razor in Threa/Threa.Client/Components/Shared/:

```razor
@using GameMechanics
@using Threa.Dal

@inject IDataPortal<NpcTemplateCreator> CreatorPortal
@inject ICharacterDal CharacterDal

<div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-file-earmark-plus me-2"></i>Save as Template
                </h5>
                <button type="button" class="btn-close" @onclick="Cancel"></button>
            </div>
            <div class="modal-body">
                @if (errorMessage != null)
                {
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-1"></i>@errorMessage
                    </div>
                }

                <div class="mb-3">
                    <label class="form-label">Template Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" @bind="templateName" />
                    <small class="text-muted">Name for the new template</small>
                </div>

                <div class="mb-3">
                    <label class="form-label">Category</label>
                    <input type="text" class="form-control" @bind="category"
                           list="categoryList" placeholder="e.g., Humanoids, Beasts, Undead" />
                    <datalist id="categoryList">
                        @foreach (var cat in existingCategories)
                        {
                            <option value="@cat" />
                        }
                    </datalist>
                    <small class="text-muted">Optional folder-like grouping</small>
                </div>

                <div class="mb-3">
                    <label class="form-label">Tags</label>
                    <input type="text" class="form-control" @bind="tags"
                           placeholder="e.g., minion, melee, boss" />
                    <small class="text-muted">Comma-separated tags for filtering</small>
                </div>

                <div class="alert alert-info small">
                    <i class="bi bi-info-circle me-1"></i>
                    <strong>What gets saved:</strong>
                    <ul class="mb-0 mt-1">
                        <li>Attributes, skills, and equipment</li>
                        <li>Health pools reset to full</li>
                        <li>All temporary effects cleared</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancel</button>
                <button type="button" class="btn btn-primary"
                        @onclick="Save"
                        disabled="@(string.IsNullOrWhiteSpace(templateName) || isSaving)">
                    @if (isSaving)
                    {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    <i class="bi bi-file-earmark-plus me-1"></i>Save Template
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public CharacterEdit Character { get; set; } = null!;

    [Parameter]
    public EventCallback<bool> OnClose { get; set; }

    private string templateName = "";
    private string category = "";
    private string tags = "";
    private List<string> existingCategories = new();
    private bool isSaving;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        // Pre-fill with character name
        templateName = Character.Name;
        category = Character.Category ?? "";
        tags = Character.Tags ?? "";

        // Load existing categories for autocomplete
        try
        {
            existingCategories = await CharacterDal.GetNpcCategoriesAsync();
        }
        catch
        {
            existingCategories = new List<string>();
        }
    }

    private async Task Save()
    {
        if (string.IsNullOrWhiteSpace(templateName)) return;
        isSaving = true;
        errorMessage = null;

        try
        {
            var creator = CreatorPortal.Create();
            creator.SourceCharacterId = Character.Id;
            creator.TemplateName = templateName.Trim();
            creator.Category = string.IsNullOrWhiteSpace(category) ? null : category.Trim();
            creator.Tags = string.IsNullOrWhiteSpace(tags) ? null : tags.Trim();

            creator = await CreatorPortal.ExecuteAsync(creator);

            if (creator.Success)
            {
                await OnClose.InvokeAsync(true);
            }
            else
            {
                errorMessage = creator.ErrorMessage ?? "Failed to create template";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task Cancel()
    {
        await OnClose.InvokeAsync(false);
    }
}
```
  </action>
  <verify>Build: `dotnet build Threa/Threa.Client/Threa.Client.csproj` - no errors</verify>
  <done>SaveAsTemplateModal component exists with template name, category, tags inputs and save functionality</done>
</task>

<task type="auto">
  <name>Task 3: Add Save as Template Button to CharacterDetailAdmin</name>
  <files>Threa/Threa.Client/Components/Shared/CharacterDetailAdmin.razor</files>
  <action>
Add "Save as Template" button and modal integration to CharacterDetailAdmin.

1. In the NPC Lifecycle section (which was added in Plan 03), add the Save as Template button BEFORE the Archive button:

Find the NPC Lifecycle card body and update to:
```razor
<div class="d-flex flex-column gap-2">
    @* Save as Template *@
    <button class="btn btn-outline-primary" @onclick="OpenSaveAsTemplateModal" disabled="@isProcessing">
        <i class="bi bi-file-earmark-plus me-1"></i>Save as Template
    </button>
    <small class="text-muted">Create a reusable template from this NPC's current state.</small>

    <hr class="my-2" />

    @* Archive - instant, no confirmation *@
    <button class="btn btn-outline-secondary" @onclick="ArchiveNpc" disabled="@isProcessing">
        <i class="bi bi-archive me-1"></i>Archive NPC
    </button>
    <small class="text-muted">Archives the NPC for later restoration. Instant - no confirmation needed.</small>

    @* Delete - requires confirmation *@
    <button class="btn btn-outline-danger mt-2" @onclick="ConfirmDeleteNpc" disabled="@isProcessing">
        <i class="bi bi-trash me-1"></i>Delete Permanently
    </button>
    <small class="text-muted">Permanently removes the NPC. Cannot be undone.</small>
</div>
```

2. Add the modal rendering after the delete confirmation dialog:
```razor
@* Save as Template Modal *@
@if (showSaveAsTemplateModal && Character != null)
{
    <SaveAsTemplateModal Character="@Character"
                         OnClose="OnSaveAsTemplateModalClose" />
}
```

3. Add state and methods in @code section:
```csharp
private bool showSaveAsTemplateModal;

private void OpenSaveAsTemplateModal()
{
    showSaveAsTemplateModal = true;
}

private async Task OnSaveAsTemplateModalClose(bool saved)
{
    showSaveAsTemplateModal = false;
    if (saved)
    {
        // Could show success message or navigate to template library
        // For now, just close the modal
    }
    StateHasChanged();
}
```
  </action>
  <verify>Build: `dotnet build Threa/Threa.Client/Threa.Client.csproj` - no errors</verify>
  <done>CharacterDetailAdmin has "Save as Template" button that opens SaveAsTemplateModal; saving creates new template in library</done>
</task>

</tasks>

<verification>
1. Solution builds without errors
2. NpcTemplateCreator command exists and compiles
3. SaveAsTemplateModal component exists
4. CharacterDetailAdmin shows "Save as Template" button for NPCs
5. Clicking button opens SaveAsTemplateModal
6. Modal pre-fills name with NPC name
7. Modal shows category autocomplete with existing categories
8. Saving creates new template with:
   - Full health pools
   - Cleared effects
   - IsTemplate = true
   - Copied attributes, skills, items
9. Template appears in template library
</verification>

<success_criteria>
- "Save as Template" button visible only for NPCs in CharacterDetailAdmin
- Modal opens with pre-filled name and category/tags inputs
- Saving executes NpcTemplateCreator command
- New template created with correct flags and reset state
- Template appears in /gamemaster/templates list
- Category autocomplete shows existing categories
</success_criteria>

<output>
After completion, create `.planning/phases/26-visibility-lifecycle/26-05-SUMMARY.md`
</output>
