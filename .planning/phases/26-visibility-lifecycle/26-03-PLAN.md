---
phase: 26-visibility-lifecycle
plan: 03
type: execute
wave: 2
depends_on: ["26-01"]
files_modified:
  - Threa/Threa.Client/Components/Shared/CharacterDetailAdmin.razor
  - Threa.Dal/ITableDal.cs
  - Threa.Dal.MockDb/MockTableDal.cs
  - Threa.Dal.Sqlite/SqliteTableDal.cs
autonomous: true

must_haves:
  truths:
    - "GM can archive an NPC (instant, no confirmation)"
    - "GM can delete an NPC (requires confirmation)"
    - "Archived NPCs are detached from table and set IsArchived = true"
    - "Deleted NPCs are permanently removed"
  artifacts:
    - path: "Threa/Threa.Client/Components/Shared/CharacterDetailAdmin.razor"
      provides: "NPC Lifecycle section with archive/delete buttons"
      contains: "NPC Lifecycle"
  key_links:
    - from: "CharacterDetailAdmin.razor"
      to: "CharacterEdit.IsArchived"
      via: "Archive flow sets property"
      pattern: "IsArchived = true"
    - from: "CharacterDetailAdmin.razor"
      to: "ICharacterDal.DeleteCharacterAsync"
      via: "Delete flow removes permanently"
      pattern: "DeleteCharacterAsync"
---

<objective>
Implement NPC dismiss/archive/delete functionality in CharacterDetailAdmin.

Purpose: GMs need to remove NPCs from the active table. Per CONTEXT.md, archive is instant (no confirmation), delete requires confirmation, and archived NPCs are retrievable while deleted NPCs are permanent.

Output: CharacterDetailAdmin extended with NPC Lifecycle section; archive/delete flows working.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/26-visibility-lifecycle/26-CONTEXT.md
@.planning/phases/26-visibility-lifecycle/26-RESEARCH.md
@.planning/phases/26-visibility-lifecycle/26-01-SUMMARY.md

@Threa/Threa.Client/Components/Shared/CharacterDetailAdmin.razor
@Threa.Dal/ITableDal.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NPC Lifecycle Section to CharacterDetailAdmin</name>
  <files>Threa/Threa.Client/Components/Shared/CharacterDetailAdmin.razor</files>
  <action>
Extend CharacterDetailAdmin.razor to include NPC-specific lifecycle actions.

1. Add required injections at the top (after existing @inject lines):
```razor
@inject IDataPortal<GameMechanics.CharacterEdit> characterPortal
@inject ICharacterDal characterDal
@inject ITableDal tableDal
```

2. Add using statement:
```razor
@using Threa.Dal
```

3. After the "Remove from Table" card (around line 31), add NPC Lifecycle section:
```razor
@* NPC Lifecycle Section - Only shown for NPCs *@
@if (Character?.IsNpc == true)
{
    <div class="card mt-3">
        <div class="card-header bg-secondary text-white">
            <strong><i class="bi bi-gear me-1"></i>NPC Lifecycle</strong>
        </div>
        <div class="card-body">
            <p class="text-muted small">
                Manage this NPC's lifecycle. Archive to save for later, or delete to remove permanently.
            </p>
            <div class="d-flex flex-column gap-2">
                @* Archive - instant, no confirmation *@
                <button class="btn btn-outline-secondary" @onclick="ArchiveNpc" disabled="@isProcessing">
                    <i class="bi bi-archive me-1"></i>Archive NPC
                </button>
                <small class="text-muted">Archives the NPC for later restoration. Instant - no confirmation needed.</small>

                @* Delete - requires confirmation *@
                <button class="btn btn-outline-danger mt-2" @onclick="ConfirmDeleteNpc" disabled="@isProcessing">
                    <i class="bi bi-trash me-1"></i>Delete Permanently
                </button>
                <small class="text-muted">Permanently removes the NPC. Cannot be undone.</small>
            </div>
        </div>
    </div>
}
```

4. Add delete confirmation dialog (after existing Remove Confirmation Dialog):
```razor
@* Delete NPC Confirmation Dialog *@
@if (showDeleteNpcConfirm)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Delete NPC Permanently</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CancelDeleteNpc"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to <strong>permanently delete</strong> <strong>@Character?.Name</strong>?</p>
                    <p class="text-danger small"><i class="bi bi-exclamation-triangle me-1"></i>This action cannot be undone. The NPC will be gone forever.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelDeleteNpc">Cancel</button>
                    <button type="button" class="btn btn-danger" @onclick="ExecuteDeleteNpc" disabled="@isProcessing">
                        <i class="bi bi-trash"></i> Delete Forever
                    </button>
                </div>
            </div>
        </div>
    </div>
}
```

5. Add state variables and methods in @code section:
```csharp
private bool showDeleteNpcConfirm;

private async Task ArchiveNpc()
{
    if (Character == null || !Character.IsNpc) return;
    isProcessing = true;

    try
    {
        // 1. Set IsArchived flag on character
        Character.IsArchived = true;
        await characterPortal.UpdateAsync(Character);

        // 2. Detach from table
        await tableDal.RemoveCharacterFromTableAsync(TableId, CharacterId);

        // 3. Notify parent that character was removed
        await OnCharacterRemoved.InvokeAsync();
    }
    catch (Exception ex)
    {
        errorMessage = $"Failed to archive: {ex.Message}";
        Character.IsArchived = false; // Revert on failure
    }
    finally
    {
        isProcessing = false;
    }
}

private void ConfirmDeleteNpc()
{
    showDeleteNpcConfirm = true;
}

private void CancelDeleteNpc()
{
    showDeleteNpcConfirm = false;
}

private async Task ExecuteDeleteNpc()
{
    if (Character == null || !Character.IsNpc) return;
    isProcessing = true;

    try
    {
        // 1. Detach from table first (avoid FK constraint issues)
        await tableDal.RemoveCharacterFromTableAsync(TableId, CharacterId);

        // 2. Delete character permanently
        await characterDal.DeleteCharacterAsync(CharacterId);

        // 3. Notify parent that character was removed
        await OnCharacterRemoved.InvokeAsync();
    }
    catch (Exception ex)
    {
        errorMessage = $"Failed to delete: {ex.Message}";
    }
    finally
    {
        isProcessing = false;
        showDeleteNpcConfirm = false;
    }
}
```
  </action>
  <verify>Build: `dotnet build Threa/Threa.Client/Threa.Client.csproj` - no errors</verify>
  <done>CharacterDetailAdmin has NPC Lifecycle section with Archive and Delete buttons; Archive is instant, Delete requires confirmation</done>
</task>

<task type="auto">
  <name>Task 2: Add RemoveCharacterFromTableAsync to ITableDal</name>
  <files>
    Threa.Dal/ITableDal.cs
    Threa.Dal.MockDb/MockTableDal.cs
    Threa.Dal.Sqlite/SqliteTableDal.cs
  </files>
  <action>
Add method to remove a character from a table (detach without deleting the character).

1. In Threa.Dal/ITableDal.cs, add method signature (if not already present):
```csharp
/// <summary>
/// Removes a character from a table (detaches without deleting the character).
/// </summary>
Task RemoveCharacterFromTableAsync(Guid tableId, int characterId);
```

2. In Threa.Dal.MockDb/MockTableDal.cs, implement:
```csharp
public Task RemoveCharacterFromTableAsync(Guid tableId, int characterId)
{
    var key = _tableCharacters.Keys.FirstOrDefault(k =>
        k.tableId == tableId && k.characterId == characterId);

    if (key != default)
    {
        _tableCharacters.TryRemove(key, out _);
    }

    return Task.CompletedTask;
}
```

3. In Threa.Dal.Sqlite/SqliteTableDal.cs, implement:
```csharp
public async Task RemoveCharacterFromTableAsync(Guid tableId, int characterId)
{
    await using var connection = new SqliteConnection(_connectionString);
    await connection.OpenAsync();

    var sql = "DELETE FROM TableCharacter WHERE TableId = @TableId AND CharacterId = @CharacterId";
    await connection.ExecuteAsync(sql, new { TableId = tableId.ToString(), CharacterId = characterId });
}
```

Note: Check if this method already exists - it may have been added as part of TableCharacterDetacher. If it exists, verify the signature matches and skip adding it again.
  </action>
  <verify>Build: `dotnet build Threa.sln` - no errors. Check ITableDal has RemoveCharacterFromTableAsync.</verify>
  <done>RemoveCharacterFromTableAsync method exists in ITableDal and both implementations</done>
</task>

</tasks>

<verification>
1. Solution builds without errors
2. CharacterDetailAdmin shows NPC Lifecycle section only for NPCs (Character.IsNpc == true)
3. Archive button archives NPC instantly:
   - Sets IsArchived = true
   - Removes from table
   - Closes modal with "removed" result
4. Delete button shows confirmation dialog
5. Confirming delete:
   - Removes from table
   - Deletes character permanently
   - Closes modal with "removed" result
6. Cancel on delete confirmation closes dialog without action
</verification>

<success_criteria>
- NPC Lifecycle section visible only for NPCs
- Archive is instant (no confirmation dialog)
- Archived NPC has IsArchived = true and is detached from table
- Delete shows confirmation dialog
- Confirmed delete removes NPC permanently
- Both actions close the modal and refresh dashboard
</success_criteria>

<output>
After completion, create `.planning/phases/26-visibility-lifecycle/26-03-SUMMARY.md`
</output>
