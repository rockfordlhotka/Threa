---
phase: 26-visibility-lifecycle
plan: 02
type: execute
wave: 2
depends_on: ["26-01"]
files_modified:
  - GameMechanics/NpcSpawner.cs
  - Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
  - Threa/Threa.Client/Components/Shared/HiddenNpcCard.razor
  - Threa/Threa.Client/Components/Shared/CharacterDetailModal.razor
autonomous: true

must_haves:
  truths:
    - "Newly spawned NPCs start hidden (VisibleToPlayers = false)"
    - "GmTable shows hidden NPCs in collapsible Hidden section"
    - "GM can reveal/hide NPCs from both card and modal"
    - "Visibility toggle is instant (no confirmation needed)"
  artifacts:
    - path: "GameMechanics/NpcSpawner.cs"
      provides: "Spawns NPCs as hidden by default"
      contains: "VisibleToPlayers = false"
    - path: "Threa/Threa.Client/Components/Shared/HiddenNpcCard.razor"
      provides: "Minimized card for hidden NPCs"
      min_lines: 30
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor"
      provides: "Hidden section with collapsible UI"
      contains: "showHiddenSection"
  key_links:
    - from: "GmTable.razor"
      to: "HiddenNpcCard.razor"
      via: "Component reference in Hidden section"
      pattern: "<HiddenNpcCard"
    - from: "CharacterDetailModal.razor"
      to: "CharacterEdit.VisibleToPlayers"
      via: "Toggle button sets property and saves"
      pattern: "VisibleToPlayers"
---

<objective>
Implement NPC visibility toggle with hidden section UI.

Purpose: GMs need to hide NPCs for surprise encounters. Per CONTEXT.md, spawned NPCs start hidden by default, appear in a collapsible "Hidden" section (collapsed by default), and can be revealed/hidden from both the minimized card and CharacterDetailModal.

Output: Complete visibility toggle workflow from spawn through reveal.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/26-visibility-lifecycle/26-CONTEXT.md
@.planning/phases/26-visibility-lifecycle/26-RESEARCH.md
@.planning/phases/26-visibility-lifecycle/26-01-SUMMARY.md

@GameMechanics/NpcSpawner.cs
@Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
@Threa/Threa.Client/Components/Shared/CharacterDetailModal.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Spawn NPCs as Hidden by Default</name>
  <files>GameMechanics/NpcSpawner.cs</files>
  <action>
In NpcSpawner.cs, modify the [Execute] method to spawn NPCs as hidden by default.

Find line ~184 where VisibleToPlayers is set:
```csharp
VisibleToPlayers = template.VisibleToPlayers,
```

Change to:
```csharp
VisibleToPlayers = false, // Spawned NPCs start hidden for surprise encounters
```

This ensures GMs control when NPCs are revealed to players, enabling surprise encounters as specified in CONTEXT.md.
  </action>
  <verify>Build: `dotnet build GameMechanics/GameMechanics.csproj` - no errors</verify>
  <done>NpcSpawner sets VisibleToPlayers = false on newly created NPCs</done>
</task>

<task type="auto">
  <name>Task 2: Create HiddenNpcCard Component and Add Hidden Section to GmTable</name>
  <files>
    Threa/Threa.Client/Components/Shared/HiddenNpcCard.razor
    Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
  </files>
  <action>
**Create HiddenNpcCard.razor** in Threa/Threa.Client/Components/Shared/:

```razor
@using GameMechanics.GamePlay
@using Threa.Dal.Dto

<div class="hidden-npc-card p-2 rounded border d-flex justify-content-between align-items-center"
     style="background: var(--color-bg-secondary); cursor: pointer;"
     @onclick="HandleClick">
    <div class="d-flex align-items-center gap-2">
        <i class="bi bi-eye-slash text-muted"></i>
        <span class="small">@Character.CharacterName</span>
        @* Disposition indicator *@
        @switch (Character.Disposition)
        {
            case NpcDisposition.Hostile:
                <i class="bi bi-skull text-danger small"></i>
                break;
            case NpcDisposition.Neutral:
                <i class="bi bi-circle text-secondary small"></i>
                break;
            case NpcDisposition.Friendly:
                <i class="bi bi-heart text-success small"></i>
                break;
        }
    </div>
    <button class="btn btn-outline-success btn-sm"
            title="Reveal to players"
            @onclick:stopPropagation="true"
            @onclick="HandleReveal">
        <i class="bi bi-eye"></i>
    </button>
</div>

@code {
    [Parameter, EditorRequired]
    public TableCharacterInfo Character { get; set; } = null!;

    [Parameter]
    public EventCallback<TableCharacterInfo> OnReveal { get; set; }

    [Parameter]
    public EventCallback<TableCharacterInfo> OnClick { get; set; }

    private async Task HandleReveal()
    {
        await OnReveal.InvokeAsync(Character);
    }

    private async Task HandleClick()
    {
        await OnClick.InvokeAsync(Character);
    }
}
```

**Modify GmTable.razor**:

1. Add state variable in @code section (around line 514):
```csharp
private bool showHiddenSection = false;
```

2. Add computed properties for hidden NPCs (around line 490, after friendlyNpcs):
```csharp
private IEnumerable<GameMechanics.GamePlay.TableCharacterInfo> hiddenNpcs =>
    tableNpcs.Where(c => !c.VisibleToPlayers);

private IEnumerable<GameMechanics.GamePlay.TableCharacterInfo> visibleHostileNpcs =>
    tableNpcs.Where(c => c.VisibleToPlayers && c.Disposition == NpcDisposition.Hostile);

private IEnumerable<GameMechanics.GamePlay.TableCharacterInfo> visibleNeutralNpcs =>
    tableNpcs.Where(c => c.VisibleToPlayers && c.Disposition == NpcDisposition.Neutral);

private IEnumerable<GameMechanics.GamePlay.TableCharacterInfo> visibleFriendlyNpcs =>
    tableNpcs.Where(c => c.VisibleToPlayers && c.Disposition == NpcDisposition.Friendly);
```

3. Replace the existing hostileNpcs, neutralNpcs, friendlyNpcs computed properties to filter by VisibleToPlayers:
   - Change `hostileNpcs =>` to `visibleHostileNpcs`
   - Change `neutralNpcs =>` to `visibleNeutralNpcs`
   - Change `friendlyNpcs =>` to `visibleFriendlyNpcs`
   - Update references in the HTML section (lines ~211-268)

4. Add Hidden section ABOVE the disposition groups (before "Hostile Group" around line 210):
```razor
@* Hidden Section - Collapsed by default, shows count *@
@if (hiddenNpcs.Any())
{
    <div class="npc-group mb-3">
        <button class="btn btn-sm w-100 d-flex justify-content-between align-items-center py-1"
                style="background: var(--color-bg-tertiary);"
                @onclick="() => showHiddenSection = !showHiddenSection">
            <span>
                <i class="bi bi-eye-slash text-muted me-1"></i>
                Hidden (@hiddenNpcs.Count())
            </span>
            <i class="bi @(showHiddenSection ? "bi-chevron-up" : "bi-chevron-down")"></i>
        </button>

        @if (showHiddenSection)
        {
            <div class="mt-2">
                <div class="row row-cols-2 row-cols-lg-3 g-2">
                    @foreach (var npc in hiddenNpcs)
                    {
                        <div class="col" @key="@($"hidden-{npc.CharacterId}-{characterListVersion}")">
                            <HiddenNpcCard Character="@npc"
                                          OnReveal="RevealNpc"
                                          OnClick="OpenCharacterDetails" />
                        </div>
                    }
                </div>
            </div>
        }
    </div>
}
```

5. Add RevealNpc method in @code section:
```csharp
private async Task RevealNpc(GameMechanics.GamePlay.TableCharacterInfo npc)
{
    try
    {
        var character = await characterPortal.FetchAsync(npc.CharacterId);
        character.VisibleToPlayers = true;
        await characterPortal.UpdateAsync(character);

        AddLogEntry($"Revealed NPC: {npc.CharacterName}", ActivityCategory.Player);

        // Publish update for real-time sync
        await TimeEventPublisher.PublishCharacterUpdateAsync(new CharacterUpdateMessage
        {
            CharacterId = npc.CharacterId,
            UpdateType = CharacterUpdateType.StatusChange,
            CampaignId = table!.Id.ToString(),
            Description = $"{npc.CharacterName} revealed to players"
        });

        await RefreshCharacterListAsync();
        StateHasChanged();
    }
    catch (Exception ex)
    {
        errorMessage = $"Failed to reveal NPC: {ex.Message}";
    }
}
```

6. Update the disposition group sections to use visible* properties instead of the old names.
  </action>
  <verify>Build: `dotnet build Threa/Threa.Client/Threa.Client.csproj` - no errors. Check that HiddenNpcCard.razor exists.</verify>
  <done>Hidden section displays in GmTable with collapsible UI; HiddenNpcCard component shows minimized NPC with reveal button</done>
</task>

<task type="auto">
  <name>Task 3: Add Visibility Toggle to CharacterDetailModal</name>
  <files>Threa/Threa.Client/Components/Shared/CharacterDetailModal.razor</files>
  <action>
Add visibility toggle button in CharacterDetailModal header for NPCs.

1. In the modal header area (around line 30, after the health bars section), add NPC visibility toggle:

Find the section with status badges (around line 59-89), and after the closing div for status badges, add:
```razor
@* NPC Visibility Toggle *@
@if (character.IsNpc)
{
    <button class="btn @(character.VisibleToPlayers ? "btn-outline-warning" : "btn-outline-success") btn-sm ms-2"
            @onclick="ToggleVisibility"
            title="@(character.VisibleToPlayers ? "Hide from players" : "Reveal to players")">
        <i class="bi @(character.VisibleToPlayers ? "bi-eye-slash" : "bi-eye") me-1"></i>
        @(character.VisibleToPlayers ? "Hide" : "Reveal")
    </button>
}
```

2. Add the ToggleVisibility method in @code section:
```csharp
private async Task ToggleVisibility()
{
    if (character == null || !character.IsNpc) return;

    character.VisibleToPlayers = !character.VisibleToPlayers;

    try
    {
        await characterPortal.UpdateAsync(character);

        // Publish update for real-time sync
        await TimeEventSubscriber.ConnectAsync(); // Ensure connected
        // Note: We need ITimeEventPublisher for publishing - add injection
    }
    catch
    {
        // Revert on failure
        character.VisibleToPlayers = !character.VisibleToPlayers;
    }

    StateHasChanged();
}
```

3. Add ITimeEventPublisher injection at top of file (around line 14):
```razor
@inject ITimeEventPublisher TimeEventPublisher
```

4. Update ToggleVisibility to publish the update:
```csharp
private async Task ToggleVisibility()
{
    if (character == null || !character.IsNpc) return;

    var wasVisible = character.VisibleToPlayers;
    character.VisibleToPlayers = !character.VisibleToPlayers;

    try
    {
        await characterPortal.UpdateAsync(character);

        // Publish update for real-time sync
        await TimeEventPublisher.PublishCharacterUpdateAsync(new CharacterUpdateMessage
        {
            CharacterId = character.Id,
            UpdateType = CharacterUpdateType.StatusChange,
            CampaignId = TableId.ToString(),
            Description = character.VisibleToPlayers ? "Revealed to players" : "Hidden from players"
        });
    }
    catch
    {
        // Revert on failure
        character.VisibleToPlayers = wasVisible;
    }

    StateHasChanged();
}
```

This provides visibility toggle accessible from the modal header, as specified in CONTEXT.md.
  </action>
  <verify>Build: `dotnet build Threa/Threa.Client/Threa.Client.csproj` - no errors</verify>
  <done>CharacterDetailModal shows visibility toggle button for NPCs in header area; toggle updates VisibleToPlayers and publishes update</done>
</task>

</tasks>

<verification>
1. Solution builds without errors
2. NpcSpawner sets VisibleToPlayers = false
3. GmTable shows Hidden section when hidden NPCs exist
4. Hidden section is collapsed by default
5. HiddenNpcCard displays NPC name, disposition icon, and reveal button
6. Clicking reveal button on HiddenNpcCard moves NPC to disposition group
7. CharacterDetailModal shows visibility toggle for NPCs
8. Toggle is instant (no confirmation)
</verification>

<success_criteria>
- Spawning an NPC creates it with VisibleToPlayers = false
- New NPC appears in Hidden section, not disposition groups
- Clicking reveal on HiddenNpcCard updates NPC to visible and moves to appropriate disposition group
- CharacterDetailModal visibility toggle works for both hidden->visible and visible->hidden
- Dashboard updates in real-time after visibility changes
</success_criteria>

<output>
After completion, create `.planning/phases/26-visibility-lifecycle/26-02-SUMMARY.md`
</output>
