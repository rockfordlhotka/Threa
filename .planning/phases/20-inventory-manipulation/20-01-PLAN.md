---
phase: 20-inventory-manipulation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Threa/Threa.Client/Components/Shared/ItemTemplatePickerModal.razor
autonomous: true

must_haves:
  truths:
    - "GM can browse all available item templates in a searchable grid"
    - "GM can filter item templates by item type"
    - "GM can filter item templates by rarity"
    - "GM can search item templates by name or description"
    - "GM can select a template and receive it as dialog result"
  artifacts:
    - path: "Threa/Threa.Client/Components/Shared/ItemTemplatePickerModal.razor"
      provides: "Item template browsing and selection modal"
      min_lines: 150
  key_links:
    - from: "ItemTemplatePickerModal.razor"
      to: "ItemTemplateList"
      via: "IDataPortal<ItemTemplateList>.FetchAsync()"
      pattern: "templateListPortal\\.FetchAsync"
    - from: "ItemTemplatePickerModal.razor"
      to: "DialogService"
      via: "DialogService.Close(template)"
      pattern: "DialogService\\.Close"
---

<objective>
Create the ItemTemplatePickerModal component for browsing and selecting item templates.

Purpose: Enable GMs to browse the item template library when adding items to character inventory. This follows the established EffectTemplatePickerModal pattern.

Output: New modal component that displays item templates in a searchable, filterable card grid and returns the selected template via DialogService.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/20-inventory-manipulation/20-RESEARCH.md
@.planning/phases/20-inventory-manipulation/20-CONTEXT.md

# Pattern reference
@Threa/Threa.Client/Components/Shared/EffectTemplatePickerModal.razor

# CSLA objects to use
@GameMechanics/Items/ItemTemplateList.cs
@GameMechanics/Items/ItemTemplateInfo.cs

# DTOs for type info
@Threa.Dal/Dto/ItemType.cs
@Threa.Dal/Dto/ItemRarity.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ItemTemplatePickerModal component</name>
  <files>Threa/Threa.Client/Components/Shared/ItemTemplatePickerModal.razor</files>
  <action>
Create ItemTemplatePickerModal.razor following the EffectTemplatePickerModal pattern exactly:

**Injections:**
- `@inject IDataPortal<ItemTemplateList> templateListPortal`
- `@inject DialogService DialogService`
- Implement IDisposable for debounce timer cleanup

**State:**
- `ItemTemplateList? templates` - loaded via CSLA data portal
- `bool isLoading = true`
- `string searchTerm = ""`
- `string filterType = ""` (ItemType filter)
- `string filterRarity = ""` (ItemRarity filter)
- `Timer? debounceTimer` (300ms debounce for search, same as EffectTemplatePickerModal)

**UI Structure:**
1. Search and filter bar (row with 3 columns):
   - col-md-6: Search input with bi-search icon, clear button when text present
   - col-md-3: ItemType dropdown (All Types + enum values)
   - col-md-3: ItemRarity dropdown (All Rarities + enum values)

2. Loading state:
   - Centered spinner with "Loading templates..." text

3. Template grid (max-height: 400px, overflow-y: auto):
   - Card layout: col-md-6 col-lg-4 (same as EffectTemplatePickerModal)
   - Each card:
     - Header: bg color by rarity, icon by ItemType, name (truncated)
     - Body: ItemType badge, weight display, description (truncated)
     - Footer: "Select" button

4. Empty state:
   - "No templates found" or "No items available" message

5. Footer:
   - Cancel button (calls DialogService.Close(null))

**Filter Logic (GetFilteredTemplates):**
- Filter by ItemType if filterType is set
- Filter by ItemRarity if filterRarity is set
- Filter by searchTerm (case-insensitive match on Name, Description, Tags)
- Sort by ItemType, then by Name

**Selection:**
- `SelectTemplate(ItemTemplateInfo template)` calls `DialogService.Close(template)`

**Styling Functions:**
```csharp
private static string GetRarityHeaderClass(ItemRarity rarity) => rarity switch
{
    ItemRarity.Common => "bg-secondary",
    ItemRarity.Uncommon => "bg-success",
    ItemRarity.Rare => "bg-primary",
    ItemRarity.Epic => "bg-purple",
    ItemRarity.Legendary => "bg-warning text-dark",
    _ => "bg-secondary"
};

private static string GetRarityBadgeClass(ItemRarity rarity) => rarity switch
{
    ItemRarity.Common => "bg-secondary-subtle text-secondary",
    ItemRarity.Uncommon => "bg-success-subtle text-success",
    ItemRarity.Rare => "bg-primary-subtle text-primary",
    ItemRarity.Epic => "bg-purple-subtle text-purple",
    ItemRarity.Legendary => "bg-warning-subtle text-warning",
    _ => "bg-secondary"
};

private static string GetItemTypeIcon(ItemType type) => type switch
{
    ItemType.Weapon => "bi-sword",
    ItemType.Armor => "bi-shield-fill",
    ItemType.Shield => "bi-shield-shaded",
    ItemType.Ammunition => "bi-bullseye",
    ItemType.AmmoContainer => "bi-box",
    ItemType.Consumable => "bi-capsule",
    ItemType.Container => "bi-box-seam",
    ItemType.Jewelry => "bi-gem",
    ItemType.Clothing => "bi-person-arms-up",
    ItemType.Food => "bi-egg-fried",
    ItemType.Drink => "bi-cup-straw",
    ItemType.Tool => "bi-tools",
    ItemType.Key => "bi-key",
    ItemType.Magic => "bi-magic",
    ItemType.Treasure => "bi-coin",
    ItemType.RawMaterial => "bi-box-seam-fill",
    ItemType.Miscellaneous => "bi-question-circle",
    _ => "bi-question-circle"
};
```

**Debounce pattern (from EffectTemplatePickerModal):**
```csharp
private void OnSearchInput()
{
    debounceTimer?.Stop();
    debounceTimer?.Dispose();
    debounceTimer = new Timer(300);
    debounceTimer.Elapsed += (_, _) => InvokeAsync(StateHasChanged);
    debounceTimer.AutoReset = false;
    debounceTimer.Start();
}

public void Dispose()
{
    debounceTimer?.Stop();
    debounceTimer?.Dispose();
}
```

**Card hover style (from EffectTemplatePickerModal):**
```css
.template-card:hover {
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
    transition: all 0.15s ease-in-out;
}
```
  </action>
  <verify>
1. File exists at Threa/Threa.Client/Components/Shared/ItemTemplatePickerModal.razor
2. `dotnet build Threa/Threa.Client/Threa.Client.csproj` succeeds
3. File contains all required elements: IDataPortal injection, search input, type filter, rarity filter, card grid, Select button, Cancel button
  </verify>
  <done>
ItemTemplatePickerModal.razor exists with searchable/filterable card grid layout matching EffectTemplatePickerModal pattern, ready to be opened via DialogService and return selected ItemTemplateInfo
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: `dotnet build Threa/Threa.Client/Threa.Client.csproj`
2. Component can be instantiated by Radzen DialogService (no constructor errors)
3. Template grid displays correctly when opened
</verification>

<success_criteria>
- ItemTemplatePickerModal.razor created following EffectTemplatePickerModal pattern
- Search, ItemType filter, and ItemRarity filter all work
- Card grid displays item templates with icons and rarity colors
- Selecting a template returns it via DialogService.Close()
- Cancel button returns null
- Debounced search (300ms delay)
</success_criteria>

<output>
After completion, create `.planning/phases/20-inventory-manipulation/20-01-SUMMARY.md`
</output>
