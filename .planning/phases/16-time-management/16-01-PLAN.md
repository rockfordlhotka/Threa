---
phase: 16-time-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
autonomous: true
user_setup: []

must_haves:
  truths:
    - "GM sees context-aware time buttons - only round in combat, only calendar in non-combat"
    - "GM sees Start/End Combat toggle button that changes label based on mode"
    - "GM sees red 'In Rounds: Round X' badge in header when in combat mode"
    - "Time controls are in dedicated right panel, always visible"
    - "Round button hidden (not disabled) when not in combat"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor"
      provides: "Reorganized time controls per CONTEXT.md decisions"
      contains: "In Rounds: Round"
  key_links:
    - from: "GmTable.razor time control section"
      to: "table.IsInCombat"
      via: "conditional rendering"
      pattern: "@if.*IsInCombat"
---

<objective>
Reorganize GM time controls to follow CONTEXT.md decisions: context-aware button display, Start/End Combat toggle, and prominent "In Rounds" badge.

Purpose: Implements TIME-01 through TIME-09 (minus TIME-10 which is already working). The existing time control UI shows all buttons regardless of mode. Per user decisions in CONTEXT.md:
- In combat: Only show +1 Round button
- In non-combat: Only show calendar buttons (+1 Min, +10 Min, +1 Hour, +1 Day, +1 Week)
- Single toggle button for combat mode (not separate Enter/Exit)
- Prominent red "In Rounds: Round X" badge in header

Output: Refactored GmTable.razor time controls section following the decided layout pattern.
</objective>

<execution_context>
@S:\src\rdl\threa\.planning\workflows\execute-plan.md
@S:\src\rdl\threa\.planning\templates\summary.md
</execution_context>

<context>
@S:\src\rdl\threa\.planning\PROJECT.md
@S:\src\rdl\threa\.planning\ROADMAP.md
@S:\src\rdl\threa\.planning\STATE.md
@S:\src\rdl\threa\.planning\phases\16-time-management\16-CONTEXT.md
@S:\src\rdl\threa\.planning\phases\16-time-management\16-RESEARCH.md
@S:\src\rdl\threa\Threa\Threa.Client\Components\Pages\GamePlay\GmTable.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor time control header with prominent combat badge</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor</files>
  <action>
  Update the header bar (the `gm-header` section around lines 48-67) to show the "In Rounds" badge more prominently:

  1. Keep existing elements but update the combat badge:
     - Replace the small "COMBAT" badge with "In Rounds: Round X" format
     - Use `bg-danger` class for red background
     - Only show when `table.IsInCombat` is true
     - Format: `<span class="badge bg-danger fs-6">In Rounds: Round @table.CurrentRound</span>`
     - Remove the separate "Round X" badge since it will be combined

  2. The header should show:
     - Table name and status (existing)
     - Theme switcher (existing)
     - Game time display (existing)
     - "In Rounds: Round X" badge (only when in combat, red, prominent)

  Reference existing code pattern for badge styling. The fs-6 class makes it slightly larger than default.
  </action>
  <verify>Build compiles: `dotnet build Threa/Threa.sln`</verify>
  <done>Header shows "In Rounds: Round X" red badge only when in combat mode, hidden otherwise</done>
</task>

<task type="auto">
  <name>Task 2: Implement context-aware time buttons with toggle</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor</files>
  <action>
  Refactor the TIME CONTROLS card body (around lines 197-296) to implement context-aware display per CONTEXT.md:

  1. **Current Time Display** (keep existing, around lines 199-204):
     - No changes needed

  2. **Combat Mode Toggle Button** (replace the separate Enter/Exit buttons):
     - Single button that toggles between states
     - In combat: Shows "End Combat" with `btn-outline-success` and `bi-peace` icon
     - Not in combat: Shows "Start Combat" with `btn-danger` and `bi-shield-exclamation` icon
     - Use `w-100` for full width
     - Place BEFORE the time buttons section

  3. **Context-Aware Time Buttons** (replace the current dual sections):
     - Use `@if (table.IsInCombat)` to show ONLY the round button when in combat:
       ```razor
       <button class="btn btn-primary w-100" @onclick="AdvanceRound">
           +1 Round
       </button>
       ```
     - Use `@else` to show ONLY calendar buttons when NOT in combat:
       ```razor
       <div class="d-grid gap-2">
           <button class="btn btn-outline-primary w-100" @onclick="() => AdvanceTime(60)">+1 Min</button>
           <button class="btn btn-outline-primary w-100" @onclick="() => AdvanceTime(600)">+10 Min</button>
           <button class="btn btn-outline-primary w-100" @onclick="() => AdvanceTime(3600)">+1 Hour</button>
           <button class="btn btn-outline-primary w-100" @onclick="() => AdvanceTime(86400)">+1 Day</button>
           <button class="btn btn-outline-primary w-100" @onclick="() => AdvanceTime(604800)">+1 Week</button>
       </div>
       ```
     - Use short labels: "+1 Min", "+10 Min", "+1 Hour", "+1 Day", "+1 Week" (not verbose)

  4. **Remove from combat section** (lines 226-246):
     - Remove the +5 and +10 quick round advance buttons
     - Remove the custom round advance input group
     - Keep ONLY the single +1 Round button for simplicity per CONTEXT.md

  5. **Maintain Lobby/Active checks** (lines 206-219):
     - Keep the Start Session button and start time input for Lobby status
     - Only show time controls when table.Status == Active

  Order in the card body should be:
  1. Current time display
  2. If Lobby: Start time input + Start Session button
  3. If Active:
     a. Combat toggle button (Start/End Combat)
     b. Spacing (use mb-3 or hr)
     c. Context-aware time buttons (either +1 Round OR calendar buttons)
  </action>
  <verify>
  Build compiles: `dotnet build Threa/Threa.sln`
  Manual test:
  - In non-combat mode: See only calendar buttons (+1 Min, +10 Min, +1 Hour, +1 Day, +1 Week) and "Start Combat" button
  - Click "Start Combat": Button changes to "End Combat", calendar buttons hidden, +1 Round button appears
  - Header shows red "In Rounds: Round X" badge
  - Click "End Combat": Returns to calendar mode
  </verify>
  <done>Time controls show context-aware buttons - round only in combat, calendar only outside combat. Single toggle button for combat mode.</done>
</task>

<task type="auto">
  <name>Task 3: Clean up TIME CONTROLS card header</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor</files>
  <action>
  Update the TIME CONTROLS card header (around lines 192-196) to remove redundant round display since it's now in the main header badge:

  1. Simplify the card header to just show "TIME CONTROLS" label:
     ```razor
     <div class="card-header">
         <strong><i class="bi bi-clock-history me-1"></i>TIME CONTROLS</strong>
     </div>
     ```
  2. Remove the "Round @table.CurrentRound" badge from this card header since:
     - It's now prominently shown in the main header when in combat
     - The card focuses purely on time advancement actions

  This declutters the UI per the CONTEXT.md decision that the panel contains "only time advancement buttons - no additional info displays."
  </action>
  <verify>Build compiles and app runs without errors: `dotnet build Threa/Threa.sln`</verify>
  <done>TIME CONTROLS card header is clean with just the label, no redundant round display</done>
</task>

</tasks>

<verification>
1. Build succeeds: `dotnet build Threa/Threa.sln`
2. Run app and navigate to GM table
3. Verify non-combat mode:
   - Header shows NO "In Rounds" badge
   - Time controls show "Start Combat" button (red, danger styling)
   - Time controls show only calendar buttons: +1 Min, +10 Min, +1 Hour, +1 Day, +1 Week
   - No round button visible
4. Click "Start Combat":
   - Button changes to "End Combat" (green outline, success styling)
   - Header shows "In Rounds: Round 1" badge (red background)
   - Calendar buttons hidden
   - Single +1 Round button visible
5. Click +1 Round:
   - Round increments, badge updates to "In Rounds: Round 2"
6. Click "End Combat":
   - Returns to calendar mode, round button hidden, calendar buttons visible
   - "In Rounds" badge hidden from header
</verification>

<success_criteria>
- TIME-01: GM can advance by 1 round (via +1 Round button in combat mode)
- TIME-02: GM can advance by 1 minute (via +1 Min button in non-combat mode)
- TIME-03: GM can advance by 1 turn/10 min (via +10 Min button in non-combat mode)
- TIME-04: GM can advance by 1 hour (via +1 Hour button)
- TIME-05: GM can advance by 1 day (via +1 Day button)
- TIME-06: GM can advance by 1 week (via +1 Week button)
- TIME-07: GM can enter "in rounds" mode (via Start Combat button)
- TIME-08: GM can exit "in rounds" mode (via End Combat button)
- TIME-09: Round button only available in combat mode (hidden otherwise)
- UI follows CONTEXT.md decisions: context-aware display, single toggle, red badge
</success_criteria>

<output>
After completion, create `.planning/phases/16-time-management/16-01-SUMMARY.md`
</output>
