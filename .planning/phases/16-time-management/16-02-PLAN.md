---
phase: 16-time-management
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Threa/Threa.Client/Components/Pages/GamePlay/Play.razor
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Player's character processes time changes when GM advances non-combat time"
    - "Player sees 'In Rounds' badge when table is in combat mode"
    - "Player's badge is hidden when table is in normal (non-combat) mode"
    - "Pending damage/healing, effect expiration, and AP recovery work for time skips"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/Play.razor"
      provides: "TimeSkipReceived subscription and In Rounds indicator"
      contains: "TimeSkipReceived"
  key_links:
    - from: "Play.razor"
      to: "TimeSkipReceived event"
      via: "event subscription in SubscribeToTimeEvents"
      pattern: "TimeSkipReceived.*OnTimeSkipReceived"
    - from: "Play.razor header"
      to: "table.IsInCombat"
      via: "conditional badge rendering"
      pattern: "In Rounds"
---

<objective>
Fix Play.razor to subscribe to TimeSkipReceived events and add "In Rounds" badge for players.

Purpose: Implements TIME-10 through TIME-14 (player-side requirements). Currently, Play.razor only subscribes to TimeEventReceived (combat rounds) but not TimeSkipReceived (non-combat time advancement like minutes/hours/days). This means characters don't process pending damage/healing when GM advances non-combat time. Also adds the "In Rounds" indicator per user decision.

Output: Play.razor with complete time event handling and combat mode indicator.
</objective>

<execution_context>
@S:\src\rdl\threa\.planning\workflows\execute-plan.md
@S:\src\rdl\threa\.planning\templates\summary.md
</execution_context>

<context>
@S:\src\rdl\threa\.planning\PROJECT.md
@S:\src\rdl\threa\.planning\ROADMAP.md
@S:\src\rdl\threa\.planning\STATE.md
@S:\src\rdl\threa\.planning\phases\16-time-management\16-CONTEXT.md
@S:\src\rdl\threa\.planning\phases\16-time-management\16-RESEARCH.md
@S:\src\rdl\threa\Threa\Threa.Client\Components\Pages\GamePlay\Play.razor
@S:\src\rdl\threa\GameMechanics\Messaging\ITimeEventSubscriber.cs
@S:\src\rdl\threa\GameMechanics\Messaging\TimeMessages.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TimeSkipReceived event subscription</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/Play.razor</files>
  <action>
  Add subscription to TimeSkipReceived event in Play.razor to handle non-combat time advancement:

  1. **Update SubscribeToTimeEvents method** (around line 617-621):
     Add subscription to TimeSkipReceived alongside existing subscriptions:
     ```csharp
     TimeEventSubscriber.TimeSkipReceived += OnTimeSkipReceived;
     ```

  2. **Add OnTimeSkipReceived handler** (add after OnTimeEventReceived, around line 659):
     ```csharp
     private void OnTimeSkipReceived(object? sender, TimeSkipMessage e)
     {
         // Only process if this event is for our table
         if (table == null || e.CampaignId != table.Id.ToString()) return;

         InvokeAsync(async () =>
         {
             try
             {
                 // Process time skip effects on the character
                 if (character != null)
                 {
                     // Time skips trigger end-of-round processing for each time unit
                     // Each round = 3 seconds, calculate how many "rounds" the skip represents
                     int roundsEquivalent = e.SkipUnit switch
                     {
                         GameMechanics.Time.TimeEventType.EndOfMinute => 10 * e.Count,      // 1 min = 10 rounds
                         GameMechanics.Time.TimeEventType.EndOfTurn => 100 * e.Count,      // 10 min = 100 rounds
                         GameMechanics.Time.TimeEventType.EndOfHour => 600 * e.Count,      // 1 hour = 600 rounds
                         GameMechanics.Time.TimeEventType.EndOfDay => 14400 * e.Count,     // 1 day = 14400 rounds
                         GameMechanics.Time.TimeEventType.EndOfWeek => 100800 * e.Count,   // 1 week = 100800 rounds
                         _ => e.Count // Default to count if unknown
                     };

                     // Apply end-of-round effects for the time period
                     // Note: For large time skips, we batch process rather than loop
                     // EndOfRound handles pending pools and effect expiration
                     for (int i = 0; i < Math.Min(roundsEquivalent, 100); i++)
                     {
                         character.EndOfRound(effectPortal);
                     }
                     // For large skips (100+ rounds), just process once more to catch any remaining effects
                     if (roundsEquivalent > 100)
                     {
                         character.EndOfRound(effectPortal);
                     }

                     // Save the updated character
                     await characterPortal.UpdateAsync(character);

                     // Refresh table state to get updated time
                     if (table != null)
                     {
                         table = await tablePortal.FetchAsync(table.Id);
                     }
                 }

                 StateHasChanged();
             }
             catch (Exception ex)
             {
                 errorMessage = $"Error processing time skip: {ex.Message}";
                 StateHasChanged();
             }
         });
     }
     ```

  3. **Update UnsubscribeFromTimeEvents method** (around line 730-739):
     Add unsubscription:
     ```csharp
     TimeEventSubscriber.TimeSkipReceived -= OnTimeSkipReceived;
     ```

  **Important notes:**
  - The existing OnTimeEventReceived handles EndOfRound events (combat rounds)
  - OnTimeSkipReceived handles calendar time advancement (minutes, hours, days, etc.)
  - Both call character.EndOfRound() which processes pending pools and effects
  - Large time skips are capped at 100 iterations to avoid UI freeze; this processes most pending damage/healing and expires most effects without blocking
  </action>
  <verify>Build compiles: `dotnet build Threa/Threa.sln`</verify>
  <done>Play.razor subscribes to TimeSkipReceived and processes character time effects for non-combat advancement</done>
</task>

<task type="auto">
  <name>Task 2: Add "In Rounds" badge to player header</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/Play.razor</files>
  <action>
  Add "In Rounds" indicator badge to the character header when the table is in combat mode:

  1. **Update the Table Info section** (around lines 327-339, inside the character header):
     The existing code shows table name, game time, and COMBAT/EXPLORATION badge. Update to show "In Rounds" badge per CONTEXT.md:

     Find the section that renders table info (inside `@if (table != null)`):
     ```razor
     @if (table != null)
     {
         <div class="text-end p-2 rounded" style="background: var(--color-bg-tertiary);">
             <div style="font-family: var(--font-display); font-size: 0.85rem;">@table.Name</div>
             <small style="color: var(--color-text-muted);">@GameTimeFormatter.FormatCompact(table.CurrentTimeSeconds)</small>
             <div class="mt-1">
                 @if (table.IsInCombat)
                 {
                     <span class="badge bg-danger">In Rounds</span>
                 }
                 <span class="badge bg-info ms-1">Round @table.CurrentRound</span>
             </div>
         </div>
     }
     ```

     Changes:
     - Replace the `@(table.IsInCombat ? "COMBAT" : "EXPLORATION")` ternary with a conditional block
     - Show "In Rounds" badge (red, bg-danger) ONLY when `table.IsInCombat` is true
     - Remove the EXPLORATION badge entirely when not in combat (cleaner per CONTEXT.md)
     - Keep the "Round X" badge always visible (it shows current round even outside combat)

  2. **Updated code structure:**
     ```razor
     @if (table != null)
     {
         <div class="text-end p-2 rounded" style="background: var(--color-bg-tertiary);">
             <div style="font-family: var(--font-display); font-size: 0.85rem;">@table.Name</div>
             <small style="color: var(--color-text-muted);">@GameTimeFormatter.FormatCompact(table.CurrentTimeSeconds)</small>
             <div class="mt-1">
                 @if (table.IsInCombat)
                 {
                     <span class="badge bg-danger">In Rounds</span>
                 }
                 <span class="badge bg-info ms-1">Round @table.CurrentRound</span>
             </div>
         </div>
     }
     ```

  This satisfies TIME-13 (show indicator when in rounds) and TIME-14 (hide when not).
  </action>
  <verify>
  Build compiles: `dotnet build Threa/Threa.sln`
  Manual test:
  - When table is in combat mode: Player sees red "In Rounds" badge in header
  - When table exits combat: Badge disappears
  </verify>
  <done>Player header shows "In Rounds" badge when table is in combat mode, hidden otherwise</done>
</task>

</tasks>

<verification>
1. Build succeeds: `dotnet build Threa/Threa.sln`
2. Run app with two browser windows: GM table and player Play page
3. Test non-combat time advancement:
   - Apply pending damage to character (via GM Actions)
   - GM clicks +1 Min (non-combat time advancement)
   - Player's character should process pending damage (FAT/VIT values change)
   - Verify activity log shows time advancement
4. Test combat mode indicator:
   - In non-combat mode: Player header shows Round X but NO "In Rounds" badge
   - GM clicks "Start Combat"
   - Player header should show red "In Rounds" badge
   - GM clicks "End Combat"
   - Player's "In Rounds" badge should disappear
5. Test both time event types work:
   - In combat: GM advances rounds -> player processes EndOfRound
   - Out of combat: GM advances time -> player processes TimeSkip
</verification>

<success_criteria>
- TIME-10: Time advancement triggers message to all characters (via existing publisher, now properly handled)
- TIME-11: Characters process time advancement (pending damage/healing, effect expiration, AP recovery)
- TIME-12: GM dashboard reflects updates (existing 500ms delay pattern continues to work)
- TIME-13: Player Play page displays "In Rounds" indicator when in combat mode
- TIME-14: Player Play page hides indicator when in normal mode
- Pending todo from STATE.md resolved: Play.razor now subscribes to TimeSkipReceived
</success_criteria>

<output>
After completion, create `.planning/phases/16-time-management/16-02-SUMMARY.md`
</output>
