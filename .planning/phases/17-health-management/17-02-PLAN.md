---
phase: 17-health-management
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Threa/Threa.Client/Components/Shared/CharacterDetailGmActions.razor
autonomous: true

must_haves:
  truths:
    - "GM can toggle between damage and healing modes with prominent button group"
    - "GM enters a single positive value that applies as damage or healing based on mode"
    - "GM sees overflow warning when FAT damage would cascade to VIT"
    - "GM sees overheal warning when healing would exceed pool maximum"
    - "GM can confirm or cancel after seeing warning"
    - "Dashboard updates in real-time when damage/healing is applied"
  artifacts:
    - path: "Threa/Threa.Client/Components/Shared/CharacterDetailGmActions.razor"
      provides: "Refactored health management with mode toggle and warnings"
      contains: "HealthMode"
  key_links:
    - from: "CharacterDetailGmActions.razor"
      to: "CharacterEdit"
      via: "characterPortal.FetchAsync"
      pattern: "characterPortal.FetchAsync\\(CharacterId\\)"
    - from: "CharacterDetailGmActions.razor"
      to: "TimeEventPublisher"
      via: "PublishCharacterUpdateAsync"
      pattern: "PublishCharacterUpdateAsync"
---

<objective>
Refactor CharacterDetailGmActions health controls to use a damage/healing mode toggle with overflow and overheal warnings.

Purpose: Per CONTEXT.md, the GM should use a mode toggle instead of separate cards, see warnings before cascading damage or exceeding pool limits, and have a cleaner single-purpose interface.

Output: Unified health management card with mode toggle, single numeric input, FAT/VIT apply buttons, and inline warnings for overflow/overheal scenarios.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-health-management/17-CONTEXT.md
@.planning/phases/17-health-management/17-RESEARCH.md

Source file to modify:
@Threa/Threa.Client/Components/Shared/CharacterDetailGmActions.razor

Reference for business object structure:
@GameMechanics/Fatigue.cs
@GameMechanics/Vitality.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor damage/healing cards to unified mode toggle</name>
  <files>Threa/Threa.Client/Components/Shared/CharacterDetailGmActions.razor</files>
  <action>
Replace the separate "Apply Damage" and "Apply Healing" cards with a single unified health management card:

1. Add enum and state fields in @code block:
   ```csharp
   private enum HealthMode { Damage, Healing }
   private HealthMode healthMode = HealthMode.Damage;
   private int healthAmount = 1;
   private bool showOverflowWarning;
   private string overflowWarningMessage = "";
   private string pendingPool = "";
   ```

2. Remove the separate `damageAmount` and `healAmount` fields (replace with `healthAmount`)

3. Create single card with mode toggle:
   - Card header color changes based on mode: danger (red) for damage, success (green) for healing
   - Header text: "Apply Damage" or "Apply Healing" based on mode
   - Header icon: bi-heart-pulse for damage, bi-bandaid for healing

4. Add Bootstrap button group toggle inside card body:
   ```html
   <div class="btn-group w-100 mb-3" role="group">
       <button class="btn @(healthMode == HealthMode.Damage ? "btn-danger" : "btn-outline-danger")"
               @onclick="() => SetMode(HealthMode.Damage)">
           <i class="bi bi-dash-circle me-1"></i>Damage
       </button>
       <button class="btn @(healthMode == HealthMode.Healing ? "btn-success" : "btn-outline-success")"
               @onclick="() => SetMode(HealthMode.Healing)">
           <i class="bi bi-plus-circle me-1"></i>Healing
       </button>
   </div>
   ```

5. Add single numeric input for amount (replace two separate inputs)

6. Add FAT/VIT apply buttons that use mode-appropriate styling:
   - btn-danger for damage mode, btn-success for healing mode
   - Both buttons call ApplyToPool("FAT") or ApplyToPool("VIT")

7. Add helper method:
   ```csharp
   private void SetMode(HealthMode mode)
   {
       healthMode = mode;
       showOverflowWarning = false; // Clear any pending warning on mode change
   }
   ```

8. Remove the old ApplyDamageToFat/ApplyDamageToVit/ApplyHealingToFat/ApplyHealingToVit wrappers
  </action>
  <verify>
Build project: `dotnet build Threa/Threa.Client/Threa.Client.csproj`
Verify no compilation errors.
  </verify>
  <done>
CharacterDetailGmActions has single health card with mode toggle replacing two separate cards. Card header and buttons change color based on damage/healing mode selection.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add overflow and overheal warning logic</name>
  <files>Threa/Threa.Client/Components/Shared/CharacterDetailGmActions.razor</files>
  <action>
Implement the warning system for overflow (FAT->VIT cascade) and overheal scenarios:

1. Create ApplyToPool method that checks for warnings before applying:
   ```csharp
   private async Task ApplyToPool(string pool)
   {
       if (Character == null) return;
       pendingPool = pool;

       if (healthMode == HealthMode.Damage && pool == "FAT")
       {
           // Check FAT overflow to VIT
           var projectedFat = Character.Fatigue.Value - Character.Fatigue.PendingDamage - healthAmount;
           if (projectedFat < 0)
           {
               var overflow = Math.Abs(projectedFat);
               overflowWarningMessage = $"This will exceed FAT capacity. {overflow} points will cascade to VIT pending damage.";
               showOverflowWarning = true;
               return;
           }
       }

       if (healthMode == HealthMode.Healing)
       {
           // Check overheal
           var currentValue = pool == "FAT" ? Character.Fatigue.Value : Character.Vitality.Value;
           var pendingHealing = pool == "FAT" ? Character.Fatigue.PendingHealing : Character.Vitality.PendingHealing;
           var maxValue = pool == "FAT" ? Character.Fatigue.BaseValue : Character.Vitality.BaseValue;
           var projectedValue = currentValue + pendingHealing + healthAmount;

           if (projectedValue > maxValue)
           {
               var overheal = projectedValue - maxValue;
               overflowWarningMessage = $"This will exceed max {pool}. {overheal} points of temporary overheal will be applied.";
               showOverflowWarning = true;
               return;
           }
       }

       await ExecuteApply();
   }
   ```

2. Add warning confirmation UI after the apply buttons (inside the card):
   ```html
   @if (showOverflowWarning)
   {
       <div class="alert @(healthMode == HealthMode.Damage ? "alert-warning" : "alert-info") mt-3 mb-0">
           <i class="bi bi-exclamation-triangle me-1"></i>
           @overflowWarningMessage
           <div class="mt-2 d-flex gap-2">
               <button class="btn @(healthMode == HealthMode.Damage ? "btn-warning" : "btn-info") btn-sm"
                       @onclick="ConfirmApply" disabled="@isProcessing">
                   Apply Anyway
               </button>
               <button class="btn btn-secondary btn-sm" @onclick="CancelApply">
                   Cancel
               </button>
           </div>
       </div>
   }
   ```

3. Add confirmation handlers:
   ```csharp
   private async Task ConfirmApply()
   {
       showOverflowWarning = false;
       await ExecuteApply();
   }

   private void CancelApply()
   {
       showOverflowWarning = false;
       pendingPool = "";
   }
   ```

4. Create ExecuteApply method that performs the actual operation:
   ```csharp
   private async Task ExecuteApply()
   {
       if (Character == null || string.IsNullOrEmpty(pendingPool)) return;
       isProcessing = true;

       try
       {
           var character = await characterPortal.FetchAsync(CharacterId);

           if (healthMode == HealthMode.Damage)
           {
               if (pendingPool == "FAT")
                   character.Fatigue.PendingDamage += healthAmount;
               else
                   character.Vitality.PendingDamage += healthAmount;
           }
           else
           {
               if (pendingPool == "FAT")
                   character.Fatigue.PendingHealing += healthAmount;
               else
                   character.Vitality.PendingHealing += healthAmount;
           }

           await characterPortal.UpdateAsync(character);

           var updateType = healthMode == HealthMode.Damage
               ? CharacterUpdateType.Damage
               : CharacterUpdateType.Healing;
           var action = healthMode == HealthMode.Damage ? "damage" : "healing";

           await TimeEventPublisher.PublishCharacterUpdateAsync(new CharacterUpdateMessage
           {
               CharacterId = CharacterId,
               UpdateType = updateType,
               CampaignId = TableId.ToString(),
               SourceId = "GM",
               Description = $"{healthAmount} {pendingPool} {action}"
           });

           ShowFeedback($"Saved: {healthAmount} {pendingPool} {action} applied", "alert-success", "bi-check-circle");
           await OnCharacterUpdated.InvokeAsync();
       }
       catch (Exception ex)
       {
           ShowFeedback($"Error saving: {ex.Message}", "alert-danger", "bi-exclamation-triangle");
       }
       finally
       {
           isProcessing = false;
           pendingPool = "";
       }
   }
   ```

5. Remove the old ApplyDamageToPool and ApplyHealingToPool methods (now consolidated)
  </action>
  <verify>
Build project: `dotnet build Threa/Threa.Client/Threa.Client.csproj`
Run application and test:
1. Apply FAT damage that would overflow - warning should appear
2. Click "Apply Anyway" - damage should apply
3. Apply healing that exceeds max - overheal warning should appear
4. Click "Cancel" - no changes should be made
  </verify>
  <done>
Health management has complete overflow/overheal warning system with confirmation dialogs. GM can see exactly what will happen before committing to cascading or excess operations.
  </done>
</task>

<task type="auto">
  <name>Task 3: Clean up layout and ensure visual consistency</name>
  <files>Threa/Threa.Client/Components/Shared/CharacterDetailGmActions.razor</files>
  <action>
Final cleanup pass to ensure the refactored component is visually consistent:

1. Update the grid layout - now only 3 cards instead of 4:
   - Health Management (new unified card) - col-md-6
   - Effects - col-md-6
   - Character Management - col-12 (full width at bottom, or keep col-md-6 with empty space)

2. Ensure card heights are consistent (`h-100` on all cards)

3. Add CSS transition for smooth header color change on mode toggle:
   - The card header already uses inline style for bg color
   - Ensure transition is smooth: `style="transition: background-color 0.2s ease; background-color: @(healthMode == HealthMode.Damage ? "var(--btn-danger-bg)" : "var(--btn-success-bg)"); color: white;"`

4. Verify button group toggle has clear visual distinction:
   - Active state should be solid button (btn-danger/btn-success)
   - Inactive state should be outline (btn-outline-danger/btn-outline-success)

5. Test keyboard navigation:
   - Mode toggle buttons should be accessible
   - Number input should accept keyboard entry
   - Enter key in input could trigger apply (optional enhancement)

6. Verify the component still handles edge cases:
   - Character is null (early return)
   - healthAmount is 0 or negative (should be prevented by min="1")
   - Concurrent operations (isProcessing flag)
  </action>
  <verify>
Run application:
1. Open GM Dashboard and click on a character
2. Navigate to GM Actions tab
3. Verify mode toggle is prominent and clear
4. Toggle between damage/healing - observe smooth color transition
5. Apply damage and healing operations
6. Verify feedback messages appear correctly
7. Switch themes (fantasy/scifi) and verify colors are appropriate
  </verify>
  <done>
CharacterDetailGmActions is fully refactored with unified health management card, mode toggle, overflow/overheal warnings, and visual polish.
  </done>
</task>

</tasks>

<verification>
1. Build solution without errors: `dotnet build Threa.sln`
2. Run application and navigate to GM Dashboard
3. Open character modal and go to GM Actions tab
4. Verify single health management card with mode toggle
5. Test damage mode:
   - Apply small FAT damage (no warning)
   - Apply large FAT damage that overflows (warning appears)
   - Confirm overflow warning
6. Test healing mode:
   - Apply small healing (no warning)
   - Apply large healing that overheals (warning appears)
   - Cancel overheal warning
7. Verify real-time updates propagate to dashboard
8. Test both themes for visual consistency
</verification>

<success_criteria>
- Single unified health card replaces two separate cards
- Mode toggle switches between damage (red) and healing (green)
- FAT overflow warning appears when damage would cascade to VIT
- Overheal warning appears when healing exceeds maximum
- Confirm/Cancel buttons on warnings work correctly
- Real-time updates continue to function
- Visual styling matches theme (fantasy/scifi)
- All 7 HLTH requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/17-health-management/17-02-SUMMARY.md`
</output>
