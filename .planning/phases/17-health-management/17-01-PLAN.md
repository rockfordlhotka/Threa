---
phase: 17-health-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Threa/Threa.Client/Components/Shared/PendingPoolBar.razor
  - Threa/Threa.Client/Components/Shared/PendingPoolBar.razor.cs
autonomous: true

must_haves:
  truths:
    - "Health bar shows green color when pool > 50% capacity"
    - "Health bar shows yellow color when pool is 25-50% capacity"
    - "Health bar shows red color when pool < 25% capacity"
    - "Overheal (healing beyond max) displays with badge indicator"
  artifacts:
    - path: "Threa/Threa.Client/Components/Shared/PendingPoolBar.razor.cs"
      provides: "Color threshold calculation logic"
      contains: "GetBarColorClass"
    - path: "Threa/Threa.Client/Components/Shared/PendingPoolBar.razor"
      provides: "Enhanced progress bar with color thresholds"
      contains: "progress-bar"
  key_links:
    - from: "PendingPoolBar.razor"
      to: "PendingPoolBar.razor.cs"
      via: "inherits PendingPoolBarBase"
      pattern: "@inherits PendingPoolBarBase"
    - from: "PendingPoolBar"
      to: "CharacterUpdateMessage"
      via: "Parent component receives message and re-renders PendingPoolBar with updated parameters"
      pattern: "OnCharacterUpdated"
---

<objective>
Enhance PendingPoolBar component with color-coded health thresholds and overheal support.

Purpose: Visual health indication helps GMs quickly assess character status using color (green/yellow/red) thresholds defined in CONTEXT.md.

Output: Enhanced PendingPoolBar with theme-aware color thresholds (>50% green, 25-50% yellow, <25% red) and overheal badge indicator for temporary buffs.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-health-management/17-CONTEXT.md
@.planning/phases/17-health-management/17-RESEARCH.md

Source files to modify:
@Threa/Threa.Client/Components/Shared/PendingPoolBar.razor
@Threa/Threa.Client/Components/Shared/PendingPoolBar.razor.cs

Theme color variables reference:
@Threa/Threa/wwwroot/css/themes.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add color threshold calculation to PendingPoolBar.razor.cs</name>
  <files>Threa/Threa.Client/Components/Shared/PendingPoolBar.razor.cs</files>
  <action>
Add protected methods to PendingPoolBarBase class for color threshold calculation:

1. Add `protected string BarColorClass { get; private set; } = "health-full";`

2. Add `protected int OverhealAmount { get; private set; }` for badge display

3. Create `GetBarColorClass()` method that:
   - Calculates effective value: `CurrentValue - PendingDamage + PendingHealing`
   - Calculates percentage: `effectiveValue / MaxValue * 100`
   - Returns "health-full" if >50%, "health-mid" if >25%, "health-low" otherwise
   - NOTE: Use string class names, not CSS variables directly (CSS handles the mapping)

4. Calculate OverhealAmount in OnParametersSet:
   - `OverhealAmount = Math.Max(0, (CurrentValue - PendingDamage + PendingHealing) - MaxValue)`
   - Only > 0 when temporary overheal exceeds pool maximum

5. Update OnParametersSet to call color calculation and assign result:
   - In OnParametersSet, after calculating effective value, add: `BarColorClass = GetBarColorClass();`
   - This wires the calculation method to the property used by the template

6. Modify HealingPercentage calculation to allow overheal visualization:
   - Current code: `Math.Min(healing, MaxValue - current)` caps healing
   - Change to: Cap the DISPLAY percentage at 100% total, but track overheal separately
   - The bar shouldn't extend beyond container, overheal shows via badge
  </action>
  <verify>
Build project: `dotnet build Threa/Threa.Client/Threa.Client.csproj`
Verify no compilation errors.
  </verify>
  <done>
PendingPoolBarBase has BarColorClass and OverhealAmount properties that update on parameter changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update PendingPoolBar.razor template with color classes and overheal badge</name>
  <files>Threa/Threa.Client/Components/Shared/PendingPoolBar.razor</files>
  <action>
Enhance the Razor template to use color thresholds and show overheal indicator:

1. Add CSS class binding to the base progress bar:
   - Change the first progress-bar div to include: `class="progress-bar @BarColorClass"`
   - The BarColorClass ("health-full", "health-mid", "health-low") gets styled via themes.css

2. Add inline style mapping for color classes that use theme variables:
   ```css
   .health-full { background-color: var(--color-health-full) !important; }
   .health-mid { background-color: var(--color-health-mid) !important; }
   .health-low { background-color: var(--color-health-low) !important; }
   ```
   Add this as a `<style>` block in the component OR add to app.css (prefer component-scoped)

3. Add overheal badge after the progress container when OverhealAmount > 0:
   ```html
   @if (OverhealAmount > 0)
   {
       <span class="badge bg-success ms-1" title="Temporary overheal">+@OverhealAmount</span>
   }
   ```

4. Wrap container in a flex layout to accommodate badge:
   - Add `d-flex align-items-center` wrapper if needed
   - Progress bar should flex-grow, badge sits to the right

5. Update the label to show overheal:
   - When OverhealAmount > 0, display: `{value + overheal}/{MaxValue} (+{overheal})`
  </action>
  <verify>
Build project: `dotnet build Threa/Threa.Client/Threa.Client.csproj`
Run app and test color thresholds manually:
1. Open GM Dashboard, click a character to open modal, go to GM Actions tab
2. Use the damage controls to apply FAT damage reducing the character's effective FAT to < 25% of max - verify bar shows red
3. Apply healing to bring FAT to 25-50% of max - verify bar shows yellow
4. Apply healing to bring FAT above 50% of max - verify bar shows green
5. Apply large healing that exceeds FAT max - verify overheal badge appears with +N value

Test real-time update propagation (HLTH-07):
6. Open two browser tabs: Tab A on GM Dashboard, Tab B on GM Dashboard (same table)
7. In Tab A, open character modal and apply FAT damage
8. Verify Tab B's dashboard shows the character's health bar color/badge update without manual refresh
9. This confirms PendingPoolBar responds correctly to TimeEventPublisher.PublishCharacterUpdateAsync messages
  </verify>
  <done>
PendingPoolBar displays color-coded health thresholds using theme CSS variables and shows +N overheal badge when applicable.
  </done>
</task>

</tasks>

<verification>
1. Build solution without errors: `dotnet build Threa.sln`
2. Run application and navigate to GM Dashboard
3. Open character modal for a character
4. Verify health bars show appropriate colors based on current pool percentage
5. Apply large healing via existing controls and verify overheal badge appears
6. Verify colors respect theme (switch between fantasy/sci-fi)
</verification>

<success_criteria>
- PendingPoolBar shows green/yellow/red based on effective health percentage
- Color thresholds: >50% green, 25-50% yellow, <25% red
- Overheal badge (+N) displays when healing exceeds maximum
- Colors use theme CSS variables (--color-health-full, --color-health-mid, --color-health-low)
- No regression to existing damage/healing visualization segments
</success_criteria>

<output>
After completion, create `.planning/phases/17-health-management/17-01-SUMMARY.md`
</output>
