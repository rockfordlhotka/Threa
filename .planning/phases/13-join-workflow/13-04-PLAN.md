---
phase: 13-join-workflow
plan: 04
type: execute
wave: 3
depends_on: ["13-02"]
files_modified:
  - Threa/Threa.Client/Components/Pages/GameMaster/Campaigns.razor
  - Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
autonomous: true

must_haves:
  truths:
    - "Campaigns.razor shows pending request count badge per campaign"
    - "GmTable.razor has 'Pending Join Requests' section when requests exist"
    - "GM can view full character details (sheet, inventory, narrative) for each request"
    - "GM can approve request with single click (character becomes active)"
    - "GM can deny request with single click (no confirmation per CONTEXT.md)"
    - "GM can remove active character from table with confirmation"
    - "Pending request badge updates after approve/deny"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/GameMaster/Campaigns.razor"
      provides: "Campaign list with pending badges"
      contains: "pending"
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor"
      provides: "Pending requests section and character removal"
      contains: "Pending Join Requests"
  key_links:
    - from: "GmTable.razor"
      to: "JoinRequestProcessor"
      via: "data portal execute"
      pattern: "JoinRequestProcessor"
    - from: "GmTable.razor"
      to: "JoinRequestList"
      via: "data portal fetch"
      pattern: "JoinRequestList"
---

<objective>
Add GM-facing UI for the join workflow: pending request count badges on campaign list, pending requests review section on campaign dashboard with approve/deny buttons, character detail expansion, and character removal with confirmation.

Purpose: Enable Game Masters to review join requests, see full character information before approving, manage table membership, and remove characters when needed.

Output: Updated Campaigns.razor with pending badges, updated GmTable.razor with pending requests section and character removal.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-join-workflow/13-CONTEXT.md
@.planning/phases/13-join-workflow/13-RESEARCH.md

Reference prior plans:
@.planning/phases/13-join-workflow/13-01-SUMMARY.md
@.planning/phases/13-join-workflow/13-02-SUMMARY.md

Key existing files:
@Threa/Threa.Client/Components/Pages/GameMaster/Campaigns.razor
@Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
@GameMechanics/CharacterEdit.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pending request badges to Campaigns.razor</name>
  <files>
    Threa/Threa.Client/Components/Pages/GameMaster/Campaigns.razor
  </files>
  <action>
Update Campaigns.razor to show pending request count badges:

1. Add inject for PendingRequestCountFetcher:
```csharp
@inject IDataPortal<GameMechanics.GamePlay.PendingRequestCountFetcher> pendingCountPortal
```

2. Add dictionary to store counts:
```csharp
private Dictionary<Guid, int> pendingCounts = new();
```

3. After loading tables in LoadTables(), fetch pending counts:
```csharp
// Load pending counts for each table
foreach (var table in tableList)
{
    try
    {
        var countFetcher = await pendingCountPortal.ExecuteAsync(table.Id);
        pendingCounts[table.Id] = countFetcher.Count;
    }
    catch
    {
        pendingCounts[table.Id] = 0;
    }
}
```

4. Update the table row to show badge after name:
```razor
<td class="fw-medium">
    @table.Name
    @if (GetPendingCount(table.Id) > 0)
    {
        <span class="badge bg-warning text-dark ms-2">
            <i class="bi bi-person-plus me-1"></i>@GetPendingCount(table.Id) pending
        </span>
    }
</td>
```

5. Add helper method:
```csharp
private int GetPendingCount(Guid tableId)
{
    return pendingCounts.TryGetValue(tableId, out var count) ? count : 0;
}
```
  </action>
  <verify>
`dotnet build Threa/Threa/Threa.csproj` succeeds
  </verify>
  <done>
Campaigns.razor shows pending request count badge next to each campaign name. Badge shows count and uses warning color with person-plus icon.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add pending requests section and character removal to GmTable.razor</name>
  <files>
    Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
  </files>
  <action>
Update GmTable.razor to add pending requests review section and character removal:

1. Add injects:
```csharp
@inject IDataPortal<GameMechanics.GamePlay.JoinRequestList> joinRequestListPortal
@inject IDataPortal<GameMechanics.GamePlay.JoinRequestProcessor> processorPortal
@inject IDataPortal<GameMechanics.GamePlay.TableCharacterDetacher> detacherPortal
```

2. Add state variables:
```csharp
private IEnumerable<GameMechanics.GamePlay.JoinRequestInfo>? pendingRequests;
private int? expandedCharacterId;
private GameMechanics.CharacterEdit? expandedCharacter;
private bool showRemoveConfirm;
private GameMechanics.GamePlay.TableCharacterInfo? characterToRemove;
private bool isProcessingRequest;
```

3. Add LoadPendingRequests method (call from LoadTable):
```csharp
private async Task LoadPendingRequests()
{
    try
    {
        var list = await joinRequestListPortal.FetchAsync(TableId);
        pendingRequests = list.AsEnumerable();
    }
    catch
    {
        pendingRequests = Enumerable.Empty<GameMechanics.GamePlay.JoinRequestInfo>();
    }
}
```

4. Call LoadPendingRequests() at end of LoadTable() method.

5. Add Pending Requests section in left panel, ABOVE "Characters at Table" card:
```razor
@if (pendingRequests != null && pendingRequests.Any())
{
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center bg-warning text-dark">
            <strong><i class="bi bi-person-plus me-1"></i>Pending Join Requests</strong>
            <span class="badge bg-dark">@pendingRequests.Count()</span>
        </div>
        <div class="card-body" style="max-height: 400px; overflow-y: auto;">
            @foreach (var request in pendingRequests)
            {
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <strong>@request.CharacterName</strong>
                                <small class="text-muted d-block">@request.Species</small>
                            </div>
                            <small class="text-muted">@request.RequestedAt.ToString("MMM d")</small>
                        </div>

                        @* Expandable character details *@
                        <div class="mb-2">
                            <button class="btn btn-sm btn-outline-secondary"
                                    @onclick="() => ToggleCharacterDetails(request.CharacterId)">
                                <i class="bi @(expandedCharacterId == request.CharacterId ? "bi-chevron-up" : "bi-eye")"></i>
                                @(expandedCharacterId == request.CharacterId ? "Hide Details" : "View Character")
                            </button>
                        </div>

                        @if (expandedCharacterId == request.CharacterId && expandedCharacter != null)
                        {
                            <div class="border rounded p-2 mb-2 bg-light" style="font-size: 0.85rem;">
                                <div class="row">
                                    <div class="col-6">
                                        <strong>Attributes:</strong>
                                        <ul class="list-unstyled mb-0 small">
                                            @foreach (var attr in expandedCharacter.Attributes)
                                            {
                                                <li>@attr.Name: @attr.Value</li>
                                            }
                                        </ul>
                                    </div>
                                    <div class="col-6">
                                        <strong>Health:</strong>
                                        <ul class="list-unstyled mb-0 small">
                                            <li>FAT: @expandedCharacter.Fatigue.Value / @expandedCharacter.Fatigue.BaseValue</li>
                                            <li>VIT: @expandedCharacter.Vitality.Value / @expandedCharacter.Vitality.BaseValue</li>
                                        </ul>
                                    </div>
                                </div>
                                @if (!string.IsNullOrWhiteSpace(expandedCharacter.Description))
                                {
                                    <div class="mt-2">
                                        <strong>Description:</strong>
                                        <p class="mb-0 small">@expandedCharacter.Description</p>
                                    </div>
                                }
                            </div>
                        }

                        <div class="d-flex gap-2">
                            <button class="btn btn-success btn-sm flex-grow-1"
                                    disabled="@isProcessingRequest"
                                    @onclick="() => ApproveRequest(request.Id)">
                                <i class="bi bi-check-lg"></i> Approve
                            </button>
                            <button class="btn btn-danger btn-sm flex-grow-1"
                                    disabled="@isProcessingRequest"
                                    @onclick="() => DenyRequest(request.Id)">
                                <i class="bi bi-x-lg"></i> Deny
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
}
```

6. Add request processing methods:
```csharp
private async Task ToggleCharacterDetails(int characterId)
{
    if (expandedCharacterId == characterId)
    {
        expandedCharacterId = null;
        expandedCharacter = null;
    }
    else
    {
        expandedCharacterId = characterId;
        try
        {
            expandedCharacter = await characterPortal.FetchAsync(characterId);
        }
        catch
        {
            expandedCharacter = null;
        }
    }
}

private async Task ApproveRequest(Guid requestId)
{
    if (table == null) return;
    isProcessingRequest = true;

    try
    {
        var gameMasterId = GetCurrentUserId();
        var result = await processorPortal.ExecuteAsync(requestId, true, gameMasterId);

        if (result.Success)
        {
            AddLogEntry($"Approved join request for {result.CharacterName}", ActivityCategory.Player);
            await LoadPendingRequests();
            var charList = await characterListPortal.FetchAsync(TableId);
            tableCharacters = charList.AsEnumerable();
        }
        else
        {
            errorMessage = result.ErrorMessage;
        }
    }
    catch (Exception ex)
    {
        errorMessage = $"Failed to approve: {ex.Message}";
    }
    finally
    {
        isProcessingRequest = false;
        expandedCharacterId = null;
        expandedCharacter = null;
    }
}

private async Task DenyRequest(Guid requestId)
{
    if (table == null) return;
    isProcessingRequest = true;

    try
    {
        var gameMasterId = GetCurrentUserId();
        var result = await processorPortal.ExecuteAsync(requestId, false, gameMasterId);

        if (result.Success)
        {
            AddLogEntry($"Denied join request for {result.CharacterName}", ActivityCategory.Player);
            await LoadPendingRequests();
        }
        else
        {
            errorMessage = result.ErrorMessage;
        }
    }
    catch (Exception ex)
    {
        errorMessage = $"Failed to deny: {ex.Message}";
    }
    finally
    {
        isProcessingRequest = false;
    }
}

private int GetCurrentUserId()
{
    var ci = (ClaimsIdentity?)Csla.ApplicationContext.User.Identity;
    return int.Parse(ci?.Claims.First(c => c.Type == ClaimTypes.NameIdentifier).Value ?? "0");
}
```
Add using for System.Security.Claims if not present.

7. Add character removal button to existing character cards (in the character card div, after Quick Heal/Damage buttons):
```razor
<button class="btn btn-sm btn-outline-danger w-100 mt-1"
        @onclick:stopPropagation="true"
        @onclick="() => ConfirmRemoveCharacter(character)">
    <i class="bi bi-x-circle"></i> Remove from Table
</button>
```

8. Add removal confirmation modal (place before closing </div> of main content):
```razor
@if (showRemoveConfirm && characterToRemove != null)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Remove Character</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CancelRemove"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to remove <strong>@characterToRemove.CharacterName</strong> from this table?</p>
                    <p class="text-muted small">The character will no longer be attached to this campaign and the player will need to submit a new join request to rejoin.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelRemove">Cancel</button>
                    <button type="button" class="btn btn-danger" @onclick="ExecuteRemoveCharacter">
                        <i class="bi bi-x-circle"></i> Remove
                    </button>
                </div>
            </div>
        </div>
    </div>
}
```

9. Add removal methods:
```csharp
private void ConfirmRemoveCharacter(GameMechanics.GamePlay.TableCharacterInfo character)
{
    characterToRemove = character;
    showRemoveConfirm = true;
}

private void CancelRemove()
{
    characterToRemove = null;
    showRemoveConfirm = false;
}

private async Task ExecuteRemoveCharacter()
{
    if (characterToRemove == null || table == null) return;

    try
    {
        var result = await detacherPortal.ExecuteAsync(characterToRemove.CharacterId, TableId);

        if (result.Success)
        {
            AddLogEntry($"Removed {characterToRemove.CharacterName} from table", ActivityCategory.Player);
            var charList = await characterListPortal.FetchAsync(TableId);
            tableCharacters = charList.AsEnumerable();

            if (selectedCharacter?.CharacterId == characterToRemove.CharacterId)
            {
                selectedCharacter = null;
            }
        }
        else
        {
            errorMessage = result.ErrorMessage;
        }
    }
    catch (Exception ex)
    {
        errorMessage = $"Failed to remove character: {ex.Message}";
    }
    finally
    {
        characterToRemove = null;
        showRemoveConfirm = false;
    }
}
```
  </action>
  <verify>
`dotnet build Threa/Threa/Threa.csproj` succeeds
  </verify>
  <done>
GmTable.razor has Pending Join Requests section above Characters at Table. Expand button shows character sheet/inventory/narrative. Approve attaches character to table. Deny deletes request (no confirmation). Character removal has confirmation modal.
  </done>
</task>

</tasks>

<verification>
- `dotnet build Threa.sln` completes without errors
- Campaigns.razor shows pending count badge per campaign
- GmTable.razor shows Pending Join Requests section when requests exist
- Character details expandable in pending request cards
- Approve button attaches character and refreshes lists
- Deny button removes request (no confirmation)
- Character removal has confirmation modal
- Lists refresh after approve/deny/remove actions
</verification>

<success_criteria>
- GM sees pending request count on campaign list
- Pending requests section visible in campaign dashboard
- Full character details available before approval decision
- Single-click approve/deny (deny has no confirmation per CONTEXT.md)
- Character removal requires confirmation
- All actions update UI immediately
- Activity log captures join/remove events
</success_criteria>

<output>
After completion, create `.planning/phases/13-join-workflow/13-04-SUMMARY.md`
</output>
