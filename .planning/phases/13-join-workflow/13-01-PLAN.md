---
phase: 13-join-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Threa.Dal/Dto/GameTable.cs
  - Threa.Dal/Dto/JoinRequest.cs
  - Threa.Dal/IJoinRequestDal.cs
  - Threa.Dal.MockDb/JoinRequestDal.cs
  - Threa.Dal.MockDb/MockDb.cs
  - Threa.Dal.MockDb/ServiceCollectionExtensions.cs
  - GameMechanics/GamePlay/TableEdit.cs
  - GameMechanics/GamePlay/TableInfo.cs
  - GameMechanics/Messaging/TimeMessages.cs
  - GameMechanics/Messaging/ITimeEventPublisher.cs
  - GameMechanics.Messaging.InMemory/TimeEventPublisher.cs
  - Threa/Threa.Client/Components/Pages/GameMaster/CampaignCreate.razor
autonomous: true

must_haves:
  truths:
    - "JoinRequest DTO exists with status enum (Pending, Approved, Denied)"
    - "IJoinRequestDal interface defines all required CRUD operations"
    - "JoinRequestDal MockDb implementation stores and retrieves requests"
    - "GameTable DTO has Description property"
    - "TableEdit and TableInfo CSLA objects expose Description"
    - "CampaignCreate.razor includes required description textarea"
    - "JoinRequestMessage message type exists for notifications"
    - "ITimeEventPublisher has method to publish join request notifications"
  artifacts:
    - path: "Threa.Dal/Dto/JoinRequest.cs"
      provides: "JoinRequest DTO and JoinRequestStatus enum"
      contains: "public enum JoinRequestStatus"
    - path: "Threa.Dal/IJoinRequestDal.cs"
      provides: "DAL interface for join requests"
      exports: ["IJoinRequestDal"]
    - path: "Threa.Dal.MockDb/JoinRequestDal.cs"
      provides: "In-memory implementation"
      contains: "class JoinRequestDal : IJoinRequestDal"
  key_links:
    - from: "Threa.Dal.MockDb/JoinRequestDal.cs"
      to: "IJoinRequestDal"
      via: "interface implementation"
      pattern: "IJoinRequestDal"
    - from: "GameMechanics/GamePlay/TableEdit.cs"
      to: "GameTable.Description"
      via: "MapFromDto/MapToDto"
      pattern: "Description"
---

<objective>
Create the data layer foundation for the join workflow: JoinRequest DTO with status tracking, DAL interface and MockDb implementation, Description field for campaigns, and messaging infrastructure for join request notifications.

Purpose: Establish the data model and persistence layer that all subsequent join workflow business logic and UI will depend on.

Output: JoinRequest.cs DTO, IJoinRequestDal.cs interface, JoinRequestDal.cs MockDb implementation, extended GameTable with Description, JoinRequestMessage for notifications.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-join-workflow/13-CONTEXT.md
@.planning/phases/13-join-workflow/13-RESEARCH.md

Key existing files to reference:
@Threa.Dal/Dto/GameTable.cs
@Threa.Dal/ITableDal.cs
@Threa.Dal.MockDb/TableDal.cs
@GameMechanics/GamePlay/TableEdit.cs
@GameMechanics/GamePlay/TableInfo.cs
@GameMechanics/Messaging/TimeMessages.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create JoinRequest DTO and extend GameTable with Description</name>
  <files>
    Threa.Dal/Dto/JoinRequest.cs
    Threa.Dal/Dto/GameTable.cs
  </files>
  <action>
Create new JoinRequest.cs in Threa.Dal/Dto:
```csharp
public class JoinRequest
{
    public Guid Id { get; set; }
    public int CharacterId { get; set; }
    public Guid TableId { get; set; }
    public int PlayerId { get; set; }
    public JoinRequestStatus Status { get; set; }
    public DateTime RequestedAt { get; set; }
    public DateTime? ProcessedAt { get; set; }
    public string? DenialReason { get; set; }
}

public enum JoinRequestStatus
{
    Pending = 0,
    Approved = 1,
    Denied = 2
}
```

Add Description property to GameTable.cs:
```csharp
/// <summary>
/// Description of the campaign for players browsing.
/// </summary>
public string Description { get; set; } = string.Empty;
```

Place Description after Theme property for logical grouping.
  </action>
  <verify>
`dotnet build Threa.Dal/Threa.Dal.csproj` succeeds
  </verify>
  <done>
JoinRequest.cs exists with Id, CharacterId, TableId, PlayerId, Status, RequestedAt, ProcessedAt, DenialReason properties. JoinRequestStatus enum has Pending=0, Approved=1, Denied=2. GameTable.cs has Description property.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create IJoinRequestDal interface and MockDb implementation</name>
  <files>
    Threa.Dal/IJoinRequestDal.cs
    Threa.Dal.MockDb/JoinRequestDal.cs
    Threa.Dal.MockDb/MockDb.cs
    Threa.Dal.MockDb/ServiceCollectionExtensions.cs
  </files>
  <action>
Create IJoinRequestDal.cs in Threa.Dal (follow ITableDal.cs pattern):
```csharp
public interface IJoinRequestDal
{
    JoinRequest GetBlank();
    Task<List<JoinRequest>> GetRequestsByPlayerAsync(int playerId);
    Task<List<JoinRequest>> GetPendingRequestsForTableAsync(Guid tableId);
    Task<JoinRequest?> GetPendingRequestAsync(int characterId, Guid tableId);
    Task<JoinRequest?> GetRequestAsync(Guid id);
    Task<JoinRequest> SaveRequestAsync(JoinRequest request);
    Task DeleteRequestAsync(Guid id);
    Task<int> GetPendingCountForTableAsync(Guid tableId);
    Task DeleteRequestsByCharacterAsync(int characterId);
}
```

Create JoinRequestDal.cs in Threa.Dal.MockDb (follow TableDal.cs pattern):
- GetBlank: return new JoinRequest with new Guid, RequestedAt = UtcNow, Status = Pending
- GetRequestsByPlayerAsync: filter MockDb.JoinRequests by playerId, exclude Denied status
- GetPendingRequestsForTableAsync: filter by tableId AND Status == Pending
- GetPendingRequestAsync: find by characterId AND tableId AND Status == Pending
- GetRequestAsync: find by Id
- SaveRequestAsync: insert or update in MockDb.JoinRequests
- DeleteRequestAsync: remove by Id
- GetPendingCountForTableAsync: count where tableId AND Status == Pending
- DeleteRequestsByCharacterAsync: remove all by characterId (for cleanup)

Add to MockDb.cs:
```csharp
public static List<JoinRequest> JoinRequests { get; } = [];
```

Register IJoinRequestDal in ServiceCollectionExtensions.cs:
```csharp
services.AddTransient<IJoinRequestDal, JoinRequestDal>();
```
  </action>
  <verify>
`dotnet build Threa.Dal.MockDb/Threa.Dal.MockDb.csproj` succeeds
  </verify>
  <done>
IJoinRequestDal interface defines all methods. JoinRequestDal implements all methods using MockDb.JoinRequests list. MockDb has JoinRequests static list. Service is registered in DI.
  </done>
</task>

<task type="auto">
  <name>Task 3: Extend TableEdit and TableInfo with Description, add JoinRequestMessage</name>
  <files>
    GameMechanics/GamePlay/TableEdit.cs
    GameMechanics/GamePlay/TableInfo.cs
    GameMechanics/Messaging/TimeMessages.cs
    GameMechanics/Messaging/ITimeEventPublisher.cs
    GameMechanics.Messaging.InMemory/TimeEventPublisher.cs
    Threa/Threa.Client/Components/Pages/GameMaster/CampaignCreate.razor
  </files>
  <action>
Add Description property to TableEdit.cs (follow Theme property pattern):
```csharp
public static readonly PropertyInfo<string> DescriptionProperty = RegisterProperty<string>(nameof(Description));
/// <summary>
/// Description of the campaign for players browsing.
/// </summary>
public string Description
{
    get => GetProperty(DescriptionProperty);
    set => SetProperty(DescriptionProperty, value);
}
```
Update MapFromDto: `Description = dto.Description;`
Update MapToDto: `dto.Description = Description;`
Initialize in Create method: `Description = string.Empty;`

Add Description property to TableInfo.cs (follow Theme property pattern):
```csharp
public static readonly PropertyInfo<string> DescriptionProperty = RegisterProperty<string>(nameof(Description));
public string Description
{
    get => GetProperty(DescriptionProperty);
    private set => LoadProperty(DescriptionProperty, value);
}
```
Update FetchChild: `Description = table.Description;`

Add JoinRequestMessage to TimeMessages.cs:
```csharp
/// <summary>
/// Message sent when a join request status changes.
/// </summary>
public class JoinRequestMessage : TimeMessageBase
{
    public Guid RequestId { get; init; }
    public int CharacterId { get; init; }
    public int PlayerId { get; init; }
    public Guid TableId { get; init; }
    public JoinRequestStatus Status { get; init; }
    public string? CharacterName { get; init; }
    public string? TableName { get; init; }
}
```
Add using for Threa.Dal.Dto at top of file.

Add to ITimeEventPublisher.cs:
```csharp
Task PublishJoinRequestAsync(JoinRequestMessage message);
```

Implement in TimeEventPublisher.cs (follow PublishCharacterUpdateAsync pattern):
```csharp
public Task PublishJoinRequestAsync(JoinRequestMessage message)
{
    _joinRequestSubject.OnNext(message);
    return Task.CompletedTask;
}
```
Add Subject and expose via interface if needed for subscription.

Update CampaignCreate.razor to add required description field:
- Add `private string campaignDescription = "";` field
- Add textarea input after Campaign Name:
```razor
<div class="mb-3">
    <label class="form-label">Description <span class="text-danger">*</span></label>
    <textarea class="form-control @(showDescriptionError ? "is-invalid" : "")"
              @bind="campaignDescription" @bind:event="oninput"
              rows="3"
              placeholder="Describe your campaign for potential players..."></textarea>
    @if (showDescriptionError)
    {
        <div class="invalid-feedback">Description is required.</div>
    }
</div>
```
- Add validation: `private bool showDescriptionError => hasInteracted && string.IsNullOrWhiteSpace(campaignDescription);`
- Update CreateCampaign method: add `newTable.Description = campaignDescription.Trim();` before save
- Update disabled condition on Create button to include description validation
  </action>
  <verify>
`dotnet build Threa.sln` succeeds
  </verify>
  <done>
TableEdit and TableInfo have Description property with proper CSLA pattern and DTO mapping. JoinRequestMessage exists in TimeMessages.cs. ITimeEventPublisher has PublishJoinRequestAsync method. TimeEventPublisher implements the method. CampaignCreate.razor has required description textarea that saves to table.
  </done>
</task>

</tasks>

<verification>
- `dotnet build Threa.sln` completes without errors
- JoinRequest.cs exists in Threa.Dal/Dto with all properties
- JoinRequestStatus enum has Pending, Approved, Denied values
- IJoinRequestDal.cs exists with all method signatures
- JoinRequestDal.cs implements all interface methods
- TableEdit.cs and TableInfo.cs have Description property
- TimeMessages.cs contains JoinRequestMessage class
- ITimeEventPublisher.cs has PublishJoinRequestAsync method
- CampaignCreate.razor has description textarea with validation
</verification>

<success_criteria>
- All DTOs compile and are accessible from dependent projects
- DAL interface and implementation are registered in DI
- CSLA business objects properly map Description field
- Messaging infrastructure ready for join request notifications
- Campaign creation requires description before saving
</success_criteria>

<output>
After completion, create `.planning/phases/13-join-workflow/13-01-SUMMARY.md`
</output>
