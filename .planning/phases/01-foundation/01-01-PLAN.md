---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - GameMechanics/Items/ItemTemplateEdit.cs
  - GameMechanics.Test/ItemTemplateTests.cs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "ItemTemplateEdit validates Name is required"
    - "ItemTemplateEdit validates ItemType is required"
    - "ItemTemplateEdit validates Weight >= 0"
    - "ItemTemplateEdit validates Volume >= 0"
    - "ItemTemplateEdit validates container capacity when IsContainer is true"
    - "Unit tests verify validation rules fire correctly"
  artifacts:
    - path: "GameMechanics/Items/ItemTemplateEdit.cs"
      provides: "AddBusinessRules() method with validation rules"
      contains: "AddBusinessRules"
    - path: "GameMechanics.Test/ItemTemplateTests.cs"
      provides: "Unit tests for ItemTemplateEdit CRUD and validation"
      min_lines: 80
  key_links:
    - from: "GameMechanics.Test/ItemTemplateTests.cs"
      to: "GameMechanics/Items/ItemTemplateEdit.cs"
      via: "IDataPortal<ItemTemplateEdit>"
      pattern: "IDataPortal<ItemTemplateEdit>"
---

<objective>
Add validation rules to ItemTemplateEdit and create comprehensive unit tests for ItemTemplate business object operations.

Purpose: ItemTemplateEdit already has full CRUD operations but lacks validation rules. Adding validation ensures data integrity and enables testing the existing CRUD functionality.
Output: ItemTemplateEdit with AddBusinessRules() method, plus ItemTemplateTests.cs with CRUD and validation tests.
</objective>

<execution_context>
@S:\src\rdl\threa\.claude\get-shit-done\workflows\execute-plan.md
@S:\src\rdl\threa\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@S:\src\rdl\threa\.planning\PROJECT.md
@S:\src\rdl\threa\.planning\ROADMAP.md
@S:\src\rdl\threa\.planning\STATE.md
@S:\src\rdl\threa\.planning\phases\01-foundation\01-CONTEXT.md
@S:\src\rdl\threa\.planning\phases\01-foundation\01-RESEARCH.md

<!-- Reference files -->
@S:\src\rdl\threa\GameMechanics\Items\ItemTemplateEdit.cs
@S:\src\rdl\threa\GameMechanics\Skills\SkillDefinitionEdit.cs
@S:\src\rdl\threa\GameMechanics.Test\CharacterSaveLoadTest.cs
@S:\src\rdl\threa\Threa.Dal\Dto\ItemTemplate.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add validation rules to ItemTemplateEdit</name>
  <files>GameMechanics/Items/ItemTemplateEdit.cs</files>
  <action>
Add AddBusinessRules() override method to ItemTemplateEdit following the pattern from SkillDefinitionEdit.cs:

1. Override AddBusinessRules() and call base.AddBusinessRules()

2. Add required field validation:
   - Name: Required, use Csla.Rules.CommonRules.Required
   - ItemType: Required (non-default value)

3. Add numeric range validation:
   - Weight >= 0 (use Csla.Rules.CommonRules.MinValue)
   - Volume >= 0 (use Csla.Rules.CommonRules.MinValue)
   - MaxStackSize >= 1 when IsStackable is true

4. Add container validation (warning, not error):
   - When IsContainer is true, ContainerMaxWeight and ContainerMaxVolume should be > 0
   - Use Csla.Rules.CommonRules or create a simple custom rule if needed

Per CONTEXT.md decisions:
- Required properties: Name and ItemType only
- Weight/Volume bounds: Non-negative (>= 0)
- Container capacity: Warning not error

Use existing CSLA 9.x patterns - BusinessRules.AddRule() with CommonRules where possible.
  </action>
  <verify>
Build succeeds: `dotnet build S:\src\rdl\threa\GameMechanics\GameMechanics.csproj`
  </verify>
  <done>
ItemTemplateEdit.cs contains AddBusinessRules() method with validation for Name (required), ItemType (required), Weight (>= 0), Volume (>= 0), and container properties (warning).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create unit tests for ItemTemplateEdit</name>
  <files>GameMechanics.Test/ItemTemplateTests.cs</files>
  <action>
Create new test file GameMechanics.Test/ItemTemplateTests.cs following the pattern from CharacterSaveLoadTest.cs:

1. Test class setup:
   - [TestClass] attribute
   - InitServices() method using AddCsla() and AddMockDb()
   - Get IDataPortal<ItemTemplateEdit> from service provider

2. CRUD tests:
   - ItemTemplateEdit_Create_InitializesDefaults: Verify Create() sets expected defaults
   - ItemTemplateEdit_Fetch_LoadsExistingTemplate: Fetch template Id=10 (Longsword), verify Name and properties
   - ItemTemplateEdit_SaveAndFetch_PropertiesPersist: Create new template, save, fetch by Id, verify all properties match
   - ItemTemplateEdit_Update_ChangesPersist: Fetch existing, modify Name, save, fetch again, verify change

3. Validation tests:
   - ItemTemplateEdit_Validation_NameRequired: Create template, leave Name empty, verify IsSavable is false and BrokenRulesCollection contains Name rule
   - ItemTemplateEdit_Validation_WeightNonNegative: Set Weight to -1, verify validation failure
   - ItemTemplateEdit_Validation_VolumeNonNegative: Set Volume to -1, verify validation failure
   - ItemTemplateEdit_Validation_ValidTemplateIsSavable: Create template, set Name and required fields, verify IsSavable is true

Test naming convention: MethodName_Scenario_ExpectedResult
Use Assert methods from MSTest (Assert.AreEqual, Assert.IsTrue, Assert.IsFalse, Assert.IsNotNull)
  </action>
  <verify>
All tests pass: `dotnet test S:\src\rdl\threa\GameMechanics.Test\GameMechanics.Test.csproj --filter "FullyQualifiedName~ItemTemplateTests"`
  </verify>
  <done>
ItemTemplateTests.cs exists with 8+ tests covering CRUD operations and validation rules. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build S:\src\rdl\threa\Threa.sln` - Solution builds without errors
2. `dotnet test S:\src\rdl\threa\GameMechanics.Test\GameMechanics.Test.csproj --filter "FullyQualifiedName~ItemTemplateTests"` - All ItemTemplate tests pass
3. ItemTemplateEdit.cs contains AddBusinessRules() method
</verification>

<success_criteria>
1. ItemTemplateEdit has AddBusinessRules() with validation for Name (required), Weight (>= 0), Volume (>= 0)
2. ItemTemplateTests.cs has 8+ tests covering CRUD and validation
3. All tests pass
4. Solution builds cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
