---
phase: 25-npc-creation-dashboard
plan: 05
type: execute
wave: 3
depends_on: ["25-01", "25-03"]
files_modified:
  - Threa/Threa.Client/Components/Shared/NpcStatusCard.razor
  - Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
  - Threa/Threa/wwwroot/app.css
autonomous: true

must_haves:
  truths:
    - "NPCs appear in GM dashboard in separate section below PCs"
    - "NPC section groups by disposition (Hostile, Neutral, Friendly)"
    - "Empty disposition groups are hidden"
    - "NPC status cards show disposition icon and template label"
  artifacts:
    - path: "Threa/Threa.Client/Components/Shared/NpcStatusCard.razor"
      provides: "NPC-specific status card wrapper"
      contains: "disposition"
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor"
      provides: "NPC section replacing NpcPlaceholder"
      contains: "hostileNpcs"
  key_links:
    - from: "GmTable.razor"
      to: "TableCharacterInfo.IsNpc"
      via: "Filter tableCharacters by IsNpc"
      pattern: "Where.*IsNpc"
    - from: "NpcStatusCard.razor"
      to: "CharacterStatusCard"
      via: "Wraps existing card with disposition overlay"
      pattern: "CharacterStatusCard"
---

<objective>
Create NPC section in GM dashboard (GmTable.razor) with disposition-based grouping and NPC status cards showing disposition icons.

Purpose: Per CONTEXT.md, NPCs appear in a separate section BELOW PCs with clear header, grouped by disposition (Hostile, Neutral, Friendly). Empty groups are hidden. This implements DASH-01, DASH-02, and DASH-04.

Output: Working NPC section in GM dashboard with disposition grouping.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-npc-creation-dashboard/25-CONTEXT.md
@.planning/phases/25-npc-creation-dashboard/25-RESEARCH.md
@.planning/phases/25-npc-creation-dashboard/25-01-SUMMARY.md

# Existing patterns
@Threa/Threa.Client/Components/Shared/CharacterStatusCard.razor
@Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NpcStatusCard wrapper component</name>
  <files>Threa/Threa.Client/Components/Shared/NpcStatusCard.razor</files>
  <action>
Create new file `Threa/Threa.Client/Components/Shared/NpcStatusCard.razor`:

```razor
@namespace Threa.Client.Components.Shared

@using GameMechanics.GamePlay
@using Threa.Dal.Dto

<div class="npc-status-card position-relative">
    @* Disposition Icon - Top Right Corner *@
    <div class="position-absolute npc-disposition-icon" style="top: 4px; right: 8px; z-index: 1;">
        @switch (Character.Disposition)
        {
            case NpcDisposition.Hostile:
                <i class="bi bi-skull text-danger" title="Hostile"></i>
                break;
            case NpcDisposition.Neutral:
                <i class="bi bi-circle text-secondary" title="Neutral"></i>
                break;
            case NpcDisposition.Friendly:
                <i class="bi bi-heart text-success" title="Friendly"></i>
                break;
        }
    </div>

    @* Reuse existing CharacterStatusCard *@
    <CharacterStatusCard Character="@Character"
                         IsSelected="@IsSelected"
                         OnClick="@OnClick" />

    @* Template Label - Below Card *@
    @if (!string.IsNullOrEmpty(Character.SourceTemplateName))
    {
        <div class="npc-template-label text-center">
            <small class="text-muted" style="font-size: 0.7rem;">
                From: @Character.SourceTemplateName
            </small>
        </div>
    }
</div>

@code {
    [Parameter, EditorRequired]
    public TableCharacterInfo Character { get; set; } = null!;

    [Parameter]
    public bool IsSelected { get; set; }

    [Parameter]
    public EventCallback<TableCharacterInfo> OnClick { get; set; }
}
```

This wrapper:
- Uses CharacterStatusCard for consistent display (DASH-02)
- Adds disposition icon overlay (DASH-04) - icon only, no text per CONTEXT.md
- Shows source template label below card per CONTEXT.md
  </action>
  <verify>
    Run: `dotnet build Threa/Threa.Client/Threa.Client.csproj`
    Expect: Build succeeds
  </verify>
  <done>
    NpcStatusCard.razor wraps CharacterStatusCard with disposition icon and template label.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace NpcPlaceholder with NPC section in GmTable.razor</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor</files>
  <action>
Modify GmTable.razor to display NPCs in disposition groups:

1. Add using statement at top:
```razor
@using Threa.Dal.Dto
```

2. In @code section, add computed properties for NPC filtering (after tableCharacters declaration):
```csharp
// NPC filtering - PCs are !IsNpc, NPCs are IsNpc
private IEnumerable<GameMechanics.GamePlay.TableCharacterInfo> playerCharacters =>
    tableCharacters?.Where(c => !c.IsNpc) ?? Enumerable.Empty<GameMechanics.GamePlay.TableCharacterInfo>();

private IEnumerable<GameMechanics.GamePlay.TableCharacterInfo> tableNpcs =>
    tableCharacters?.Where(c => c.IsNpc) ?? Enumerable.Empty<GameMechanics.GamePlay.TableCharacterInfo>();

private IEnumerable<GameMechanics.GamePlay.TableCharacterInfo> hostileNpcs =>
    tableNpcs.Where(c => c.Disposition == NpcDisposition.Hostile);

private IEnumerable<GameMechanics.GamePlay.TableCharacterInfo> neutralNpcs =>
    tableNpcs.Where(c => c.Disposition == NpcDisposition.Neutral);

private IEnumerable<GameMechanics.GamePlay.TableCharacterInfo> friendlyNpcs =>
    tableNpcs.Where(c => c.Disposition == NpcDisposition.Friendly);
```

3. Update the Characters at Table card to use playerCharacters instead of tableCharacters:
   - Change line `@foreach (var character in tableCharacters)` to `@foreach (var character in playerCharacters)`
   - Change line `@(tableCharacters?.Count() ?? 0)` in badge to `@playerCharacters.Count()`
   - Keep the empty state check using `tableCharacters` but change `!tableCharacters.Any()` to `!playerCharacters.Any()`

4. Replace `<NpcPlaceholder />` (around line 187) with the NPC section:
```razor
@* NPC Section - Below Characters *@
<div class="card mt-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <strong><i class="bi bi-people me-1"></i>NPCs</strong>
        <span class="badge bg-secondary">@tableNpcs.Count()</span>
    </div>
    <div class="card-body" style="max-height: 500px; overflow-y: auto;">
        @if (!tableNpcs.Any())
        {
            <div class="text-center text-muted py-3">
                <i class="bi bi-person-badge fs-3 opacity-50 d-block mb-2"></i>
                No NPCs at this table. Spawn from templates to begin.
            </div>
        }
        else
        {
            @* Hostile Group - Red Header *@
            @if (hostileNpcs.Any())
            {
                <div class="npc-group mb-3">
                    <h6 class="npc-group-header text-danger mb-2">
                        <i class="bi bi-skull-crossbones me-1"></i>Hostile (@hostileNpcs.Count())
                    </h6>
                    <div class="row row-cols-1 row-cols-lg-2 g-2">
                        @foreach (var npc in hostileNpcs)
                        {
                            <div class="col" @key="@($"npc-{npc.CharacterId}-{characterListVersion}")">
                                <NpcStatusCard Character="@npc"
                                              IsSelected="@(selectedCharacter?.CharacterId == npc.CharacterId)"
                                              OnClick="OpenCharacterDetails" />
                            </div>
                        }
                    </div>
                </div>
            }

            @* Neutral Group - Gray Header *@
            @if (neutralNpcs.Any())
            {
                <div class="npc-group mb-3">
                    <h6 class="npc-group-header text-secondary mb-2">
                        <i class="bi bi-circle me-1"></i>Neutral (@neutralNpcs.Count())
                    </h6>
                    <div class="row row-cols-1 row-cols-lg-2 g-2">
                        @foreach (var npc in neutralNpcs)
                        {
                            <div class="col" @key="@($"npc-{npc.CharacterId}-{characterListVersion}")">
                                <NpcStatusCard Character="@npc"
                                              IsSelected="@(selectedCharacter?.CharacterId == npc.CharacterId)"
                                              OnClick="OpenCharacterDetails" />
                            </div>
                        }
                    </div>
                </div>
            }

            @* Friendly Group - Green Header *@
            @if (friendlyNpcs.Any())
            {
                <div class="npc-group mb-3">
                    <h6 class="npc-group-header text-success mb-2">
                        <i class="bi bi-heart me-1"></i>Friendly (@friendlyNpcs.Count())
                    </h6>
                    <div class="row row-cols-1 row-cols-lg-2 g-2">
                        @foreach (var npc in friendlyNpcs)
                        {
                            <div class="col" @key="@($"npc-{npc.CharacterId}-{characterListVersion}")">
                                <NpcStatusCard Character="@npc"
                                              IsSelected="@(selectedCharacter?.CharacterId == npc.CharacterId)"
                                              OnClick="OpenCharacterDetails" />
                            </div>
                        }
                    </div>
                </div>
            }
        }
    </div>
</div>
```

5. Add the NpcStatusCard using statement if not auto-detected:
```razor
@using Threa.Client.Components.Shared
```

Note: NPC status cards use the existing OpenCharacterDetails method which opens CharacterDetailModal - this satisfies DASH-03 (same manipulation powers as PCs).
  </action>
  <verify>
    Run: `dotnet build Threa/Threa.Client/Threa.Client.csproj`
    Expect: Build succeeds
  </verify>
  <done>
    GmTable.razor has NPC section with disposition grouping.
    Empty disposition groups are hidden.
    NPC cards use NpcStatusCard wrapper.
    Clicking NPC opens CharacterDetailModal.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add NPC section CSS styles</name>
  <files>Threa/Threa/wwwroot/app.css</files>
  <action>
Add CSS for NPC section styling in app.css (after existing styles):

```css
/* NPC Section Styles */
.npc-status-card {
    /* Wrapper for NPC card with disposition overlay */
}

.npc-disposition-icon {
    font-size: 0.9rem;
    opacity: 0.9;
}

.npc-template-label {
    margin-top: -4px;
    padding-bottom: 4px;
}

.npc-group-header {
    font-size: 0.9rem;
    font-weight: 600;
    padding-bottom: 4px;
    border-bottom: 1px solid currentColor;
    opacity: 0.8;
}

.npc-group:last-child {
    margin-bottom: 0 !important;
}
```

These styles:
- Position disposition icon cleanly
- Style template label below card
- Create visual separation between disposition groups
  </action>
  <verify>
    Run: `dotnet build Threa/Threa/Threa.csproj`
    Expect: Build succeeds
  </verify>
  <done>
    CSS styles added for NPC section and disposition groups.
  </done>
</task>

</tasks>

<verification>
1. `NpcStatusCard.razor` exists with disposition icon and template label
2. `GmTable.razor` has NPC section below Characters section
3. NPC section groups by disposition (Hostile, Neutral, Friendly)
4. Empty disposition groups are hidden
5. Clicking NPC opens CharacterDetailModal
6. CSS provides visual styling for NPC section
7. Solution builds successfully
</verification>

<success_criteria>
- NPCs appear in separate section from PCs (DASH-01)
- NPC cards show same info as PC cards via CharacterStatusCard reuse (DASH-02)
- Clicking NPC opens same CharacterDetailModal as PCs (DASH-03)
- NPCs display disposition icons (DASH-04)
- Disposition grouping hides empty groups
- Template label shows source template name
</success_criteria>

<output>
After completion, create `.planning/phases/25-npc-creation-dashboard/25-05-SUMMARY.md`
</output>
