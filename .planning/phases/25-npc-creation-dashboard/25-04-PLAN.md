---
phase: 25-npc-creation-dashboard
plan: 04
type: execute
wave: 3
depends_on: ["25-02", "25-03"]
files_modified:
  - Threa/Threa.Client/Components/Shared/NpcSpawnModal.razor
  - Threa/Threa.Client/Components/Pages/GameMaster/NpcTemplates.razor
autonomous: true

must_haves:
  truths:
    - "GM can open spawn modal from template library"
    - "Spawn modal shows auto-generated name, editable by GM"
    - "Spawn modal allows disposition override"
    - "Spawn modal allows session notes entry"
  artifacts:
    - path: "Threa/Threa.Client/Components/Shared/NpcSpawnModal.razor"
      provides: "Modal for NPC spawn customization"
      contains: "NpcSpawnModal"
    - path: "Threa/Threa.Client/Components/Pages/GameMaster/NpcTemplates.razor"
      provides: "Spawn button per template row"
      contains: "ShowSpawnModal"
  key_links:
    - from: "NpcTemplates.razor"
      to: "NpcSpawnModal"
      via: "showSpawnModal state triggers modal render"
      pattern: "showSpawnModal"
---

<objective>
Create NpcSpawnModal component and integrate spawn button into NpcTemplates.razor template library page.

Purpose: Per CONTEXT.md, spawn opens a "quick modal" (not immediate spawn) that allows GM to customize name, disposition, and session notes before spawning. This plan implements the modal and template library integration.

Output: Working spawn workflow from template library page.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-npc-creation-dashboard/25-CONTEXT.md
@.planning/phases/25-npc-creation-dashboard/25-RESEARCH.md
@.planning/phases/25-npc-creation-dashboard/25-02-SUMMARY.md
@.planning/phases/25-npc-creation-dashboard/25-03-SUMMARY.md

# Existing UI patterns
@Threa/Threa.Client/Components/Pages/GameMaster/NpcTemplates.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NpcSpawnModal component</name>
  <files>Threa/Threa.Client/Components/Shared/NpcSpawnModal.razor</files>
  <action>
Create new file `Threa/Threa.Client/Components/Shared/NpcSpawnModal.razor`:

```razor
@namespace Threa.Client.Components.Shared

@using Threa.Dal.Dto

<div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-person-plus me-2"></i>Spawn NPC: @TemplateName
                </h5>
                <button type="button" class="btn-close" @onclick="Cancel" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-control" @bind="npcName" @bind:event="oninput" />
                    <small class="text-muted">Auto-generated. Edit to customize.</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Disposition</label>
                    <select class="form-select" @bind="disposition">
                        <option value="@NpcDisposition.Hostile">
                            <i class="bi bi-skull"></i> Hostile
                        </option>
                        <option value="@NpcDisposition.Neutral">
                            <i class="bi bi-circle"></i> Neutral
                        </option>
                        <option value="@NpcDisposition.Friendly">
                            <i class="bi bi-heart"></i> Friendly
                        </option>
                    </select>
                    <small class="text-muted">Override template default (@DefaultDisposition).</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Session Notes <span class="text-muted">(optional)</span></label>
                    <textarea class="form-control" rows="3" @bind="sessionNotes"
                        placeholder="Notes about this specific NPC instance..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="Cancel">
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" @onclick="Spawn"
                    disabled="@(string.IsNullOrWhiteSpace(npcName) || isSpawning)">
                    @if (isSpawning)
                    {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                        <span>Spawning...</span>
                    }
                    else
                    {
                        <i class="bi bi-plus-lg me-1"></i>
                        <span>Spawn</span>
                    }
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public int TemplateId { get; set; }
    [Parameter] public string TemplateName { get; set; } = "";
    [Parameter] public NpcDisposition DefaultDisposition { get; set; }
    [Parameter] public string AutoGeneratedName { get; set; } = "";
    [Parameter] public EventCallback<NpcSpawnRequest> OnSpawn { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    private string npcName = "";
    private NpcDisposition disposition;
    private string sessionNotes = "";
    private bool isSpawning;

    protected override void OnParametersSet()
    {
        npcName = AutoGeneratedName;
        disposition = DefaultDisposition;
    }

    private async Task Spawn()
    {
        if (string.IsNullOrWhiteSpace(npcName)) return;

        isSpawning = true;
        StateHasChanged();

        await OnSpawn.InvokeAsync(new NpcSpawnRequest
        {
            TemplateId = TemplateId,
            Name = npcName.Trim(),
            Disposition = disposition,
            SessionNotes = string.IsNullOrWhiteSpace(sessionNotes) ? null : sessionNotes.Trim()
        });

        isSpawning = false;
    }

    private async Task Cancel() => await OnCancel.InvokeAsync();

    /// <summary>
    /// Request DTO for spawning an NPC.
    /// </summary>
    public class NpcSpawnRequest
    {
        public int TemplateId { get; set; }
        public string Name { get; set; } = "";
        public NpcDisposition Disposition { get; set; }
        public string? SessionNotes { get; set; }
    }
}
```

Key decisions per CONTEXT.md:
- Modal shows auto-generated name (from NpcAutoNamingService)
- GM can edit name freely
- Disposition dropdown with template default shown
- Optional session notes
- Disable spawn button while spawning (prevent double-click)
  </action>
  <verify>
    Run: `dotnet build Threa/Threa.Client/Threa.Client.csproj`
    Expect: Build succeeds
  </verify>
  <done>
    NpcSpawnModal.razor exists with name, disposition, and session notes fields.
    Modal has OnSpawn and OnCancel event callbacks.
    NpcSpawnRequest nested class provides spawn parameters.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add spawn button to NpcTemplates.razor</name>
  <files>Threa/Threa.Client/Components/Pages/GameMaster/NpcTemplates.razor</files>
  <action>
Modify NpcTemplates.razor to add spawn functionality:

1. Add inject statements at top (after existing injects):
```razor
@inject IDataPortal<GameMechanics.NpcSpawner> spawnerPortal
@inject Threa.Services.NpcAutoNamingService NamingService
```

2. Add state variables in @code section:
```csharp
// Spawn modal state
private bool showSpawnModal;
private NpcTemplateInfo? spawnTarget;
private string spawnAutoName = "";
private Guid? activeTableId; // TODO: Get from session or parameter

// Error handling
private string? spawnError;
```

3. Add a new column for Actions in the RadzenDataGrid (after the existing columns, before closing </Columns>):
```razor
<RadzenDataGridColumn TItem="NpcTemplateInfo" Title="Actions" Width="100px" Sortable="false">
    <Template Context="template">
        <button class="btn btn-sm btn-outline-primary"
                @onclick:stopPropagation="true"
                @onclick="() => ShowSpawnModal(template)"
                title="Spawn NPC from this template">
            <i class="bi bi-person-plus"></i>
        </button>
    </Template>
</RadzenDataGridColumn>
```

4. Add the modal render at the bottom of the page (before @code):
```razor
@if (showSpawnModal && spawnTarget != null)
{
    <NpcSpawnModal TemplateId="@spawnTarget.Id"
                   TemplateName="@spawnTarget.Name"
                   DefaultDisposition="@spawnTarget.DefaultDisposition"
                   AutoGeneratedName="@spawnAutoName"
                   OnSpawn="HandleSpawn"
                   OnCancel="CloseSpawnModal" />
}

@if (!string.IsNullOrEmpty(spawnError))
{
    <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
        @spawnError
        <button type="button" class="btn-close" @onclick="() => spawnError = null"></button>
    </div>
}
```

5. Add methods in @code:
```csharp
private void ShowSpawnModal(NpcTemplateInfo template)
{
    spawnTarget = template;
    spawnAutoName = NamingService.GenerateName(template.Id, template.Name);
    showSpawnModal = true;
}

private void CloseSpawnModal()
{
    showSpawnModal = false;
    spawnTarget = null;
}

private async Task HandleSpawn(NpcSpawnModal.NpcSpawnRequest request)
{
    // For now, just close modal with success message
    // Full spawn will require table context (Phase 25-05/06 integration)

    // Update prefix memory if name was customized
    NamingService.UpdatePrefixFromName(request.TemplateId, request.Name);

    // TODO: Execute spawn when table context is available
    // var spawner = await spawnerPortal.CreateAsync();
    // spawner.TemplateId = request.TemplateId;
    // spawner.TableId = activeTableId!.Value;
    // spawner.Name = request.Name;
    // spawner.Disposition = request.Disposition;
    // spawner.SessionNotes = request.SessionNotes;
    // spawner = await spawnerPortal.ExecuteAsync(spawner);

    CloseSpawnModal();

    // Show info that spawn requires active table
    spawnError = "Spawn from template library requires an active table. Use the spawn button in the GM dashboard instead.";
}
```

Note: The template library spawn will show a message directing to GM dashboard. Full spawn integration happens in Plan 25-06. This establishes the modal and UI patterns.
  </action>
  <verify>
    Run: `dotnet build Threa/Threa.Client/Threa.Client.csproj`
    Expect: Build succeeds
  </verify>
  <done>
    NpcTemplates.razor has spawn button per template row.
    Spawn button opens NpcSpawnModal with auto-generated name.
    Modal integrates with NpcAutoNamingService for prefix memory.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify UI compilation and modal integration</name>
  <files></files>
  <action>
Build full solution and verify spawn modal components compile:

1. Build Threa.Client project
2. Build full solution
3. Verify NpcSpawnModal is correctly referenced
  </action>
  <verify>
    Run: `dotnet build S:/src/rdl/threa/Threa.sln`
    Expect: Build succeeded
  </verify>
  <done>
    Full solution builds with spawn modal integrated into template library.
  </done>
</task>

</tasks>

<verification>
1. `NpcSpawnModal.razor` exists in `Threa/Threa.Client/Components/Shared/`
2. Modal has name, disposition, and session notes fields
3. NpcTemplates.razor has spawn button column
4. Clicking spawn opens modal with auto-generated name
5. Solution builds successfully
</verification>

<success_criteria>
- NpcSpawnModal provides full spawn customization UI
- Template library has spawn button per row
- Auto-naming service generates unique names
- Prefix memory updates when GM customizes name
- Modal prevents spawn without name
</success_criteria>

<output>
After completion, create `.planning/phases/25-npc-creation-dashboard/25-04-SUMMARY.md`
</output>
