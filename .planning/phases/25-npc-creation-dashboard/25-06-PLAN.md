---
phase: 25-npc-creation-dashboard
plan: 06
type: execute
wave: 4
depends_on: ["25-04", "25-05"]
files_modified:
  - Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
  - Threa/Threa.Client/Components/Shared/NpcSpawnModal.razor
autonomous: false

must_haves:
  truths:
    - "GM can spawn NPC from dashboard using spawn button"
    - "Spawned NPC appears in correct disposition group immediately"
    - "CharacterDetailModal works for NPCs with full GM manipulation"
    - "Session notes are visible in NPC detail modal"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor"
      provides: "Spawn button in NPC section header"
      contains: "ShowNpcSpawnModal"
  key_links:
    - from: "GmTable.razor"
      to: "NpcSpawner"
      via: "spawnerPortal.ExecuteAsync"
      pattern: "spawnerPortal"
    - from: "GmTable.razor"
      to: "CharacterDetailModal"
      via: "OpenCharacterDetails for NPCs"
      pattern: "OpenCharacterDetails"
---

<objective>
Complete NPC spawn integration by adding spawn button to GmTable dashboard, connecting NpcSpawner command, and verifying full end-to-end workflow.

Purpose: This final plan connects all the pieces: spawn button in dashboard triggers spawn modal, modal calls NpcSpawner command, spawned NPC appears in dashboard, and clicking NPC opens CharacterDetailModal with full manipulation powers.

Output: Complete working NPC spawn and management workflow.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-npc-creation-dashboard/25-CONTEXT.md
@.planning/phases/25-npc-creation-dashboard/25-RESEARCH.md
@.planning/phases/25-npc-creation-dashboard/25-03-SUMMARY.md
@.planning/phases/25-npc-creation-dashboard/25-04-SUMMARY.md
@.planning/phases/25-npc-creation-dashboard/25-05-SUMMARY.md

# Files to integrate
@Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
@Threa/Threa.Client/Components/Shared/NpcSpawnModal.razor
@GameMechanics/NpcSpawner.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add spawn button and modal integration to GmTable.razor</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor</files>
  <action>
Integrate NPC spawn workflow into GmTable.razor:

1. Add inject statements at top (with other injects):
```razor
@inject IDataPortal<GameMechanics.NpcSpawner> spawnerPortal
@inject Threa.Services.NpcAutoNamingService NamingService
@inject IDataPortal<GameMechanics.GameMaster.NpcTemplateList> templateListPortal
```

2. Add state variables in @code section (after existing state):
```csharp
// NPC spawn modal state
private bool showNpcSpawnModal;
private GameMechanics.GameMaster.NpcTemplateInfo? spawnTemplate;
private string spawnAutoName = "";
private IEnumerable<GameMechanics.GameMaster.NpcTemplateInfo>? availableTemplates;
private bool showTemplateSelector;
```

3. Update the NPC section card header to include spawn button:
```razor
<div class="card-header d-flex justify-content-between align-items-center">
    <strong><i class="bi bi-people me-1"></i>NPCs</strong>
    <div class="d-flex gap-2 align-items-center">
        <span class="badge bg-secondary">@tableNpcs.Count()</span>
        <button class="btn btn-primary btn-sm" @onclick="ShowTemplateSelector">
            <i class="bi bi-plus-lg me-1"></i>Spawn NPC
        </button>
    </div>
</div>
```

4. Add template selector modal (render before the NpcSpawnModal, after the NPC section card):
```razor
@* Template Selector Modal *@
@if (showTemplateSelector)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-person-badge me-2"></i>Select Template to Spawn
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseTemplateSelector"></button>
                </div>
                <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                    @if (availableTemplates == null)
                    {
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary"></div>
                            <div class="mt-2">Loading templates...</div>
                        </div>
                    }
                    else if (!availableTemplates.Any())
                    {
                        <div class="text-center text-muted py-3">
                            No active templates available.
                            <a href="/gamemaster/templates" class="d-block mt-2">Create templates</a>
                        </div>
                    }
                    else
                    {
                        <div class="list-group">
                            @foreach (var template in availableTemplates.Where(t => t.IsActive))
                            {
                                <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                        @onclick="() => SelectTemplate(template)">
                                    <div>
                                        <strong>@template.Name</strong>
                                        <small class="text-muted d-block">@template.Species - @template.Category</small>
                                    </div>
                                    <div class="text-end">
                                        @{
                                            var (badgeClass, label, _) = GetDifficultyDisplay(template.DifficultyRating);
                                        }
                                        <span class="badge @badgeClass">@label</span>
                                        <span class="badge bg-secondary ms-1">
                                            @(template.DefaultDisposition switch
                                            {
                                                NpcDisposition.Hostile => "Hostile",
                                                NpcDisposition.Neutral => "Neutral",
                                                NpcDisposition.Friendly => "Friendly",
                                                _ => "Unknown"
                                            })
                                        </span>
                                    </div>
                                </button>
                            }
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseTemplateSelector">Cancel</button>
                </div>
            </div>
        </div>
    </div>
}

@* NPC Spawn Modal *@
@if (showNpcSpawnModal && spawnTemplate != null)
{
    <NpcSpawnModal TemplateId="@spawnTemplate.Id"
                   TemplateName="@spawnTemplate.Name"
                   DefaultDisposition="@spawnTemplate.DefaultDisposition"
                   AutoGeneratedName="@spawnAutoName"
                   OnSpawn="HandleNpcSpawn"
                   OnCancel="CloseNpcSpawnModal" />
}
```

5. Add helper method for difficulty display (copy from NpcTemplates.razor or add):
```csharp
private (string badgeClass, string label, string tooltip) GetDifficultyDisplay(int rating)
{
    return rating switch
    {
        <= 5 => ("bg-success", "Easy", "Low threat - suitable for inexperienced parties"),
        <= 10 => ("bg-warning text-dark", "Moderate", "Medium threat - challenging for average parties"),
        <= 15 => ("bg-danger", "Hard", "High threat - dangerous for experienced parties"),
        _ => ("bg-dark", "Deadly", "Extreme threat - may result in casualties")
    };
}
```

6. Add spawn workflow methods:
```csharp
private async Task ShowTemplateSelector()
{
    showTemplateSelector = true;
    if (availableTemplates == null)
    {
        try
        {
            var list = await templateListPortal.FetchAsync();
            availableTemplates = list.AsEnumerable();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load templates: {ex.Message}";
            showTemplateSelector = false;
        }
    }
}

private void CloseTemplateSelector()
{
    showTemplateSelector = false;
}

private void SelectTemplate(GameMechanics.GameMaster.NpcTemplateInfo template)
{
    spawnTemplate = template;
    spawnAutoName = NamingService.GenerateName(template.Id, template.Name);
    showTemplateSelector = false;
    showNpcSpawnModal = true;
}

private void CloseNpcSpawnModal()
{
    showNpcSpawnModal = false;
    spawnTemplate = null;
}

private async Task HandleNpcSpawn(NpcSpawnModal.NpcSpawnRequest request)
{
    if (table == null) return;

    try
    {
        // Update prefix memory if name was customized
        NamingService.UpdatePrefixFromName(request.TemplateId, request.Name);

        // Execute spawn
        var spawner = spawnerPortal.Create();
        spawner.TemplateId = request.TemplateId;
        spawner.TableId = table.Id;
        spawner.Name = request.Name;
        spawner.Disposition = request.Disposition;
        spawner.SessionNotes = request.SessionNotes;
        spawner = await spawnerPortal.ExecuteAsync(spawner);

        if (spawner.Success)
        {
            AddLogEntry($"Spawned NPC: {request.Name}", ActivityCategory.Player);
            CloseNpcSpawnModal();

            // Refresh character list to show new NPC
            await RefreshCharacterListAsync();
            StateHasChanged();
        }
        else
        {
            errorMessage = spawner.ErrorMessage ?? "Failed to spawn NPC";
        }
    }
    catch (Exception ex)
    {
        errorMessage = $"Error spawning NPC: {ex.Message}";
    }
}
```
  </action>
  <verify>
    Run: `dotnet build Threa/Threa.Client/Threa.Client.csproj`
    Expect: Build succeeds
  </verify>
  <done>
    GmTable.razor has spawn button in NPC section header.
    Template selector modal shows available templates.
    Spawn modal opens with selected template.
    NpcSpawner command is executed on spawn.
    Character list refreshes to show new NPC.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify full solution build</name>
  <files></files>
  <action>
Build full solution to ensure all integrations compile:

1. Build all projects
2. Verify no errors from the integration
3. Check that all imports are resolved
  </action>
  <verify>
    Run: `dotnet build S:/src/rdl/threa/Threa.sln`
    Expect: Build succeeded
  </verify>
  <done>
    Full solution builds with complete NPC spawn integration.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete NPC spawn and dashboard workflow:
    1. Spawn button in GM dashboard NPC section
    2. Template selector modal listing available templates
    3. Spawn customization modal with name, disposition, notes
    4. NPC spawner creates full character from template
    5. Spawned NPC appears in dashboard grouped by disposition
    6. Clicking NPC opens CharacterDetailModal with full GM powers
  </what-built>
  <how-to-verify>
    1. Run the application: `cd Threa/Threa && dotnet run`
    2. Navigate to GM table page (login as GM, go to active table)
    3. Click "+ Spawn NPC" button in the NPC section header
    4. Select a template from the list
    5. Verify spawn modal shows auto-generated name (e.g., "Goblin 1")
    6. Optionally customize name, disposition, and session notes
    7. Click "Spawn" button
    8. Verify NPC appears in the correct disposition group
    9. Verify disposition icon (skull/circle/heart) shows on NPC card
    10. Verify "From: [template name]" label shows below card
    11. Click the NPC card
    12. Verify CharacterDetailModal opens
    13. Test GM manipulation in modal (damage, effects, etc.)
    14. Spawn another NPC - verify counter increments (e.g., "Goblin 2")
    15. (Optional) Customize name to "Goblin Chief 3" and spawn again - next goblin should use "Goblin Chief" prefix
  </how-to-verify>
  <resume-signal>Type "approved" if workflow functions correctly, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. Spawn button visible in NPC section header
2. Template selector shows available templates
3. Spawn modal pre-fills auto-generated name
4. Spawned NPC appears in correct disposition group
5. NPC card shows disposition icon and template label
6. CharacterDetailModal works for NPCs
7. Auto-naming counter increments correctly
8. Prefix memory works for customized names
</verification>

<success_criteria>
- CRTN-01: GM can quick-create NPC from template (spawn workflow)
- CRTN-02: NPCs have full character stats (same model as PCs)
- CRTN-03: Smart naming auto-generates unique names (global counter)
- CRTN-04: GM can add session-specific notes (spawn modal and detail modal)
- DASH-01: NPCs appear in separate dashboard section
- DASH-02: NPC status cards show same info as PC cards
- DASH-03: NPC detail modal provides same manipulation powers
- DASH-04: NPCs display disposition marker
</success_criteria>

<output>
After completion, create `.planning/phases/25-npc-creation-dashboard/25-06-SUMMARY.md`
</output>
