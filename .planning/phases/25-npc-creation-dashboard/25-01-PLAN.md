---
phase: 25-npc-creation-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Threa.Dal/Dto/Character.cs
  - GameMechanics/CharacterEdit.cs
  - GameMechanics/GamePlay/TableCharacterInfo.cs
autonomous: true

must_haves:
  truths:
    - "Spawned NPCs can track their source template ID and name"
    - "TableCharacterInfo displays NPC-specific fields (IsNpc, Disposition)"
  artifacts:
    - path: "Threa.Dal/Dto/Character.cs"
      provides: "SourceTemplateId and SourceTemplateName properties"
      contains: "SourceTemplateId"
    - path: "GameMechanics/CharacterEdit.cs"
      provides: "CSLA properties for source template tracking"
      contains: "SourceTemplateIdProperty"
    - path: "GameMechanics/GamePlay/TableCharacterInfo.cs"
      provides: "IsNpc, Disposition, SourceTemplateId, SourceTemplateName properties"
      contains: "IsNpcProperty"
  key_links:
    - from: "GameMechanics/GamePlay/TableCharacterInfo.cs"
      to: "Threa.Dal/Dto/Character"
      via: "Fetch method populates NPC fields from character"
      pattern: "IsNpc = character\\.IsNpc"
---

<objective>
Add source template tracking properties to Character DTO and CharacterEdit, and extend TableCharacterInfo with NPC-specific fields for dashboard display.

Purpose: Enable spawned NPCs to remember which template they came from (for "From: Goblin Warrior" label) and provide NPC fields to the dashboard for disposition grouping and display.

Output: Extended data model ready for NPC spawner and dashboard integration.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-npc-creation-dashboard/25-RESEARCH.md

# Existing files to modify
@Threa.Dal/Dto/Character.cs
@GameMechanics/CharacterEdit.cs
@GameMechanics/GamePlay/TableCharacterInfo.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add source template properties to Character DTO and CharacterEdit</name>
  <files>
    Threa.Dal/Dto/Character.cs
    GameMechanics/CharacterEdit.cs
  </files>
  <action>
1. In Character.cs (DTO), add after DifficultyRating property:
   - `public int? SourceTemplateId { get; set; }` - ID of template this NPC was spawned from (null for PCs/templates)
   - `public string? SourceTemplateName { get; set; }` - Denormalized template name for display

2. In CharacterEdit.cs (business object), add after DifficultyRatingProperty using the existing PropertyInfo pattern:
   - SourceTemplateIdProperty with int? type, using SetProperty for dirty tracking
   - SourceTemplateNameProperty with string? type, using SetProperty for dirty tracking
   - Add [Display(Name = "...")] attributes for UI consistency

Follow the exact pattern used for existing nullable properties like Category and Tags.
  </action>
  <verify>
    Run: `dotnet build Threa.Dal/Threa.Dal.csproj && dotnet build GameMechanics/GameMechanics.csproj`
    Expect: Both projects build successfully with 0 errors
  </verify>
  <done>
    Character DTO has SourceTemplateId and SourceTemplateName nullable properties.
    CharacterEdit has CSLA PropertyInfo properties for both fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend TableCharacterInfo with NPC-specific properties</name>
  <files>GameMechanics/GamePlay/TableCharacterInfo.cs</files>
  <action>
Add NPC-specific CSLA properties to TableCharacterInfo (read-only info class):

1. Add using statement for NpcDisposition enum: `using Threa.Dal.Dto;` (if not already present)

2. Add properties after GmNotes or ConcentrationName section:
   - IsNpc (bool) - Whether this character is an NPC
   - Disposition (NpcDisposition) - NPC's disposition (Hostile/Neutral/Friendly)
   - SourceTemplateId (int?) - Template this NPC was spawned from
   - SourceTemplateName (string?) - Template name for display

3. In the Fetch method, after existing character data loading (around line 280), populate the new fields:
```csharp
// NPC-specific properties
IsNpc = character.IsNpc;
Disposition = character.DefaultDisposition;
SourceTemplateId = character.SourceTemplateId;
SourceTemplateName = character.SourceTemplateName;
```

Use LoadProperty with private set pattern (matching existing TableCharacterInfo style).
  </action>
  <verify>
    Run: `dotnet build GameMechanics/GameMechanics.csproj`
    Expect: Build succeeds with 0 errors
  </verify>
  <done>
    TableCharacterInfo has IsNpc, Disposition, SourceTemplateId, and SourceTemplateName properties.
    Fetch method populates these from Character data.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify full solution build</name>
  <files></files>
  <action>
Build the entire solution to ensure no downstream compilation errors from the data model changes:

1. Run full solution build
2. Verify 0 errors
3. Check that existing TableCharacterList and other consumers still compile
  </action>
  <verify>
    Run: `dotnet build S:/src/rdl/threa/Threa.sln`
    Expect: Build succeeded with 0 errors (warnings acceptable)
  </verify>
  <done>
    Full solution builds successfully.
    No compilation errors introduced by data model changes.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Threa.sln` succeeds
2. Character.cs contains SourceTemplateId and SourceTemplateName
3. CharacterEdit.cs contains corresponding PropertyInfo properties
4. TableCharacterInfo.cs contains IsNpc, Disposition, SourceTemplateId, SourceTemplateName
5. TableCharacterInfo.Fetch populates NPC fields from character data
</verification>

<success_criteria>
- Character DTO has source template tracking properties
- CharacterEdit business object has corresponding CSLA properties
- TableCharacterInfo exposes NPC fields for dashboard consumption
- All projects build successfully
</success_criteria>

<output>
After completion, create `.planning/phases/25-npc-creation-dashboard/25-01-SUMMARY.md`
</output>
