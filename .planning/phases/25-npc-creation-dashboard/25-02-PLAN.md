---
phase: 25-npc-creation-dashboard
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Threa/Services/NpcAutoNamingService.cs
  - Threa/Program.cs
autonomous: true

must_haves:
  truths:
    - "Auto-naming generates unique names with global counter"
    - "Template prefixes are remembered per template within session"
  artifacts:
    - path: "Threa/Services/NpcAutoNamingService.cs"
      provides: "Session-scoped auto-naming service"
      contains: "GenerateName"
    - path: "Threa/Program.cs"
      provides: "Service registration"
      contains: "NpcAutoNamingService"
  key_links:
    - from: "Threa/Program.cs"
      to: "NpcAutoNamingService"
      via: "AddScoped registration"
      pattern: "AddScoped<NpcAutoNamingService>"
---

<objective>
Create NpcAutoNamingService that generates unique NPC names with a global counter and template-specific prefix memory.

Purpose: Per CONTEXT.md decisions, NPCs use a global counter across all spawns (not per-template) to avoid confusion ("which Goblin 2 is this?"). Template prefixes are remembered within the session so repeated spawns use the same prefix.

Output: Working auto-naming service registered as scoped (per-session).
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-npc-creation-dashboard/25-CONTEXT.md
@.planning/phases/25-npc-creation-dashboard/25-RESEARCH.md

@Threa/Program.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NpcAutoNamingService</name>
  <files>Threa/Services/NpcAutoNamingService.cs</files>
  <action>
Create new file `Threa/Services/NpcAutoNamingService.cs`:

```csharp
namespace Threa.Services;

/// <summary>
/// Session-scoped service for generating unique NPC names.
/// Uses a global counter across all NPCs with template-specific prefix memory.
/// Per CONTEXT.md: "GLOBAL counter across all NPCs (not per-template)"
/// </summary>
public class NpcAutoNamingService
{
    private int _globalCounter = 0;
    private readonly Dictionary<int, string> _templatePrefixes = new();

    /// <summary>
    /// Generates the next unique name for an NPC from the given template.
    /// </summary>
    /// <param name="templateId">Template ID for prefix lookup.</param>
    /// <param name="defaultPrefix">Default prefix (template name) if not previously set.</param>
    /// <returns>Generated name like "Goblin 1", "Bandit 2".</returns>
    public string GenerateName(int templateId, string defaultPrefix)
    {
        _globalCounter++;
        var prefix = GetOrSetPrefix(templateId, defaultPrefix);
        return $"{prefix} {_globalCounter}";
    }

    /// <summary>
    /// Gets the current prefix for a template, or sets it if not yet defined.
    /// </summary>
    public string GetOrSetPrefix(int templateId, string defaultPrefix)
    {
        if (!_templatePrefixes.TryGetValue(templateId, out var prefix))
        {
            prefix = defaultPrefix;
            _templatePrefixes[templateId] = prefix;
        }
        return prefix;
    }

    /// <summary>
    /// Updates the prefix for a template. Called when GM customizes the name.
    /// Extracts prefix from name like "Bandit Leader 3" -> "Bandit Leader".
    /// </summary>
    public void UpdatePrefixFromName(int templateId, string fullName)
    {
        // Extract prefix by removing trailing number
        var match = System.Text.RegularExpressions.Regex.Match(fullName, @"^(.+?)\s*\d*$");
        if (match.Success && !string.IsNullOrWhiteSpace(match.Groups[1].Value))
        {
            _templatePrefixes[templateId] = match.Groups[1].Value.Trim();
        }
    }

    /// <summary>
    /// Gets the current global counter value (for debugging/testing).
    /// </summary>
    public int CurrentCounter => _globalCounter;
}
```

Key implementation decisions per CONTEXT.md:
- Global counter (not per-template) - "Bandit 1", "Goblin 2", "Bandit 3"
- Prefix memory per template - spawning "Goblin" remembers "Goblin" prefix
- Prefix extraction - if GM names one "Goblin Chief 4", next goblin uses "Goblin Chief"
  </action>
  <verify>
    Run: `dotnet build Threa/Threa/Threa.csproj`
    Expect: Build succeeds
  </verify>
  <done>
    NpcAutoNamingService class exists with GenerateName, GetOrSetPrefix, and UpdatePrefixFromName methods.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register service in Program.cs</name>
  <files>Threa/Program.cs</files>
  <action>
Add NpcAutoNamingService registration to Program.cs:

1. Find the services configuration section (around the other `AddScoped`/`AddSingleton` calls)
2. Add after existing service registrations:

```csharp
// NPC auto-naming service (session-scoped)
builder.Services.AddScoped<NpcAutoNamingService>();
```

The service must be Scoped (not Singleton) because:
- Each user session gets its own counter
- Counter resets when session ends (page refresh)
- Per CONTEXT.md: "session state" persistence

Note: Add `using Threa.Services;` if not already present at top of file.
  </action>
  <verify>
    Run: `dotnet build Threa/Threa/Threa.csproj`
    Expect: Build succeeds with NpcAutoNamingService registration
  </verify>
  <done>
    NpcAutoNamingService is registered as Scoped service in Program.cs.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify service integration</name>
  <files></files>
  <action>
Build full solution to ensure service registration doesn't break anything:

1. Build the Threa project (web host)
2. Verify Program.cs compiles with service registration
3. Confirm no missing namespace errors
  </action>
  <verify>
    Run: `dotnet build S:/src/rdl/threa/Threa.sln`
    Expect: Build succeeded
  </verify>
  <done>
    Full solution builds with NpcAutoNamingService integrated.
  </done>
</task>

</tasks>

<verification>
1. `NpcAutoNamingService.cs` exists in `Threa/Services/`
2. Service has `GenerateName(templateId, defaultPrefix)` method
3. Service has `UpdatePrefixFromName(templateId, fullName)` method
4. Service is registered as Scoped in Program.cs
5. Solution builds successfully
</verification>

<success_criteria>
- NpcAutoNamingService generates names with global counter
- Service remembers template prefixes within session
- Prefix extraction works for customized names
- Service registered as Scoped in DI container
</success_criteria>

<output>
After completion, create `.planning/phases/25-npc-creation-dashboard/25-02-SUMMARY.md`
</output>
