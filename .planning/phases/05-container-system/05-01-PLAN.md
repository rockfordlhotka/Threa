---
phase: 05-container-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Threa/Threa.Client/Components/Pages/GamePlay/TabPlayInventory.razor
autonomous: false

must_haves:
  truths:
    - "Player can click a container tile to see its contents in a side panel"
    - "Player can select an item and click a container tile to move item into container"
    - "Player can select an item in container panel and click Remove to move it back to inventory"
    - "Container panel shows item count and basic capacity info"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/TabPlayInventory.razor"
      provides: "Container contents panel, move-to/remove-from container functionality"
      contains: "selectedContainer"
  key_links:
    - from: "TabPlayInventory.razor"
      to: "ItemManagementService.MoveToContainerAsync"
      via: "Method call for container operations"
      pattern: "itemService\\.MoveToContainerAsync"
    - from: "TabPlayInventory.razor"
      to: "itemDal.GetContainerContentsAsync"
      via: "Fetch container contents (or filter from loaded items)"
      pattern: "GetContainerContents|ContainerItemId"
---

<objective>
Add container contents panel and item placement functionality to the Play page inventory tab.

Purpose: Players need to organize items inside containers (backpacks, pouches, bags) to manage their inventory effectively. This enables hierarchical item organization.

Output: TabPlayInventory.razor extended with container panel that appears when clicking a container, plus move-to-container and remove-from-container functionality.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-container-system/05-CONTEXT.md
@.planning/phases/05-container-system/05-RESEARCH.md
@Threa/Threa.Client/Components/Pages/GamePlay/TabPlayInventory.razor
@GameMechanics/Items/ItemManagementService.cs
@Threa.Dal/IItemDal.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Container Contents Panel</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/TabPlayInventory.razor</files>
  <action>
Add container panel state and UI to TabPlayInventory.razor:

1. Add state fields after existing selection state:
   - `private CharacterItem? selectedContainer;` - currently opened container
   - `private List<CharacterItem> containerContents = new();` - items in selected container
   - `private Guid? selectedContainerItemId;` - selected item within container panel
   - `private CharacterItem? selectedContainerItem;` - reference to selected container item

2. Add helper method to identify containers:
```csharp
private bool IsContainerItem(CharacterItem item)
{
    var template = GetTemplate(item.ItemTemplateId);
    if (template == null) return false;
    return template.IsContainer || template.ItemType == ItemType.Container || template.ItemType == ItemType.AmmoContainer;
}
```

3. Add method to load container contents (filter from already-loaded items):
```csharp
private List<CharacterItem> GetContainerContents(Guid containerId)
{
    if (inventoryItems == null) return new List<CharacterItem>();
    return inventoryItems.Where(i => i.ContainerItemId == containerId).ToList();
}

private void OpenContainerPanel(CharacterItem container)
{
    selectedContainer = container;
    containerContents = GetContainerContents(container.Id);
    // Clear container item selection
    selectedContainerItemId = null;
    selectedContainerItem = null;
}

private void CloseContainerPanel()
{
    selectedContainer = null;
    containerContents.Clear();
    selectedContainerItemId = null;
    selectedContainerItem = null;
}
```

4. Modify the right column (col-md-5) to toggle between Equipment and Container panel:
   - If selectedContainer is not null, show container panel
   - Otherwise show equipment slots (existing code)

5. Add container panel markup (inside the col-md-5 div, before equipment slots):
```razor
@if (selectedContainer != null)
{
    <div class="card">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <strong>@GetItemName(selectedContainer)</strong>
            <button type="button" class="btn-close btn-close-white" @onclick="CloseContainerPanel"></button>
        </div>
        <div class="card-body">
            @if (!containerContents.Any())
            {
                <p class="text-muted text-center">Container is empty.</p>
            }
            else
            {
                <div class="container-grid">
                    @foreach (var item in containerContents)
                    {
                        <div class="container-item @(selectedContainerItemId == item.Id ? "selected" : "")"
                             @onclick="() => SelectContainerItem(item)">
                            <span class="item-icon">@GetItemIcon(item)</span>
                            <span class="item-name">@GetItemDisplayName(item)</span>
                            @if (item.Template?.IsStackable == true && item.StackSize > 1)
                            {
                                <span class="item-qty">x@item.StackSize</span>
                            }
                        </div>
                    }
                </div>
            }
        </div>
        <div class="card-footer">
            <button class="btn btn-outline-primary btn-sm"
                    disabled="@(selectedContainerItem == null)"
                    @onclick="RemoveFromContainer">
                Remove to Inventory
            </button>
        </div>
    </div>
}
else
{
    @* Existing Equipment Slots card *@
}
```

6. Add CSS for container panel (in the style section):
```css
.container-grid {
    display: flex;
    flex-direction: column;
    gap: 4px;
    max-height: 300px;
    overflow-y: auto;
}

.container-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    cursor: pointer;
    background: #fff;
}

.container-item:hover {
    background: #f0f0f0;
}

.container-item.selected {
    border-color: var(--bs-primary);
    background: rgba(var(--bs-primary-rgb), 0.1);
}

.container-item .item-icon {
    font-size: 16px;
    width: 20px;
    text-align: center;
}

.container-item .item-name {
    flex: 1;
    font-size: 0.9rem;
}

.container-item .item-qty {
    color: #6c757d;
    font-size: 0.8rem;
}
```

7. Add SelectContainerItem method:
```csharp
private void SelectContainerItem(CharacterItem item)
{
    if (selectedContainerItemId == item.Id)
    {
        selectedContainerItemId = null;
        selectedContainerItem = null;
    }
    else
    {
        selectedContainerItemId = item.Id;
        selectedContainerItem = item;
    }
}
```
  </action>
  <verify>dotnet build Threa/Threa.sln --no-restore</verify>
  <done>Container panel appears in right column when a container would be clicked (functionality added in Task 2). Panel shows container contents with selection capability.</done>
</task>

<task type="auto">
  <name>Task 2: Implement Move-to-Container and Remove-from-Container</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/TabPlayInventory.razor</files>
  <action>
Modify item click handling and add container operations:

1. Modify SelectItem() to handle container clicks with the two-phase move flow:
```csharp
private async Task SelectItem(CharacterItem item)
{
    ClearMessages();

    // If user has an item selected and clicks a container, move item into container
    if (selectedItem != null && IsContainerItem(item) && selectedItem.Id != item.Id)
    {
        await MoveToContainer(selectedItem.Id, item.Id);
        return;
    }

    // If clicking a container with no item selected, open container panel
    if (IsContainerItem(item) && selectedItem == null)
    {
        OpenContainerPanel(item);
        // Also select the container in inventory (for potential drop)
        selectedItemId = item.Id;
        selectedItem = item;
        return;
    }

    // Normal toggle selection
    if (selectedItemId == item.Id)
    {
        selectedItemId = null;
        selectedItem = null;
    }
    else
    {
        selectedItemId = item.Id;
        selectedItem = item;
        // Close container panel when selecting non-container
        if (!IsContainerItem(item))
        {
            CloseContainerPanel();
        }
    }
}
```
Note: Change SelectItem from sync to async Task since it now calls MoveToContainer.

2. Update inventory-tile @onclick to be async:
```razor
@onclick="async () => await SelectItem(item)"
```

3. Add MoveToContainer method:
```csharp
private async Task MoveToContainer(Guid itemId, Guid containerId)
{
    try
    {
        var result = await itemService.MoveToContainerAsync(Character!, itemId, containerId);
        if (!result.Success)
        {
            errorMessage = result.ErrorMessage;
            return;
        }

        var itemName = GetItemName(inventoryItems?.FirstOrDefault(i => i.Id == itemId));
        var containerName = GetItemName(inventoryItems?.FirstOrDefault(i => i.Id == containerId));
        successMessage = $"Moved {itemName} into {containerName}.";

        // Clear selection and refresh
        selectedItem = null;
        selectedItemId = null;
        await LoadItemsAsync();

        // Re-open container panel to show updated contents
        var container = inventoryItems?.FirstOrDefault(i => i.Id == containerId);
        if (container != null)
        {
            OpenContainerPanel(container);
        }
    }
    catch (Exception ex)
    {
        errorMessage = $"Error moving item: {ex.Message}";
    }
}
```

4. Add RemoveFromContainer method:
```csharp
private async Task RemoveFromContainer()
{
    if (selectedContainerItem == null || selectedContainer == null) return;

    try
    {
        ClearMessages();

        // Move item out of container (containerItemId = null)
        var result = await itemService.MoveToContainerAsync(Character!, selectedContainerItem.Id, null);
        if (!result.Success)
        {
            errorMessage = result.ErrorMessage;
            return;
        }

        var itemName = GetItemName(selectedContainerItem);
        successMessage = $"Removed {itemName} from container.";

        // Clear container item selection
        selectedContainerItemId = null;
        selectedContainerItem = null;

        // Refresh and re-open container panel
        var containerId = selectedContainer.Id;
        await LoadItemsAsync();

        var container = inventoryItems?.FirstOrDefault(i => i.Id == containerId);
        if (container != null)
        {
            OpenContainerPanel(container);
        }
        else
        {
            CloseContainerPanel();
        }
    }
    catch (Exception ex)
    {
        errorMessage = $"Error removing item: {ex.Message}";
    }
}
```

5. Update inventory grid to exclude items that are inside containers (only show top-level items):
In the inventory grid foreach, filter to items not in containers:
```razor
@foreach (var item in inventoryItems.Where(i => i.ContainerItemId == null))
```

6. Add visual indicator on container tiles that they are containers (add "is-container" class):
```razor
<div class="inventory-tile @(item.IsEquipped ? "equipped" : "") @(selectedItemId == item.Id ? "selected" : "") @(IsContainerItem(item) ? "is-container" : "")"
```

7. Add CSS for container tile indicator:
```css
.inventory-tile.is-container {
    border-style: dashed;
}

.inventory-tile.is-container::before {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: #6c757d;
}
```
  </action>
  <verify>dotnet build Threa/Threa.sln --no-restore</verify>
  <done>Clicking container with item selected moves item into container. Clicking container without selection opens panel. Remove button moves item from container back to inventory. Inventory grid only shows top-level items (not items inside containers).</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Container contents panel and move-to/remove-from container functionality in TabPlayInventory.razor:
- Container panel appears when clicking container tile (without item selected)
- Items can be moved into containers by selecting item first, then clicking container
- Items can be removed from containers via Remove button in panel
- Inventory grid only shows top-level items
- Container tiles have dashed border visual indicator
  </what-built>
  <how-to-verify>
1. Run the application: `dotnet run --project Threa/Threa`
2. Navigate to Play page with a character that has inventory items and at least one container (backpack, pouch, etc.)
3. Test container panel:
   - Click on a container tile (no item selected) - should open container panel on right
   - Click X button on panel header - should close panel and show equipment slots
4. Test move-to-container:
   - Click an item (not a container) to select it (blue border)
   - Click a container tile - item should move into container
   - Success message should appear
   - Container panel should open showing the moved item
5. Test remove-from-container:
   - With container panel open, click an item inside
   - Click "Remove to Inventory" button
   - Item should appear back in main inventory grid
   - Success message should appear
6. Verify filtering:
   - Items inside containers should NOT appear in main inventory grid
   - Only top-level items visible in grid
7. Verify container visual:
   - Container tiles should have dashed border
  </how-to-verify>
  <resume-signal>Type "approved" if container operations work correctly, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
- Container panel displays when clicking container without item selected
- Items move into containers when selected then container clicked
- Items remove from containers via Remove button
- Inventory grid shows only top-level items
- Container tiles have visual distinction
- Build succeeds without errors
</verification>

<success_criteria>
- INV-13: Player can place item inside container item in inventory
- INV-14: Player can remove item from container back to main inventory
- INV-15: Player can view items contained within a container
</success_criteria>

<output>
After completion, create `.planning/phases/05-container-system/05-01-SUMMARY.md`
</output>
