---
phase: 05-container-system
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - Threa/Threa.Client/Components/Pages/GamePlay/TabPlayInventory.razor
autonomous: false

must_haves:
  truths:
    - "Container tiles show color-coded fill indicator (green/yellow/red)"
    - "Container panel header shows weight and volume capacity status"
    - "System warns when placing item exceeds container capacity (but allows it)"
    - "System warns when placing wrong item type in restricted container (but allows it)"
    - "System blocks placing items in containers that are inside other containers"
    - "Dropping container with contents shows confirmation dialog with options"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/TabPlayInventory.razor"
      provides: "Container capacity display, fill indicators, nesting enforcement, drop confirmation"
      contains: "GetContainerFillClass"
  key_links:
    - from: "TabPlayInventory.razor"
      to: "ItemTemplate container fields"
      via: "Capacity calculation using ContainerMaxWeight, ContainerMaxVolume, ContainerWeightReduction"
      pattern: "ContainerMaxWeight|ContainerMaxVolume|ContainerWeightReduction"
---

<objective>
Add container capacity enforcement with visual indicators and warnings to the Play page inventory tab.

Purpose: Players need feedback about container fullness and must be warned when exceeding limits. The system enforces one-level nesting and provides clear options when dropping containers with contents.

Output: TabPlayInventory.razor extended with fill indicators on container tiles, capacity display in panel header, warning messages for limit violations, nesting enforcement, and drop container confirmation dialog.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-container-system/05-CONTEXT.md
@.planning/phases/05-container-system/05-RESEARCH.md
@.planning/phases/05-container-system/05-01-SUMMARY.md
@Threa/Threa.Client/Components/Pages/GamePlay/TabPlayInventory.razor
@Threa.Dal/Dto/ItemTemplate.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Container Capacity Display and Visual Fill Indicators</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/TabPlayInventory.razor</files>
  <action>
Add capacity calculation and visual indicators:

1. Add ContainerCapacity record class (after SlotCategory record):
```csharp
private record ContainerCapacity
{
    public decimal CurrentWeight { get; init; }
    public decimal MaxWeight { get; init; }
    public decimal CurrentVolume { get; init; }
    public decimal MaxVolume { get; init; }
    public decimal WeightPercent { get; init; }
    public decimal VolumePercent { get; init; }
    public decimal FillPercent => Math.Max(WeightPercent, VolumePercent);
    public bool IsOverCapacity { get; init; }
}
```

2. Add method to calculate container capacity:
```csharp
private ContainerCapacity GetContainerCapacity(CharacterItem container)
{
    var template = GetTemplate(container.ItemTemplateId);
    if (template == null || !IsContainerItem(container))
        return new ContainerCapacity();

    var contents = GetContainerContents(container.Id);

    decimal currentWeight = 0;
    decimal currentVolume = 0;

    foreach (var item in contents)
    {
        var itemTemplate = GetTemplate(item.ItemTemplateId);
        if (itemTemplate == null) continue;

        currentWeight += itemTemplate.Weight * item.StackSize;
        currentVolume += itemTemplate.Volume * item.StackSize;
    }

    // Apply magical weight reduction (e.g., Bag of Holding has < 1.0)
    currentWeight *= template.ContainerWeightReduction;

    var maxWeight = template.ContainerMaxWeight ?? decimal.MaxValue;
    var maxVolume = template.ContainerMaxVolume ?? decimal.MaxValue;

    var weightPercent = maxWeight < decimal.MaxValue && maxWeight > 0
        ? (currentWeight / maxWeight) * 100
        : 0;
    var volumePercent = maxVolume < decimal.MaxValue && maxVolume > 0
        ? (currentVolume / maxVolume) * 100
        : 0;

    return new ContainerCapacity
    {
        CurrentWeight = currentWeight,
        MaxWeight = maxWeight,
        CurrentVolume = currentVolume,
        MaxVolume = maxVolume,
        WeightPercent = weightPercent,
        VolumePercent = volumePercent,
        IsOverCapacity = (maxWeight < decimal.MaxValue && currentWeight > maxWeight) ||
                         (maxVolume < decimal.MaxValue && currentVolume > maxVolume)
    };
}
```

3. Add method to get fill CSS class for container tiles:
```csharp
private string GetContainerFillClass(CharacterItem item)
{
    if (!IsContainerItem(item)) return "";

    var capacity = GetContainerCapacity(item);

    if (capacity.FillPercent >= 100) return "container-full";
    if (capacity.FillPercent >= 75) return "container-warning";
    if (capacity.FillPercent > 0) return "container-partial";
    return "container-empty";
}
```

4. Update inventory-tile to include fill class:
```razor
<div class="inventory-tile @(item.IsEquipped ? "equipped" : "") @(selectedItemId == item.Id ? "selected" : "") @(IsContainerItem(item) ? "is-container" : "") @GetContainerFillClass(item)"
```

5. Add CSS for fill indicator colors (update existing container CSS):
```css
.inventory-tile.container-empty::before {
    background: #6c757d;
}

.inventory-tile.container-partial {
    border-color: var(--bs-success);
}

.inventory-tile.container-partial::before {
    background: var(--bs-success);
}

.inventory-tile.container-warning {
    border-color: var(--bs-warning);
}

.inventory-tile.container-warning::before {
    background: var(--bs-warning);
}

.inventory-tile.container-full {
    border-color: var(--bs-danger);
}

.inventory-tile.container-full::before {
    background: var(--bs-danger);
}
```

6. Update container panel header to show capacity:
```razor
<div class="card-header bg-info text-white">
    <div class="d-flex justify-content-between align-items-center">
        <strong>@GetItemName(selectedContainer)</strong>
        <button type="button" class="btn-close btn-close-white" @onclick="CloseContainerPanel"></button>
    </div>
    @{ var capacity = GetContainerCapacity(selectedContainer); }
    <div class="small mt-1">
        @if (capacity.MaxWeight < decimal.MaxValue)
        {
            <span class="@(capacity.WeightPercent >= 100 ? "text-warning" : "")">
                Weight: @capacity.CurrentWeight.ToString("0.#")/@capacity.MaxWeight.ToString("0.#") lbs
            </span>
        }
        @if (capacity.MaxVolume < decimal.MaxValue)
        {
            <span class="ms-2 @(capacity.VolumePercent >= 100 ? "text-warning" : "")">
                Volume: @capacity.CurrentVolume.ToString("0.#")/@capacity.MaxVolume.ToString("0.#")
            </span>
        }
        @if (capacity.IsOverCapacity)
        {
            <span class="badge bg-warning text-dark ms-2">Over Capacity</span>
        }
    </div>
</div>
```

7. Add method to format capacity display:
```csharp
private string GetCapacityDisplay(CharacterItem container)
{
    var capacity = GetContainerCapacity(container);
    var parts = new List<string>();

    if (capacity.MaxWeight < decimal.MaxValue)
        parts.Add($"{capacity.CurrentWeight:0.#}/{capacity.MaxWeight:0.#} lbs");
    if (capacity.MaxVolume < decimal.MaxValue)
        parts.Add($"{capacity.CurrentVolume:0.#}/{capacity.MaxVolume:0.#} vol");

    return string.Join(" | ", parts);
}
```
  </action>
  <verify>dotnet build Threa/Threa.sln --no-restore</verify>
  <done>Container tiles show color-coded fill indicators. Container panel header displays current/max weight and volume. Over-capacity containers show warning badge.</done>
</task>

<task type="auto">
  <name>Task 2: Add Nesting Enforcement, Type Warnings, and Drop Container Confirmation</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/TabPlayInventory.razor</files>
  <action>
Add validation for nesting, type restrictions, and container drop confirmation:

1. Add warning message field if not already present:
```csharp
private string? warningMessage;
```

2. Add warning alert after success message in the markup:
```razor
@if (!string.IsNullOrEmpty(warningMessage))
{
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        @warningMessage
        <button type="button" class="btn-close" @onclick="() => warningMessage = null"></button>
    </div>
}
```

3. Update ClearMessages to also clear warning:
```csharp
private void ClearMessages()
{
    errorMessage = null;
    successMessage = null;
    warningMessage = null;
}
```

4. Add nesting validation method:
```csharp
private string? ValidateNesting(CharacterItem item, CharacterItem container)
{
    // Check if target container is itself inside another container
    if (container.ContainerItemId.HasValue)
    {
        return "Cannot place items in a container that is inside another container. " +
               "Remove the container from its parent first.";
    }

    // If item being moved is a container, check if it has contents
    if (IsContainerItem(item))
    {
        var nestedContents = GetContainerContents(item.Id);
        if (nestedContents.Any())
        {
            return "Cannot place a container with items inside another container. " +
                   "Empty the container first.";
        }
    }

    return null;
}
```

5. Add type restriction validation method:
```csharp
private string? ValidateContainerTypeRestriction(CharacterItem item, CharacterItem container)
{
    var containerTemplate = GetTemplate(container.ItemTemplateId);
    if (string.IsNullOrEmpty(containerTemplate?.ContainerAllowedTypes))
        return null; // No restrictions

    var itemTemplate = GetTemplate(item.ItemTemplateId);
    if (itemTemplate == null) return null;

    var allowedTypes = containerTemplate.ContainerAllowedTypes
        .Split(',')
        .Select(t => t.Trim())
        .ToList();

    if (!allowedTypes.Contains(itemTemplate.ItemType.ToString()))
    {
        return $"This container is designed for {containerTemplate.ContainerAllowedTypes}. " +
               $"Placing {itemTemplate.ItemType} items may not be ideal.";
    }

    return null;
}
```

6. Add capacity warning check:
```csharp
private string? CheckCapacityWarning(CharacterItem item, CharacterItem container)
{
    var containerTemplate = GetTemplate(container.ItemTemplateId);
    var itemTemplate = GetTemplate(item.ItemTemplateId);
    if (containerTemplate == null || itemTemplate == null) return null;

    var capacity = GetContainerCapacity(container);
    var itemWeight = itemTemplate.Weight * item.StackSize * containerTemplate.ContainerWeightReduction;
    var itemVolume = itemTemplate.Volume * item.StackSize;

    var newWeight = capacity.CurrentWeight + itemWeight;
    var newVolume = capacity.CurrentVolume + itemVolume;

    var warnings = new List<string>();

    if (capacity.MaxWeight < decimal.MaxValue && newWeight > capacity.MaxWeight)
        warnings.Add($"weight ({newWeight:0.#}/{capacity.MaxWeight:0.#} lbs)");

    if (capacity.MaxVolume < decimal.MaxValue && newVolume > capacity.MaxVolume)
        warnings.Add($"volume ({newVolume:0.#}/{capacity.MaxVolume:0.#})");

    if (warnings.Any())
        return $"This will exceed container {string.Join(" and ", warnings)}.";

    return null;
}
```

7. Update MoveToContainer to include validations:
```csharp
private async Task MoveToContainer(Guid itemId, Guid containerId)
{
    try
    {
        var item = inventoryItems?.FirstOrDefault(i => i.Id == itemId);
        var container = inventoryItems?.FirstOrDefault(i => i.Id == containerId);

        if (item == null || container == null)
        {
            errorMessage = "Item or container not found.";
            return;
        }

        // Check nesting (blocking)
        var nestingError = ValidateNesting(item, container);
        if (nestingError != null)
        {
            errorMessage = nestingError;
            return;
        }

        // Check type restriction (warning only)
        var typeWarning = ValidateContainerTypeRestriction(item, container);

        // Check capacity (warning only)
        var capacityWarning = CheckCapacityWarning(item, container);

        var result = await itemService.MoveToContainerAsync(Character!, itemId, containerId);
        if (!result.Success)
        {
            errorMessage = result.ErrorMessage;
            return;
        }

        var itemName = GetItemName(item);
        var containerName = GetItemName(container);
        successMessage = $"Moved {itemName} into {containerName}.";

        // Show warnings if any
        var warnings = new List<string>();
        if (typeWarning != null) warnings.Add(typeWarning);
        if (capacityWarning != null) warnings.Add(capacityWarning);
        if (warnings.Any())
        {
            warningMessage = string.Join(" ", warnings);
        }

        // Clear selection and refresh
        selectedItem = null;
        selectedItemId = null;
        await LoadItemsAsync();

        // Re-open container panel to show updated contents
        var updatedContainer = inventoryItems?.FirstOrDefault(i => i.Id == containerId);
        if (updatedContainer != null)
        {
            OpenContainerPanel(updatedContainer);
        }
    }
    catch (Exception ex)
    {
        errorMessage = $"Error moving item: {ex.Message}";
    }
}
```

8. Update ConfirmDropItem to handle containers with contents:
```csharp
private async Task ConfirmDropItem()
{
    if (selectedItem == null) return;

    try
    {
        ClearMessages();

        var itemName = GetItemName(selectedItem);
        var template = GetTemplate(selectedItem.ItemTemplateId);

        // Check if item can be dropped (curse check)
        if (!itemService.CanDropItem(Character!, selectedItem.Id))
        {
            errorMessage = itemService.GetDropBlockReason(Character!, selectedItem.Id)
                ?? "This item cannot be dropped.";
            return;
        }

        // Check if this is a container with contents
        if (IsContainerItem(selectedItem))
        {
            var contents = GetContainerContents(selectedItem.Id);
            if (contents.Any())
            {
                await ConfirmDropContainerWithContents(selectedItem, contents);
                return;
            }
        }

        // For stackable items with quantity > 1, show quantity dialog
        if (template?.IsStackable == true && selectedItem.StackSize > 1)
        {
            await ShowDropQuantityDialog();
            return;
        }

        // Single item or non-stackable - simple confirmation
        var confirmed = await DialogService.Confirm(
            $"Are you sure you want to drop {itemName}? This cannot be undone.",
            "Drop Item",
            new ConfirmOptions
            {
                OkButtonText = "Drop",
                CancelButtonText = "Cancel"
            });

        if (confirmed == true)
        {
            await DropItem(selectedItem.Id);
        }
    }
    catch (Exception ex)
    {
        errorMessage = $"Error dropping item: {ex.Message}";
    }
}
```

9. Add ConfirmDropContainerWithContents method:
```csharp
private async Task ConfirmDropContainerWithContents(CharacterItem container, List<CharacterItem> contents)
{
    var containerName = GetItemName(container);
    var itemCount = contents.Count;
    var totalItems = contents.Sum(c => c.StackSize);

    var message = $"'{containerName}' contains {itemCount} item(s) ({totalItems} total). " +
                  "What would you like to do?";

    // Use custom dialog with three options
    var result = await DialogService.OpenAsync("Drop Container?", ds =>
        @<div>
            <p>@message</p>
            <div class="d-flex gap-2 justify-content-end mt-3">
                <button class="btn btn-secondary" @onclick="() => ds.Close(false)">Cancel</button>
                <button class="btn btn-outline-primary" @onclick="() => ds.Close(\"empty\")">Empty First</button>
                <button class="btn btn-danger" @onclick="() => ds.Close(\"drop\")">Drop All</button>
            </div>
        </div>
    );

    if (result is string action)
    {
        if (action == "drop")
        {
            // Drop container with all contents
            // First drop all contents
            foreach (var item in contents)
            {
                await itemService.RemoveItemFromInventoryAsync(Character!, item.Id);
            }
            // Then drop the container
            await DropItem(container.Id);
        }
        else if (action == "empty")
        {
            // Move all contents out of container
            foreach (var item in contents)
            {
                await itemService.MoveToContainerAsync(Character!, item.Id, null);
            }
            successMessage = $"Emptied {containerName}. Select it again to drop.";
            await LoadItemsAsync();
            // Keep container selected
            selectedItem = inventoryItems?.FirstOrDefault(i => i.Id == container.Id);
            selectedItemId = container.Id;
            CloseContainerPanel();
        }
    }
}
```
  </action>
  <verify>dotnet build Threa/Threa.sln --no-restore</verify>
  <done>Nesting is blocked with clear error. Type restrictions show warning. Capacity warnings show when exceeding limits. Container drop shows three-option dialog (Cancel/Empty First/Drop All).</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Container capacity enforcement in TabPlayInventory.razor:
- Visual fill indicators on container tiles (gray/green/yellow/red)
- Capacity display in container panel header (weight and volume)
- Over-capacity warning badge
- Nesting enforcement (blocks items in nested containers)
- Type restriction warnings (allows but warns)
- Capacity warnings (allows but warns)
- Drop container confirmation with three options
  </what-built>
  <how-to-verify>
1. Run the application: `dotnet run --project Threa/Threa`
2. Navigate to Play page with a character that has containers

3. Test fill indicators:
   - Empty container should have gray/neutral bar at bottom
   - Container with some items should show green (if under 75% full)
   - Container near capacity should show yellow (75-99%)
   - Over-capacity container should show red

4. Test capacity display:
   - Open a container panel
   - Header should show "Weight: X/Y lbs" and "Volume: X/Y"
   - If over capacity, should show "Over Capacity" badge

5. Test capacity warning:
   - Select a large/heavy item
   - Move it into a nearly-full container
   - Should see warning message but item still moves
   - Container should update to show new fill level

6. Test nesting enforcement:
   - Try to move an item into a container that is inside another container
   - Should see error message and item should NOT move
   - Try to move a non-empty container into another container
   - Should see error message and container should NOT move
   - Empty container can go into another container (should work)

7. Test type restriction warning:
   - If you have a quiver (designed for ammunition), try putting non-ammo in it
   - Should see warning but item still moves

8. Test drop container with contents:
   - Select a container that has items inside
   - Click Drop button
   - Should see dialog with "Cancel", "Empty First", and "Drop All" buttons
   - Test "Empty First" - items should move to inventory, container stays
   - Test "Drop All" - both container and contents should be removed
  </how-to-verify>
  <resume-signal>Type "approved" if all capacity enforcement features work correctly, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
- Container tiles show fill indicator colors based on capacity
- Container panel shows weight/volume status
- Over-capacity shows warning badge
- Capacity warnings appear but don't block operations
- Type restriction warnings appear but don't block operations
- Nesting is blocked with clear error message
- Drop container with contents shows three-option dialog
- All validations use existing ItemTemplate container fields
- Build succeeds without errors
</verification>

<success_criteria>
- INV-16: Container weight limits are enforced (warn but allow per CONTEXT.md)
- INV-17: Container volume limits are enforced (warn but allow per CONTEXT.md)
- INV-18: Container type restrictions are enforced (warn only per CONTEXT.md)
</success_criteria>

<output>
After completion, create `.planning/phases/05-container-system/05-02-SUMMARY.md`
</output>
