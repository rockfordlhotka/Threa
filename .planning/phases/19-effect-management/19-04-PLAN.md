---
phase: 19-effect-management
plan: 04
type: execute
wave: 3
depends_on: ["19-02", "19-03"]
files_modified:
  - Threa/Threa.Client/Components/Shared/EffectTemplatePickerModal.razor
  - Threa/Threa.Client/Components/Shared/EffectFormModal.razor
  - Threa/Threa.Client/Components/Shared/CharacterDetailEffects.razor
  - Threa/Threa.Client/Components/Shared/CharacterDetailModal.razor
autonomous: true

must_haves:
  truths:
    - "GM can browse effect templates and apply them to characters"
    - "GM can save a current effect as a new template"
    - "Character detail modal has Effects tab showing active effects"
    - "Templates pre-fill the effect form with defaults"
  artifacts:
    - path: "Threa/Threa.Client/Components/Shared/EffectTemplatePickerModal.razor"
      provides: "Modal for browsing and selecting effect templates"
      contains: "EffectTemplatePickerModal"
    - path: "Threa/Threa.Client/Components/Shared/CharacterDetailEffects.razor"
      provides: "Effects tab content for character detail modal"
      contains: "CharacterDetailEffects"
  key_links:
    - from: "EffectFormModal.razor"
      to: "EffectTemplatePickerModal.razor"
      via: "DialogService.OpenAsync"
      pattern: "OpenAsync<EffectTemplatePickerModal>"
    - from: "CharacterDetailModal.razor"
      to: "CharacterDetailEffects.razor"
      via: "tab rendering"
      pattern: "<CharacterDetailEffects"
---

<objective>
Create the effect template picker for quick effect application and a dedicated Effects tab in the character detail modal.

Purpose: Enables GMs to quickly apply common effects from templates and provides a dedicated view for monitoring active effects on characters. Completes the effect management feature set.

Output: EffectTemplatePickerModal.razor, CharacterDetailEffects.razor, updates to EffectFormModal.razor and CharacterDetailModal.razor.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-effect-management/19-CONTEXT.md
@.planning/phases/19-effect-management/19-02-SUMMARY.md (when available)
@.planning/phases/19-effect-management/19-03-SUMMARY.md (when available)
@Threa/Threa.Client/Components/Shared/CharacterDetailModal.razor (integration point)
@GameMechanics/EffectTemplateList.cs (template source)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EffectTemplatePickerModal for template selection</name>
  <files>Threa/Threa.Client/Components/Shared/EffectTemplatePickerModal.razor</files>
  <action>
Create EffectTemplatePickerModal.razor for browsing and selecting effect templates.

**Parameters:**
- None (returns selected template or null)

**UI Layout:**
1. **Search/Filter bar:**
   - Text search input (searches name, description, tags)
   - Effect type dropdown filter (All, Buff, Debuff, Condition, etc.)
2. **Template Grid:**
   - Responsive card grid (col-md-4 or col-lg-3)
   - Each card shows:
     - Icon and Name
     - Type badge (color-coded)
     - Brief description (truncated)
     - Duration info
     - Key modifiers summary
     - "Select" button
3. **Empty state:** "No templates found" when search returns nothing
4. **Cancel button** at bottom

**Behavior:**
- On init, fetch all templates via `IDataPortal<EffectTemplateList>`
- Filter templates client-side based on search term and type filter
- On "Select", call `DialogService.Close(selectedTemplate)` returning the EffectTemplate
- On "Cancel", call `DialogService.Close(null)`

**Injections:**
- `IDataPortal<EffectTemplateList> templateListPortal`
- `DialogService DialogService`

Use debounced search (300ms) for better UX.
  </action>
  <verify>
Build succeeds: `dotnet build Threa/Threa.Client/Threa.Client.csproj`
  </verify>
  <done>
EffectTemplatePickerModal displays searchable/filterable template grid and returns selected template.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add template selection to EffectFormModal</name>
  <files>Threa/Threa.Client/Components/Shared/EffectFormModal.razor</files>
  <action>
Enhance EffectFormModal with template selection and "Save as Template" functionality.

**Add to top of form (before Name field):**
```razor
<!-- Template Selection -->
<div class="mb-3">
    <label class="form-label">Quick Template (Optional)</label>
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-primary flex-grow-1" @onclick="OpenTemplatePicker">
            <i class="bi bi-collection me-1"></i>Choose from Templates...
        </button>
        @if (ExistingEffect == null && !string.IsNullOrEmpty(effectName))
        {
            <button type="button" class="btn btn-outline-secondary" @onclick="SaveAsTemplate"
                    disabled="@(!IsFormValid || isSavingTemplate)" title="Save current values as reusable template">
                <i class="bi bi-bookmark-plus"></i>
            </button>
        }
    </div>
    <small class="text-muted">Pre-fill form with a saved template, or save current values as new template</small>
</div>

<hr class="my-3" />
```

**Add methods:**

```csharp
private bool isSavingTemplate;

private async Task OpenTemplatePicker()
{
    var template = await DialogService.OpenAsync<EffectTemplatePickerModal>(
        "Select Effect Template",
        null,
        new DialogOptions { Width = "900px", Height = "600px", CloseDialogOnOverlayClick = true });

    if (template is EffectTemplate selectedTemplate)
    {
        ApplyTemplate(selectedTemplate);
    }
}

private void ApplyTemplate(EffectTemplate template)
{
    effectName = template.Name;
    selectedType = template.EffectType;
    description = template.Description ?? "";
    durationType = template.DurationType;
    durationValue = template.DefaultDurationValue ?? 0;

    var state = template.State;
    asModifier = state.ASModifier ?? 0;
    fatDamagePerTick = state.FatDamagePerTick ?? 0;
    vitDamagePerTick = state.VitDamagePerTick ?? 0;
    fatHealingPerTick = state.FatHealingPerTick ?? 0;
    vitHealingPerTick = state.VitHealingPerTick ?? 0;

    // Clear and repopulate modifier dictionaries
    attributeModifiers.Clear();
    if (state.AttributeModifiers != null)
    {
        foreach (var mod in state.AttributeModifiers)
            attributeModifiers[mod.Key] = mod.Value;
    }

    skillModifiers.Clear();
    if (state.SkillModifiers != null)
    {
        foreach (var mod in state.SkillModifiers)
            skillModifiers[mod.Key] = mod.Value;
    }

    StateHasChanged();
}

private async Task SaveAsTemplate()
{
    if (!IsFormValid) return;
    isSavingTemplate = true;

    try
    {
        var state = BuildEffectState();
        var templateDto = new EffectTemplateDto
        {
            Name = effectName,
            EffectType = selectedType,
            Description = description,
            DefaultDurationValue = durationValue,
            DurationType = durationType,
            StateJson = state.Serialize(),
            Tags = "", // Could prompt for tags
            IsSystem = false,
            IsActive = true,
            CreatedAt = DateTime.UtcNow
        };

        await EffectTemplateDal.SaveTemplateAsync(templateDto);
        ShowFeedback("Template saved!", "alert-success", "bi-check-circle");
    }
    catch (Exception ex)
    {
        ShowFeedback($"Error saving template: {ex.Message}", "alert-danger", "bi-exclamation-triangle");
    }
    finally
    {
        isSavingTemplate = false;
    }
}
```

**Add injection:**
- `[Inject] IEffectTemplateDal EffectTemplateDal { get; set; } = default!;`

**Add feedback support** (if not present):
- `feedbackMessage`, `feedbackClass`, `feedbackIcon` fields
- `ShowFeedback()` method
- Alert display in UI
  </action>
  <verify>
Build succeeds: `dotnet build Threa/Threa.Client/Threa.Client.csproj`
  </verify>
  <done>
EffectFormModal has "Choose from Templates" button that opens picker and pre-fills form. "Save as Template" button saves current form values.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create CharacterDetailEffects tab and integrate into modal</name>
  <files>
Threa/Threa.Client/Components/Shared/CharacterDetailEffects.razor
Threa/Threa.Client/Components/Shared/CharacterDetailModal.razor
  </files>
  <action>
**CharacterDetailEffects.razor:**

Create read-only view of character effects for the detail modal tab.

**Parameters:**
- `CharacterEdit? Character`
- `int CharacterId`
- `Guid TableId`

**UI Layout:**
1. **Summary header:**
   - Total active effects count (excluding wounds)
   - Total AS modifier from effects
   - Total attribute/skill modifiers summary
2. **Effect list** (not cards - more compact table/list view for read-only):
   - Icon, Name, Type badge
   - Duration remaining (or "Permanent")
   - Modifiers summary
   - Source (if set)
3. **"Manage Effects" button** at bottom linking to full management modal
4. **Empty state:** "No active effects" message

Follow patterns from CharacterDetailSheet for read-only display.

**CharacterDetailModal.razor:**

1. Add "Effects" to the tab list:
```csharp
private static readonly string[] tabNames = ["GM Actions", "Character Sheet", "Effects", "Inventory", "Grant Items", "Narrative"];
```

2. Add tab content rendering:
```razor
else if (activeTab == "Effects")
{
    <CharacterDetailEffects Character="character"
                            CharacterId="selectedCharacterId"
                            TableId="TableId" />
}
```

Position "Effects" after "Character Sheet" for logical flow.
  </action>
  <verify>
Build succeeds: `dotnet build Threa/Threa.Client/Threa.Client.csproj`
  </verify>
  <done>
CharacterDetailEffects tab exists in character detail modal showing active effects with modifiers. Tab navigation works.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Threa.sln` completes without errors
2. Run application, open character detail modal
3. "Effects" tab appears and shows character's non-wound effects
4. From EffectFormModal, "Choose from Templates" opens picker with seed templates
5. Selecting a template pre-fills all form fields
6. "Save as Template" creates new template (appears in picker on next open)
7. Effects tab shows accurate modifier summaries
</verification>

<success_criteria>
- EffectTemplatePickerModal provides searchable/filterable template browsing
- Templates pre-fill EffectFormModal with all relevant values
- Save as Template creates new templates for reuse
- Effects tab provides read-only view of active effects
- Tab integrates seamlessly with existing CharacterDetailModal
</success_criteria>

<output>
After completion, create `.planning/phases/19-effect-management/19-04-SUMMARY.md`
</output>
