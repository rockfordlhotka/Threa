---
phase: 19-effect-management
plan: 03
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - Threa/Threa.Client/Components/Shared/EffectManagementModal.razor
  - Threa/Threa.Client/Components/Shared/EffectFormModal.razor
  - Threa/Threa.Client/Components/Shared/CharacterDetailGmActions.razor
autonomous: true

must_haves:
  truths:
    - "GM can view all active effects on a character in a modal"
    - "GM can add a custom effect with name, type, duration, and modifiers"
    - "GM can edit an existing effect's properties"
    - "GM can remove an effect from a character"
  artifacts:
    - path: "Threa/Threa.Client/Components/Shared/EffectManagementModal.razor"
      provides: "Modal for listing and managing character effects"
      contains: "EffectManagementModal"
    - path: "Threa/Threa.Client/Components/Shared/EffectFormModal.razor"
      provides: "Modal for adding/editing effect details"
      contains: "EffectFormModal"
  key_links:
    - from: "CharacterDetailGmActions.razor"
      to: "EffectManagementModal.razor"
      via: "DialogService.OpenAsync"
      pattern: "OpenAsync<EffectManagementModal>"
    - from: "EffectManagementModal.razor"
      to: "EffectFormModal.razor"
      via: "DialogService.OpenAsync"
      pattern: "OpenAsync<EffectFormModal>"
---

<objective>
Create the effect management UI components - EffectManagementModal for viewing/removing effects, EffectFormModal for adding/editing effects, and integrate with CharacterDetailGmActions.

Purpose: Enables GMs to create custom effects with full modifier support, edit existing effects, and remove effects. This is the core CRUD interface for effect management.

Output: EffectManagementModal.razor, EffectFormModal.razor, updated CharacterDetailGmActions.razor.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-effect-management/19-CONTEXT.md
@.planning/phases/19-effect-management/19-01-SUMMARY.md (when available)
@Threa/Threa.Client/Components/Shared/WoundManagementModal.razor (pattern reference)
@Threa/Threa.Client/Components/Shared/WoundFormModal.razor (pattern reference)
@Threa/Threa.Client/Components/Shared/CharacterDetailGmActions.razor (integration point)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EffectManagementModal for effect list and actions</name>
  <files>Threa/Threa.Client/Components/Shared/EffectManagementModal.razor</files>
  <action>
Create EffectManagementModal.razor modeled after WoundManagementModal.

**Parameters:**
- `CharacterEdit? Character`
- `int CharacterId`
- `Guid TableId`

**UI Layout:**
1. "Add Effect" button at top
2. Card grid display of active effects (exclude wounds - they have separate management):
   - Filter: `e.EffectType != EffectType.Wound`
   - Each card shows:
     - Icon (if set) or default icon by type
     - Name with type badge (color-coded: Buff=success, Debuff=danger, Condition=warning, etc.)
     - Description (truncated)
     - Duration info (rounds remaining, "Permanent", or time remaining)
     - Modifiers summary (e.g., "STR +2, AS -2")
     - Edit/Remove buttons
3. Empty state: "No active effects. Click 'Add Effect' to create one."
4. Summary stats: Total effects count, total AS modifier sum

**Actions:**
- `OpenAddEffect()` - Opens EffectFormModal for new effect
- `OpenEditEffect(EffectRecord)` - Opens EffectFormModal for editing
- `ConfirmRemoveEffect(EffectRecord)` - Shows confirmation dialog
- `ExecuteRemove()` - Removes effect, publishes CharacterUpdateMessage
- `RefreshCharacter()` - Re-fetches character data

**Injections:**
- `IDataPortal<CharacterEdit> characterPortal`
- `DialogService DialogService`
- `ITimeEventPublisher TimeEventPublisher`

Use Bootstrap 5 cards in a responsive grid (col-md-6 or col-lg-4).
Follow WoundManagementModal patterns for dialog result handling and feedback messages.
  </action>
  <verify>
Build succeeds: `dotnet build Threa/Threa.Client/Threa.Client.csproj`
  </verify>
  <done>
EffectManagementModal displays character effects (excluding wounds) in card grid with add/edit/remove actions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create EffectFormModal for add/edit effect</name>
  <files>Threa/Threa.Client/Components/Shared/EffectFormModal.razor</files>
  <action>
Create EffectFormModal.razor modeled after WoundFormModal.

**Parameters:**
- `CharacterEdit? Character`
- `int CharacterId`
- `Guid TableId`
- `EffectRecord? ExistingEffect` (null for add, set for edit)

**Form Fields:**
1. **Name** (required, text input)
2. **Effect Type** (dropdown: Buff, Debuff, Condition, Poison, Disease, SpellEffect, ItemEffect, Environmental)
   - Exclude Wound (separate workflow), CombatStance, Concentration (special cases)
3. **Description** (textarea, optional)
4. **Duration Section:**
   - Duration Type dropdown: Rounds, Turns, Minutes, Hours, Days, Permanent
   - Duration Value input (number, hidden if Permanent)
5. **Modifiers Section** (collapsible "Advanced" panel):
   - AS Modifier (number input, default 0)
   - Attribute Modifiers: Mini-form with attribute dropdown + value, "Add" button, list of added modifiers
   - Skill Modifiers: Similar pattern
6. **Damage/Healing Per Tick** (for poisons, regeneration):
   - FAT Damage/Tick (number)
   - VIT Damage/Tick (number)
   - FAT Healing/Tick (number)
   - VIT Healing/Tick (number)

**Behavior:**
- On edit, populate all fields from ExistingEffect and its EffectState
- Validate: Name required, at least 2 characters
- Save builds EffectState, creates/updates EffectRecord
- Publish CharacterUpdateMessage after save
- DialogService.Close(true) on success, Close(false) on cancel

**Effect Type Color Mapping:**
- Buff: bg-success
- Debuff: bg-danger
- Condition: bg-warning
- Poison: bg-purple (or bg-dark)
- Disease: bg-secondary
- SpellEffect: bg-info
- ItemEffect: bg-primary
- Environmental: bg-dark

Follow WoundFormModal patterns for validation display and processing state.
  </action>
  <verify>
Build succeeds: `dotnet build Threa/Threa.Client/Threa.Client.csproj`
  </verify>
  <done>
EffectFormModal provides complete form for creating/editing effects with all modifier types and duration options.
  </done>
</task>

<task type="auto">
  <name>Task 3: Replace placeholder in CharacterDetailGmActions with Manage Effects button</name>
  <files>Threa/Threa.Client/Components/Shared/CharacterDetailGmActions.razor</files>
  <action>
Update the "Apply Effect" card section (currently a dropdown with hardcoded effects) to use the new modal system.

**Replace the current "Apply Effect" card with "Manage Effects" card:**

Remove:
```razor
<!-- Effects -->
<div class="col-md-6">
    <div class="card h-100">
        <div class="card-header bg-warning text-dark">
            <strong><i class="bi bi-stars me-1"></i>Apply Effect</strong>
        </div>
        <div class="card-body">
            <select class="form-select mb-2" @bind="selectedEffect">
                <option value="">Select effect...</option>
                ...
            </select>
            <button class="btn btn-warning w-100" @onclick="ApplyEffect"...>
        </div>
    </div>
</div>
```

Replace with:
```razor
<!-- Effects -->
<div class="col-md-6">
    <div class="card h-100">
        <div class="card-header bg-info text-white">
            <strong><i class="bi bi-stars me-1"></i>Manage Effects</strong>
        </div>
        <div class="card-body d-flex flex-column">
            <p class="text-muted small flex-grow-1">
                Add, edit, and remove effects. Effects modify stats, apply damage over time, or provide conditions.
            </p>
            <button class="btn btn-outline-info w-100" @onclick="OpenEffectManagement" disabled="@isProcessing">
                <i class="bi bi-stars me-1"></i>Manage Effects
                @if (Character != null)
                {
                    var effectCount = Character.Effects.Count(e => e.EffectType != EffectType.Wound);
                    if (effectCount > 0)
                    {
                        <span class="badge bg-light text-info ms-1">@effectCount</span>
                    }
                }
            </button>
        </div>
    </div>
</div>
```

**Add OpenEffectManagement method:**
```csharp
private async Task OpenEffectManagement()
{
    var result = await DialogService.OpenAsync<EffectManagementModal>(
        "Manage Effects",
        new Dictionary<string, object>
        {
            { "Character", Character! },
            { "CharacterId", CharacterId },
            { "TableId", TableId }
        },
        new DialogOptions { Width = "800px", Height = "600px", CloseDialogOnOverlayClick = true });

    if (result is true)
    {
        await OnCharacterUpdated.InvokeAsync();
    }
}
```

**Remove obsolete code:**
- Remove `selectedEffect` field
- Remove `ApplyEffect` method (the old dropdown approach)

**Add using:**
- Ensure `@using GameMechanics.Effects` if needed for EffectState
  </action>
  <verify>
Build succeeds: `dotnet build Threa/Threa.Client/Threa.Client.csproj`
  </verify>
  <done>
CharacterDetailGmActions has "Manage Effects" button that opens EffectManagementModal. Effect count badge shows non-wound effects.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Threa.sln` completes without errors
2. Run application, open character detail, click "Manage Effects"
3. EffectManagementModal opens showing character's non-wound effects
4. "Add Effect" opens EffectFormModal
5. Can create new effect with modifiers
6. Effect appears in management modal after save
7. Can edit and remove effects
</verification>

<success_criteria>
- EffectManagementModal shows all non-wound effects in card grid
- EffectFormModal supports all effect types and modifier configurations
- Add/Edit/Remove workflows function correctly
- Real-time updates published via CharacterUpdateMessage
- UI follows established patterns from WoundManagement
</success_criteria>

<output>
After completion, create `.planning/phases/19-effect-management/19-03-SUMMARY.md`
</output>
