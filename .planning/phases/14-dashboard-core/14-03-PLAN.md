---
phase: 14-dashboard-core
plan: 03
type: execute
wave: 3
depends_on: ["14-02"]
files_modified:
  - Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
  - Threa/Threa/wwwroot/js/site.js
autonomous: false

must_haves:
  truths:
    - "GM dashboard shows CharacterStatusCard for each character at the table"
    - "Cards are arranged in a responsive grid layout"
    - "Empty state shows message when no characters have joined"
    - "Tooltips initialize correctly on dynamic card content"
    - "Character selection highlights the selected card"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor"
      provides: "GM dashboard with character status cards"
      contains: "CharacterStatusCard"
  key_links:
    - from: "GmTable.razor"
      to: "CharacterStatusCard.razor"
      via: "Component usage in foreach loop"
      pattern: "<CharacterStatusCard.*Character="
    - from: "GmTable.razor"
      to: "site.js"
      via: "JS interop for tooltip initialization"
      pattern: "initializeTooltips"
---

<objective>
Integrate CharacterStatusCard into GmTable.razor, replacing the existing character list with a responsive grid of status cards, and add Bootstrap tooltip initialization.

Purpose: Transform the GM dashboard's character panel from a simple list into a compact, information-rich grid of status cards that provides at-a-glance monitoring.
Output: Updated GmTable.razor with CharacterStatusCard grid, empty state handling, and working tooltips.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/14-dashboard-core/14-CONTEXT.md
@.planning/phases/14-dashboard-core/14-RESEARCH.md
@.planning/phases/14-dashboard-core/14-02-SUMMARY.md

@Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
@Threa/Threa.Client/Components/Shared/CharacterStatusCard.razor
@Threa/Threa/wwwroot/js/site.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tooltip initialization JavaScript</name>
  <files>
    Threa/Threa/wwwroot/js/site.js
  </files>
  <action>
Add a function to initialize Bootstrap tooltips for dynamically rendered content. This is needed because Blazor renders content after Bootstrap's initial tooltip setup.

Add to site.js (create file if it doesn't exist, or add to existing):

```javascript
// Initialize Bootstrap tooltips on dynamically rendered elements
window.initializeTooltips = function() {
    // Dispose existing tooltips to prevent duplicates
    var existingTooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    existingTooltips.forEach(function(el) {
        var existingInstance = bootstrap.Tooltip.getInstance(el);
        if (existingInstance) {
            existingInstance.dispose();
        }
    });

    // Initialize new tooltips
    var tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltipTriggerList.forEach(function(el) {
        new bootstrap.Tooltip(el, {
            container: 'body',
            trigger: 'hover'
        });
    });
};

// Also reinitialize on DOM changes if needed
window.reinitializeTooltipsAfterDelay = function(delayMs) {
    setTimeout(function() {
        window.initializeTooltips();
    }, delayMs || 100);
};
```

Check if site.js is already referenced in the Blazor layout. If not, it will need to be added to App.razor or _Host.cshtml.
  </action>
  <verify>
File exists at Threa/Threa/wwwroot/js/site.js with initializeTooltips function.
  </verify>
  <done>
site.js contains initializeTooltips function for Bootstrap tooltip initialization on dynamic Blazor content.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update GmTable.razor to use CharacterStatusCard grid</name>
  <files>
    Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
  </files>
  <action>
Replace the existing "Characters at Table" card body with a grid of CharacterStatusCard components.

1. Find the existing character list section (around line 165-235 in the current file):
```razor
<div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Characters at Table</strong>
        ...
    </div>
    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
        @if (tableCharacters == null || !tableCharacters.Any())
        ...
```

2. Replace the card body content with:
```razor
<div class="card-body" style="max-height: 500px; overflow-y: auto;">
    @if (tableCharacters == null || !tableCharacters.Any())
    {
        <div class="text-center py-4">
            <i class="bi bi-people fs-1 text-muted"></i>
            <p class="text-muted mt-2 mb-0">Waiting for players to join</p>
            <small class="text-muted">Share this link:</small>
            <div class="mt-1">
                <code class="small">@GetPlayerJoinLink()</code>
            </div>
        </div>
    }
    else
    {
        <div class="row row-cols-1 row-cols-lg-2 g-2">
            @foreach (var character in tableCharacters)
            {
                <div class="col">
                    <CharacterStatusCard Character="@character"
                                        IsSelected="@(selectedCharacter?.CharacterId == character.CharacterId)"
                                        OnClick="SelectCharacter" />
                </div>
            }
        </div>
    }
</div>
```

3. Add JS interop call for tooltip initialization after render. Add to the @code section:
```csharp
protected override async Task OnAfterRenderAsync(bool firstRender)
{
    await base.OnAfterRenderAsync(firstRender);

    // Initialize tooltips after each render since cards may have changed
    if (tableCharacters?.Any() == true)
    {
        await JS.InvokeVoidAsync("reinitializeTooltipsAfterDelay", 50);
    }
}
```

4. Remove the old character card markup (the foreach loop with gm-character-card divs).

5. Keep the quick action buttons (Heal/Damage/Remove) - move them to a separate section below the grid OR keep them in the detail panel. Per CONTEXT.md, the cards are for display only - actions are in the center panel when a character is selected.

IMPORTANT: The existing code already has damage/heal/remove functionality in the detail panel (center column). The CharacterStatusCard replaces only the character LIST display, not the action panel.
  </action>
  <verify>
`dotnet build Threa/Threa.Client/Threa.Client.csproj` compiles without errors.
  </verify>
  <done>
GmTable.razor displays characters using CharacterStatusCard grid with responsive columns, empty state, and tooltip initialization.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
GM dashboard character status cards with:
- Responsive grid layout (2 columns on large screens, 1 on small)
- Health bars with pending damage/healing visualization
- AP, wounds, and effects badges with hover tooltips
- Color-coded borders indicating health state
- Empty state when no characters joined
  </what-built>
  <how-to-verify>
1. Start the application: `dotnet run --project Threa/Threa`
2. Navigate to https://localhost:7133 and login as GM
3. Open an existing campaign table (or create one)
4. Verify empty state displays correctly if no characters
5. If characters exist at the table:
   - Verify cards show in a grid layout
   - Verify FAT/VIT bars display (with pending damage if any)
   - Hover over wounds/effects badges to verify tooltips appear
   - Click a card to verify selection highlighting
   - Verify border color matches health state:
     - Green = healthy
     - Yellow = wounded or low FAT
     - Red = critical (low VIT)
     - Dark = unconscious (FAT <= 0)
6. Resize browser to verify responsive layout
7. Test in both Fantasy and Sci-Fi themes
  </how-to-verify>
  <resume-signal>Type "approved" if the dashboard displays correctly, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
1. `dotnet build Threa.sln` - solution compiles
2. GmTable.razor uses CharacterStatusCard component
3. site.js has initializeTooltips function
4. Visual verification of dashboard layout and functionality
</verification>

<success_criteria>
- GM dashboard shows CharacterStatusCard for each character at table
- Cards arranged in responsive 2-column grid on large screens
- Empty state displays when no characters joined
- Tooltips show wound/effect details on badge hover
- Card borders indicate health state with correct colors
- Card selection works (highlights selected, shows in detail panel)
- Works in both Fantasy and Sci-Fi themes
</success_criteria>

<output>
After completion, create `.planning/phases/14-dashboard-core/14-03-SUMMARY.md`
</output>
