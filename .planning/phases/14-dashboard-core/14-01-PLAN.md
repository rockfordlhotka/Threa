---
phase: 14-dashboard-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - GameMechanics/GamePlay/TableCharacterInfo.cs
  - Threa.Dal/Dto/CharacterStatusSummary.cs
  - Threa.Dal/ICharacterDal.cs
  - Threa.Dal.MockDb/CharacterDalMock.cs
  - Threa.Dal.Sqlite/CharacterDalSqlite.cs
autonomous: true

must_haves:
  truths:
    - "TableCharacterInfo includes pending damage and healing values for FAT and VIT"
    - "TableCharacterInfo includes wound count and effect count"
    - "TableCharacterInfo includes wound and effect summary strings for tooltips"
  artifacts:
    - path: "GameMechanics/GamePlay/TableCharacterInfo.cs"
      provides: "Extended read-only character info with pending pools and status counts"
      contains: "FatPendingDamage"
    - path: "Threa.Dal/Dto/CharacterStatusSummary.cs"
      provides: "DTO for aggregated character status data"
      contains: "WoundCount"
  key_links:
    - from: "GameMechanics/GamePlay/TableCharacterInfo.cs"
      to: "Threa.Dal/Dto/Character.cs"
      via: "FetchChild loads from Character DTO"
      pattern: "FatPendingDamage.*=.*character\\.FatPendingDamage"
---

<objective>
Extend TableCharacterInfo to include pending damage/healing pools, wound count, effect count, and summary strings for GM dashboard tooltips.

Purpose: Enable the GM dashboard to display complete character status without fetching full CharacterEdit objects, maintaining read-only lightweight access.
Output: Updated TableCharacterInfo with all fields needed for compact status card display.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-dashboard-core/14-CONTEXT.md
@.planning/phases/14-dashboard-core/14-RESEARCH.md

@GameMechanics/GamePlay/TableCharacterInfo.cs
@Threa.Dal/Dto/Character.cs
@GameMechanics/EffectList.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend TableCharacterInfo with pending pools and status counts</name>
  <files>
    GameMechanics/GamePlay/TableCharacterInfo.cs
  </files>
  <action>
Add CSLA properties for pending pools and status counts to TableCharacterInfo:

1. Pending pool properties (using standard CSLA pattern):
   - FatPendingDamage (int)
   - FatPendingHealing (int)
   - VitPendingDamage (int)
   - VitPendingHealing (int)

2. Status count properties:
   - WoundCount (int) - total wounds across all locations
   - EffectCount (int) - count of active effects

3. Tooltip summary string properties:
   - WoundSummary (string) - e.g., "Light x2, Serious x1"
   - EffectSummary (string) - e.g., "Poison (3 rnd), Blessed, Shield Spell"

Update the [FetchChild] method to load these from the Character DTO:
- Load pending pools directly from character.FatPendingDamage etc.
- For WoundCount and EffectCount, count from character.Effects list by type
- Build WoundSummary by grouping wounds and formatting as "Type xN, ..."
- Build EffectSummary by listing effect names with durations

Use LoadProperty for all new properties (read-only, no dirty tracking).

Pattern for wound summary building:
```csharp
var wounds = character.Effects.Where(e => e.EffectType == EffectType.Wound)
    .GroupBy(e => e.Name)
    .Select(g => g.Count() > 1 ? $"{g.Key} x{g.Count()}" : g.Key);
WoundSummary = string.Join(", ", wounds);
```

Pattern for effect summary (non-wound effects):
```csharp
var effects = character.Effects.Where(e => e.EffectType != EffectType.Wound)
    .Select(e => e.DurationRounds.HasValue ? $"{e.Name} ({e.DurationRounds} rnd)" : e.Name);
EffectSummary = string.Join(", ", effects);
```
  </action>
  <verify>
`dotnet build GameMechanics/GameMechanics.csproj` compiles without errors.
  </verify>
  <done>
TableCharacterInfo has 8 new properties: FatPendingDamage, FatPendingHealing, VitPendingDamage, VitPendingHealing, WoundCount, EffectCount, WoundSummary, EffectSummary. All properties load from Character DTO in FetchChild.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update DAL to populate effects for TableCharacterList fetch</name>
  <files>
    Threa.Dal.MockDb/CharacterDalMock.cs
    Threa.Dal.Sqlite/CharacterDalSqlite.cs
  </files>
  <action>
Ensure that when fetching Character data for TableCharacterList, the Effects list is populated (currently it may be empty because effects are loaded on-demand).

Check the GetCharacterAsync methods in both DAL implementations:
1. MockDb: Verify that effects are included when returning a Character
2. Sqlite: Verify that effects are joined/loaded when returning a Character

If effects are NOT currently populated in GetCharacterAsync:
- Add an optional parameter `includeEffects = false` to avoid breaking changes
- Or ensure the existing implementation populates effects

The TableCharacterList fetch operation needs Character.Effects to be populated for the WoundCount, EffectCount, WoundSummary, and EffectSummary calculations.

Check TableCharacterList.cs [Fetch] method to see how it calls the DAL - it may need adjustment to request effects.

If ICharacterDal doesn't have a method that includes effects, look at how the existing code fetches effects (likely via IEffectDal) and add that lookup in the TableCharacterList [Fetch] after getting the character.
  </action>
  <verify>
`dotnet build Threa.sln` compiles without errors.
  </verify>
  <done>
Character Effects list is populated when TableCharacterList fetches character data, enabling wound/effect counting in TableCharacterInfo.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify integration with unit test</name>
  <files>
    GameMechanics.Test/GamePlayTests.cs
  </files>
  <action>
Add a simple test to verify TableCharacterInfo correctly exposes the new properties. If GamePlayTests.cs doesn't exist, create it.

Test should:
1. Create a Character DTO with known pending pools values
2. Create a Character with mock effects (wounds and non-wound effects)
3. Fetch TableCharacterInfo and verify:
   - FatPendingDamage, VitPendingDamage populated correctly
   - WoundCount matches number of wound effects
   - EffectCount matches number of non-wound effects
   - WoundSummary and EffectSummary formatted correctly

Use existing test patterns from other test files in the project.

If direct unit testing of TableCharacterInfo is complex due to CSLA data portal, add a simpler integration test that verifies the extension works via the data portal pattern.
  </action>
  <verify>
`dotnet test GameMechanics.Test/GameMechanics.Test.csproj --filter "FullyQualifiedName~TableCharacterInfo"` passes.
  </verify>
  <done>
Unit test confirms TableCharacterInfo correctly populates pending pools, wound count, effect count, and summary strings from Character data.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Threa.sln` - solution compiles
2. `dotnet test GameMechanics.Test/GameMechanics.Test.csproj` - all tests pass
3. TableCharacterInfo.cs contains all 8 new properties with proper CSLA pattern
</verification>

<success_criteria>
- TableCharacterInfo has FatPendingDamage, FatPendingHealing, VitPendingDamage, VitPendingHealing properties
- TableCharacterInfo has WoundCount and EffectCount integer properties
- TableCharacterInfo has WoundSummary and EffectSummary string properties
- All properties populated correctly from Character DTO in FetchChild
- Solution builds and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-dashboard-core/14-01-SUMMARY.md`
</output>
