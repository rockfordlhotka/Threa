---
phase: 27-time-combat-integration
plan: 02
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - Threa/Threa.Client/Components/Pages/GamePlay/Play.razor
  - Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
autonomous: true

must_haves:
  truths:
    - "Player's targeting is invalidated when GM hides their selected target"
    - "Activity log shows '[NPC Name] appears!' when GM reveals NPC"
    - "Target list refreshes when NPC visibility changes"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/Play.razor"
      provides: "Target invalidation on visibility change"
      contains: "VisibleToPlayers"
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor"
      provides: "Reveal activity log message"
      contains: "appears!"
  key_links:
    - from: "Play.razor OnCharacterUpdateReceived"
      to: "Target invalidation"
      via: "visibility check on current target"
      pattern: "VisibleToPlayers.*false"
    - from: "GmTable.razor RevealNpc"
      to: "ActivityLog"
      via: "Publish reveal message"
      pattern: "appears!"
---

<objective>
Complete NPC combat integration with target invalidation and reveal announcements.

Purpose: This plan adds polish from CONTEXT.md decisions: target invalidation when GM hides NPC mid-action, and activity log announcement when NPC is revealed.

Output: Modified Play.razor with target invalidation handling, modified GmTable.razor with reveal activity log message.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-time-combat-integration/27-CONTEXT.md
@.planning/phases/27-time-combat-integration/27-RESEARCH.md
@.planning/phases/27-time-combat-integration/27-01-SUMMARY.md

Key files:
@Threa/Threa.Client/Components/Pages/GamePlay/Play.razor
@Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Target Invalidation on Visibility Change</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/Play.razor</files>
  <action>
Enhance OnCharacterUpdateReceived to refresh target list and invalidate targeting if current target becomes hidden.

Per CONTEXT.md: "If player is mid-action when GM hides target, action is invalidated - player picks new target."

1. Update OnCharacterUpdateReceived to handle all character updates (not just self):

Locate the existing OnCharacterUpdateReceived method. Currently it only handles updates to the player's own character. Expand it to also refresh tableCharacters when ANY character at the table changes.

```csharp
private void OnCharacterUpdateReceived(object? sender, CharacterUpdateMessage e)
{
    // Ignore events if component is disposed
    if (_disposed || table == null) return;

    _ = InvokeAsync(async () =>
    {
        try
        {
            // If this is our character, refresh it
            if (character != null && e.CharacterId == character.Id)
            {
                character = await characterPortal.FetchAsync(character.Id);
                await LoadEquippedItemsAsync();
            }

            // Always refresh table characters to catch NPC visibility changes
            await LoadTableCharactersAsync();

            // Check if we're in targeting and our target is no longer valid
            if (currentTargetingInteraction != null && showTargetingModal)
            {
                var targetId = currentTargetingInteraction.DefenderId;
                var target = tableCharacters.FirstOrDefault(c => c.CharacterId == targetId);

                // Target invalid if: not found, or is NPC that's now hidden
                bool targetInvalid = target == null ||
                    (target.IsNpc && !target.VisibleToPlayers);

                if (targetInvalid)
                {
                    // Cancel the targeting interaction
                    await TargetingManager.CancelAsync(
                        currentTargetingInteraction.InteractionId,
                        "Target is no longer available");

                    // Show toast notification to player
                    // Use DialogService or just close the modal with a message
                    showTargetingModal = false;
                    currentTargetingInteraction = null;

                    // Log the invalidation for the player
                    AddLogEntry("Target hidden - select a new target", ActivityCategory.Combat);
                }
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error processing character update: {ex.Message}";
            StateHasChanged();
        }
    });
}
```

Note: The method currently checks `e.CharacterId != character.Id` to early-return. Remove that check so ALL character updates trigger a refresh of tableCharacters.
  </action>
  <verify>
Build compiles:
```bash
dotnet build Threa.sln
```
  </verify>
  <done>
OnCharacterUpdateReceived refreshes tableCharacters on any character update and invalidates targeting if current target is now hidden.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Reveal Activity Log Message</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor</files>
  <action>
Update RevealNpc method to publish player-visible activity log message when NPC is revealed.

Per CONTEXT.md: "When GM reveals an NPC, activity log entry: '[NPC Name] appears!' (name only, no disposition text)."

Find the existing RevealNpc method (around line 1313). Currently it logs "Revealed NPC: {name}" which is GM-oriented. Change to player-facing announcement.

Update the AddLogEntry call:

```csharp
private async Task RevealNpc(GameMechanics.GamePlay.TableCharacterInfo npc)
{
    try
    {
        var character = await characterPortal.FetchAsync(npc.CharacterId);
        character.VisibleToPlayers = true;
        await characterPortal.UpdateAsync(character);

        // Activity log announcement - visible to players
        // Per CONTEXT.md: "[NPC Name] appears!" (name only, no disposition)
        AddLogEntry($"{npc.CharacterName} appears!", ActivityCategory.Announcement);

        // Publish update for real-time sync
        await TimeEventPublisher.PublishCharacterUpdateAsync(new CharacterUpdateMessage
        {
            CharacterId = npc.CharacterId,
            UpdateType = CharacterUpdateType.General,
            CampaignId = table!.Id.ToString(),
            Description = $"{npc.CharacterName} revealed to players"
        });

        await RefreshCharacterListAsync();
        StateHasChanged();
    }
    catch (Exception ex)
    {
        errorMessage = $"Failed to reveal NPC: {ex.Message}";
    }
}
```

The key change is the AddLogEntry line - use ActivityCategory.Announcement so it stands out, and the message format "[Name] appears!" per CONTEXT.md.
  </action>
  <verify>
Build compiles:
```bash
dotnet build Threa.sln
```
  </verify>
  <done>
RevealNpc publishes "[NPC Name] appears!" to activity log with Announcement category.
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: `dotnet build Threa.sln`
2. Manual testing:
   - GM creates and reveals NPC
   - Player sees "[NPC Name] appears!" in activity log
   - Player starts targeting an NPC
   - GM hides that NPC
   - Player's targeting modal closes, log shows "Target hidden - select a new target"
   - Player can select a different target
</verification>

<success_criteria>
- [ ] OnCharacterUpdateReceived refreshes tableCharacters on any character update
- [ ] Targeting invalidated when current target becomes hidden NPC
- [ ] RevealNpc logs "[NPC Name] appears!" with Announcement category
- [ ] Build compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/27-time-combat-integration/27-02-SUMMARY.md`
</output>
