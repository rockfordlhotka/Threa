---
phase: 27-time-combat-integration
plan: 02
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - Threa/Threa.Client/Components/Pages/GamePlay/Play.razor
  - Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
autonomous: false

must_haves:
  truths:
    - "Player's targeting is invalidated when GM hides their selected target"
    - "Activity log shows '[NPC Name] appears!' when GM reveals NPC"
    - "Target list refreshes when NPC visibility changes"
    - "Advancing time processes NPC effects same as PC effects"
    - "NPC AP recovers on round advancement according to standard rules"
    - "NPC wounds, effects, health pools update in real-time during time advancement"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/Play.razor"
      provides: "Target invalidation on visibility change"
      contains: "VisibleToPlayers"
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor"
      provides: "Reveal activity log message"
      contains: "appears!"
    - path: "GameMechanics/Time/TimeAdvancementService.cs"
      provides: "Time processing for all table characters (including NPCs)"
      contains: "GetTableCharactersAsync"
      note: "NO CHANGES NEEDED - already processes all characters"
  key_links:
    - from: "Play.razor OnCharacterUpdateReceived"
      to: "Target invalidation"
      via: "visibility check on current target"
      pattern: "VisibleToPlayers.*false"
    - from: "GmTable.razor RevealNpc"
      to: "ActivityLog"
      via: "Publish reveal message"
      pattern: "appears!"
    - from: "TimeAdvancementService.AdvanceRoundsAsync"
      to: "All TableCharacters"
      via: "GetTableCharactersAsync (no IsNpc filter)"
      pattern: "GetTableCharactersAsync"
      note: "CMBT-01/CMBT-03 satisfied by existing code"
---

<objective>
Complete NPC combat integration with target invalidation, reveal announcements, and time advancement verification.

Purpose: This plan adds polish from CONTEXT.md decisions: target invalidation when GM hides NPC mid-action, activity log announcement when NPC is revealed, and validates that NPCs participate in time advancement (CMBT-01, CMBT-03).

Output: Modified Play.razor with target invalidation handling, modified GmTable.razor with reveal activity log message, verification that time advancement processes NPCs.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-time-combat-integration/27-CONTEXT.md
@.planning/phases/27-time-combat-integration/27-RESEARCH.md
@.planning/phases/27-time-combat-integration/27-01-SUMMARY.md

Key files:
@Threa/Threa.Client/Components/Pages/GamePlay/Play.razor
@Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
@GameMechanics/Time/TimeAdvancementService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Target Invalidation on Visibility Change</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/Play.razor</files>
  <action>
Enhance OnCharacterUpdateReceived to refresh target list and invalidate targeting if current target becomes hidden.

Per CONTEXT.md: "If player is mid-action when GM hides target, action is invalidated - player picks new target."

1. Update OnCharacterUpdateReceived to handle all character updates (not just self):

Locate the existing OnCharacterUpdateReceived method. Currently it only handles updates to the player's own character. Expand it to also refresh tableCharacters when ANY character at the table changes.

```csharp
private void OnCharacterUpdateReceived(object? sender, CharacterUpdateMessage e)
{
    // Ignore events if component is disposed
    if (_disposed || table == null) return;

    _ = InvokeAsync(async () =>
    {
        try
        {
            // If this is our character, refresh it
            if (character != null && e.CharacterId == character.Id)
            {
                character = await characterPortal.FetchAsync(character.Id);
                await LoadEquippedItemsAsync();
            }

            // Always refresh table characters to catch NPC visibility changes
            await LoadTableCharactersAsync();

            // Check if we're in targeting and our target is no longer valid
            if (currentTargetingInteraction != null && showTargetingModal)
            {
                var targetId = currentTargetingInteraction.DefenderId;
                var target = tableCharacters.FirstOrDefault(c => c.CharacterId == targetId);

                // Target invalid if: not found, or is NPC that's now hidden
                bool targetInvalid = target == null ||
                    (target.IsNpc && !target.VisibleToPlayers);

                if (targetInvalid)
                {
                    // Cancel the targeting interaction
                    await TargetingManager.CancelAsync(
                        currentTargetingInteraction.InteractionId,
                        "Target is no longer available");

                    // Show toast notification to player
                    // Use DialogService or just close the modal with a message
                    showTargetingModal = false;
                    currentTargetingInteraction = null;

                    // Log the invalidation for the player
                    AddLogEntry("Target hidden - select a new target", ActivityCategory.Combat);
                }
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error processing character update: {ex.Message}";
            StateHasChanged();
        }
    });
}
```

Note: The method currently checks `e.CharacterId != character.Id` to early-return. Remove that check so ALL character updates trigger a refresh of tableCharacters.
  </action>
  <verify>
Build compiles:
```bash
dotnet build Threa.sln
```
  </verify>
  <done>
OnCharacterUpdateReceived refreshes tableCharacters on any character update and invalidates targeting if current target is now hidden.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Reveal Activity Log Message</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor</files>
  <action>
Update RevealNpc method to publish player-visible activity log message when NPC is revealed.

Per CONTEXT.md: "When GM reveals an NPC, activity log entry: '[NPC Name] appears!' (name only, no disposition text)."

Find the existing RevealNpc method (around line 1313). Currently it logs "Revealed NPC: {name}" which is GM-oriented. Change to player-facing announcement.

Update the AddLogEntry call:

```csharp
private async Task RevealNpc(GameMechanics.GamePlay.TableCharacterInfo npc)
{
    try
    {
        var character = await characterPortal.FetchAsync(npc.CharacterId);
        character.VisibleToPlayers = true;
        await characterPortal.UpdateAsync(character);

        // Activity log announcement - visible to players
        // Per CONTEXT.md: "[NPC Name] appears!" (name only, no disposition)
        AddLogEntry($"{npc.CharacterName} appears!", ActivityCategory.Announcement);

        // Publish update for real-time sync
        await TimeEventPublisher.PublishCharacterUpdateAsync(new CharacterUpdateMessage
        {
            CharacterId = npc.CharacterId,
            UpdateType = CharacterUpdateType.General,
            CampaignId = table!.Id.ToString(),
            Description = $"{npc.CharacterName} revealed to players"
        });

        await RefreshCharacterListAsync();
        StateHasChanged();
    }
    catch (Exception ex)
    {
        errorMessage = $"Failed to reveal NPC: {ex.Message}";
    }
}
```

The key change is the AddLogEntry line - use ActivityCategory.Announcement so it stands out, and the message format "[Name] appears!" per CONTEXT.md.
  </action>
  <verify>
Build compiles:
```bash
dotnet build Threa.sln
```
  </verify>
  <done>
RevealNpc publishes "[NPC Name] appears!" to activity log with Announcement category.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify NPC Time Advancement (CMBT-01, CMBT-03)</name>
  <what-built>
This task validates that NPCs participate in time advancement. Per RESEARCH.md, TimeAdvancementService.AdvanceRoundsAsync() already processes ALL table characters (including NPCs) without filtering. The code at lines 118-126 shows:

```csharp
var tableCharacters = await _tableDal.GetTableCharactersAsync(tableId);
foreach (var tc in tableCharacters)
{
    var character = await _characterPortal.FetchAsync(tc.CharacterId);
    character.EndOfRound(_effectPortal);
    await _characterPortal.UpdateAsync(character);
}
```

Since NPCs use CharacterEdit (same as PCs), they already receive end-of-round processing. This checkpoint verifies the existing implementation works as expected.
  </what-built>
  <how-to-verify>
1. Run the application: `dotnet run --project Threa/Threa`
2. Open GM dashboard for an active table
3. Spawn a hostile NPC from template (use "Spawn NPC" button)
4. Note the NPC's current AP (should be max based on stats)
5. Use GM Actions modal to spend some of the NPC's AP (apply Fatigue or use actions)
6. Verify AP is less than maximum
7. On GM dashboard, advance 1 round using "Advance Round" button
8. Verify NPC's AP recovers (increases toward max, per standard AP recovery rules)
9. Apply a timed effect to the NPC (e.g., a 2-round buff via GM Actions)
10. Advance 2 rounds
11. Verify the effect expires on the NPC (disappears from active effects)
12. OPTIONAL: Test with hidden NPC - spawn hidden, advance rounds, reveal and verify state changed

Expected behavior:
- NPC AP recovery identical to PC AP recovery
- NPC effect expiration identical to PC effect expiration
- Hidden NPCs still process (time affects them even when not visible)
  </how-to-verify>
  <resume-signal>Type "verified" if NPC time advancement works correctly, or describe any issues observed</resume-signal>
</task>

</tasks>

<verification>
1. Build succeeds: `dotnet build Threa.sln`
2. Manual testing - target invalidation:
   - GM creates and reveals NPC
   - Player sees "[NPC Name] appears!" in activity log
   - Player starts targeting an NPC
   - GM hides that NPC
   - Player's targeting modal closes, log shows "Target hidden - select a new target"
   - Player can select a different target
3. Manual testing - time advancement (CMBT-01, CMBT-03):
   - Spawn NPC, spend some AP
   - Advance round, verify AP recovery
   - Apply timed effect to NPC
   - Advance rounds, verify effect expires
   - Verify hidden NPCs also process time (reveal shows updated state)
4. Verify all phase success criteria from ROADMAP.md:
   - [ ] Advancing time processes NPC effects same as PC effects (expiration, stacking)
   - [ ] NPC AP recovers on round advancement according to standard rules
   - [ ] NPC wounds, effects, health pools update in real-time during time advancement
</verification>

<success_criteria>
- [ ] OnCharacterUpdateReceived refreshes tableCharacters on any character update
- [ ] Targeting invalidated when current target becomes hidden NPC
- [ ] RevealNpc logs "[NPC Name] appears!" with Announcement category
- [ ] Build compiles without errors
- [ ] CMBT-01 verified: NPCs participate in round/time advancement
- [ ] CMBT-03 verified: Time advancement applies to NPCs same as PCs
- [ ] Phase success criterion 1: NPC effects process on time advancement
- [ ] Phase success criterion 2: NPC AP recovers on round advancement
- [ ] Phase success criterion 5: NPC wounds/effects/health update during time advancement
</success_criteria>

<output>
After completion, create `.planning/phases/27-time-combat-integration/27-02-SUMMARY.md`
</output>
