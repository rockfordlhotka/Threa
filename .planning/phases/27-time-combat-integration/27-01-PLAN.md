---
phase: 27-time-combat-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Threa/Threa.Client/Components/Pages/GamePlay/Play.razor
  - Threa/Threa.Client/Components/Pages/GamePlay/Targeting/TargetSelectionModal.razor
autonomous: true

must_haves:
  truths:
    - "Visible NPCs appear in target dropdown when player initiates attack"
    - "NPCs are grouped by disposition (Hostile/Neutral/Friendly) in target list"
    - "Each NPC shows disposition icon matching GM dashboard styling"
    - "Hidden NPCs do not appear in target list"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/Play.razor"
      provides: "Target loading via TableCharacterList with visibility filtering"
      contains: "characterListPortal"
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/Targeting/TargetSelectionModal.razor"
      provides: "Grouped target list with disposition icons"
      contains: "NpcDisposition"
  key_links:
    - from: "Play.razor"
      to: "TableCharacterList"
      via: "characterListPortal.FetchAsync"
      pattern: "characterListPortal\\.FetchAsync"
    - from: "TargetSelectionModal.razor"
      to: "TargetInfo.Disposition"
      via: "disposition grouping"
      pattern: "Disposition.*Hostile"
---

<objective>
Enable players to target visible NPCs during combat actions.

Purpose: This completes CMBT-02 (NPCs can be targeted by combat actions) by integrating NPCs into the targeting system. Players see visible NPCs in the target dropdown, grouped by disposition for quick identification.

Output: Modified Play.razor and TargetSelectionModal.razor with NPC targeting support.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-time-combat-integration/27-CONTEXT.md
@.planning/phases/27-time-combat-integration/27-RESEARCH.md

Key files:
@Threa/Threa.Client/Components/Pages/GamePlay/Play.razor
@Threa/Threa.Client/Components/Pages/GamePlay/Targeting/TargetSelectionModal.razor
@GameMechanics/GamePlay/TableCharacterList.cs
@GameMechanics/GamePlay/TableCharacterInfo.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Play.razor to Load Targets via TableCharacterList</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/Play.razor</files>
  <action>
Replace the raw DAL-based target loading with CSLA TableCharacterList for NPC support.

1. Add inject for TableCharacterList portal:
```csharp
@inject IDataPortal<GameMechanics.GamePlay.TableCharacterList> characterListPortal
```

2. Add using for NpcDisposition:
```csharp
@using Threa.Dal.Dto
```
(NpcDisposition enum is in Threa.Dal.Dto namespace)

3. Change the tableCharacters field from raw DTO to CSLA objects:
```csharp
// Old:
private List<Threa.Dal.Dto.TableCharacter> tableCharacters = new();

// New:
private List<GameMechanics.GamePlay.TableCharacterInfo> tableCharacters = new();
```

4. Update LoadTableCharactersAsync to use CSLA portal:
```csharp
private async Task LoadTableCharactersAsync()
{
    if (table == null) return;
    var charList = await characterListPortal.FetchAsync(table.Id);
    tableCharacters = charList.ToList();
}
```

5. Update GetAvailableTargets to filter visible NPCs and populate Disposition:
```csharp
public List<TargetSelectionModal.TargetInfo> GetAvailableTargets()
{
    if (table == null || character == null)
        return new List<TargetSelectionModal.TargetInfo>();

    return tableCharacters
        .Where(c => c.CharacterId != character.Id)
        .Where(c => !c.IsNpc || c.VisibleToPlayers) // PCs always visible, NPCs only if revealed
        .Select(c => new TargetSelectionModal.TargetInfo
        {
            CharacterId = c.CharacterId,
            CharacterName = c.CharacterName,
            PlayerName = c.IsNpc ? null : "Player",
            IsNPC = c.IsNpc,
            Disposition = c.Disposition
        })
        .ToList();
}
```

Note: The Disposition property will be added to TargetInfo in Task 2. Order is important - this task creates the data source, Task 2 updates the UI to use it.
  </action>
  <verify>
Build compiles without errors:
```bash
dotnet build Threa.sln
```
  </verify>
  <done>
Play.razor uses TableCharacterList for target loading with IsNpc and VisibleToPlayers filtering. GetAvailableTargets returns targets with Disposition populated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance TargetSelectionModal with Disposition Grouping</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/Targeting/TargetSelectionModal.razor</files>
  <action>
Add disposition property to TargetInfo and implement NPC-first grouped display.

1. Add using for NpcDisposition at top of file:
```csharp
@using Threa.Dal.Dto
```

2. Add Disposition property to TargetInfo class:
```csharp
public class TargetInfo
{
    public int CharacterId { get; init; }
    public string CharacterName { get; init; } = string.Empty;
    public string? PlayerName { get; init; }
    public bool IsNPC { get; init; }
    public NpcDisposition Disposition { get; init; }  // ADD THIS
}
```

3. Replace the simple foreach list with grouped display. Per CONTEXT.md: NPCs first (grouped by disposition), then PCs below. Use Bootstrap list-group styling:

```razor
@if (AvailableTargets == null || !AvailableTargets.Any())
{
    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle"></i> No valid targets available at this table.
    </div>
}
else
{
    <div class="list-group">
        @{
            var npcs = AvailableTargets.Where(t => t.IsNPC).ToList();
            var pcs = AvailableTargets.Where(t => !t.IsNPC).ToList();
        }

        @* NPCs Section - Hostile first, then Neutral, then Friendly *@
        @foreach (var target in npcs.Where(n => n.Disposition == NpcDisposition.Hostile))
        {
            <button type="button"
                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center @(selectedTargetId == target.CharacterId ? "active" : "")"
                    @onclick="() => SelectTarget(target)">
                <div>
                    <i class="bi bi-skull text-danger me-1" title="Hostile"></i>
                    <strong>@target.CharacterName</strong>
                </div>
                <span class="badge bg-secondary">NPC</span>
            </button>
        }
        @foreach (var target in npcs.Where(n => n.Disposition == NpcDisposition.Neutral))
        {
            <button type="button"
                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center @(selectedTargetId == target.CharacterId ? "active" : "")"
                    @onclick="() => SelectTarget(target)">
                <div>
                    <i class="bi bi-circle text-secondary me-1" title="Neutral"></i>
                    <strong>@target.CharacterName</strong>
                </div>
                <span class="badge bg-secondary">NPC</span>
            </button>
        }
        @foreach (var target in npcs.Where(n => n.Disposition == NpcDisposition.Friendly))
        {
            <button type="button"
                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center @(selectedTargetId == target.CharacterId ? "active" : "")"
                    @onclick="() => SelectTarget(target)">
                <div>
                    <i class="bi bi-heart text-success me-1" title="Friendly"></i>
                    <strong>@target.CharacterName</strong>
                </div>
                <span class="badge bg-secondary">NPC</span>
            </button>
        }

        @* Divider between NPCs and PCs if both exist *@
        @if (npcs.Any() && pcs.Any())
        {
            <div class="list-group-item bg-secondary text-white py-1">
                <small>Players</small>
            </div>
        }

        @* PCs Section *@
        @foreach (var target in pcs)
        {
            <button type="button"
                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center @(selectedTargetId == target.CharacterId ? "active" : "")"
                    @onclick="() => SelectTarget(target)">
                <div>
                    <strong>@target.CharacterName</strong>
                    @if (!string.IsNullOrEmpty(target.PlayerName))
                    {
                        <small class="text-muted d-block">(@target.PlayerName)</small>
                    }
                </div>
                <span class="badge bg-primary">PC</span>
            </button>
        }
    </div>
}
```

Icons match GmTable.razor dashboard styling: skull (Hostile), circle (Neutral), heart (Friendly).
  </action>
  <verify>
Build compiles without errors:
```bash
dotnet build Threa.sln
```
  </verify>
  <done>
TargetSelectionModal displays NPCs first (grouped by Hostile/Neutral/Friendly), each with disposition icon matching GM dashboard, followed by PCs section. TargetInfo class has Disposition property.
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: `dotnet build Threa.sln`
2. Run application and test:
   - GM spawns visible NPCs at table
   - Player opens combat tab, initiates attack
   - Target modal shows NPCs first with disposition icons
   - NPCs grouped: Hostile (skull), Neutral (circle), Friendly (heart)
   - Hidden NPCs do not appear in list
   - PCs appear in separate section below NPCs
</verification>

<success_criteria>
- [ ] Play.razor uses TableCharacterList via CSLA portal (not raw DAL)
- [ ] GetAvailableTargets filters out hidden NPCs (VisibleToPlayers = false)
- [ ] TargetInfo has Disposition property
- [ ] Target modal shows NPCs first, grouped by disposition
- [ ] Disposition icons match GM dashboard (skull/circle/heart)
- [ ] Build compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/27-time-combat-integration/27-01-SUMMARY.md`
</output>
