---
phase: 33-attack-actions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor
  - Threa/Threa.Client/Components/Pages/GamePlay/AttackMode.razor
autonomous: true

must_haves:
  truths:
    - "Ranged button shows tooltip 'No ranged weapon equipped' when disabled due to no ranged weapon"
    - "Player clicking melee Attack button sees a target selection step with 'Anonymous Target' as an option"
    - "After selecting Anonymous Target, the existing melee attack setup flow (skill, cost, boost, options, roll) proceeds unchanged"
    - "Solo melee attack result displays AV to the player (already works — no regression)"
    - "Anonymous melee attack result logs to the activity feed"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor"
      provides: "Ranged button tooltip when no ranged weapon equipped"
      contains: "No ranged weapon equipped"
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/AttackMode.razor"
      provides: "Target selection step with Anonymous Target option before melee attack setup"
      contains: "Anonymous Target"
  key_links:
    - from: "TabCombat.razor"
      to: "AttackMode.razor"
      via: "CombatMode.Attack renders AttackMode with existing parameters"
      pattern: "combatMode == CombatMode.Attack"
    - from: "AttackMode.razor target selection"
      to: "AttackMode.razor existing setup flow"
      via: "targetSelected boolean gates existing flow"
      pattern: "targetSelected"
---

<objective>
Wire the melee attack button's anonymous target support and fix the ranged button tooltip.

Purpose: Enables solo melee attacks with AV display by adding target selection as the first step in AttackMode. Also adds the "No ranged weapon equipped" tooltip to the ranged button for better UX.

Output: Modified TabCombat.razor (tooltip) and AttackMode.razor (target selection step).
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-attack-actions/33-CONTEXT.md
@.planning/phases/33-attack-actions/33-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ranged button tooltip and wire target selection into AttackMode</name>
  <files>
    Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor
    Threa/Threa.Client/Components/Pages/GamePlay/AttackMode.razor
  </files>
  <action>
**TabCombat.razor** — One small change:

1. On the Ranged button (currently around line 162-168), change the `title` attribute to conditionally show "No ranged weapon equipped" when `!hasRangedWeaponEquipped`, otherwise show "Ranged attack". Use a ternary: `title="@(!hasRangedWeaponEquipped ? "No ranged weapon equipped" : "Ranged attack")"`.

No other changes to TabCombat.razor — the melee Attack button already correctly calls `StartAttack()` which sets `combatMode = CombatMode.Attack` and renders AttackMode.razor with the existing parameters.

**AttackMode.razor** — Add target selection as the FIRST step, gating the existing setup flow:

1. Add a `bool targetSelected = false;` field and a `bool isAnonymousTarget = false;` field in the `@code` block.

2. Wrap the existing `@if (!hasRolled)` / `else` block inside a new outer conditional:
   - If `!targetSelected`: show a target selection card as the first thing (right below the header/cancel bar).
   - If `targetSelected`: show the existing `@if (!hasRolled)` / `else` flow unchanged.

3. Target selection card content:
   - Card header: "Select Target"
   - Card body: A `list-group` with a single button for now:
     - Button text: "Anonymous Target" with icon `bi-question-circle` and small muted text: "Solo attack — AV displayed after rolling"
     - On click: sets `targetSelected = true` and `isAnonymousTarget = true`
   - This is the "future-proof" spot where real targets from `AvailableTargets` would go (but don't add that now — just the anonymous option).

4. When anonymous target is selected, the existing flow proceeds exactly as today. The AV is already displayed in the results section (line 191-195 shows "Attack Value (AV): @attackResult.AV"). No changes needed to the result display for melee anonymous targets.

5. In the `CompleteAttack()` method, if `isAnonymousTarget`, adjust the activity log message to indicate it was against an anonymous target. Change the message to: `$"{Character?.Name} attacks with {attackResult.SkillName} vs anonymous target: AV {attackResult.AV}"` when `isAnonymousTarget` is true. Keep the existing message format when it's not anonymous.

6. In `ResetAttack()`, do NOT reset `targetSelected` or `isAnonymousTarget` — "New Attack" should stay on the same target (existing behavior keeps the mode). But add a "Back to Targets" or "Change Target" button in the results footer (alongside Done and New Attack) that resets both `targetSelected = false`, `isAnonymousTarget = false`, and calls `ResetAttack()`.

7. Ensure the Cancel button (already in the header) continues to call `OnCancel` which returns to TabCombat default mode — no change needed there.

**Important constraints:**
- Do NOT modify the `ExecuteAttack()` method — costs, dice rolling, physicality check all proceed identically for anonymous targets.
- Do NOT modify the attack summary card or the roll breakdown display.
- Do NOT add any new parameters to AttackMode — it receives everything it needs from TabCombat already.
  </action>
  <verify>
    Build the solution with `dotnet build Threa.sln` from the project root. Verify zero build errors.
  </verify>
  <done>
    - TabCombat ranged button shows "No ranged weapon equipped" tooltip when disabled
    - AttackMode shows target selection as first step with "Anonymous Target" option
    - After selecting Anonymous Target, existing melee attack flow (skill, cost, boost, roll, AV result) works unchanged
    - Activity log message includes "vs anonymous target" for anonymous attacks
    - "Change Target" button in results allows going back to target selection
    - Build succeeds with zero errors
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Threa.sln` — zero errors
2. Visual inspection: AttackMode.razor has a `targetSelected` gating variable that wraps the existing flow
3. Grep for "Anonymous Target" in AttackMode.razor — should find the target selection card
4. Grep for "No ranged weapon equipped" in TabCombat.razor — should find the tooltip
5. The existing `@if (!hasRolled)` / `else` block is preserved inside the `@if (targetSelected)` wrapper
</verification>

<success_criteria>
- Build passes
- Melee attack flow has target selection as first step
- Anonymous Target option is present and functional
- Ranged button tooltip shows "No ranged weapon equipped" when disabled
- Existing melee attack flow (skill/cost/boost/roll/result with AV) is unchanged after target selection
</success_criteria>

<output>
After completion, create `.planning/phases/33-attack-actions/33-01-SUMMARY.md`
</output>
