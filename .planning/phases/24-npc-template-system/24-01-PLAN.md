---
phase: 24-npc-template-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Threa.Dal/Dto/NpcDisposition.cs
  - Threa.Dal/Dto/Character.cs
  - Threa.Dal/ICharacterDal.cs
  - Threa.Dal.SqlLite/CharacterDal.cs
  - GameMechanics/CharacterEdit.cs
  - GameMechanics.Test/CharacterTests.cs
autonomous: true

must_haves:
  truths:
    - "Character DTO can store template organization data (category, tags, notes, disposition)"
    - "CharacterEdit business object exposes template properties with CSLA pattern"
    - "Difficulty rating is calculated from combat AS values"
    - "DAL can retrieve distinct NPC template categories"
  artifacts:
    - path: "Threa.Dal/Dto/NpcDisposition.cs"
      provides: "Enum for NPC default attitude"
      contains: "public enum NpcDisposition"
    - path: "Threa.Dal/Dto/Character.cs"
      provides: "Template organization properties"
      contains: "Category"
    - path: "GameMechanics/CharacterEdit.cs"
      provides: "CSLA properties for template fields"
      contains: "CategoryProperty"
  key_links:
    - from: "GameMechanics/CharacterEdit.cs"
      to: "Threa.Dal/Dto/Character.cs"
      via: "CSLA DataMapper in Fetch/Insert/Update"
      pattern: "DataMapper\\.Map"
    - from: "Threa.Dal.SqlLite/CharacterDal.cs"
      to: "ICharacterDal.cs"
      via: "Interface implementation"
      pattern: "GetNpcCategoriesAsync"
---

<objective>
Extend the Character data model with template-specific properties for organizing NPC templates.

Purpose: Templates need category, tags, notes, default disposition, and difficulty rating to enable the library organization features (TMPL-05). This foundation supports all subsequent UI work.

Output: Extended Character DTO and CharacterEdit business object with template properties, plus DAL method for category retrieval.
</objective>

<execution_context>
@S:\src\rdl\threa\.planning\workflows\execute-plan.md
@S:\src\rdl\threa\.planning\templates\summary.md
</execution_context>

<context>
@S:\src\rdl\threa\.planning\PROJECT.md
@S:\src\rdl\threa\.planning\ROADMAP.md
@S:\src\rdl\threa\.planning\phases\24-npc-template-system\24-CONTEXT.md
@S:\src\rdl\threa\.planning\phases\24-npc-template-system\24-RESEARCH.md
@S:\src\rdl\threa\Threa.Dal\Dto\Character.cs
@S:\src\rdl\threa\GameMechanics\CharacterEdit.cs
@S:\src\rdl\threa\Threa.Dal\ICharacterDal.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NpcDisposition enum and Character DTO properties</name>
  <files>
    Threa.Dal/Dto/NpcDisposition.cs
    Threa.Dal/Dto/Character.cs
  </files>
  <action>
Create NpcDisposition.cs enum in Threa.Dal/Dto with values:
- Hostile = 0 (default for enemies)
- Neutral = 1 (non-combatants, potential allies)
- Friendly = 2 (allies, helpers)

Add template organization properties to Character.cs:
- string? Category - folder-like grouping (e.g., "Humanoids", "Beasts")
- string? Tags - comma-separated tags for filtering (e.g., "minion,melee")
- string? TemplateNotes - GM notes about template usage
- NpcDisposition DefaultDisposition - default attitude, defaults to Hostile
- int DifficultyRating - auto-calculated threat level

Follow existing property patterns in Character.cs (simple auto-properties with defaults).
  </action>
  <verify>
Build succeeds: `dotnet build Threa.Dal/Threa.Dal.csproj`
  </verify>
  <done>
NpcDisposition enum exists with 3 values. Character DTO has 5 new template properties.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CharacterEdit CSLA properties and difficulty calculation</name>
  <files>
    GameMechanics/CharacterEdit.cs
  </files>
  <action>
Add CSLA-managed properties to CharacterEdit.cs following existing PropertyInfo pattern:

1. Category property (string, nullable):
   - public static readonly PropertyInfo<string?> CategoryProperty = RegisterProperty<string?>(nameof(Category));
   - Use SetProperty for setter (track dirty state)

2. Tags property (string, nullable):
   - Same pattern as Category

3. TemplateNotes property (string, nullable):
   - Same pattern as Category

4. DefaultDisposition property (NpcDisposition):
   - Default to NpcDisposition.Hostile
   - Use SetProperty for setter

5. DifficultyRating property (int):
   - ReadOnly getter backed by LoadProperty (calculated, not user-set)

6. CalculateDifficultyRating() method:
   - Average combat AS values (skills with IsCombatSkill or containing "Combat", "Melee", "Ranged", "Firearms", "Archery")
   - Add health modifier: (Fatigue.BaseValue + Vitality.BaseValue) / 10
   - Subtract 10 to normalize around 0-10 range
   - Return Math.Max(1, result) to ensure minimum of 1

7. Add new properties to mapIgnore array to handle them in Fetch/Insert/Update:
   - Actually DON'T add to mapIgnore - let DataMapper handle them automatically

Add using statement for Threa.Dal.Dto if not present (for NpcDisposition).
  </action>
  <verify>
Build succeeds: `dotnet build GameMechanics/GameMechanics.csproj`
  </verify>
  <done>
CharacterEdit has Category, Tags, TemplateNotes, DefaultDisposition, DifficultyRating properties with CSLA pattern. CalculateDifficultyRating method implemented.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add GetNpcCategoriesAsync to DAL with unit tests</name>
  <files>
    Threa.Dal/ICharacterDal.cs
    Threa.Dal.SqlLite/CharacterDal.cs
    GameMechanics.Test/CharacterTests.cs
  </files>
  <action>
1. Add to ICharacterDal.cs:
   Task<List<string>> GetNpcCategoriesAsync();

2. Implement in Threa.Dal.SqlLite/CharacterDal.cs:
   - Call GetNpcTemplatesAsync() (already exists from Phase 23)
   - Filter to non-null/non-empty Category values
   - Return distinct, ordered list

3. Add unit tests in CharacterTests.cs:
   - Test_TemplateCategory_PersistsThroughSaveFetch: Create character with IsNpc=true, IsTemplate=true, Category="Beasts", save, fetch, verify Category
   - Test_TemplateTags_PersistsThroughSaveFetch: Same pattern for Tags
   - Test_TemplateNotes_PersistsThroughSaveFetch: Same pattern for TemplateNotes
   - Test_DefaultDisposition_PersistsThroughSaveFetch: Same pattern for DefaultDisposition
   - Test_DifficultyRating_CalculatesFromCombatSkills: Create character with skills, call CalculateDifficultyRating, verify reasonable value

Follow existing test patterns in CharacterTests.cs.
  </action>
  <verify>
All tests pass: `dotnet test GameMechanics.Test/GameMechanics.Test.csproj --filter "FullyQualifiedName~Template"`
Full test suite: `dotnet test GameMechanics.Test/GameMechanics.Test.csproj --filter "FullyQualifiedName~CharacterTests"`
  </verify>
  <done>
GetNpcCategoriesAsync defined in interface and implemented in SQLite DAL. 5 new unit tests pass verifying template property persistence and difficulty calculation.
  </done>
</task>

</tasks>

<verification>
1. Build entire solution: `dotnet build Threa.sln`
2. Run character tests: `dotnet test GameMechanics.Test/GameMechanics.Test.csproj --filter "FullyQualifiedName~CharacterTests"`
3. All tests pass (existing + new template tests)
</verification>

<success_criteria>
- NpcDisposition enum with Hostile/Neutral/Friendly values
- Character DTO has Category, Tags, TemplateNotes, DefaultDisposition, DifficultyRating
- CharacterEdit has corresponding CSLA properties
- CalculateDifficultyRating method returns sensible values
- GetNpcCategoriesAsync extracts distinct categories from templates
- All existing CharacterTests pass (no regressions)
- 5 new template property tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/24-npc-template-system/24-01-SUMMARY.md`
</output>
