---
phase: 24-npc-template-system
plan: 04
type: execute
wave: 3
depends_on: ["24-02"]
files_modified:
  - Threa/Threa.Client/Components/Pages/GameMaster/NpcTemplateEdit.razor
autonomous: true

must_haves:
  truths:
    - "GM can create new NPC templates from scratch"
    - "GM can edit existing NPC template properties"
    - "GM can use existing character tabs for attributes, skills, equipment"
    - "GM can deactivate templates (soft delete)"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/GameMaster/NpcTemplateEdit.razor"
      provides: "Template editor with tabs and save functionality"
      contains: "@page \"/gamemaster/templates/{Id}\""
      min_lines: 150
  key_links:
    - from: "NpcTemplateEdit.razor"
      to: "CharacterEdit"
      via: "IDataPortal Create/Fetch"
      pattern: "IDataPortal<CharacterEdit>"
    - from: "NpcTemplateEdit.razor"
      to: "TabAttributes.razor"
      via: "Component reference"
      pattern: "<TabAttributes"
---

<objective>
Create the NPC Template Editor page for creating and editing templates.

Purpose: GMs need to create new templates and edit existing ones (TMPL-01, TMPL-02, TMPL-04). The editor reuses existing character tabs for attributes, skills, and equipment to maintain full feature parity.

Output: Complete template editor with template-specific metadata tab plus character stat tabs.
</objective>

<execution_context>
@S:\src\rdl\threa\.planning\workflows\execute-plan.md
@S:\src\rdl\threa\.planning\templates\summary.md
</execution_context>

<context>
@S:\src\rdl\threa\.planning\PROJECT.md
@S:\src\rdl\threa\.planning\ROADMAP.md
@S:\src\rdl\threa\.planning\phases\24-npc-template-system\24-CONTEXT.md
@S:\src\rdl\threa\.planning\phases\24-npc-template-system\24-RESEARCH.md
@S:\src\rdl\threa\Threa\Threa.Client\Components\Pages\GameMaster\ItemEdit.razor
@S:\src\rdl\threa\Threa\Threa.Client\Components\Pages\Character\CharacterEdit.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NpcTemplateEdit.razor with template info tab</name>
  <files>
    Threa/Threa.Client/Components/Pages/GameMaster/NpcTemplateEdit.razor
  </files>
  <action>
Create NpcTemplateEdit.razor following ItemEdit.razor and CharacterEdit.razor patterns:

Page routes:
- @page "/gamemaster/templates/{Id}"
- @page "/gamemaster/templates/new"
- @rendermode InteractiveServer
- @attribute [Authorize(Roles = "GameMaster,Administrator")]

Inject services:
- IDataPortal<CharacterEdit> characterPortal
- IDataPortal<NpcTemplateList> templateListPortal (for category autocomplete)
- ViewModel<CharacterEdit> vm
- NavigationManager
- Threa.Services.RenderModeProvider

Header section:
- Title: "Create NPC Template" or "Edit: {vm.Model?.Name}"
- Status badge: Active/Inactive
- Back link to /gamemaster/templates

RadzenTabs structure:
1. "Template Info" tab - template-specific metadata
2. "Attributes" tab - <TabAttributes vm="vm" />
3. "Skills" tab - <TabSkills vm="vm" />
4. "Equipment" tab - <TabItems vm="vm" />

Template Info tab content (table layout like ItemEdit):
- Name: TextInputRow (required)
- Species: RadzenDropDown bound to species list OR text input
- Category: RadzenTextBox with autocomplete from existing categories
  - Use RadzenAutoComplete or simple text with datalist
- Tags: Tag chips UI from ItemEdit.razor pattern
  - Display existing tags as badges with remove button
  - Input for adding new tags
  - Enter key adds tag
- Notes: RadzenTextArea for TemplateNotes
- Default Disposition: RadzenDropDown with NpcDisposition enum values
- Difficulty Rating: Read-only display with calculated value
  - Show breakdown on hover/click if possible

Sticky save/cancel bar:
- Save button: disabled when !vm.Model.IsSavable
- Cancel button: navigates back to /gamemaster/templates
- Deactivate button (for existing templates only): toggles VisibleToPlayers to false

@code block:
- [Parameter] public string? Id { get; set; }
- IsNewTemplate computed property
- Category autocomplete data (from fetched template list)
- Tag management (tagList, newTagInput, AddTag, RemoveTag, OnTagKeyDown)
- OnInitializedAsync:
  - If new: Create character with IsNpc=true, IsTemplate=true
  - If edit: Fetch character by Id
  - Load categories from existing templates
- SaveData: Save and navigate back
- Cancel: Navigate back
- Deactivate: Set VisibleToPlayers=false and save

Important: When creating new template, must set:
- IsNpc = true
- IsTemplate = true
- VisibleToPlayers = true (active by default)

Use the ViewModel pattern from ItemEdit.razor:
- vm.Saved += () => NavigationManager.NavigateTo("/gamemaster/templates")
- vm.ModelChanged and vm.ModelPropertyChanged for state updates
  </action>
  <verify>
Build succeeds: `dotnet build Threa/Threa.csproj`
  </verify>
  <done>
NpcTemplateEdit.razor exists with Template Info tab, Attributes/Skills/Equipment tabs (reusing existing components), save/cancel/deactivate buttons.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add clone modal functionality</name>
  <files>
    Threa/Threa.Client/Components/Pages/GameMaster/NpcTemplateEdit.razor
  </files>
  <action>
Add clone functionality to NpcTemplateEdit.razor (can also be triggered from NpcTemplates.razor "Clone From..." button):

1. Add clone route parameter:
   - @page "/gamemaster/templates/clone/{SourceId:int}"

2. Clone state variables:
   - bool isCloning - true when creating from clone
   - int? cloneSourceId

3. Clone initialization in OnInitializedAsync:
   - If route is /clone/{id}, fetch source character
   - Create new template
   - Copy attributes: loop through source.AttributeList, match by Name, copy BaseValue
   - Copy skills: loop through source.Skills, match by Name, copy Level
   - Set default name: "{source.Name} (Template)"
   - Per CONTEXT.md: Do NOT copy equipment or notes
   - Set IsNpc=true, IsTemplate=true, VisibleToPlayers=true

4. Update NpcTemplates.razor "Clone From..." button:
   - Show modal with character/template search
   - OR simpler: Navigate to /gamemaster/templates/clone/{selectedId}
   - For now, can be a placeholder that shows alert("Clone functionality coming")
   - Or implement simple version: dropdown of existing characters + templates

Clone modal (if implementing full version):
- RadzenDialog or custom modal
- Search/filter existing characters and templates
- Show list with Name, Species, Type (PC/NPC/Template)
- Click to select, then "Clone" button creates from that source

Simpler approach for this task:
- Just handle the /clone/{id} route
- Clone button in NpcTemplates.razor can come in Plan 05 polish
  </action>
  <verify>
Build succeeds: `dotnet build Threa/Threa.csproj`
Navigate to /gamemaster/templates/clone/1 (with valid character ID) creates pre-filled template
  </verify>
  <done>
Clone route /gamemaster/templates/clone/{SourceId} works. New template is pre-filled with source character's attributes and skills.
  </done>
</task>

</tasks>

<verification>
1. Build solution: `dotnet build Threa.sln`
2. Run application and test:
   - /gamemaster/templates/new shows create form with empty fields
   - All tabs display correctly (Template Info, Attributes, Skills, Equipment)
   - Save creates new template with IsNpc=true, IsTemplate=true
   - Edit existing template loads all fields
   - Deactivate sets template as inactive
   - Clone route pre-fills from source character
</verification>

<success_criteria>
- NpcTemplateEdit.razor handles /gamemaster/templates/{Id}, /new, and /clone/{SourceId}
- Template Info tab shows Name, Species, Category, Tags, Notes, Disposition, Difficulty
- Character tabs (Attributes, Skills, Equipment) are reused unchanged
- Tags managed with chip UI (add/remove)
- Save persists template with correct flags
- Deactivate sets VisibleToPlayers=false
- Clone copies attributes and skills but not equipment/notes
</success_criteria>

<output>
After completion, create `.planning/phases/24-npc-template-system/24-04-SUMMARY.md`
</output>
