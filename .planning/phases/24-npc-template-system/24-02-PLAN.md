---
phase: 24-npc-template-system
plan: 02
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - GameMechanics/NpcTemplateInfo.cs
  - GameMechanics/NpcTemplateList.cs
  - GameMechanics.Test/NpcTemplateTests.cs
autonomous: true

must_haves:
  truths:
    - "NPC template list can be fetched through CSLA data portal"
    - "Template info includes all fields needed for library display"
    - "TagList computed property splits comma-separated tags"
  artifacts:
    - path: "GameMechanics/NpcTemplateInfo.cs"
      provides: "ReadOnlyBase for template list items"
      contains: "ReadOnlyBase<NpcTemplateInfo>"
    - path: "GameMechanics/NpcTemplateList.cs"
      provides: "ReadOnlyListBase for template collection"
      contains: "ReadOnlyListBase<NpcTemplateList, NpcTemplateInfo>"
  key_links:
    - from: "GameMechanics/NpcTemplateList.cs"
      to: "ICharacterDal.GetNpcTemplatesAsync"
      via: "CSLA Fetch operation"
      pattern: "dal\\.GetNpcTemplatesAsync"
    - from: "GameMechanics/NpcTemplateInfo.cs"
      to: "Threa.Dal.Dto.Character"
      via: "FetchChild mapping"
      pattern: "FetchChild.*Character"
---

<objective>
Create CSLA business objects for browsing NPC templates in the library.

Purpose: The library UI needs read-only list and info objects to display templates without loading full CharacterEdit objects. This follows the ItemTemplateList/ItemTemplateInfo pattern already established.

Output: NpcTemplateList and NpcTemplateInfo classes ready for use in the library Blazor page.
</objective>

<execution_context>
@S:\src\rdl\threa\.planning\workflows\execute-plan.md
@S:\src\rdl\threa\.planning\templates\summary.md
</execution_context>

<context>
@S:\src\rdl\threa\.planning\PROJECT.md
@S:\src\rdl\threa\.planning\ROADMAP.md
@S:\src\rdl\threa\.planning\phases\24-npc-template-system\24-RESEARCH.md
@S:\src\rdl\threa\GameMechanics\Items\ItemTemplateInfo.cs
@S:\src\rdl\threa\GameMechanics\Items\ItemTemplateList.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NpcTemplateInfo ReadOnlyBase</name>
  <files>
    GameMechanics/NpcTemplateInfo.cs
  </files>
  <action>
Create NpcTemplateInfo.cs in GameMechanics/ following ItemTemplateInfo pattern:

```csharp
[Serializable]
public class NpcTemplateInfo : ReadOnlyBase<NpcTemplateInfo>
```

Properties (all read-only with PropertyInfo pattern):
- int Id - template character ID
- string Name - template name
- string Species - species for display
- string? Category - organizational category
- string? Tags - comma-separated tags string
- NpcDisposition DefaultDisposition - default NPC attitude
- int DifficultyRating - calculated threat level
- bool IsActive - true if template is not deactivated

Computed property (not CSLA-managed):
- IEnumerable<string> TagList => split Tags by comma, trim each, filter empty

FetchChild method:
- [FetchChild] private void Fetch(Character dto)
- Use LoadProperty for each field
- IsActive = !dto.IsNpc is wrong - templates are always IsNpc=true
- IsActive should be based on whether template is deactivated (use VisibleToPlayers for now - true = active, can refine later)

Add usings:
- Csla
- Threa.Dal.Dto (for Character and NpcDisposition)
  </action>
  <verify>
Build succeeds: `dotnet build GameMechanics/GameMechanics.csproj`
  </verify>
  <done>
NpcTemplateInfo.cs exists with all properties and FetchChild method. TagList computed property splits tags correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create NpcTemplateList ReadOnlyListBase</name>
  <files>
    GameMechanics/NpcTemplateList.cs
  </files>
  <action>
Create NpcTemplateList.cs in GameMechanics/ following ItemTemplateList pattern:

```csharp
[Serializable]
public class NpcTemplateList : ReadOnlyListBase<NpcTemplateList, NpcTemplateInfo>
```

Fetch operation:
- [Fetch] private async Task Fetch([Inject] ICharacterDal dal, [Inject] IChildDataPortal<NpcTemplateInfo> childPortal)
- Call dal.GetNpcTemplatesAsync() to get all templates
- Use LoadListMode block
- For each template, Add(childPortal.FetchChild(template))

Add usings:
- Csla
- System.Threading.Tasks
- Threa.Dal
  </action>
  <verify>
Build succeeds: `dotnet build GameMechanics/GameMechanics.csproj`
  </verify>
  <done>
NpcTemplateList.cs exists with Fetch operation that retrieves all NPC templates via DAL.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for template list business objects</name>
  <files>
    GameMechanics.Test/NpcTemplateTests.cs
  </files>
  <action>
Create NpcTemplateTests.cs in GameMechanics.Test/ following existing test patterns:

Test class setup:
- [TestClass] public class NpcTemplateTests
- Use ApplicationContextManager and DataPortal setup from other test classes

Tests:

1. NpcTemplateList_Fetch_ReturnsOnlyTemplates
   - Create two characters: one with IsNpc=true, IsTemplate=true; one regular
   - Save both
   - Fetch NpcTemplateList
   - Verify only template character is in list

2. NpcTemplateInfo_LoadsAllProperties
   - Create template character with: Name, Species, Category="Beasts", Tags="undead,boss", DefaultDisposition=Hostile, DifficultyRating=5
   - Save
   - Fetch NpcTemplateList
   - Find template in list
   - Verify all properties loaded correctly

3. NpcTemplateInfo_TagList_SplitsCorrectly
   - Create template with Tags="melee, ranged, boss"
   - Fetch list and get template
   - Verify TagList contains ["melee", "ranged", "boss"] (trimmed)

4. NpcTemplateInfo_TagList_HandlesEmpty
   - Create template with Tags=null
   - Fetch and verify TagList is empty enumerable (not null)

5. NpcTemplateInfo_TagList_HandlesSingleTag
   - Create template with Tags="solo"
   - Verify TagList contains exactly ["solo"]

Use TestCleanup to delete test characters if needed (or use unique names that won't conflict).
  </action>
  <verify>
All tests pass: `dotnet test GameMechanics.Test/GameMechanics.Test.csproj --filter "FullyQualifiedName~NpcTemplateTests"`
  </verify>
  <done>
NpcTemplateTests.cs exists with 5 tests. All tests pass verifying list fetching and info property loading.
  </done>
</task>

</tasks>

<verification>
1. Build solution: `dotnet build Threa.sln`
2. Run NPC template tests: `dotnet test GameMechanics.Test/GameMechanics.Test.csproj --filter "FullyQualifiedName~NpcTemplateTests"`
3. All 5 new tests pass
</verification>

<success_criteria>
- NpcTemplateInfo is a ReadOnlyBase with Id, Name, Species, Category, Tags, DefaultDisposition, DifficultyRating, IsActive properties
- NpcTemplateInfo has TagList computed property that correctly parses comma-separated tags
- NpcTemplateList is a ReadOnlyListBase that fetches templates via GetNpcTemplatesAsync
- 5 unit tests verify correct behavior
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/24-npc-template-system/24-02-SUMMARY.md`
</output>
