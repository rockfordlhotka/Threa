---
phase: 24-npc-template-system
plan: 05
type: execute
wave: 4
depends_on: ["24-03", "24-04"]
files_modified:
  - Threa/Threa.Client/Components/Pages/GameMaster/NpcTemplates.razor
  - Threa/Threa.Client/Components/Pages/GameMaster/NpcTemplateEdit.razor
  - Threa/Threa.Client/wwwroot/css/site.css
autonomous: false

must_haves:
  truths:
    - "Category input shows autocomplete with existing categories"
    - "Inactive templates display with dimmed/strikethrough styling"
    - "Difficulty badge shows color-coded rating with tooltip"
    - "Clone modal allows selecting source character/template"
    - "All template CRUD operations work end-to-end"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/GameMaster/NpcTemplates.razor"
      provides: "Complete library with clone modal"
      contains: "CloneModal"
    - path: "Threa/Threa.Client/wwwroot/css/site.css"
      provides: "Inactive template styling"
      contains: "template-inactive"
  key_links:
    - from: "NpcTemplates.razor"
      to: "NpcTemplateEdit.razor"
      via: "Clone navigation"
      pattern: "/gamemaster/templates/clone"
---

<objective>
Polish the NPC Template System with category autocomplete, inactive styling, difficulty badges, and clone modal.

Purpose: Complete the template management experience with visual polish and the clone workflow (TMPL-01 through TMPL-05 completion).

Output: Fully polished template library with all visual indicators and clone functionality.
</objective>

<execution_context>
@S:\src\rdl\threa\.planning\workflows\execute-plan.md
@S:\src\rdl\threa\.planning\templates\summary.md
</execution_context>

<context>
@S:\src\rdl\threa\.planning\PROJECT.md
@S:\src\rdl\threa\.planning\ROADMAP.md
@S:\src\rdl\threa\.planning\phases\24-npc-template-system\24-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add category autocomplete and inactive template styling</name>
  <files>
    Threa/Threa.Client/Components/Pages/GameMaster/NpcTemplateEdit.razor
    Threa/Threa.Client/Components/Pages/GameMaster/NpcTemplates.razor
    Threa/Threa.Client/wwwroot/css/site.css
  </files>
  <action>
1. Category autocomplete in NpcTemplateEdit.razor:
   - Replace simple TextBox with RadzenAutoComplete
   - Data source: categories extracted from existing templates
   - Allow free text entry (GM can create new categories)
   - MinLength="0" to show all on focus
   - FilterCaseSensitivity.CaseInsensitive

2. Inactive template styling in NpcTemplates.razor:
   - Add row styling based on IsActive property
   - RowRender event to add CSS class
   - Inactive rows: dimmed opacity (0.6) and strikethrough on name

3. CSS in site.css:
```css
/* NPC Template inactive styling */
.template-inactive {
    opacity: 0.6;
}
.template-inactive .template-name {
    text-decoration: line-through;
}
```

4. Update Name column in NpcTemplates.razor:
   - Wrap name in span with class="template-name"
   - RowRender callback adds "template-inactive" class when !item.IsActive

5. Reactivate functionality in NpcTemplateEdit.razor:
   - When editing inactive template, show "Reactivate" button instead of "Deactivate"
   - Reactivate sets VisibleToPlayers=true and saves
  </action>
  <verify>
Build succeeds: `dotnet build Threa/Threa.csproj`
  </verify>
  <done>
Category autocomplete suggests existing categories. Inactive templates show with dimmed/strikethrough styling. Reactivate button restores inactive templates.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add difficulty badge with tooltip and clone modal</name>
  <files>
    Threa/Threa.Client/Components/Pages/GameMaster/NpcTemplates.razor
    Threa/Threa.Client/Components/Pages/GameMaster/NpcTemplateEdit.razor
  </files>
  <action>
1. Difficulty badge in NpcTemplates.razor:
   - Replace plain number with colored badge
   - Color mapping:
     - 1-5: badge bg-success, text "Easy"
     - 6-10: badge bg-warning, text "Moderate"
     - 11-15: badge bg-danger, text "Hard"
     - 16+: badge bg-dark, text "Deadly"
   - Show actual number in badge: "Easy (3)"
   - Use RadzenTooltip for hover info OR title attribute

2. Difficulty display in NpcTemplateEdit.razor Template Info tab:
   - Calculate on load and when stats change
   - Display with same color coding
   - Optional: Show breakdown (average combat AS, health modifier)

3. Clone modal in NpcTemplates.razor:
   - Add state: showCloneModal, cloneSearchText, cloneSourceList, selectedCloneSource
   - "Clone From..." button opens modal
   - Modal content:
     - Search input for filtering
     - List of characters (both PCs and existing templates)
     - Each row: Name, Species, Type badge (PC/NPC/Template)
     - Click row to select (highlight)
     - "Clone" button: Navigate to /gamemaster/templates/clone/{selectedId}
     - "Cancel" button: Close modal
   - Fetch both regular characters and templates for source list
   - Use RadzenDialog or custom modal div

4. Alternative simpler clone approach (if modal is too complex):
   - "Clone From..." button shows inline dropdown
   - Select source from dropdown
   - "Create Clone" button navigates to clone route
  </action>
  <verify>
Build succeeds: `dotnet build Threa/Threa.csproj`
  </verify>
  <done>
Difficulty badges display with color coding. Clone modal allows selecting source character. Clone creates new template from source.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete template management workflow</name>
  <what-built>
Complete NPC Template System with:
- Template library page with search/filter
- Template editor with all tabs
- Clone functionality
- Category autocomplete
- Inactive template styling
- Difficulty badges
  </what-built>
  <how-to-verify>
1. Start application: `cd Threa/Threa && dotnet run`
2. Login as GameMaster (or admin)
3. Navigate to "NPC Templates" from GM menu

Test Create (TMPL-01):
4. Click "Create New"
5. Fill in: Name="Goblin Scout", Species="Goblin", Category="Humanoids", Tags="minion,melee"
6. Set some attributes (e.g., STR=6, DEX=8)
7. Add a skill (e.g., Light Blades level 2)
8. Click Save
9. Verify template appears in library

Test Edit (TMPL-02):
10. Click on "Goblin Scout" in library
11. Change name to "Goblin Warrior", add tag "soldier"
12. Save and verify changes persist

Test Search/Filter (TMPL-03):
13. Create another template with different category
14. Use search box to filter by name
15. Use category dropdown to filter
16. Use tag dropdown to filter

Test Deactivate (TMPL-04):
17. Edit a template, click "Deactivate"
18. Verify template shows as inactive in library (dimmed/strikethrough)
19. With "Show Inactive" unchecked, verify it's hidden
20. Check "Show Inactive", click template, click "Reactivate"

Test Clone:
21. Click "Clone From..." in library
22. Select an existing character or template
23. Verify new template has copied attributes/skills
24. Verify equipment and notes are NOT copied

Test Difficulty Badge:
25. Verify difficulty badge shows color-coded rating
26. Edit template to change combat skills, verify difficulty updates

Expected: All operations complete successfully. Templates persist across page refreshes.
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Build solution: `dotnet build Threa.sln`
2. Run all tests: `dotnet test GameMechanics.Test/GameMechanics.Test.csproj`
3. Manual verification of complete workflow (Task 3 checkpoint)
</verification>

<success_criteria>
- Category autocomplete shows existing categories and allows new entries
- Inactive templates display with dimmed opacity and strikethrough name
- Reactivate button restores inactive templates
- Difficulty badges show color-coded ratings (Easy/Moderate/Hard/Deadly)
- Clone modal allows selecting any character as source
- Clone creates template with copied stats, not equipment/notes
- All 5 TMPL requirements verified working
</success_criteria>

<output>
After completion, create `.planning/phases/24-npc-template-system/24-05-SUMMARY.md`
</output>
