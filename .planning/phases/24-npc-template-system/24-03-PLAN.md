---
phase: 24-npc-template-system
plan: 03
type: execute
wave: 3
depends_on: ["24-02"]
files_modified:
  - Threa/Threa.Client/Components/Pages/GameMaster/NpcTemplates.razor
  - Threa/Threa.Client/Components/Layout/NavMenu.razor
autonomous: true

must_haves:
  truths:
    - "GM can view list of NPC templates in organized library"
    - "GM can search templates by name"
    - "GM can filter templates by category"
    - "GM can filter templates by tag"
    - "GM can toggle showing inactive templates"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/GameMaster/NpcTemplates.razor"
      provides: "Template library page with search and filtering"
      contains: "@page \"/gamemaster/templates\""
      min_lines: 100
  key_links:
    - from: "NpcTemplates.razor"
      to: "NpcTemplateList"
      via: "IDataPortal fetch"
      pattern: "IDataPortal<NpcTemplateList>"
    - from: "NavMenu.razor"
      to: "NpcTemplates.razor"
      via: "Navigation link"
      pattern: "/gamemaster/templates"
---

<objective>
Create the NPC Template Library page with search and filtering capabilities.

Purpose: GMs need to browse, search, and filter their NPC template collection (TMPL-03). This page serves as the entry point to template management and the source for spawning NPCs in Phase 25.

Output: Fully functional template library page accessible from GM navigation.
</objective>

<execution_context>
@S:\src\rdl\threa\.planning\workflows\execute-plan.md
@S:\src\rdl\threa\.planning\templates\summary.md
</execution_context>

<context>
@S:\src\rdl\threa\.planning\PROJECT.md
@S:\src\rdl\threa\.planning\ROADMAP.md
@S:\src\rdl\threa\.planning\phases\24-npc-template-system\24-CONTEXT.md
@S:\src\rdl\threa\.planning\phases\24-npc-template-system\24-RESEARCH.md
@S:\src\rdl\threa\Threa\Threa.Client\Components\Pages\GameMaster\Items.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NpcTemplates.razor library page</name>
  <files>
    Threa/Threa.Client/Components/Pages/GameMaster/NpcTemplates.razor
  </files>
  <action>
Create NpcTemplates.razor following Items.razor pattern closely:

Page setup:
- @page "/gamemaster/templates"
- @rendermode InteractiveServer
- @attribute [Authorize(Roles = "GameMaster,Administrator")]
- @implements IDisposable

Inject services:
- IDataPortal<NpcTemplateList> templateListPortal
- IDataPortal<ICharacterDal> - NO, use separate call for categories
- NavigationManager

Header section (info-box):
- Title: "NPC Template Library"
- Count display: "Showing X of Y templates"
- Buttons: "Create New" -> /gamemaster/templates/new, "Clone From..." -> ShowCloneModal (placeholder for now)

Filter section (card-header):
1. RadzenTextBox for search (300px width)
   - @bind-Value="@searchText"
   - @oninput with debounce pattern from Items.razor
   - Placeholder="Search templates..."

2. RadzenDropDown for category filter (200px)
   - TValue="string"
   - Data="@categories"
   - AllowClear="true"
   - Placeholder="All Categories"
   - Change triggers ApplyFilters()

3. RadzenDropDown for tag filter (150px)
   - TValue="string"
   - Data="@availableTags" (extracted from all templates)
   - AllowClear="true"
   - Placeholder="All Tags"

4. RadzenCheckBox for showing inactive
   - @bind-Value="@showInactive"
   - @bind:after="ApplyFilters"
   - Label: "Show Inactive"

Data grid (RadzenDataGrid):
- Data="@filteredTemplates"
- TItem="NpcTemplateInfo"
- AllowSorting="true"
- AllowPaging="true"
- PageSize="20"
- RowSelect navigates to /gamemaster/templates/{id}

Columns:
1. Name (sortable, 250px)
2. Species (sortable, 150px)
3. Category (sortable, 150px)
4. Difficulty - display with color badge:
   - 1-5: bg-success (Easy)
   - 6-10: bg-warning (Moderate)
   - 11+: bg-danger (Hard)
5. Tags - render as badges (bg-secondary)
6. Status - "Active" (text-positive) or "Inactive" (text-negative)

@code block:
- State: allTemplates, filteredTemplates, searchText, selectedCategory, selectedTag, showInactive, categories, availableTags
- Debounce timer (300ms like Items.razor)
- OnParametersSetAsync: fetch NpcTemplateList, extract categories and tags, apply filters
- OnSearchInput: debounced filter application
- ApplyFilters: LINQ chain with all filter conditions
- Dispose: cleanup timer

Extract categories from data (don't need separate DAL call):
```csharp
categories = allTemplates
    .Where(t => !string.IsNullOrEmpty(t.Category))
    .Select(t => t.Category!)
    .Distinct()
    .OrderBy(c => c)
    .ToList();
```

Extract tags similarly from TagList property.
  </action>
  <verify>
Build succeeds: `dotnet build Threa/Threa.csproj`
Navigate to /gamemaster/templates shows the page (requires running app)
  </verify>
  <done>
NpcTemplates.razor exists with search box, category filter, tag filter, inactive toggle, and data grid displaying template list.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add navigation link and loading state</name>
  <files>
    Threa/Threa.Client/Components/Layout/NavMenu.razor
    Threa/Threa.Client/Components/Pages/GameMaster/NpcTemplates.razor
  </files>
  <action>
1. Add navigation link in NavMenu.razor:
   - Find the GameMaster section (look for "Items" or similar GM links)
   - Add link: "NPC Templates" pointing to /gamemaster/templates
   - Use appropriate icon (e.g., "groups" or "people")
   - Place after Items link for logical grouping

2. Add loading state to NpcTemplates.razor:
   - Show loading indicator when vm.Model == null or allTemplates == null
   - Use existing busy.gif pattern from Items.razor
   - "Loading templates..."

3. Add empty state:
   - When filteredTemplates is empty but allTemplates has items: "No templates match your filters"
   - When allTemplates is empty: "No NPC templates yet. Create one to get started."
  </action>
  <verify>
Build succeeds: `dotnet build Threa/Threa.csproj`
NavMenu shows "NPC Templates" link in GM section
  </verify>
  <done>
Navigation link added to NavMenu.razor. Loading and empty states display correctly.
  </done>
</task>

</tasks>

<verification>
1. Build solution: `dotnet build Threa.sln`
2. Run application: `cd Threa/Threa && dotnet run`
3. Login as GM, verify NPC Templates link appears
4. Navigate to /gamemaster/templates, verify page loads
5. Verify search, category filter, and tag filter work (may need test data)
</verification>

<success_criteria>
- NpcTemplates.razor at /gamemaster/templates shows template list
- Search filters templates by name (with 300ms debounce)
- Category dropdown filters by category
- Tag dropdown filters by tag
- "Show Inactive" toggle includes/excludes inactive templates
- Row click navigates to editor (will 404 until Plan 04)
- Navigation link visible in GM menu
- Loading and empty states display appropriately
</success_criteria>

<output>
After completion, create `.planning/phases/24-npc-template-system/24-03-SUMMARY.md`
</output>
