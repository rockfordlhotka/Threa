---
phase: 18-wound-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - GameMechanics/Effects/Behaviors/WoundBehavior.cs
  - Threa/Threa.Client/Components/Shared/WoundManagementModal.razor
  - Threa/Threa.Client/Components/Shared/WoundFormModal.razor
  - Threa/Threa.Client/Components/Shared/CharacterDetailGmActions.razor
autonomous: true

must_haves:
  truths:
    - "GM can open wound management modal from character detail"
    - "GM can add a wound with severity (Minor/Moderate/Severe/Critical)"
    - "GM can specify wound location and description"
    - "Wound is saved to character's Effects list"
  artifacts:
    - path: "Threa/Threa.Client/Components/Shared/WoundManagementModal.razor"
      provides: "Wound list table with add/edit/delete actions"
      min_lines: 80
    - path: "Threa/Threa.Client/Components/Shared/WoundFormModal.razor"
      provides: "Add/edit wound form with severity and location"
      min_lines: 100
  key_links:
    - from: "CharacterDetailGmActions.razor"
      to: "WoundManagementModal"
      via: "DialogService.OpenAsync"
      pattern: "OpenAsync<WoundManagementModal>"
    - from: "WoundFormModal"
      to: "character.Effects"
      via: "AddEffect"
      pattern: "Effects\\.Add"
---

<objective>
Create wound management UI and extend WoundState to support GM-specified severity levels and custom damage rates.

Purpose: Enable GMs to add wounds to characters with specific severity levels (Minor/Moderate/Severe/Critical), body locations, and descriptions. This provides the foundation for wound tracking in gameplay.

Output: WoundManagementModal component accessible from CharacterDetailGmActions, WoundFormModal for adding/editing wounds, and extended WoundState supporting custom severity.
</objective>

<execution_context>
@S:\src\rdl\threa\.claude\get-shit-done\workflows\execute-plan.md
@S:\src\rdl\threa\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@S:\src\rdl\threa\.planning\PROJECT.md
@S:\src\rdl\threa\.planning\ROADMAP.md
@S:\src\rdl\threa\.planning\STATE.md
@S:\src\rdl\threa\.planning\phases\18-wound-management\18-CONTEXT.md
@S:\src\rdl\threa\.planning\phases\18-wound-management\18-RESEARCH.md
@S:\src\rdl\threa\GameMechanics\Effects\Behaviors\WoundBehavior.cs
@S:\src\rdl\threa\Threa\Threa.Client\Components\Shared\CharacterDetailGmActions.razor
@S:\src\rdl\threa\Threa\Threa.Client\Components\Shared\CharacterDetailModal.razor
@S:\src\rdl\threa\GameMechanics\EffectRecord.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend WoundState for Custom Severity</name>
  <files>GameMechanics/Effects/Behaviors/WoundBehavior.cs</files>
  <action>
Extend WoundState class to support Phase 18 requirements:

1. Add new properties to WoundState:
```csharp
/// <summary>Custom severity label set by GM (Minor, Moderate, Severe, Critical)</summary>
public string? Severity { get; set; }

/// <summary>GM-provided description of the wound</summary>
public string? Description { get; set; }

/// <summary>Custom AS penalty override (null = use default calculation)</summary>
public int? CustomASPenalty { get; set; }

/// <summary>FAT damage per tick (20 rounds). Null = use default based on wound type</summary>
public int? FatDamagePerTick { get; set; }

/// <summary>VIT damage per tick (20 rounds). Null = use default based on wound type</summary>
public int? VitDamagePerTick { get; set; }
```

2. Add helper method for suggested defaults based on severity:
```csharp
public static (int asPenalty, int fatPerTick, int vitPerTick) GetSeverityDefaults(string severity) => severity switch
{
    "Minor" => (-2, 1, 0),
    "Moderate" => (-2, 2, 1),
    "Severe" => (-4, 3, 2),
    "Critical" => (-6, 4, 3),
    _ => (-2, 1, 0)
};
```

3. Update WoundBehavior.OnTick() to use custom damage rates when set:
- If FatDamagePerTick is set, use it instead of default calculation
- If VitDamagePerTick is set, use it instead of default calculation
- Fall back to existing logic (SeriousWounds * 2 for FAT, SeriousWounds for VIT) when null

4. Update GetAbilityScoreModifiers() to use CustomASPenalty when set:
- If CustomASPenalty is set, use it directly
- Fall back to TotalWounds * PenaltyPerWound when null

5. Add static method for creating custom wound:
```csharp
public static EffectRecord CreateCustomWound(
    CharacterEdit character,
    Csla.IChildDataPortal<EffectRecord> effectPortal,
    string location,
    string severity,
    string? description,
    int? asPenalty = null,
    int? fatPerTick = null,
    int? vitPerTick = null)
```
This creates an EffectRecord with WoundState containing the custom values.
  </action>
  <verify>
Build solution: `dotnet build Threa.sln`
Verify WoundState has Severity, Description, CustomASPenalty, FatDamagePerTick, VitDamagePerTick properties
Verify GetSeverityDefaults static method exists
Verify CreateCustomWound static method exists
  </verify>
  <done>
WoundState extended with custom severity support. OnTick uses custom rates when set. GetAbilityScoreModifiers uses custom penalty when set. CreateCustomWound helper exists for UI to use.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Wound Form Modal</name>
  <files>Threa/Threa.Client/Components/Shared/WoundFormModal.razor</files>
  <action>
Create WoundFormModal.razor for adding/editing a single wound:

1. Parameters:
```csharp
[Parameter] public CharacterEdit? Character { get; set; }
[Parameter] public int CharacterId { get; set; }
[Parameter] public EffectRecord? ExistingWound { get; set; } // null for add, set for edit
```

2. Form fields matching CONTEXT.md requirements:
- **Severity dropdown** (required): Minor, Moderate, Severe, Critical
  - On change, pre-fill suggested AS penalty and FAT/VIT rates from GetSeverityDefaults()
- **Location dropdown** (required): Head, Torso, LeftArm, RightArm, LeftLeg, RightLeg
- **Description text input** (required): Free-form wound description
- **Common wound template dropdown** (optional): Quick-select presets
  - Options: Broken Arm, Broken Leg, Concussion, Deep Cut, Puncture Wound, Burns, Internal Bleeding
  - On select, populate Location, Severity, Description with template values
- **AS Penalty numeric input**: Pre-filled from severity, GM can override
- **FAT Damage/Tick numeric input**: Pre-filled from severity, GM can override
- **VIT Damage/Tick numeric input**: Pre-filled from severity, GM can override

3. Form validation:
- Severity is required
- Location is required
- Description is required (min 3 chars)
- Numeric fields >= 0

4. Save logic:
```csharp
private async Task SaveWound()
{
    // Re-fetch character for fresh state
    var character = await characterPortal.FetchAsync(CharacterId);

    if (ExistingWound != null)
    {
        // Edit: Find and update existing wound
        var wound = character.Effects.FirstOrDefault(e => e.Id == ExistingWound.Id);
        if (wound != null)
        {
            var state = WoundState.Deserialize(wound.BehaviorState);
            state.Severity = selectedSeverity;
            state.Description = description;
            state.CustomASPenalty = asPenalty;
            state.FatDamagePerTick = fatDamage;
            state.VitDamagePerTick = vitDamage;
            wound.BehaviorState = state.Serialize();
            wound.Location = selectedLocation;
            wound.Name = $"Wound: {selectedLocation}";
        }
    }
    else
    {
        // Add: Create new wound using WoundBehavior.CreateCustomWound
        WoundBehavior.CreateCustomWound(
            character, effectPortal,
            selectedLocation, selectedSeverity, description,
            asPenalty, fatDamage, vitDamage);
    }

    await characterPortal.UpdateAsync(character);

    // Publish update
    await TimeEventPublisher.PublishCharacterUpdateAsync(new CharacterUpdateMessage
    {
        CharacterId = CharacterId,
        UpdateType = CharacterUpdateType.EffectAdded,
        CampaignId = TableId.ToString(),
        SourceId = "GM",
        Description = $"Wound: {description}"
    });

    DialogService.Close(true);
}
```

5. UI Layout:
- Modal title: "Add Wound" or "Edit Wound" based on ExistingWound
- Bootstrap form styling consistent with CharacterDetailGmActions
- Save/Cancel buttons at bottom
- 500px width per RESEARCH.md pattern

6. Inject required services:
```csharp
@inject IDataPortal<CharacterEdit> characterPortal
@inject IChildDataPortal<EffectRecord> effectPortal
@inject DialogService DialogService
@inject ITimeEventPublisher TimeEventPublisher
```

7. Common wound templates (static list):
```csharp
private static readonly (string Name, string Location, string Severity, string Description)[] CommonWounds = [
    ("Broken Arm", "RightArm", "Moderate", "Fractured arm bone"),
    ("Broken Leg", "RightLeg", "Moderate", "Fractured leg bone"),
    ("Concussion", "Head", "Moderate", "Traumatic head injury"),
    ("Deep Cut", "Torso", "Minor", "Deep bleeding laceration"),
    ("Puncture Wound", "Torso", "Moderate", "Piercing injury"),
    ("Burns", "Torso", "Minor", "Thermal damage to skin"),
    ("Internal Bleeding", "Torso", "Severe", "Internal hemorrhage")
];
```
  </action>
  <verify>
Build solution: `dotnet build Threa.sln`
Verify WoundFormModal.razor exists with required fields
Verify severity dropdown updates default values
Verify common wound templates populate form
  </verify>
  <done>
WoundFormModal created with severity selection, location dropdown, description field, common wound templates, and customizable AS/FAT/VIT values. Form saves wound to character Effects and publishes update.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Wound Management Modal and Wire to GM Actions</name>
  <files>
Threa/Threa.Client/Components/Shared/WoundManagementModal.razor
Threa/Threa.Client/Components/Shared/CharacterDetailGmActions.razor
  </files>
  <action>
**Part A: Create WoundManagementModal.razor**

1. Parameters:
```csharp
[Parameter] public CharacterEdit? Character { get; set; }
[Parameter] public int CharacterId { get; set; }
[Parameter] public Guid TableId { get; set; }
```

2. Display wound list table:
- Columns: Severity (badge), Location, Description, Actions (Edit/Remove buttons)
- Sort by severity (Critical first) by default
- Show "No wounds" message if empty
- Badge colors: Minor=secondary, Moderate=warning, Severe=orange, Critical=danger

3. Add Wound button at top:
```csharp
<button class="btn btn-primary mb-3" @onclick="OpenAddWound">
    <i class="bi bi-plus-lg me-1"></i>Add Wound
</button>
```

4. Wire actions:
```csharp
private async Task OpenAddWound()
{
    var result = await DialogService.OpenAsync<WoundFormModal>(
        "Add Wound",
        new Dictionary<string, object>
        {
            { "Character", Character },
            { "CharacterId", CharacterId },
            { "TableId", TableId }
        },
        new DialogOptions { Width = "500px", CloseDialogOnOverlayClick = true });

    if (result == true)
        await RefreshCharacter();
}

private async Task OpenEditWound(EffectRecord wound)
{
    var result = await DialogService.OpenAsync<WoundFormModal>(
        "Edit Wound",
        new Dictionary<string, object>
        {
            { "Character", Character },
            { "CharacterId", CharacterId },
            { "TableId", TableId },
            { "ExistingWound", wound }
        },
        new DialogOptions { Width = "500px", CloseDialogOnOverlayClick = true });

    if (result == true)
        await RefreshCharacter();
}

private async Task RemoveWound(EffectRecord wound)
{
    var character = await characterPortal.FetchAsync(CharacterId);
    var toRemove = character.Effects.FirstOrDefault(e => e.Id == wound.Id);
    if (toRemove != null)
    {
        character.Effects.Remove(toRemove);
        await characterPortal.UpdateAsync(character);

        await TimeEventPublisher.PublishCharacterUpdateAsync(new CharacterUpdateMessage
        {
            CharacterId = CharacterId,
            UpdateType = CharacterUpdateType.EffectRemoved,
            CampaignId = TableId.ToString(),
            SourceId = "GM",
            Description = $"Wound removed: {wound.Location}"
        });

        await RefreshCharacter();
    }
}
```

5. Get wounds from character:
```csharp
private IEnumerable<EffectRecord> GetWounds() =>
    Character?.Effects
        .Where(e => e.EffectType == EffectType.Wound)
        .OrderByDescending(e => GetSeverityOrder(WoundState.Deserialize(e.BehaviorState).Severity))
    ?? Enumerable.Empty<EffectRecord>();

private static int GetSeverityOrder(string? severity) => severity switch
{
    "Critical" => 4,
    "Severe" => 3,
    "Moderate" => 2,
    "Minor" => 1,
    _ => 0
};
```

**Part B: Add Manage Wounds button to CharacterDetailGmActions.razor**

1. Add new card after Effects card (around line 90):
```razor
<!-- Wounds -->
<div class="col-md-6">
    <div class="card h-100">
        <div class="card-header bg-danger text-white">
            <strong><i class="bi bi-bandaid me-1"></i>Manage Wounds</strong>
        </div>
        <div class="card-body d-flex flex-column">
            <p class="text-muted small flex-grow-1">
                Add, edit, and remove wounds. Wounds apply AS penalties and periodic damage.
            </p>
            <button class="btn btn-outline-danger w-100" @onclick="OpenWoundManagement" disabled="@isProcessing">
                <i class="bi bi-bandaid me-1"></i>Manage Wounds
                @if (Character != null)
                {
                    var woundCount = Character.Effects.Count(e => e.EffectType == EffectType.Wound);
                    if (woundCount > 0)
                    {
                        <span class="badge bg-light text-danger ms-1">@woundCount</span>
                    }
                }
            </button>
        </div>
    </div>
</div>
```

2. Add OpenWoundManagement method:
```csharp
private async Task OpenWoundManagement()
{
    var result = await DialogService.OpenAsync<WoundManagementModal>(
        "Manage Wounds",
        new Dictionary<string, object>
        {
            { "Character", Character },
            { "CharacterId", CharacterId },
            { "TableId", TableId }
        },
        new DialogOptions
        {
            Width = "700px",
            Height = "500px",
            CloseDialogOnOverlayClick = true
        });

    // Refresh character data when modal closes
    await OnCharacterUpdated.InvokeAsync();
}
```

3. Add required using/inject for DialogService (if not already present):
```csharp
@inject DialogService DialogService
```
  </action>
  <verify>
Build solution: `dotnet build Threa.sln`
Verify WoundManagementModal.razor exists with wound table and actions
Verify CharacterDetailGmActions has "Manage Wounds" card
Verify OpenWoundManagement opens WoundManagementModal via DialogService
  </verify>
  <done>
WoundManagementModal displays wounds in sortable table with edit/delete. CharacterDetailGmActions has Manage Wounds card with wound count badge. Modal-over-modal pattern works via RadzenDialog.
  </done>
</task>

</tasks>

<verification>
Run full solution build:
```bash
dotnet build Threa.sln
```

Verify all new files exist:
- GameMechanics/Effects/Behaviors/WoundBehavior.cs (modified)
- Threa/Threa.Client/Components/Shared/WoundManagementModal.razor (new)
- Threa/Threa.Client/Components/Shared/WoundFormModal.razor (new)
- Threa/Threa.Client/Components/Shared/CharacterDetailGmActions.razor (modified)

Verify key patterns:
- WoundState has Severity, Description, CustomASPenalty, FatDamagePerTick, VitDamagePerTick
- WoundFormModal has severity dropdown with 4 options
- WoundManagementModal has wound table with severity sorting
- CharacterDetailGmActions has Manage Wounds card
</verification>

<success_criteria>
1. GM can open Manage Wounds modal from CharacterDetailGmActions
2. GM can add a new wound with severity (Minor/Moderate/Severe/Critical)
3. GM can specify location (Head, Torso, Arms, Legs) and description
4. GM can select from common wound templates to pre-fill form
5. GM can customize AS penalty and FAT/VIT damage rates
6. GM can edit existing wounds (change severity, description, location)
7. GM can remove wounds
8. Wounds display in sortable table ordered by severity
9. Solution builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-wound-management/18-01-SUMMARY.md`
</output>
