---
phase: 18-wound-management
plan: 02
type: execute
wave: 2
depends_on: [18-01]
files_modified:
  - Threa/Threa.Client/Components/Shared/CharacterDetailModal.razor
  - Threa/Threa.Client/Components/Shared/CharacterDetailGmActions.razor
autonomous: true

must_haves:
  truths:
    - "GM can see individual wound badges in modal header"
    - "Hovering wound badge shows tooltip with wound details"
    - "VIT damage exceeding threshold prompts wound creation"
    - "Wound AS penalties show in character sheet calculations"
  artifacts:
    - path: "Threa/Threa.Client/Components/Shared/CharacterDetailModal.razor"
      provides: "Individual wound badges with tooltips in header"
      contains: "title=.*Wound:"
  key_links:
    - from: "CharacterDetailModal"
      to: "WoundState"
      via: "tooltip display"
      pattern: "WoundState\\.Deserialize"
    - from: "CharacterDetailGmActions"
      to: "WoundFormModal"
      via: "damage threshold prompt"
      pattern: "projectedVit.*<.*wound"
---

<objective>
Integrate wound display and prompts into the existing UI to provide visibility and workflow integration.

Purpose: Complete the wound management experience by showing wound indicators in the character header, prompting wound creation when VIT is exceeded, and ensuring AS penalty visibility. This makes wounds first-class citizens in the GM workflow.

Output: Enhanced CharacterDetailModal header with individual wound tooltips, VIT threshold wound prompt in damage flow, verified AS penalty display.
</objective>

<execution_context>
@S:\src\rdl\threa\.claude\get-shit-done\workflows\execute-plan.md
@S:\src\rdl\threa\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@S:\src\rdl\threa\.planning\PROJECT.md
@S:\src\rdl\threa\.planning\ROADMAP.md
@S:\src\rdl\threa\.planning\STATE.md
@S:\src\rdl\threa\.planning\phases\18-wound-management\18-CONTEXT.md
@S:\src\rdl\threa\.planning\phases\18-wound-management\18-RESEARCH.md
@S:\src\rdl\threa\.planning\phases\18-wound-management\18-01-SUMMARY.md
@S:\src\rdl\threa\Threa\Threa.Client\Components\Shared\CharacterDetailModal.razor
@S:\src\rdl\threa\Threa\Threa.Client\Components\Shared\CharacterDetailGmActions.razor
@S:\src\rdl\threa\GameMechanics\Effects\Behaviors\WoundBehavior.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance Header with Individual Wound Badges</name>
  <files>Threa/Threa.Client/Components/Shared/CharacterDetailModal.razor</files>
  <action>
Replace the single wound count badge (lines 62-66) with individual wound badges showing tooltips:

1. Change the existing wound badge section from:
```razor
@if (character.Effects.Count(e => e.EffectType == Threa.Dal.Dto.EffectType.Wound) > 0)
{
    <span class="badge bg-warning text-dark" title="Wounds">
        <i class="bi bi-bandaid"></i> @character.Effects.Count(e => e.EffectType == Threa.Dal.Dto.EffectType.Wound)
    </span>
}
```

To individual badges per wound:
```razor
@foreach (var wound in character.Effects.Where(e => e.EffectType == Threa.Dal.Dto.EffectType.Wound))
{
    var woundState = GameMechanics.Effects.Behaviors.WoundState.Deserialize(wound.BehaviorState);
    var severity = woundState?.Severity ?? "Unknown";
    var description = woundState?.Description ?? wound.Location ?? "Wound";
    var badgeClass = severity switch
    {
        "Critical" => "bg-danger",
        "Severe" => "bg-danger-subtle text-danger",
        "Moderate" => "bg-warning text-dark",
        "Minor" => "bg-secondary",
        _ => "bg-warning text-dark"
    };

    <span class="badge @badgeClass"
          style="cursor: help;"
          title="@($"{severity} wound at {wound.Location}: {description}")">
        <i class="bi bi-bandaid"></i> @(wound.Location?.Replace("Left", "L").Replace("Right", "R") ?? "?")
    </span>
}
```

2. Add using directive at top if not present:
```razor
@using GameMechanics.Effects.Behaviors
```

3. Tooltip format per CONTEXT.md:
- Hover shows: "{Severity} wound at {Location}: {Description}"
- Example: "Moderate wound at RightArm: Fractured arm bone"

4. Location abbreviations for compact display:
- LeftArm -> L.Arm (too long, use "LArm" or just "LA")
- Actually keep simpler: just replace "Left" -> "L" and "Right" -> "R"
  </action>
  <verify>
Build solution: `dotnet build Threa.sln`
Verify CharacterDetailModal has individual wound badges with title attributes
Verify using directive for WoundState is present
  </verify>
  <done>
CharacterDetailModal header shows one badge per wound with severity-colored styling. Hovering badge shows tooltip with severity, location, and description.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add VIT Damage Wound Prompt</name>
  <files>Threa/Threa.Client/Components/Shared/CharacterDetailGmActions.razor</files>
  <action>
Add wound creation prompt when VIT damage exceeds capacity (per CONTEXT.md):

1. Add state variables:
```csharp
private bool showWoundPrompt;
private int woundDamageExcess;
```

2. Modify ApplyToPool() VIT damage check (around lines 205-215) to store excess for prompt:
```csharp
else if (pool == "VIT")
{
    var projectedVit = Character.Vitality.Value - Character.Vitality.PendingDamage - healthAmount;
    if (projectedVit < 0)
    {
        var excess = Math.Abs(projectedVit);
        woundDamageExcess = excess;
        overflowWarningMessage = $"This will exceed VIT capacity. {excess} points of damage beyond VIT may result in wounds.";
        showOverflowWarning = true;
        return;
    }
}
```

3. Modify the overflow warning UI section (around lines 48-62) to include wound prompt after applying:
Replace existing warning block with enhanced version that includes wound prompt option:

```razor
@if (showOverflowWarning)
{
    <div class="alert @(healthMode == HealthMode.Damage ? "alert-warning" : "alert-info") mt-3 mb-0">
        <i class="bi bi-exclamation-triangle me-1"></i>
        @overflowWarningMessage
        <div class="mt-2 d-flex gap-2 flex-wrap">
            <button class="btn @(healthMode == HealthMode.Damage ? "btn-warning" : "btn-info") btn-sm"
                    @onclick="ConfirmApply" disabled="@isProcessing">
                Apply Anyway
            </button>
            @if (healthMode == HealthMode.Damage && pendingPool == "VIT" && woundDamageExcess > 0)
            {
                <button class="btn btn-danger btn-sm"
                        @onclick="ApplyAndAddWound" disabled="@isProcessing">
                    <i class="bi bi-bandaid me-1"></i>Apply + Add Wound
                </button>
            }
            <button class="btn btn-secondary btn-sm" @onclick="CancelApply">
                Cancel
            </button>
        </div>
    </div>
}
```

4. Add ApplyAndAddWound method:
```csharp
private async Task ApplyAndAddWound()
{
    showOverflowWarning = false;

    // First apply the damage
    await ExecuteApply();

    // Then open wound form modal
    var result = await DialogService.OpenAsync<WoundFormModal>(
        "Add Wound (VIT Exceeded)",
        new Dictionary<string, object>
        {
            { "Character", Character },
            { "CharacterId", CharacterId },
            { "TableId", TableId }
        },
        new DialogOptions { Width = "500px", CloseDialogOnOverlayClick = true });

    if (result == true)
    {
        await OnCharacterUpdated.InvokeAsync();
    }

    woundDamageExcess = 0;
}
```

5. Clear woundDamageExcess in CancelApply and SetMode:
```csharp
private void CancelApply()
{
    showOverflowWarning = false;
    pendingPool = "";
    woundDamageExcess = 0;
}

private void SetMode(HealthMode mode)
{
    healthMode = mode;
    showOverflowWarning = false;
    woundDamageExcess = 0;
}
```

6. Reset woundDamageExcess after ConfirmApply (in ExecuteApply finally block):
```csharp
finally
{
    isProcessing = false;
    pendingPool = "";
    woundDamageExcess = 0;  // Add this line
}
```
  </action>
  <verify>
Build solution: `dotnet build Threa.sln`
Verify CharacterDetailGmActions has ApplyAndAddWound method
Verify VIT overflow warning shows "Apply + Add Wound" button when damage exceeds VIT
  </verify>
  <done>
VIT damage exceeding capacity shows "Apply + Add Wound" button. Clicking it applies damage then opens WoundFormModal. Prompt is optional and dismissible.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify AS Penalty Display</name>
  <files>Threa/Threa.Client/Components/Tabs/TabStatus.razor</files>
  <action>
Verify that wound AS penalties display correctly in the character sheet. Per RESEARCH.md, TabStatus.razor already shows TotalWoundPenalty.

1. Read TabStatus.razor and locate wound penalty display (around lines 540-542 per RESEARCH.md)

2. If wound penalty display exists and works with the new custom penalties:
   - Document the existing implementation
   - No changes needed if it correctly reads from GetAbilityScoreModifiers

3. If wound penalty display is missing or doesn't use the new CustomASPenalty:
   - Ensure it reads from WoundBehavior.GetAbilityScoreModifiers which we updated in Plan 01
   - The method now uses CustomASPenalty when set, falls back to TotalWounds * PenaltyPerWound
   - Display should show "Wounds: -X" in AS breakdown

4. Test scenario to verify:
   - Create a wound with custom AS penalty (e.g., -5)
   - View character's skill AS calculations
   - Should show wound penalty in the breakdown

Note: This is primarily a verification task. The work in Plan 01 updating WoundBehavior.GetAbilityScoreModifiers() should make existing UI work correctly. Only modify if there's a gap.
  </action>
  <verify>
Build solution: `dotnet build Threa.sln`
Locate wound penalty display in TabStatus.razor or character sheet
Confirm AS calculation shows wound modifiers from Effects.GetAbilityScoreModifiers()
  </verify>
  <done>
AS penalty from wounds (including custom penalties from Plan 01) displays correctly in character calculations. Existing infrastructure handles this via EffectRecord.GetAbilityScoreModifiers().
  </done>
</task>

</tasks>

<verification>
Run full solution build:
```bash
dotnet build Threa.sln
```

Verify UI integration:
- CharacterDetailModal header shows individual wound badges with tooltips
- CharacterDetailGmActions VIT overflow shows "Apply + Add Wound" option
- Wound AS penalties appear in skill calculations

Verify files modified:
- CharacterDetailModal.razor has wound badge loop with WoundState.Deserialize
- CharacterDetailGmActions.razor has ApplyAndAddWound method and woundDamageExcess state
</verification>

<success_criteria>
1. Each wound shows as individual badge in character modal header
2. Hovering wound badge shows tooltip with "Severity wound at Location: Description"
3. Badge colors match severity (Critical=danger, Severe=orange, Moderate=warning, Minor=secondary)
4. Applying VIT damage that exceeds capacity shows "Apply + Add Wound" button option
5. Clicking "Apply + Add Wound" applies damage then opens wound form modal
6. Wound prompt is optional (can still "Apply Anyway" or "Cancel")
7. Wound AS penalties appear in character ability score calculations
8. Solution builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-wound-management/18-02-SUMMARY.md`
</output>
