---
phase: 29-batch-action-framework
plan: 03
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
  - Threa/Threa/wwwroot/css/themes.css
autonomous: true

must_haves:
  truths:
    - "Batch result feedback appears inline in SelectionBar after operation"
    - "Success shows green alert with character count"
    - "Partial failure shows yellow alert with success count and expandable error details"
    - "Selection clears on full success; failed IDs remain selected on partial failure"
    - "Feedback dismisses on click or when new batch starts"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor"
      provides: "GmTable wiring for SelectionBar new parameters and result handling"
      contains: "OnBatchActionCompleted"
    - path: "Threa/Threa/wwwroot/css/themes.css"
      provides: "Batch result alert styling"
      contains: "batch-result"
  key_links:
    - from: "Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor"
      to: "SelectionBar"
      via: "Parameter binding for TableId, SelectedCharacterIds, OnBatchActionCompleted"
      pattern: "OnBatchActionCompleted"
---

<objective>
Implement batch result feedback display and selection cleanup logic in GmTable

Purpose: Provide clear feedback after batch operations and handle selection state cleanup based on success/failure
Output: GmTable wired to SelectionBar with result handling, inline feedback display, and selection cleanup
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-batch-action-framework/29-RESEARCH.md
@.planning/phases/29-batch-action-framework/29-01-SUMMARY.md
@Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
@Threa/Threa.Client/Components/Shared/SelectionBar.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update SelectionBar to display inline batch result feedback</name>
  <files>Threa/Threa.Client/Components/Shared/SelectionBar.razor</files>
  <action>
Add inline result display to SelectionBar.razor:

1. Add a field for tracking result in @code block:
```csharp
private BatchActionResult? lastResult;
private bool showErrorDetails;
```

2. After the existing div with buttons, add result display inside the outer selection-bar div:
```razor
@if (lastResult != null)
{
    <div class="batch-result-container mt-2">
        <div class="alert @GetResultAlertClass() py-2 mb-0 d-flex justify-content-between align-items-center">
            <div>
                <i class="bi @GetResultIcon() me-1"></i>
                @lastResult.Summary
            </div>
            <div class="d-flex gap-2 align-items-center">
                @if (lastResult.HasFailures)
                {
                    <button type="button" class="btn btn-sm btn-link p-0" @onclick="ToggleErrorDetails">
                        @(showErrorDetails ? "Hide" : "Show") Details
                    </button>
                }
                <button type="button" class="btn btn-sm btn-link p-0" @onclick="DismissResult">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        </div>

        @if (showErrorDetails && lastResult.HasFailures)
        {
            <div class="alert alert-secondary py-2 mt-1 small">
                <strong>Failed:</strong>
                <ul class="mb-0 ps-3">
                    @foreach (var error in lastResult.Errors)
                    {
                        <li>@error</li>
                    }
                </ul>
            </div>
        }
    </div>
}
```

3. Add helper methods in @code block:
```csharp
private string GetResultAlertClass() => lastResult?.AllSucceeded == true
    ? "alert-success"
    : "alert-warning";

private string GetResultIcon() => lastResult?.AllSucceeded == true
    ? "bi-check-circle"
    : "bi-exclamation-triangle";

private void ToggleErrorDetails() => showErrorDetails = !showErrorDetails;

private void DismissResult()
{
    lastResult = null;
    showErrorDetails = false;
}
```

4. Update ExecuteBatchAction to store result and clear selection appropriately:
```csharp
private async Task ExecuteBatchAction(BatchActionType actionType, int amount, string pool)
{
    // Clear any previous result
    lastResult = null;
    showErrorDetails = false;

    var request = new BatchActionRequest
    {
        TableId = TableId,
        CharacterIds = SelectedCharacterIds.ToList(),
        ActionType = actionType,
        Pool = pool,
        Amount = amount
    };

    var batchResult = actionType == BatchActionType.Damage
        ? await BatchActionService.ApplyDamageAsync(request)
        : await BatchActionService.ApplyHealingAsync(request);

    lastResult = batchResult;
    await OnBatchActionCompleted.InvokeAsync(batchResult);
}
```
  </action>
  <verify>dotnet build Threa/Threa.Client/Threa.Client.csproj --no-restore</verify>
  <done>SelectionBar displays inline result feedback with success/warning styling and expandable error details</done>
</task>

<task type="auto">
  <name>Task 2: Wire GmTable to SelectionBar with new parameters and result handler</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor</files>
  <action>
Update GmTable.razor to pass new parameters to SelectionBar and handle batch results:

1. Add using statement if not present:
```razor
@using GameMechanics.Batch
```

2. Find the existing SelectionBar usage and update it to pass new parameters:
```razor
<SelectionBar SelectedCount="@selectedCharacterIds.Count"
              OnDeselectAll="DeselectAll"
              TableId="@TableId"
              SelectedCharacterIds="@selectedCharacterIds"
              OnBatchActionCompleted="HandleBatchActionCompleted" />
```

3. Add the batch action completed handler in @code section:
```csharp
private async Task HandleBatchActionCompleted(BatchActionResult result)
{
    if (result.AllSucceeded)
    {
        // Full success: clear entire selection
        selectedCharacterIds.Clear();
    }
    else if (result.HasFailures && result.SuccessIds.Count > 0)
    {
        // Partial success: remove succeeded IDs, keep failed for retry
        foreach (var successId in result.SuccessIds)
        {
            selectedCharacterIds.Remove(successId);
        }
    }
    // If all failed, keep selection intact for investigation

    // Refresh character list to show updated health values
    await RefreshCharacterListAsync();
    StateHasChanged();
}
```

Note: The RefreshCharacterListAsync method already exists and handles loading characters from the table.
  </action>
  <verify>dotnet build Threa/Threa.Client/Threa.Client.csproj --no-restore && grep -n "OnBatchActionCompleted" Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor</verify>
  <done>GmTable passes TableId, SelectedCharacterIds, OnBatchActionCompleted to SelectionBar and handles selection cleanup</done>
</task>

<task type="auto">
  <name>Task 3: Add batch result CSS styling</name>
  <files>Threa/Threa/wwwroot/css/themes.css</files>
  <action>
Add CSS styles for batch result display in themes.css. Find the existing `.selection-bar` styles and add these rules nearby:

```css
/* Batch result display in SelectionBar */
.batch-result-container {
    border-top: 1px solid var(--border-primary);
    padding-top: 0.5rem;
}

.batch-result-container .alert {
    font-size: 0.875rem;
}

.batch-result-container .btn-link {
    font-size: 0.8rem;
    text-decoration: none;
    color: inherit;
}

.batch-result-container .btn-link:hover {
    text-decoration: underline;
}

/* Ensure alert colors work with both themes */
[data-theme="fantasy"] .batch-result-container .alert-success {
    background-color: rgba(25, 135, 84, 0.15);
    border-color: rgba(25, 135, 84, 0.3);
    color: var(--text-primary);
}

[data-theme="fantasy"] .batch-result-container .alert-warning {
    background-color: rgba(255, 193, 7, 0.15);
    border-color: rgba(255, 193, 7, 0.3);
    color: var(--text-primary);
}

[data-theme="scifi"] .batch-result-container .alert-success {
    background-color: rgba(25, 135, 84, 0.2);
    border-color: rgba(25, 135, 84, 0.4);
    color: var(--text-primary);
}

[data-theme="scifi"] .batch-result-container .alert-warning {
    background-color: rgba(255, 193, 7, 0.2);
    border-color: rgba(255, 193, 7, 0.4);
    color: var(--text-primary);
}
```
  </action>
  <verify>grep -n "batch-result" Threa/Threa/wwwroot/css/themes.css</verify>
  <done>themes.css includes batch-result styling for both fantasy and scifi themes</done>
</task>

</tasks>

<verification>
1. `dotnet build Threa.sln` - Full solution builds
2. Verify GmTable passes TableId, SelectedCharacterIds, OnBatchActionCompleted to SelectionBar
3. Verify SelectionBar has lastResult field and result display markup
4. Verify themes.css has batch-result-container styles
</verification>

<success_criteria>
- Batch result appears inline below action buttons in SelectionBar
- Success (all succeeded) shows green alert with summary
- Partial failure shows yellow alert with "Show Details" link
- Clicking "Show Details" expands error list
- Dismiss button (X) clears result display
- On full success, selection clears completely
- On partial success, only succeeded IDs removed from selection (failed remain selected)
- GmTable refreshes character list after batch action
</success_criteria>

<output>
After completion, create `.planning/phases/29-batch-action-framework/29-03-SUMMARY.md`
</output>
