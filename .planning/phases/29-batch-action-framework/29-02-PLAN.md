---
phase: 29-batch-action-framework
plan: 02
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - Threa/Threa.Client/Components/Shared/SelectionBar.razor
  - Threa/Threa.Client/Components/Shared/BatchDamageHealingModal.razor
autonomous: true

must_haves:
  truths:
    - "Damage and Heal buttons appear in SelectionBar when characters are selected"
    - "Clicking Damage button opens modal for amount and pool input"
    - "Clicking Heal button opens modal for amount and pool input"
    - "Modal confirms action by calling BatchActionService"
  artifacts:
    - path: "Threa/Threa.Client/Components/Shared/SelectionBar.razor"
      provides: "Action buttons for batch damage/healing"
      contains: "OpenDamageModal"
    - path: "Threa/Threa.Client/Components/Shared/BatchDamageHealingModal.razor"
      provides: "Modal for entering damage/healing amount and pool"
      contains: "BatchActionType"
  key_links:
    - from: "Threa/Threa.Client/Components/Shared/SelectionBar.razor"
      to: "DialogService.OpenAsync"
      via: "Modal opening on button click"
      pattern: "DialogService.OpenAsync"
    - from: "Threa/Threa.Client/Components/Shared/BatchDamageHealingModal.razor"
      to: "DialogService.Close"
      via: "Return input values to caller"
      pattern: "DialogService.Close"
---

<objective>
Create batch action UI with damage/healing buttons in SelectionBar and input modal

Purpose: Enable GM to trigger batch damage/healing operations from the selection bar with a simple amount/pool input modal
Output: Extended SelectionBar with action buttons, and BatchDamageHealingModal component
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-batch-action-framework/29-RESEARCH.md
@.planning/phases/29-batch-action-framework/29-01-SUMMARY.md
@Threa/Threa.Client/Components/Shared/SelectionBar.razor
@Threa/Threa.Client/Components/Shared/WoundFormModal.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BatchDamageHealingModal component</name>
  <files>Threa/Threa.Client/Components/Shared/BatchDamageHealingModal.razor</files>
  <action>
Create a new modal component for batch damage/healing input. Follow WoundFormModal pattern:

```razor
@* Modal for entering batch damage or healing amount and pool *@

@using GameMechanics.Batch
@using Radzen

@inject DialogService DialogService

<div class="p-3">
    <div class="mb-3">
        <label class="form-label">Amount</label>
        <RadzenNumeric @bind-Value="amount" Min="1" Max="999" class="w-100" />
    </div>

    <div class="mb-3">
        <label class="form-label">Pool</label>
        <div class="btn-group w-100" role="group">
            <button type="button"
                    class="btn @(pool == "FAT" ? "btn-primary" : "btn-outline-primary")"
                    @onclick='() => pool = "FAT"'>
                FAT
            </button>
            <button type="button"
                    class="btn @(pool == "VIT" ? "btn-primary" : "btn-outline-primary")"
                    @onclick='() => pool = "VIT"'>
                VIT
            </button>
        </div>
    </div>

    <div class="d-flex justify-content-end gap-2 mt-4">
        <button type="button" class="btn btn-secondary" @onclick="Cancel">
            Cancel
        </button>
        <button type="button"
                class="btn @(Mode == BatchActionType.Damage ? "btn-danger" : "btn-success")"
                @onclick="Confirm"
                disabled="@(amount < 1)">
            <i class="bi @(Mode == BatchActionType.Damage ? "bi-heart-pulse" : "bi-bandaid") me-1"></i>
            Apply to @SelectedCount Character@(SelectedCount != 1 ? "s" : "")
        </button>
    </div>
</div>

@code {
    [Parameter] public BatchActionType Mode { get; set; }
    [Parameter] public int SelectedCount { get; set; }

    private int amount = 1;
    private string pool = "FAT";

    private void Cancel() => DialogService.Close(null);

    private void Confirm() => DialogService.Close(new BatchInputResult(amount, pool));
}

/// <summary>
/// Result returned from BatchDamageHealingModal when user confirms.
/// </summary>
public record BatchInputResult(int Amount, string Pool);
```
  </action>
  <verify>dotnet build Threa/Threa.Client/Threa.Client.csproj --no-restore</verify>
  <done>BatchDamageHealingModal.razor compiles and includes BatchInputResult record</done>
</task>

<task type="auto">
  <name>Task 2: Add action buttons and modal integration to SelectionBar</name>
  <files>Threa/Threa.Client/Components/Shared/SelectionBar.razor</files>
  <action>
Extend SelectionBar.razor to include Damage and Heal buttons that open the modal:

1. Add using statements at top:
```razor
@using GameMechanics.Batch
@using Radzen
@inject DialogService DialogService
```

2. Add new parameters after existing ones:
```csharp
[Parameter] public Guid TableId { get; set; }
[Parameter] public HashSet<int> SelectedCharacterIds { get; set; } = new();
[Parameter] public EventCallback<BatchActionResult> OnBatchActionCompleted { get; set; }
```

3. Inject BatchActionService:
```razor
@inject BatchActionService BatchActionService
```

4. Replace the existing div content (between the outer div tags) with:
```razor
<div class="d-flex justify-content-between align-items-center">
    <span class="selection-count">
        <i class="bi bi-check2-square me-2"></i>
        <strong>@SelectedCount</strong> selected
    </span>

    <div class="d-flex gap-2 align-items-center">
        <button class="btn btn-sm btn-danger" @onclick="OpenDamageModal">
            <i class="bi bi-heart-pulse me-1"></i>Damage
        </button>
        <button class="btn btn-sm btn-success" @onclick="OpenHealingModal">
            <i class="bi bi-bandaid me-1"></i>Heal
        </button>
        <button class="btn btn-sm btn-outline-secondary" @onclick="HandleDeselectAll">
            <i class="bi bi-x-lg me-1"></i>Clear
        </button>
    </div>
</div>
```

5. Add modal handler methods in @code block:
```csharp
private async Task OpenDamageModal()
{
    var result = await DialogService.OpenAsync<BatchDamageHealingModal>(
        "Apply Damage",
        new Dictionary<string, object>
        {
            { "Mode", BatchActionType.Damage },
            { "SelectedCount", SelectedCount }
        },
        new DialogOptions { Width = "350px", CloseDialogOnOverlayClick = true });

    if (result is BatchInputResult input)
    {
        await ExecuteBatchAction(BatchActionType.Damage, input.Amount, input.Pool);
    }
}

private async Task OpenHealingModal()
{
    var result = await DialogService.OpenAsync<BatchDamageHealingModal>(
        "Apply Healing",
        new Dictionary<string, object>
        {
            { "Mode", BatchActionType.Healing },
            { "SelectedCount", SelectedCount }
        },
        new DialogOptions { Width = "350px", CloseDialogOnOverlayClick = true });

    if (result is BatchInputResult input)
    {
        await ExecuteBatchAction(BatchActionType.Healing, input.Amount, input.Pool);
    }
}

private async Task ExecuteBatchAction(BatchActionType actionType, int amount, string pool)
{
    var request = new BatchActionRequest
    {
        TableId = TableId,
        CharacterIds = SelectedCharacterIds.ToList(),
        ActionType = actionType,
        Pool = pool,
        Amount = amount
    };

    var batchResult = actionType == BatchActionType.Damage
        ? await BatchActionService.ApplyDamageAsync(request)
        : await BatchActionService.ApplyHealingAsync(request);

    await OnBatchActionCompleted.InvokeAsync(batchResult);
}
```
  </action>
  <verify>dotnet build Threa/Threa.Client/Threa.Client.csproj --no-restore</verify>
  <done>SelectionBar has Damage and Heal buttons that open modal and execute batch actions</done>
</task>

</tasks>

<verification>
1. `dotnet build Threa.sln` - Full solution builds
2. Verify SelectionBar has Damage, Heal, and Clear buttons in markup
3. Verify BatchDamageHealingModal has FAT/VIT toggle and amount input
4. Verify SelectionBar injects BatchActionService and DialogService
</verification>

<success_criteria>
- SelectionBar displays Damage (red) and Heal (green) buttons alongside Clear
- Clicking Damage opens BatchDamageHealingModal with "Apply Damage" title
- Clicking Heal opens BatchDamageHealingModal with "Apply Healing" title
- Modal has RadzenNumeric for amount (Min=1) and FAT/VIT button group
- Confirm button shows character count and calls DialogService.Close with BatchInputResult
- SelectionBar calls BatchActionService on modal confirmation
</success_criteria>

<output>
After completion, create `.planning/phases/29-batch-action-framework/29-02-SUMMARY.md`
</output>
