---
phase: 35-defense-group
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Threa/Threa/wwwroot/css/themes.css
  - GameMechanics/Effects/Behaviors/CombatStanceBehavior.cs
  - Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor
autonomous: true

must_haves:
  truths:
    - "Defense group shows 4 stance chips (Normal, Parry Mode, Dodge Focus, Block with Shield) below the Defend/Take Damage tiles"
    - "Active stance chip is highlighted with blue background; inactive chips are plain"
    - "Parry Mode chip is disabled when no weapon equipped, with tooltip explaining why"
    - "Block with Shield chip is disabled when no shield equipped, with tooltip explaining why"
    - "Clicking Normal chip clears any active CombatStance effect"
    - "Clicking Dodge Focus or Block with Shield chip creates/replaces a CombatStance effect"
    - "Clicking Parry Mode chip triggers the existing enter-parry-mode flow (deducting 1AP+1FAT or 2AP)"
    - "Stance chips re-derive state from character effects after returning from any combat mode"
  artifacts:
    - path: "Threa/Threa/wwwroot/css/themes.css"
      provides: "stance-chip CSS styles"
      contains: ".stance-chip"
    - path: "GameMechanics/Effects/Behaviors/CombatStanceBehavior.cs"
      provides: "Dodge Focus and Block with Shield stance constants and helpers"
      contains: "DodgeFocusName"
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor"
      provides: "Stance chips in Defense group, stance derivation, Parry Mode chip activation"
      contains: "stance-chip"
  key_links:
    - from: "TabCombat.razor"
      to: "CombatStanceBehavior.cs"
      via: "GetActiveStance() calls IsInParryMode, checks for DodgeFocusName/BlockWithShieldName effects"
      pattern: "CombatStanceBehavior\\.(IsInParryMode|DodgeFocusName|BlockWithShieldName)"
    - from: "TabCombat.razor stance chip onclick"
      to: "Character.Effects"
      via: "AddEffect/RemoveEffect for CombatStance effects"
      pattern: "Character\\.Effects\\.(AddEffect|RemoveEffect)"
---

<objective>
Add defensive stance chips to the Defense group on the Combat tab and extend CombatStanceBehavior to support all four stances.

Purpose: Players need a visible, always-accessible way to set their defensive stance, which pre-selects defense type when entering DefendMode. Stances persist via the CombatStance effect system.
Output: Stance chip UI in Defense group card, CombatStanceBehavior constants for new stances, CSS for stance chips.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-defense-group/35-CONTEXT.md
@.planning/phases/35-defense-group/35-RESEARCH.md
@Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor
@GameMechanics/Effects/Behaviors/CombatStanceBehavior.cs
@Threa/Threa/wwwroot/css/themes.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add stance chip CSS and extend CombatStanceBehavior with new stance constants</name>
  <files>
    Threa/Threa/wwwroot/css/themes.css
    GameMechanics/Effects/Behaviors/CombatStanceBehavior.cs
  </files>
  <action>
**themes.css** -- Add stance chip styles AFTER the existing combat tile section (after line ~2152, after `.combat-group-other .card-header`):

```css
/* Stance toggle chips - smaller than combat tiles, pill-shaped */
.stance-chip {
    font-size: 0.75rem;
    padding: 0.2rem 0.6rem;
    border-radius: 1rem;
    border: 1px solid var(--color-border-primary);
    background: transparent;
    color: var(--color-text-secondary);
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: var(--font-display);
    letter-spacing: 0.03em;
}

.stance-chip.active {
    background: var(--color-accent-blue);
    color: white;
    border-color: var(--color-accent-blue);
}

.stance-chip:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

.stance-chip:not(:disabled):not(.active):hover {
    background: var(--color-bg-tertiary);
    border-color: var(--color-accent-blue);
}

[data-theme="scifi"] .stance-chip.active {
    box-shadow: 0 0 5px var(--color-accent-blue);
}
```

**CombatStanceBehavior.cs** -- Add constants and helpers for Dodge Focus and Block with Shield stances. Add these alongside the existing `ParryStance` and `ParryModeName` constants:

```csharp
public const string DodgeFocusStance = "DodgeFocus";
public const string DodgeFocusName = "Dodge Focus";
public const string BlockWithShieldStance = "BlockWithShield";
public const string BlockWithShieldName = "Block with Shield";
```

Add static helper methods following the existing `IsInParryMode` / `EndParryMode` pattern:

- `IsInDodgeFocus(CharacterEdit character)` -- checks for active CombatStance effect with name DodgeFocusName
- `IsInBlockWithShield(CharacterEdit character)` -- checks for active CombatStance effect with name BlockWithShieldName
- `GetActiveStanceName(CharacterEdit character)` -- returns the name of the active CombatStance effect, or null if none (Normal stance)
- `ClearStance(CharacterEdit character)` -- removes any active CombatStance effect (used when switching to Normal)
- `CreateDodgeFocusState()` -- returns serialized CombatStanceState with StanceType = DodgeFocusStance
- `CreateBlockWithShieldState()` -- returns serialized CombatStanceState with StanceType = BlockWithShieldStance
- `GetDodgeFocusDescription()` -- returns "Dodge Focus: Pre-selects dodge defense when defending."
- `GetBlockWithShieldDescription()` -- returns "Block with Shield: Pre-selects shield block defense when defending."

Note: Dodge Focus and Block with Shield are free to enter (no AP/FAT cost). They are UI preference hints stored as effects for persistence. The existing `OnAdding` method in `CombatStanceBehavior` already handles replacing any existing CombatStance of the same type, and the general pattern of removing old stances when adding new ones should work. However, ensure that entering one stance replaces ANY existing stance (not just same-name). Update the `OnAdding` method: instead of only checking `e.Name == effect.Name`, also remove any OTHER active CombatStance effect, since only one stance can be active at a time. Return `EffectAddResult.Replace(existingStance.Id)` for whichever existing stance is found (regardless of name match).
  </action>
  <verify>
    Run `dotnet build Threa.sln` from the project root. No compilation errors. Verify the new constants exist in CombatStanceBehavior and the CSS file has the .stance-chip styles.
  </verify>
  <done>
    CombatStanceBehavior has constants for all 4 stances (Parry Mode, Dodge Focus, Block with Shield) plus helpers to check/clear/create each. themes.css has .stance-chip CSS. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add stance chips to Defense group in TabCombat and wire stance activation</name>
  <files>
    Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor
  </files>
  <action>
Modify `TabCombat.razor` to add stance toggle chips inside the Defense group card, below the existing Defend and Take Damage tiles.

**HTML changes** -- Inside the Defense group `<div class="card combat-group-defense mb-3">`, after the existing `<div class="d-flex flex-wrap gap-2">` that contains the Defend and Take Damage buttons, add a horizontal rule and stance chips section:

```html
<hr class="my-2" />
<div class="d-flex flex-wrap gap-1 align-items-center">
    <small class="text-muted me-1">Stance:</small>
    <button class="btn btn-sm stance-chip @(GetActiveStance() == "normal" ? "active" : "")"
            @onclick="SetStanceNormal"
            title="No special defensive focus">
        Normal
    </button>
    <button class="btn btn-sm stance-chip @(GetActiveStance() == "parry" ? "active" : "")"
            @onclick="ActivateParryModeFromChip"
            disabled="@(!hasWeaponEquipped || !CanPerformActiveDefenseForStance())"
            title="@GetParryModeChipTooltip()">
        Parry Mode
    </button>
    <button class="btn btn-sm stance-chip @(GetActiveStance() == "dodge" ? "active" : "")"
            @onclick="SetStanceDodgeFocus"
            title="Pre-selects dodge when defending">
        Dodge Focus
    </button>
    <button class="btn btn-sm stance-chip @(GetActiveStance() == "block" ? "active" : "")"
            @onclick="SetStanceBlockWithShield"
            disabled="@(!hasShieldEquipped)"
            title="@(!hasShieldEquipped ? "Requires shield equipped" : "Pre-selects shield block when defending")">
        Block
    </button>
</div>
```

Place this INSIDE the card-body div, after the existing button flex container (after the closing `</div>` of the `d-flex flex-wrap gap-2` div that holds Defend and Take Damage).

**Code-behind changes** -- Add these methods to the `@code` block:

1. `GetActiveStance()` method that derives stance from character effects:
```csharp
private string GetActiveStance()
{
    if (Character == null) return "normal";
    var stanceName = CombatStanceBehavior.GetActiveStanceName(Character);
    return stanceName switch
    {
        CombatStanceBehavior.ParryModeName => "parry",
        CombatStanceBehavior.DodgeFocusName => "dodge",
        CombatStanceBehavior.BlockWithShieldName => "block",
        _ => "normal"
    };
}
```

2. `SetStanceNormal()` -- clears any active CombatStance effect, saves character:
```csharp
private async Task SetStanceNormal()
{
    if (Character == null) return;
    CombatStanceBehavior.ClearStance(Character);
    if (Character is Csla.Core.ISavable savable)
        await savable.SaveAsync();
    StateHasChanged();
}
```

3. `SetStanceDodgeFocus()` -- creates Dodge Focus CombatStance effect (replaces any existing stance via the OnAdding behavior), saves:
```csharp
private async Task SetStanceDodgeFocus()
{
    if (Character == null) return;
    // Clear any existing stance first (including Parry Mode)
    CombatStanceBehavior.ClearStance(Character);

    var effect = EffectPortal.CreateChild(
        EffectType.CombatStance,
        CombatStanceBehavior.DodgeFocusName,
        null, null,
        CombatStanceBehavior.CreateDodgeFocusState());
    effect.Description = CombatStanceBehavior.GetDodgeFocusDescription();
    effect.Source = "Combat";
    Character.Effects.AddEffect(effect);

    if (Character is Csla.Core.ISavable savable)
        await savable.SaveAsync();
    StateHasChanged();
}
```

4. `SetStanceBlockWithShield()` -- same pattern as Dodge Focus but for Block with Shield:
```csharp
private async Task SetStanceBlockWithShield()
{
    if (Character == null || !hasShieldEquipped) return;
    CombatStanceBehavior.ClearStance(Character);

    var effect = EffectPortal.CreateChild(
        EffectType.CombatStance,
        CombatStanceBehavior.BlockWithShieldName,
        null, null,
        CombatStanceBehavior.CreateBlockWithShieldState());
    effect.Description = CombatStanceBehavior.GetBlockWithShieldDescription();
    effect.Source = "Combat";
    Character.Effects.AddEffect(effect);

    if (Character is Csla.Core.ISavable savable)
        await savable.SaveAsync();
    StateHasChanged();
}
```

5. `ActivateParryModeFromChip()` -- triggers the existing Enter Parry Mode flow. This COSTS AP/FAT. Uses the same logic as DefendMode's `EnterParryMode()`:
```csharp
private async Task ActivateParryModeFromChip()
{
    if (Character == null || !hasWeaponEquipped) return;
    if (!CanPerformActiveDefenseForStance()) return;

    // Clear any existing stance
    CombatStanceBehavior.ClearStance(Character);

    // Deduct cost: 1 AP + 1 FAT (using default cost type)
    Character.ActionPoints.Available -= 1;
    Character.ActionPoints.ActionsTakenThisRound += 1;
    Character.Fatigue.Value -= 1;

    // Create parry mode effect
    var effect = EffectPortal.CreateChild(
        EffectType.CombatStance,
        CombatStanceBehavior.ParryModeName,
        null, null,
        CombatStanceBehavior.CreateParryModeState(weaponSkillName, weaponSkillAS));
    effect.Description = CombatStanceBehavior.GetParryModeDescription(weaponSkillName);
    effect.Source = "Combat";
    Character.Effects.AddEffect(effect);

    if (Character is Csla.Core.ISavable savable)
        await savable.SaveAsync();

    LogActivity($"{Character.Name} enters Parry Mode with {weaponSkillName}.", ActivityCategory.Combat);

    if (OnCharacterChanged.HasDelegate)
        await OnCharacterChanged.InvokeAsync();

    StateHasChanged();
}
```

6. `CanPerformActiveDefenseForStance()` -- checks if character can afford the AP/FAT cost to enter Parry Mode:
```csharp
private bool CanPerformActiveDefenseForStance()
{
    if (Character == null) return false;
    return !Character.IsPassedOut &&
           ((Character.ActionPoints.Available >= 1 && Character.Fatigue.Value >= 1) ||
            Character.ActionPoints.Available >= 2);
}
```

7. `GetParryModeChipTooltip()`:
```csharp
private string GetParryModeChipTooltip()
{
    if (!hasWeaponEquipped) return "Requires weapon equipped";
    if (!CanPerformActiveDefenseForStance()) return "Not enough AP/FAT to enter Parry Mode";
    return "Free parry defenses (costs 1 AP + 1 FAT to enter)";
}
```

**Also need EffectPortal injection.** TabCombat.razor needs to inject `Csla.IChildDataPortal<GameMechanics.EffectRecord>` -- add this injection alongside the existing injections at the top of the file:
```
@inject Csla.IChildDataPortal<GameMechanics.EffectRecord> EffectPortal
```

**Important:** The `EffectType` enum is in `Threa.Dal.Dto` namespace which is already imported via `@using Threa.Dal.Dto`.

**Stance re-derivation on mode return:** The `GetActiveStance()` method reads directly from `Character.Effects` each time it's called (no cached state), so when returning from any mode (Attack, Defend, etc.) the stance chips will automatically reflect the correct state -- including when Parry Mode breaks due to an attack action. No additional wiring needed for re-derivation.
  </action>
  <verify>
    Run `dotnet build Threa.sln`. No compilation errors. Visually inspect the Defense group card -- it should show Defend and Take Damage tiles, then a separator, then 4 stance chips in a row.
  </verify>
  <done>
    Defense group shows stance chips (Normal, Parry Mode, Dodge Focus, Block with Shield). Chips derive active state from character effects. Clicking Normal clears stances. Clicking Parry Mode deducts AP/FAT and creates the effect. Clicking Dodge Focus/Block with Shield creates free CombatStance effects. Disabled states with tooltips for Parry Mode (no weapon) and Block with Shield (no shield).
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Threa.sln` -- no errors
2. `dotnet test GameMechanics.Test/GameMechanics.Test.csproj` -- all existing tests pass (CombatStanceBehavior changes are backward-compatible)
3. Defense group card in default mode shows: Defend tile, Take Damage tile, horizontal rule, then 4 stance chips
4. Stance chips are visually smaller than action tiles (pill-shaped, 0.75rem font)
5. Active stance chip has blue background; others are plain
6. Parry Mode chip disabled when no weapon equipped (tooltip: "Requires weapon equipped")
7. Block with Shield chip disabled when no shield equipped (tooltip: "Requires shield equipped")
</verification>

<success_criteria>
- Build succeeds with no errors
- All existing tests pass
- Defense group shows stance chips below action tiles
- Stance chips derive state from character effects (not component state)
- Parry Mode chip costs AP/FAT to activate
- Dodge Focus and Block with Shield are free to toggle
- Normal chip clears any active stance
- Disabled chips have explanatory tooltips
</success_criteria>

<output>
After completion, create `.planning/phases/35-defense-group/35-01-SUMMARY.md`
</output>
