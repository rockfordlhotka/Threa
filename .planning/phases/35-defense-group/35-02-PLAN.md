---
phase: 35-defense-group
plan: 02
type: execute
wave: 2
depends_on: ["35-01"]
files_modified:
  - Threa/Threa.Client/Components/Pages/GamePlay/DefendMode.razor
  - Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor
autonomous: true

must_haves:
  truths:
    - "When player is in Dodge Focus stance and clicks Defend, DefendMode opens with Dodge pre-selected"
    - "When player is in Block with Shield stance and clicks Defend, DefendMode opens with ShieldBlock pre-selected"
    - "When player is in Parry Mode stance and clicks Defend, DefendMode opens with Parry pre-selected"
    - "When player is in Normal stance and clicks Defend, DefendMode opens with Passive pre-selected (default)"
    - "Player can still manually override the pre-selected defense type in DefendMode"
    - "Defend button shows a subtle visual hint when no AP available for active defense"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/DefendMode.razor"
      provides: "ActiveStance parameter with defense type pre-selection logic"
      contains: "ActiveStance"
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor"
      provides: "ActiveStance parameter passed to DefendMode, visual hint on Defend button"
      contains: "ActiveStance=\"@GetActiveStance()\""
  key_links:
    - from: "TabCombat.razor DefendMode invocation"
      to: "DefendMode.razor ActiveStance parameter"
      via: "Blazor parameter binding"
      pattern: "ActiveStance=\"@GetActiveStance\\(\\)\""
    - from: "DefendMode.razor OnParametersSetAsync"
      to: "DefenseTypeOption pre-selection"
      via: "switch on ActiveStance value"
      pattern: "ActiveStance switch"
---

<objective>
Wire stance-aware pre-selection into DefendMode and add a visual hint on the Defend button when active defense is unavailable.

Purpose: When a player has set a defensive stance, clicking Defend should pre-select the matching defense type for a streamlined experience. The Defend button should also indicate when only passive defense is available.
Output: DefendMode with ActiveStance parameter, TabCombat passing stance to DefendMode, Defend button AP hint.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-defense-group/35-CONTEXT.md
@.planning/phases/35-defense-group/35-RESEARCH.md
@.planning/phases/35-defense-group/35-01-SUMMARY.md
@Threa/Threa.Client/Components/Pages/GamePlay/DefendMode.razor
@Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ActiveStance parameter to DefendMode with pre-selection logic</name>
  <files>
    Threa/Threa.Client/Components/Pages/GamePlay/DefendMode.razor
  </files>
  <action>
Add a new `ActiveStance` parameter to DefendMode.razor and use it to pre-select the defense type when the component loads.

**Add parameter** in the `@code` block alongside existing parameters:
```csharp
[Parameter] public string? ActiveStance { get; set; }
```

**Modify `OnParametersSetAsync`** to pre-select defense type based on the active stance. Currently this method checks for `isInParryMode` and loads equipped armor. After the existing parry mode check and before/after `LoadEquippedArmor()`, add stance-based pre-selection:

```csharp
protected override async Task OnParametersSetAsync()
{
    if (Character != null)
    {
        isInParryMode = CombatStanceBehavior.IsInParryMode(Character);
        if (isInParryMode)
        {
            parrySkillName = CombatStanceBehavior.GetParrySkillName(Character);
            parrySkillAS = CombatStanceBehavior.GetParrySkillAS(Character);
        }

        // Pre-select defense type based on active stance (only on initial load, not after rolling)
        if (!hasRolled)
        {
            defenseType = ActiveStance switch
            {
                "dodge" when CanPerformActiveDefense() => DefenseTypeOption.Dodge,
                "parry" when isInParryMode => DefenseTypeOption.Parry,
                "block" when HasShieldEquipped && CanPerformActiveDefense() => DefenseTypeOption.ShieldBlock,
                _ => DefenseTypeOption.Passive
            };
        }

        await LoadEquippedArmor();
    }
}
```

The pre-selection only applies when:
- `!hasRolled` -- don't change defense type after a roll has been made
- The stance maps to a defense type the player can actually use (e.g., dodge requires AP, parry requires being in parry mode, shield block requires shield equipped)
- If the stance's defense type isn't available (e.g., "dodge" but no AP), fall back to Passive

The player can still manually override by clicking a different radio button -- the pre-selection just sets the initial state. The existing radio buttons and `SetDefenseType` method remain unchanged.
  </action>
  <verify>
    Run `dotnet build Threa.sln`. No compilation errors. The ActiveStance parameter is accepted by DefendMode and pre-selects defense type correctly.
  </verify>
  <done>
    DefendMode accepts an ActiveStance parameter. On load, it pre-selects: "dodge" -> Dodge, "parry" -> Parry, "block" -> ShieldBlock, anything else -> Passive. Pre-selection respects availability constraints. Player can still override.
  </done>
</task>

<task type="auto">
  <name>Task 2: Pass ActiveStance to DefendMode and add Defend button AP hint in TabCombat</name>
  <files>
    Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor
  </files>
  <action>
**Pass ActiveStance to DefendMode** -- In the `combatMode == CombatMode.Defend` section of TabCombat.razor, add the `ActiveStance` parameter to the DefendMode component invocation:

Change:
```html
<DefendMode Character="Character"
            Table="Table"
            HasWeaponEquipped="hasWeaponEquipped"
            HasShieldEquipped="hasShieldEquipped"
            WeaponSkillAS="weaponSkillAS"
            WeaponSkillName="weaponSkillName"
            ShieldSkillAS="shieldSkillAS"
            OnCancel="ReturnToDefault"
            OnDefenseComplete="OnDefenseComplete"
            OnHit="OnDefenseHit" />
```

To:
```html
<DefendMode Character="Character"
            Table="Table"
            HasWeaponEquipped="hasWeaponEquipped"
            HasShieldEquipped="hasShieldEquipped"
            WeaponSkillAS="weaponSkillAS"
            WeaponSkillName="weaponSkillName"
            ShieldSkillAS="shieldSkillAS"
            ActiveStance="@GetActiveStance()"
            OnCancel="ReturnToDefault"
            OnDefenseComplete="OnDefenseComplete"
            OnHit="OnDefenseHit" />
```

Note: `GetActiveStance()` was added in Plan 35-01 and returns "normal", "parry", "dodge", or "block".

**Add visual hint on Defend button** -- The Defend button should show a subtle visual hint when only passive defense is available (no AP for active defense). Per CONTEXT.md: "Defend button always visible; visual hint when no AP available for active defense (passive still works)."

Modify the Defend button in the Defense group:

Change:
```html
<button class="btn combat-tile combat-tile-defense"
        @onclick="StartDefend"
        disabled="@(Character?.IsPassedOut ?? true)"
        title="Defend against an attack">
    <i class="bi bi-shield-shaded"></i>
    <span>Defend</span>
</button>
```

To:
```html
<button class="btn combat-tile combat-tile-defense @(CanPerformActiveDefenseForStance() ? "" : "combat-tile-passive-only")"
        @onclick="StartDefend"
        disabled="@(Character?.IsPassedOut ?? true)"
        title="@(CanPerformActiveDefenseForStance() ? "Defend against an attack" : "Passive defense only (no AP for active defense)")">
    <i class="bi bi-shield-shaded"></i>
    <span>Defend</span>
</button>
```

The `CanPerformActiveDefenseForStance()` method was added in Plan 35-01.

**Add the passive-only CSS class to themes.css** -- Add a subtle visual hint style:

In `Threa/Threa/wwwroot/css/themes.css`, after the existing stance-chip styles (added in 35-01), add:

```css
/* Subtle hint when only passive defense is available */
.combat-tile-passive-only {
    opacity: 0.65;
}
```

This reduces opacity to signal that the button still works but with reduced capability. The tooltip text also changes to explain that only passive defense is available.
  </action>
  <verify>
    Run `dotnet build Threa.sln`. No compilation errors. Run `dotnet test GameMechanics.Test/GameMechanics.Test.csproj` -- all tests pass. Verify DefendMode receives ActiveStance and Defend button shows visual hint when AP is low.
  </verify>
  <done>
    TabCombat passes GetActiveStance() to DefendMode's ActiveStance parameter. Defend button shows reduced opacity + updated tooltip when player lacks AP for active defense but passive still works. Full defense workflow operates: stance chip -> click Defend -> DefendMode opens with matching defense type pre-selected.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Threa.sln` -- no errors
2. `dotnet test GameMechanics.Test/GameMechanics.Test.csproj` -- all existing tests pass
3. Full workflow test: Set stance to Dodge Focus -> click Defend -> DefendMode opens with Dodge radio pre-selected
4. Full workflow test: Set stance to Normal -> click Defend -> DefendMode opens with Passive pre-selected
5. Full workflow test: Parry Mode active -> click Defend -> DefendMode opens with Parry (Free) pre-selected
6. Full workflow test: Block with Shield active -> click Defend -> DefendMode opens with Shield Block pre-selected
7. Override test: Pre-selection sets Dodge, but player clicks Passive radio -> defense uses Passive (override works)
8. Defend button shows reduced opacity when character has no AP for active defense
9. Defend button tooltip changes to "Passive defense only" when no AP
</verification>

<success_criteria>
- Build succeeds with no errors
- All existing tests pass
- DefendMode accepts ActiveStance parameter and pre-selects matching defense type
- TabCombat passes stance value to DefendMode
- Defend button visually hints when only passive is available
- Pre-selection respects constraints (no AP -> falls back to Passive)
- Player can always override the pre-selected defense type
</success_criteria>

<output>
After completion, create `.planning/phases/35-defense-group/35-02-SUMMARY.md`
</output>
