---
phase: 22-concentration-system
plan: 05
type: execute
wave: 5
depends_on: ["22-04"]
files_modified:
  - Threa/Threa.Client/Components/Shared/ConcentrationBreakDialog.razor
  - Threa/Threa.Client/Components/Shared/ConcentrationBreakDialog.razor.cs
  - Threa/Threa.Client/wwwroot/css/app.css
autonomous: true
estimated_minutes: 20
gap_closure: true

must_haves:
  truths:
    - "ConcentrationBreakDialog component displays current concentration effect details"
    - "Dialog shows concentration type, progress (for casting-time), and linked effects (for sustained)"
    - "Dialog has Cancel button that closes without breaking concentration"
    - "Dialog has Break & Continue button that returns true to caller"
    - "Dialog can be opened programmatically via DialogService"
  artifacts:
    - path: "Threa/Threa.Client/Components/Shared/ConcentrationBreakDialog.razor"
      provides: "Confirmation dialog UI for breaking concentration"
      min_lines: 30
    - path: "Threa/Threa.Client/Components/Shared/ConcentrationBreakDialog.razor.cs"
      provides: "Dialog code-behind with parameters and button handlers"
      min_lines: 20
  key_links:
    - from: "ConcentrationBreakDialog"
      to: "DialogService"
      via: "DialogService.Close returns result"
      pattern: "DialogService\\.Close"
---

<objective>
Create the ConcentrationBreakDialog component for confirming concentration break before taking actions.

Purpose: Warn players before breaking concentration with clear information about what will be lost, providing Cancel and Break & Continue options.

Output: Radzen dialog component that displays concentration details and returns user's choice.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/22-concentration-system/22-CONTEXT.md
@.planning/phases/22-concentration-system/22-04-SUMMARY.md

Key context:
- Project uses Radzen.Blazor components including RadzenDialog
- Existing dialog patterns in EffectFormModal.razor, WoundModal.razor
- DialogService used for modal dialogs with return values
- ConcentrationState has ConcentrationType, SpellName, CurrentProgress, TotalRequired, LinkedEffectIds

UI Design (from CONCENTRATION_SYSTEM.md):
```
+-------------------------------------+
| Break Concentration?                |
+-------------------------------------+
| You are concentrating on:           |
| "Invisibility" (3 rounds remaining) |
|                                     |
| Taking this action will end the     |
| effect immediately.                 |
|                                     |
| [Cancel] [Break & Continue]         |
+-------------------------------------+
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConcentrationBreakDialog.razor component</name>
  <files>Threa/Threa.Client/Components/Shared/ConcentrationBreakDialog.razor</files>
  <action>
Create a new Razor component for the concentration break confirmation dialog:

```razor
@using GameMechanics.Effects.Behaviors
@using Threa.Dal.Dto

<div class="concentration-break-dialog">
    <div class="dialog-content">
        <p class="mb-3">You are concentrating on:</p>

        <div class="concentration-details card p-3 mb-3 bg-light">
            <h5 class="mb-2">@GetConcentrationName()</h5>
            @if (IsCastingTime)
            {
                <p class="text-muted mb-0">
                    <i class="rzi rzi-time"></i>
                    Progress: @CurrentProgress / @TotalRequired rounds
                </p>
                <p class="text-warning mb-0">
                    <small>Interrupting will cancel the action.</small>
                </p>
            }
            else if (IsSustained)
            {
                @if (LinkedEffectCount > 0)
                {
                    <p class="text-muted mb-0">
                        <i class="rzi rzi-link"></i>
                        Maintaining @LinkedEffectCount effect(s) on target(s)
                    </p>
                }
                @if (DrainPerRound != null)
                {
                    <p class="text-muted mb-0">
                        <i class="rzi rzi-flash"></i>
                        Draining @DrainPerRound per round
                    </p>
                }
                <p class="text-warning mb-0">
                    <small>Breaking will end the effect immediately.</small>
                </p>
            }
        </div>

        <p class="text-danger">
            <strong>Taking this action will break concentration.</strong>
        </p>
    </div>

    <div class="dialog-buttons d-flex justify-content-end gap-2 mt-4">
        <RadzenButton Text="Cancel"
                      ButtonStyle="ButtonStyle.Light"
                      Click="@OnCancel" />
        <RadzenButton Text="Break & Continue"
                      ButtonStyle="ButtonStyle.Danger"
                      Click="@OnConfirm" />
    </div>
</div>
```
  </action>
  <verify>Component file exists and contains RadzenButton elements</verify>
  <done>ConcentrationBreakDialog.razor created with concentration details display and action buttons</done>
</task>

<task type="auto">
  <name>Task 2: Create ConcentrationBreakDialog.razor.cs code-behind</name>
  <files>Threa/Threa.Client/Components/Shared/ConcentrationBreakDialog.razor.cs</files>
  <action>
Create the code-behind file with parameters and button handlers:

```csharp
using Microsoft.AspNetCore.Components;
using Radzen;
using GameMechanics.Effects.Behaviors;

namespace Threa.Client.Components.Shared;

public partial class ConcentrationBreakDialog : ComponentBase
{
    [Inject]
    public DialogService DialogService { get; set; } = default!;

    /// <summary>
    /// The concentration type (e.g., "MagazineReload", "SustainedSpell")
    /// </summary>
    [Parameter]
    public string? ConcentrationType { get; set; }

    /// <summary>
    /// The name of the concentration effect (e.g., "Invisibility", "Reloading Magazine")
    /// </summary>
    [Parameter]
    public string? EffectName { get; set; }

    /// <summary>
    /// The spell name for sustained spells
    /// </summary>
    [Parameter]
    public string? SpellName { get; set; }

    /// <summary>
    /// Current progress for casting-time concentration
    /// </summary>
    [Parameter]
    public int CurrentProgress { get; set; }

    /// <summary>
    /// Total required rounds for casting-time concentration
    /// </summary>
    [Parameter]
    public int TotalRequired { get; set; }

    /// <summary>
    /// Number of linked effects for sustained concentration
    /// </summary>
    [Parameter]
    public int LinkedEffectCount { get; set; }

    /// <summary>
    /// FAT drain per round for sustained concentration
    /// </summary>
    [Parameter]
    public int FatDrainPerRound { get; set; }

    /// <summary>
    /// VIT drain per round for sustained concentration
    /// </summary>
    [Parameter]
    public int VitDrainPerRound { get; set; }

    private bool IsCastingTime => ConcentrationType == "MagazineReload"
        || ConcentrationType == "SpellCasting"
        || ConcentrationType == "RitualPreparation";

    private bool IsSustained => ConcentrationType == "SustainedSpell"
        || ConcentrationType == "SustainedAbility"
        || ConcentrationType == "MentalControl";

    private string? DrainPerRound
    {
        get
        {
            var parts = new List<string>();
            if (FatDrainPerRound > 0)
                parts.Add($"{FatDrainPerRound} FAT");
            if (VitDrainPerRound > 0)
                parts.Add($"{VitDrainPerRound} VIT");

            return parts.Count > 0 ? string.Join(" + ", parts) : null;
        }
    }

    private string GetConcentrationName()
    {
        if (!string.IsNullOrEmpty(SpellName))
            return SpellName;
        if (!string.IsNullOrEmpty(EffectName))
            return EffectName;
        return ConcentrationType ?? "Unknown";
    }

    private void OnCancel()
    {
        DialogService.Close(false);
    }

    private void OnConfirm()
    {
        DialogService.Close(true);
    }
}
```
  </action>
  <verify>dotnet build Threa/Threa.Client/Threa.Client.csproj</verify>
  <done>ConcentrationBreakDialog.razor.cs created with parameters for all concentration details and button handlers</done>
</task>

<task type="auto">
  <name>Task 3: Add dialog styling</name>
  <files>Threa/Threa.Client/wwwroot/css/app.css</files>
  <action>
Add CSS for the concentration break dialog at the end of app.css (or in an appropriate section):

```css
/* Concentration Break Dialog */
.concentration-break-dialog {
    min-width: 350px;
    padding: 1rem;
}

.concentration-break-dialog .concentration-details {
    border-left: 4px solid var(--rz-warning);
}

.concentration-break-dialog .concentration-details h5 {
    color: var(--rz-text-color);
    font-weight: 600;
}
```
  </action>
  <verify>CSS file contains concentration-break-dialog class</verify>
  <done>Dialog styling added with warning accent and proper spacing</done>
</task>

<task type="auto">
  <name>Task 4: Add static helper method for opening dialog</name>
  <files>Threa/Threa.Client/Components/Shared/ConcentrationBreakDialog.razor.cs</files>
  <action>
Add a static helper method to simplify opening the dialog from other components:

```csharp
/// <summary>
/// Shows the concentration break confirmation dialog.
/// </summary>
/// <param name="dialogService">The dialog service</param>
/// <param name="concentrationState">The current concentration state</param>
/// <param name="effectName">The effect name to display</param>
/// <returns>True if user chose to break concentration, false if cancelled</returns>
public static async Task<bool> ShowAsync(
    DialogService dialogService,
    ConcentrationState state,
    string effectName)
{
    var parameters = new Dictionary<string, object>
    {
        { nameof(ConcentrationType), state.ConcentrationType },
        { nameof(EffectName), effectName },
        { nameof(SpellName), state.SpellName ?? "" },
        { nameof(CurrentProgress), state.CurrentProgress },
        { nameof(TotalRequired), state.TotalRequired },
        { nameof(LinkedEffectCount), state.LinkedEffectIds?.Count ?? 0 },
        { nameof(FatDrainPerRound), state.FatDrainPerRound },
        { nameof(VitDrainPerRound), state.VitDrainPerRound }
    };

    var result = await dialogService.OpenAsync<ConcentrationBreakDialog>(
        "Break Concentration?",
        parameters,
        new DialogOptions
        {
            Width = "400px",
            CloseDialogOnOverlayClick = true,
            ShowClose = true
        });

    return result is bool confirmed && confirmed;
}
```

Also add required using statement at the top:
```csharp
using GameMechanics.Effects.Behaviors;
```
  </action>
  <verify>dotnet build Threa/Threa.Client/Threa.Client.csproj</verify>
  <done>Static ShowAsync helper method added for easy dialog invocation</done>
</task>

</tasks>

<verification>
1. Build succeeds: `dotnet build Threa/Threa.sln`
2. Code review:
   - ConcentrationBreakDialog.razor displays concentration name and details
   - Casting-time concentration shows progress and "will cancel" warning
   - Sustained concentration shows linked effects and drain rate
   - Cancel button calls DialogService.Close(false)
   - Break & Continue button calls DialogService.Close(true)
   - Static ShowAsync helper creates dialog with all parameters
3. Manual testing:
   - Dialog opens with correct title
   - Clicking Cancel closes without returning true
   - Clicking Break & Continue returns true
</verification>

<success_criteria>
- ConcentrationBreakDialog component exists with proper Razor markup
- Dialog displays concentration type, name, progress (casting-time), or linked effects (sustained)
- Cancel button closes dialog returning false
- Break & Continue button closes dialog returning true
- Static ShowAsync helper simplifies dialog invocation
- Component builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-concentration-system/22-05-SUMMARY.md`
</output>

---

## Notes

**Dialog Design**: The dialog follows the project's existing modal patterns using Radzen DialogService. It displays different information based on concentration type:
- Casting-time: Shows progress (X/Y rounds) and warns that action will be cancelled
- Sustained: Shows linked effect count and drain rate, warns effect will end immediately

**Integration Point**: This dialog is invoked by UI code before executing actions that would break concentration. The calling code checks `IsConcentrating()`, opens this dialog, and only proceeds if the user confirms.

**Action System Integration**: Plan 22-05 creates the dialog component. The actual integration with action buttons (checking concentration before actions) will be done as part of future action system work or can be integrated into existing action handling code.

---

*Plan created: 2026-01-29*
*Gap closure for: Taking active actions prompts to break concentration with confirmation*
