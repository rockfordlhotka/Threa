---
phase: 22-concentration-system
plan: 06
type: execute
wave: 5
depends_on: ["22-04"]
files_modified:
  - GameMechanics/Combat/DefenseResolver.cs
  - GameMechanics.Test/DefenseConcentrationTests.cs
autonomous: true
estimated_minutes: 20
gap_closure: true

must_haves:
  truths:
    - "DefenseResolver triggers concentration check when defender is concentrating and uses passive defense"
    - "Concentration check uses Focus AS + 4dF+ vs attacker AV with damage penalty"
    - "Active defense does NOT trigger concentration check (breaks concentration before defense)"
    - "DefenseResult includes ConcentrationCheckResult when check was performed"
    - "Concentration automatically breaks when FAT or VIT reaches 0"
  artifacts:
    - path: "GameMechanics/Combat/DefenseResolver.cs"
      provides: "Concentration check integration in defense resolution"
      contains: "CheckConcentration|IsConcentrating|ConcentrationCheckResult"
    - path: "GameMechanics.Test/DefenseConcentrationTests.cs"
      provides: "Tests for defense-triggered concentration checks"
      min_lines: 60
  key_links:
    - from: "DefenseResolver"
      to: "CharacterEdit.CheckConcentration"
      via: "calls after damage calculation for passive defense"
      pattern: "CheckConcentration.*attackerAV.*damage"
---

<objective>
Integrate concentration checks with the defense system: trigger checks on passive defense and handle automatic breaking on health depletion.

Purpose: When a concentrating character is attacked and chooses passive defense, they must make a concentration check. Damage taken applies a penalty to this check.

Output: DefenseResolver with concentration check integration, ConcentrationCheckResult in DefenseResult, and comprehensive tests.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/22-concentration-system/22-CONTEXT.md
@.planning/phases/22-concentration-system/22-04-SUMMARY.md

Key context:
- CharacterEdit.CheckConcentration(attackerAV, damageDealt, diceRoller) performs the check
- ConcentrationBehavior.IsConcentrating(character) checks if concentrating
- ConcentrationBehavior.BreakConcentration(character, reason) breaks concentration
- DefenseResolver pattern: takes DefenseRequest, returns DefenseResult
- Passive defense: no skill roll, uses AS-1 as TV
- Active defense: skill roll required, breaks concentration

Design spec (from CONCENTRATION_SYSTEM.md):
- Active Defense: Automatically breaks concentration BEFORE the defense roll
- Passive Defense: Concentration check AFTER damage resolution
- Check happens regardless of hit/miss, but damage penalty only applies if hit
- Auto-break on incapacitation (FAT or VIT reaches 0)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ConcentrationCheckResult to DefenseResult</name>
  <files>GameMechanics/Combat/DefenseResolver.cs</files>
  <action>
First, find the DefenseResult class (may be in DefenseResolver.cs or a separate file). Add a property for the concentration check result:

```csharp
/// <summary>
/// Result of concentration check if defender was concentrating and used passive defense.
/// Null if not concentrating or used active defense.
/// </summary>
public ConcentrationCheckResult? ConcentrationCheck { get; set; }

/// <summary>
/// True if concentration was broken during this defense (either by active defense or failed check).
/// </summary>
public bool ConcentrationBroken { get; set; }
```

Add the required using statement: `using GameMechanics.Effects.Behaviors;`

If ConcentrationCheckResult is in CharacterEdit.cs, the using may need to reference that namespace or the class may need to be moved to a shared location.
  </action>
  <verify>dotnet build GameMechanics/GameMechanics.csproj</verify>
  <done>DefenseResult has ConcentrationCheck and ConcentrationBroken properties</done>
</task>

<task type="auto">
  <name>Task 2: Break concentration on active defense</name>
  <files>GameMechanics/Combat/DefenseResolver.cs</files>
  <action>
Find the section in DefenseResolver.Resolve() where active defense is chosen/processed. Add concentration breaking BEFORE the defense roll:

```csharp
// Near the start of active defense processing
if (ConcentrationBehavior.IsConcentrating(request.Defender))
{
    ConcentrationBehavior.BreakConcentration(
        request.Defender,
        "Chose active defense - concentration broken");
    result.ConcentrationBroken = true;
}
```

This should happen early in active defense processing, before any skill rolls.
  </action>
  <verify>dotnet build GameMechanics/GameMechanics.csproj</verify>
  <done>Active defense breaks concentration before defense roll</done>
</task>

<task type="auto">
  <name>Task 3: Add concentration check for passive defense</name>
  <files>GameMechanics/Combat/DefenseResolver.cs</files>
  <action>
Find the section where passive defense damage is calculated/applied. Add concentration check AFTER damage is determined:

```csharp
// After damage calculation for passive defense
if (ConcentrationBehavior.IsConcentrating(request.Defender))
{
    // Calculate damage dealt (may be 0 if attack missed)
    int damageDealt = result.DamageDealt ?? 0;

    // Perform concentration check
    var checkResult = request.Defender.CheckConcentration(
        request.AttackerAV,
        damageDealt,
        request.DiceRoller ?? new Dice());

    result.ConcentrationCheck = checkResult;
    result.ConcentrationBroken = !checkResult.Success;
}
```

Notes:
- request.AttackerAV should be the attacker's roll result (TV for the check)
- request.DiceRoller may need to be added to DefenseRequest if not present
- Damage penalty applies even if it's 0 (no penalty in that case)
  </action>
  <verify>dotnet build GameMechanics/GameMechanics.csproj</verify>
  <done>Passive defense triggers concentration check with attacker AV and damage dealt</done>
</task>

<task type="auto">
  <name>Task 4: Add auto-break on health depletion</name>
  <files>GameMechanics/Combat/DefenseResolver.cs</files>
  <action>
After damage is applied in passive defense resolution, check for health depletion:

```csharp
// After damage is applied (pending damage or immediate)
// Check for automatic concentration break on incapacitation
if (ConcentrationBehavior.IsConcentrating(request.Defender))
{
    bool fatigueExhausted = request.Defender.FatigueDamage >= request.Defender.MaxFatigue;
    bool vitalityExhausted = request.Defender.VitalityDamage >= request.Defender.MaxVitality;

    if (fatigueExhausted || vitalityExhausted)
    {
        ConcentrationBehavior.BreakConcentration(
            request.Defender,
            "Incapacitated - concentration broken");
        result.ConcentrationBroken = true;
    }
}
```

Note: This check may happen even if the concentration check succeeded, because the damage could have depleted health pools to 0.
  </action>
  <verify>dotnet build GameMechanics/GameMechanics.csproj</verify>
  <done>Concentration automatically breaks when FAT or VIT reaches 0</done>
</task>

<task type="auto">
  <name>Task 5: Create defense concentration tests</name>
  <files>GameMechanics.Test/DefenseConcentrationTests.cs</files>
  <action>
Create a new test file for defense-triggered concentration checks. Use DeterministicDiceRoller for predictable results.

Tests to include:
1. PassiveDefense_WhenConcentrating_TriggersConcentrationCheck
2. PassiveDefense_SuccessfulCheck_MaintainsConcentration
3. PassiveDefense_FailedCheck_BreaksConcentration
4. PassiveDefense_DamagePenalty_AppliedToCheck
5. PassiveDefense_NoDamage_NoPenalty
6. ActiveDefense_WhenConcentrating_BreaksBeforeRoll
7. PassiveDefense_FatigueExhausted_AutoBreaks
8. PassiveDefense_VitalityExhausted_AutoBreaks
9. PassiveDefense_NotConcentrating_NoCheck

Use the test patterns established in the project:
- DeterministicDiceRoller for controlled roll results
- Set up defender with Focus skill and concentration effect
- Create AttackRequest/DefenseRequest with appropriate values
- Verify ConcentrationCheck result in DefenseResult
  </action>
  <verify>dotnet test GameMechanics.Test/GameMechanics.Test.csproj --filter "FullyQualifiedName~DefenseConcentrationTests"</verify>
  <done>All 9 tests pass covering defense-triggered concentration checks and auto-breaking</done>
</task>

</tasks>

<verification>
1. Build succeeds: `dotnet build Threa.sln`
2. Tests pass: `dotnet test GameMechanics.Test/GameMechanics.Test.csproj --filter "FullyQualifiedName~DefenseConcentration"`
3. Code review:
   - DefenseResult includes ConcentrationCheck and ConcentrationBroken properties
   - Active defense breaks concentration BEFORE defense roll
   - Passive defense triggers concentration check AFTER damage calculation
   - Concentration check uses attacker AV as TV
   - Damage penalty applied correctly (-1 per 2 damage)
   - Auto-break on FAT/VIT reaching 0
</verification>

<success_criteria>
- DefenseResult has ConcentrationCheck and ConcentrationBroken properties
- Active defense breaks concentration before defense roll (no check)
- Passive defense triggers CheckConcentration with attacker AV and damage dealt
- Damage penalty (-1 per 2) applied to concentration check
- Concentration auto-breaks when FAT or VIT reaches 0
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/22-concentration-system/22-06-SUMMARY.md`
</output>

---

## Notes

**Defense Choice Flow**:
1. Attack declared against concentrating character
2. Defender chooses defense type:
   - **Active Defense**: Concentration breaks immediately (before roll). Defender then makes normal active defense roll.
   - **Passive Defense**: Defense resolves normally. After damage calculated, concentration check is made.

**Concentration Check Timing**:
- The check happens AFTER damage is determined, so the penalty can be calculated
- The check happens regardless of whether the attack hit - being under attack risks breaking concentration
- If hit, damage penalty = -(damage / 2) rounded down

**Auto-Break Priority**:
If a passive defense results in health depletion to 0, concentration breaks even if the check would have succeeded. The order is:
1. Damage applied
2. Concentration check made
3. Health depletion check
4. If either check or depletion fails, concentration breaks

**Wave Assignment**: This plan is Wave 5 because it depends on 22-04 (CharacterEdit.CheckConcentration). It can run in parallel with 22-05 (dialog component) since they don't share files.

---

*Plan created: 2026-01-29*
*Gap closure for: Passive defense triggers concentration check + Auto-break on incapacitation*
