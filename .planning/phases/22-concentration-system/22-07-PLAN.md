---
phase: 22-concentration-system
plan: 07
type: execute
wave: 6
depends_on: ["22-05", "22-06"]
files_modified:
  - Threa/Threa.Client/Components/Shared/ConcentrationIndicator.razor
  - Threa/Threa.Client/Components/Shared/ConcentrationIndicator.razor.cs
  - Threa/Threa.Client/Components/Pages/GamePlay/TabStatus.razor
  - Threa/Threa.Client/Components/Shared/CharacterStatusCard.razor
  - Threa/Threa.Client/wwwroot/css/app.css
autonomous: true
estimated_minutes: 30
gap_closure: true

must_haves:
  truths:
    - "ConcentrationIndicator displays concentration type and name"
    - "Casting-time concentration shows progress bar (X/Y rounds)"
    - "Sustained concentration shows linked effect count and drain rate"
    - "Indicator visible in TabStatus for player view"
    - "Indicator visible in CharacterStatusCard for GM dashboard"
    - "Drop Concentration button available for voluntary break"
  artifacts:
    - path: "Threa/Threa.Client/Components/Shared/ConcentrationIndicator.razor"
      provides: "Reusable concentration status display component"
      min_lines: 40
    - path: "Threa/Threa.Client/Components/Shared/ConcentrationIndicator.razor.cs"
      provides: "Component logic for concentration display"
      min_lines: 30
  key_links:
    - from: "TabStatus.razor"
      to: "ConcentrationIndicator"
      via: "renders when character is concentrating"
      pattern: "ConcentrationIndicator.*IsConcentrating"
    - from: "CharacterStatusCard.razor"
      to: "ConcentrationIndicator"
      via: "renders when character is concentrating"
      pattern: "ConcentrationIndicator.*IsConcentrating"
---

<objective>
Create UI components to display concentration status: indicator with progress/drain info, integration into player Status tab and GM dashboard cards.

Purpose: Players and GMs need visibility into concentration state - what's being concentrated on, progress (casting-time), drain rate (sustained), and ability to drop concentration voluntarily.

Output: ConcentrationIndicator component integrated into TabStatus and CharacterStatusCard.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/22-concentration-system/22-CONTEXT.md
@.planning/phases/22-concentration-system/22-05-SUMMARY.md
@.planning/phases/22-concentration-system/22-06-SUMMARY.md

Key context:
- ConcentrationBehavior.IsConcentrating(character) checks concentration status
- CharacterEdit.GetConcentrationEffect() returns the active concentration effect
- CharacterEdit.GetConcentrationType() returns the concentration type
- ConcentrationState has SpellName, CurrentProgress, TotalRequired, LinkedEffectIds, FatDrainPerRound, VitDrainPerRound
- ConcentrationBehavior.BreakConcentration(character, reason) for voluntary drop
- Radzen components (RadzenProgressBar, RadzenBadge) for UI elements
- TabStatus.razor displays character status for player
- CharacterStatusCard.razor displays character summary for GM dashboard

UI Design (from CONCENTRATION_SYSTEM.md):
- Show concentration icon/badge when concentrating
- Display effect name being concentrated on
- For casting-time: show progress (X of Y rounds)
- For sustained: show linked effects count and drain rate
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConcentrationIndicator.razor component</name>
  <files>Threa/Threa.Client/Components/Shared/ConcentrationIndicator.razor</files>
  <action>
Create a new Razor component for displaying concentration status:

```razor
@using GameMechanics.Effects.Behaviors
@using Threa.Dal.Dto

@if (IsConcentrating)
{
    <div class="concentration-indicator @(Compact ? "compact" : "")">
        <div class="concentration-header d-flex align-items-center gap-2">
            <RadzenBadge BadgeStyle="BadgeStyle.Warning" IsPill="true">
                <i class="rzi rzi-brain me-1"></i>
                Concentrating
            </RadzenBadge>
            <span class="concentration-name">@GetConcentrationName()</span>
        </div>

        @if (!Compact)
        {
            <div class="concentration-details mt-2">
                @if (IsCastingTime)
                {
                    <div class="progress-section">
                        <small class="text-muted d-block mb-1">
                            @CurrentProgress / @TotalRequired rounds
                        </small>
                        <RadzenProgressBar Value="@ProgressPercent"
                                           Max="100"
                                           ShowValue="false"
                                           Style="height: 8px;" />
                    </div>
                }
                else if (IsSustained)
                {
                    <div class="sustained-section">
                        @if (LinkedEffectCount > 0)
                        {
                            <small class="text-muted d-block">
                                <i class="rzi rzi-link"></i>
                                @LinkedEffectCount linked effect(s)
                            </small>
                        }
                        @if (!string.IsNullOrEmpty(DrainDisplay))
                        {
                            <small class="text-warning d-block">
                                <i class="rzi rzi-flash"></i>
                                @DrainDisplay/round
                            </small>
                        }
                    </div>
                }
            </div>

            @if (ShowDropButton)
            {
                <div class="concentration-actions mt-2">
                    <RadzenButton Text="Drop Concentration"
                                  Size="ButtonSize.Small"
                                  ButtonStyle="ButtonStyle.Light"
                                  Click="@OnDropConcentration" />
                </div>
            }
        }
    </div>
}
```
  </action>
  <verify>Component file exists and contains RadzenBadge and RadzenProgressBar elements</verify>
  <done>ConcentrationIndicator.razor created with concentration type display, progress bar, and drain info</done>
</task>

<task type="auto">
  <name>Task 2: Create ConcentrationIndicator.razor.cs code-behind</name>
  <files>Threa/Threa.Client/Components/Shared/ConcentrationIndicator.razor.cs</files>
  <action>
Create the code-behind file with parameters and computed properties:

```csharp
using Microsoft.AspNetCore.Components;
using GameMechanics;
using GameMechanics.Effects.Behaviors;
using Threa.Dal.Dto;

namespace Threa.Client.Components.Shared;

public partial class ConcentrationIndicator : ComponentBase
{
    /// <summary>
    /// The character to display concentration status for.
    /// </summary>
    [Parameter]
    public CharacterEdit? Character { get; set; }

    /// <summary>
    /// If true, shows compact view (badge only, no progress/details).
    /// </summary>
    [Parameter]
    public bool Compact { get; set; }

    /// <summary>
    /// If true, shows the Drop Concentration button.
    /// </summary>
    [Parameter]
    public bool ShowDropButton { get; set; } = true;

    /// <summary>
    /// Callback when concentration is dropped voluntarily.
    /// </summary>
    [Parameter]
    public EventCallback OnConcentrationDropped { get; set; }

    private bool IsConcentrating => Character != null && ConcentrationBehavior.IsConcentrating(Character);

    private ConcentrationState? State
    {
        get
        {
            if (Character == null) return null;
            var effect = Character.GetConcentrationEffect();
            if (effect == null) return null;
            return ConcentrationState.FromJson(effect.BehaviorState);
        }
    }

    private bool IsCastingTime => State?.ConcentrationType is "MagazineReload" or "SpellCasting" or "RitualPreparation";
    private bool IsSustained => State?.ConcentrationType is "SustainedSpell" or "SustainedAbility" or "MentalControl";

    private int CurrentProgress => State?.CurrentProgress ?? 0;
    private int TotalRequired => State?.TotalRequired ?? 1;
    private int LinkedEffectCount => State?.LinkedEffectIds?.Count ?? 0;

    private double ProgressPercent
    {
        get
        {
            if (TotalRequired <= 0) return 0;
            return Math.Min(100, (double)CurrentProgress / TotalRequired * 100);
        }
    }

    private string? DrainDisplay
    {
        get
        {
            if (State == null) return null;
            var parts = new List<string>();
            if (State.FatDrainPerRound > 0)
                parts.Add($"{State.FatDrainPerRound} FAT");
            if (State.VitDrainPerRound > 0)
                parts.Add($"{State.VitDrainPerRound} VIT");
            return parts.Count > 0 ? string.Join(" + ", parts) : null;
        }
    }

    private string GetConcentrationName()
    {
        if (State?.SpellName != null)
            return State.SpellName;

        var effect = Character?.GetConcentrationEffect();
        if (effect?.Name != null)
            return effect.Name;

        return State?.ConcentrationType ?? "Unknown";
    }

    private async Task OnDropConcentration()
    {
        if (Character != null)
        {
            ConcentrationBehavior.BreakConcentration(Character, "Voluntarily dropped concentration");
            await OnConcentrationDropped.InvokeAsync();
        }
    }
}
```
  </action>
  <verify>dotnet build Threa/Threa.Client/Threa.Client.csproj</verify>
  <done>ConcentrationIndicator.razor.cs created with character parameter, state parsing, and computed properties</done>
</task>

<task type="auto">
  <name>Task 3: Add component styling</name>
  <files>Threa/Threa.Client/wwwroot/css/app.css</files>
  <action>
Add CSS for the concentration indicator at the end of app.css:

```css
/* Concentration Indicator */
.concentration-indicator {
    background: var(--rz-base-100);
    border: 1px solid var(--rz-warning);
    border-left: 4px solid var(--rz-warning);
    border-radius: var(--rz-border-radius);
    padding: 0.75rem;
    margin-bottom: 0.5rem;
}

.concentration-indicator.compact {
    padding: 0.25rem 0.5rem;
    background: transparent;
    border: none;
}

.concentration-indicator .concentration-name {
    font-weight: 500;
    color: var(--rz-text-color);
}

.concentration-indicator .progress-section .rz-progressbar {
    background: var(--rz-base-200);
}

.concentration-indicator .sustained-section small {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}
```
  </action>
  <verify>CSS file contains concentration-indicator class</verify>
  <done>Component styling added with warning accent, progress bar styling, and compact mode</done>
</task>

<task type="auto">
  <name>Task 4: Integrate into TabStatus.razor</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/TabStatus.razor</files>
  <action>
Find TabStatus.razor and add the ConcentrationIndicator near the top of the status display (after health pools, before effects list).

Add the component reference:

```razor
@* Near the top of status content, after health bars *@
<ConcentrationIndicator Character="@Character"
                        ShowDropButton="true"
                        OnConcentrationDropped="@OnCharacterChanged" />
```

If there's no OnCharacterChanged callback, use an appropriate callback or create a simple refresh method:

```csharp
private async Task RefreshCharacter()
{
    StateHasChanged();
    // If character needs to be re-fetched, do so here
}
```

Make sure to add the using directive if needed:
```razor
@using Threa.Client.Components.Shared
```
  </action>
  <verify>dotnet build Threa/Threa.Client/Threa.Client.csproj</verify>
  <done>ConcentrationIndicator integrated into TabStatus showing player's concentration status</done>
</task>

<task type="auto">
  <name>Task 5: Integrate into CharacterStatusCard.razor</name>
  <files>Threa/Threa.Client/Components/Shared/CharacterStatusCard.razor</files>
  <action>
Find CharacterStatusCard.razor and add a compact ConcentrationIndicator to show concentration status in the GM dashboard.

Add the component in compact mode (just the badge, no progress details):

```razor
@* In the card body, possibly near the effects count *@
<ConcentrationIndicator Character="@Character"
                        Compact="true"
                        ShowDropButton="false" />
```

For the GM dashboard cards, we want:
- Compact mode (just badge + name)
- No drop button (GM clicks to open modal for detailed view)

Make sure to add the using directive if needed:
```razor
@using Threa.Client.Components.Shared
```
  </action>
  <verify>dotnet build Threa/Threa.Client/Threa.Client.csproj</verify>
  <done>Compact ConcentrationIndicator integrated into CharacterStatusCard for GM dashboard view</done>
</task>

</tasks>

<verification>
1. Build succeeds: `dotnet build Threa/Threa.sln`
2. Code review:
   - ConcentrationIndicator displays badge with "Concentrating" label
   - Casting-time shows progress bar and X/Y rounds text
   - Sustained shows linked effect count and drain rate
   - Compact mode shows only badge and name
   - Drop button calls BreakConcentration and invokes callback
3. Manual testing:
   - TabStatus shows full concentration indicator when character is concentrating
   - CharacterStatusCard shows compact badge when character is concentrating
   - Drop Concentration button works and refreshes display
   - Progress bar fills as rounds complete (for casting-time)
</verification>

<success_criteria>
- ConcentrationIndicator component displays concentration type, name, and appropriate details
- Casting-time concentration shows progress bar with X/Y rounds
- Sustained concentration shows linked effect count and drain rate per round
- TabStatus renders ConcentrationIndicator for player view with drop button
- CharacterStatusCard renders compact ConcentrationIndicator for GM dashboard
- Drop Concentration button calls BreakConcentration and refreshes UI
- Component builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-concentration-system/22-07-SUMMARY.md`
</output>

---

## Notes

**Component Modes**:
- **Full Mode** (TabStatus): Shows all details - badge, name, progress/drain info, drop button
- **Compact Mode** (CharacterStatusCard): Shows only badge and name for space efficiency

**Drop Button Behavior**:
- Player can voluntarily drop concentration at any time
- Uses BreakConcentration which triggers OnRemove (handles cleanup)
- Invokes callback so parent can refresh character state

**Integration Points**:
- TabStatus: Player's view of their own character
- CharacterStatusCard: GM's dashboard showing all characters
- CharacterDetailModal: Could also integrate for GM to see full details (future enhancement)

**Linked Effects Processing**: The LastConcentrationResult from sustained concentration break (with LinkedEffectIds) would be processed here when the UI receives notification of concentration ending. However, since the actual effect removal requires iterating through table characters, that logic belongs in a higher-level handler (e.g., in GmTable page or a dedicated service). This plan focuses on the display component.

---

*Plan created: 2026-01-29*
*Gap closure for: UI displays concentration type, progress, linked effects, and drain cost*
