---
phase: 22-concentration-system
plan: 08
type: gap_closure
wave: 8
depends_on: ["22-05", "22-07"]
files_modified:
  - Threa/Threa.Client/Components/Pages/GamePlay/AttackMode.razor
  - Threa/Threa.Client/Components/Pages/GamePlay/RangedAttackMode.razor
  - Threa/Threa.Client/Components/Pages/GamePlay/ReloadMode.razor
autonomous: true
estimated_minutes: 15

must_haves:
  truths:
    - "Taking active actions prompts to break concentration with confirmation"
    - "ExecuteAttack in AttackMode.razor checks IsConcentrating before executing"
    - "ExecuteAttack in RangedAttackMode.razor checks IsConcentrating before executing"
    - "ExecuteReload in ReloadMode.razor checks IsConcentrating before executing"
    - "ConcentrationBreakDialog.ShowAsync is called when character is concentrating"
    - "Action only executes if user confirms breaking concentration (returns true)"
    - "Action is cancelled if user declines to break concentration (returns false)"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/AttackMode.razor"
      provides: "Melee attack action with concentration check before execution"
      contains: ["ConcentrationBreakDialog", "GetConcentrationEffect", "ShowAsync"]
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/RangedAttackMode.razor"
      provides: "Ranged attack action with concentration check before execution"
      contains: ["ConcentrationBreakDialog", "GetConcentrationEffect", "ShowAsync"]
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/ReloadMode.razor"
      provides: "Reload action with concentration check before execution"
      contains: ["ConcentrationBreakDialog", "GetConcentrationEffect", "ShowAsync"]
  key_links:
    - from: "AttackMode"
      to: "ConcentrationBreakDialog"
      via: "ShowAsync returns confirmation"
      pattern: "ConcentrationBreakDialog\\.ShowAsync"
    - from: "RangedAttackMode"
      to: "ConcentrationBreakDialog"
      via: "ShowAsync returns confirmation"
      pattern: "ConcentrationBreakDialog\\.ShowAsync"
    - from: "ReloadMode"
      to: "ConcentrationBreakDialog"
      via: "ShowAsync returns confirmation"
      pattern: "ConcentrationBreakDialog\\.ShowAsync"
---

<objective>
Integrate ConcentrationBreakDialog into action execution flow for AttackMode, RangedAttackMode, and ReloadMode components.

Purpose: Close the remaining Phase 22 gap - "Taking active actions prompts to break concentration with confirmation"

Output: All three action components check for active concentration before executing and show confirmation dialog, only proceeding if the user confirms.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/22-concentration-system/22-CONTEXT.md
@.planning/phases/22-concentration-system/22-05-SUMMARY.md

Key context:
- ConcentrationBreakDialog.ShowAsync(DialogService, ConcentrationState, effectName) returns Task<bool>
- CharacterEdit.GetConcentrationEffect() returns EffectRecord? (null if not concentrating)
- ConcentrationState.FromJson(effect.BehaviorState) extracts state from effect
- ConcentrationBehavior.BreakConcentration(character, reason) breaks concentration if confirmed
- DialogService injected via @inject Radzen.DialogService DialogService

Pattern for checking concentration before action:
```csharp
// At start of ExecuteAttack/ExecuteReload
var concentrationEffect = Character?.GetConcentrationEffect();
if (concentrationEffect != null)
{
    var state = ConcentrationState.FromJson(concentrationEffect.BehaviorState);
    if (state != null)
    {
        var confirmed = await ConcentrationBreakDialog.ShowAsync(
            DialogService,
            state,
            concentrationEffect.Name);
        if (!confirmed)
            return; // User cancelled - don't execute action

        // User confirmed - break concentration before proceeding
        ConcentrationBehavior.BreakConcentration(Character!, "Took action");
    }
}
// Continue with action execution...
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add concentration check to AttackMode.razor</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/AttackMode.razor</files>
  <action>
Add concentration check to ExecuteAttack method in AttackMode.razor:

1. Add required using statements after existing @using directives:
```razor
@using Threa.Client.Components.Shared
@using GameMechanics.Effects.Behaviors
```

2. Add DialogService injection after existing @inject:
```razor
@inject Radzen.DialogService DialogService
```

3. Modify ExecuteAttack method to check concentration at the start:
```csharp
private async Task ExecuteAttack()
{
    if (!CanAttack() || Character == null) return;

    // Check if character is concentrating - prompt before breaking
    var concentrationEffect = Character.GetConcentrationEffect();
    if (concentrationEffect != null)
    {
        var state = ConcentrationState.FromJson(concentrationEffect.BehaviorState);
        if (state != null)
        {
            var confirmed = await ConcentrationBreakDialog.ShowAsync(
                DialogService,
                state,
                concentrationEffect.Name);
            if (!confirmed)
                return; // User cancelled - don't execute action

            // User confirmed - break concentration before proceeding
            ConcentrationBehavior.BreakConcentration(Character, "Took attack action");
        }
    }

    // Existing code continues from here...
    var skill = GetSelectedSkill();
    // ... rest of method unchanged
```
  </action>
  <verify>File contains ConcentrationBreakDialog.ShowAsync in ExecuteAttack method</verify>
  <done>AttackMode.razor updated with concentration check before melee attack execution</done>
</task>

<task type="auto">
  <name>Task 2: Add concentration check to RangedAttackMode.razor</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/RangedAttackMode.razor</files>
  <action>
Add concentration check to ExecuteAttack method in RangedAttackMode.razor:

1. Add required using statement after existing @using directives (if not present):
```razor
@using GameMechanics.Effects.Behaviors
```

2. Add DialogService injection after existing parameters:
```razor
@inject Radzen.DialogService DialogService
```

3. Modify ExecuteAttack method to check concentration at the start:
```csharp
private async Task ExecuteAttack()
{
    if (!CanAttack() || Character == null) return;

    // Check if character is concentrating - prompt before breaking
    var concentrationEffect = Character.GetConcentrationEffect();
    if (concentrationEffect != null)
    {
        var state = ConcentrationState.FromJson(concentrationEffect.BehaviorState);
        if (state != null)
        {
            var confirmed = await ConcentrationBreakDialog.ShowAsync(
                DialogService,
                state,
                concentrationEffect.Name);
            if (!confirmed)
                return; // User cancelled - don't execute action

            // User confirmed - break concentration before proceeding
            ConcentrationBehavior.BreakConcentration(Character, "Took ranged attack action");
        }
    }

    // Existing code continues from here...
    var weapon = GetSelectedWeapon();
    // ... rest of method unchanged
```
  </action>
  <verify>File contains ConcentrationBreakDialog.ShowAsync in ExecuteAttack method</verify>
  <done>RangedAttackMode.razor updated with concentration check before ranged attack execution</done>
</task>

<task type="auto">
  <name>Task 3: Add concentration check to ReloadMode.razor</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/ReloadMode.razor</files>
  <action>
Add concentration check to ExecuteReload method in ReloadMode.razor:

1. Add required using statement after existing @using directives:
```razor
@using GameMechanics.Effects.Behaviors
```

2. Add DialogService injection:
```razor
@inject Radzen.DialogService DialogService
```

3. Modify ExecuteReload method to check concentration at the start:
```csharp
private async Task ExecuteReload()
{
    if (!CanReload() || Character == null || selectedWeapon == null || selectedMagazine == null) return;

    // Check if character is concentrating - prompt before breaking
    var concentrationEffect = Character.GetConcentrationEffect();
    if (concentrationEffect != null)
    {
        var state = ConcentrationState.FromJson(concentrationEffect.BehaviorState);
        if (state != null)
        {
            var confirmed = await ConcentrationBreakDialog.ShowAsync(
                DialogService,
                state,
                concentrationEffect.Name);
            if (!confirmed)
                return; // User cancelled - don't execute action

            // User confirmed - break concentration before proceeding
            ConcentrationBehavior.BreakConcentration(Character, "Took reload action");
        }
    }

    // Existing code continues from here...
    // Deduct costs
    var apCost = costType == ActionCostType.TwoAP ? 2 : 1;
    // ... rest of method unchanged
```
  </action>
  <verify>File contains ConcentrationBreakDialog.ShowAsync in ExecuteReload method</verify>
  <done>ReloadMode.razor updated with concentration check before reload execution</done>
</task>

<task type="auto">
  <name>Task 4: Verify build and test</name>
  <files>N/A</files>
  <action>
Build the solution to ensure all changes compile:

```bash
dotnet build Threa/Threa.sln
```

Verify:
1. No compilation errors
2. All three files reference ConcentrationBreakDialog correctly
3. DialogService injection is properly typed
  </action>
  <verify>dotnet build succeeds without errors</verify>
  <done>Build verification complete - all action components integrate with ConcentrationBreakDialog</done>
</task>

</tasks>

<verification>
1. Build succeeds: `dotnet build Threa/Threa.sln`
2. Code review:
   - AttackMode.razor contains `@inject Radzen.DialogService DialogService`
   - AttackMode.razor ExecuteAttack calls `ConcentrationBreakDialog.ShowAsync`
   - RangedAttackMode.razor contains `@inject Radzen.DialogService DialogService`
   - RangedAttackMode.razor ExecuteAttack calls `ConcentrationBreakDialog.ShowAsync`
   - ReloadMode.razor contains `@inject Radzen.DialogService DialogService`
   - ReloadMode.razor ExecuteReload calls `ConcentrationBreakDialog.ShowAsync`
3. Grep verification:
   ```bash
   grep -l "ConcentrationBreakDialog.ShowAsync" Threa/Threa.Client/Components/Pages/GamePlay/*Mode.razor
   ```
   Should return all three files.
</verification>

<success_criteria>
- All three action components (AttackMode, RangedAttackMode, ReloadMode) check for concentration
- ConcentrationBreakDialog.ShowAsync is called when character is concentrating
- Action is cancelled if user declines (returns false)
- Concentration is broken if user confirms (returns true)
- Build succeeds without errors
- Phase 22 gap "Taking active actions prompts to break concentration with confirmation" is closed
</success_criteria>

<output>
After completion, create `.planning/phases/22-concentration-system/22-08-SUMMARY.md`
</output>

---

## Notes

**Gap Context**: This plan closes the final gap in Phase 22 (Concentration System). The ConcentrationBreakDialog component was created in plan 22-05 but was never integrated into the action flow. This plan adds the missing integration.

**Integration Points**:
- AttackMode.razor: Melee attack actions
- RangedAttackMode.razor: Ranged/firearm attack actions
- ReloadMode.razor: Weapon reload actions

**Flow**:
1. User clicks action button (Roll Attack, Reload, etc.)
2. Component checks if character has active concentration effect
3. If concentrating, show ConcentrationBreakDialog with effect details
4. If user clicks "Cancel", action is aborted
5. If user clicks "Break & Continue", concentration is broken and action proceeds

**Not Modified**: DefendMode.razor is not modified because passive defense already has concentration check integration via DefenseResolver (from plan 22-06). Only active actions need this dialog prompt.

---

*Plan created: 2026-01-29*
*Gap closure for: Taking active actions prompts to break concentration with confirmation*
