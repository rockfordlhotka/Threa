---
phase: 22-concentration-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - GameMechanics/Effects/Behaviors/ConcentrationBehavior.cs
  - GameMechanics/EffectRecord.cs
  - Threa.Dal/Dto/CharacterEffect.cs
  - Threa.Dal.Sqlite/CharacterEffectDal.cs
  - Sql/migrations/002_add_concentration_linking.sql
  - GameMechanics/Effects/Behaviors/MagazineReloadPayload.cs
  - GameMechanics/Effects/Behaviors/SpellCastPayload.cs
  - GameMechanics.Test/ConcentrationStateSerializationTests.cs
autonomous: true
estimated_minutes: 45

must_haves:
  truths:
    - "ConcentrationState class has all fields for casting-time and sustained concentration"
    - "EffectRecord has SourceEffectId and SourceCasterId for effect linking"
    - "Database migration adds columns and indexes for effect linking"
    - "Payload classes serialize/deserialize correctly for deferred actions"
    - "Existing effects load without errors after schema changes"
  artifacts:
    - path: "GameMechanics/Effects/Behaviors/ConcentrationBehavior.cs"
      provides: "Complete ConcentrationState schema with all concentration fields"
      contains: "DeferredActionType|DeferredActionPayload|LinkedEffectIds|FatDrainPerRound"
    - path: "GameMechanics/EffectRecord.cs"
      provides: "SourceEffectId and SourceCasterId CSLA properties"
      contains: "SourceEffectIdProperty|SourceCasterIdProperty"
    - path: "GameMechanics/Effects/Behaviors/MagazineReloadPayload.cs"
      provides: "Serializable payload for magazine reload deferred action"
      min_lines: 30
    - path: "GameMechanics/Effects/Behaviors/SpellCastPayload.cs"
      provides: "Stub payload for spell cast deferred action"
      min_lines: 30
    - path: "Sql/migrations/002_add_concentration_linking.sql"
      provides: "Database migration for effect linking columns"
      contains: "SourceEffectId|SourceCasterId|CREATE INDEX"
  key_links:
    - from: "EffectRecord.SourceEffectId"
      to: "CharacterEffect.SourceEffectId"
      via: "FetchChild loads from DTO, InsertChild saves to DTO"
      pattern: "SourceEffectId.*dto\\.SourceEffectId"
    - from: "CharacterEffectDal"
      to: "CharacterEffect DTO"
      via: "SQL queries include SourceEffectId and SourceCasterId columns"
      pattern: "SourceEffectId.*SourceCasterId"
---

<objective>
Establish complete data model for both casting-time and sustained concentration.

Purpose: Enable all concentration features by defining the complete schema for ConcentrationState, adding effect linking properties, and creating payload classes for deferred actions.

Output: Complete data layer foundation for concentration system including ConcentrationState schema, EffectRecord properties, payload classes, database migration, and DAL updates.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/22-concentration-system/22-CONTEXT.md

Key context:
- ConcentrationBehavior.cs has partial ConcentrationState implementation
- EffectRecord.cs needs SourceEffectId/SourceCasterId for effect linking
- Phase 21 (Stat Editing) is complete - this is the foundation for concentration
- Magazine reload is primary focus (sci-fi), spell casting is stubbed for future
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ConcentrationState schema</name>
  <files>GameMechanics/Effects/Behaviors/ConcentrationBehavior.cs</files>
  <action>
Find the existing ConcentrationState class and add all missing fields for both casting-time and sustained concentration:

**New Casting-Time Fields:**
- DeferredActionType (string?) - "MagazineReload", "SpellCast"
- DeferredActionPayload (string?) - JSON-serialized action parameters
- CompletionMessage (string?) - "Magazine reloaded!"
- InterruptionMessage (string?) - "Reload interrupted!"

**New Sustained Fields:**
- SpellName (string?) - Name of sustained spell
- LinkedEffectIds (List of Guid?) - Active effects on target(s)
- FatDrainPerRound (int) - FAT cost per round (0 for casting-time)
- VitDrainPerRound (int) - VIT cost per round (0 for casting-time)
- SourceCasterId (Guid?) - Character ID of caster

Use [JsonPropertyName] attributes with camelCase names. Use DefaultIgnoreCondition.WhenWritingNull in Serialize().
  </action>
  <verify>dotnet build GameMechanics/GameMechanics.csproj</verify>
  <done>ConcentrationState has all 9 new properties (5 casting-time, 4 sustained) with JSON serialization</done>
</task>

<task type="auto">
  <name>Task 2: Add EffectRecord linking properties</name>
  <files>GameMechanics/EffectRecord.cs</files>
  <action>
Add two new CSLA managed properties to EffectRecord:

1. SourceEffectId (Guid?) - Links active spell effect back to concentration effect on caster
2. SourceCasterId (Guid?) - Character ID of caster who is concentrating

Use the standard CSLA PropertyInfo pattern:
```csharp
public static readonly PropertyInfo<Guid?> SourceEffectIdProperty = RegisterProperty<Guid?>(nameof(SourceEffectId));
```

Update FetchChild method to load from DTO.
Update InsertChild/UpdateChild methods to save to DTO.
  </action>
  <verify>dotnet build GameMechanics/GameMechanics.csproj</verify>
  <done>EffectRecord has SourceEffectId and SourceCasterId with CSLA registration and Fetch/Insert mapping</done>
</task>

<task type="auto">
  <name>Task 3: Update CharacterEffect DTO</name>
  <files>Threa.Dal/Dto/CharacterEffect.cs</files>
  <action>
Add two new properties to the CharacterEffect DTO class:

```csharp
/// <summary>
/// Links an active spell effect back to the concentration effect on the caster.
/// </summary>
public Guid? SourceEffectId { get; set; }

/// <summary>
/// The character ID of the caster who is concentrating on this effect.
/// </summary>
public Guid? SourceCasterId { get; set; }
```
  </action>
  <verify>dotnet build Threa.Dal/Threa.Dal.csproj</verify>
  <done>CharacterEffect DTO has SourceEffectId and SourceCasterId properties</done>
</task>

<task type="auto">
  <name>Task 4: Create database migration</name>
  <files>Sql/migrations/002_add_concentration_linking.sql</files>
  <action>
Create a new SQL migration file with:

1. ALTER TABLE to add SourceEffectId TEXT NULL column
2. ALTER TABLE to add SourceCasterId TEXT NULL column
3. CREATE INDEX on SourceEffectId (for finding linked effects)
4. CREATE INDEX on SourceCasterId (for finding caster's linked effects)

Use partial indexes with WHERE column IS NOT NULL for efficiency.
  </action>
  <verify>File exists and contains ALTER TABLE and CREATE INDEX statements</verify>
  <done>Migration file creates SourceEffectId and SourceCasterId columns with indexes</done>
</task>

<task type="auto">
  <name>Task 5: Update SQLite DAL</name>
  <files>Threa.Dal.Sqlite/CharacterEffectDal.cs</files>
  <action>
Update SQL queries in CharacterEffectDal to include new columns:

1. SELECT queries: Add SourceEffectId, SourceCasterId to column list
2. INSERT queries: Add columns and parameter placeholders
3. UPDATE queries: Add SET clause for both columns
4. Add parameters: Use DBNull.Value for null GUIDs

Check the existing column names/patterns in the file and follow the same style.
  </action>
  <verify>dotnet build Threa.Dal.Sqlite/Threa.Dal.Sqlite.csproj</verify>
  <done>SQLite DAL includes SourceEffectId and SourceCasterId in all CRUD operations</done>
</task>

<task type="auto">
  <name>Task 6: Create MagazineReloadPayload class</name>
  <files>GameMechanics/Effects/Behaviors/MagazineReloadPayload.cs</files>
  <action>
Create a new class file with payload for magazine reload deferred action:

Properties:
- WeaponItemId (Guid) - The weapon CharacterItem ID being reloaded
- MagazineItemId (Guid) - The magazine/ammo source CharacterItem ID
- RoundsToLoad (int) - Number of rounds to load into the weapon

Include Serialize() and static FromJson(string) methods using System.Text.Json.
Use [JsonPropertyName] with camelCase names.
  </action>
  <verify>dotnet build GameMechanics/GameMechanics.csproj</verify>
  <done>MagazineReloadPayload class created with serialization methods</done>
</task>

<task type="auto">
  <name>Task 7: Create SpellCastPayload stub</name>
  <files>GameMechanics/Effects/Behaviors/SpellCastPayload.cs</files>
  <action>
Create a stub class for spell casting deferred action:

Properties:
- SpellId (int) - Spell ID to cast
- TargetId (Guid?) - Target character ID (if single-target spell)
- Parameters (string?) - Additional spell parameters

Include Serialize() and static FromJson(string) methods.
Add XML doc comment noting this is a STUB pending full spell system.
  </action>
  <verify>dotnet build GameMechanics/GameMechanics.csproj</verify>
  <done>SpellCastPayload stub class created for future spell system integration</done>
</task>

<task type="auto">
  <name>Task 8: Create serialization tests</name>
  <files>GameMechanics.Test/ConcentrationStateSerializationTests.cs</files>
  <action>
Create unit tests for serialization roundtrips:

1. ConcentrationState_CastingTime_SerializesAndDeserializes - test DeferredActionType, Payload, messages
2. ConcentrationState_Sustained_SerializesAndDeserializes - test SpellName, LinkedEffectIds, drain rates
3. MagazineReloadPayload_SerializesAndDeserializes - test all properties
4. SpellCastPayload_SerializesAndDeserializes - test stub properties
5. ConcentrationState_BackwardCompatibility_LoadsWithoutNewFields - verify old JSON still works

Use [TestClass] and [TestMethod] attributes (MSTest pattern).
  </action>
  <verify>dotnet test GameMechanics.Test/GameMechanics.Test.csproj --filter "FullyQualifiedName~ConcentrationStateSerializationTests"</verify>
  <done>All serialization tests pass covering casting-time, sustained, and backward compatibility</done>
</task>

</tasks>

<verification>
1. Build succeeds: `dotnet build Threa.sln`
2. Tests pass: `dotnet test GameMechanics.Test/GameMechanics.Test.csproj --filter "FullyQualifiedName~ConcentrationStateSerializationTests"`
3. Code review:
   - ConcentrationState has all 9 new properties
   - EffectRecord has SourceEffectId and SourceCasterId with CSLA registration
   - CharacterEffect DTO has both new properties
   - Database migration creates columns and indexes
   - SQLite DAL includes new columns in all queries
   - MagazineReloadPayload and SpellCastPayload serialize correctly
</verification>

<success_criteria>
- ConcentrationState class has all properties for casting-time (DeferredActionType, DeferredActionPayload, messages) and sustained (SpellName, LinkedEffectIds, drain rates)
- EffectRecord has SourceEffectId and SourceCasterId as CSLA managed properties
- CharacterEffect DTO has both linking properties
- Database migration adds columns with indexes
- SQLite DAL includes new columns in SELECT/INSERT/UPDATE
- Payload classes serialize and deserialize correctly
- All serialization tests pass
- Existing effects load without errors (backward compatibility)
</success_criteria>

<output>
After completion, create `.planning/phases/22-concentration-system/22-01-SUMMARY.md`
</output>

---

## Notes

**Focus:** Magazine reload concentration for sci-fi gameplay is the primary use case. Spell casting is stubbed for future magic system implementation in v1.4+.

**Backward Compatibility:** ConcentrationState uses JsonIgnoreCondition.WhenWritingNull, so existing effects with older JSON will load correctly - unknown fields are ignored by System.Text.Json.

**Effect Linking Pattern:** SourceEffectId links an effect on a target (e.g., Invisibility buff) back to the concentration effect on the caster. When concentration breaks, all effects with matching SourceEffectId are removed from all characters.

---

*Plan created: 2026-01-29*
*Focus: Data layer foundation for concentration system*
