---
phase: 28-selection-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["28-01"]
files_modified:
  - Threa/Threa.Client/Components/Shared/SelectionBar.razor
  - Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
  - Threa/Threa/wwwroot/css/themes.css
autonomous: true

must_haves:
  truths:
    - "Dashboard displays X selected count when characters are selected"
    - "GM can click Select All to select all characters within a section"
    - "GM can click Deselect All to clear all selections"
    - "Escape key clears all selections"
  artifacts:
    - path: "Threa/Threa.Client/Components/Shared/SelectionBar.razor"
      provides: "Sticky selection bar with count and Deselect All button"
      contains: "selectedCharacterIds.Count"
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor"
      provides: "Per-section Select All buttons and Escape key handler"
      contains: "SelectAllInSection"
  key_links:
    - from: "SelectionBar.razor"
      to: "GmTable.razor"
      via: "SelectedCount and OnDeselectAll parameters"
      pattern: "OnDeselectAll\\.InvokeAsync"
    - from: "GmTable.razor"
      to: "SelectionBar.razor"
      via: "Component inclusion with parameters"
      pattern: "<SelectionBar"
---

<objective>
Add selection controls: sticky selection bar with count and Deselect All, per-section Select All buttons, Escape key handler for quick deselection, and cleanup logic when characters are removed from the table.

Purpose: Complete the selection infrastructure by providing controls for bulk selection operations and keyboard shortcuts. This enables efficient selection management before batch actions (delivered in Phases 29-31).

Output: SelectionBar.razor component with count display and Deselect All. GmTable.razor with per-section Select All buttons, Escape key handler, and selection cleanup on character removal.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-selection-infrastructure/28-CONTEXT.md
@.planning/phases/28-selection-infrastructure/28-RESEARCH.md
@.planning/phases/28-selection-infrastructure/28-01-SUMMARY.md
@Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
@Threa/Threa/wwwroot/css/themes.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SelectionBar.razor sticky component</name>
  <files>
    Threa/Threa.Client/Components/Shared/SelectionBar.razor
    Threa/Threa/wwwroot/css/themes.css
  </files>
  <action>
1. Create new file Threa/Threa.Client/Components/Shared/SelectionBar.razor:

```razor
@namespace Threa.Client.Components.Shared

<div class="selection-bar @(SelectedCount > 0 ? "visible" : "")">
    <div class="d-flex justify-content-between align-items-center">
        <span class="selection-count">
            <i class="bi bi-check2-square me-2"></i>
            <strong>@SelectedCount</strong> selected
        </span>
        <button class="btn btn-sm btn-outline-secondary" @onclick="HandleDeselectAll">
            <i class="bi bi-x-lg me-1"></i>Deselect All
        </button>
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public int SelectedCount { get; set; }

    [Parameter]
    public EventCallback OnDeselectAll { get; set; }

    private async Task HandleDeselectAll()
    {
        await OnDeselectAll.InvokeAsync();
    }
}
```

2. Add CSS for selection bar to themes.css (after the existing character-status-card styles):

```css
/* ═══════════════════════════════════════════════════════════════════
   SELECTION BAR - Sticky bar showing selection count and controls
   ═══════════════════════════════════════════════════════════════════ */

.selection-bar {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--color-card-bg);
    padding: 0.5rem 1rem;
    margin-bottom: 1rem;
    border: 1px solid var(--color-card-border);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-card);
    transform: translateY(-100%);
    opacity: 0;
    transition: transform 150ms ease, opacity 150ms ease;
    pointer-events: none;
}

.selection-bar.visible {
    transform: translateY(0);
    opacity: 1;
    pointer-events: auto;
}

.selection-bar .selection-count {
    font-family: var(--font-display);
    color: var(--color-text-primary);
}

.selection-bar .selection-count strong {
    color: var(--color-accent-primary);
    font-size: 1.1em;
}

/* Sci-fi theme enhancements */
[data-theme="scifi"] .selection-bar {
    border-color: var(--color-accent-primary);
    box-shadow: 0 0 10px rgba(0, 240, 255, 0.2);
}

[data-theme="scifi"] .selection-bar.visible {
    animation: selection-bar-glow 2s ease-in-out infinite;
}

@keyframes selection-bar-glow {
    0%, 100% { box-shadow: 0 0 10px rgba(0, 240, 255, 0.2); }
    50% { box-shadow: 0 0 15px rgba(0, 240, 255, 0.4); }
}
```
  </action>
  <verify>
Build succeeds: `dotnet build Threa.sln`
Verify SelectionBar.razor file exists with SelectedCount and OnDeselectAll parameters
Verify themes.css has .selection-bar styles with transition animation
  </verify>
  <done>
SelectionBar.razor exists with count display and Deselect All button. CSS provides sticky positioning with slide-in animation and theme-aware styling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add SelectionBar and per-section controls to GmTable.razor</name>
  <files>
    Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
  </files>
  <action>
1. Add using statement for SelectionBar at the top of the file:
```razor
@using Threa.Client.Components.Shared
```
(Note: This may already be present, verify before adding)

2. Add SelectionBar component immediately after the header bar (around line 71, after the closing div of gm-header):
```razor
<!-- Selection Bar - appears when characters are selected -->
<SelectionBar SelectedCount="@selectedCharacterIds.Count"
              OnDeselectAll="DeselectAll" />
```

3. Add DeselectAll method to @code section:
```csharp
private void DeselectAll()
{
    selectedCharacterIds.Clear();
    StateHasChanged();
}
```

4. Add SelectAllInSection and DeselectAllInSection methods to @code section:
```csharp
private void SelectAllInSection(IEnumerable<GameMechanics.GamePlay.TableCharacterInfo> characters)
{
    foreach (var c in characters)
        selectedCharacterIds.Add(c.CharacterId);
    StateHasChanged();
}

private void DeselectAllInSection(IEnumerable<GameMechanics.GamePlay.TableCharacterInfo> characters)
{
    foreach (var c in characters)
        selectedCharacterIds.Remove(c.CharacterId);
    StateHasChanged();
}

private bool HasSelectionInSection(IEnumerable<GameMechanics.GamePlay.TableCharacterInfo> characters)
    => characters.Any(c => selectedCharacterIds.Contains(c.CharacterId));
```

5. Update the PC section header (around line 157-159) to add Select All/Deselect buttons:
```razor
<div class="card-header d-flex justify-content-between align-items-center">
    <strong>Characters at Table</strong>
    <div class="d-flex gap-2 align-items-center">
        <span class="badge bg-primary">@playerCharacters.Count()</span>
        @if (playerCharacters.Any())
        {
            <button class="btn btn-outline-secondary btn-sm"
                    @onclick="() => SelectAllInSection(playerCharacters)"
                    title="Select all PCs">
                <i class="bi bi-check2-all"></i>
            </button>
            <button class="btn btn-outline-secondary btn-sm"
                    @onclick="() => DeselectAllInSection(playerCharacters)"
                    disabled="@(!HasSelectionInSection(playerCharacters))"
                    title="Deselect all PCs">
                <i class="bi bi-x-lg"></i>
            </button>
        }
    </div>
</div>
```

6. Update NPC disposition group headers to add Select All/Deselect buttons:

For Hostile NPCs (around line 246-248):
```razor
<h6 class="npc-group-header text-danger mb-2 d-flex justify-content-between align-items-center">
    <span><i class="bi bi-skull-crossbones me-1"></i>Hostile (@hostileNpcs.Count())</span>
    <div class="d-flex gap-1">
        <button class="btn btn-outline-secondary btn-sm py-0 px-1"
                @onclick="() => SelectAllInSection(hostileNpcs)"
                title="Select all hostile NPCs">
            <i class="bi bi-check2-all" style="font-size: 0.8rem;"></i>
        </button>
        <button class="btn btn-outline-secondary btn-sm py-0 px-1"
                @onclick="() => DeselectAllInSection(hostileNpcs)"
                disabled="@(!HasSelectionInSection(hostileNpcs))"
                title="Deselect all hostile NPCs">
            <i class="bi bi-x-lg" style="font-size: 0.8rem;"></i>
        </button>
    </div>
</h6>
```

For Neutral NPCs (around line 266-268):
```razor
<h6 class="npc-group-header text-secondary mb-2 d-flex justify-content-between align-items-center">
    <span><i class="bi bi-circle me-1"></i>Neutral (@neutralNpcs.Count())</span>
    <div class="d-flex gap-1">
        <button class="btn btn-outline-secondary btn-sm py-0 px-1"
                @onclick="() => SelectAllInSection(neutralNpcs)"
                title="Select all neutral NPCs">
            <i class="bi bi-check2-all" style="font-size: 0.8rem;"></i>
        </button>
        <button class="btn btn-outline-secondary btn-sm py-0 px-1"
                @onclick="() => DeselectAllInSection(neutralNpcs)"
                disabled="@(!HasSelectionInSection(neutralNpcs))"
                title="Deselect all neutral NPCs">
            <i class="bi bi-x-lg" style="font-size: 0.8rem;"></i>
        </button>
    </div>
</h6>
```

For Friendly NPCs (around line 286-288):
```razor
<h6 class="npc-group-header text-success mb-2 d-flex justify-content-between align-items-center">
    <span><i class="bi bi-heart me-1"></i>Friendly (@friendlyNpcs.Count())</span>
    <div class="d-flex gap-1">
        <button class="btn btn-outline-secondary btn-sm py-0 px-1"
                @onclick="() => SelectAllInSection(friendlyNpcs)"
                title="Select all friendly NPCs">
            <i class="bi bi-check2-all" style="font-size: 0.8rem;"></i>
        </button>
        <button class="btn btn-outline-secondary btn-sm py-0 px-1"
                @onclick="() => DeselectAllInSection(friendlyNpcs)"
                disabled="@(!HasSelectionInSection(friendlyNpcs))"
                title="Deselect all friendly NPCs">
            <i class="bi bi-x-lg" style="font-size: 0.8rem;"></i>
        </button>
    </div>
</h6>
```

For Hidden NPCs section button (around line 214-221):
```razor
<button class="btn btn-sm w-100 d-flex justify-content-between align-items-center py-1"
        style="background: var(--color-bg-tertiary);"
        @onclick="() => showHiddenSection = !showHiddenSection">
    <span>
        <i class="bi bi-eye-slash text-muted me-1"></i>
        Hidden (@hiddenNpcs.Count())
    </span>
    <div class="d-flex align-items-center gap-1">
        @if (showHiddenSection)
        {
            <span class="btn btn-outline-secondary btn-sm py-0 px-1"
                  @onclick:stopPropagation="true"
                  @onclick="() => SelectAllInSection(hiddenNpcs)"
                  title="Select all hidden NPCs">
                <i class="bi bi-check2-all" style="font-size: 0.8rem;"></i>
            </span>
            <span class="btn btn-outline-secondary btn-sm py-0 px-1"
                  @onclick:stopPropagation="true"
                  @onclick="() => DeselectAllInSection(hiddenNpcs)"
                  title="Deselect all hidden NPCs">
                <i class="bi bi-x-lg" style="font-size: 0.8rem;"></i>
            </span>
        }
        <i class="bi @(showHiddenSection ? "bi-chevron-up" : "bi-chevron-down")"></i>
    </div>
</button>
```
  </action>
  <verify>
Build succeeds: `dotnet build Threa.sln`
Verify SelectionBar appears in GmTable.razor
Verify each section header has Select All and Deselect buttons
Verify methods SelectAllInSection, DeselectAllInSection, DeselectAll exist
  </verify>
  <done>
SelectionBar component added to GmTable showing count when selections exist. Each section (PCs, Hostile, Neutral, Friendly, Hidden) has Select All/Deselect buttons. DeselectAll clears all selections.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Escape key handler and selection cleanup</name>
  <files>
    Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
  </files>
  <action>
1. Add tabindex to the main container to enable keyboard events. Wrap the main content in a div with @onkeydown handler. Find the opening of the row div (around line 73) and wrap the content:

Change:
```razor
<div class="row">
```

To:
```razor
<div class="row" @onkeydown="HandleKeyDown" tabindex="0" style="outline: none;">
```

2. Add keyboard event handler to @code section:
```csharp
private void HandleKeyDown(KeyboardEventArgs e)
{
    if (e.Key == "Escape" && selectedCharacterIds.Count > 0)
    {
        DeselectAll();
    }
}
```

3. Update RefreshCharacterListAsync to clean up stale selections (characters that no longer exist). Modify the existing method to include cleanup:

Add after the tableCharacters assignment (around line 699):
```csharp
// Clean up selections for characters no longer at table
if (selectedCharacterIds.Count > 0 && tableCharacters != null)
{
    var currentCharacterIds = new HashSet<int>(tableCharacters.Select(c => c.CharacterId));
    selectedCharacterIds.RemoveWhere(id => !currentCharacterIds.Contains(id));
}
```

4. Per CONTEXT.md decision: "Dismissed/archived characters silently drop from selection" - the cleanup in RefreshCharacterListAsync handles this automatically since dismissed characters won't appear in the refreshed list.

5. Ensure focus behavior: Add @ref to the container and set focus on render if needed (optional enhancement for better keyboard UX):

Add field:
```csharp
private ElementReference mainContainer;
```

Update the container div:
```razor
<div class="row" @ref="mainContainer" @onkeydown="HandleKeyDown" tabindex="0" style="outline: none;">
```

Note: Focus will be set naturally when user clicks into the container. No explicit focus setting needed on page load.
  </action>
  <verify>
Build succeeds: `dotnet build Threa.sln`
Run the application and verify:
- Select some characters
- Press Escape key - selections should clear
- Selection count should become 0
- When a character is dismissed, their selection should be removed
  </verify>
  <done>
Escape key clears all selections when pressed. RefreshCharacterListAsync removes stale selections for dismissed/archived characters. Container has tabindex for keyboard focus.
  </done>
</task>

</tasks>

<verification>
1. Build: `dotnet build Threa.sln` - no errors
2. Run application: `cd Threa/Threa && dotnet run`
3. Navigate to GM Table with multiple characters
4. Verify sticky selection bar appears when selecting characters
5. Verify selection count updates correctly
6. Click "Deselect All" in selection bar - all selections should clear
7. Click section "Select All" buttons - all characters in that section should be selected
8. Click section "Deselect" buttons - all characters in that section should be deselected
9. Press Escape key - all selections should clear
10. Dismiss an NPC - that NPC should be removed from selection automatically
11. Verify styling in both Fantasy and Sci-Fi themes
</verification>

<success_criteria>
- [ ] SelectionBar.razor component exists with SelectedCount and OnDeselectAll
- [ ] Selection bar shows "X selected" count when characters are selected
- [ ] Selection bar has slide-in animation (transforms from hidden to visible)
- [ ] Deselect All button in selection bar clears all selections
- [ ] Each section (PCs, Hostile, Neutral, Friendly, Hidden) has Select All button
- [ ] Each section has Deselect button (disabled when no selections in section)
- [ ] Escape key clears all selections
- [ ] Dismissed characters are automatically removed from selection
- [ ] Styling works in both Fantasy and Sci-Fi themes
</success_criteria>

<output>
After completion, create `.planning/phases/28-selection-infrastructure/28-02-SUMMARY.md`
</output>
