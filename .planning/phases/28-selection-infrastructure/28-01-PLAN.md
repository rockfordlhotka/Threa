---
phase: 28-selection-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
  - Threa/Threa.Client/Components/Shared/CharacterStatusCard.razor
  - Threa/Threa.Client/Components/Shared/CharacterStatusCard.razor.cs
  - Threa/Threa.Client/Components/Shared/NpcStatusCard.razor
  - Threa/Threa.Client/Components/Shared/HiddenNpcCard.razor
  - Threa/Threa/wwwroot/css/themes.css
autonomous: true

must_haves:
  truths:
    - "GM can click checkbox on any character card to toggle selection"
    - "Selected characters have visible highlight distinguishing them from unselected"
    - "Checkbox toggles selection without opening character details modal"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor"
      provides: "HashSet<int> selectedCharacterIds with toggle/select/deselect methods"
      contains: "private HashSet<int> selectedCharacterIds"
    - path: "Threa/Threa.Client/Components/Shared/CharacterStatusCard.razor"
      provides: "Checkbox overlay with IsSelectable parameter"
      contains: "IsSelectable"
    - path: "Threa/Threa/wwwroot/css/themes.css"
      provides: "Multi-selected card styling"
      contains: ".multi-selected"
  key_links:
    - from: "GmTable.razor"
      to: "CharacterStatusCard.razor"
      via: "IsMultiSelected and OnSelectionChanged parameters"
      pattern: "IsMultiSelected.*OnSelectionChanged"
    - from: "CharacterStatusCard.razor"
      to: "GmTable.razor"
      via: "EventCallback invocation on checkbox toggle"
      pattern: "OnSelectionChanged\\.InvokeAsync"
---

<objective>
Implement multi-character selection state management in GmTable.razor and add checkbox overlays to all character card components (CharacterStatusCard, NpcStatusCard, HiddenNpcCard) with clear visual selection indicators.

Purpose: Enable GMs to select multiple characters for batch operations (delivered in Phases 29-31). This plan establishes the selection infrastructure and visual feedback.

Output: GmTable.razor with HashSet<int> selection state and toggle methods. Character cards with checkbox overlays and multi-selected styling. Theme-aware selection highlighting.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-selection-infrastructure/28-CONTEXT.md
@.planning/phases/28-selection-infrastructure/28-RESEARCH.md
@Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
@Threa/Threa.Client/Components/Shared/CharacterStatusCard.razor
@Threa/Threa.Client/Components/Shared/CharacterStatusCard.razor.cs
@Threa/Threa.Client/Components/Shared/NpcStatusCard.razor
@Threa/Threa.Client/Components/Shared/HiddenNpcCard.razor
@Threa/Threa/wwwroot/css/themes.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add selection state and methods to GmTable.razor</name>
  <files>
    Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
  </files>
  <action>
Add HashSet-based selection state management to GmTable.razor:

1. Add selection state field in @code section:
```csharp
// Selection state for batch operations
private HashSet<int> selectedCharacterIds = new();
```

2. Add selection helper methods:
```csharp
private void ToggleSelection(int characterId)
{
    if (!selectedCharacterIds.Add(characterId))
    {
        // Already existed, so remove it (toggle off)
        selectedCharacterIds.Remove(characterId);
    }
    StateHasChanged();
}

private bool IsCharacterSelected(int characterId)
    => selectedCharacterIds.Contains(characterId);
```

3. Update CharacterStatusCard usage for PCs (around line 176-183) to pass selection parameters:
```razor
<CharacterStatusCard Character="@character"
                     IsSelected="@(selectedCharacter?.CharacterId == character.CharacterId)"
                     IsMultiSelected="@IsCharacterSelected(character.CharacterId)"
                     IsSelectable="true"
                     OnSelectionChanged="@(() => ToggleSelection(character.CharacterId))"
                     OnClick="OpenCharacterDetails" />
```

4. Update NpcStatusCard usages (hostile, neutral, friendly - around lines 253, 273, 293) to pass selection parameters:
```razor
<NpcStatusCard Character="@npc"
               IsSelected="@(selectedCharacter?.CharacterId == npc.CharacterId)"
               IsMultiSelected="@IsCharacterSelected(npc.CharacterId)"
               IsSelectable="true"
               OnSelectionChanged="@(() => ToggleSelection(npc.CharacterId))"
               OnClick="OpenCharacterDetails" />
```

5. Update HiddenNpcCard usage (around line 231) to pass selection parameters:
```razor
<HiddenNpcCard Character="@npc"
               IsMultiSelected="@IsCharacterSelected(npc.CharacterId)"
               IsSelectable="true"
               OnSelectionChanged="@(() => ToggleSelection(npc.CharacterId))"
               OnReveal="RevealNpc"
               OnClick="OpenCharacterDetails" />
```

Note: The existing `IsSelected` parameter on CharacterStatusCard is for single-character detail selection (opens modal). `IsMultiSelected` is new and controls batch selection checkbox state.
  </action>
  <verify>
Build succeeds: `dotnet build Threa.sln`
Verify selectedCharacterIds field and methods exist in GmTable.razor
  </verify>
  <done>
GmTable.razor contains HashSet&lt;int&gt; selectedCharacterIds, ToggleSelection method, IsCharacterSelected method, and passes IsMultiSelected/IsSelectable/OnSelectionChanged to all card components.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add selection parameters and checkbox to CharacterStatusCard</name>
  <files>
    Threa/Threa.Client/Components/Shared/CharacterStatusCard.razor
    Threa/Threa.Client/Components/Shared/CharacterStatusCard.razor.cs
    Threa/Threa/wwwroot/css/themes.css
  </files>
  <action>
1. Update CharacterStatusCardBase.cs to add new parameters:
```csharp
[Parameter] public bool IsMultiSelected { get; set; }
[Parameter] public bool IsSelectable { get; set; }
[Parameter] public EventCallback OnSelectionChanged { get; set; }
```

2. Update CharacterStatusCard.razor to add checkbox overlay and multi-selected class:

Change the outer div to include multi-selected class:
```razor
<div class="character-status-card card @CardBorderClass @(IsSelected ? "selected" : "") @(IsMultiSelected ? "multi-selected" : "") mb-2"
     @onclick="() => OnClick.InvokeAsync(Character)"
     style="cursor: pointer; position: relative;">
```

Add checkbox overlay immediately inside the div (before card-body):
```razor
@if (IsSelectable)
{
    <div class="selection-checkbox" @onclick:stopPropagation="true" @onclick="HandleCheckboxClick">
        <RadzenCheckBox TValue="bool"
                       Value="@IsMultiSelected"
                       class="selection-cb" />
    </div>
}
```

Note: The checkbox container handles the click, not the RadzenCheckBox directly. The @onclick:stopPropagation prevents the card click (which opens details modal) from firing when clicking the checkbox.

3. Add checkbox click handler in CharacterStatusCardBase.cs:
```csharp
protected async Task HandleCheckboxClick()
{
    await OnSelectionChanged.InvokeAsync();
}
```

4. Add CSS for selection checkbox and multi-selected state to themes.css (after the existing .character-status-card styles around line 930):

```css
/* Multi-selection checkbox styling */
.selection-checkbox {
    position: absolute;
    top: 4px;
    left: 4px;
    z-index: 10;
    padding: 8px; /* Touch target expansion per WCAG */
    cursor: pointer;
    border-radius: var(--border-radius);
    background: rgba(255, 255, 255, 0.9);
    transition: background 150ms ease;
}

[data-theme="scifi"] .selection-checkbox {
    background: rgba(18, 18, 26, 0.9);
}

.selection-checkbox:hover {
    background: rgba(255, 255, 255, 1);
}

[data-theme="scifi"] .selection-checkbox:hover {
    background: rgba(26, 26, 37, 1);
}

/* RadzenCheckBox sizing inside selection container */
.selection-checkbox .selection-cb {
    transform: scale(1.2);
}

/* Multi-selected card styling */
.character-status-card.multi-selected {
    border-color: var(--color-accent-primary) !important;
    background-color: var(--color-bg-tertiary);
    box-shadow: 0 0 0 2px var(--color-accent-primary);
    transition: all 150ms ease;
}

[data-theme="scifi"] .character-status-card.multi-selected {
    box-shadow: 0 0 10px var(--color-accent-primary);
}
```
  </action>
  <verify>
Build succeeds: `dotnet build Threa.sln`
Verify CharacterStatusCardBase has IsMultiSelected, IsSelectable, OnSelectionChanged parameters
Verify CharacterStatusCard.razor has selection-checkbox div with RadzenCheckBox
Verify themes.css has .selection-checkbox and .multi-selected styles
  </verify>
  <done>
CharacterStatusCard has IsMultiSelected, IsSelectable, OnSelectionChanged parameters. Checkbox appears in top-left corner when IsSelectable is true. Multi-selected cards have border highlight and background tint. Click propagation properly stopped on checkbox.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add selection support to NpcStatusCard and HiddenNpcCard</name>
  <files>
    Threa/Threa.Client/Components/Shared/NpcStatusCard.razor
    Threa/Threa.Client/Components/Shared/HiddenNpcCard.razor
    Threa/Threa/wwwroot/css/themes.css
  </files>
  <action>
1. Update NpcStatusCard.razor to pass new selection parameters through to CharacterStatusCard:

Add parameters to @code section:
```csharp
[Parameter]
public bool IsMultiSelected { get; set; }

[Parameter]
public bool IsSelectable { get; set; }

[Parameter]
public EventCallback OnSelectionChanged { get; set; }
```

Update CharacterStatusCard usage to pass through the new parameters:
```razor
<CharacterStatusCard Character="@Character"
                     IsSelected="@IsSelected"
                     IsMultiSelected="@IsMultiSelected"
                     IsSelectable="@IsSelectable"
                     OnSelectionChanged="@OnSelectionChanged"
                     OnClick="@OnClick" />
```

2. Update HiddenNpcCard.razor to add checkbox and multi-selected styling:

Add parameters to @code section:
```csharp
[Parameter]
public bool IsMultiSelected { get; set; }

[Parameter]
public bool IsSelectable { get; set; }

[Parameter]
public EventCallback OnSelectionChanged { get; set; }
```

Update the outer div to include multi-selected class:
```razor
<div class="hidden-npc-card p-2 rounded border d-flex justify-content-between align-items-center @(IsMultiSelected ? "multi-selected" : "")"
     style="background: var(--color-bg-secondary); cursor: pointer; position: relative;"
     @onclick="HandleClick">
```

Add checkbox at the beginning of the content (before the d-flex with character info):
```razor
@if (IsSelectable)
{
    <div class="selection-checkbox-compact" @onclick:stopPropagation="true" @onclick="HandleCheckboxClick">
        <RadzenCheckBox TValue="bool"
                       Value="@IsMultiSelected"
                       class="selection-cb-compact" />
    </div>
}
```

Add checkbox click handler:
```csharp
private async Task HandleCheckboxClick()
{
    await OnSelectionChanged.InvokeAsync();
}
```

3. Add CSS for hidden NPC card selection (smaller checkbox for compact card) to themes.css:

```css
/* Hidden NPC card multi-selection styling */
.hidden-npc-card.multi-selected {
    border-color: var(--color-accent-primary) !important;
    background-color: var(--color-bg-tertiary) !important;
    box-shadow: 0 0 0 2px var(--color-accent-primary);
}

[data-theme="scifi"] .hidden-npc-card.multi-selected {
    box-shadow: 0 0 8px var(--color-accent-primary);
}

/* Compact selection checkbox for hidden NPC cards */
.selection-checkbox-compact {
    position: absolute;
    top: 2px;
    left: 2px;
    z-index: 10;
    padding: 4px;
    cursor: pointer;
    border-radius: var(--border-radius);
    background: rgba(255, 255, 255, 0.9);
}

[data-theme="scifi"] .selection-checkbox-compact {
    background: rgba(18, 18, 26, 0.9);
}

.selection-checkbox-compact .selection-cb-compact {
    transform: scale(0.9);
}
```
  </action>
  <verify>
Build succeeds: `dotnet build Threa.sln`
Run the application and verify:
- PC cards show checkbox in top-left corner
- NPC cards (hostile, neutral, friendly) show checkbox in top-left corner
- Hidden NPC cards show compact checkbox
- Clicking checkbox toggles selection without opening details modal
- Selected cards show border highlight and background tint
  </verify>
  <done>
NpcStatusCard passes IsMultiSelected, IsSelectable, OnSelectionChanged through to CharacterStatusCard. HiddenNpcCard has compact checkbox and multi-selected styling. All card types support multi-selection with visual feedback.
  </done>
</task>

</tasks>

<verification>
1. Build: `dotnet build Threa.sln` - no errors
2. Run application: `cd Threa/Threa && dotnet run`
3. Navigate to GM Table page with characters
4. Verify checkbox appears on all character cards (PCs and NPCs)
5. Click checkbox - should toggle selection visually (border highlight + background tint)
6. Click checkbox - should NOT open character details modal
7. Click card body - should still open character details modal
8. Verify styling works in both Fantasy and Sci-Fi themes
</verification>

<success_criteria>
- [ ] HashSet<int> selectedCharacterIds exists in GmTable.razor
- [ ] ToggleSelection and IsCharacterSelected methods work correctly
- [ ] CharacterStatusCard shows checkbox when IsSelectable=true
- [ ] Checkbox click toggles IsMultiSelected state via OnSelectionChanged
- [ ] Multi-selected cards show visible border highlight and background tint
- [ ] Click propagation properly stopped (checkbox doesn't open modal)
- [ ] NpcStatusCard passes selection parameters to CharacterStatusCard
- [ ] HiddenNpcCard has compact checkbox with selection support
- [ ] Styling works in both Fantasy and Sci-Fi themes
</success_criteria>

<output>
After completion, create `.planning/phases/28-selection-infrastructure/28-01-SUMMARY.md`
</output>
