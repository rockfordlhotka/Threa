---
phase: 08-registration-foundation
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - Threa/Threa/Components/Pages/Register.razor
  - Threa/Threa/Components/Pages/Login.razor
autonomous: true

must_haves:
  truths:
    - "User can navigate to /register page"
    - "Registration form accepts username, password, secret question, secret answer"
    - "Form shows validation errors for invalid input"
    - "Successful registration redirects to /login?registered=true"
    - "Duplicate username shows clear error message"
    - "Login page has link to registration page"
  artifacts:
    - path: "Threa/Threa/Components/Pages/Register.razor"
      provides: "Registration page with form"
      contains: "@page \"/register\""
      min_lines: 60
    - path: "Threa/Threa/Components/Pages/Login.razor"
      provides: "Link to registration page"
      contains: "/register"
  key_links:
    - from: "Threa/Threa/Components/Pages/Register.razor"
      to: "UserRegistration"
      via: "IDataPortal<UserRegistration> injection"
      pattern: "IDataPortal<UserRegistration>"
    - from: "Threa/Threa/Components/Pages/Register.razor"
      to: "/login"
      via: "NavigationManager redirect after success"
      pattern: "NavigateTo.*login"
---

<objective>
Create the registration UI page that allows new users to create accounts.

Purpose: Provide a user-friendly registration form that validates input, creates accounts, and handles errors gracefully.

Output: Register.razor page following Login.razor pattern, with link from login page to registration.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-registration-foundation/08-RESEARCH.md
@.planning/phases/08-registration-foundation/08-01-SUMMARY.md

# Key existing files to reference
@Threa/Threa/Components/Pages/Login.razor
@GameMechanics/Player/UserRegistration.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Registration Page</name>
  <files>Threa/Threa/Components/Pages/Register.razor</files>
  <action>
Create Register.razor following the Login.razor pattern exactly:

1. **Page directive and imports:**
```razor
@page "/register"

@using GameMechanics.Player
@using Csla

@inject IDataPortal<UserRegistration> portal
@inject NavigationManager NavigationManager

<PageTitle>Threa - Register</PageTitle>
```

2. **Page content:**
```razor
<h1>Create Account</h1>

@if (!string.IsNullOrEmpty(Message))
{
    <div class="alert alert-danger">@Message</div>
}

@if (!string.IsNullOrEmpty(SuccessMessage))
{
    <div class="alert alert-success">@SuccessMessage</div>
}

<EditForm Model="RegistrationModel" OnSubmit="RegisterUser" FormName="registerform">
    <div class="mb-3">
        <label class="form-label">Username</label>
        <InputText class="form-control" @bind-Value="RegistrationModel!.Username" />
        <small class="form-text text-muted">3-50 characters</small>
    </div>
    <div class="mb-3">
        <label class="form-label">Password</label>
        <InputText type="password" class="form-control" @bind-Value="RegistrationModel!.Password" />
        <small class="form-text text-muted">Minimum 6 characters</small>
    </div>
    <div class="mb-3">
        <label class="form-label">Secret Question</label>
        <InputText class="form-control" @bind-Value="RegistrationModel!.SecretQuestion" />
        <small class="form-text text-muted">Used for password recovery</small>
    </div>
    <div class="mb-3">
        <label class="form-label">Secret Answer</label>
        <InputText class="form-control" @bind-Value="RegistrationModel!.SecretAnswer" />
        <small class="form-text text-muted">Case-insensitive</small>
    </div>
    <button type="submit" class="btn btn-primary">Register</button>
    <a href="/login" class="btn btn-link">Already have an account? Login</a>
</EditForm>
```

3. **Code block:**
```razor
@code {
    [SupplyParameterFromForm]
    public RegistrationInfo? RegistrationModel { get; set; }

    protected override void OnInitialized()
    {
        RegistrationModel ??= new();
    }

    public string Message { get; set; } = "";
    public string SuccessMessage { get; set; } = "";

    private async Task RegisterUser()
    {
        Message = "";
        SuccessMessage = "";

        try
        {
            var registration = await portal.CreateAsync();
            registration.Username = RegistrationModel!.Username;
            registration.Password = RegistrationModel!.Password;
            registration.SecretQuestion = RegistrationModel!.SecretQuestion;
            registration.SecretAnswer = RegistrationModel!.SecretAnswer;

            if (!registration.IsSavable)
            {
                // Show validation errors from broken rules
                var errors = registration.BrokenRulesCollection
                    .Where(r => r.Severity == Csla.Rules.RuleSeverity.Error)
                    .Select(r => r.Description);
                Message = string.Join("; ", errors);
                return;
            }

            await registration.SaveAsync();

            // Redirect to login after successful registration
            NavigationManager.NavigateTo("/login?registered=true");
        }
        catch (DataPortalException ex)
        {
            // Handle business exceptions (like duplicate username)
            Message = ex.BusinessExceptionMessage ?? ex.Message;
        }
        catch (Exception ex)
        {
            Message = $"Registration failed: {ex.Message}";
        }
    }

    public class RegistrationInfo
    {
        public string Username { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string SecretQuestion { get; set; } = string.Empty;
        public string SecretAnswer { get; set; } = string.Empty;
    }
}
```

Key differences from Login.razor:
- Uses IDataPortal<UserRegistration> instead of IDataPortal<UserValidation>
- Creates object with CreateAsync, sets properties, then SaveAsync
- Shows validation errors from BrokenRulesCollection before save attempt
- Redirects to login with ?registered=true query param (for optional success message)
  </action>
  <verify>
Build succeeds: `dotnet build Threa/Threa/Threa.csproj`
  </verify>
  <done>Register.razor exists with form for username, password, secret Q&A, and proper error handling.</done>
</task>

<task type="auto">
  <name>Task 2: Add Registration Link to Login Page</name>
  <files>Threa/Threa/Components/Pages/Login.razor</files>
  <action>
Modify Login.razor to add a link to the registration page and optionally show success message when redirected from registration:

1. **Add registration link after the login button:**
Find the existing `<button class="btn btn-primary">Login</button>` and add after it:
```razor
<a href="/register" class="btn btn-link">Don't have an account? Register</a>
```

2. **Optionally show success message when coming from registration:**
Add at the top of the code block:
```csharp
[SupplyParameterFromQuery]
public bool Registered { get; set; }
```

Add in the HTML, before the login form:
```razor
@if (Registered)
{
    <div class="alert alert-success">Registration successful! Please log in with your new account.</div>
}
```

This provides a visual confirmation that registration worked and guides the user to log in.
  </action>
  <verify>
Build succeeds: `dotnet build Threa/Threa/Threa.csproj`
  </verify>
  <done>Login.razor has link to /register and shows success message when ?registered=true.</done>
</task>

</tasks>

<verification>
1. `dotnet build Threa.sln` - All projects compile
2. Run the application: `dotnet run --project Threa/Threa`
3. Navigate to https://localhost:7133/register - page loads with form
4. Navigate to https://localhost:7133/login - shows "Don't have an account? Register" link
5. Click register link from login - navigates to /register
6. Fill in registration form with valid data - should create account and redirect to login
</verification>

<success_criteria>
- Register.razor exists at /register route
- Registration form has fields: Username, Password, Secret Question, Secret Answer
- Form validates input and shows errors from CSLA business rules
- Successful registration redirects to /login?registered=true
- Login page shows "Don't have an account? Register" link
- Login page shows success message when ?registered=true
- Duplicate username shows clear error message
</success_criteria>

<output>
After completion, create `.planning/phases/08-registration-foundation/08-02-SUMMARY.md`
</output>
