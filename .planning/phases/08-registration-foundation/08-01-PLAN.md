---
phase: 08-registration-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Threa.Dal/Dto/Player.cs
  - GameMechanics/Player/UserRegistration.cs
  - GameMechanics.Test/RegistrationTests.cs
autonomous: true

must_haves:
  truths:
    - "Player DTO has SecretQuestion and SecretAnswer fields"
    - "UserRegistration business object validates username, password (min 6), secret Q&A"
    - "First user gets Administrator role, subsequent users get Player role"
    - "Duplicate usernames throw DuplicateKeyException"
    - "Password is hashed with BCrypt before storage"
    - "Secret answer is stored lowercase and trimmed"
  artifacts:
    - path: "Threa.Dal/Dto/Player.cs"
      provides: "SecretQuestion and SecretAnswer properties"
      contains: "SecretQuestion"
    - path: "GameMechanics/Player/UserRegistration.cs"
      provides: "Registration business object with validation and Insert"
      exports: ["UserRegistration"]
    - path: "GameMechanics.Test/RegistrationTests.cs"
      provides: "Unit tests for registration validation and first-user logic"
      min_lines: 50
  key_links:
    - from: "GameMechanics/Player/UserRegistration.cs"
      to: "IPlayerDal"
      via: "CSLA [Inject] in Insert method"
      pattern: "\\[Inject\\] IPlayerDal"
    - from: "GameMechanics/Player/UserRegistration.cs"
      to: "BCrypt.Net.BCrypt"
      via: "Password hashing"
      pattern: "BCrypt\\.Net\\.BCrypt\\.(GenerateSalt|HashPassword)"
---

<objective>
Create the data layer and business object foundation for user registration.

Purpose: Enable users to self-register with username, password, and secret Q&A for password recovery. The first registered user automatically becomes admin.

Output: Extended Player DTO with secret Q&A fields, UserRegistration CSLA BusinessBase with validation rules and first-user-admin logic, unit tests.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-registration-foundation/08-RESEARCH.md

# Key existing files to reference
@Threa.Dal/Dto/Player.cs
@GameMechanics/Player/AdminUserEdit.cs
@GameMechanics/Player/UserValidation.cs
@GameMechanics/Player/Roles.cs
@Threa.Dal/IPlayerDal.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Player DTO with Secret Q&A Fields</name>
  <files>Threa.Dal/Dto/Player.cs</files>
  <action>
Add two new properties to the Player DTO class:

```csharp
public string SecretQuestion { get; set; } = string.Empty;
public string SecretAnswer { get; set; } = string.Empty;  // Stored lowercase, trimmed
```

Add them after the existing `IsEnabled` property. These fields will be automatically serialized to the JSON blob in SQLite - no schema migration needed.

Note: The secret answer is stored normalized (lowercase, trimmed) at write time, not as a hash. This is intentional - it's for identity verification, not authentication.
  </action>
  <verify>
Build succeeds: `dotnet build Threa.sln`
  </verify>
  <done>Player DTO has SecretQuestion and SecretAnswer properties with empty string defaults.</done>
</task>

<task type="auto">
  <name>Task 2: Create UserRegistration Business Object</name>
  <files>GameMechanics/Player/UserRegistration.cs</files>
  <action>
Create a new CSLA BusinessBase for registration following the AdminUserEdit.cs pattern:

1. **Properties (using PropertyInfo pattern):**
   - `Id` (int, private set, LoadProperty) - Set after insert
   - `Username` (string) - Login username
   - `Password` (string) - Plain text, hashed in Insert
   - `SecretQuestion` (string) - Password recovery question
   - `SecretAnswer` (string) - Password recovery answer

2. **Business Rules (in AddBusinessRules):**
   - Required: Username, Password, SecretQuestion, SecretAnswer
   - MinLength: Password >= 6 chars with custom message "Password must be at least 6 characters"
   - MinLength: Username >= 3 chars with custom message "Username must be at least 3 characters"
   - MaxLength: Username <= 50 chars

3. **Create method:**
   - Initialize all string properties to empty string using BypassPropertyChecks
   - Call BusinessRules.CheckRules()

4. **Insert method (key logic):**
   ```csharp
   [Insert]
   private async Task Insert([Inject] IPlayerDal dal)
   {
       // Check for duplicate username (case-insensitive by checking existing)
       var existing = await dal.GetPlayerByEmailAsync(Username);
       if (existing != null)
           throw new DuplicateKeyException($"Username '{Username}' is already registered");

       // Determine if this is the first user (becomes Admin)
       var allPlayers = await dal.GetAllPlayersAsync();
       bool isFirstUser = !allPlayers.Any();

       // Hash password with BCrypt
       var hashedPassword = BCrypt.Net.BCrypt.HashPassword(Password);

       // Create player with appropriate role
       var player = new Threa.Dal.Dto.Player
       {
           Email = Username,  // Email field stores username (legacy naming)
           Name = Username,   // Initial display name = username
           HashedPassword = hashedPassword,
           SecretQuestion = SecretQuestion,
           SecretAnswer = SecretAnswer.Trim().ToLowerInvariant(),
           Roles = isFirstUser ? Roles.Administrator : Roles.Player,
           IsEnabled = true
       };

       var result = await dal.SavePlayerAsync(player);
       LoadProperty(IdProperty, result.Id);
   }
   ```

Note: BCrypt.Net.HashPassword generates salt internally - no need for separate Salt field. The research suggested using GenerateSalt(12), but BCrypt.HashPassword with single argument uses default cost factor 11, which is acceptable. For consistency with existing code (AdminUserEdit uses GenerateSalt), use:
```csharp
var salt = BCrypt.Net.BCrypt.GenerateSalt(12);
var hashedPassword = BCrypt.Net.BCrypt.HashPassword(Password, salt);
// Then store Salt in the player DTO too
player.Salt = salt;
```

Required usings:
```csharp
using System;
using System.Linq;
using System.Threading.Tasks;
using Csla;
using Threa.Dal;
```
  </action>
  <verify>
Build succeeds: `dotnet build GameMechanics/GameMechanics.csproj`
  </verify>
  <done>UserRegistration.cs exists with validation rules, first-user detection, and password hashing.</done>
</task>

<task type="auto">
  <name>Task 3: Create Registration Unit Tests</name>
  <files>GameMechanics.Test/RegistrationTests.cs</files>
  <action>
Create unit tests for the UserRegistration business object following existing test patterns (see CombatTests.cs for style):

1. **Validation Tests:**
   - `Create_HasBrokenRules_WhenFieldsEmpty` - Verify all required fields show broken rules
   - `Create_HasBrokenRules_WhenPasswordTooShort` - Password < 6 chars fails validation
   - `Create_HasBrokenRules_WhenUsernameTooShort` - Username < 3 chars fails validation
   - `Create_IsSavable_WhenAllFieldsValid` - All fields valid = IsSavable true

2. **Note on Insert Tests:**
   The Insert method requires IPlayerDal injection which needs integration test setup. For unit testing, focus on validation rules that can be tested without the data portal.

Test class structure:
```csharp
using Microsoft.VisualStudio.TestTools.UnitTesting;
using Csla;
using GameMechanics.Player;

namespace GameMechanics.Test;

[TestClass]
public class RegistrationTests
{
    // Note: These tests require CSLA ApplicationContext setup
    // For now, verify the UserRegistration class compiles and
    // validation rules are correctly defined by inspecting BrokenRulesCollection
}
```

If CSLA test setup is complex, create simpler tests that verify:
- The class exists and is serializable
- Properties are defined correctly
- BusinessRules are registered (requires Create which needs DataPortal)

Alternative: Create a test that uses the actual DataPortal with test DI setup if existing tests show this pattern.
  </action>
  <verify>
Tests pass: `dotnet test GameMechanics.Test/GameMechanics.Test.csproj --filter "FullyQualifiedName~RegistrationTests"`
  </verify>
  <done>RegistrationTests.cs exists with validation tests for registration business object.</done>
</task>

</tasks>

<verification>
1. `dotnet build Threa.sln` - All projects compile
2. `dotnet test GameMechanics.Test/GameMechanics.Test.csproj` - All tests pass (including new registration tests)
3. Player DTO has SecretQuestion and SecretAnswer properties
4. UserRegistration.cs exists with Required, MinLength rules and Insert method
</verification>

<success_criteria>
- Player DTO extended with SecretQuestion, SecretAnswer string properties
- UserRegistration CSLA BusinessBase created with:
  - Username, Password, SecretQuestion, SecretAnswer properties
  - Required validation on all fields
  - MinLength(6) on Password, MinLength(3) on Username
  - Insert method that checks duplicates, detects first user, hashes password, saves with correct role
- Unit tests verify validation rules
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/08-registration-foundation/08-01-SUMMARY.md`
</output>
