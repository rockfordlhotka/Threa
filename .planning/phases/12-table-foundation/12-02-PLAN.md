---
phase: 12-table-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Threa/Threa.Client/Components/Pages/GameMaster/Campaigns.razor
  - Threa/Threa/wwwroot/js/theme.js
  - Threa/Threa.Client/Components/Shared/ThemeIndicator.razor
autonomous: true

must_haves:
  truths:
    - "GM can see a list of all campaigns they created"
    - "Campaign list shows name, theme indicator, epoch time, and created date columns"
    - "Campaign list is sorted newest-first (most recently created at top)"
    - "GM can click a campaign row to navigate to its dashboard"
    - "Theme infrastructure works correctly (applies and persists)"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/GameMaster/Campaigns.razor"
      provides: "Campaign list page at /campaigns"
      contains: "@page \"/campaigns\""
    - path: "Threa/Threa.Client/Components/Shared/ThemeIndicator.razor"
      provides: "Reusable theme indicator component"
      contains: "bi-book"
  key_links:
    - from: "Campaigns.razor"
      to: "tableListPortal.FetchAsync()"
      via: "IDataPortal injection"
      pattern: "await tableListPortal\\.FetchAsync"
    - from: "Campaigns.razor"
      to: "CampaignCreate.razor"
      via: "Navigation link"
      pattern: "NavigateTo.*campaigns/create"
---

<objective>
Create the campaign list view with proper columns and sorting, add theme indicator component, and fix any theme infrastructure issues.

Purpose: Enable GMs to view all their campaigns in a data table format with theme and epoch time columns, sorted by creation date (newest first), and ensure theme switching works reliably.

Output:
- New Campaigns.razor page at /campaigns with data table
- ThemeIndicator.razor component for displaying theme badges
- Verified/fixed theme.js infrastructure
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-table-foundation/12-CONTEXT.md
@.planning/phases/12-table-foundation/12-RESEARCH.md

@GameMechanics/GamePlay/TableInfo.cs
@GameMechanics/GamePlay/TableList.cs
@Threa/Threa.Client/Components/Pages/GamePlay/Tables.razor
@Threa/Threa/wwwroot/js/theme.js
@Threa/Threa.Client/Components/Shared/ThemeSwitcher.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ThemeIndicator component</name>
  <files>Threa/Threa.Client/Components/Shared/ThemeIndicator.razor</files>
  <action>
Create a simple reusable component to display a theme badge/indicator in list views.

**Component specification:**
- Namespace: `Threa.Client.Components.Shared`
- Parameter: `Theme` (string, default "fantasy")

**Rendering:**
- For "scifi": Show a badge with CPU icon and "Sci-Fi" text
  - Style: transparent background, accent border, accent text color
  - Icon: `bi-cpu` (Bootstrap Icons)
- For "fantasy" (default): Show a badge with book icon and "Fantasy" text
  - Style: accent background, white text
  - Icon: `bi-book` (Bootstrap Icons)

**Example markup:**
```razor
@if (Theme == "scifi")
{
    <span class="badge" style="background: transparent; border: 1px solid var(--color-accent-primary); color: var(--color-accent-primary);">
        <i class="bi bi-cpu"></i> Sci-Fi
    </span>
}
else
{
    <span class="badge" style="background: var(--color-accent-primary); color: white;">
        <i class="bi bi-book"></i> Fantasy
    </span>
}
```

Note: Uses CSS variables so it works with both themes active.
  </action>
  <verify>
Run `dotnet build Threa/Threa.Client/Threa.Client.csproj` - should compile without errors.
Component file exists at the specified path.
  </verify>
  <done>
ThemeIndicator.razor component exists with Theme parameter, displays appropriate icon and styling for fantasy/scifi.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Campaigns.razor list page</name>
  <files>Threa/Threa.Client/Components/Pages/GameMaster/Campaigns.razor</files>
  <action>
Create a new campaign list page that replaces/complements the existing Tables.razor modal approach.

**Page structure:**
- Route: `@page "/campaigns"` (also consider adding `@page "/gamemaster/tables"` as alias for compatibility)
- RenderMode: InteractiveServer
- Authorization: `[Authorize(Roles = "GameMaster,Administrator")]`
- Inject: StateManager, RenderModeProvider, NavigationManager, IDataPortal for TableList, IDataPortal for TableEdit

**Header section:**
- Title: "My Campaigns"
- "Create New Campaign" button that navigates to /campaigns/create

**Data table (Bootstrap table, not RadzenDataGrid for simplicity):**
Columns (per CONTEXT.md):
1. Campaign Name - clickable, links to dashboard
2. Theme - uses ThemeIndicator component
3. Epoch Time - displays raw long value (StartTimeSeconds)
4. Created - formatted date using .ToString("g")

**Sorting:**
- Fixed sort order: newest first (OrderByDescending on CreatedAt)
- No column header sorting controls

**Row behavior:**
- Entire row clickable, navigates to `/gamemaster/table/{id}`
- Use `style="cursor: pointer"` for visual feedback

**Empty state:**
- Show friendly message when no campaigns exist
- Include link to create first campaign

**Error handling:**
- Display error message if loading fails

**Implementation notes:**
- Load tables via tableListPortal.FetchAsync() in OnInitializedAsync (same pattern as Tables.razor)
- Apply OrderByDescending(t => t.CreatedAt) before rendering
- Reference the ThemeIndicator component: `<ThemeIndicator Theme="@table.Theme" />`
- Delete functionality optional (can keep from Tables.razor pattern)

Reference existing Tables.razor for the loading and data portal patterns.
  </action>
  <verify>
1. Run `dotnet build Threa/Threa/Threa.csproj` - should compile without errors
2. Navigate to https://localhost:7133/campaigns as a GM user
3. Verify table shows with columns: Name, Theme, Epoch Time, Created
4. Verify campaigns are sorted newest-first
5. Verify clicking a row navigates to that campaign's dashboard
6. Verify "Create New Campaign" button navigates to /campaigns/create
  </verify>
  <done>
Campaigns.razor exists at /campaigns with:
- Data table showing Name, Theme indicator, Epoch Time, Created date
- Sorted by CreatedAt descending (newest first)
- Row click navigates to campaign dashboard
- Create New Campaign button links to /campaigns/create
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify and fix theme infrastructure</name>
  <files>Threa/Threa/wwwroot/js/theme.js</files>
  <action>
The CONTEXT.md indicates theme infrastructure is "broken" and needs repair. Investigate and fix issues.

**Investigation steps:**
1. Check theme.js loads correctly (look for script tag in App.razor or _Host.cshtml)
2. Test sessionStorage persistence (does theme survive page navigation?)
3. Test data-theme attribute application (is it on html element?)
4. Test CSS variable cascade (do themed components pick up the variables?)

**Common issues to check and fix:**

1. **Script loading timing**: If theme.js loads after Blazor hydrates, the DOMContentLoaded event may have already fired. Add a check:
```javascript
// Auto-initialize on page load
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        window.threaTheme.init();
    });
} else {
    // DOM already loaded, init immediately
    window.threaTheme.init();
}
```

2. **Blazor navigation resets**: Enhanced navigation in Blazor may not trigger DOMContentLoaded. Add a MutationObserver or ensure init() is called from Blazor on each page load.

3. **SSR hydration**: During SSR the data-theme attribute may be lost. Ensure theme.js is in the <head> and runs early.

**If theme works correctly after testing:**
- Add a comment documenting that it was verified working
- No changes needed if it works

**If theme has issues:**
- Fix the specific issue found
- Test that fix resolves the problem
- Document what was fixed in the summary

Reference ThemeSwitcher.razor and GmTable.razor for how JS interop is called.
  </action>
  <verify>
1. Run the application: `dotnet run --project Threa/Threa/Threa.csproj`
2. Navigate to /campaigns and create a campaign with scifi theme
3. Theme preview should update styling on CampaignCreate page
4. After navigating to dashboard, theme should persist
5. Refresh page - theme should still be applied (from sessionStorage)
6. Navigate away and back - theme should persist
7. Check browser console for any theme-related errors
  </verify>
  <done>
Theme infrastructure verified working or issues fixed:
- data-theme attribute applies correctly to html element
- sessionStorage persists theme across navigation
- CSS variables cascade to all themed components
- Theme preview works in campaign creation
  </done>
</task>

</tasks>

<verification>
1. Build passes: `dotnet build Threa.sln`
2. /campaigns page loads and shows campaign list
3. Theme indicator shows correct icon/styling for each campaign
4. Campaigns sorted newest-first
5. Row click navigates to dashboard
6. Theme switching works end-to-end (create page preview, dashboard application, persistence)
</verification>

<success_criteria>
- [ ] ThemeIndicator.razor component created with fantasy/scifi badge display
- [ ] Campaigns.razor page exists at /campaigns
- [ ] Table shows Name, Theme, Epoch Time, Created columns
- [ ] Table sorted by CreatedAt descending (newest first)
- [ ] Row click navigates to /gamemaster/table/{id}
- [ ] Create New Campaign button links to /campaigns/create
- [ ] Theme infrastructure verified working or issues fixed
</success_criteria>

<output>
After completion, create `.planning/phases/12-table-foundation/12-02-SUMMARY.md`
</output>
