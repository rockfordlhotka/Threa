---
phase: 11-user-profiles
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - Threa/Threa.Client/Components/Shared/UserAvatar.razor
  - Threa/Threa/wwwroot/app.css
  - Threa/Threa.Client/Components/Pages/Player/PlayerEdit.razor
  - Threa/Threa.Client/Components/Pages/Profile.razor
  - Threa/Threa/Components/Layout/NavMenu.razor
  - Threa/Threa.Client/Components/Pages/Admin/Users.razor
autonomous: true

must_haves:
  truths:
    - "User can view and edit profile at /player/playeredit"
    - "Profile page shows live Gravatar preview when email provided"
    - "Avatar shows initials when no email or Gravatar disabled"
    - "Avatars display in navigation bar for logged-in user"
    - "Avatars display in admin user list"
    - "User can toggle Gravatar opt-out"
  artifacts:
    - path: "Threa/Threa.Client/Components/Shared/UserAvatar.razor"
      provides: "Reusable avatar component with Gravatar/initials fallback"
      contains: "RadzenGravatar"
    - path: "Threa/Threa.Client/Components/Pages/Player/PlayerEdit.razor"
      provides: "Enhanced profile editing page"
      contains: "ContactEmail"
    - path: "Threa/Threa/wwwroot/app.css"
      provides: "CSS for initials avatar styling"
      contains: "threa-avatar-initials"
  key_links:
    - from: "Threa/Threa.Client/Components/Pages/Player/PlayerEdit.razor"
      to: "GameMechanics/Player/PlayerEdit.cs"
      via: "CSLA ViewModel binding"
      pattern: "vm.Model"
    - from: "Threa/Threa.Client/Components/Shared/UserAvatar.razor"
      to: "Radzen.Blazor"
      via: "RadzenGravatar component"
      pattern: "RadzenGravatar"
---

<objective>
Create the UserAvatar component and enhance the profile editing UI with Gravatar preview, then integrate avatars throughout the application (nav bar, admin user list). Users can edit their profile including display name, contact email, and Gravatar preferences.

Purpose: Delivers the user-facing profile management experience. Users can set display names, provide email for Gravatar, and see their avatar throughout the UI.

Output: Reusable UserAvatar component, enhanced profile edit page with live Gravatar preview, avatars in nav and admin UI.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-user-profiles/11-CONTEXT.md
@.planning/phases/11-user-profiles/11-RESEARCH.md
@.planning/research/GRAVATAR.md

Key patterns from existing code:
- Threa/Threa.Client/Components/Pages/Player/PlayerEdit.razor - Current profile page
- Threa/Threa.Client/Components/Pages/Admin/Users.razor - Admin list pattern
- Threa/Threa/Components/Layout/NavMenu.razor - Navigation structure
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UserAvatar component and CSS</name>
  <files>
    - Threa/Threa.Client/Components/Shared/UserAvatar.razor
    - Threa/Threa/wwwroot/app.css
  </files>
  <action>
Create directory if needed: `Threa/Threa.Client/Components/Shared/`

Create UserAvatar.razor - reusable avatar component with Gravatar/initials fallback:

```razor
@* UserAvatar.razor - Displays Gravatar when email provided, initials otherwise *@

@if (!string.IsNullOrWhiteSpace(Email) && UseGravatar)
{
    <RadzenGravatar Email="@Email"
                    Size="@Size"
                    AlternateText="@GetAltText()"
                    Style="@GetStyle()" />
}
else
{
    <div class="threa-avatar-initials" style="@GetInitialsStyle()">
        @GetInitials()
    </div>
}

@code {
    /// <summary>Contact email for Gravatar lookup</summary>
    [Parameter] public string? Email { get; set; }

    /// <summary>Display name for initials fallback and alt text</summary>
    [Parameter] public string? DisplayName { get; set; }

    /// <summary>Avatar size in pixels (square)</summary>
    [Parameter] public int Size { get; set; } = 48;

    /// <summary>Whether to use Gravatar when email is provided</summary>
    [Parameter] public bool UseGravatar { get; set; } = true;

    /// <summary>Whether avatar should be round</summary>
    [Parameter] public bool Round { get; set; } = true;

    private string GetAltText() =>
        string.IsNullOrWhiteSpace(DisplayName) ? "User avatar" : $"{DisplayName}'s avatar";

    private string GetStyle() =>
        Round ? "border-radius: 50%;" : "";

    private string GetInitialsStyle() =>
        $"width:{Size}px;height:{Size}px;font-size:{Size * 0.4}px;" +
        (Round ? "border-radius:50%;" : "");

    private string GetInitials()
    {
        if (string.IsNullOrWhiteSpace(DisplayName))
            return "?";

        var parts = DisplayName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return parts.Length >= 2
            ? $"{parts[0][0]}{parts[^1][0]}".ToUpperInvariant()
            : DisplayName[0].ToString().ToUpperInvariant();
    }
}
```

Add CSS to app.css (at end of file):

```css
/* UserAvatar initials fallback styling */
.threa-avatar-initials {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--rz-primary), var(--rz-primary-dark, var(--rz-primary)));
    color: var(--rz-on-primary, white);
    font-weight: 600;
    text-transform: uppercase;
}
```
  </action>
  <verify>
    - Build succeeds: `dotnet build Threa/Threa.Client/Threa.Client.csproj`
    - File exists: `ls Threa/Threa.Client/Components/Shared/UserAvatar.razor`
  </verify>
  <done>
    - UserAvatar.razor component created with Gravatar/initials logic
    - CSS for initials styling added to app.css
    - Component accepts Email, DisplayName, Size, UseGravatar, Round parameters
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance profile edit page with new fields and Gravatar preview</name>
  <files>
    - Threa/Threa.Client/Components/Pages/Player/PlayerEdit.razor
  </files>
  <action>
Replace the existing PlayerEdit.razor with enhanced version that includes:
- Display name (already exists, editable)
- Contact email field (new, for Gravatar)
- Use Gravatar toggle checkbox
- Live Gravatar preview that updates as email changes
- Form validation feedback using CSLA patterns

```razor
@page "/player/playeredit"
@rendermode InteractiveServer

@attribute [Authorize]

@using GameMechanics.Player
@using System.Security.Claims
@using Threa.Client.Components.Shared

@inject IDataPortal<GameMechanics.Player.PlayerEdit> playerPortal
@inject ViewModel<GameMechanics.Player.PlayerEdit> vm
@inject ApplicationContext applicationContext
@inject Threa.Services.RenderModeProvider RenderModeProvider
@inject NavigationManager NavigationManager

<h3>My Profile</h3>

<div class="alert-danger">@vm.ViewModelErrorText</div>

@if (vm.Model == null)
{
    <div>Loading...</div>
    <img src="images/busy.gif" class="busy-animation" />
}
else
{
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Profile Settings</h5>

                    <div class="mb-3">
                        <label class="form-label">Username (for login)</label>
                        <input type="text" class="form-control" value="@vm.Model.Email" disabled
                               title="Username cannot be changed" />
                        <div class="form-text">Your login username cannot be changed.</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Display Name <span class="text-danger">*</span></label>
                        <TextInput Property="vm.GetPropertyInfo<string>(() => vm.Model.Name)" />
                        <div class="form-text">This name is shown throughout the app (1-50 characters).</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Contact Email (optional)</label>
                        <TextInput Property="vm.GetPropertyInfo<string>(() => vm.Model.ContactEmail)" />
                        <div class="form-text">Used for Gravatar avatar. Not visible to other users.</div>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="useGravatar"
                               checked="@vm.Model.UseGravatar"
                               @onchange="@(e => vm.Model.UseGravatar = (bool)(e.Value ?? false))" />
                        <label class="form-check-label" for="useGravatar">
                            Use Gravatar for my avatar
                        </label>
                        <div class="form-text">When disabled, your initials will be shown instead.</div>
                    </div>

                    <button type="button"
                            @onclick="SaveData"
                            class="btn btn-primary"
                            disabled="@(!vm.Model.IsSavable)">
                        Save Profile
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Avatar Preview</h5>
                    <div class="mb-3">
                        <UserAvatar Email="@vm.Model.ContactEmail"
                                    DisplayName="@vm.Model.Name"
                                    Size="128"
                                    UseGravatar="@vm.Model.UseGravatar" />
                    </div>
                    <p class="text-muted small">
                        @if (vm.Model.UseGravatar && !string.IsNullOrWhiteSpace(vm.Model.ContactEmail))
                        {
                            <span>Showing Gravatar for your email</span>
                        }
                        else
                        {
                            <span>Showing initials from your display name</span>
                        }
                    </p>
                </div>
            </div>
        </div>
    </div>
}

@code {
    protected override async Task OnInitializedAsync()
    {
        if (!RenderModeProvider.GetRenderMode(this).ToString().Contains("Interactive"))
            return;
        vm.Saved += () => NavigationManager.NavigateTo("/");
        vm.ModelChanged += async () => await InvokeAsync(() => StateHasChanged());
        vm.ModelPropertyChanged += async (s, a) => await InvokeAsync(() => StateHasChanged());
        var identity = applicationContext.Principal.Identity!;
        string? idText = applicationContext.Principal.Claims.First(c => c.Type == ClaimTypes.NameIdentifier)?.Value;
        int playerId = int.Parse(idText!);
        await vm.RefreshAsync(() =>
            playerPortal.FetchAsync(playerId));
    }

    private async Task SaveData()
    {
        await vm.SaveAsync();
        NavigationManager.NavigateTo("/");
    }
}
```

Note: TextInput is a CSLA Blazor component that provides validation binding. The page uses the existing CSLA ViewModel pattern.
  </action>
  <verify>
    - Build succeeds: `dotnet build Threa/Threa.Client/Threa.Client.csproj`
    - Page compiles without errors
  </verify>
  <done>
    - Profile edit page shows display name, contact email, and Gravatar toggle
    - Live avatar preview updates as user changes email or toggle
    - Validation feedback displayed via CSLA bindings
    - Save button disabled when form is invalid
  </done>
</task>

<task type="auto">
  <name>Task 3: Add avatar to navigation bar and admin user list</name>
  <files>
    - Threa/Threa/Components/Layout/NavMenu.razor
    - Threa/Threa.Client/Components/Pages/Admin/Users.razor
  </files>
  <action>
Update NavMenu.razor to show current user's avatar in the authorized section. Since claims don't include ContactEmail (and we want fresh data anyway), we'll show a simple avatar placeholder based on the user's name from claims, with a note that the full avatar integration requires additional claims work (which can be done in a future enhancement).

For now, add a simple display name indicator in the nav. Full avatar in nav requires fetching profile data or extending claims, which is beyond this plan's scope.

Update the Authorized section in NavMenu.razor to show user identity:

```razor
@* At the top of the Authorized section, after line 18 *@
<div class="nav-item px-3 py-2 text-light small">
    Logged in as: @context.User.Identity?.Name
</div>
```

Update Users.razor in Admin to show avatars in the user list. Add a template column for avatar:

First, add using statement at top:
```razor
@using Threa.Client.Components.Shared
```

Then add an avatar column before the Username column in the QuickGrid:
```razor
<TemplateColumn Title="" Width="50px">
    <UserAvatar Email="@context.Email"
                DisplayName="@context.Name"
                Size="32"
                UseGravatar="true" />
</TemplateColumn>
```

Note: The admin list shows `Email` (which is actually username in this codebase) and `Name` (display name). For proper Gravatar, we'd need to expose ContactEmail in AdminUserInfo. For now, this shows initials since Email contains username, not an actual email address. This can be enhanced by updating AdminUserInfo to include ContactEmail in a future iteration.
  </action>
  <verify>
    - Build succeeds: `dotnet build Threa/Threa.sln`
    - Run app and verify nav shows logged-in username
    - Admin user list shows avatar column
  </verify>
  <done>
    - NavMenu shows logged-in user identity
    - Admin user list has avatar column showing initials
    - UserAvatar component integrated in multiple locations
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `dotnet build Threa.sln` succeeds
2. Run application: `dotnet run --project Threa/Threa/Threa.csproj`
3. Login and navigate to /player/playeredit
4. Verify profile page shows:
   - Username (read-only)
   - Display name (editable with validation)
   - Contact email (editable)
   - Use Gravatar toggle
   - Live avatar preview
5. Save changes and verify they persist
6. Verify nav shows logged-in user
7. Verify admin user list shows avatar column (as admin user)
</verification>

<success_criteria>
- UserAvatar component renders Gravatar when email+enabled, initials otherwise
- Profile edit page allows editing display name, contact email, Gravatar preference
- Avatar preview updates live as user changes settings
- Avatars appear in admin user list
- Navigation shows current user identity
- All validation rules enforce 1-50 char display name with profanity filter
</success_criteria>

<output>
After completion, create `.planning/phases/11-user-profiles/11-02-SUMMARY.md`
</output>
