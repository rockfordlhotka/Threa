---
phase: 23-data-model-foundation
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - Threa.Dal/ICharacterDal.cs
  - Threa.Dal.SqlLite/CharacterDal.cs
  - GameMechanics.Test/CharacterTests.cs
autonomous: true

must_haves:
  truths:
    - "DAL interface defines GetNpcTemplatesAsync method"
    - "DAL interface defines GetTableNpcsAsync method"
    - "GetNpcTemplatesAsync returns only characters with IsNpc=true AND IsTemplate=true"
    - "NPC flags persist through save/fetch cycle"
    - "VisibleToPlayers flag persists with both true and false values"
  artifacts:
    - path: "Threa.Dal/ICharacterDal.cs"
      provides: "NPC query method signatures"
      contains: "GetNpcTemplatesAsync"
    - path: "Threa.Dal.SqlLite/CharacterDal.cs"
      provides: "NPC query implementations"
      contains: "GetNpcTemplatesAsync"
    - path: "GameMechanics.Test/CharacterTests.cs"
      provides: "NPC flag persistence tests"
      contains: "NpcFlags_PersistToDatabase"
  key_links:
    - from: "Threa.Dal.SqlLite/CharacterDal.cs"
      to: "GetAllCharactersAsync"
      via: "reuses existing fetch, filters in memory"
      pattern: "GetAllCharactersAsync.*Where.*IsNpc"
    - from: "GameMechanics.Test/CharacterTests.cs"
      to: "IDataPortal<CharacterEdit>"
      via: "create, save, fetch, verify cycle"
      pattern: "SaveAsync.*FetchAsync"
---

<objective>
Add DAL query methods and unit tests for NPC flags.

Purpose: Enable querying NPC templates from the database and verify that NPC flags persist correctly through the save/fetch cycle.

Output: ICharacterDal interface with new query methods, SQLite implementation, and unit tests proving NPC flags work.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-data-model-foundation/23-RESEARCH.md
@.planning/phases/23-data-model-foundation/23-01-SUMMARY.md

# Source files to modify
@Threa.Dal/ICharacterDal.cs
@Threa.Dal.SqlLite/CharacterDal.cs
@GameMechanics.Test/CharacterTests.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add query methods to DAL interface and implementation</name>
  <files>
Threa.Dal/ICharacterDal.cs
Threa.Dal.SqlLite/CharacterDal.cs
  </files>
  <action>
**In ICharacterDal.cs**, add two new method signatures:

```csharp
Task<List<Character>> GetNpcTemplatesAsync();
Task<List<Character>> GetTableNpcsAsync(Guid tableId);
```

Add these after the existing GetAllCharactersAsync method.

**In CharacterDal.cs**, implement the methods:

```csharp
public async Task<List<Character>> GetNpcTemplatesAsync()
{
    try
    {
        // Reuse existing fetch, filter in memory for JSON storage
        var all = await GetAllCharactersAsync();
        return all.Where(c => c.IsNpc && c.IsTemplate).ToList();
    }
    catch (Exception ex)
    {
        throw new OperationFailedException("Error getting NPC templates", ex);
    }
}

public async Task<List<Character>> GetTableNpcsAsync(Guid tableId)
{
    // Full implementation requires TableDal integration (Phase 25)
    // For Phase 23, provide a stub that throws NotImplementedException
    throw new NotImplementedException("GetTableNpcsAsync requires Phase 25 table integration");
}
```

Add `using System.Linq;` if not already present in CharacterDal.cs.
Add `using System;` for Guid if not already present in ICharacterDal.cs.
  </action>
  <verify>
Build the DAL projects:
```
dotnet build Threa.Dal/Threa.Dal.csproj && dotnet build Threa.Dal.SqlLite/Threa.Dal.SqlLite.csproj
```
  </verify>
  <done>ICharacterDal has GetNpcTemplatesAsync and GetTableNpcsAsync. SQLite implementation filters by IsNpc && IsTemplate for templates.</done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for NPC flag persistence</name>
  <files>GameMechanics.Test/CharacterTests.cs</files>
  <action>
Add unit tests to CharacterTests.cs to verify NPC flags persist correctly.

Add these test methods at the end of the CharacterTests class:

```csharp
[TestMethod]
public async Task Character_NpcFlags_PersistToDatabase()
{
    var provider = InitServices();
    var dp = provider.GetRequiredService<IDataPortal<CharacterEdit>>();
    var c = dp.Create(42);

    // Set NPC flags (hidden NPC, not a template)
    c.Name = "Goblin Scout";
    c.Species = "Goblin";
    c.IsNpc = true;
    c.IsTemplate = false;
    c.VisibleToPlayers = false;  // Hidden for surprise

    c = await c.SaveAsync();
    var characterId = c.Id;

    // Fetch and verify
    var fetched = await dp.FetchAsync(characterId);
    Assert.IsTrue(fetched.IsNpc, "IsNpc should persist as true");
    Assert.IsFalse(fetched.IsTemplate, "IsTemplate should persist as false");
    Assert.IsFalse(fetched.VisibleToPlayers, "VisibleToPlayers should persist as false");
}

[TestMethod]
public async Task Character_TemplateFlags_PersistToDatabase()
{
    var provider = InitServices();
    var dp = provider.GetRequiredService<IDataPortal<CharacterEdit>>();
    var c = dp.Create(42);

    // Create NPC template
    c.Name = "Goblin Warrior Template";
    c.Species = "Goblin";
    c.IsNpc = true;
    c.IsTemplate = true;
    c.VisibleToPlayers = true;  // Templates visible in library

    c = await c.SaveAsync();
    var characterId = c.Id;

    // Fetch and verify
    var fetched = await dp.FetchAsync(characterId);
    Assert.IsTrue(fetched.IsNpc, "Template IsNpc should persist");
    Assert.IsTrue(fetched.IsTemplate, "Template IsTemplate should persist");
    Assert.IsTrue(fetched.VisibleToPlayers, "Template VisibleToPlayers should persist");
}

[TestMethod]
public async Task Character_VisibleToPlayers_DefaultsToTrue()
{
    var provider = InitServices();
    var dp = provider.GetRequiredService<IDataPortal<CharacterEdit>>();
    var c = dp.Create(42);

    // Verify default value before any explicit set
    Assert.IsTrue(c.VisibleToPlayers, "VisibleToPlayers should default to true");

    // Save and fetch without setting VisibleToPlayers
    c.Name = "Test Character";
    c.Species = "Human";
    c = await c.SaveAsync();

    var fetched = await dp.FetchAsync(c.Id);
    Assert.IsTrue(fetched.VisibleToPlayers, "VisibleToPlayers should remain true after fetch");
}

[TestMethod]
public async Task GetNpcTemplatesAsync_ReturnsOnlyTemplates()
{
    var provider = InitServices();
    var dp = provider.GetRequiredService<IDataPortal<CharacterEdit>>();
    var characterDal = provider.GetRequiredService<ICharacterDal>();

    // Create a regular PC
    var pc = dp.Create(42);
    pc.Name = "Player Character";
    pc.Species = "Human";
    pc.IsNpc = false;
    pc.IsTemplate = false;
    pc = await pc.SaveAsync();

    // Create an NPC (not a template)
    var npc = dp.Create(42);
    npc.Name = "Active NPC";
    npc.Species = "Goblin";
    npc.IsNpc = true;
    npc.IsTemplate = false;
    npc = await npc.SaveAsync();

    // Create an NPC template
    var template = dp.Create(42);
    template.Name = "Goblin Template";
    template.Species = "Goblin";
    template.IsNpc = true;
    template.IsTemplate = true;
    template = await template.SaveAsync();

    // Query templates
    var templates = await characterDal.GetNpcTemplatesAsync();

    // Verify only the template is returned
    Assert.IsTrue(templates.Any(t => t.Name == "Goblin Template"), "Template should be in results");
    Assert.IsFalse(templates.Any(t => t.Name == "Player Character"), "PC should not be in results");
    Assert.IsFalse(templates.Any(t => t.Name == "Active NPC"), "Non-template NPC should not be in results");
}
```

Add `using System.Threading.Tasks;` if not already present.
Add `using System.Linq;` if not already present.
  </action>
  <verify>
Run the tests:
```
dotnet test GameMechanics.Test/GameMechanics.Test.csproj --filter "FullyQualifiedName~Character_NpcFlags|FullyQualifiedName~Character_TemplateFlags|FullyQualifiedName~Character_VisibleToPlayers|FullyQualifiedName~GetNpcTemplatesAsync"
```
  </verify>
  <done>All 4 NPC flag tests pass: NpcFlags_PersistToDatabase, TemplateFlags_PersistToDatabase, VisibleToPlayers_DefaultsToTrue, GetNpcTemplatesAsync_ReturnsOnlyTemplates.</done>
</task>

</tasks>

<verification>
1. All projects build successfully
2. All 4 new unit tests pass
3. GetNpcTemplatesAsync correctly filters by IsNpc=true AND IsTemplate=true
4. NPC flags persist through complete save/fetch cycle
</verification>

<success_criteria>
- ICharacterDal has GetNpcTemplatesAsync and GetTableNpcsAsync methods
- CharacterDal implements GetNpcTemplatesAsync with filtering logic
- CharacterDal stubs GetTableNpcsAsync (throws NotImplementedException)
- 4 new unit tests exist and pass
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/23-data-model-foundation/23-02-SUMMARY.md`
</output>
