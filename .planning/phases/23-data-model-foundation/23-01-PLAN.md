---
phase: 23-data-model-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Threa.Dal/Dto/Character.cs
  - GameMechanics/CharacterEdit.cs
autonomous: true

must_haves:
  truths:
    - "CharacterEdit has IsNpc, IsTemplate, VisibleToPlayers properties"
    - "DTO serializes new boolean flags to JSON"
    - "New properties use CSLA PropertyInfo pattern"
    - "VisibleToPlayers defaults to true for new characters"
  artifacts:
    - path: "Threa.Dal/Dto/Character.cs"
      provides: "NPC flag DTO properties"
      contains: "bool IsNpc"
    - path: "GameMechanics/CharacterEdit.cs"
      provides: "NPC flag business object properties"
      contains: "IsNpcProperty"
  key_links:
    - from: "GameMechanics/CharacterEdit.cs"
      to: "Threa.Dal/Dto/Character.cs"
      via: "Csla.Data.DataMapper.Map automatic property mapping"
      pattern: "DataMapper\\.Map"
---

<objective>
Add NPC and template flags to the Character data model.

Purpose: Enable the existing CharacterEdit model to represent NPCs and templates by adding three boolean flags. This is the foundation for all NPC management features in v1.5.

Output: Character DTO and CharacterEdit business object with IsNpc, IsTemplate, and VisibleToPlayers properties.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-data-model-foundation/23-RESEARCH.md

# Source files to modify
@Threa.Dal/Dto/Character.cs
@GameMechanics/CharacterEdit.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NPC flags to Character DTO</name>
  <files>Threa.Dal/Dto/Character.cs</files>
  <action>
Add three boolean properties to the Character DTO class:

1. `bool IsNpc { get; set; }` - Identifies this character as an NPC (not a player character)
2. `bool IsTemplate { get; set; }` - Identifies this character as a template for spawning instances
3. `bool VisibleToPlayers { get; set; } = true;` - Controls whether players can see this NPC (default: visible)

Add these properties after the existing `IsPlayable` property (line ~13) to group boolean flags together.

The default for VisibleToPlayers is `true` because:
- Existing characters should remain visible (backward compatibility)
- Templates in the GM library should be browsable
- NPCs are hidden explicitly when needed for surprise encounters
  </action>
  <verify>
Build the Threa.Dal project:
```
dotnet build Threa.Dal/Threa.Dal.csproj
```
  </verify>
  <done>Character DTO has IsNpc, IsTemplate, and VisibleToPlayers properties. VisibleToPlayers defaults to true.</done>
</task>

<task type="auto">
  <name>Task 2: Add NPC flags to CharacterEdit business object</name>
  <files>GameMechanics/CharacterEdit.cs</files>
  <action>
Add three CSLA properties to CharacterEdit following the existing PropertyInfo pattern (see IsPlayableProperty around line 355).

Add after IsPlayable property (around line 361):

```csharp
public static readonly PropertyInfo<bool> IsNpcProperty = RegisterProperty<bool>(nameof(IsNpc));
[Display(Name = "Is NPC")]
public bool IsNpc
{
    get => GetProperty(IsNpcProperty);
    set => SetProperty(IsNpcProperty, value);
}

public static readonly PropertyInfo<bool> IsTemplateProperty = RegisterProperty<bool>(nameof(IsTemplate));
[Display(Name = "Is Template")]
public bool IsTemplate
{
    get => GetProperty(IsTemplateProperty);
    set => SetProperty(IsTemplateProperty, value);
}

public static readonly PropertyInfo<bool> VisibleToPlayersProperty = RegisterProperty<bool>(nameof(VisibleToPlayers));
[Display(Name = "Visible to Players")]
public bool VisibleToPlayers
{
    get => GetProperty(VisibleToPlayersProperty);
    set => SetProperty(VisibleToPlayersProperty, value);
}
```

Also update the CreateInternal method (around line 836) to initialize VisibleToPlayers to true:
- Find the CreateInternal method
- After the existing property initializations, add: `VisibleToPlayers = true;`

Note: Use SetProperty (not LoadProperty) because these are user-editable properties that should trigger dirty tracking.
  </action>
  <verify>
Build the GameMechanics project:
```
dotnet build GameMechanics/GameMechanics.csproj
```
  </verify>
  <done>CharacterEdit has IsNpc, IsTemplate, VisibleToPlayers properties with CSLA PropertyInfo pattern. VisibleToPlayers initialized to true in Create.</done>
</task>

</tasks>

<verification>
1. Both projects build without errors
2. Properties follow existing patterns in the codebase
3. VisibleToPlayers defaults to true (verified by examining code)
</verification>

<success_criteria>
- Threa.Dal.csproj builds successfully
- GameMechanics.csproj builds successfully
- Character DTO has 3 new boolean properties
- CharacterEdit has 3 new CSLA properties with PropertyInfo pattern
- VisibleToPlayers defaults to true for backward compatibility
</success_criteria>

<output>
After completion, create `.planning/phases/23-data-model-foundation/23-01-SUMMARY.md`
</output>
