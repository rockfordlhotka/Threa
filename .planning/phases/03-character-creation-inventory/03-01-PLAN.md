---
phase: 03-character-creation-inventory
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Threa/Threa.Client/Components/Pages/Character/TabItems.razor
autonomous: true

must_haves:
  truths:
    - "Player sees split-view layout with item browser on left and inventory on right"
    - "Player can filter item templates by type using dropdown"
    - "Player can search item templates by name with debounced input"
    - "Player can click an item in browser to add one copy to inventory"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/Character/TabItems.razor"
      provides: "Split-view item browser with filter and search"
      contains: "RadzenDataGrid"
  key_links:
    - from: "TabItems.razor"
      to: "IItemTemplateDal"
      via: "GetAllTemplatesAsync for browser data"
      pattern: "itemTemplateDal\\.GetAllTemplatesAsync"
    - from: "TabItems.razor RowSelect"
      to: "ICharacterItemDal.AddItemAsync"
      via: "Click handler creates and saves CharacterItem"
      pattern: "RowSelect.*AddItem"
---

<objective>
Restructure TabItems.razor to use a split-view layout with an item browser on the left side for selecting items during character creation.

Purpose: Players need to browse and select from available item templates when creating their starting inventory. The current dropdown-based approach doesn't scale well with many items.

Output: TabItems.razor enhanced with Bootstrap grid split-view layout, RadzenDataGrid item browser with type filter and debounced search, and single-click to add functionality.
</objective>

<execution_context>
@S:\src\rdl\threa\.claude\get-shit-done\workflows\execute-plan.md
@S:\src\rdl\threa\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@S:\src\rdl\threa\.planning\PROJECT.md
@S:\src\rdl\threa\.planning\ROADMAP.md
@S:\src\rdl\threa\.planning\STATE.md
@S:\src\rdl\threa\.planning\phases\03-character-creation-inventory\03-CONTEXT.md
@S:\src\rdl\threa\.planning\phases\03-character-creation-inventory\03-RESEARCH.md

# Key source files
@S:\src\rdl\threa\Threa\Threa.Client\Components\Pages\Character\TabItems.razor
@S:\src\rdl\threa\Threa\Threa.Client\Components\Pages\GameMaster\Items.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add IDisposable and Split-View Layout Structure</name>
  <files>Threa/Threa.Client/Components/Pages/Character/TabItems.razor</files>
  <action>
Modify TabItems.razor to:

1. Add `@implements IDisposable` directive at the top (after @inject lines)

2. Add debounce timer fields to the @code section:
```csharp
private string searchText = "";
private ItemType? selectedType;
private System.Timers.Timer? debounceTimer;
private const int DebounceMs = 300;
private List<ItemTemplate>? filteredTemplates;
private readonly IEnumerable<ItemType> itemTypes = Enum.GetValues<ItemType>();
```

3. Replace the existing "Add New Item" section (the dropdown and button around lines 200-228) with a split-view Bootstrap grid layout:

```razor
@if (!vm.Model.IsPlayable)
{
    <div class="row">
        @* Left column: Item Browser *@
        <div class="col-md-6">
            <h4>Available Items</h4>
            <div class="d-flex gap-2 mb-3 flex-wrap">
                <RadzenTextBox @bind-Value="@searchText" Placeholder="Search..."
                    @oninput="@((e) => OnSearchInput(e.Value?.ToString() ?? ""))"
                    Style="width: 180px" />
                <RadzenDropDown TValue="ItemType?" Data="@itemTypes"
                    @bind-Value="@selectedType" Change="@(_ => ApplyFilters())"
                    Placeholder="Type" AllowClear="true" Style="width: 140px" />
            </div>

            <RadzenDataGrid Data="@filteredTemplates" TItem="ItemTemplate"
                AllowSorting="true" AllowPaging="true" PageSize="10"
                RowSelect="@AddItemFromBrowser"
                Style="cursor: pointer; max-height: 400px; overflow-y: auto">
                <Columns>
                    <RadzenDataGridColumn TItem="ItemTemplate" Property="Name" Title="Name" Width="180px" />
                    <RadzenDataGridColumn TItem="ItemTemplate" Property="ItemType" Title="Type" Width="100px" />
                    <RadzenDataGridColumn TItem="ItemTemplate" Property="Weight" Title="Wt" Width="60px">
                        <Template Context="t">@t.Weight.ToString("F1")</Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        </div>

        @* Right column: Current Inventory (existing inventory display moves here) *@
        <div class="col-md-6">
            <!-- Existing inventory content will be placed here in Task 2 -->
        </div>
    </div>
}
```

4. Add the debounce and filter methods (copy pattern from Items.razor):
```csharp
private void OnSearchInput(string value)
{
    searchText = value;
    debounceTimer?.Stop();
    debounceTimer?.Dispose();
    debounceTimer = new System.Timers.Timer(DebounceMs);
    debounceTimer.Elapsed += (s, e) =>
    {
        debounceTimer?.Stop();
        InvokeAsync(() => { ApplyFilters(); StateHasChanged(); });
    };
    debounceTimer.Start();
}

private void ApplyFilters()
{
    var query = itemTemplates?.AsEnumerable() ?? Enumerable.Empty<ItemTemplate>();

    if (selectedType.HasValue)
        query = query.Where(i => i.ItemType == selectedType.Value);

    if (!string.IsNullOrWhiteSpace(searchText))
        query = query.Where(i =>
            i.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
            (!string.IsNullOrEmpty(i.ShortDescription) && i.ShortDescription.Contains(searchText, StringComparison.OrdinalIgnoreCase)));

    filteredTemplates = query.ToList();
}
```

5. Add Dispose method:
```csharp
public void Dispose()
{
    debounceTimer?.Stop();
    debounceTimer?.Dispose();
}
```

6. Update LoadItemTemplatesAsync to call ApplyFilters after loading:
```csharp
private async Task LoadItemTemplatesAsync()
{
    try
    {
        itemTemplates = await itemTemplateDal.GetAllTemplatesAsync();
        ApplyFilters();
    }
    catch (Exception ex)
    {
        errorMessage = $"Error loading item templates: {ex.Message}";
    }
}
```

IMPORTANT: Keep the existing Currency section, Equipped Items section, and all helper methods (FormatCurrency, GetEquippedSlotName, GetContainerContents). Only restructure the "Add New Item" section and integrate with the inventory display.
  </action>
  <verify>
- Build succeeds: `dotnet build Threa/Threa.sln`
- No compiler errors related to IDisposable or Timer
  </verify>
  <done>TabItems.razor has split-view layout structure with item browser containing RadzenDataGrid, type filter, and debounced search.</done>
</task>

<task type="auto">
  <name>Task 2: Implement Single-Click Add and Integrate Inventory Display</name>
  <files>Threa/Threa.Client/Components/Pages/Character/TabItems.razor</files>
  <action>
Continue modifying TabItems.razor:

1. Add the AddItemFromBrowser method that replaces AddItemAsync for browser clicks:
```csharp
private async Task AddItemFromBrowser(ItemTemplate template)
{
    if (template == null || vm?.Model == null || vm.Model.Id == 0 || vm.Model.IsPlayable)
        return;

    try
    {
        errorMessage = null;

        var newItem = new CharacterItem
        {
            Id = Guid.NewGuid(),
            ItemTemplateId = template.Id,
            OwnerCharacterId = vm.Model!.Id,
            StackSize = 1,
            CurrentDurability = template.HasDurability ? template.MaxDurability : null,
            CreatedAt = DateTime.UtcNow
        };

        await itemDal.AddItemAsync(newItem);
        await LoadItemsAsync();
        StateHasChanged();
    }
    catch (Exception ex)
    {
        errorMessage = $"Error adding item: {ex.Message}";
    }
}
```

2. Move the existing "Inventory Items" section into the right column of the split view. The right column should contain:
```razor
<div class="col-md-6">
    <h4>Starting Inventory</h4>

    @if (inventoryItems == null || !inventoryItems.Any())
    {
        <p><em>No items in inventory. Click items on the left to add them.</em></p>
    }
    else
    {
        <div class="inventory-items" style="max-height: 400px; overflow-y: auto;">
            @foreach (var item in inventoryItems.OrderBy(i => i.Template?.ItemType).ThenBy(i => i.Template?.Name))
            {
                <div style="margin-bottom: 0.75rem; padding: 0.5rem; border: 1px solid #e9ecef; border-radius: 4px; background-color: #f8f9fa;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="font-weight: bold;">
                            @(item.Template?.Name ?? "Unknown Item")
                            @if (item.StackSize > 1)
                            {
                                <span style="color: #6c757d;"> x@item.StackSize</span>
                            }
                        </div>
                        <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveItemAsync(item.Id)" disabled="@isRemovingItem" title="Remove">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    @if (item.Template != null)
                    {
                        <div style="font-size: 0.85em; color: #6c757d;">
                            @item.Template.ShortDescription
                        </div>
                        <div style="font-size: 0.85em; margin-top: 0.25rem; color: #6c757d;">
                            Weight: @item.Template.Weight lbs | Value: @FormatCurrency(item.Template.Value)
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>
```

3. Add a guard for unsaved characters at the top of the component (after the loading check):
```razor
@if (vm.Model.Id == 0)
{
    <div class="alert alert-info">
        <p><strong>Save your character first</strong> to manage inventory.</p>
        <p><em>After saving, you can browse and add items to your starting inventory.</em></p>
    </div>
    return;
}
```

4. Update the info message for character creation to be more concise:
```razor
@if (!vm.Model.IsPlayable)
{
    <div class="alert alert-info mb-3">
        <strong>Character Creation Mode:</strong> Click items in the browser to add them to your inventory.
    </div>
}
```

5. Remove the old dropdown-based "Add New Item" section entirely (the select element and Add Item button) - it's replaced by the DataGrid browser.

6. Remove the now-unused fields and methods:
   - Remove `selectedItemTemplateId` field
   - Remove `isAddingItem` field
   - Remove the old `AddItemAsync` method (keep the new AddItemFromBrowser)

7. Keep the Equipped Items section OUTSIDE and ABOVE the split view (it shows equipped items for both creation and gameplay modes).
  </action>
  <verify>
- Build succeeds: `dotnet build Threa/Threa.sln`
- Run the app and navigate to Character Edit > Items tab
- Verify split-view layout appears (browser left, inventory right)
- Verify clicking an item in browser adds it to inventory
- Verify type filter and search work
- Verify X button removes items
  </verify>
  <done>Players can browse items in DataGrid, click to add, and see items appear in inventory list on the right. Old dropdown UI removed.</done>
</task>

</tasks>

<verification>
1. Build succeeds without errors
2. Character Edit page Items tab shows split-view layout
3. Item browser shows all templates in DataGrid
4. Type filter dropdown works
5. Search box filters with 300ms debounce
6. Clicking item row adds one copy to inventory
7. Inventory list on right shows added items
8. X button removes items from inventory
9. Unsaved character (Id=0) shows "Save first" message
10. Active character (IsPlayable=true) shows read-only view
</verification>

<success_criteria>
- INV-01: Player can browse available item templates (DataGrid browser)
- INV-02: Player can filter item templates by type (dropdown filter)
- INV-03: Player can search item templates by name (debounced search)
- INV-04: Player can add item to inventory (click row in browser)
- INV-05: Player can remove item (X button in inventory list)
</success_criteria>

<output>
After completion, create `.planning/phases/03-character-creation-inventory/03-01-SUMMARY.md`
</output>
