---
phase: 03-character-creation-inventory
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - Threa/Threa.Client/Components/Pages/Character/TabItems.razor
autonomous: false

must_haves:
  truths:
    - "Player can edit quantity for stackable items inline in inventory list"
    - "Player sees weight calculation with current/max capacity display"
    - "Player sees warning when inventory weight exceeds carrying capacity"
    - "Quantity changes persist immediately"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/Character/TabItems.razor"
      provides: "Inline quantity editing and weight warnings"
      contains: "CalculateCarryingCapacity"
  key_links:
    - from: "TabItems.razor quantity input"
      to: "ICharacterItemDal.UpdateItemAsync"
      via: "OnChange handler updates stack size"
      pattern: "UpdateQuantity.*UpdateItemAsync"
    - from: "TabItems.razor quantity=0"
      to: "ICharacterItemDal.DeleteItemAsync"
      via: "Quantity 0 triggers delete"
      pattern: "DeleteItemAsync"
    - from: "TabItems.razor weight display"
      to: "CharacterEdit.GetAttribute"
      via: "STR attribute for capacity calculation"
      pattern: "GetAttribute.*STR"
---

<objective>
Add inline quantity editing for stackable items and weight capacity display with overweight warnings to TabItems.razor.

Purpose: Players need to adjust quantities of stackable items (like arrows or potions) and see if their starting inventory exceeds their carrying capacity based on STR.

Output: TabItems.razor enhanced with inline quantity inputs for stackable items, weight calculation based on STR (formula: 50 * 1.15^(STR-10)), and warning display when overweight.
</objective>

<execution_context>
@S:\src\rdl\threa\.claude\get-shit-done\workflows\execute-plan.md
@S:\src\rdl\threa\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@S:\src\rdl\threa\.planning\PROJECT.md
@S:\src\rdl\threa\.planning\ROADMAP.md
@S:\src\rdl\threa\.planning\STATE.md
@S:\src\rdl\threa\.planning\phases\03-character-creation-inventory\03-CONTEXT.md
@S:\src\rdl\threa\.planning\phases\03-character-creation-inventory\03-RESEARCH.md
@S:\src\rdl\threa\.planning\phases\03-character-creation-inventory\03-01-SUMMARY.md

# Key source files (after Plan 01 completion)
@S:\src\rdl\threa\Threa\Threa.Client\Components\Pages\Character\TabItems.razor
@S:\src\rdl\threa\design\CARRYING_CAPACITY_ANALYSIS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Weight Calculation and Display</name>
  <files>Threa/Threa.Client/Components/Pages/Character/TabItems.razor</files>
  <action>
Add weight calculation methods and display to TabItems.razor:

1. Add weight calculation methods to the @code section:
```csharp
/// <summary>
/// Calculate carrying capacity based on STR using exponential formula.
/// Formula: 50 lbs * (1.15 ^ (STR - 10))
/// </summary>
private decimal CalculateCarryingCapacity()
{
    // Default to STR 10 if character or attribute not available
    var str = vm?.Model?.GetAttribute("STR") ?? 10;
    return 50m * (decimal)Math.Pow(1.15, str - 10);
}

/// <summary>
/// Calculate total weight of all inventory items (including equipped and container contents).
/// </summary>
private decimal CalculateTotalWeight()
{
    if (allItems == null) return 0;
    return allItems.Sum(i => (i.Template?.Weight ?? 0) * i.StackSize);
}
```

2. Add weight display to the right column, above the inventory list. Insert this right after the `<h4>Starting Inventory</h4>` line:
```razor
@{
    var totalWeight = CalculateTotalWeight();
    var maxWeight = CalculateCarryingCapacity();
    var isOverweight = totalWeight > maxWeight;
}
@if (isOverweight)
{
    <div class="alert alert-warning py-2 mb-2">
        <strong>Over Capacity!</strong> Carrying @totalWeight.ToString("F1") / @maxWeight.ToString("F1") lbs
        <br/><small>This is allowed during character creation, but may affect gameplay.</small>
    </div>
}
else
{
    <div class="text-muted mb-2">
        <strong>Weight:</strong> @totalWeight.ToString("F1") / @maxWeight.ToString("F1") lbs
    </div>
}
```

Note: The GetAttribute method exists on CharacterEdit (see GameMechanics/CharacterEdit.cs line 297). It takes attribute name like "STR" and returns the base attribute value.
  </action>
  <verify>
- Build succeeds: `dotnet build Threa/Threa.sln`
- Weight display appears in inventory section
  </verify>
  <done>Weight calculation and display added with overweight warning based on STR attribute.</done>
</task>

<task type="auto">
  <name>Task 2: Add Inline Quantity Editing for Stackable Items</name>
  <files>Threa/Threa.Client/Components/Pages/Character/TabItems.razor</files>
  <action>
Add inline quantity editing to TabItems.razor:

1. Add UpdateQuantity method to handle quantity changes:
```csharp
private async Task UpdateQuantity(Guid itemId, int newQuantity)
{
    var item = allItems?.FirstOrDefault(i => i.Id == itemId);
    if (item == null || vm?.Model?.IsPlayable == true)
        return;

    var maxStack = item.Template?.MaxStackSize ?? 1;

    try
    {
        errorMessage = null;

        if (newQuantity <= 0)
        {
            // Quantity 0 or less = remove item
            await itemDal.DeleteItemAsync(itemId);
        }
        else
        {
            // Clamp to valid range and update
            item.StackSize = Math.Clamp(newQuantity, 1, maxStack);
            await itemDal.UpdateItemAsync(item);
        }

        await LoadItemsAsync();
        StateHasChanged();
    }
    catch (Exception ex)
    {
        errorMessage = $"Error updating quantity: {ex.Message}";
    }
}
```

2. Modify the inventory item display in the right column to show inline quantity input for stackable items. Replace the stack size display section:

FIND this pattern in the inventory item foreach loop:
```razor
@if (item.StackSize > 1)
{
    <span style="color: #6c757d;"> x@item.StackSize</span>
}
```

REPLACE with:
```razor
@if (item.Template?.IsStackable == true)
{
    <span style="margin-left: 0.5rem;">
        x<input type="number"
               class="form-control form-control-sm d-inline-block"
               style="width: 60px; height: 24px; padding: 0 4px; font-size: 0.85em;"
               min="1"
               max="@(item.Template.MaxStackSize)"
               value="@item.StackSize"
               @onchange="@(e => UpdateQuantity(item.Id, int.Parse(e.Value?.ToString() ?? "1")))" />
    </span>
}
else if (item.StackSize > 1)
{
    <span style="color: #6c757d;"> x@item.StackSize</span>
}
```

3. Also add quantity display to the item browser (left column) so players can see max stack size. Add a column to the RadzenDataGrid:
```razor
<RadzenDataGridColumn TItem="ItemTemplate" Property="MaxStackSize" Title="Stack" Width="60px">
    <Template Context="t">
        @if (t.IsStackable)
        {
            <span>@t.MaxStackSize</span>
        }
        else
        {
            <span>-</span>
        }
    </Template>
</RadzenDataGridColumn>
```

4. Update the inventory item weight display to show total weight for stacks:
Change:
```razor
Weight: @item.Template.Weight lbs
```
To:
```razor
Weight: @((item.Template.Weight * item.StackSize).ToString("F1")) lbs @if(item.StackSize > 1){ <span>(@item.Template.Weight ea)</span> }
```
  </action>
  <verify>
- Build succeeds: `dotnet build Threa/Threa.sln`
- Run the app and add a stackable item (like arrows)
- Verify quantity input appears for stackable items
- Verify changing quantity updates the item
- Verify setting quantity to 0 removes the item
- Verify weight updates when quantity changes
  </verify>
  <done>Inline quantity editing works for stackable items. Quantity changes persist immediately and weight display updates accordingly.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete character creation inventory management:
- Split-view layout with item browser (left) and inventory (right)
- Type filter and debounced search in item browser
- Single-click to add items from browser
- Inline quantity editing for stackable items
- Weight calculation with STR-based carrying capacity
- Overweight warning display
- X button to remove items
  </what-built>
  <how-to-verify>
1. Run the application: `cd Threa/Threa && dotnet run`
2. Navigate to https://localhost:7133
3. Go to Character Edit for an existing character (or create and save a new one)
4. Click the "Items" tab
5. Verify the split-view layout appears:
   - Left side: "Available Items" with search box, type filter, and item grid
   - Right side: "Starting Inventory" with weight display

6. Test item browser:
   - Type in search box - items should filter after brief delay
   - Select a type from dropdown - grid should filter
   - Clear filters - all items should show

7. Test adding items:
   - Click a row in the item browser
   - Item should appear in inventory list on right
   - Weight should update

8. Test quantity editing (use a stackable item like Arrows):
   - Add a stackable item
   - Change the quantity using the inline number input
   - Verify weight updates
   - Set quantity to 0 - item should be removed

9. Test weight warning:
   - Add enough items to exceed carrying capacity
   - Verify orange warning appears showing "Over Capacity!"

10. Test item removal:
    - Click the X button on an inventory item
    - Item should be removed
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Build succeeds without errors
2. Stackable items show inline quantity input
3. Changing quantity persists to database
4. Setting quantity to 0 removes item
5. Weight calculation uses STR attribute correctly
6. Weight display shows current/max format
7. Overweight warning appears when total > capacity
8. Warning allows character creation (not blocking)
</verification>

<success_criteria>
- INV-06: Player can set initial quantity for stackable items (inline input)
- Weight display shows current weight vs STR-based carrying capacity
- Overweight warning appears but does not prevent character creation
- All CONTEXT.md decisions honored (no toast, immediate update, warning not enforced)
</success_criteria>

<output>
After completion, create `.planning/phases/03-character-creation-inventory/03-02-SUMMARY.md`
</output>
