---
phase: 34-new-action-types
plan: 02
type: execute
wave: 2
depends_on: ["34-01"]
files_modified:
  - Threa/Threa.Client/Components/Pages/GamePlay/CombatSkillPickerModal.razor
  - Threa/Threa.Client/Components/Pages/GamePlay/SkillCheckMode.razor
  - Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor
autonomous: true

must_haves:
  truths:
    - "Player clicks Use Skill in the Actions group and sees a modal listing all character skills grouped by governing attribute"
    - "Each skill in the modal shows name and computed AS value (e.g., 'Stealth (AS 12)')"
    - "After selecting a skill, the modal closes and an inline panel opens with the skill pre-selected, showing cost selector, TV input, boost, and roll button"
    - "Player rolls AS + 4dF+ vs TV, sees full breakdown, and result is logged to activity feed"
    - "The skill check does NOT trigger an attack workflow -- it is a standalone roll"
    - "AP/FAT costs are deducted, ActionsTakenThisRound is incremented, and character is saved"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/CombatSkillPickerModal.razor"
      provides: "Modal component for selecting a character skill, grouped by attribute"
      min_lines: 50
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/SkillCheckMode.razor"
      provides: "Skill check inline panel component"
      min_lines: 100
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor"
      provides: "SkillCheck enum value, Use Skill button, mode rendering, completion handler"
      contains: "CombatMode.SkillCheck"
  key_links:
    - from: "TabCombat.razor"
      to: "SkillCheckMode.razor"
      via: "CombatMode.SkillCheck switch branch"
      pattern: "combatMode == CombatMode.SkillCheck"
    - from: "SkillCheckMode.razor"
      to: "CombatSkillPickerModal.razor"
      via: "Radzen DialogService.OpenAsync"
      pattern: "DialogService.OpenAsync<CombatSkillPickerModal>"
    - from: "SkillCheckMode.razor"
      to: "skill.AbilityScore"
      via: "Pre-computed AS from SkillEdit business object"
      pattern: "selectedSkill.AbilityScore"
---

<objective>
Create the Skill Check feature: a modal for picking any character skill (grouped by attribute) and an inline panel for rolling AS + 4dF+ vs player-entered TV. Integrate into the Combat tab's Actions group.

Purpose: Enables combat-context skill checks without leaving the Combat tab (ACT-04 requirement).
Output: CombatSkillPickerModal.razor + SkillCheckMode.razor + TabCombat.razor updates.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-new-action-types/34-CONTEXT.md
@.planning/phases/34-new-action-types/34-RESEARCH.md
@.planning/phases/34-new-action-types/34-01-SUMMARY.md
@Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor
@Threa/Threa.Client/Components/Pages/GamePlay/AnonymousActionMode.razor
@Threa/Threa.Client/Components/Pages/GamePlay/MedicalMode.razor
@Threa/Threa.Client/Components/Pages/GamePlay/TabPlaySkills.razor
@Threa/Threa.Client/Components/Shared/ActionCostSelector.razor
@Threa/Threa.Client/Components/Shared/BoostSelector.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CombatSkillPickerModal and SkillCheckMode components</name>
  <files>
    Threa/Threa.Client/Components/Pages/GamePlay/CombatSkillPickerModal.razor
    Threa/Threa.Client/Components/Pages/GamePlay/SkillCheckMode.razor
  </files>
  <action>
Create two new Razor components:

## CombatSkillPickerModal.razor

A modal component opened via Radzen's `DialogService.OpenAsync`. Shows ALL character skills grouped by governing attribute.

**Parameter:**
- `Character` (GameMechanics.CharacterEdit) - used to access `Character.Skills`

**Layout:**
- Optional search/filter input at top (text filter on skill name)
- Skills grouped by `skill.PrimaryAttribute` (e.g., "STR", "DEX", etc.)
- Each group has a header showing the attribute name
- Each skill row shows: skill name + "(AS {skill.AbilityScore})" - use the computed `AbilityScore` property from `SkillEdit` which already includes all modifiers
- Clicking a skill calls `DialogService.Close(skill)` to return the `SkillEdit` object to the caller
- Cancel button calls `DialogService.Close()` with no argument

**Grouping logic** (from 34-RESEARCH.md Example 5):
```csharp
private IEnumerable<IGrouping<string, GameMechanics.SkillEdit>> GetGroupedSkills()
{
    var skills = Character?.Skills?.AsEnumerable() ?? Enumerable.Empty<GameMechanics.SkillEdit>();
    if (!string.IsNullOrWhiteSpace(searchFilter))
        skills = skills.Where(s => s.Name.Contains(searchFilter, StringComparison.OrdinalIgnoreCase));
    return skills
        .OrderBy(s => s.PrimaryAttribute)
        .ThenBy(s => s.Name)
        .GroupBy(s => s.PrimaryAttribute);
}
```

**Using directives:**
```
@inject Radzen.DialogService DialogService
```

**Style:** Use Bootstrap list-group for skill items, card headers for attribute groups. Compact layout since it will be in a 500x600px dialog.

## SkillCheckMode.razor

An inline panel component following the exact same pattern as AnonymousActionMode.razor (created in 34-01), with these differences:

**Parameters:**
- `Character` (GameMechanics.CharacterEdit?)
- `Table` (GameMechanics.GamePlay.TableEdit?)
- `OnCancel` (EventCallback)
- `OnSkillCheckComplete` (EventCallback&lt;string&gt;)

**Flow:**
1. On initialization, immediately open the skill picker modal via `DialogService.OpenAsync<CombatSkillPickerModal>` with width "500px", height "600px", and pass `Character`.
2. If user cancels the modal (result is null), call `OnCancel.InvokeAsync()` to return to default.
3. If user selects a skill (result is SkillEdit), store as `selectedSkill` and show the inline panel.

**Setup phase (left column) - shown after skill selection:**
1. **Selected Skill** (card): Display skill name, AS, governing attribute. Include a "Change Skill" button that re-opens the modal.
2. **Action Cost** (card): `<ActionCostSelector>` (same as AnonymousActionMode).
3. **Target Value** (card): `<input type="number">` bound to `targetValue`.
4. **Boost** (card): `<BoostSelector>` (same as AnonymousActionMode).

**Setup phase (right column):**
- Summary card showing: Skill Name, AS (from `selectedSkill.AbilityScore`), TV, Cost, Boost.
- "Roll Check" button in footer, disabled when `!CanRoll()`.

**Roll execution (async Task ExecuteSkillCheck):**
1. Concentration check (same pattern as AnonymousActionMode).
2. End parry mode if active.
3. Deduct costs (same pattern: base + boost).
4. Roll: `int baseAS = selectedSkill.AbilityScore; int effectiveAS = baseAS + boostValue; int diceRoll = GameMechanics.Dice.Roll4dFPlus(); int totalRoll = effectiveAS + diceRoll; int sv = totalRoll - targetValue;`
   - IMPORTANT: Use `selectedSkill.AbilityScore` directly - it already includes attribute value, skill level, -5 offset, item bonuses, effect modifiers, and fatigue penalty. Do NOT recalculate AS manually.
   - Wounds: `int woundCount = Character.Effects.Count(e => e.EffectType == EffectType.Wound); effectiveAS -= woundCount * 2;`
   - Multi-action penalty: `if (Character.ActionPoints.ActionsTakenThisRound > 1) effectiveAS -= (Character.ActionPoints.ActionsTakenThisRound - 1) * 2;`
   - Apply penalties BEFORE calculating totalRoll.
5. Save character.
6. Set `hasRolled = true`.

**Result phase:**
- Success/failure card (same style as AnonymousActionMode).
- Breakdown table: Skill Name, Base AS, Boost (+N), Wounds (-N), Multi-Action Penalty (-N), Effective AS, Dice Roll, Total Roll, TV, SV.
- Done button invokes `OnSkillCheckComplete.InvokeAsync(resultMessage)`.
- Message format per CONTEXT.md: `"{Character.Name}: {selectedSkill.Name} AS {effectiveAS} + 4dF+ ({diceRoll formatted}) = {totalRoll} vs TV {targetValue} -> SV {sv formatted}"`

**Using directives:**
```
@using GameMechanics.Effects.Behaviors
@using Threa.Dal.Dto
@using Threa.Client.Components.Shared
@inject Radzen.DialogService DialogService
```

**Modal opening pattern** (call in OnInitializedAsync or OnAfterRenderAsync with firstRender guard):
Use `OnAfterRenderAsync` with a `firstRender` check to open the modal after the component renders. This avoids lifecycle issues with Radzen dialogs. Store a `bool modalOpened` flag.

```csharp
protected override async Task OnAfterRenderAsync(bool firstRender)
{
    if (firstRender && !modalOpened)
    {
        modalOpened = true;
        await OpenSkillPicker();
        StateHasChanged();
    }
}
```
  </action>
  <verify>
`dotnet build Threa/Threa.Client/Threa.Client.csproj` compiles without errors. Both files exist. Grep for `DialogService.OpenAsync<CombatSkillPickerModal>` in SkillCheckMode.razor returns a match. Grep for `DialogService.Close` in CombatSkillPickerModal.razor returns a match.
  </verify>
  <done>
CombatSkillPickerModal.razor shows all character skills grouped by PrimaryAttribute with AS values, returns selected SkillEdit via DialogService.Close. SkillCheckMode.razor opens the modal on first render, shows inline panel after skill selection with cost selector, TV input, boost selector, and roll button. Uses skill.AbilityScore for AS, handles concentration, parry mode, costs, wounds, multi-action penalty, save, and formatted result message.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate SkillCheckMode into TabCombat</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor</files>
  <action>
Modify TabCombat.razor to wire up the Skill Check mode. Plan 34-01 already added `AnonymousAction` to the enum and integrated its button/mode/handler.

1. **Add enum value:** In the `CombatMode` enum, add `SkillCheck` after `AnonymousAction`:
   `..., ActivateImplant, AnonymousAction, SkillCheck`

2. **Add button to Actions group:** After the "Action" button (added by 34-01), add:
   ```razor
   <button class="btn combat-tile combat-tile-actions"
           @onclick="StartSkillCheck"
           disabled="@(!CanAct())"
           title="Skill check from any skill">
       <i class="bi bi-journal-check"></i>
       <span>Use Skill</span>
   </button>
   ```

3. **Add mode rendering:** After the `AnonymousAction` else-if block (added by 34-01), add:
   ```razor
   else if (combatMode == CombatMode.SkillCheck)
   {
       <SkillCheckMode Character="Character"
                        Table="Table"
                        OnCancel="ReturnToDefault"
                        OnSkillCheckComplete="OnSkillCheckComplete" />
   }
   ```

4. **Add StartSkillCheck method:**
   ```csharp
   private void StartSkillCheck()
   {
       // Skill checks end parry mode
       if (Character != null && CombatStanceBehavior.IsInParryMode(Character))
       {
           CombatStanceBehavior.EndParryMode(Character);
       }
       combatMode = CombatMode.SkillCheck;
   }
   ```

5. **Add completion handler:**
   ```csharp
   private async Task OnSkillCheckComplete(string resultMessage)
   {
       LogActivity(resultMessage, ActivityCategory.Combat);
       combatMode = CombatMode.Default;
       if (OnCharacterChanged.HasDelegate)
       {
           await OnCharacterChanged.InvokeAsync();
       }
       await InvokeAsync(StateHasChanged);
   }
   ```
  </action>
  <verify>
`dotnet build Threa.sln` compiles without errors. Grep for `CombatMode.SkillCheck` in TabCombat.razor returns matches. Grep for `StartSkillCheck` returns a match. Grep for `OnSkillCheckComplete` returns a match.
  </verify>
  <done>
TabCombat.razor has SkillCheck in the CombatMode enum, a "Use Skill" button tile in the Actions group, mode rendering that instantiates SkillCheckMode with correct parameters, a StartSkillCheck method that ends parry mode and sets the mode, and an OnSkillCheckComplete handler that logs to activity feed, returns to default, and notifies parent of character changes.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Threa.sln` compiles without errors
2. CombatSkillPickerModal.razor exists and groups skills by PrimaryAttribute
3. SkillCheckMode.razor exists with modal-first flow, then inline panel
4. TabCombat.razor has SkillCheck in CombatMode enum
5. TabCombat.razor has "Use Skill" button in Actions group
6. TabCombat.razor renders SkillCheckMode when in SkillCheck mode
7. SkillCheckMode uses skill.AbilityScore (pre-computed with modifiers) for AS
8. SkillCheckMode does NOT trigger attack workflow - purely standalone roll
9. SkillCheckMode deducts costs, increments ActionsTakenThisRound, saves character
10. Result message follows CONTEXT.md format
</verification>

<success_criteria>
- Player can click "Use Skill" to see a modal listing all skills grouped by attribute with AS values
- Player can search/filter skills in the modal
- Selecting a skill closes the modal and opens an inline panel with the skill pre-selected
- Player can enter TV, choose cost, boost, and roll
- Result displays with full breakdown showing skill-based AS + dice vs TV
- Cost is deducted and character is saved
- Result is logged to the activity feed
- The skill check is a standalone roll, not an attack
</success_criteria>

<output>
After completion, create `.planning/phases/34-new-action-types/34-02-SUMMARY.md`
</output>
