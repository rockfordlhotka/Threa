---
phase: 34-new-action-types
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Threa/Threa.Client/Components/Pages/GamePlay/AnonymousActionMode.razor
  - Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor
autonomous: true

must_haves:
  truths:
    - "Player clicks Action button in Actions group and sees an inline panel with attribute dropdown, cost selector, TV input, boost selector, and roll button"
    - "Player selects an attribute, enters a TV, rolls, and sees the result with full breakdown (attribute value + dice roll = total vs TV -> SV)"
    - "AP/FAT costs are deducted, ActionsTakenThisRound is incremented, and character is saved after rolling"
    - "Result is logged to the activity feed with the format from CONTEXT.md"
    - "Player can dismiss the result and return to the default Combat tab view"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/AnonymousActionMode.razor"
      provides: "Anonymous action inline panel component"
      min_lines: 100
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor"
      provides: "AnonymousAction enum value, Action button, mode rendering, completion handler"
      contains: "CombatMode.AnonymousAction"
  key_links:
    - from: "TabCombat.razor"
      to: "AnonymousActionMode.razor"
      via: "CombatMode.AnonymousAction switch branch"
      pattern: "combatMode == CombatMode.AnonymousAction"
    - from: "AnonymousActionMode.razor"
      to: "Character.GetEffectiveAttribute"
      via: "Attribute value lookup for roll"
      pattern: "GetEffectiveAttribute"
    - from: "TabCombat.razor"
      to: "ActivityLog.Publish"
      via: "OnAnonymousActionComplete handler"
      pattern: "OnAnonymousActionComplete"
---

<objective>
Create the Anonymous Action inline panel component and integrate it into the Combat tab's Actions group. Player can select an attribute, choose a cost, enter a TV, optionally boost, roll 4dF+, and see the result.

Purpose: Enables attribute-only rolls against a target value during combat (ACT-03 requirement).
Output: AnonymousActionMode.razor component + TabCombat.razor updates (enum, button, mode rendering, handler).
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-new-action-types/34-CONTEXT.md
@.planning/phases/34-new-action-types/34-RESEARCH.md
@Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor
@Threa/Threa.Client/Components/Pages/GamePlay/MedicalMode.razor
@Threa/Threa.Client/Components/Pages/GamePlay/TabPlaySkills.razor
@Threa/Threa.Client/Components/Shared/ActionCostSelector.razor
@Threa/Threa.Client/Components/Shared/BoostSelector.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AnonymousActionMode.razor component</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/AnonymousActionMode.razor</files>
  <action>
Create a new Razor component `AnonymousActionMode.razor` in the GamePlay folder following the exact pattern of MedicalMode.razor (same header, two-column layout, setup/result phases, cost/save patterns). Key requirements:

**Parameters (same as other modes):**
- `Character` (GameMechanics.CharacterEdit?)
- `Table` (GameMechanics.GamePlay.TableEdit?)
- `OnCancel` (EventCallback)
- `OnActionComplete` (EventCallback&lt;string&gt;) - passes result message to parent for activity logging

**Setup phase (left column):**
1. **Attribute dropdown** (card): `<select>` with all 7 attributes. Display as "Physicality (STR)", "Dodge (DEX)", "Drive (END)", "Reasoning (INT)", "Awareness (ITT)", "Focus (WIL)", "Influence (PHY)". Use a static `Dictionary<string, string>` for display names (see 34-RESEARCH.md Example 2).
2. **Action Cost** (card): `<ActionCostSelector>` passing `AP="Character.ActionPoints.Available"` and `Fat="Character.Fatigue.Value"`.
3. **Target Value** (card): `<input type="number">` bound to `targetValue`, min="1".
4. **Boost** (card): `<BoostSelector>` with `AvailableAP` and `AvailableFAT` calculated after base cost deduction (same pattern as TabPlaySkills.razor lines 346-355: subtract base cost from available, pass remainder).

**Setup phase (right column):**
- Summary card showing: Selected Attribute, Attribute Value (from `Character.GetEffectiveAttribute(selectedAttribute)`), TV, Cost display, Boost amount.
- Footer: "Roll Check" button, disabled when `!CanRoll()`.

**CanRoll() logic:**
- Character not null, not passed out
- Attribute selected
- TV > 0
- AP and FAT sufficient for base cost + boost cost

**Roll execution (async Task ExecuteAction):**
1. Check concentration (exact pattern from MedicalMode.razor lines 499-516: get concentration effect, show break dialog, break if confirmed, return if cancelled).
2. End parry mode if active: `if (CombatStanceBehavior.IsInParryMode(Character)) CombatStanceBehavior.EndParryMode(Character);`
3. Deduct costs: `var apCost = costType == ActionCostType.TwoAP ? 2 : 1; var fatCost = costType == ActionCostType.OneAPOneFat ? 1 : 0; Character.ActionPoints.Available -= (apCost + boostAPCost); Character.ActionPoints.ActionsTakenThisRound += 1; if ((fatCost + boostFATCost) > 0) Character.Fatigue.Value -= (fatCost + boostFATCost);`
4. Calculate effective value with penalties, then roll:
   ```csharp
   int attributeValue = Character.GetEffectiveAttribute(selectedAttribute);
   // IMPORTANT: Anonymous actions use RAW attribute value, NOT the AS formula
   // (no skill level, no -5).
   int effectiveValue = attributeValue + boostValue;
   // Apply wound penalty BEFORE rolling
   int woundCount = Character.Effects.Count(e => e.EffectType == EffectType.Wound);
   effectiveValue -= woundCount * 2;
   // Apply multi-action penalty BEFORE rolling (ActionsTakenThisRound already incremented)
   if (Character.ActionPoints.ActionsTakenThisRound > 1)
       effectiveValue -= (Character.ActionPoints.ActionsTakenThisRound - 1) * 2;
   // NOW roll and calculate result
   int diceRoll = GameMechanics.Dice.Roll4dFPlus();
   int totalRoll = effectiveValue + diceRoll;
   int sv = totalRoll - targetValue;
   ```
5. Set `hasRolled = true`, store result fields.
6. Save: `if (Character is Csla.Core.ISavable savable) await savable.SaveAsync();`

**Result phase:**
- Card with success/failure header (green/red based on sv >= 0).
- Table showing: Attribute, Attribute Value, Boost (+N if any), Wounds (-N if any), Multi-Action Penalty (-N if any), Effective Value, Dice Roll (formatted +N/-N), Total Roll, Target Value, Success Value.
- Done button calls `OnActionComplete.InvokeAsync(resultMessage)` with message format per CONTEXT.md: `"{Character.Name}: {AttributeDisplayName} {effectiveValue} + 4dF+ ({diceRoll formatted}) = {totalRoll} vs TV {targetValue} -> SV {sv formatted}"`

**Using directives:**
```
@using GameMechanics.Effects.Behaviors
@using Threa.Dal.Dto
@using Threa.Client.Components.Shared
@inject Radzen.DialogService DialogService
```

**Code conventions:** 2-space indentation, braces on new line, PascalCase methods, camelCase locals, no `this.` prefix.
  </action>
  <verify>
`dotnet build Threa/Threa.Client/Threa.Client.csproj` compiles without errors. File exists at `Threa/Threa.Client/Components/Pages/GamePlay/AnonymousActionMode.razor`.
  </verify>
  <done>
AnonymousActionMode.razor exists with setup phase (attribute dropdown, cost selector, TV input, boost selector, summary card, roll button) and result phase (full breakdown table, done button). Uses GetEffectiveAttribute for attribute value, handles concentration break, parry mode end, cost deduction with ActionsTakenThisRound increment, wound penalty, multi-action penalty, save, and formatted result message.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate AnonymousActionMode into TabCombat</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor</files>
  <action>
Modify TabCombat.razor to wire up the new Anonymous Action mode:

1. **Add enum value:** In the `CombatMode` enum (line 401), add `AnonymousAction` after `ActivateImplant`:
   `Default, Attack, Defend, TakeDamage, RangedAttack, Reload, Unload, Medical, SelectTarget, ActivateImplant, AnonymousAction`

2. **Add button to Actions group:** In the Actions group card (after the Ranged Target button, around line 175), add:
   ```razor
   <button class="btn combat-tile combat-tile-actions"
           @onclick="StartAnonymousAction"
           disabled="@(!CanAct())"
           title="Attribute-only roll vs TV (1 AP + 1 FAT)">
       <i class="bi bi-dice-5"></i>
       <span>Action</span>
   </button>
   ```

3. **Add mode rendering:** After the `ActivateImplant` else-if block (around line 352), add:
   ```razor
   else if (combatMode == CombatMode.AnonymousAction)
   {
       <AnonymousActionMode Character="Character"
                             Table="Table"
                             OnCancel="ReturnToDefault"
                             OnActionComplete="OnAnonymousActionComplete" />
   }
   ```

4. **Add StartAnonymousAction method** (in the @code block, near the other Start* methods):
   ```csharp
   private void StartAnonymousAction()
   {
       // Anonymous actions end parry mode
       if (Character != null && CombatStanceBehavior.IsInParryMode(Character))
       {
           CombatStanceBehavior.EndParryMode(Character);
       }
       combatMode = CombatMode.AnonymousAction;
   }
   ```

5. **Add completion handler** (near the other On*Complete methods):
   ```csharp
   private async Task OnAnonymousActionComplete(string resultMessage)
   {
       LogActivity(resultMessage, ActivityCategory.Combat);
       combatMode = CombatMode.Default;
       if (OnCharacterChanged.HasDelegate)
       {
           await OnCharacterChanged.InvokeAsync();
       }
       await InvokeAsync(StateHasChanged);
   }
   ```
  </action>
  <verify>
`dotnet build Threa/Threa.Client/Threa.Client.csproj` compiles without errors. Grep for `CombatMode.AnonymousAction` in TabCombat.razor returns matches. Grep for `StartAnonymousAction` returns a match. Grep for `OnAnonymousActionComplete` returns a match.
  </verify>
  <done>
TabCombat.razor has AnonymousAction in the CombatMode enum, an "Action" button tile in the Actions group, mode rendering that instantiates AnonymousActionMode with correct parameters, a StartAnonymousAction method that ends parry mode and sets the mode, and an OnAnonymousActionComplete handler that logs to activity feed, returns to default, and notifies parent of character changes.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Threa.sln` compiles without errors
2. AnonymousActionMode.razor exists with correct structure (setup + result phases)
3. TabCombat.razor has AnonymousAction in CombatMode enum
4. TabCombat.razor has "Action" button tile in Actions group
5. TabCombat.razor renders AnonymousActionMode when in AnonymousAction mode
6. AnonymousActionMode uses GetEffectiveAttribute (not AS formula) for attribute value
7. AnonymousActionMode deducts costs, increments ActionsTakenThisRound, saves character
8. AnonymousActionMode checks concentration before rolling
9. AnonymousActionMode handles boost via BoostSelector
10. Result message follows CONTEXT.md format
</verification>

<success_criteria>
- Player can click "Action" in the Actions group to enter the anonymous action inline panel
- Player can select an attribute, choose cost type, enter TV, optionally boost, and roll
- Result displays with full breakdown and SV determination
- Cost is deducted and character is saved
- Result is logged to the activity feed
- Player can dismiss result and return to Combat tab default
</success_criteria>

<output>
After completion, create `.planning/phases/34-new-action-types/34-01-SUMMARY.md`
</output>
