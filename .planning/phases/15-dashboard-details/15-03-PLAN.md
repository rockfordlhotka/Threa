---
phase: 15-dashboard-details
plan: 03
type: execute
wave: 3
depends_on: ["15-01", "15-02"]
files_modified:
  - Threa/Threa.Client/Components/Shared/CharacterDetailModal.razor
  - Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
  - Threa/Threa.Client/Components/Shared/NpcPlaceholder.razor
autonomous: false

must_haves:
  truths:
    - "Modal content updates automatically when character state changes"
    - "GM sees updated health/effects in modal without closing and reopening"
    - "Dashboard has collapsible NPC section at bottom of left panel"
    - "NPC section is labeled and indicates future functionality"
  artifacts:
    - path: "Threa/Threa.Client/Components/Shared/NpcPlaceholder.razor"
      provides: "Collapsible NPC placeholder section"
      min_lines: 20
  key_links:
    - from: "CharacterDetailModal.razor"
      to: "ITimeEventSubscriber.CharacterUpdateReceived"
      via: "Event subscription refreshing character data"
      pattern: "CharacterUpdateReceived.*OnCharacterUpdate"
    - from: "GmTable.razor"
      to: "NpcPlaceholder.razor"
      via: "Component inclusion in left panel"
      pattern: "<NpcPlaceholder"
---

<objective>
Add real-time update capability to the detail modal and create the NPC placeholder section for the dashboard.

Purpose: Ensures GMs always see current character state even while detail modal is open, and sets expectation for future NPC functionality.
Output: Live-updating modal content and clearly labeled NPC placeholder section.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-dashboard-details/15-CONTEXT.md
@.planning/phases/15-dashboard-details/15-RESEARCH.md
@.planning/phases/15-dashboard-details/15-01-SUMMARY.md
@.planning/phases/15-dashboard-details/15-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add real-time updates to CharacterDetailModal</name>
  <files>
    - Threa/Threa.Client/Components/Shared/CharacterDetailModal.razor
  </files>
  <action>
    Update CharacterDetailModal to subscribe to CharacterUpdateMessage and refresh data when the currently viewed character changes.

    1. **Add IAsyncDisposable implementation:**
       ```csharp
       @implements IAsyncDisposable
       ```

    2. **Add injection:**
       ```csharp
       @inject ITimeEventSubscriber TimeEventSubscriber
       ```

    3. **Add subscription state:**
       ```csharp
       private bool subscribed;
       ```

    4. **Subscribe in OnInitializedAsync:**
       ```csharp
       protected override async Task OnInitializedAsync()
       {
           // ... existing character load logic ...

           // Subscribe to real-time updates
           await SubscribeToUpdatesAsync();
       }

       private async Task SubscribeToUpdatesAsync()
       {
           if (subscribed) return;

           await TimeEventSubscriber.ConnectAsync();
           await TimeEventSubscriber.SubscribeAsync();
           TimeEventSubscriber.CharacterUpdateReceived += OnCharacterUpdateReceived;
           subscribed = true;
       }
       ```

    5. **Handle character updates:**
       ```csharp
       private void OnCharacterUpdateReceived(object? sender, CharacterUpdateMessage e)
       {
           // Only refresh if the updated character is the one we're viewing
           if (e.CharacterId != selectedCharacterId) return;

           InvokeAsync(async () =>
           {
               // Refresh character data
               isLoading = true;
               StateHasChanged();

               try
               {
                   character = await characterPortal.FetchAsync(selectedCharacterId);
               }
               finally
               {
                   isLoading = false;
                   StateHasChanged();
               }
           });
       }
       ```

    6. **Implement DisposeAsync:**
       ```csharp
       public async ValueTask DisposeAsync()
       {
           if (subscribed)
           {
               TimeEventSubscriber.CharacterUpdateReceived -= OnCharacterUpdateReceived;
               await TimeEventSubscriber.UnsubscribeAsync();
               subscribed = false;
           }
       }
       ```

    7. **Add using for messaging:**
       ```csharp
       @using GameMechanics.Messaging
       ```

    Note: The update is silent (no visual indicator) per CONTEXT.md - values just change seamlessly.

    Important: Use the same pattern as GmTable.razor for subscription management. Check the existing OnCharacterUpdateReceived handler in GmTable for reference.
  </action>
  <verify>
    - Build succeeds: `dotnet build Threa.sln`
    - Open modal for a character
    - In another browser/tab (or via GM dashboard actions), apply damage to that character
    - Modal should refresh and show updated health values
  </verify>
  <done>
    CharacterDetailModal subscribes to CharacterUpdateMessage and refreshes when viewed character is updated
  </done>
</task>

<task type="auto">
  <name>Task 2: Create NpcPlaceholder component and integrate into dashboard</name>
  <files>
    - Threa/Threa.Client/Components/Shared/NpcPlaceholder.razor
    - Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
  </files>
  <action>
    **Part A: Create NpcPlaceholder.razor**

    Create new file in Components/Shared:

    ```html
    @* Placeholder section for future NPC functionality *@

    <div class="card mt-3">
        <div class="card-header d-flex justify-content-between align-items-center"
             style="cursor: pointer;"
             @onclick="ToggleExpanded">
            <strong><i class="bi bi-people me-1"></i>NPCs</strong>
            <i class="bi @(isExpanded ? "bi-chevron-up" : "bi-chevron-down")"></i>
        </div>

        @if (isExpanded)
        {
            <div class="card-body text-center">
                <div class="py-4">
                    <i class="bi bi-person-badge fs-1 text-muted opacity-50"></i>
                    <p class="mt-3 mb-2 text-muted">
                        <strong>NPC Management</strong>
                    </p>
                    <p class="small text-muted mb-0">
                        Coming in a future update. NPCs will appear here with quick stat blocks for combat encounters.
                    </p>
                </div>

                <!-- Visual mockup hint -->
                <div class="border rounded p-2 bg-light mt-3" style="opacity: 0.5;">
                    <div class="d-flex align-items-center gap-2 small text-muted">
                        <div class="bg-secondary rounded" style="width: 40px; height: 40px;"></div>
                        <div class="flex-grow-1 text-start">
                            <div class="bg-secondary rounded" style="height: 12px; width: 60%;"></div>
                            <div class="bg-secondary rounded mt-1" style="height: 8px; width: 40%;"></div>
                        </div>
                    </div>
                </div>
                <small class="text-muted">Example NPC card layout</small>
            </div>
        }
    </div>

    @code {
        private bool isExpanded = false;

        private void ToggleExpanded()
        {
            isExpanded = !isExpanded;
        }
    }
    ```

    **Part B: Replace existing NPC panel in GmTable.razor**

    1. Find the existing NPCs panel (around line 188-210 based on earlier read):
       ```html
       <!-- NPCs Panel -->
       <div class="card">
           <div class="card-header d-flex justify-content-between align-items-center">
               <strong>NPCs</strong>
               <button class="btn btn-sm btn-outline-primary" @onclick="AddNpc">+ Add NPC</button>
           </div>
           ...
       </div>
       ```

    2. Replace the entire NPCs panel with:
       ```html
       <!-- NPC Placeholder -->
       <NpcPlaceholder />
       ```

    3. Remove the following if they exist and are no longer needed:
       - `AddNpc` method
       - `RemoveNpc` method
       - `npcs` collection (if only used for the old NPC panel)

       Note: Keep any NPC-related code if it's used elsewhere. Only remove if the NPC panel was the sole consumer.

    4. Add using if needed:
       ```csharp
       @using Threa.Client.Components.Shared
       ```
  </action>
  <verify>
    - Build succeeds: `dotnet build Threa.sln`
    - Navigate to GM dashboard
    - See "NPCs" collapsible section in left panel
    - Click header to expand - see placeholder message and mockup
    - Click again to collapse
  </verify>
  <done>
    NpcPlaceholder component created and integrated into GmTable, replacing old NPC panel
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 15 Dashboard Details implementation:
    1. CharacterDetailModal opens when clicking character cards
    2. Three tabs: Character Sheet, Inventory, Narrative
    3. Character switcher dropdown in modal header
    4. GM notes (private, per-character) in Narrative tab
    5. Real-time updates to modal when character state changes
    6. NPC placeholder section (collapsible) on dashboard
  </what-built>
  <how-to-verify>
    1. Navigate to a GM table with at least one active character
    2. Click a character card - modal should open
    3. Verify tabs:
       - Character Sheet: Shows portrait, health bars, attributes (7), skills
       - Inventory: Shows equipped items by slot, carried items, currency
       - Narrative: Shows appearance, backstory, GM notes textarea
    4. In Narrative tab, type GM notes and click elsewhere - notes should save
    5. Close and reopen modal - GM notes should persist
    6. Use character switcher dropdown - content should update
    7. With modal open, apply damage to character via GM dashboard quick actions
       - Modal should refresh automatically showing new health values
    8. Close modal, find NPC section in left panel
    9. Click NPC header - should expand showing placeholder message
    10. Click again - should collapse
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues for follow-up fixes</resume-signal>
</task>

</tasks>

<verification>
After all tasks:
1. `dotnet build Threa.sln` succeeds
2. Character cards open detail modal on click
3. All three tabs functional with real character data
4. GM notes save and persist
5. Character switcher works
6. Real-time updates work (apply damage, modal refreshes)
7. NPC placeholder visible and collapsible
8. No console errors during modal open/close/switch
</verification>

<success_criteria>
- DASH-08: GM can click character card to view detailed character information - DONE
- DASH-09: Detailed view displays character sheet (attributes, skills, levels) - DONE
- DASH-10: Detailed view displays character inventory and equipped items - DONE
- DASH-11: Detailed view displays character narrative (appearance, backstory) - DONE
- DASH-12: Dashboard automatically updates when character state changes - DONE
- DASH-13: Dashboard includes placeholder for NPCs (labeled for future implementation) - DONE
</success_criteria>

<output>
After completion, create `.planning/phases/15-dashboard-details/15-03-SUMMARY.md`
</output>
