---
phase: 15-dashboard-details
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - Threa/Threa.Client/Components/Shared/CharacterDetailSheet.razor
  - Threa/Threa.Client/Components/Shared/CharacterDetailInventory.razor
  - Threa/Threa.Client/Components/Shared/CharacterDetailNarrative.razor
  - Threa/Threa.Client/Components/Shared/CharacterDetailModal.razor
autonomous: true

must_haves:
  truths:
    - "Character Sheet tab displays all 7 attributes with values"
    - "Character Sheet tab displays skills organized by attribute"
    - "Inventory tab shows equipped items in slot categories"
    - "Inventory tab shows carried items in grid"
    - "Narrative tab shows appearance fields (skin, hair, height, weight)"
    - "Narrative tab shows backstory/description"
    - "Narrative tab has editable GM notes textarea"
    - "GM notes persist when modal closes"
  artifacts:
    - path: "Threa/Threa.Client/Components/Shared/CharacterDetailSheet.razor"
      provides: "Read-only character sheet display"
      min_lines: 60
    - path: "Threa/Threa.Client/Components/Shared/CharacterDetailInventory.razor"
      provides: "Read-only inventory and equipment display"
      min_lines: 80
    - path: "Threa/Threa.Client/Components/Shared/CharacterDetailNarrative.razor"
      provides: "Narrative info plus editable GM notes"
      min_lines: 50
  key_links:
    - from: "CharacterDetailModal.razor"
      to: "CharacterDetailSheet.razor"
      via: "Conditional render in tab content"
      pattern: "<CharacterDetailSheet"
    - from: "CharacterDetailModal.razor"
      to: "CharacterDetailInventory.razor"
      via: "Conditional render in tab content"
      pattern: "<CharacterDetailInventory"
    - from: "CharacterDetailModal.razor"
      to: "CharacterDetailNarrative.razor"
      via: "Conditional render in tab content"
      pattern: "<CharacterDetailNarrative"
    - from: "CharacterDetailNarrative.razor"
      to: "ITableDal.UpdateGmNotesAsync"
      via: "Blur or debounced save"
      pattern: "UpdateGmNotesAsync"
    - from: "CharacterDetailModal.razor"
      to: "TableCharacterInfo.GmNotes"
      via: "Load initial GM notes from AllCharacters collection"
      pattern: "tc\\.GmNotes|AllCharacters.*GmNotes"
---

<objective>
Create the three tab content components that populate the CharacterDetailModal: Character Sheet (attributes, skills), Inventory (equipped and carried items), and Narrative (appearance, backstory, GM notes).

Purpose: Provides comprehensive read-only character inspection for GMs, plus private GM notes functionality.
Output: Fully functional tabs showing all character data relevant to GM oversight.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-dashboard-details/15-CONTEXT.md
@.planning/phases/15-dashboard-details/15-RESEARCH.md
@.planning/phases/15-dashboard-details/15-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CharacterDetailSheet component</name>
  <files>
    - Threa/Threa.Client/Components/Shared/CharacterDetailSheet.razor
  </files>
  <action>
    Create new file `CharacterDetailSheet.razor` in Components/Shared:

    1. **Parameters:**
       ```csharp
       [Parameter] public CharacterEdit Character { get; set; } = null!;
       ```

    2. **Layout Structure** (mirror TabStatus.razor pattern but read-only):
       ```html
       <div class="row">
         <!-- Left Column: Portrait and Basic Info -->
         <div class="col-md-4">
           <div class="card">
             <div class="card-body text-center">
               @if (!string.IsNullOrEmpty(Character.ImageUrl))
               {
                 <img src="@Character.ImageUrl" alt="@Character.Name" class="img-fluid rounded mb-3" style="max-height: 200px;" />
               }
               else
               {
                 <div class="bg-secondary text-white rounded d-flex align-items-center justify-content-center mb-3" style="height: 150px; font-size: 3rem;">
                   @(Character.Name?.FirstOrDefault())
                 </div>
               }
               <h5>@Character.Name</h5>
               <p class="text-muted mb-1">@Character.Species</p>
               @if (!string.IsNullOrEmpty(Character.TrueName))
               {
                 <p class="text-muted small mb-0">True Name: @Character.TrueName</p>
               }
             </div>
           </div>

           <!-- Health Pools -->
           <div class="card mt-3">
             <div class="card-header"><strong>Health</strong></div>
             <div class="card-body">
               <div class="mb-2">
                 <label class="small text-muted">Fatigue</label>
                 <PendingPoolBar CurrentValue="@Character.Fatigue.Value"
                                MaxValue="@Character.Fatigue.BaseValue"
                                PendingDamage="@Character.Fatigue.PendingDamage"
                                PendingHealing="@Character.Fatigue.PendingHealing" />
                 <small>@Character.Fatigue.Value / @Character.Fatigue.BaseValue</small>
               </div>
               <div class="mb-2">
                 <label class="small text-muted">Vitality</label>
                 <PendingPoolBar CurrentValue="@Character.Vitality.Value"
                                MaxValue="@Character.Vitality.BaseValue"
                                PendingDamage="@Character.Vitality.PendingDamage"
                                PendingHealing="@Character.Vitality.PendingHealing" />
                 <small>@Character.Vitality.Value / @Character.Vitality.BaseValue</small>
               </div>
               <div>
                 <label class="small text-muted">Action Points</label>
                 <div class="progress" style="height: 8px;">
                   <div class="progress-bar bg-primary" style="width: @GetApPercent()%"></div>
                 </div>
                 <small>@Character.ActionPoints.Available / @Character.ActionPoints.Maximum</small>
               </div>
             </div>
           </div>
         </div>

         <!-- Center Column: Attributes -->
         <div class="col-md-4">
           <div class="card">
             <div class="card-header"><strong>Attributes</strong></div>
             <div class="card-body">
               @foreach (var attr in Character.AttributeList)
               {
                 <div class="d-flex justify-content-between mb-2">
                   <span>@attr.Name</span>
                   <span class="fw-bold">@attr.Value</span>
                 </div>
               }
             </div>
           </div>

           <!-- XP and Damage Class -->
           <div class="card mt-3">
             <div class="card-header"><strong>Stats</strong></div>
             <div class="card-body">
               <div class="d-flex justify-content-between mb-2">
                 <span>XP Banked</span>
                 <span>@Character.XPBanked</span>
               </div>
               <div class="d-flex justify-content-between mb-2">
                 <span>XP Total</span>
                 <span>@Character.XPTotal</span>
               </div>
               <div class="d-flex justify-content-between">
                 <span>Damage Class</span>
                 <span>@Character.DamageClass</span>
               </div>
             </div>
           </div>
         </div>

         <!-- Right Column: Skills -->
         <div class="col-md-4">
           <div class="card" style="max-height: 500px; overflow-y: auto;">
             <div class="card-header"><strong>Skills</strong></div>
             <div class="card-body">
               @foreach (var skillGroup in Character.Skills.GroupBy(s => s.Attribute).OrderBy(g => g.Key))
               {
                 <h6 class="text-muted small mt-2">@skillGroup.Key</h6>
                 @foreach (var skill in skillGroup.OrderBy(s => s.Name))
                 {
                   @if (skill.Level > 0)
                   {
                     <div class="d-flex justify-content-between small">
                       <span>@skill.Name</span>
                       <span>@skill.Level</span>
                     </div>
                   }
                 }
               }
             </div>
           </div>
         </div>
       </div>
       ```

    3. **Helper methods:**
       ```csharp
       private int GetApPercent()
       {
           if (Character.ActionPoints.Maximum <= 0) return 0;
           return Character.ActionPoints.Available * 100 / Character.ActionPoints.Maximum;
       }
       ```

    4. **Add usings:**
       ```csharp
       @using GameMechanics
       @using Threa.Client.Components.Shared
       ```
  </action>
  <verify>
    - Build succeeds: `dotnet build Threa.sln`
    - File exists with expected structure
  </verify>
  <done>
    CharacterDetailSheet displays portrait, health pools, attributes, stats, and skills in read-only format
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CharacterDetailInventory component</name>
  <files>
    - Threa/Threa.Client/Components/Shared/CharacterDetailInventory.razor
  </files>
  <action>
    Create new file `CharacterDetailInventory.razor` in Components/Shared.

    This is a READ-ONLY view of inventory (GM cannot modify items from here, just inspect).

    1. **Parameters and Injections:**
       ```csharp
       [Parameter] public CharacterEdit Character { get; set; } = null!;

       @inject ICharacterItemDal itemDal
       @inject IItemTemplateDal templateDal
       ```

    2. **State:**
       ```csharp
       private List<CharacterItem>? items;
       private Dictionary<int, ItemTemplate>? templates;
       private bool isLoading = true;
       ```

    3. **OnInitializedAsync:**
       Load items for character, cache templates (same pattern as TabPlayInventory but simpler - no selection/actions).

    4. **Layout Structure:**
       ```html
       <div class="row">
         <!-- Left: Equipped Items by Slot -->
         <div class="col-md-5">
           <div class="card">
             <div class="card-header bg-success text-white"><strong>Equipment</strong></div>
             <div class="card-body" style="max-height: 400px; overflow-y: auto;">
               @foreach (var category in slotCategories)
               {
                 <h6 class="text-muted small mt-2">@category.Name</h6>
                 @foreach (var slot in category.Slots)
                 {
                   var equipped = GetEquippedItem(slot);
                   <div class="d-flex justify-content-between small mb-1">
                     <span class="text-muted">@slot.GetDisplayName()</span>
                     @if (equipped != null)
                     {
                       <span>@GetItemName(equipped)</span>
                     }
                     else
                     {
                       <span class="text-muted">-</span>
                     }
                   </div>
                 }
               }
             </div>
           </div>
         </div>

         <!-- Right: Carried Items Grid -->
         <div class="col-md-7">
           <div class="card">
             <div class="card-header bg-primary text-white"><strong>Inventory</strong></div>
             <div class="card-body">
               @if (isLoading)
               {
                 <p class="text-center text-muted">Loading...</p>
               }
               else if (items == null || !items.Where(i => !i.IsEquipped && i.ContainerItemId == null).Any())
               {
                 <p class="text-muted text-center">No carried items.</p>
               }
               else
               {
                 <div class="inventory-grid">
                   @foreach (var item in items.Where(i => !i.IsEquipped && i.ContainerItemId == null))
                   {
                     <div class="inventory-tile">
                       <div class="item-icon">@GetItemIcon(item)</div>
                       <div class="item-name">@GetItemName(item)</div>
                       @if (item.StackSize > 1)
                       {
                         <div class="item-quantity">x@item.StackSize</div>
                       }
                     </div>
                   }
                 </div>
               }
             </div>
           </div>

           <!-- Currency -->
           <div class="card mt-3">
             <div class="card-header"><strong>Currency</strong></div>
             <div class="card-body">
               <div class="d-flex gap-3">
                 <span><strong>@Character.PlatinumCoins</strong> pp</span>
                 <span><strong>@Character.GoldCoins</strong> gp</span>
                 <span><strong>@Character.SilverCoins</strong> sp</span>
                 <span><strong>@Character.CopperCoins</strong> cp</span>
               </div>
             </div>
           </div>
         </div>
       </div>
       ```

    5. **Helper methods:** Reuse the slot categories and icon mapping from TabPlayInventory:
       ```csharp
       private static readonly SlotCategory[] slotCategories = new[]
       {
         new SlotCategory("Weapons", new[] { EquipmentSlot.MainHand, EquipmentSlot.OffHand, EquipmentSlot.TwoHand }),
         new SlotCategory("Head & Neck", new[] { EquipmentSlot.Head, EquipmentSlot.Face, EquipmentSlot.Ears, EquipmentSlot.Neck }),
         new SlotCategory("Body", new[] { EquipmentSlot.Shoulders, EquipmentSlot.Back, EquipmentSlot.Chest, EquipmentSlot.Waist }),
         new SlotCategory("Arms", new[] { EquipmentSlot.ArmLeft, EquipmentSlot.ArmRight, EquipmentSlot.WristLeft, EquipmentSlot.WristRight, EquipmentSlot.HandLeft, EquipmentSlot.HandRight }),
         new SlotCategory("Legs & Feet", new[] { EquipmentSlot.Legs, EquipmentSlot.AnkleLeft, EquipmentSlot.AnkleRight, EquipmentSlot.FootLeft, EquipmentSlot.FootRight }),
       };
       private record SlotCategory(string Name, EquipmentSlot[] Slots);

       private CharacterItem? GetEquippedItem(EquipmentSlot slot) => items?.FirstOrDefault(i => i.IsEquipped && i.EquippedSlot == slot);
       private string GetItemName(CharacterItem item) => item.CustomName ?? templates?.GetValueOrDefault(item.ItemTemplateId)?.Name ?? "Unknown";
       private string GetItemIcon(CharacterItem item) { /* same as TabPlayInventory */ }
       ```

    6. **CSS:** Include minimal inventory-grid styling or reuse from themes.css:
       ```css
       <style>
         .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 6px; }
         .inventory-tile { display: flex; flex-direction: column; align-items: center; padding: 6px; border: 1px solid #dee2e6; border-radius: 4px; background: #fff; font-size: 0.8rem; }
         .item-icon { font-size: 18px; }
         .item-name { text-align: center; font-size: 0.7rem; overflow: hidden; text-overflow: ellipsis; max-width: 100%; white-space: nowrap; }
         .item-quantity { font-size: 0.65rem; color: #6c757d; }
       </style>
       ```
  </action>
  <verify>
    - Build succeeds: `dotnet build Threa.sln`
    - File exists with expected structure
  </verify>
  <done>
    CharacterDetailInventory displays equipped items by slot and carried items in grid format (read-only)
  </done>
</task>

<task type="auto">
  <name>Task 3: Create CharacterDetailNarrative component with GM notes</name>
  <files>
    - Threa/Threa.Client/Components/Shared/CharacterDetailNarrative.razor
    - Threa/Threa.Client/Components/Shared/CharacterDetailModal.razor
  </files>
  <action>
    **Part A: Create CharacterDetailNarrative.razor**

    1. **Parameters:**
       ```csharp
       [Parameter] public CharacterEdit Character { get; set; } = null!;
       [Parameter] public Guid TableId { get; set; }
       [Parameter] public int CharacterId { get; set; }
       [Parameter] public string? InitialGmNotes { get; set; }
       [Parameter] public EventCallback<string?> OnGmNotesChanged { get; set; }
       ```

    2. **Inject:**
       ```csharp
       @inject ITableDal tableDal
       ```

    3. **State:**
       ```csharp
       private string? gmNotes;
       private bool isSaving;

       protected override void OnInitialized()
       {
           gmNotes = InitialGmNotes;
       }
       ```

    4. **Layout:**
       ```html
       <div class="row">
         <!-- Left: Appearance -->
         <div class="col-md-6">
           <div class="card">
             <div class="card-header"><strong>Appearance</strong></div>
             <div class="card-body">
               @if (!string.IsNullOrEmpty(Character.ImageUrl))
               {
                 <img src="@Character.ImageUrl" alt="@Character.Name" class="img-fluid rounded mb-3" style="max-height: 150px;" />
               }

               <table class="table table-sm mb-0">
                 <tbody>
                   <tr>
                     <td class="text-muted">Height</td>
                     <td>@(string.IsNullOrEmpty(Character.Height) ? "-" : Character.Height)</td>
                   </tr>
                   <tr>
                     <td class="text-muted">Weight</td>
                     <td>@(string.IsNullOrEmpty(Character.Weight) ? "-" : Character.Weight)</td>
                   </tr>
                   <tr>
                     <td class="text-muted">Skin</td>
                     <td>@(string.IsNullOrEmpty(Character.SkinDescription) ? "-" : Character.SkinDescription)</td>
                   </tr>
                   <tr>
                     <td class="text-muted">Hair</td>
                     <td>@(string.IsNullOrEmpty(Character.HairDescription) ? "-" : Character.HairDescription)</td>
                   </tr>
                 </tbody>
               </table>
             </div>
           </div>

           <!-- Aliases -->
           @if (!string.IsNullOrEmpty(Character.Aliases))
           {
             <div class="card mt-3">
               <div class="card-header"><strong>Aliases</strong></div>
               <div class="card-body">
                 <p class="mb-0">@Character.Aliases</p>
               </div>
             </div>
           }
         </div>

         <!-- Right: Backstory and Notes -->
         <div class="col-md-6">
           <!-- Player Description/Backstory -->
           <div class="card">
             <div class="card-header"><strong>Backstory</strong></div>
             <div class="card-body" style="max-height: 200px; overflow-y: auto;">
               @if (string.IsNullOrEmpty(Character.Description))
               {
                 <p class="text-muted mb-0">No backstory provided.</p>
               }
               else
               {
                 <p class="mb-0" style="white-space: pre-wrap;">@Character.Description</p>
               }
             </div>
           </div>

           <!-- Player Notes (read-only) -->
           @if (!string.IsNullOrEmpty(Character.Notes))
           {
             <div class="card mt-3">
               <div class="card-header"><strong>Player Notes</strong></div>
               <div class="card-body" style="max-height: 150px; overflow-y: auto;">
                 <p class="mb-0" style="white-space: pre-wrap;">@Character.Notes</p>
               </div>
             </div>
           }

           <!-- GM Notes (editable) -->
           <div class="card mt-3 border-warning">
             <div class="card-header bg-warning text-dark">
               <strong><i class="bi bi-eye-slash me-1"></i>GM Notes</strong>
               <small class="ms-2">(Private - not visible to player)</small>
             </div>
             <div class="card-body">
               <textarea class="form-control" rows="4"
                         placeholder="Add private notes about this character..."
                         @bind="gmNotes"
                         @onblur="SaveGmNotes"
                         disabled="@isSaving"></textarea>
               @if (isSaving)
               {
                 <small class="text-muted"><i class="bi bi-arrow-repeat spin"></i> Saving...</small>
               }
             </div>
           </div>
         </div>
       </div>
       ```

    5. **Save method:**
       ```csharp
       private async Task SaveGmNotes()
       {
           if (isSaving) return;
           isSaving = true;
           try
           {
               await tableDal.UpdateGmNotesAsync(TableId, CharacterId, gmNotes);
               await OnGmNotesChanged.InvokeAsync(gmNotes);
           }
           finally
           {
               isSaving = false;
           }
       }
       ```

    **Part B: Update CharacterDetailModal.razor to use components and load GM notes**

    1. Replace the placeholder content in tab-content section:
       ```html
       @if (activeTab == "Character Sheet")
       {
           <CharacterDetailSheet Character="character" />
       }
       else if (activeTab == "Inventory")
       {
           <CharacterDetailInventory Character="character" />
       }
       else if (activeTab == "Narrative")
       {
           <CharacterDetailNarrative Character="character"
                                     TableId="TableId"
                                     CharacterId="selectedCharacterId"
                                     InitialGmNotes="@currentGmNotes"
                                     OnGmNotesChanged="@((notes) => currentGmNotes = notes)" />
       }
       ```

    2. Add state for GM notes in CharacterDetailModal:
       ```csharp
       private string? currentGmNotes;
       ```

    3. **CRITICAL: Load GM notes from TableCharacterInfo in OnInitializedAsync and OnCharacterChanged:**

       In `OnInitializedAsync`:
       ```csharp
       protected override async Task OnInitializedAsync()
       {
           selectedCharacterId = CharacterId;
           isLoading = true;

           // Fetch character data
           character = await characterPortal.FetchAsync(CharacterId);

           // Load GM notes from TableCharacterInfo (added in Plan 15-01)
           var tableChar = AllCharacters.FirstOrDefault(tc => tc.CharacterId == CharacterId);
           currentGmNotes = tableChar?.GmNotes;

           isLoading = false;
       }
       ```

       In `OnCharacterChanged`:
       ```csharp
       private async Task OnCharacterChanged()
       {
           isLoading = true;
           StateHasChanged();

           character = await characterPortal.FetchAsync(selectedCharacterId);

           // Load GM notes from TableCharacterInfo
           var tableChar = AllCharacters.FirstOrDefault(tc => tc.CharacterId == selectedCharacterId);
           currentGmNotes = tableChar?.GmNotes;

           isLoading = false;
           StateHasChanged();
       }
       ```

       **Note:** TableCharacterInfo.GmNotes property was added in Plan 15-01 Task 1. This wires the GM notes from the AllCharacters collection passed to the modal.
  </action>
  <verify>
    - Build succeeds: `dotnet build Threa.sln`
    - Run app, navigate to GM table, click character card
    - Switch to Narrative tab
    - GM notes textarea is visible with warning styling
    - Type in GM notes, click elsewhere (blur) - notes should save
    - Character Sheet and Inventory tabs display character data
  </verify>
  <done>
    All three tab components created and wired into CharacterDetailModal. GM notes load from TableCharacterInfo and persist on blur.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `dotnet build Threa.sln` succeeds
2. Open CharacterDetailModal from dashboard
3. Character Sheet tab shows: portrait, health bars, attributes, skills
4. Inventory tab shows: equipped items by slot, carried items grid, currency
5. Narrative tab shows: appearance, backstory, player notes (read-only), GM notes (editable)
6. Switching characters via dropdown refreshes all tab content including GM notes
7. GM notes save on blur and persist across modal close/reopen
</verification>

<success_criteria>
- CharacterDetailSheet component renders full character sheet data
- CharacterDetailInventory component renders equipped and carried items
- CharacterDetailNarrative component renders narrative and allows GM notes editing
- All components integrated into CharacterDetailModal tab structure
- GM notes load from TableCharacterInfo.GmNotes on modal open and character switch
- GM notes persist via UpdateGmNotesAsync
</success_criteria>

<output>
After completion, create `.planning/phases/15-dashboard-details/15-02-SUMMARY.md`
</output>
