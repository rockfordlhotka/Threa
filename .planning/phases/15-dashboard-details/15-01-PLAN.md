---
phase: 15-dashboard-details
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Threa.Dal/Dto/GameTable.cs
  - Threa.Dal/ITableDal.cs
  - Threa.Dal.Sqlite/TableDal.cs
  - GameMechanics/GamePlay/TableCharacterInfo.cs
  - Threa/Threa.Client/Components/Shared/CharacterDetailModal.razor
  - Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
  - Threa/Threa.Client/Components/Shared/CharacterStatusCard.razor
autonomous: true

must_haves:
  truths:
    - "GM can click a character card to open a detail modal"
    - "Modal displays character name in header with close button"
    - "Modal has three tab buttons: Character Sheet, Inventory, Narrative"
    - "GM can switch between characters via dropdown without closing modal"
    - "GM notes persist per character per table"
  artifacts:
    - path: "Threa/Threa.Client/Components/Shared/CharacterDetailModal.razor"
      provides: "Modal component with tab structure and character switcher"
      min_lines: 80
    - path: "Threa.Dal/Dto/GameTable.cs"
      provides: "TableCharacter.GmNotes property"
      contains: "GmNotes"
    - path: "GameMechanics/GamePlay/TableCharacterInfo.cs"
      provides: "TableCharacterInfo.GmNotes property for modal access"
      contains: "GmNotes"
  key_links:
    - from: "CharacterStatusCard.razor"
      to: "CharacterDetailModal.razor"
      via: "DialogService.OpenAsync on card click"
      pattern: "DialogService\\.OpenAsync.*CharacterDetailModal"
    - from: "CharacterDetailModal.razor"
      to: "ITableDal"
      via: "Save GM notes on blur/change"
      pattern: "UpdateGmNotesAsync|SaveGmNotes"
    - from: "TableCharacterInfo.cs"
      to: "TableCharacter.GmNotes"
      via: "FetchChild loads GmNotes from DTO"
      pattern: "GmNotes = tableChar\\.GmNotes"
---

<objective>
Create the foundation for character detail viewing: data layer extension for GM notes, modal skeleton with tab navigation and character switcher, and wire CharacterStatusCard click to open the modal.

Purpose: Establishes the infrastructure for detailed character inspection that subsequent plans will populate with tab content.
Output: Clickable character cards that open a modal with tab structure and character switching capability.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-dashboard-details/15-CONTEXT.md
@.planning/phases/15-dashboard-details/15-RESEARCH.md
@.planning/phases/14-dashboard-core/14-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GmNotes to TableCharacter data layer and TableCharacterInfo</name>
  <files>
    - Threa.Dal/Dto/GameTable.cs
    - Threa.Dal/ITableDal.cs
    - Threa.Dal.Sqlite/TableDal.cs
    - GameMechanics/GamePlay/TableCharacterInfo.cs
  </files>
  <action>
    1. In `Threa.Dal/Dto/GameTable.cs`, add to TableCharacter class:
       ```csharp
       /// <summary>
       /// GM-only notes for this character at this table. Not visible to players.
       /// </summary>
       public string? GmNotes { get; set; }
       ```

    2. In `Threa.Dal/ITableDal.cs`, add method:
       ```csharp
       Task UpdateGmNotesAsync(Guid tableId, int characterId, string? notes);
       ```

    3. In `Threa.Dal.Sqlite/TableDal.cs`, implement:
       - Add `GmNotes TEXT` column to TableCharacters table in schema (if using migrations) or handle gracefully
       - Implement `UpdateGmNotesAsync` to update the GmNotes field for a specific table-character pair
       - Update any existing Fetch methods to include GmNotes in the SELECT

    4. **CRITICAL: In `GameMechanics/GamePlay/TableCharacterInfo.cs`, add GmNotes property:**

       Add the property definition after the existing EffectSummary property:
       ```csharp
       public static readonly PropertyInfo<string?> GmNotesProperty = RegisterProperty<string?>(nameof(GmNotes));
       public string? GmNotes
       {
           get => GetProperty(GmNotesProperty);
           private set => LoadProperty(GmNotesProperty, value);
       }
       ```

       In the FetchChild method, add after the character data loading section (after EffectSummary assignment):
       ```csharp
       // Load GM notes from table character record
       GmNotes = tableChar.GmNotes;
       ```

    Note: Since SQLite may not have migrations, check how other schema changes have been handled (likely direct table creation or ALTER TABLE).
  </action>
  <verify>
    - Build succeeds: `dotnet build Threa.sln`
    - Verify GmNotes property exists on TableCharacter class
    - Verify GmNotes property exists on TableCharacterInfo class
  </verify>
  <done>
    TableCharacter has GmNotes property, ITableDal has UpdateGmNotesAsync method, and TableCharacterInfo exposes GmNotes for modal access
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CharacterDetailModal with tab navigation and character switcher</name>
  <files>
    - Threa/Threa.Client/Components/Shared/CharacterDetailModal.razor
  </files>
  <action>
    Create new file `CharacterDetailModal.razor` in Components/Shared:

    1. **Parameters:**
       - `int CharacterId` - Initially selected character
       - `Guid TableId` - Current table
       - `IEnumerable<TableCharacterInfo> AllCharacters` - For dropdown switcher

    2. **Injections:**
       - `IDataPortal<CharacterEdit> characterPortal` - Fetch full character data
       - `DialogService DialogService` - For close functionality
       - `ITableDal tableDal` - For saving GM notes

    3. **Modal Structure:**
       ```html
       <div class="character-detail-modal">
         <!-- Header with character switcher and close -->
         <div class="modal-header d-flex justify-content-between align-items-center">
           <select class="form-select" style="max-width: 250px;" @bind="selectedCharacterId" @bind:after="OnCharacterChanged">
             @foreach (var char in AllCharacters)
             {
               <option value="@char.CharacterId">@char.CharacterName</option>
             }
           </select>
           <button type="button" class="btn-close" @onclick="Close"></button>
         </div>

         <!-- Tab navigation -->
         <div class="tab-buttons">
           @foreach (var tabName in tabNames)
           {
             <button class="tab-link @(activeTab == tabName ? "active" : "")"
                     @onclick="() => activeTab = tabName">
               @tabName
             </button>
           }
         </div>

         <!-- Tab content placeholder -->
         <div class="tab-content p-3">
           @if (isLoading)
           {
             <div class="text-center py-4">Loading...</div>
           }
           else if (character != null)
           {
             @if (activeTab == "Character Sheet")
             {
               <p class="text-muted">Character Sheet content (Plan 02)</p>
             }
             else if (activeTab == "Inventory")
             {
               <p class="text-muted">Inventory content (Plan 02)</p>
             }
             else if (activeTab == "Narrative")
             {
               <p class="text-muted">Narrative content (Plan 02)</p>
             }
           }
         </div>
       </div>
       ```

    4. **Code-behind logic:**
       - `OnInitializedAsync`: Fetch character data for initial CharacterId
       - `OnCharacterChanged`: Fetch new character when dropdown changes
       - `Close`: Call `DialogService.Close()`
       - Tab state: `string[] tabNames = ["Character Sheet", "Inventory", "Narrative"]`
       - Loading state: `bool isLoading`, `CharacterEdit? character`

    5. **Styling:** Add scoped CSS or use existing `.tab-buttons`, `.tab-link`, `.tab-content` classes from themes.css

    Follow the UserEditModal.razor pattern for DialogService integration.
  </action>
  <verify>
    - Build succeeds: `dotnet build Threa.sln`
    - File exists at correct path
  </verify>
  <done>
    CharacterDetailModal component exists with header (switcher + close), three tab buttons, and placeholder content
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire CharacterStatusCard click to open CharacterDetailModal</name>
  <files>
    - Threa/Threa.Client/Components/Pages/GamePlay/GmTable.razor
  </files>
  <action>
    1. **Inject DialogService** if not already injected:
       ```csharp
       @inject DialogService DialogService
       ```

    2. **Add using for Radzen** at top:
       ```csharp
       @using Radzen
       ```

    3. **Create OpenCharacterDetails method:**
       ```csharp
       private async Task OpenCharacterDetails(TableCharacterInfo character)
       {
           var result = await DialogService.OpenAsync<CharacterDetailModal>(
               character.CharacterName,
               new Dictionary<string, object>
               {
                   { "CharacterId", character.CharacterId },
                   { "TableId", TableId },
                   { "AllCharacters", tableCharacters }
               },
               new DialogOptions
               {
                   Width = "90%",
                   Height = "90%",
                   CloseDialogOnOverlayClick = false,
                   ShowClose = false  // We have our own close button
               });
       }
       ```

    4. **Update CharacterStatusCard usage** in the character grid:
       Find the existing CharacterStatusCard component and update OnClick to call OpenCharacterDetails:
       ```html
       <CharacterStatusCard Character="@character"
                            IsSelected="@(selectedCharacter?.CharacterId == character.CharacterId)"
                            OnClick="OpenCharacterDetails" />
       ```
       Note: This changes the click behavior from SelectCharacter to OpenCharacterDetails.

    5. **Handle selection separately** - If the existing SelectCharacter is still needed (for the center panel quick actions), consider:
       - Double-click for details, single-click for selection, OR
       - Keep single-click for details (modal), remove center panel selection concept

       Based on CONTEXT.md, the modal replaces the need for the center panel selection. The modal provides full detail access. Keep the simple single-click to open modal approach.

    6. **Ensure DialogService is registered** - Check Program.cs has `builder.Services.AddRadzenComponents()` or equivalent. If not present, add it.
  </action>
  <verify>
    - Build succeeds: `dotnet build Threa.sln`
    - Run app, navigate to GM table with characters
    - Click a character card - modal should open with character name in header
    - Tab buttons should be visible (content is placeholder)
    - Character switcher dropdown should list all characters
    - Close button should dismiss modal
  </verify>
  <done>
    Clicking CharacterStatusCard opens CharacterDetailModal with character switcher and tab navigation visible
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `dotnet build Threa.sln` succeeds
2. GM dashboard loads with character cards
3. Clicking any character card opens modal
4. Modal shows character name in dropdown
5. Three tabs visible: Character Sheet, Inventory, Narrative
6. Character switcher dropdown works (can select different character)
7. Close button dismisses modal
8. GmNotes property exists on TableCharacter (data layer ready for Plan 02)
9. GmNotes property exists on TableCharacterInfo (CSLA info object ready for Plan 02)
</verification>

<success_criteria>
- CharacterDetailModal exists with tab structure
- CharacterStatusCard click opens modal via DialogService
- Character switcher dropdown populated with all table characters
- GmNotes property added to TableCharacter DTO
- GmNotes property added to TableCharacterInfo (for modal to read)
- UpdateGmNotesAsync method available in ITableDal
</success_criteria>

<output>
After completion, create `.planning/phases/15-dashboard-details/15-01-SUMMARY.md`
</output>
