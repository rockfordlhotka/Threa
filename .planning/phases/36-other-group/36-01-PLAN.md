---
phase: 36-other-group
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Threa/Threa/wwwroot/css/themes.css
  - Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor
autonomous: true

must_haves:
  truths:
    - "Implants button is hidden (not rendered) when no toggleable implants are equipped"
    - "Reload button is hidden (not rendered) when no ranged weapon is equipped"
    - "Unload button is hidden (not rendered) when no weapon has ammo loaded"
    - "Medical and Rest buttons are always visible regardless of equipment state"
    - "Clicking Rest opens an inline confirmation panel showing 'Spend 1 AP to recover 1 FAT' with Confirm/Cancel"
    - "Confirming Rest deducts 1 AP, heals 1 FAT, ends parry mode, saves character, and returns to default mode"
    - "Cancelling Rest returns to default mode without any AP/FAT changes"
    - "A combat-tile-dimmed CSS class exists with opacity: 0.65"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor"
      provides: "Hidden conditional buttons, Rest confirmation panel, CombatMode.Rest enum value"
      contains: "CombatMode.Rest"
    - path: "Threa/Threa/wwwroot/css/themes.css"
      provides: "combat-tile-dimmed CSS class"
      contains: "combat-tile-dimmed"
  key_links:
    - from: "TabCombat.razor Rest button"
      to: "CombatMode.Rest panel"
      via: "StartRest sets combatMode = CombatMode.Rest"
      pattern: "combatMode == CombatMode\\.Rest"
    - from: "ConfirmRest method"
      to: "Character save"
      via: "SaveAsync after AP deduction and FAT healing"
      pattern: "ConfirmRest"
---

<objective>
Wire Other group button visibility, add Rest confirmation flow, and create dimming CSS class.

Purpose: Convert conditional buttons (Implants, Reload, Unload) from disabled to hidden, replace instant Rest execution with a confirmation panel following the combat mode pattern, and add the combat-tile-dimmed CSS class that Plan 02 will apply across all groups.

Output: Modified TabCombat.razor with @if-guarded conditional buttons, CombatMode.Rest enum value, inline Rest confirmation panel, StartRest/ConfirmRest methods; themes.css with .combat-tile-dimmed class.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/36-other-group/36-CONTEXT.md
@.planning/phases/36-other-group/36-RESEARCH.md
@Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor
@Threa/Threa/wwwroot/css/themes.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add combat-tile-dimmed CSS and convert conditional Other group buttons to hidden</name>
  <files>
    Threa/Threa/wwwroot/css/themes.css
    Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor
  </files>
  <action>
**themes.css:** Add a new CSS class right after the existing `.combat-tile-passive-only` rule (around line 2191):

```css
/* Cost-aware dimming for combat tiles (insufficient AP/FAT) */
.combat-tile-dimmed {
    opacity: 0.65;
}
```

**TabCombat.razor — Other group HTML (lines 245-289):** Replace the three conditional buttons (Implants, Reload, Unload) with `@if`-guarded versions. Keep Medical and Rest always rendered. Specifically:

1. **Implants button (lines 266-271):** Wrap in `@if (hasToggleableImplantsEquipped)`. Remove the `disabled="@(!hasToggleableImplantsEquipped)"` attribute since the button is now hidden when condition is false. Keep the button otherwise unchanged.

2. **Reload button (lines 273-278):** Wrap in `@if (hasRangedWeaponEquipped)`. Change `disabled` from `@(!CanAct() || !hasRangedWeaponEquipped)` to `@(Character?.IsPassedOut ?? true)` since the ranged weapon check is now handled by visibility.

3. **Unload button (lines 280-286):** Wrap in `@if (HasWeaponWithAmmo())`. Change `disabled` from `@(!CanAct() || !HasWeaponWithAmmo())` to `@(Character?.IsPassedOut ?? true)` since the ammo check is now handled by visibility.

The Medical and Rest buttons remain exactly as they are for now (dimming is applied in Plan 02). Do NOT add the dimming class to any buttons yet — that is Task 2 of Plan 02.
  </action>
  <verify>
Build compiles: `dotnet build Threa.sln`
Grep for `@if (hasToggleableImplantsEquipped)` in TabCombat.razor confirms Implants is @if-guarded.
Grep for `@if (hasRangedWeaponEquipped)` in TabCombat.razor confirms Reload is @if-guarded.
Grep for `@if (HasWeaponWithAmmo())` in TabCombat.razor confirms Unload is @if-guarded.
Grep for `combat-tile-dimmed` in themes.css confirms CSS class exists.
  </verify>
  <done>
Three conditional buttons hidden via @if when preconditions are false. Medical and Rest remain always visible. combat-tile-dimmed CSS class exists in themes.css.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Rest confirmation flow with CombatMode.Rest</name>
  <files>Threa/Threa.Client/Components/Pages/GamePlay/TabCombat.razor</files>
  <action>
**1. Add Rest to CombatMode enum (line 457):**

Change:
```csharp
private enum CombatMode { Default, Attack, Defend, TakeDamage, RangedAttack, Reload, Unload, Medical, SelectTarget, ActivateImplant, AnonymousAction, SkillCheck }
```
To:
```csharp
private enum CombatMode { Default, Attack, Defend, TakeDamage, RangedAttack, Reload, Unload, Medical, SelectTarget, ActivateImplant, AnonymousAction, SkillCheck, Rest }
```

**2. Change Rest button @onclick (in the Other group):**

Change the Rest button's `@onclick="Rest"` to `@onclick="StartRest"`. Keep the disabled and title attributes as-is for now (Plan 02 handles dimming).

**3. Replace the `Rest()` method (lines 1268-1295) with two new methods:**

```csharp
private void StartRest()
{
    if (Character?.IsPassedOut ?? true) return;
    combatMode = CombatMode.Rest;
}

private async Task ConfirmRest()
{
    if (!CanRest() || Character == null) return;

    // Resting ends parry mode
    if (CombatStanceBehavior.IsInParryMode(Character))
    {
        CombatStanceBehavior.EndParryMode(Character);
    }

    Character.ActionPoints.Available -= 1;
    Character.Fatigue.PendingHealing += 1;

    LogActivity($"{Character.Name} rests, recovering some fatigue.", ActivityCategory.Health);

    if (Character is Csla.Core.ISavable savable)
    {
        await savable.SaveAsync();
    }

    if (OnCharacterChanged.HasDelegate)
    {
        await OnCharacterChanged.InvokeAsync();
    }

    combatMode = CombatMode.Default;
    StateHasChanged();
}
```

Note: `StartRest` does NOT check `CanRest()` — it only checks `IsPassedOut`. This allows the panel to open even when AP is insufficient (the panel will show but Confirm won't execute). This matches how other modes work.

**4. Add Rest confirmation panel HTML in the mode rendering section.**

After the last `else if` mode block (likely after the SkillCheck or ActivateImplant mode), add:

```html
else if (combatMode == CombatMode.Rest)
{
    <div class="card">
        <div class="card-header">
            <i class="bi bi-cup-hot"></i> <strong>Rest</strong>
        </div>
        <div class="card-body text-center">
            <p>Spend 1 AP to recover 1 FAT</p>
            <div class="d-flex justify-content-center gap-2">
                <button class="btn btn-success" @onclick="ConfirmRest" disabled="@(!CanRest())">
                    <i class="bi bi-check"></i> Confirm
                </button>
                <button class="btn btn-outline-secondary" @onclick="ReturnToDefault">
                    <i class="bi bi-x-lg"></i> Cancel
                </button>
            </div>
        </div>
    </div>
}
```

The Confirm button uses `disabled="@(!CanRest())"` so the player can see the panel but cannot confirm if they lack AP or FAT is already full. The Cancel button uses the existing `ReturnToDefault` method.
  </action>
  <verify>
Build compiles: `dotnet build Threa.sln`
Grep for `CombatMode.Rest` confirms enum value exists and is used in mode rendering.
Grep for `StartRest` confirms button onclick is wired.
Grep for `ConfirmRest` confirms the confirmation method exists.
Grep for `ReturnToDefault` in the Rest panel confirms cancel button uses existing method.
  </verify>
  <done>
Rest button opens inline confirmation panel. Confirm executes rest logic (AP deduction, FAT healing, parry mode end, save). Cancel returns to default. CombatMode.Rest enum value exists and is used.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Threa.sln` passes with no errors
2. Implants/Reload/Unload buttons are wrapped in @if guards in the Other group
3. Medical and Rest buttons have no @if guard (always rendered)
4. CombatMode enum includes Rest
5. StartRest method sets combatMode to CombatMode.Rest
6. ConfirmRest method contains AP deduction, FAT healing, parry mode end, save, and returns to Default mode
7. Rest confirmation panel renders with Confirm (disabled when !CanRest()) and Cancel buttons
8. .combat-tile-dimmed CSS class exists in themes.css with opacity: 0.65
</verification>

<success_criteria>
- Build succeeds
- Three conditional buttons are @if-guarded
- Rest flows through confirmation panel instead of executing immediately
- combat-tile-dimmed CSS class is ready for Plan 02 to apply
</success_criteria>

<output>
After completion, create `.planning/phases/36-other-group/36-01-SUMMARY.md`
</output>
