---
phase: 02-gm-item-management
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - Threa/Threa.Client/Components/Pages/GameMaster/ItemEdit.razor
  - Threa/Threa.Client/Components/Pages/GameMaster/Items.razor
autonomous: false

must_haves:
  truths:
    - "GM can see item properties organized in tabs"
    - "GM can add and remove tags from an item template"
    - "GM can search items by tags on list page"
    - "Type-specific tabs show/hide based on ItemType"
    - "Save/Cancel buttons are visible in sticky bottom bar"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/GameMaster/ItemEdit.razor"
      provides: "Tabbed edit form with tags"
      contains: "RadzenTabs"
    - path: "Threa/Threa.Client/Components/Pages/GameMaster/Items.razor"
      provides: "Search includes Tags"
      contains: "Tags.Contains"
  key_links:
    - from: "ItemEdit.razor Tags input"
      to: "vm.Model.Tags"
      via: "Two-way binding"
      pattern: "@bind.*Tags"
    - from: "Items.razor search"
      to: "ItemTemplateInfo.Tags"
      via: "Filter predicate"
      pattern: "Tags.*Contains"
---

<objective>
Reorganize ItemEdit.razor into tabbed sections and add Tags input with autocomplete.

Purpose: Improve UX for editing complex items by organizing properties into logical tabs. Per CONTEXT.md: Tabbed sections (Basic | Weapon | Armor | Container | Bonuses), type-specific tabs show/hide, fixed bottom action bar, tags with autocomplete.

Output: Tabbed ItemEdit.razor with Tags input, sticky bottom bar, and search-by-tags on list page.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-gm-item-management/02-CONTEXT.md
@.planning/phases/02-gm-item-management/02-RESEARCH.md

# Prior plan summary for Tags property
@.planning/phases/02-gm-item-management/02-01-SUMMARY.md

# Current files to modify
@Threa/Threa.Client/Components/Pages/GameMaster/ItemEdit.razor
@Threa/Threa.Client/Components/Pages/GameMaster/Items.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wrap existing fieldsets in RadzenTabs</name>
  <files>
    Threa/Threa.Client/Components/Pages/GameMaster/ItemEdit.razor
  </files>
  <action>
Reorganize the existing fieldsets into RadzenTabs. The existing content stays largely the same - we're just wrapping it in tabs.

1. **Add state for tab selection**:
   ```csharp
   private int selectedTabIndex = 0;
   ```

2. **Wrap content in RadzenTabs**:
   ```razor
   <RadzenTabs @bind-SelectedIndex="@selectedTabIndex">
       <Tabs>
           <RadzenTabsItem Text="Basic">
               <!-- Move Basic Properties fieldset content here -->
               <!-- Move Equipment fieldset content here (if applicable) -->
           </RadzenTabsItem>

           @if (vm.Model.ItemType == ItemType.Weapon)
           {
               <RadzenTabsItem Text="Weapon">
                   <!-- Move Weapon Properties fieldset here -->
                   <!-- Move Ranged Weapon Properties fieldset here (nested if) -->
               </RadzenTabsItem>
           }

           @if (vm.Model.ItemType == ItemType.Armor || vm.Model.ItemType == ItemType.Shield)
           {
               <RadzenTabsItem Text="Armor">
                   <!-- Move Armor Properties fieldset here -->
               </RadzenTabsItem>
           }

           @if (vm.Model.ItemType == ItemType.Container)
           {
               <RadzenTabsItem Text="Container">
                   <!-- Move Container Properties fieldset here -->
               </RadzenTabsItem>
           }

           @if (vm.Model.ItemType == ItemType.Ammunition)
           {
               <RadzenTabsItem Text="Ammunition">
                   <!-- Move Ammunition Properties fieldset here -->
               </RadzenTabsItem>
           }

           @if (vm.Model.ItemType == ItemType.AmmoContainer)
           {
               <RadzenTabsItem Text="Ammo Container">
                   <!-- Move Ammo Container Properties fieldset here -->
               </RadzenTabsItem>
           }
       </Tabs>
   </RadzenTabs>
   ```

3. **Reset tab index on ItemType change** (per RESEARCH.md pitfall):
   Modify OnItemTypeChanged() to reset selectedTabIndex = 0:
   ```csharp
   private void OnItemTypeChanged()
   {
       // Reset to Basic tab when type changes (avoid pointing to hidden tab)
       selectedTabIndex = 0;
       // ... existing code ...
   }
   ```

4. **Remove fieldset/legend wrappers** inside tabs - the tab itself provides the section label. Keep the table structure.

5. **Keep the form wrapper** around RadzenTabs for proper submit handling.
  </action>
  <verify>
    dotnet build Threa.sln
  </verify>
  <done>
    Edit page shows RadzenTabs with Basic always visible, type-specific tabs appear/disappear based on ItemType selection.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Tags input and sticky bottom bar</name>
  <files>
    Threa/Threa.Client/Components/Pages/GameMaster/ItemEdit.razor
  </files>
  <action>
Add Tags input to Basic tab and create sticky bottom action bar.

1. **Add Tags input** in Basic tab (after IsActive checkbox, before the table close):
   ```razor
   <tr>
       <td>Tags</td>
       <td>
           <div class="tags-input-container">
               @if (tagList.Any())
               {
                   <div class="d-flex flex-wrap gap-1 mb-2">
                       @foreach (var tag in tagList)
                       {
                           <span class="badge bg-secondary d-flex align-items-center">
                               @tag
                               <button type="button" class="btn-close btn-close-white ms-1"
                                   style="font-size: 0.6rem;"
                                   @onclick="@(() => RemoveTag(tag))"></button>
                           </span>
                       }
                   </div>
               }
               <div class="d-flex gap-2">
                   <RadzenTextBox @bind-Value="@newTagInput" Placeholder="Add tag..."
                       @onkeydown="@OnTagKeyDown" Style="width: 200px" />
                   <RadzenButton Text="Add" Icon="add" Click="@AddTag"
                       Disabled="@string.IsNullOrWhiteSpace(newTagInput)" Size="ButtonSize.Small" />
               </div>
               <small class="text-muted">Press Enter to add tag. Tags help with filtering and search.</small>
           </div>
       </td>
   </tr>
   ```

2. **Add tag management code**:
   ```csharp
   private string newTagInput = "";
   private List<string> tagList = new();

   // Call in LoadCustomProperties or after model loads
   private void LoadTags()
   {
       tagList = string.IsNullOrWhiteSpace(vm.Model?.Tags)
           ? new List<string>()
           : vm.Model.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries)
               .Select(t => t.Trim())
               .ToList();
   }

   private void SaveTags()
   {
       if (vm.Model != null)
           vm.Model.Tags = tagList.Any() ? string.Join(",", tagList) : null;
   }

   private void AddTag()
   {
       if (!string.IsNullOrWhiteSpace(newTagInput) && !tagList.Contains(newTagInput.Trim(), StringComparer.OrdinalIgnoreCase))
       {
           tagList.Add(newTagInput.Trim().ToLowerInvariant());
           SaveTags();
           newTagInput = "";
       }
   }

   private void RemoveTag(string tag)
   {
       tagList.Remove(tag);
       SaveTags();
   }

   private void OnTagKeyDown(KeyboardEventArgs e)
   {
       if (e.Key == "Enter")
       {
           AddTag();
       }
   }
   ```

3. **Call LoadTags()** in ModelChanged handler:
   ```csharp
   vm.ModelChanged += async () =>
   {
       LoadCustomProperties();
       LoadTags();  // Add this line
       await InvokeAsync(() => StateHasChanged());
   };
   ```

4. **Add sticky bottom action bar** - move Save/Cancel to fixed bottom:
   Replace the existing button div with:
   ```razor
   <div class="form-actions-bar">
       <button type="button" @onclick="SaveData" class="btn btn-primary" disabled="@(!vm.Model.IsSavable)">Save</button>
       <button type="button" @onclick="Cancel" class="btn btn-secondary ms-2">Cancel</button>
   </div>
   ```

5. **Add CSS** at top of file or in a scoped CSS file:
   ```razor
   <style>
       .form-actions-bar {
           position: sticky;
           bottom: 0;
           background: var(--rz-base-background-color, white);
           padding: 1rem;
           border-top: 1px solid var(--rz-border-color, #dee2e6);
           z-index: 100;
           margin-top: 1rem;
       }
   </style>
   ```
  </action>
  <verify>
    dotnet build Threa.sln
  </verify>
  <done>
    Tags input allows adding/removing tags with Enter key or Add button. Tags display as badges with X to remove. Save/Cancel buttons in sticky bottom bar.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update list page search to include Tags</name>
  <files>
    Threa/Threa.Client/Components/Pages/GameMaster/Items.razor
  </files>
  <action>
Update the ApplyFilters method in Items.razor to also search Tags property.

1. **Update ApplyFilters()** to include Tags in search:
   ```csharp
   private void ApplyFilters()
   {
       var query = allItems?.AsEnumerable() ?? Enumerable.Empty<ItemTemplateInfo>();

       if (selectedType.HasValue)
           query = query.Where(i => i.ItemType == selectedType.Value);

       if (!string.IsNullOrWhiteSpace(searchText))
           query = query.Where(i =>
               i.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
               i.Description.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
               (!string.IsNullOrEmpty(i.Tags) && i.Tags.Contains(searchText, StringComparison.OrdinalIgnoreCase)));

       filteredItems = query.ToList();
   }
   ```

Note: The Tags property was added to ItemTemplateInfo in Plan 02-01.
  </action>
  <verify>
    dotnet build Threa.sln
  </verify>
  <done>
    Searching for a tag name (e.g., "starter-gear") shows items with that tag.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Tabbed edit form with:
    - Basic tab always visible with Tags input
    - Type-specific tabs (Weapon, Armor, Container, Ammunition, AmmoContainer) that show/hide
    - Sticky bottom action bar with Save/Cancel
    - Tag management (add/remove with badges)
    - Search by tags on list page
  </what-built>
  <how-to-verify>
    1. Run `dotnet run --project Threa/Threa`
    2. Navigate to https://localhost:7133/gamemaster/items
    3. Click on any item row to edit
    4. Verify tabs appear: Basic tab always shown
    5. Change ItemType dropdown - verify type-specific tabs appear/disappear
    6. In Basic tab, add a tag (type "test-tag" and press Enter or click Add)
    7. Verify tag appears as badge with X button
    8. Click X to remove the tag
    9. Scroll down - verify Save/Cancel buttons stay visible (sticky)
    10. Go back to list page
    11. Search for "starter-gear" - verify weapons/armor with that tag appear
    12. Search for a tag you added - verify it filters correctly
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `dotnet build Threa.sln` - No compilation errors
2. Manual test: Edit page shows tabs (Basic always, others conditional)
3. Manual test: Changing ItemType shows/hides appropriate tabs
4. Manual test: Can add tags with Enter key and Add button
5. Manual test: Can remove tags with X button on badge
6. Manual test: Save/Cancel buttons in sticky footer
7. Manual test: List page search finds items by tag
</verification>

<success_criteria>
- RadzenTabs organizes edit form into logical sections
- Basic tab always visible with all current basic fields plus Tags input
- Weapon tab appears for ItemType.Weapon (includes ranged properties)
- Armor tab appears for ItemType.Armor or ItemType.Shield
- Container tab appears for ItemType.Container
- Ammunition tab appears for ItemType.Ammunition
- AmmoContainer tab appears for ItemType.AmmoContainer
- Tags input shows existing tags as badges
- Can add new tags (Enter key or Add button)
- Can remove tags (X button on badge)
- Save/Cancel buttons in sticky bottom bar
- List page search includes Tags field
</success_criteria>

<output>
After completion, create `.planning/phases/02-gm-item-management/02-03-SUMMARY.md`
</output>
