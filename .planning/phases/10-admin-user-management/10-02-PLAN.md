---
phase: 10-admin-user-management
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - Threa/Threa.Client/Components/Pages/Admin/UserEditModal.razor
  - Threa/Threa.Client/Components/Pages/Admin/Users.razor
autonomous: true

must_haves:
  truths:
    - "Admin can view sortable list of all users with status icons"
    - "Admin can open edit modal by clicking Edit button"
    - "Modal shows checkboxes for GameMaster and Admin roles (not User)"
    - "Modal shows warning when admin edits their own account"
    - "Save shows error message for last-admin protection rule violation"
    - "Success message displays in modal after successful save"
  artifacts:
    - path: "Threa/Threa.Client/Components/Pages/Admin/UserEditModal.razor"
      provides: "Modal component for editing user with roles and warnings"
      min_lines: 100
    - path: "Threa/Threa.Client/Components/Pages/Admin/Users.razor"
      provides: "Enhanced user list with modal, icons, sorting"
      contains: "UserEditModal"
  key_links:
    - from: "Users.razor"
      to: "UserEditModal.razor"
      via: "DialogService.OpenAsync"
      pattern: "DialogService.OpenAsync.*UserEditModal"
    - from: "UserEditModal.razor"
      to: "AdminUserEdit"
      via: "IDataPortal<AdminUserEdit>"
      pattern: "IDataPortal.*AdminUserEdit"
---

<objective>
Create admin user management UI with modal editing and list enhancements.

Purpose: Allow administrators to efficiently manage users from a single page with inline modal editing, clear status indicators, and appropriate warnings for self-affecting actions.

Output: Enhanced Users.razor with sortable columns, status icons, and edit modal. UserEditModal.razor component with role checkboxes, warning dialogs for self-disable/demote, and inline success messaging.
</objective>

<execution_context>
@C:\Users\rocky\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\rocky\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-admin-user-management/10-CONTEXT.md
@.planning/phases/10-admin-user-management/10-RESEARCH.md
@.planning/phases/10-admin-user-management/10-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UserEditModal Component</name>
  <files>
    Threa/Threa.Client/Components/Pages/Admin/UserEditModal.razor
  </files>
  <action>
Create modal component for editing user details, roles, and enabled status.

**UserEditModal.razor:**

```razor
@using GameMechanics.Player
@using Radzen
@using System.Security.Claims

@inject IDataPortal<AdminUserEdit> userPortal
@inject ViewModel<AdminUserEdit> vm
@inject DialogService DialogService
@inject AuthenticationStateProvider AuthenticationStateProvider

<div class="p-3">
    @if (vm.Model == null)
    {
        <p>Loading...</p>
    }
    else
    {
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }
        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success">@successMessage</div>
        }

        <div class="mb-3">
            <label class="form-label">Username</label>
            <input type="text" class="form-control" value="@vm.Model.Email" disabled />
        </div>

        <div class="mb-3">
            <label class="form-label">Display Name</label>
            <input type="text" class="form-control" @bind="vm.Model.Name" />
        </div>

        <div class="mb-3">
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="isEnabled" @bind="vm.Model.IsEnabled" />
                <label class="form-check-label" for="isEnabled">Account Enabled</label>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">Roles</label>
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="isGameMaster" @bind="vm.Model.IsGameMaster" />
                <label class="form-check-label" for="isGameMaster">Game Master</label>
            </div>
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="isAdmin" @bind="vm.Model.IsAdministrator" />
                <label class="form-check-label" for="isAdmin">Administrator</label>
            </div>
            <small class="text-muted">User role is always assigned.</small>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">Reset Password</label>
            <input type="password" class="form-control" @bind="vm.Model.NewPassword" placeholder="Leave blank to keep current" />
        </div>

        <div class="d-flex gap-2 justify-content-end">
            <button type="button" class="btn btn-secondary" @onclick="Close">Close</button>
            <button type="button" class="btn btn-primary" @onclick="SaveAsync" disabled="@(!vm.Model.IsSavable || saving)">
                @if (saving)
                {
                    <span class="spinner-border spinner-border-sm me-1"></span>
                }
                Save
            </button>
        </div>
    }
</div>

@code {
    [Parameter]
    public int UserId { get; set; }

    private int currentUserId;
    private string? errorMessage;
    private string? successMessage;
    private bool saving;

    protected override async Task OnInitializedAsync()
    {
        // Get current user ID
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            var idClaim = user.FindFirst(ClaimTypes.NameIdentifier);
            if (idClaim != null && int.TryParse(idClaim.Value, out var id))
            {
                currentUserId = id;
            }
        }

        vm.ModelChanged += async () => await InvokeAsync(StateHasChanged);
        vm.ModelPropertyChanged += async (s, a) => await InvokeAsync(StateHasChanged);
        await vm.RefreshAsync(() => userPortal.FetchAsync(UserId));
    }

    private async Task SaveAsync()
    {
        if (vm.Model == null) return;

        errorMessage = null;
        successMessage = null;

        // Check for self-disable warning
        if (currentUserId == vm.Model.Id && !vm.Model.IsEnabled)
        {
            var confirmed = await DialogService.Confirm(
                "You're about to disable your own account. You will be logged out immediately. Continue?",
                "Warning",
                new ConfirmOptions
                {
                    OkButtonText = "Disable Anyway",
                    CancelButtonText = "Cancel"
                });
            if (confirmed != true) return;
        }

        // Check for self-demote warning
        if (currentUserId == vm.Model.Id && !vm.Model.IsAdministrator)
        {
            var confirmed = await DialogService.Confirm(
                "You're about to remove your own Admin access. You won't be able to access this page after saving. Continue?",
                "Warning",
                new ConfirmOptions
                {
                    OkButtonText = "Remove Anyway",
                    CancelButtonText = "Cancel"
                });
            if (confirmed != true) return;
        }

        saving = true;
        StateHasChanged();

        try
        {
            vm.Model = await vm.Model.SaveAsync();
            successMessage = "User saved successfully.";
        }
        catch (Csla.DataPortalException ex) when (ex.BusinessException != null)
        {
            errorMessage = ex.BusinessException.Message;
        }
        catch (Csla.Rules.ValidationException)
        {
            // Display broken rules from the model
            var brokenRules = vm.Model.BrokenRulesCollection
                .Where(r => r.Severity == Csla.Rules.RuleSeverity.Error)
                .Select(r => r.Description);
            errorMessage = string.Join("; ", brokenRules);
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            saving = false;
            StateHasChanged();
        }
    }

    private void Close()
    {
        DialogService.Close(!string.IsNullOrEmpty(successMessage));
    }
}
```

Key features:
- Displays username as read-only (Email field)
- Editable display name (Name field)
- Enabled checkbox
- GameMaster and Administrator role checkboxes (User role implicit, not shown)
- Password reset field
- Warning dialogs for self-disable and self-demote (confirm before save)
- Inline error message for validation failures (including last-admin protection)
- Inline success message after save
- Manual close button (user reviews success message then closes)
  </action>
  <verify>
Build succeeds: `dotnet build Threa.sln`
  </verify>
  <done>
UserEditModal.razor exists with:
- Role checkboxes for GameMaster and Admin (not User)
- Warning confirmations for self-disable and self-demote
- Inline error/success messaging
- Manual close after save
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance Users.razor with Modal and Sorting</name>
  <files>
    Threa/Threa.Client/Components/Pages/Admin/Users.razor
  </files>
  <action>
Enhance Users.razor to use modal editing, add sorting, and show disabled status icons.

**Replace entire Users.razor content:**

```razor
@page "/admin/users"
@rendermode InteractiveServer

@using GameMechanics.Player
@using Microsoft.AspNetCore.Components.QuickGrid
@using Microsoft.AspNetCore.Authorization
@using Radzen

@inject IDataPortal<AdminUserList> userListPortal
@inject ViewModel<AdminUserList> vm
@inject DialogService DialogService

@attribute [Authorize(Roles = "Administrator")]

<h3>Manage Users</h3>

@if (!string.IsNullOrEmpty(vm.ViewModelErrorText))
{
    <div class="alert alert-danger">@vm.ViewModelErrorText</div>
}

@if (vm.Model == null)
{
    <div>Loading...</div>
    <img src="images/busy.gif" class="busy-animation" />
}
else
{
    <QuickGrid Items="users" Class="table table-striped">
        <PropertyColumn Title="Username" Property="@(p => p.Email)" Sortable="true" />
        <PropertyColumn Title="Display Name" Property="@(p => p.Name)" Sortable="true" />
        <PropertyColumn Title="Roles" Property="@(p => p.Roles)" Sortable="true" />
        <TemplateColumn Title="Status" Sortable="true" SortBy="@enabledSort">
            @if (context.IsEnabled)
            {
                <span class="badge bg-success">Enabled</span>
            }
            else
            {
                <span>
                    <i class="bi bi-lock-fill text-danger me-1" title="Account disabled"></i>
                    <span class="text-danger">Disabled</span>
                </span>
            }
        </TemplateColumn>
        <TemplateColumn Title="Actions">
            <button class="btn btn-sm btn-outline-primary" @onclick="() => EditUserAsync(context.Id)">
                <i class="bi bi-pencil me-1"></i>Edit
            </button>
        </TemplateColumn>
    </QuickGrid>
}

@code {
    private IQueryable<AdminUserInfo>? users;

    // Sort by enabled status (enabled first, then disabled)
    private GridSort<AdminUserInfo> enabledSort = GridSort<AdminUserInfo>
        .ByDescending(p => p.IsEnabled);

    protected override async Task OnParametersSetAsync()
    {
        await RefreshListAsync();
    }

    private async Task RefreshListAsync()
    {
        await vm.RefreshAsync(() => userListPortal.FetchAsync());
        users = vm.Model?.AsQueryable();
        StateHasChanged();
    }

    private async Task EditUserAsync(int userId)
    {
        var result = await DialogService.OpenAsync<UserEditModal>(
            "Edit User",
            new Dictionary<string, object> { { "UserId", userId } },
            new DialogOptions
            {
                Width = "500px",
                CloseDialogOnOverlayClick = false,
                ShowClose = true
            });

        // Refresh list if save was successful
        if (result is bool saved && saved)
        {
            await RefreshListAsync();
        }
    }
}
```

Key changes from existing Users.razor:
1. Added `@rendermode InteractiveServer` for dialog support
2. Added `@using Radzen` and `@inject DialogService`
3. Changed columns to `Sortable="true"`
4. Added custom sort for Status column using `GridSort<AdminUserInfo>.ByDescending(p => p.IsEnabled)`
5. Status column now shows lock icon (bi-lock-fill) for disabled users
6. Edit link replaced with button that opens `UserEditModal` via `DialogService.OpenAsync`
7. Added `RefreshListAsync` method called after successful modal save
8. Added `table-striped` class for better visual

**Note:** Ensure Bootstrap Icons are available. Check if `<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">` exists in App.razor or _Host.cshtml. If not present, add it.
  </action>
  <verify>
1. Build succeeds: `dotnet build Threa.sln`
2. Run application and navigate to /admin/users as admin
3. Verify columns are sortable (click headers)
4. Verify disabled users show lock icon
5. Verify Edit button opens modal dialog
6. Verify save in modal updates the list
  </verify>
  <done>
Users.razor enhanced with:
- Sortable columns (Username, Display Name, Roles, Status)
- Lock icon for disabled users
- Edit button opens UserEditModal dialog
- List refreshes after modal save
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Threa.sln` succeeds
2. Navigate to /admin/users as admin user
3. Click column headers to verify sorting works
4. Verify disabled users show lock icon next to status
5. Click Edit on a user - modal should open
6. Modify user and save - success message appears in modal
7. Close modal - list should show updated data
8. Edit own account and try to disable - warning dialog appears
9. Edit own account and try to remove Admin role - warning dialog appears
10. If only admin exists, try to disable/demote - error message shown (last-admin protection)
</verification>

<success_criteria>
- Users.razor shows sortable list with status icons
- Edit opens modal instead of navigating
- Modal shows role checkboxes (GameMaster, Admin but not User)
- Warning dialogs appear for self-disable and self-demote
- Last-admin protection error displays in modal
- Success message displays after save
- List refreshes after modal closes
</success_criteria>

<output>
After completion, create `.planning/phases/10-admin-user-management/10-02-SUMMARY.md`
</output>
